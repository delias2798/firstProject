import{A as cr,C as Pe,a as ve,d as Oe,e as Re,f as Qe,h as L,k as ee,l as be,n as G,o as q,p as N,q as ar,r as Z,s as or,u as hr,v as lr,x as C,y as $,z as oe}from"./chunk-WHUUA6IU.js";function S(n,e,t,r){var i=arguments.length,s=i<3?e:r===null?r=Object.getOwnPropertyDescriptor(e,t):r,a;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")s=Reflect.decorate(n,e,t,r);else for(var o=n.length-1;o>=0;o--)(a=n[o])&&(s=(i<3?a(s):i>3?a(e,t,s):a(e,t))||s);return i>3&&s&&Object.defineProperty(e,t,s),s}var $e={},Je={};function ur(n){let e=n.getClassName();return Je[e]||(Je[e]={}),Je[e]}function et(n){let e=n.getClassName();if($e[e])return $e[e];$e[e]={};let t=$e[e],r=n,i=e;for(;i;){let s=Je[i];for(let h in s)t[h]=s[h];let a,o=!1;do{if(a=Object.getPrototypeOf(r),!a.getClassName){o=!0;break}if(a.getClassName()!==i)break;r=a}while(a);if(o)break;i=a.getClassName(),r=a}return t}function ue(n,e){return(t,r)=>{let i=ur(t);i[r]||(i[r]={type:n,sourceName:e})}}function oi(n,e=null){return(t,r)=>{let i=e||"_"+r;Object.defineProperty(t,r,{get:function(){return this[i]},set:function(s){typeof this.equals=="function"&&this.equals(s)||this[i]!==s&&(this[i]=s,t[n].apply(this))},enumerable:!0,configurable:!0})}}function Ui(n,e=null){return oi(n,e)}function I(n){return ue(0,n)}function _r(n){return ue(1,n)}function Di(n){return ue(2,n)}function Li(n){return ue(3,n)}function vi(n){return ue(4,n)}function Oi(n){return ue(5,n)}function zi(n){return ue(6,n)}function Ni(n){return ue(7,n)}function Gi(n){return ue(8,n)}function ki(n){return ue(9,n)}function Vi(n){return ue(10,n)}function Ki(n){return ue(12,n)}function Hi(n){return ue(11,n)}function fr(n,e,t,r){let i=t.value;t.value=(...s)=>{let a=i;if(typeof _native<"u"&&_native[e]){let o=_native[e];r?a=(...h)=>r(...h)?o(...h):i(...h):a=o}return n[e]=a,a(...s)}}fr.filter=function(n){return(e,t,r)=>fr(e,t,r,n)};var dr={};function v(n,e=!1){if(!(e&&dr[n]))return dr[n]=!0,`${n} needs to be imported before as it contains a side-effect required by your code.`}var tt=class n{static Eval(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,r=>(r=r.slice(1,r.length-1),n._HandleParenthesisContent(r,t))):e=n._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:n.Eval(e,t)}static _HandleParenthesisContent(e,t){t=t||(s=>s==="true");let r,i=e.split("||");for(let s in i)if(Object.prototype.hasOwnProperty.call(i,s)){let a=n._SimplifyNegation(i[s].trim()),o=a.split("&&");if(o.length>1)for(let h=0;h<o.length;++h){let l=n._SimplifyNegation(o[h].trim());if(l!=="true"&&l!=="false"?l[0]==="!"?r=!t(l.substring(1)):r=t(l):r=l==="true",!r){a="false";break}}if(r||a==="true"){r=!0;break}a!=="true"&&a!=="false"?a[0]==="!"?r=!t(a.substring(1)):r=t(a):r=a==="true"}return r?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>""),t.length%2?"!":"")),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e}};var me=class n{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>n.HasTags(e),e.addTags=t=>n.AddTagsTo(e,t),e.removeTags=t=>n.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>n.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;let t=e._tags;for(let r in t)if(Object.prototype.hasOwnProperty.call(t,r))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){let r=[];for(let i in e._tags)Object.prototype.hasOwnProperty.call(e._tags,i)&&e._tags[i]===!0&&r.push(i);return r.join(" ")}else return e._tags}static AddTagsTo(e,t){if(!t||typeof t!="string")return;t.split(" ").forEach(function(i){n._AddTagTo(e,i)})}static _AddTagTo(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(n.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!n.HasTags(e))return;let r=t.split(" ");for(let i in r)n._RemoveTagFrom(e,r[i])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return t===void 0?!0:t===""?n.HasTags(e):tt.Eval(t,r=>n.HasTags(e)&&e._tags[r])}};var te=class n{static SetMatrixPrecision(e){if(n.MatrixTrackPrecisionChange=!1,e&&!n.MatrixUse64Bits&&n.MatrixTrackedMatrices)for(let t=0;t<n.MatrixTrackedMatrices.length;++t){let r=n.MatrixTrackedMatrices[t],i=r._m;r._m=new Array(16);for(let s=0;s<16;++s)r._m[s]=i[s]}n.MatrixUse64Bits=e,n.MatrixCurrentType=n.MatrixUse64Bits?Array:Float32Array,n.MatrixTrackedMatrices=null}};te.MatrixUse64Bits=!1;te.MatrixTrackPrecisionChange=!0;te.MatrixCurrentType=Float32Array;te.MatrixTrackedMatrices=[];var re=n=>parseInt(n.toString().replace(/\W/g,"")),Ee=class n{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){let e=re(this.x),t=re(this.y),r=e;return r=r*397^t,r}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return n.FromArrayToRef(e,t,this),this}asArray(){return[this.x,this.y]}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}setAll(e){return this.copyFromFloats(e,e)}add(e){return new n(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addInPlaceFromFloats(e,t){return this.x+=e,this.y+=t,this}addVector3(e){return new n(this.x+e.x,this.y+e.y)}subtract(e){return new n(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new n(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new n(this.x*e,this.y*t)}divide(e){return new n(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.x=this.x/e.x,this.y=this.y/e.y,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e.x,e.y)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e.x,e.y)}minimizeInPlaceFromFloats(e,t){return this.x=Math.min(e,this.x),this.y=Math.min(t,this.y),this}maximizeInPlaceFromFloats(e,t){return this.x=Math.max(e,this.x),this.y=Math.max(t,this.y),this}subtractFromFloats(e,t){return new n(this.x-e,this.y-t)}subtractFromFloatsToRef(e,t,r){return r.x=this.x-e,r.y=this.y-t,r}negate(){return new n(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.x=-this.x,e.y=-this.y,e}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){return new n(this.x*e,this.y*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=ee){return e&&q(this.x,e.x,t)&&q(this.y,e.y,t)}equalsToFloats(e,t){return this.x===e&&this.y===t}floor(){return new n(Math.floor(this.x),Math.floor(this.y))}floorToRef(e){return e.x=Math.floor(this.x),e.y=Math.floor(this.y),e}fract(){return new n(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}fractToRef(e){return e.x=this.x-Math.floor(this.x),e.y=this.y-Math.floor(this.y),e}rotateToRef(e,t){let r=Math.cos(e),i=Math.sin(e),s=r*this.x-i*this.y,a=i*this.x+r*this.y;return t.x=s,t.y=a,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){let e=new n;return this.normalizeToRef(e),e}normalizeToRef(e){let t=this.length();return t===0&&(e.x=this.x,e.y=this.y),this.scaleToRef(1/t,e)}clone(){return new n(this.x,this.y)}dot(e){return this.x*e.x+this.y*e.y}static Zero(){return new n(0,0)}static One(){return new n(1,1)}static Random(e=0,t=1){return new n(N(e,t),N(e,t))}static RandomToRef(e=0,t=1,r){return r.copyFromFloats(N(e,t),N(e,t))}static get ZeroReadOnly(){return n._ZeroReadOnly}static FromArray(e,t=0){return new n(e[t],e[t+1])}static FromArrayToRef(e,t,r){return r.x=e[t],r.y=e[t+1],r}static FromFloatsToRef(e,t,r){return r.copyFromFloats(e,t),r}static CatmullRom(e,t,r,i,s){let a=s*s,o=s*a,h=.5*(2*t.x+(-e.x+r.x)*s+(2*e.x-5*t.x+4*r.x-i.x)*a+(-e.x+3*t.x-3*r.x+i.x)*o),l=.5*(2*t.y+(-e.y+r.y)*s+(2*e.y-5*t.y+4*r.y-i.y)*a+(-e.y+3*t.y-3*r.y+i.y)*o);return new n(h,l)}static ClampToRef(e,t,r,i){return i.x=Z(e.x,t.x,r.x),i.y=Z(e.y,t.y,r.y),i}static Clamp(e,t,r){let i=Z(e.x,t.x,r.x),s=Z(e.y,t.y,r.y);return new n(i,s)}static Hermite(e,t,r,i,s){let a=s*s,o=s*a,h=2*o-3*a+1,l=-2*o+3*a,u=o-2*a+s,c=o-a,f=e.x*h+r.x*l+t.x*u+i.x*c,_=e.y*h+r.y*l+t.y*u+i.y*c;return new n(f,_)}static Hermite1stDerivative(e,t,r,i,s){return this.Hermite1stDerivativeToRef(e,t,r,i,s,new n)}static Hermite1stDerivativeToRef(e,t,r,i,s,a){let o=s*s;return a.x=(o-s)*6*e.x+(3*o-4*s+1)*t.x+(-o+s)*6*r.x+(3*o-2*s)*i.x,a.y=(o-s)*6*e.y+(3*o-4*s+1)*t.y+(-o+s)*6*r.y+(3*o-2*s)*i.y,a}static Lerp(e,t,r){let i=e.x+(t.x-e.x)*r,s=e.y+(t.y-e.y)*r;return new n(i,s)}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){return n.NormalizeToRef(e,new n)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){let r=e.x<t.x?e.x:t.x,i=e.y<t.y?e.y:t.y;return new n(r,i)}static Maximize(e,t){let r=e.x>t.x?e.x:t.x,i=e.y>t.y?e.y:t.y;return new n(r,i)}static Transform(e,t){return n.TransformToRef(e,t,new n)}static TransformToRef(e,t,r){let i=t.m,s=e.x*i[0]+e.y*i[4]+i[12],a=e.x*i[1]+e.y*i[5]+i[13];return r.x=s,r.y=a,r}static PointInTriangle(e,t,r,i){let s=.5*(-r.y*i.x+t.y*(-r.x+i.x)+t.x*(r.y-i.y)+r.x*i.y),a=s<0?-1:1,o=(t.y*i.x-t.x*i.y+(i.y-t.y)*e.x+(t.x-i.x)*e.y)*a,h=(t.x*r.y-t.y*r.x+(t.y-r.y)*e.x+(r.x-t.x)*e.y)*a;return o>0&&h>0&&o+h<2*s*a}static Distance(e,t){return Math.sqrt(n.DistanceSquared(e,t))}static DistanceSquared(e,t){let r=e.x-t.x,i=e.y-t.y;return r*r+i*i}static Center(e,t){return n.CenterToRef(e,t,new n)}static CenterToRef(e,t,r){return r.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,r){let i=n.DistanceSquared(t,r);if(i===0)return n.Distance(e,t);let s=r.subtract(t),a=Math.max(0,Math.min(1,n.Dot(e.subtract(t),s)/i)),o=t.add(s.multiplyByFloats(a,a));return n.Distance(e,o)}};Ee._ZeroReadOnly=Ee.Zero();Object.defineProperties(Ee.prototype,{dimension:{value:[2]},rank:{value:1}});var b=class n{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,r=0){this._isDirty=!0,this._x=e,this._y=t,this._z=r}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){let e=re(this._x),t=re(this._y),r=re(this._z),i=e;return i=i*397^t,i=i*397^r,i}asArray(){return[this._x,this._y,this._z]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return n.FromArrayToRef(e,t,this),this}toQuaternion(){return fe.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._isDirty=!0,this}addInPlaceFromFloats(e,t,r){return this._x+=e,this._y+=t,this._z+=r,this._isDirty=!0,this}add(e){return new n(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new n(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,r){return new n(this._x-e,this._y-t,this._z-r)}subtractFromFloatsToRef(e,t,r,i){return i.copyFromFloats(this._x-e,this._y-t,this._z-r)}negate(){return new n(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e.copyFromFloats(this._x*-1,this._y*-1,this._z*-1)}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new n(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}getNormalToRef(e){let t=this.length(),r=Math.acos(this.y/t),i=Math.atan2(this.z,this.x);r>Math.PI/2?r-=Math.PI/2:r+=Math.PI/2;let s=t*Math.sin(r)*Math.cos(i),a=t*Math.cos(r),o=t*Math.sin(r)*Math.sin(i);return e.set(s,a,o),e}applyRotationQuaternionToRef(e,t){let r=this._x,i=this._y,s=this._z,a=e._x,o=e._y,h=e._z,l=e._w,u=2*(o*s-h*i),c=2*(h*r-a*s),f=2*(a*i-o*r);return t._x=r+l*u+o*f-h*c,t._y=i+l*c+h*u-a*f,t._z=s+l*f+a*c-o*u,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new n)}scaleAndAddToRef(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,t){return this.projectOnPlaneToRef(e,t,new n)}projectOnPlaneToRef(e,t,r){let i=e.normal,s=e.d,a=p.Vector3[0];this.subtractToRef(t,a),a.normalize();let o=n.Dot(a,i);if(Math.abs(o)<1e-10)r.setAll(1/0);else{let h=-(n.Dot(t,i)+s)/o,l=a.scaleInPlace(h);t.addToRef(l,r)}return r}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=ee){return e&&q(this._x,e._x,t)&&q(this._y,e._y,t)&&q(this._z,e._z,t)}equalsToFloats(e,t,r){return this._x===e&&this._y===t&&this._z===r}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,t,r){return new n(this._x*e,this._y*t,this._z*r)}divide(e){return new n(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this._x=this._x/e._x,this._y=this._y/e._y,this._z=this._z/e._z,this._isDirty=!0,this}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,r){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),r<this._z&&(this.z=r),this}maximizeInPlaceFromFloats(e,t,r){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),r>this._z&&(this.z=r),this}isNonUniformWithinEpsilon(e){let t=Math.abs(this._x),r=Math.abs(this._y);if(!q(t,r,e))return!0;let i=Math.abs(this._z);return!q(t,i,e)||!q(r,i,e)}get isNonUniform(){let e=Math.abs(this._x),t=Math.abs(this._y);if(e!==t)return!0;let r=Math.abs(this._z);return e!==r}floorToRef(e){return e._x=Math.floor(this._x),e._y=Math.floor(this._y),e._z=Math.floor(this._z),e._isDirty=!0,e}floor(){return new n(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}fractToRef(e){return e._x=this.x-Math.floor(this._x),e._y=this.y-Math.floor(this._y),e._z=this.z-Math.floor(this._z),e._isDirty=!0,e}fract(){return new n(this.x-Math.floor(this._x),this.y-Math.floor(this._y),this.z-Math.floor(this._z))}length(){return Math.sqrt(this.lengthSquared())}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){if(e=e.toLowerCase(),e==="xyz")return this;let t=p.Vector3[0].copyFrom(this);return this.x=t[e[0]],this.y=t[e[1]],this.z=t[e[2]],this}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(p.Matrix[0]),n.TransformCoordinatesToRef(this,p.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,r){return this.subtractToRef(t,p.Vector3[0]),p.Vector3[0].rotateByQuaternionToRef(e,p.Vector3[0]),t.addToRef(p.Vector3[0],r),r}cross(e){return n.CrossToRef(this,e,new n)}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new n)}normalizeToRef(e){let t=this.length();return t===0||t===1?e.copyFrom(this):this.scaleToRef(1/t,e)}clone(){return new n(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,r){return this._x=e,this._y=t,this._z=r,this._isDirty=!0,this}set(e,t,r){return this.copyFromFloats(e,t,r)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(e,t,r,i){let s=n.Dot(e,r),a=n.Dot(t,r);return(s-i)/(s-a)}static GetAngleBetweenVectors(e,t,r){let i=e.normalizeToRef(p.Vector3[1]),s=t.normalizeToRef(p.Vector3[2]),a=n.Dot(i,s);a=Z(a,-1,1);let o=Math.acos(a),h=p.Vector3[3];return n.CrossToRef(i,s,h),n.Dot(h,r)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(a)}static GetAngleBetweenVectorsOnPlane(e,t,r){p.Vector3[0].copyFrom(e);let i=p.Vector3[0];p.Vector3[1].copyFrom(t);let s=p.Vector3[1];p.Vector3[2].copyFrom(r);let a=p.Vector3[2],o=p.Vector3[3],h=p.Vector3[4];i.normalize(),s.normalize(),a.normalize(),n.CrossToRef(a,i,o),n.CrossToRef(o,a,h);let l=Math.atan2(n.Dot(s,o),n.Dot(s,h));return or(l)}static PitchYawRollToMoveBetweenPointsToRef(e,t,r){let i=H.Vector3[0];return t.subtractToRef(e,i),r._y=Math.atan2(i.x,i.z)||0,r._x=Math.atan2(Math.sqrt(i.x**2+i.z**2),i.y)||0,r._z=0,r._isDirty=!0,r}static PitchYawRollToMoveBetweenPoints(e,t){let r=n.Zero();return n.PitchYawRollToMoveBetweenPointsToRef(e,t,r)}static SlerpToRef(e,t,r,i){r=Z(r,0,1);let s=p.Vector3[0],a=p.Vector3[1];s.copyFrom(e);let o=s.length();s.normalizeFromLength(o),a.copyFrom(t);let h=a.length();a.normalizeFromLength(h);let l=n.Dot(s,a),u,c;if(l<1-ee){let f=Math.acos(l),_=1/Math.sin(f);u=Math.sin((1-r)*f)*_,c=Math.sin(r*f)*_}else u=1-r,c=r;return s.scaleInPlace(u),a.scaleInPlace(c),i.copyFrom(s).addInPlace(a),i.scaleInPlace(ar(o,h,r)),i}static SmoothToRef(e,t,r,i,s){return n.SlerpToRef(e,t,i===0?1:r/i,s),s}static FromArray(e,t=0){return new n(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return n.FromArray(e,t)}static FromArrayToRef(e,t,r){return r._x=e[t],r._y=e[t+1],r._z=e[t+2],r._isDirty=!0,r}static FromFloatArrayToRef(e,t,r){return n.FromArrayToRef(e,t,r)}static FromFloatsToRef(e,t,r,i){return i.copyFromFloats(e,t,r),i}static Zero(){return new n(0,0,0)}static One(){return new n(1,1,1)}static Up(){return new n(0,1,0)}static get UpReadOnly(){return n._UpReadOnly}static get DownReadOnly(){return n._DownReadOnly}static get RightReadOnly(){return n._RightReadOnly}static get LeftReadOnly(){return n._LeftReadOnly}static get LeftHandedForwardReadOnly(){return n._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return n._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return n._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return n._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return n._ZeroReadOnly}static get OneReadOnly(){return n._OneReadOnly}static Down(){return new n(0,-1,0)}static Forward(e=!1){return new n(0,0,e?-1:1)}static Backward(e=!1){return new n(0,0,e?1:-1)}static Right(){return new n(1,0,0)}static Left(){return new n(-1,0,0)}static Random(e=0,t=1){return new n(N(e,t),N(e,t),N(e,t))}static RandomToRef(e=0,t=1,r){return r.copyFromFloats(N(e,t),N(e,t),N(e,t))}static TransformCoordinates(e,t){let r=n.Zero();return n.TransformCoordinatesToRef(e,t,r),r}static TransformCoordinatesToRef(e,t,r){return n.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,r),r}static TransformCoordinatesFromFloatsToRef(e,t,r,i,s){let a=i.m,o=e*a[0]+t*a[4]+r*a[8]+a[12],h=e*a[1]+t*a[5]+r*a[9]+a[13],l=e*a[2]+t*a[6]+r*a[10]+a[14],u=1/(e*a[3]+t*a[7]+r*a[11]+a[15]);return s._x=o*u,s._y=h*u,s._z=l*u,s._isDirty=!0,s}static TransformNormal(e,t){let r=n.Zero();return n.TransformNormalToRef(e,t,r),r}static TransformNormalToRef(e,t,r){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,r),r}static TransformNormalFromFloatsToRef(e,t,r,i,s){let a=i.m;return s._x=e*a[0]+t*a[4]+r*a[8],s._y=e*a[1]+t*a[5]+r*a[9],s._z=e*a[2]+t*a[6]+r*a[10],s._isDirty=!0,s}static CatmullRom(e,t,r,i,s){let a=s*s,o=s*a,h=.5*(2*t._x+(-e._x+r._x)*s+(2*e._x-5*t._x+4*r._x-i._x)*a+(-e._x+3*t._x-3*r._x+i._x)*o),l=.5*(2*t._y+(-e._y+r._y)*s+(2*e._y-5*t._y+4*r._y-i._y)*a+(-e._y+3*t._y-3*r._y+i._y)*o),u=.5*(2*t._z+(-e._z+r._z)*s+(2*e._z-5*t._z+4*r._z-i._z)*a+(-e._z+3*t._z-3*r._z+i._z)*o);return new n(h,l,u)}static Clamp(e,t,r){let i=new n;return n.ClampToRef(e,t,r,i),i}static ClampToRef(e,t,r,i){let s=e._x;s=s>r._x?r._x:s,s=s<t._x?t._x:s;let a=e._y;a=a>r._y?r._y:a,a=a<t._y?t._y:a;let o=e._z;return o=o>r._z?r._z:o,o=o<t._z?t._z:o,i.copyFromFloats(s,a,o),i}static CheckExtends(e,t,r){t.minimizeInPlace(e),r.maximizeInPlace(e)}static Hermite(e,t,r,i,s){let a=s*s,o=s*a,h=2*o-3*a+1,l=-2*o+3*a,u=o-2*a+s,c=o-a,f=e._x*h+r._x*l+t._x*u+i._x*c,_=e._y*h+r._y*l+t._y*u+i._y*c,d=e._z*h+r._z*l+t._z*u+i._z*c;return new n(f,_,d)}static Hermite1stDerivative(e,t,r,i,s){let a=new n;return this.Hermite1stDerivativeToRef(e,t,r,i,s,a),a}static Hermite1stDerivativeToRef(e,t,r,i,s,a){let o=s*s;return a._x=(o-s)*6*e._x+(3*o-4*s+1)*t._x+(-o+s)*6*r._x+(3*o-2*s)*i._x,a._y=(o-s)*6*e._y+(3*o-4*s+1)*t._y+(-o+s)*6*r._y+(3*o-2*s)*i._y,a._z=(o-s)*6*e._z+(3*o-4*s+1)*t._z+(-o+s)*6*r._z+(3*o-2*s)*i._z,a._isDirty=!0,a}static Lerp(e,t,r){let i=new n(0,0,0);return n.LerpToRef(e,t,r,i),i}static LerpToRef(e,t,r,i){return i._x=e._x+(t._x-e._x)*r,i._y=e._y+(t._y-e._y)*r,i._z=e._z+(t._z-e._z)*r,i._isDirty=!0,i}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z}static Cross(e,t){let r=new n;return n.CrossToRef(e,t,r),r}static CrossToRef(e,t,r){let i=e._y*t._z-e._z*t._y,s=e._z*t._x-e._x*t._z,a=e._x*t._y-e._y*t._x;return r.copyFromFloats(i,s,a),r}static Normalize(e){let t=n.Zero();return n.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(e,t,r,i){let s=new n;return n.ProjectToRef(e,t,r,i,s),s}static ProjectToRef(e,t,r,i,s){let a=i.width,o=i.height,h=i.x,l=i.y,u=p.Matrix[1],c=G.LastCreatedEngine?.isNDCHalfZRange,f=c?1:.5,_=c?0:.5;M.FromValuesToRef(a/2,0,0,0,0,-o/2,0,0,0,0,f,0,h+a/2,o/2+l,_,1,u);let d=p.Matrix[0];return t.multiplyToRef(r,d),d.multiplyToRef(u,d),n.TransformCoordinatesToRef(e,d,s),s}static Reflect(e,t){return this.ReflectToRef(e,t,new n)}static ReflectToRef(e,t,r){let i=H.Vector3[0];return i.copyFrom(t).scaleInPlace(2*n.Dot(e,t)),r.copyFrom(e).subtractInPlace(i)}static _UnprojectFromInvertedMatrixToRef(e,t,r){n.TransformCoordinatesToRef(e,t,r);let i=t.m,s=e._x*i[3]+e._y*i[7]+e._z*i[11]+i[15];return q(s,1)&&r.scaleInPlace(1/s),r}static UnprojectFromTransform(e,t,r,i,s){return this.Unproject(e,t,r,i,s,M.IdentityReadOnly)}static Unproject(e,t,r,i,s,a){let o=new n;return n.UnprojectToRef(e,t,r,i,s,a,o),o}static UnprojectToRef(e,t,r,i,s,a,o){return n.UnprojectFloatsToRef(e._x,e._y,e._z,t,r,i,s,a,o),o}static UnprojectFloatsToRef(e,t,r,i,s,a,o,h,l){let u=p.Matrix[0];a.multiplyToRef(o,u),u.multiplyToRef(h,u),u.invert();let c=p.Vector3[0];return c.x=e/i*2-1,c.y=-(t/s*2-1),G.LastCreatedEngine?.isNDCHalfZRange?c.z=r:c.z=2*r-1,n._UnprojectFromInvertedMatrixToRef(c,u,l),l}static Minimize(e,t){let r=new n;return r.copyFrom(e),r.minimizeInPlace(t),r}static Maximize(e,t){let r=new n;return r.copyFrom(e),r.maximizeInPlace(t),r}static Distance(e,t){return Math.sqrt(n.DistanceSquared(e,t))}static DistanceSquared(e,t){let r=e._x-t._x,i=e._y-t._y,s=e._z-t._z;return r*r+i*i+s*s}static ProjectOnTriangleToRef(e,t,r,i,s){let a=p.Vector3[0],o=p.Vector3[1],h=p.Vector3[2],l=p.Vector3[3],u=p.Vector3[4];r.subtractToRef(t,a),i.subtractToRef(t,o),i.subtractToRef(r,h);let c=a.length(),f=o.length(),_=h.length();if(c<ee||f<ee||_<ee)return s.copyFrom(t),n.Distance(e,t);e.subtractToRef(t,u),n.CrossToRef(a,o,l);let d=l.length();if(d<ee)return s.copyFrom(t),n.Distance(e,t);l.normalizeFromLength(d);let m=u.length();if(m<ee)return s.copyFrom(t),0;u.normalizeFromLength(m);let T=n.Dot(l,u),R=p.Vector3[5],g=p.Vector3[6];R.copyFrom(l).scaleInPlace(-m*T),g.copyFrom(e).addInPlace(R);let F=p.Vector3[4],E=p.Vector3[5],x=p.Vector3[7],y=p.Vector3[8];F.copyFrom(a).scaleInPlace(1/c),y.copyFrom(o).scaleInPlace(1/f),F.addInPlace(y).scaleInPlace(-1),E.copyFrom(a).scaleInPlace(-1/c),y.copyFrom(h).scaleInPlace(1/_),E.addInPlace(y).scaleInPlace(-1),x.copyFrom(h).scaleInPlace(-1/_),y.copyFrom(o).scaleInPlace(-1/f),x.addInPlace(y).scaleInPlace(-1);let B=p.Vector3[9],w;B.copyFrom(g).subtractInPlace(t),n.CrossToRef(F,B,y),w=n.Dot(y,l);let j=w;B.copyFrom(g).subtractInPlace(r),n.CrossToRef(E,B,y),w=n.Dot(y,l);let X=w;B.copyFrom(g).subtractInPlace(i),n.CrossToRef(x,B,y),w=n.Dot(y,l);let J=w,W=p.Vector3[10],D,P;j>0&&X<0?(W.copyFrom(a),D=t,P=r):X>0&&J<0?(W.copyFrom(h),D=r,P=i):(W.copyFrom(o).scaleInPlace(-1),D=i,P=t);let se=p.Vector3[9],le=p.Vector3[4];if(D.subtractToRef(g,y),P.subtractToRef(g,se),n.CrossToRef(y,se,le),!(n.Dot(le,l)<0))return s.copyFrom(g),Math.abs(m*T);let ne=p.Vector3[5];n.CrossToRef(W,le,ne),ne.normalize();let ae=p.Vector3[9];ae.copyFrom(D).subtractInPlace(g);let ce=ae.length();if(ce<ee)return s.copyFrom(D),n.Distance(e,D);ae.normalizeFromLength(ce);let Te=n.Dot(ne,ae),Ce=p.Vector3[7];Ce.copyFrom(g).addInPlace(ne.scaleInPlace(ce*Te)),y.copyFrom(Ce).subtractInPlace(D),m=W.length(),W.normalizeFromLength(m);let Le=n.Dot(y,W)/Math.max(m,ee);return Le=Z(Le,0,1),Ce.copyFrom(D).addInPlace(W.scaleInPlace(Le*m)),s.copyFrom(Ce),n.Distance(e,Ce)}static Center(e,t){return n.CenterToRef(e,t,n.Zero())}static CenterToRef(e,t,r){return r.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,r){let i=new n;return n.RotationFromAxisToRef(e,t,r,i),i}static RotationFromAxisToRef(e,t,r,i){let s=p.Quaternion[0];return fe.RotationQuaternionFromAxisToRef(e,t,r,s),s.toEulerAnglesToRef(i),i}};b._UpReadOnly=b.Up();b._DownReadOnly=b.Down();b._LeftHandedForwardReadOnly=b.Forward(!1);b._RightHandedForwardReadOnly=b.Forward(!0);b._LeftHandedBackwardReadOnly=b.Backward(!1);b._RightHandedBackwardReadOnly=b.Backward(!0);b._RightReadOnly=b.Right();b._LeftReadOnly=b.Left();b._ZeroReadOnly=b.Zero();b._OneReadOnly=b.One();Object.defineProperties(b.prototype,{dimension:{value:[3]},rank:{value:1}});var we=class n{constructor(e=0,t=0,r=0,i=0){this.x=e,this.y=t,this.z=r,this.w=i}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){let e=re(this.x),t=re(this.y),r=re(this.z),i=re(this.w),s=e;return s=s*397^t,s=s*397^r,s=s*397^i,s}asArray(){return[this.x,this.y,this.z,this.w]}toArray(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return n.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addInPlaceFromFloats(e,t,r,i){return this.x+=e,this.y+=t,this.z+=r,this.w+=i,this}add(e){return new n(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new n(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,r,i){return new n(this.x-e,this.y-t,this.z-r,this.w-i)}subtractFromFloatsToRef(e,t,r,i,s){return s.x=this.x-e,s.y=this.y-t,s.z=this.z-r,s.w=this.w-i,s}negate(){return new n(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.x=-this.x,e.y=-this.y,e.z=-this.z,e.w=-this.w,e}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new n(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=ee){return e&&q(this.x,e.x,t)&&q(this.y,e.y,t)&&q(this.z,e.z,t)&&q(this.w,e.w,t)}equalsToFloats(e,t,r,i){return this.x===e&&this.y===t&&this.z===r&&this.w===i}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new n(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,r,i){return new n(this.x*e,this.y*t,this.z*r,this.w*i)}divide(e){return new n(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}minimizeInPlaceFromFloats(e,t,r,i){return this.x=Math.min(e,this.x),this.y=Math.min(t,this.y),this.z=Math.min(r,this.z),this.w=Math.min(i,this.w),this}maximizeInPlaceFromFloats(e,t,r,i){return this.x=Math.max(e,this.x),this.y=Math.max(t,this.y),this.z=Math.max(r,this.z),this.w=Math.max(i,this.w),this}floorToRef(e){return e.x=Math.floor(this.x),e.y=Math.floor(this.y),e.z=Math.floor(this.z),e.w=Math.floor(this.w),e}floor(){return new n(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fractToRef(e){return e.x=this.x-Math.floor(this.x),e.y=this.y-Math.floor(this.y),e.z=this.z-Math.floor(this.z),e.w=this.w-Math.floor(this.w),e}fract(){return new n(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){return this.normalizeToRef(new n)}normalizeToRef(e){let t=this.length();return t===0||t===1?(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w,e):this.scaleToRef(1/t,e)}toVector3(){return new b(this.x,this.y,this.z)}clone(){return new n(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this}set(e,t,r,i){return this.copyFromFloats(e,t,r,i)}setAll(e){return this.x=this.y=this.z=this.w=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}static FromArray(e,t){return t||(t=0),new n(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,r){return r.x=e[t],r.y=e[t+1],r.z=e[t+2],r.w=e[t+3],r}static FromFloatArrayToRef(e,t,r){return n.FromArrayToRef(e,t,r),r}static FromFloatsToRef(e,t,r,i,s){return s.x=e,s.y=t,s.z=r,s.w=i,s}static Zero(){return new n(0,0,0,0)}static One(){return new n(1,1,1,1)}static Random(e=0,t=1){return new n(N(e,t),N(e,t),N(e,t),N(e,t))}static RandomToRef(e=0,t=1,r){return r.x=N(e,t),r.y=N(e,t),r.z=N(e,t),r.w=N(e,t),r}static Clamp(e,t,r){return n.ClampToRef(e,t,r,new n)}static ClampToRef(e,t,r,i){return i.x=Z(e.x,t.x,r.x),i.y=Z(e.y,t.y,r.y),i.z=Z(e.z,t.z,r.z),i.w=Z(e.w,t.w,r.w),i}static CheckExtends(e,t,r){t.minimizeInPlace(e),r.maximizeInPlace(e)}static get ZeroReadOnly(){return n._ZeroReadOnly}static Normalize(e){return n.NormalizeToRef(e,new n)}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Minimize(e,t){let r=new n;return r.copyFrom(e),r.minimizeInPlace(t),r}static Maximize(e,t){let r=new n;return r.copyFrom(e),r.maximizeInPlace(t),r}static Distance(e,t){return Math.sqrt(n.DistanceSquared(e,t))}static DistanceSquared(e,t){let r=e.x-t.x,i=e.y-t.y,s=e.z-t.z,a=e.w-t.w;return r*r+i*i+s*s+a*a}static Center(e,t){return n.CenterToRef(e,t,new n)}static CenterToRef(e,t,r){return r.x=(e.x+t.x)/2,r.y=(e.y+t.y)/2,r.z=(e.z+t.z)/2,r.w=(e.w+t.w)/2,r}static TransformCoordinates(e,t){return n.TransformCoordinatesToRef(e,t,new n)}static TransformCoordinatesToRef(e,t,r){return n.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,r),r}static TransformCoordinatesFromFloatsToRef(e,t,r,i,s){let a=i.m,o=e*a[0]+t*a[4]+r*a[8]+a[12],h=e*a[1]+t*a[5]+r*a[9]+a[13],l=e*a[2]+t*a[6]+r*a[10]+a[14],u=e*a[3]+t*a[7]+r*a[11]+a[15];return s.x=o,s.y=h,s.z=l,s.w=u,s}static TransformNormal(e,t){return n.TransformNormalToRef(e,t,new n)}static TransformNormalToRef(e,t,r){let i=t.m,s=e.x*i[0]+e.y*i[4]+e.z*i[8],a=e.x*i[1]+e.y*i[5]+e.z*i[9],o=e.x*i[2]+e.y*i[6]+e.z*i[10];return r.x=s,r.y=a,r.z=o,r.w=e.w,r}static TransformNormalFromFloatsToRef(e,t,r,i,s,a){let o=s.m;return a.x=e*o[0]+t*o[4]+r*o[8],a.y=e*o[1]+t*o[5]+r*o[9],a.z=e*o[2]+t*o[6]+r*o[10],a.w=i,a}static FromVector3(e,t=0){return new n(e._x,e._y,e._z,t)}static Dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}};we._ZeroReadOnly=we.Zero();Object.defineProperties(we.prototype,{dimension:{value:[4]},rank:{value:1}});var fe=class n{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,r=0,i=1){this._isDirty=!0,this._x=e,this._y=t,this._z=r,this._w=i}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){let e=re(this._x),t=re(this._y),r=re(this._z),i=re(this._w),s=e;return s=s*397^t,s=s*397^r,s=s*397^i,s}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}fromArray(e,t=0){return n.FromArrayToRef(e,t,this)}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=ee){return e&&q(this._x,e._x,t)&&q(this._y,e._y,t)&&q(this._z,e._z,t)&&q(this._w,e._w,t)}clone(){return new n(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,r,i){return this._x=e,this._y=t,this._z=r,this._w=i,this._isDirty=!0,this}set(e,t,r,i){return this.copyFromFloats(e,t,r,i)}setAll(e){return this.copyFromFloats(e,e,e,e)}add(e){return new n(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}addToRef(e,t){return t._x=this._x+e._x,t._y=this._y+e._y,t._z=this._z+e._z,t._w=this._w+e._w,t._isDirty=!0,t}addInPlaceFromFloats(e,t,r,i){return this._x+=e,this._y+=t,this._z+=r,this._w+=i,this._isDirty=!0,this}subtractToRef(e,t){return t._x=this._x-e._x,t._y=this._y-e._y,t._z=this._z-e._z,t._w=this._w-e._w,t._isDirty=!0,t}subtractFromFloats(e,t,r,i){return this.subtractFromFloatsToRef(e,t,r,i,new n)}subtractFromFloatsToRef(e,t,r,i,s){return s._x=this._x-e,s._y=this._y-t,s._z=this._z-r,s._w=this._w-i,s._isDirty=!0,s}subtract(e){return new n(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new n(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){let t=new n(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){let r=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,i=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,s=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,a=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(r,i,s,a),t}multiplyInPlace(e){return this.multiplyToRef(e,this)}multiplyByFloats(e,t,r,i){return this._x*=e,this._y*=t,this._z*=r,this._w*=i,this._isDirty=!0,this}divide(e){throw new ReferenceError("Can not divide a quaternion")}divideToRef(e,t){throw new ReferenceError("Can not divide a quaternion")}divideInPlace(e){throw new ReferenceError("Can not divide a quaternion")}minimizeInPlace(){throw new ReferenceError("Can not minimize a quaternion")}minimizeInPlaceFromFloats(){throw new ReferenceError("Can not minimize a quaternion")}maximizeInPlace(){throw new ReferenceError("Can not maximize a quaternion")}maximizeInPlaceFromFloats(){throw new ReferenceError("Can not maximize a quaternion")}negate(){return this.negateToRef(new n)}negateInPlace(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._isDirty=!0,this}negateToRef(e){return e._x=-this._x,e._y=-this._y,e._z=-this._z,e._w=-this._w,e._isDirty=!0,e}equalsToFloats(e,t,r,i){return this._x===e&&this._y===t&&this._z===r&&this._w===i}floorToRef(e){throw new ReferenceError("Can not floor a quaternion")}floor(){throw new ReferenceError("Can not floor a quaternion")}fractToRef(e){throw new ReferenceError("Can not fract a quaternion")}fract(){throw new ReferenceError("Can not fract a quaternion")}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new n(-this._x,-this._y,-this._z,this._w)}invert(){let e=this.conjugate(),t=this.lengthSquared();return t==0||t==1||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();let e=this.lengthSquared();return e==0||e==1?this:(this.scaleInPlace(1/e),this)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){return this.normalizeFromLength(this.length())}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){let e=new n(0,0,0,1);return this.normalizeToRef(e),e}normalizeToRef(e){let t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z,this._w):this.scaleToRef(1/t,e)}toEulerAngles(){let e=b.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){let t=this._z,r=this._x,i=this._y,s=this._w,a=i*t-r*s,o=.4999999;if(a<-o)e._y=2*Math.atan2(i,s),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(a>o)e._y=2*Math.atan2(i,s),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{let h=s*s,l=t*t,u=r*r,c=i*i;e._z=Math.atan2(2*(r*i+t*s),-l-u+c+h),e._x=Math.asin(-2*a),e._y=Math.atan2(2*(t*r+i*s),l-u-c+h),e._isDirty=!0}return e}toRotationMatrix(e){return M.FromQuaternionToRef(this,e),e}fromRotationMatrix(e){return n.FromRotationMatrixToRef(e,this),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}static FromRotationMatrix(e){let t=new n;return n.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){let r=e.m,i=r[0],s=r[4],a=r[8],o=r[1],h=r[5],l=r[9],u=r[2],c=r[6],f=r[10],_=i+h+f,d;return _>0?(d=.5/Math.sqrt(_+1),t._w=.25/d,t._x=(c-l)*d,t._y=(a-u)*d,t._z=(o-s)*d,t._isDirty=!0):i>h&&i>f?(d=2*Math.sqrt(1+i-h-f),t._w=(c-l)/d,t._x=.25*d,t._y=(s+o)/d,t._z=(a+u)/d,t._isDirty=!0):h>f?(d=2*Math.sqrt(1+h-i-f),t._w=(a-u)/d,t._x=(s+o)/d,t._y=.25*d,t._z=(l+c)/d,t._isDirty=!0):(d=2*Math.sqrt(1+f-i-h),t._w=(o-s)/d,t._x=(a+u)/d,t._y=(l+c)/d,t._z=.25*d,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,r=.1){let i=n.Dot(e,t);return 1-i*i<=r}static SmoothToRef(e,t,r,i,s){let a=i===0?1:r/i;return a=Z(a,0,1),n.SlerpToRef(e,t,a,s),s}static Zero(){return new n(0,0,0,0)}static Inverse(e){return new n(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new n(0,0,0,1)}static IsIdentity(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1}static RotationAxis(e,t){return n.RotationAxisToRef(e,t,new n)}static RotationAxisToRef(e,t,r){let i=Math.sin(t/2);return e.normalize(),r._w=Math.cos(t/2),r._x=e._x*i,r._y=e._y*i,r._z=e._z*i,r._isDirty=!0,r}static FromArray(e,t){return t||(t=0),new n(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,r){return r._x=e[t],r._y=e[t+1],r._z=e[t+2],r._w=e[t+3],r._isDirty=!0,r}static FromFloatsToRef(e,t,r,i,s){return s.copyFromFloats(e,t,r,i),s}static FromEulerAngles(e,t,r){let i=new n;return n.RotationYawPitchRollToRef(t,e,r,i),i}static FromEulerAnglesToRef(e,t,r,i){return n.RotationYawPitchRollToRef(t,e,r,i),i}static FromEulerVector(e){let t=new n;return n.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return n.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,r,i=ee){let s=b.Dot(e,t)+1;return s<i?Math.abs(e.x)>Math.abs(e.z)?r.set(-e.y,e.x,0,0):r.set(0,-e.z,e.y,0):(b.CrossToRef(e,t,H.Vector3[0]),r.set(H.Vector3[0].x,H.Vector3[0].y,H.Vector3[0].z,s)),r.normalize()}static RotationYawPitchRoll(e,t,r){let i=new n;return n.RotationYawPitchRollToRef(e,t,r,i),i}static RotationYawPitchRollToRef(e,t,r,i){let s=r*.5,a=t*.5,o=e*.5,h=Math.sin(s),l=Math.cos(s),u=Math.sin(a),c=Math.cos(a),f=Math.sin(o),_=Math.cos(o);return i._x=_*u*l+f*c*h,i._y=f*c*l-_*u*h,i._z=_*c*h-f*u*l,i._w=_*c*l+f*u*h,i._isDirty=!0,i}static RotationAlphaBetaGamma(e,t,r){let i=new n;return n.RotationAlphaBetaGammaToRef(e,t,r,i),i}static RotationAlphaBetaGammaToRef(e,t,r,i){let s=(r+e)*.5,a=(r-e)*.5,o=t*.5;return i._x=Math.cos(a)*Math.sin(o),i._y=Math.sin(a)*Math.sin(o),i._z=Math.sin(s)*Math.cos(o),i._w=Math.cos(s)*Math.cos(o),i._isDirty=!0,i}static RotationQuaternionFromAxis(e,t,r){let i=new n(0,0,0,0);return n.RotationQuaternionFromAxisToRef(e,t,r,i),i}static RotationQuaternionFromAxisToRef(e,t,r,i){let s=p.Matrix[0];return M.FromXYZAxesToRef(e.normalize(),t.normalize(),r.normalize(),s),n.FromRotationMatrixToRef(s,i),i}static FromLookDirectionLH(e,t){let r=new n;return n.FromLookDirectionLHToRef(e,t,r),r}static FromLookDirectionLHToRef(e,t,r){let i=p.Matrix[0];return M.LookDirectionLHToRef(e,t,i),n.FromRotationMatrixToRef(i,r),r}static FromLookDirectionRH(e,t){let r=new n;return n.FromLookDirectionRHToRef(e,t,r),r}static FromLookDirectionRHToRef(e,t,r){let i=p.Matrix[0];return M.LookDirectionRHToRef(e,t,i),n.FromRotationMatrixToRef(i,r)}static Slerp(e,t,r){let i=n.Identity();return n.SlerpToRef(e,t,r,i),i}static SlerpToRef(e,t,r,i){let s,a,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,h=!1;if(o<0&&(h=!0,o=-o),o>.999999)a=1-r,s=h?-r:r;else{let l=Math.acos(o),u=1/Math.sin(l);a=Math.sin((1-r)*l)*u,s=h?-Math.sin(r*l)*u:Math.sin(r*l)*u}return i._x=a*e._x+s*t._x,i._y=a*e._y+s*t._y,i._z=a*e._z+s*t._z,i._w=a*e._w+s*t._w,i._isDirty=!0,i}static Hermite(e,t,r,i,s){let a=s*s,o=s*a,h=2*o-3*a+1,l=-2*o+3*a,u=o-2*a+s,c=o-a,f=e._x*h+r._x*l+t._x*u+i._x*c,_=e._y*h+r._y*l+t._y*u+i._y*c,d=e._z*h+r._z*l+t._z*u+i._z*c,m=e._w*h+r._w*l+t._w*u+i._w*c;return new n(f,_,d,m)}static Hermite1stDerivative(e,t,r,i,s){let a=new n;return this.Hermite1stDerivativeToRef(e,t,r,i,s,a),a}static Hermite1stDerivativeToRef(e,t,r,i,s,a){let o=s*s;return a._x=(o-s)*6*e._x+(3*o-4*s+1)*t._x+(-o+s)*6*r._x+(3*o-2*s)*i._x,a._y=(o-s)*6*e._y+(3*o-4*s+1)*t._y+(-o+s)*6*r._y+(3*o-2*s)*i._y,a._z=(o-s)*6*e._z+(3*o-4*s+1)*t._z+(-o+s)*6*r._z+(3*o-2*s)*i._z,a._w=(o-s)*6*e._w+(3*o-4*s+1)*t._w+(-o+s)*6*r._w+(3*o-2*s)*i._w,a._isDirty=!0,a}static Normalize(e){let t=n.Zero();return n.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Clamp(e,t,r){let i=new n;return n.ClampToRef(e,t,r,i),i}static ClampToRef(e,t,r,i){return i.copyFromFloats(Z(e.x,t.x,r.x),Z(e.y,t.y,r.y),Z(e.z,t.z,r.z),Z(e.w,t.w,r.w))}static Random(e=0,t=1){return new n(N(e,t),N(e,t),N(e,t),N(e,t))}static RandomToRef(e=0,t=1,r){return r.copyFromFloats(N(e,t),N(e,t),N(e,t),N(e,t))}static Minimize(){throw new ReferenceError("Quaternion.Minimize does not make sense")}static Maximize(){throw new ReferenceError("Quaternion.Maximize does not make sense")}static Distance(e,t){return Math.sqrt(n.DistanceSquared(e,t))}static DistanceSquared(e,t){let r=e.x-t.x,i=e.y-t.y,s=e.z-t.z,a=e.w-t.w;return r*r+i*i+s*s+a*a}static Center(e,t){return n.CenterToRef(e,t,n.Zero())}static CenterToRef(e,t,r){return r.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}};Object.defineProperties(fe.prototype,{dimension:{value:[4]},rank:{value:1}});var M=class n{static get Use64Bits(){return te.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=n._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,r=!1,i=!0){this._isIdentity=e,this._isIdentity3x2=e||r,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:i}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,te.MatrixTrackPrecisionChange&&te.MatrixTrackedMatrices.push(this),this._m=new te.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;let e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;let e=this._m,t=e[0],r=e[1],i=e[2],s=e[3],a=e[4],o=e[5],h=e[6],l=e[7],u=e[8],c=e[9],f=e[10],_=e[11],d=e[12],m=e[13],T=e[14],R=e[15],g=f*R-T*_,F=c*R-m*_,E=c*T-m*f,x=u*R-d*_,y=u*T-f*d,B=u*m-d*c,w=+(o*g-h*F+l*E),j=-(a*g-h*x+l*y),X=+(a*F-o*x+l*B),J=-(a*E-o*y+h*B);return t*w+r*j+i*X+s*J}toString(){return`{${this.m[0]}, ${this.m[1]}, ${this.m[2]}, ${this.m[3]}
${this.m[4]}, ${this.m[5]}, ${this.m[6]}, ${this.m[7]}
${this.m[8]}, ${this.m[9]}, ${this.m[10]}, ${this.m[11]}
${this.m[12]}, ${this.m[13]}, ${this.m[14]}, ${this.m[15]}}`}toArray(e=null,t=0){if(!e)return this._m;let r=this._m;for(let i=0;i<16;i++)e[t+i]=r[i];return this}asArray(){return this._m}fromArray(e,t=0){return n.FromArrayToRef(e,t,this)}copyFromFloats(...e){return n.FromArrayToRef(e,0,this)}set(...e){let t=this._m;for(let r=0;r<16;r++)t[r]=e[r];return this.markAsUpdated(),this}setAll(e){let t=this._m;for(let r=0;r<16;r++)t[r]=e;return this.markAsUpdated(),this}invert(){return this.invertToRef(this),this}reset(){return n.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){let t=new n;return this.addToRef(e,t),t}addToRef(e,t){let r=this._m,i=t._m,s=e.m;for(let a=0;a<16;a++)i[a]=r[a]+s[a];return t.markAsUpdated(),t}addToSelf(e){let t=this._m,r=e.m;for(let i=0;i<16;i++)t[i]+=r[i];return this.markAsUpdated(),this}addInPlace(e){let t=this._m,r=e.m;for(let i=0;i<16;i++)t[i]+=r[i];return this.markAsUpdated(),this}addInPlaceFromFloats(...e){let t=this._m;for(let r=0;r<16;r++)t[r]+=e[r];return this.markAsUpdated(),this}subtract(e){let t=this._m,r=e.m;for(let i=0;i<16;i++)t[i]-=r[i];return this.markAsUpdated(),this}subtractToRef(e,t){let r=this._m,i=e.m,s=t._m;for(let a=0;a<16;a++)s[a]=r[a]-i[a];return t.markAsUpdated(),t}subtractInPlace(e){let t=this._m,r=e.m;for(let i=0;i<16;i++)t[i]-=r[i];return this.markAsUpdated(),this}subtractFromFloats(...e){return this.subtractFromFloatsToRef(...e,new n)}subtractFromFloatsToRef(...e){let t=e.pop(),r=this._m,i=t._m,s=e;for(let a=0;a<16;a++)i[a]=r[a]-s[a];return t.markAsUpdated(),t}invertToRef(e){if(this._isIdentity===!0)return n.IdentityToRef(e),e;let t=this._m,r=t[0],i=t[1],s=t[2],a=t[3],o=t[4],h=t[5],l=t[6],u=t[7],c=t[8],f=t[9],_=t[10],d=t[11],m=t[12],T=t[13],R=t[14],g=t[15],F=_*g-R*d,E=f*g-T*d,x=f*R-T*_,y=c*g-m*d,B=c*R-_*m,w=c*T-m*f,j=+(h*F-l*E+u*x),X=-(o*F-l*y+u*B),J=+(o*E-h*y+u*w),W=-(o*x-h*B+l*w),D=r*j+i*X+s*J+a*W;if(D===0)return e.copyFrom(this),e;let P=1/D,se=l*g-R*u,le=h*g-T*u,ge=h*R-T*l,ne=o*g-m*u,ae=o*R-m*l,ce=o*T-m*h,Te=l*d-_*u,Ce=h*d-f*u,Le=h*_-f*l,ir=o*d-c*u,sr=o*_-c*l,nr=o*f-c*h,Yr=-(i*F-s*E+a*x),Zr=+(r*F-s*y+a*B),Qr=-(r*E-i*y+a*w),$r=+(r*x-i*B+s*w),Jr=+(i*se-s*le+a*ge),ei=-(r*se-s*ne+a*ae),ti=+(r*le-i*ne+a*ce),ri=-(r*ge-i*ae+s*ce),ii=-(i*Te-s*Ce+a*Le),si=+(r*Te-s*ir+a*sr),ni=-(r*Ce-i*ir+a*nr),ai=+(r*Le-i*sr+s*nr);return n.FromValuesToRef(j*P,Yr*P,Jr*P,ii*P,X*P,Zr*P,ei*P,si*P,J*P,Qr*P,ti*P,ni*P,W*P,$r*P,ri*P,ai*P,e),e}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,r){return this._m[12]=e,this._m[13]=t,this._m[14]=r,this.markAsUpdated(),this}addTranslationFromFloats(e,t,r){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=r,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new b(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){let e=this.m;return n.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this}copyFrom(e){e.copyToArray(this._m);let t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){let r=this._m;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],this}multiply(e){let t=new n;return this.multiplyToRef(e,t),t}multiplyInPlace(e){let t=this._m,r=e.m;for(let i=0;i<16;i++)t[i]*=r[i];return this.markAsUpdated(),this}multiplyByFloats(...e){let t=this._m;for(let r=0;r<16;r++)t[r]*=e[r];return this.markAsUpdated(),this}multiplyByFloatsToRef(...e){let t=e.pop(),r=this._m,i=t._m,s=e;for(let a=0;a<16;a++)i[a]=r[a]*s[a];return t.markAsUpdated(),t}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,r){let i=this._m,s=e.m,a=i[0],o=i[1],h=i[2],l=i[3],u=i[4],c=i[5],f=i[6],_=i[7],d=i[8],m=i[9],T=i[10],R=i[11],g=i[12],F=i[13],E=i[14],x=i[15],y=s[0],B=s[1],w=s[2],j=s[3],X=s[4],J=s[5],W=s[6],D=s[7],P=s[8],se=s[9],le=s[10],ge=s[11],ne=s[12],ae=s[13],ce=s[14],Te=s[15];return t[r]=a*y+o*X+h*P+l*ne,t[r+1]=a*B+o*J+h*se+l*ae,t[r+2]=a*w+o*W+h*le+l*ce,t[r+3]=a*j+o*D+h*ge+l*Te,t[r+4]=u*y+c*X+f*P+_*ne,t[r+5]=u*B+c*J+f*se+_*ae,t[r+6]=u*w+c*W+f*le+_*ce,t[r+7]=u*j+c*D+f*ge+_*Te,t[r+8]=d*y+m*X+T*P+R*ne,t[r+9]=d*B+m*J+T*se+R*ae,t[r+10]=d*w+m*W+T*le+R*ce,t[r+11]=d*j+m*D+T*ge+R*Te,t[r+12]=g*y+F*X+E*P+x*ne,t[r+13]=g*B+F*J+E*se+x*ae,t[r+14]=g*w+F*W+E*le+x*ce,t[r+15]=g*j+F*D+E*ge+x*Te,this}divide(e){return this.divideToRef(e,new n)}divideToRef(e,t){let r=this._m,i=e.m,s=t._m;for(let a=0;a<16;a++)s[a]=r[a]/i[a];return t.markAsUpdated(),t}divideInPlace(e){let t=this._m,r=e.m;for(let i=0;i<16;i++)t[i]/=r[i];return this.markAsUpdated(),this}minimizeInPlace(e){let t=this._m,r=e.m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],r[i]);return this.markAsUpdated(),this}minimizeInPlaceFromFloats(...e){let t=this._m;for(let r=0;r<16;r++)t[r]=Math.min(t[r],e[r]);return this.markAsUpdated(),this}maximizeInPlace(e){let t=this._m,r=e.m;for(let i=0;i<16;i++)t[i]=Math.min(t[i],r[i]);return this.markAsUpdated(),this}maximizeInPlaceFromFloats(...e){let t=this._m;for(let r=0;r<16;r++)t[r]=Math.min(t[r],e[r]);return this.markAsUpdated(),this}negate(){return this.negateToRef(new n)}negateInPlace(){let e=this._m;for(let t=0;t<16;t++)e[t]=-e[t];return this.markAsUpdated(),this}negateToRef(e){let t=this._m,r=e._m;for(let i=0;i<16;i++)r[i]=-t[i];return e.markAsUpdated(),e}equals(e){let t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;let r=this.m,i=t.m;return r[0]===i[0]&&r[1]===i[1]&&r[2]===i[2]&&r[3]===i[3]&&r[4]===i[4]&&r[5]===i[5]&&r[6]===i[6]&&r[7]===i[7]&&r[8]===i[8]&&r[9]===i[9]&&r[10]===i[10]&&r[11]===i[11]&&r[12]===i[12]&&r[13]===i[13]&&r[14]===i[14]&&r[15]===i[15]}equalsWithEpsilon(e,t=0){let r=this._m,i=e.m;for(let s=0;s<16;s++)if(!q(r[s],i[s],t))return!1;return!0}equalsToFloats(...e){let t=this._m;for(let r=0;r<16;r++)if(t[r]!=e[r])return!1;return!0}floor(){return this.floorToRef(new n)}floorToRef(e){let t=this._m,r=e._m;for(let i=0;i<16;i++)r[i]=Math.floor(t[i]);return e.markAsUpdated(),e}fract(){return this.fractToRef(new n)}fractToRef(e){let t=this._m,r=e._m;for(let i=0;i<16;i++)r[i]=t[i]-Math.floor(t[i]);return e.markAsUpdated(),e}clone(){let e=new n;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=re(this._m[0]);for(let t=1;t<16;t++)e=e*397^re(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new fe,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,r,i,s=!0){if(this._isIdentity)return r&&r.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;let a=this._m;if(r&&r.copyFromFloats(a[12],a[13],a[14]),e=e||p.Vector3[0],e.x=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),e.y=Math.sqrt(a[4]*a[4]+a[5]*a[5]+a[6]*a[6]),e.z=Math.sqrt(a[8]*a[8]+a[9]*a[9]+a[10]*a[10]),i){let o=(s?i.absoluteScaling.x:i.scaling.x)<0?-1:1,h=(s?i.absoluteScaling.y:i.scaling.y)<0?-1:1,l=(s?i.absoluteScaling.z:i.scaling.z)<0?-1:1;e.x*=o,e.y*=h,e.z*=l}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){let o=1/e._x,h=1/e._y,l=1/e._z;n.FromValuesToRef(a[0]*o,a[1]*o,a[2]*o,0,a[4]*h,a[5]*h,a[6]*h,0,a[8]*l,a[9]*l,a[10]*l,0,0,0,0,1,p.Matrix[0]),fe.FromRotationMatrixToRef(p.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;let t=e*4;return new we(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<=3){let r=e*4;t.x=this._m[r+0],t.y=this._m[r+1],t.z=this._m[r+2],t.w=this._m[r+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){let e=new n;return n.TransposeToRef(this,e),e}transposeToRef(e){return n.TransposeToRef(this,e),e}setRowFromFloats(e,t,r,i,s){if(e<0||e>3)return this;let a=e*4;return this._m[a+0]=t,this._m[a+1]=r,this._m[a+2]=i,this._m[a+3]=s,this.markAsUpdated(),this}scale(e){let t=new n;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let r=0;r<16;r++)t._m[r]=this._m[r]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let r=0;r<16;r++)t._m[r]+=this._m[r]*e;return t.markAsUpdated(),t}scaleInPlace(e){let t=this._m;for(let r=0;r<16;r++)t[r]*=e;return this.markAsUpdated(),this}toNormalMatrix(e){let t=p.Matrix[0];this.invertToRef(t),t.transposeToRef(e);let r=e._m;return n.FromValuesToRef(r[0],r[1],r[2],0,r[4],r[5],r[6],0,r[8],r[9],r[10],0,0,0,0,1,e),e}getRotationMatrix(){let e=new n;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){let t=p.Vector3[0];if(!this.decompose(t))return n.IdentityToRef(e),e;let r=this._m,i=1/t._x,s=1/t._y,a=1/t._z;return n.FromValuesToRef(r[0]*i,r[1]*i,r[2]*i,0,r[4]*s,r[5]*s,r[6]*s,0,r[8]*a,r[9]*a,r[10]*a,0,0,0,0,1,e),e}toggleModelMatrixHandInPlace(){let e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){let e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(e,t=0){let r=new n;return n.FromArrayToRef(e,t,r),r}static FromArrayToRef(e,t,r){for(let i=0;i<16;i++)r._m[i]=e[i+t];return r.markAsUpdated(),r}static FromFloat32ArrayToRefScaled(e,t,r,i){for(let s=0;s<16;s++)i._m[s]=e[s+t]*r;return i.markAsUpdated(),i}static get IdentityReadOnly(){return n._IdentityReadOnly}static FromValuesToRef(e,t,r,i,s,a,o,h,l,u,c,f,_,d,m,T,R){let g=R._m;g[0]=e,g[1]=t,g[2]=r,g[3]=i,g[4]=s,g[5]=a,g[6]=o,g[7]=h,g[8]=l,g[9]=u,g[10]=c,g[11]=f,g[12]=_,g[13]=d,g[14]=m,g[15]=T,R.markAsUpdated()}static FromValues(e,t,r,i,s,a,o,h,l,u,c,f,_,d,m,T){let R=new n,g=R._m;return g[0]=e,g[1]=t,g[2]=r,g[3]=i,g[4]=s,g[5]=a,g[6]=o,g[7]=h,g[8]=l,g[9]=u,g[10]=c,g[11]=f,g[12]=_,g[13]=d,g[14]=m,g[15]=T,R.markAsUpdated(),R}static Compose(e,t,r){let i=new n;return n.ComposeToRef(e,t,r,i),i}static ComposeToRef(e,t,r,i){let s=i._m,a=t._x,o=t._y,h=t._z,l=t._w,u=a+a,c=o+o,f=h+h,_=a*u,d=a*c,m=a*f,T=o*c,R=o*f,g=h*f,F=l*u,E=l*c,x=l*f,y=e._x,B=e._y,w=e._z;return s[0]=(1-(T+g))*y,s[1]=(d+x)*y,s[2]=(m-E)*y,s[3]=0,s[4]=(d-x)*B,s[5]=(1-(_+g))*B,s[6]=(R+F)*B,s[7]=0,s[8]=(m+E)*w,s[9]=(R-F)*w,s[10]=(1-(_+T))*w,s[11]=0,s[12]=r._x,s[13]=r._y,s[14]=r._z,s[15]=1,i.markAsUpdated(),i}static Identity(){let e=n.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){return n.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0),e}static Zero(){let e=n.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){let t=new n;return n.RotationXToRef(e,t),t}static Invert(e){let t=new n;return e.invertToRef(t),t}static RotationXToRef(e,t){let r=Math.sin(e),i=Math.cos(e);return n.FromValuesToRef(1,0,0,0,0,i,r,0,0,-r,i,0,0,0,0,1,t),t._updateIdentityStatus(i===1&&r===0),t}static RotationY(e){let t=new n;return n.RotationYToRef(e,t),t}static RotationYToRef(e,t){let r=Math.sin(e),i=Math.cos(e);return n.FromValuesToRef(i,0,-r,0,0,1,0,0,r,0,i,0,0,0,0,1,t),t._updateIdentityStatus(i===1&&r===0),t}static RotationZ(e){let t=new n;return n.RotationZToRef(e,t),t}static RotationZToRef(e,t){let r=Math.sin(e),i=Math.cos(e);return n.FromValuesToRef(i,r,0,0,-r,i,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(i===1&&r===0),t}static RotationAxis(e,t){let r=new n;return n.RotationAxisToRef(e,t,r),r}static RotationAxisToRef(e,t,r){let i=Math.sin(-t),s=Math.cos(-t),a=1-s;e.normalize();let o=r._m;return o[0]=e._x*e._x*a+s,o[1]=e._x*e._y*a-e._z*i,o[2]=e._x*e._z*a+e._y*i,o[3]=0,o[4]=e._y*e._x*a+e._z*i,o[5]=e._y*e._y*a+s,o[6]=e._y*e._z*a-e._x*i,o[7]=0,o[8]=e._z*e._x*a-e._y*i,o[9]=e._z*e._y*a+e._x*i,o[10]=e._z*e._z*a+s,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,r.markAsUpdated(),r}static RotationAlignToRef(e,t,r,i=!1){let s=b.Dot(t,e),a=r._m;if(s<-1+ee)a[0]=-1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=i?1:-1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=i?-1:1,a[11]=0;else{let o=b.Cross(t,e),h=1/(1+s);a[0]=o._x*o._x*h+s,a[1]=o._y*o._x*h-o._z,a[2]=o._z*o._x*h+o._y,a[3]=0,a[4]=o._x*o._y*h+o._z,a[5]=o._y*o._y*h+s,a[6]=o._z*o._y*h-o._x,a[7]=0,a[8]=o._x*o._z*h-o._y,a[9]=o._y*o._z*h+o._x,a[10]=o._z*o._z*h+s,a[11]=0}return a[12]=0,a[13]=0,a[14]=0,a[15]=1,r.markAsUpdated(),r}static RotationYawPitchRoll(e,t,r){let i=new n;return n.RotationYawPitchRollToRef(e,t,r,i),i}static RotationYawPitchRollToRef(e,t,r,i){return fe.RotationYawPitchRollToRef(e,t,r,p.Quaternion[0]),p.Quaternion[0].toRotationMatrix(i),i}static Scaling(e,t,r){let i=new n;return n.ScalingToRef(e,t,r,i),i}static ScalingToRef(e,t,r,i){return n.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1,i),i._updateIdentityStatus(e===1&&t===1&&r===1),i}static Translation(e,t,r){let i=new n;return n.TranslationToRef(e,t,r,i),i}static TranslationToRef(e,t,r,i){return n.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,r,1,i),i._updateIdentityStatus(e===0&&t===0&&r===0),i}static Lerp(e,t,r){let i=new n;return n.LerpToRef(e,t,r,i),i}static LerpToRef(e,t,r,i){let s=i._m,a=e.m,o=t.m;for(let h=0;h<16;h++)s[h]=a[h]*(1-r)+o[h]*r;return i.markAsUpdated(),i}static DecomposeLerp(e,t,r){let i=new n;return n.DecomposeLerpToRef(e,t,r,i),i}static DecomposeLerpToRef(e,t,r,i){let s=p.Vector3[0],a=p.Quaternion[0],o=p.Vector3[1];e.decompose(s,a,o);let h=p.Vector3[2],l=p.Quaternion[1],u=p.Vector3[3];t.decompose(h,l,u);let c=p.Vector3[4];b.LerpToRef(s,h,r,c);let f=p.Quaternion[2];fe.SlerpToRef(a,l,r,f);let _=p.Vector3[5];return b.LerpToRef(o,u,r,_),n.ComposeToRef(c,f,_,i),i}static LookAtLH(e,t,r){let i=new n;return n.LookAtLHToRef(e,t,r,i),i}static LookAtLHToRef(e,t,r,i){let s=p.Vector3[0],a=p.Vector3[1],o=p.Vector3[2];t.subtractToRef(e,o),o.normalize(),b.CrossToRef(r,o,s);let h=s.lengthSquared();h===0?s.x=1:s.normalizeFromLength(Math.sqrt(h)),b.CrossToRef(o,s,a),a.normalize();let l=-b.Dot(s,e),u=-b.Dot(a,e),c=-b.Dot(o,e);return n.FromValuesToRef(s._x,a._x,o._x,0,s._y,a._y,o._y,0,s._z,a._z,o._z,0,l,u,c,1,i),i}static LookAtRH(e,t,r){let i=new n;return n.LookAtRHToRef(e,t,r,i),i}static LookAtRHToRef(e,t,r,i){let s=p.Vector3[0],a=p.Vector3[1],o=p.Vector3[2];e.subtractToRef(t,o),o.normalize(),b.CrossToRef(r,o,s);let h=s.lengthSquared();h===0?s.x=1:s.normalizeFromLength(Math.sqrt(h)),b.CrossToRef(o,s,a),a.normalize();let l=-b.Dot(s,e),u=-b.Dot(a,e),c=-b.Dot(o,e);return n.FromValuesToRef(s._x,a._x,o._x,0,s._y,a._y,o._y,0,s._z,a._z,o._z,0,l,u,c,1,i),i}static LookDirectionLH(e,t){let r=new n;return n.LookDirectionLHToRef(e,t,r),r}static LookDirectionLHToRef(e,t,r){let i=p.Vector3[0];i.copyFrom(e),i.scaleInPlace(-1);let s=p.Vector3[1];return b.CrossToRef(t,i,s),n.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,r),r}static LookDirectionRH(e,t){let r=new n;return n.LookDirectionRHToRef(e,t,r),r}static LookDirectionRHToRef(e,t,r){let i=p.Vector3[2];return b.CrossToRef(t,e,i),n.FromValuesToRef(i._x,i._y,i._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,r),r}static OrthoLH(e,t,r,i,s){let a=new n;return n.OrthoLHToRef(e,t,r,i,a,s),a}static OrthoLHToRef(e,t,r,i,s,a){let o=r,h=i,l=2/e,u=2/t,c=2/(h-o),f=-(h+o)/(h-o);return n.FromValuesToRef(l,0,0,0,0,u,0,0,0,0,c,0,0,0,f,1,s),a&&s.multiplyToRef(Me,s),s._updateIdentityStatus(l===1&&u===1&&c===1&&f===0),s}static OrthoOffCenterLH(e,t,r,i,s,a,o){let h=new n;return n.OrthoOffCenterLHToRef(e,t,r,i,s,a,h,o),h}static OrthoOffCenterLHToRef(e,t,r,i,s,a,o,h){let l=s,u=a,c=2/(t-e),f=2/(i-r),_=2/(u-l),d=-(u+l)/(u-l),m=(e+t)/(e-t),T=(i+r)/(r-i);return n.FromValuesToRef(c,0,0,0,0,f,0,0,0,0,_,0,m,T,d,1,o),h&&o.multiplyToRef(Me,o),o.markAsUpdated(),o}static ObliqueOffCenterLHToRef(e,t,r,i,s,a,o,h,l,u,c){let f=-o*Math.cos(h),_=-o*Math.sin(h);return n.TranslationToRef(0,0,-l,p.Matrix[1]),n.FromValuesToRef(1,0,0,0,0,1,0,0,f,_,1,0,0,0,0,1,p.Matrix[0]),p.Matrix[1].multiplyToRef(p.Matrix[0],p.Matrix[0]),n.TranslationToRef(0,0,l,p.Matrix[1]),p.Matrix[0].multiplyToRef(p.Matrix[1],p.Matrix[0]),n.OrthoOffCenterLHToRef(e,t,r,i,s,a,u,c),p.Matrix[0].multiplyToRef(u,u),u}static OrthoOffCenterRH(e,t,r,i,s,a,o){let h=new n;return n.OrthoOffCenterRHToRef(e,t,r,i,s,a,h,o),h}static OrthoOffCenterRHToRef(e,t,r,i,s,a,o,h){return n.OrthoOffCenterLHToRef(e,t,r,i,s,a,o,h),o._m[10]*=-1,o}static ObliqueOffCenterRHToRef(e,t,r,i,s,a,o,h,l,u,c){let f=o*Math.cos(h),_=o*Math.sin(h);return n.TranslationToRef(0,0,l,p.Matrix[1]),n.FromValuesToRef(1,0,0,0,0,1,0,0,f,_,1,0,0,0,0,1,p.Matrix[0]),p.Matrix[1].multiplyToRef(p.Matrix[0],p.Matrix[0]),n.TranslationToRef(0,0,-l,p.Matrix[1]),p.Matrix[0].multiplyToRef(p.Matrix[1],p.Matrix[0]),n.OrthoOffCenterRHToRef(e,t,r,i,s,a,u,c),p.Matrix[0].multiplyToRef(u,u),u}static PerspectiveLH(e,t,r,i,s,a=0){let o=new n,h=r,l=i,u=2*h/e,c=2*h/t,f=(l+h)/(l-h),_=-2*l*h/(l-h),d=Math.tan(a);return n.FromValuesToRef(u,0,0,0,0,c,0,d,0,0,f,1,0,0,_,0,o),s&&o.multiplyToRef(Me,o),o._updateIdentityStatus(!1),o}static PerspectiveFovLH(e,t,r,i,s,a=0,o=!1){let h=new n;return n.PerspectiveFovLHToRef(e,t,r,i,h,!0,s,a,o),h}static PerspectiveFovLHToRef(e,t,r,i,s,a=!0,o,h=0,l=!1){let u=r,c=i,f=1/Math.tan(e*.5),_=a?f/t:f,d=a?f:f*t,m=l&&u===0?-1:c!==0?(c+u)/(c-u):1,T=l&&u===0?2*c:c!==0?-2*c*u/(c-u):-2*u,R=Math.tan(h);return n.FromValuesToRef(_,0,0,0,0,d,0,R,0,0,m,1,0,0,T,0,s),o&&s.multiplyToRef(Me,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseLHToRef(e,t,r,i,s,a=!0,o,h=0){let l=1/Math.tan(e*.5),u=a?l/t:l,c=a?l:l*t,f=Math.tan(h);return n.FromValuesToRef(u,0,0,0,0,c,0,f,0,0,-r,1,0,0,1,0,s),o&&s.multiplyToRef(Me,s),s._updateIdentityStatus(!1),s}static PerspectiveFovRH(e,t,r,i,s,a=0,o=!1){let h=new n;return n.PerspectiveFovRHToRef(e,t,r,i,h,!0,s,a,o),h}static PerspectiveFovRHToRef(e,t,r,i,s,a=!0,o,h=0,l=!1){let u=r,c=i,f=1/Math.tan(e*.5),_=a?f/t:f,d=a?f:f*t,m=l&&u===0?1:c!==0?-(c+u)/(c-u):-1,T=l&&u===0?2*c:c!==0?-2*c*u/(c-u):-2*u,R=Math.tan(h);return n.FromValuesToRef(_,0,0,0,0,d,0,R,0,0,m,-1,0,0,T,0,s),o&&s.multiplyToRef(Me,s),s._updateIdentityStatus(!1),s}static PerspectiveFovReverseRHToRef(e,t,r,i,s,a=!0,o,h=0){let l=1/Math.tan(e*.5),u=a?l/t:l,c=a?l:l*t,f=Math.tan(h);return n.FromValuesToRef(u,0,0,0,0,c,0,f,0,0,-r,-1,0,0,-1,0,s),o&&s.multiplyToRef(Me,s),s._updateIdentityStatus(!1),s}static GetFinalMatrix(e,t,r,i,s,a){let o=e.width,h=e.height,l=e.x,u=e.y,c=n.FromValues(o/2,0,0,0,0,-h/2,0,0,0,0,a-s,0,l+o/2,h/2+u,s,1),f=new n;return t.multiplyToRef(r,f),f.multiplyToRef(i,f),f.multiplyToRef(c,f)}static GetAsMatrix2x2(e){let t=e.m,r=[t[0],t[1],t[4],t[5]];return te.MatrixUse64Bits?r:new Float32Array(r)}static GetAsMatrix3x3(e){let t=e.m,r=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return te.MatrixUse64Bits?r:new Float32Array(r)}static Transpose(e){let t=new n;return n.TransposeToRef(e,t),t}static TransposeToRef(e,t){let r=e.m,i=r[0],s=r[4],a=r[8],o=r[12],h=r[1],l=r[5],u=r[9],c=r[13],f=r[2],_=r[6],d=r[10],m=r[14],T=r[3],R=r[7],g=r[11],F=r[15],E=t._m;return E[0]=i,E[1]=s,E[2]=a,E[3]=o,E[4]=h,E[5]=l,E[6]=u,E[7]=c,E[8]=f,E[9]=_,E[10]=d,E[11]=m,E[12]=T,E[13]=R,E[14]=g,E[15]=F,t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(e){let t=new n;return n.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();let r=e.normal.x,i=e.normal.y,s=e.normal.z,a=-2*r,o=-2*i,h=-2*s;return n.FromValuesToRef(a*r+1,o*r,h*r,0,a*i,o*i+1,h*i,0,a*s,o*s,h*s+1,0,a*e.d,o*e.d,h*e.d,1,t),t}static FromXYZAxesToRef(e,t,r,i){return n.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,r._x,r._y,r._z,0,0,0,0,1,i),i}static FromQuaternionToRef(e,t){let r=e._x*e._x,i=e._y*e._y,s=e._z*e._z,a=e._x*e._y,o=e._z*e._w,h=e._z*e._x,l=e._y*e._w,u=e._y*e._z,c=e._x*e._w;return t._m[0]=1-2*(i+s),t._m[1]=2*(a+o),t._m[2]=2*(h-l),t._m[3]=0,t._m[4]=2*(a-o),t._m[5]=1-2*(s+r),t._m[6]=2*(u+c),t._m[7]=0,t._m[8]=2*(h+l),t._m[9]=2*(u-c),t._m[10]=1-2*(i+r),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}};M._UpdateFlagSeed=0;M._IdentityReadOnly=M.Identity();Object.defineProperties(M.prototype,{dimension:{value:[4,4]},rank:{value:2}});var p=class{};p.Vector3=be.BuildTuple(11,b.Zero);p.Matrix=be.BuildTuple(2,M.Identity);p.Quaternion=be.BuildTuple(3,fe.Zero);var H=class{};H.Vector2=be.BuildTuple(3,Ee.Zero);H.Vector3=be.BuildTuple(13,b.Zero);H.Vector4=be.BuildTuple(3,we.Zero);H.Quaternion=be.BuildTuple(2,fe.Zero);H.Matrix=be.BuildTuple(8,M.Identity);Re("BABYLON.Vector2",Ee);Re("BABYLON.Vector3",b);Re("BABYLON.Vector4",we);Re("BABYLON.Matrix",M);var Me=M.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);var mr=function(n,e,t,r={}){let i=n();me&&me.HasTags(e)&&me.AddTagsTo(i,me.GetTags(e,!0));let s=et(i),a={};for(let o in s){let h=s[o],l=e[o],u=h.type;if(l!=null&&(o!=="uniqueId"||pe.AllowLoadingUniqueId))switch(u){case 0:case 6:case 11:i[o]=l;break;case 1:r.cloneTexturesOnlyOnce&&a[l.uniqueId]?i[o]=a[l.uniqueId]:(i[o]=t||l.isRenderTarget?l:l.clone(),a[l.uniqueId]=i[o]);break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:i[o]=t?l:l.clone();break}}return i},pe=(()=>{class n{static AppendSerializedAnimations(t,r){if(t.animations){r.animations=[];for(let i=0;i<t.animations.length;i++){let s=t.animations[i];r.animations.push(s.serialize())}}}static Serialize(t,r){r||(r={}),me&&(r.tags=me.GetTags(t));let i=et(t);for(let s in i){let a=i[s],o=a.sourceName||s,h=a.type,l=t[s];if(l!=null&&(s!=="uniqueId"||n.AllowLoadingUniqueId))switch(h){case 0:r[o]=l;break;case 1:r[o]=l.serialize();break;case 2:r[o]=l.asArray();break;case 3:r[o]=l.serialize();break;case 4:r[o]=l.asArray();break;case 5:r[o]=l.asArray();break;case 6:r[o]=l.id;break;case 7:r[o]=l.serialize();break;case 8:r[o]=l.asArray();break;case 9:r[o]=l.serialize();break;case 10:r[o]=l.asArray();break;case 11:r[o]=l.id;break;case 12:r[o]=l.asArray();break}}return r}static ParseProperties(t,r,i,s){s||(s="");let a=et(r);for(let o in a){let h=a[o],l=t[h.sourceName||o],u=h.type;if(l!=null&&(o!=="uniqueId"||n.AllowLoadingUniqueId)){let c=r;switch(u){case 0:c[o]=l;break;case 1:i&&(c[o]=n._TextureParser(l,i,s));break;case 2:c[o]=hr.FromArray(l);break;case 3:c[o]=n._FresnelParametersParser(l);break;case 4:c[o]=Ee.FromArray(l);break;case 5:c[o]=b.FromArray(l);break;case 6:i&&(c[o]=i.getLastMeshById(l));break;case 7:c[o]=n._ColorCurvesParser(l);break;case 8:c[o]=lr.FromArray(l);break;case 9:c[o]=n._ImageProcessingConfigurationParser(l);break;case 10:c[o]=fe.FromArray(l);break;case 11:i&&(c[o]=i.getCameraById(l));break;case 12:c[o]=M.FromArray(l);break}}}}static Parse(t,r,i,s=null){let a=t();return me&&me.AddTagsTo(a,r.tags),n.ParseProperties(r,a,i,s),a}static Clone(t,r,i={}){return mr(t,r,!1,i)}static Instanciate(t,r){return mr(t,r,!0)}}return n.AllowLoadingUniqueId=!1,n._ImageProcessingConfigurationParser=e=>{throw v("ImageProcessingConfiguration")},n._FresnelParametersParser=e=>{throw v("FresnelParameters")},n._ColorCurvesParser=e=>{throw v("ColorCurves")},n._TextureParser=(e,t,r)=>{throw v("Texture")},n})();var rt=class{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null,this._isDisposed=!1}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}setEngine(e){this.engine=e}_fillEffectInformation(e,t,r,i,s,a,o,h){let l=this.engine;if(l.supportsUniformBuffers)for(let f in t)e.bindUniformBlock(f,t[f]);this.engine.getUniforms(this,r).forEach((f,_)=>{i[r[_]]=f}),this._uniforms=i;let c;for(c=0;c<s.length;c++)e.getUniform(s[c])==null&&(s.splice(c,1),c--);s.forEach((f,_)=>{a[f]=_});for(let f of l.getAttributes(this,o))h.push(f)}dispose(){this._uniforms={},this._isDisposed=!0}_cacheMatrix(e,t){let r=this._valueCache[e],i=t.updateFlag;return r!==void 0&&r===i?!1:(this._valueCache[e]=i,!0)}_cacheFloat2(e,t,r){let i=this._valueCache[e];if(!i||i.length!==2)return i=[t,r],this._valueCache[e]=i,!0;let s=!1;return i[0]!==t&&(i[0]=t,s=!0),i[1]!==r&&(i[1]=r,s=!0),s}_cacheFloat3(e,t,r,i){let s=this._valueCache[e];if(!s||s.length!==3)return s=[t,r,i],this._valueCache[e]=s,!0;let a=!1;return s[0]!==t&&(s[0]=t,a=!0),s[1]!==r&&(s[1]=r,a=!0),s[2]!==i&&(s[2]=i,a=!0),a}_cacheFloat4(e,t,r,i,s){let a=this._valueCache[e];if(!a||a.length!==4)return a=[t,r,i,s],this._valueCache[e]=a,!0;let o=!1;return a[0]!==t&&(a[0]=t,o=!0),a[1]!==r&&(a[1]=r,o=!0),a[2]!==i&&(a[2]=i,o=!0),a[3]!==s&&(a[3]=s,o=!0),o}setInt(e,t){let r=this._valueCache[e];r!==void 0&&r===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,r){this._cacheFloat2(e,t,r)&&(this.engine.setInt2(this._uniforms[e],t,r)||(this._valueCache[e]=null))}setInt3(e,t,r,i){this._cacheFloat3(e,t,r,i)&&(this.engine.setInt3(this._uniforms[e],t,r,i)||(this._valueCache[e]=null))}setInt4(e,t,r,i,s){this._cacheFloat4(e,t,r,i,s)&&(this.engine.setInt4(this._uniforms[e],t,r,i,s)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){let r=this._valueCache[e];r!==void 0&&r===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,r){this._cacheFloat2(e,t,r)&&(this.engine.setUInt2(this._uniforms[e],t,r)||(this._valueCache[e]=null))}setUInt3(e,t,r,i){this._cacheFloat3(e,t,r,i)&&(this.engine.setUInt3(this._uniforms[e],t,r,i)||(this._valueCache[e]=null))}setUInt4(e,t,r,i,s){this._cacheFloat4(e,t,r,i,s)&&(this.engine.setUInt4(this._uniforms[e],t,r,i,s)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){let r=this._valueCache[e];r!==void 0&&r===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,r){this._cacheFloat2(e,t,r)&&(this.engine.setFloat2(this._uniforms[e],t,r)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,r,i){this._cacheFloat3(e,t,r,i)&&(this.engine.setFloat3(this._uniforms[e],t,r,i)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,r,i,s){this._cacheFloat4(e,t,r,i,s)&&(this.engine.setFloat4(this._uniforms[e],t,r,i,s)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,r){this._cacheFloat4(e,t.r,t.g,t.b,r)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,r)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}};function k(){return typeof window<"u"}function it(){return typeof navigator<"u"}function He(){return typeof document<"u"}function st(n){let e="",t=n.firstChild;for(;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}var ze={};function nt(n,e,t=""){return t+(e?e+`
`:"")+n}function at(n,e,t,r,i,s,a){let o=a||ze.loadFile;if(o)return o(n,e,t,r,i,s);throw v("FileTools")}function ot(n,e,t,r){if(n){e?n.IS_NDC_HALF_ZRANGE="":delete n.IS_NDC_HALF_ZRANGE,t?n.USE_REVERSE_DEPTHBUFFER="":delete n.USE_REVERSE_DEPTHBUFFER,r?n.USE_EXACT_SRGB_CONVERSIONS="":delete n.USE_EXACT_SRGB_CONVERSIONS;return}else{let i="";return e&&(i+="#define IS_NDC_HALF_ZRANGE"),t&&(i&&(i+=`
`),i+="#define USE_REVERSE_DEPTHBUFFER"),r&&(i&&(i+=`
`),i+="#define USE_EXACT_SRGB_CONVERSIONS"),i}}var Nt=new WeakMap,hi={_webGLVersion:2,cachedPipelines:{}};function ie(n){let e=Nt.get(n);if(!e){if(!n)return hi;e={_webGLVersion:n.TEXTURE_BINDING_3D?2:1,_context:n,cachedPipelines:{}},Nt.set(n,e)}return e}function gr(n){Nt.delete(n)}function kt(n,e,t,r,i,s){let a=ie(r);s||(s=a._createShaderProgramInjection??ht);let o=Gt(e,"vertex",r,a._contextWasLost),h=Gt(t,"fragment",r,a._contextWasLost);return s(n,o,h,r,i,a.validateShaderPrograms)}function Vt(n,e,t,r,i,s=null,a){let o=ie(i);a||(a=o._createShaderProgramInjection??ht);let h=o._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",l=pr(e,"vertex",r,h,i,o._contextWasLost),u=pr(t,"fragment",r,h,i,o._contextWasLost);return a(n,l,u,i,s,o.validateShaderPrograms)}function xr(n,e){let t=new rt,r=ie(n);return r.parallelShaderCompile&&(t.isParallelCompiled=!0),t.context=r._context,t}function ht(n,e,t,r,i=null,s){let a=r.createProgram();if(n.program=a,!a)throw new Error("Unable to create program");return r.attachShader(a,e),r.attachShader(a,t),r.linkProgram(a),n.context=r,n.vertexShader=e,n.fragmentShader=t,n.isParallelCompiled||Kt(n,r,s),a}function Kt(n,e,t){let r=n.context,i=n.vertexShader,s=n.fragmentShader,a=n.program;if(!r.getProgramParameter(a,r.LINK_STATUS)){if(!e.getShaderParameter(i,e.COMPILE_STATUS)){let l=e.getShaderInfoLog(i);if(l)throw n.vertexCompilationError=l,new Error("VERTEX SHADER "+l)}if(!e.getShaderParameter(s,e.COMPILE_STATUS)){let l=e.getShaderInfoLog(s);if(l)throw n.fragmentCompilationError=l,new Error("FRAGMENT SHADER "+l)}let h=r.getProgramInfoLog(a);if(h)throw n.programLinkError=h,new Error(h)}if(t&&(r.validateProgram(a),!r.getProgramParameter(a,r.VALIDATE_STATUS))){let l=r.getProgramInfoLog(a);if(l)throw n.programValidationError=l,new Error(l)}r.deleteShader(i),r.deleteShader(s),n.vertexShader=void 0,n.fragmentShader=void 0,n.onCompiled&&(n.onCompiled(),n.onCompiled=void 0)}function yr(n,e,t,r,i,s,a,o,h,l="",u,c){let f=ie(n.context);u||(u=f.createRawShaderProgramInjection??kt),c||(c=f.createShaderProgramInjection??Vt);let _=n;r?_.program=u(_,e,t,_.context,h):_.program=c(_,e,t,o,_.context,h),_.program.__SPECTOR_rebuildProgram=a}function pr(n,e,t,r,i,s){return Gt(nt(n,t,r),e,i,s)}function Gt(n,e,t,r){let i=t.createShader(e==="vertex"?t.VERTEX_SHADER:t.FRAGMENT_SHADER);if(!i){let s=t.NO_ERROR,a=t.NO_ERROR;for(;(a=t.getError())!==t.NO_ERROR;)s=a;throw new Error(`Something went wrong while creating a gl ${e} shader object. gl error=${s}, gl isContextLost=${t.isContextLost()}, _contextWasLost=${r}`)}return t.shaderSource(i,n),t.compileShader(i),i}function Tr(n,e){e.useProgram(n)}function Rr(n,e){let t=n;if(!t.isParallelCompiled){e(n);return}let r=t.onCompiled;t.onCompiled=()=>{r?.(),e(n)}}function br(n){return n.getPipelineContext===void 0}var lt=class{constructor(){this.shaderLanguage=$.GLSL}postProcessor(e,t,r,i,s){if(s.drawBuffersExtensionDisabled){let a=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(a,"")}return e}};var li=/(flat\s)?\s*varying\s*.*/,ct=class{constructor(){this.shaderLanguage=$.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingCheck(e,t){return li.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,r){let i=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,s=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(s,""),e=e.replace(/texture2D\s*\(/g,"texture("),r){let a=e.search(/layout *\(location *= *0\) *out/g)!==-1;e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(i||a?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(")}else if(t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}};var Se=class extends cr{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}};function Er(n){let e=1;do e*=2;while(e<n);return e===n}function Ar(n,e,t){return n*(1-t)+e*t}function Ht(n){let e=ut(n),t=ft(n);return e-n>n-t?t:e}function ut(n){return n--,n|=n>>1,n|=n>>2,n|=n>>4,n|=n>>8,n|=n>>16,n++,n}function ft(n){return n=n|n>>1,n=n|n>>2,n=n|n>>4,n=n|n>>8,n=n|n>>16,n-(n>>1)}function _t(n,e,t=2){let r;switch(t){case 1:r=ft(n);break;case 2:r=Ht(n);break;case 3:default:r=ut(n);break}return Math.min(r,e)}var ci="attribute",ui="varying",xe=class{constructor(){this.children=[]}isValid(e){return!0}process(e,t){let r="";if(this.line){let i=this.line,s=t.processor;if(s){s.lineProcessor&&(i=s.lineProcessor(i,t.isFragment,t.processingContext));let a=t.processor?.attributeKeywordName??ci,o=t.isFragment&&t.processor?.varyingFragmentKeywordName?t.processor?.varyingFragmentKeywordName:!t.isFragment&&t.processor?.varyingVertexKeywordName?t.processor?.varyingVertexKeywordName:ui;!t.isFragment&&s.attributeProcessor&&this.line.startsWith(a)?i=s.attributeProcessor(this.line,e,t.processingContext):s.varyingProcessor&&(s.varyingCheck?.(this.line,t.isFragment)||!s.varyingCheck&&this.line.startsWith(o))?i=s.varyingProcessor(this.line,t.isFragment,e,t.processingContext):s.uniformProcessor&&s.uniformRegexp&&s.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(i=s.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):s.uniformBufferProcessor&&s.uniformBufferRegexp&&s.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(i=s.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):s.textureProcessor&&s.textureRegexp&&s.textureRegexp.test(this.line)?i=s.textureProcessor(this.line,t.isFragment,e,t.processingContext):(s.uniformProcessor||s.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?s.uniformProcessor&&(i=s.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):s.uniformBufferProcessor&&(i=s.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,s.endOfUniformBufferProcessor&&(i=s.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}r+=i+`
`}return this.children.forEach(i=>{r+=i.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),r}};var dt=class{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(let t of e){if(!t||t==="\r")continue;if(t[0]==="#"){this._lines.push(t);continue}let r=t.trim();if(!r)continue;if(r.startsWith("//")){this._lines.push(t);continue}let i=r.indexOf(";");if(i===-1)this._lines.push(r);else if(i===r.length-1)r.length>1&&this._lines.push(r);else{let s=t.split(";");for(let a=0;a<s.length;a++){let o=s[a];o&&(o=o.trim(),o&&this._lines.push(o+(a!==s.length-1?";":"")))}}}}};var Ne=class extends xe{process(e,t){for(let r=0;r<this.children.length;r++){let i=this.children[r];if(i.isValid(e))return i.process(e,t)}return""}};var mt=class extends xe{isValid(e){return this.testExpression.isTrue(e)}};var Q=class n{isTrue(e){return!0}static postfixToInfix(e){let t=[];for(let r of e)if(n._OperatorPriority[r]===void 0)t.push(r);else{let i=t[t.length-1],s=t[t.length-2];t.length-=2,t.push(`(${s}${r}${i})`)}return t[t.length-1]}static infixToPostfix(e){let t=n._InfixToPostfixCache.get(e);if(t)return t.accessTime=Date.now(),t.result;if(!e.includes("&&")&&!e.includes("||")&&!e.includes(")")&&!e.includes("("))return[e];let r=[],i=-1,s=()=>{u=u.trim(),u!==""&&(r.push(u),u="")},a=c=>{i<n._Stack.length-1&&(n._Stack[++i]=c)},o=()=>n._Stack[i],h=()=>i===-1?"!!INVALID EXPRESSION!!":n._Stack[i--],l=0,u="";for(;l<e.length;){let c=e.charAt(l),f=l<e.length-1?e.substr(l,2):"";if(c==="(")u="",a(c);else if(c===")"){for(s();i!==-1&&o()!=="(";)r.push(h());h()}else if(n._OperatorPriority[f]>1){for(s();i!==-1&&n._OperatorPriority[o()]>=n._OperatorPriority[f];)r.push(h());a(f),l++}else u+=c;l++}for(s();i!==-1;)o()==="("?h():r.push(h());return n._InfixToPostfixCache.size>=n.InfixToPostfixCacheLimitSize&&n.ClearCache(),n._InfixToPostfixCache.set(e,{result:r,accessTime:Date.now()}),r}static ClearCache(){let e=Array.from(n._InfixToPostfixCache.entries()).sort((t,r)=>t[1].accessTime-r[1].accessTime);for(let t=0;t<n.InfixToPostfixCacheCleanupSize;t++)n._InfixToPostfixCache.delete(e[t][0])}};Q.InfixToPostfixCacheLimitSize=5e4;Q.InfixToPostfixCacheCleanupSize=25e3;Q._InfixToPostfixCache=new Map;Q._OperatorPriority={")":0,"(":1,"||":2,"&&":3};Q._Stack=["","","","","","","","","","","","","","","","","","","",""];var Ue=class extends Q{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}};var pt=class extends Q{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}};var gt=class extends Q{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}};var xt=class extends Q{constructor(e,t,r){super(),this.define=e,this.operand=t,this.testValue=r}isTrue(e){let t=e[this.define];t===void 0&&(t=this.define);let r=!1,i=parseInt(t),s=parseInt(this.testValue);switch(this.operand){case">":r=i>s;break;case"<":r=i<s;break;case"<=":r=i<=s;break;case">=":r=i>=s;break;case"==":r=i===s;break;case"!=":r=i!==s;break}return r}};var fi=/defined\s*?\((.+?)\)/g,Wt=/defined\s*?\[(.+?)\]/g,_i=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,di=/__decl__/,Fr=/light\{X\}.(\w*)/g,Cr=/\{X\}/g,yt=[],mi=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/;function wr(n){n.processor&&n.processor.initializeShaders&&n.processor.initializeShaders(n.processingContext)}function Yt(n,e,t,r){e.processor?.preProcessShaderCode&&(n=e.processor.preProcessShaderCode(n,e.isFragment)),Rt(n,e,i=>{e.processCodeAfterIncludes&&(i=e.processCodeAfterIncludes(e.isFragment?"fragment":"vertex",i,e.defines));let s=xi(i,e,r);t(s,i)})}function Js(n,e,t,r){e.processor?.preProcessShaderCode&&(n=e.processor.preProcessShaderCode(n,e.isFragment)),Rt(n,e,i=>{e.processCodeAfterIncludes&&(i=e.processCodeAfterIncludes(e.isFragment?"fragment":"vertex",i,e.defines));let s=yi(i,e,r);t(s,i)})}function Sr(n,e,t){return!t.processor||!t.processor.finalizeShaders?{vertexCode:n,fragmentCode:e}:t.processor.finalizeShaders(n,e,t.processingContext)}function pi(n,e){if(e.processor?.noPrecision)return n;let t=e.shouldUseHighPrecisionShader;return n.indexOf("precision highp float")===-1?t?n=`precision highp float;
`+n:n=`precision mediump float;
`+n:t||(n=n.replace("precision highp float","precision mediump float")),n}function jt(n){let t=/defined\((.+)\)/.exec(n);if(t&&t.length)return new Ue(t[1].trim(),n[0]==="!");let r=["==","!=",">=","<=","<",">"],i="",s=0;for(i of r)if(s=n.indexOf(i),s>-1)break;if(s===-1)return new Ue(n);let a=n.substring(0,s).trim(),o=n.substring(s+i.length).trim();return new xt(a,i,o)}function gi(n){n=n.replace(fi,"defined[$1]");let e=Q.infixToPostfix(n),t=[];for(let i of e)if(i!=="||"&&i!=="&&")t.push(i);else if(t.length>=2){let s=t[t.length-1],a=t[t.length-2];t.length-=2;let o=i=="&&"?new gt:new pt;typeof s=="string"&&(s=s.replace(Wt,"defined($1)")),typeof a=="string"&&(a=a.replace(Wt,"defined($1)")),o.leftOperand=typeof a=="string"?jt(a):a,o.rightOperand=typeof s=="string"?jt(s):s,t.push(o)}let r=t[t.length-1];return typeof r=="string"&&(r=r.replace(Wt,"defined($1)")),typeof r=="string"?jt(r):r}function Tt(n,e){let t=new mt,r=n.substring(0,e),i=n.substring(e);return i=i.substring(0,(i.indexOf("//")+1||i.length+1)-1).trim(),r==="#ifdef"?t.testExpression=new Ue(i):r==="#ifndef"?t.testExpression=new Ue(i,!0):t.testExpression=gi(i),t}function Xt(n,e,t){let r=n.currentLine;for(;qt(n,t);){r=n.currentLine;let i=r.substring(0,5).toLowerCase();if(i==="#else"){let s=new xe;e.children.push(s),qt(n,s);return}else if(i==="#elif"){let s=Tt(r,5);e.children.push(s),t=s}}}function qt(n,e){for(;n.canRead;){n.lineIndex++;let t=n.currentLine;if(t.indexOf("#")>=0){let i=mi.exec(t);if(i&&i.length){switch(i[0]){case"#ifdef":{let a=new Ne;e.children.push(a);let o=Tt(t,6);a.children.push(o),Xt(n,a,o);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{let a=new Ne;e.children.push(a);let o=Tt(t,7);a.children.push(o),Xt(n,a,o);break}case"#if":{let a=new Ne,o=Tt(t,3);e.children.push(a),a.children.push(o),Xt(n,a,o);break}}continue}}let r=new xe;if(r.line=t,e.children.push(r),t[0]==="#"&&t[1]==="d"){let i=t.replace(";","").split(" ");r.additionalDefineKey=i[1],i.length===3&&(r.additionalDefineValue=i[2])}}return!1}function Ir(n,e,t){let r=new xe,i=new dt;return i.lineIndex=-1,i.lines=n.split(`
`),qt(i,r),r.process(e,t)}function Br(n,e){let t=n.defines,r={};for(let i of t){let a=i.replace("#define","").replace(";","").trim().split(" ");r[a[0]]=a.length>1?a[1]:""}return n.processor?.shaderLanguage===$.GLSL&&(r.GL_ES="true"),r.__VERSION__=n.version,r[n.platformName]="true",ot(r,e?.isNDCHalfZRange,e?.useReverseDepthBuffer,e?.useExactSrgbConversions),r}function xi(n,e,t){let r=pi(n,e);if(!e.processor||e.processor.shaderLanguage===$.GLSL&&r.indexOf("#version 3")!==-1&&(r=r.replace("#version 300 es",""),!e.processor.parseGLES3))return r;let i=e.defines,s=Br(e,t);return e.processor.preProcessor&&(r=e.processor.preProcessor(r,i,s,e.isFragment,e.processingContext)),r=Ir(r,s,e),e.processor.postProcessor&&(r=e.processor.postProcessor(r,i,e.isFragment,e.processingContext,t?{drawBuffersExtensionDisabled:!t.getCaps().drawBuffersExtension}:{})),t?._features.needShaderCodeInlining&&(r=t.inlineShaderCode(r)),r}function yi(n,e,t){let r=n,i=e.defines,s=Br(e,t);return e.processor?.preProcessor&&(r=e.processor.preProcessor(r,i,s,e.isFragment,e.processingContext)),r=Ir(r,s,e),e.processor?.postProcessor&&(r=e.processor.postProcessor(r,i,e.isFragment,e.processingContext,t?{drawBuffersExtensionDisabled:!t.getCaps().drawBuffersExtension}:{})),t._features.needShaderCodeInlining&&(r=t.inlineShaderCode(r)),r}function Rt(n,e,t){yt.length=0;let r;for(;(r=_i.exec(n))!==null;)yt.push(r);let i=String(n),s=[n],a=!1;for(let o of yt){let h=o[1];if(h.indexOf("__decl__")!==-1&&(h=h.replace(di,""),e.supportsUniformBuffers&&(h=h.replace("Vertex","Ubo").replace("Fragment","Ubo")),h=h+"Declaration"),e.includesShadersStore[h]){let l=e.includesShadersStore[h];if(o[2]){let c=o[3].split(",");for(let f=0;f<c.length;f+=2){let _=new RegExp(c[f],"g"),d=c[f+1];l=l.replace(_,d)}}if(o[4]){let c=o[5];if(c.indexOf("..")!==-1){let f=c.split(".."),_=parseInt(f[0]),d=parseInt(f[1]),m=l.slice(0);l="",isNaN(d)&&(d=e.indexParameters[f[1]]);for(let T=_;T<d;T++)e.supportsUniformBuffers||(m=m.replace(Fr,(R,g)=>g+"{X}")),l+=m.replace(Cr,T.toString())+`
`}else e.supportsUniformBuffers||(l=l.replace(Fr,(f,_)=>_+"{X}")),l=l.replace(Cr,c)}let u=[];for(let c of s){let f=c.split(o[0]);for(let _=0;_<f.length-1;_++)u.push(f[_]),u.push(l);u.push(f[f.length-1])}s=u,a=a||l.indexOf("#include<")>=0||l.indexOf("#include <")>=0}else{let l=e.shadersRepository+"ShadersInclude/"+h+".fx";Zt.loadFile(l,u=>{e.includesShadersStore[h]=u,Rt(s.join(""),e,t)});return}}yt.length=0,i=s.join(""),a?Rt(i.toString(),e,t):t(i)}var Zt={loadFile:(n,e,t,r,i,s)=>{throw v("FileTools")}};function Mr(n,e){return ie(e).cachedPipelines[n]}function bt(n){let e=n._name,t=n.context;if(e&&t){let r=ie(t);r.cachedPipelines[e]?.dispose(),delete r.cachedPipelines[e]}}function Ur(n,e,t,r,i,s,a){let o,h,l=k()?s?.getHostDocument():null;typeof e=="string"?o=e:e.vertexSource?o="source:"+e.vertexSource:e.vertexElement?o=l?.getElementById(e.vertexElement)||e.vertexElement:o=e.vertex||e,typeof e=="string"?h=e:e.fragmentSource?h="source:"+e.fragmentSource:e.fragmentElement?h=l?.getElementById(e.fragmentElement)||e.fragmentElement:h=e.fragment||e;let u=[void 0,void 0],c=()=>{if(u[0]&&u[1]){n.isFragment=!0;let[f,_]=u;Yt(_,n,(d,m)=>{a&&(a._fragmentSourceCodeBeforeMigration=m),t&&(d=t("fragment",d));let T=Sr(f,d,n);n=null;let R=Ti(T.vertexCode,T.fragmentCode,e,i);r?.(R.vertexSourceCode,R.fragmentSourceCode)},s)}};Pr(o,"Vertex","",f=>{wr(n),Yt(f,n,(_,d)=>{a&&(a._rawVertexSourceCode=f,a._vertexSourceCodeBeforeMigration=d),t&&(_=t("vertex",_)),u[0]=_,c()},s)},i),Pr(h,"Fragment","Pixel",f=>{a&&(a._rawFragmentSourceCode=f),u[1]=f,c()},i)}function Pr(n,e,t,r,i,s){if(typeof HTMLElement<"u"&&n instanceof HTMLElement){let h=st(n);r(h);return}if(n.substr(0,7)==="source:"){r(n.substr(7));return}if(n.substr(0,7)==="base64:"){let h=window.atob(n.substr(7));r(h);return}let a=oe.GetShadersStore(i);if(a[n+e+"Shader"]){r(a[n+e+"Shader"]);return}if(t&&a[n+t+"Shader"]){r(a[n+t+"Shader"]);return}let o;if(n[0]==="."||n[0]==="/"||n.indexOf("http")>-1?o=n:o=oe.GetShadersRepository(i)+n,s=s||at,!s)throw new Error("loadFileInjection is not defined");s(o+"."+e.toLowerCase()+".fx",r)}function Ti(n,e,t,r){if(t){let i=t.vertexElement||t.vertex||t.spectorName||t,s=t.fragmentElement||t.fragment||t.spectorName||t;return{vertexSourceCode:(r===$.WGSL?"//":"")+"#define SHADER_NAME vertex:"+i+`
`+n,fragmentSourceCode:(r===$.WGSL?"//":"")+"#define SHADER_NAME fragment:"+s+`
`+e}}else return{vertexSourceCode:n,fragmentSourceCode:e}}var Dr=(n,e,t,r)=>{try{let i=n.existingPipelineContext||e(n.shaderProcessingContext);if(i._name=n.name,n.name&&n.context){let s=ie(n.context);s.cachedPipelines[n.name]=i}return t(i,n.vertex,n.fragment,!!n.createAsRaw,"","",n.rebuildRebind,n.defines,n.transformFeedbackVaryings,""),r(i,()=>{n.onRenderingStateCompiled?.(i)}),i}catch(i){throw C.Error("Error compiling effect"),i}};var he=class n{static get ShadersRepository(){return oe.ShadersRepository}static set ShadersRepository(e){oe.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new L),this._onBindObservable}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,r,i=null,s,a=null,o=null,h=null,l=null,u,c="",f=$.GLSL){this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new L,this.onErrorObservable=new L,this._onBindObservable=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._vertexSourceCodeBeforeMigration="",this._fragmentSourceCodeBeforeMigration="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this._processCodeAfterIncludes=void 0,this._processFinalCode=null,this.name=e,this._key=c;let _=this._key.replace(/\r/g,"").replace(/\n/g,"|"),d;if(t.attributes){let m=t;if(this._engine=r,this._attributesNames=m.attributes,this._uniformsNames=m.uniformsNames.concat(m.samplers),this._samplerList=m.samplers.slice(),this.defines=m.defines,this.onError=m.onError,this.onCompiled=m.onCompiled,this._fallbacks=m.fallbacks,this._indexParameters=m.indexParameters,this._transformFeedbackVaryings=m.transformFeedbackVaryings||null,this._multiTarget=!!m.multiTarget,this._shaderLanguage=m.shaderLanguage??$.GLSL,m.uniformBuffersNames){this._uniformBuffersNamesList=m.uniformBuffersNames.slice();for(let T=0;T<m.uniformBuffersNames.length;T++)this._uniformBuffersNames[m.uniformBuffersNames[T]]=T}this._processFinalCode=m.processFinalCode??null,this._processCodeAfterIncludes=m.processCodeAfterIncludes??void 0,d=m.existingPipelineContext}else this._engine=s,this.defines=a??"",this._uniformsNames=r.concat(i),this._samplerList=i?i.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=f,this.onError=l,this.onCompiled=h,this._indexParameters=u,this._fallbacks=o;this._engine.shaderPlatformName==="WEBGL2"&&(d=Mr(_,this._engine._gl)??d),this._attributeLocationByName={},this.uniqueId=n._UniqueIdSeed++,d?(this._pipelineContext=d,this._pipelineContext.setEngine(this._engine),this._onRenderingStateCompiled(this._pipelineContext),this._pipelineContext.program&&(this._pipelineContext.program.__SPECTOR_rebuildProgram=this._rebuildProgram.bind(this))):this._processShaderCode()}_processShaderCode(e=null,t=!1,r=null){this._processingContext=r||this._engine._getShaderProcessingContext(this._shaderLanguage);let i={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:e??this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:oe.GetShadersRepository(this._shaderLanguage),includesShadersStore:oe.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:this._processCodeAfterIncludes};Ur(i,this.name,this._processFinalCode,(s,a)=>{this._vertexSourceCode=s,this._fragmentSourceCode=a,this._prepareEffect(t)},this._shaderLanguage,this._engine,this)}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}this._isDisposed||setTimeout(()=>{this._checkIsReady(e)},16)}get vertexSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:this._pipelineContext?._getVertexShaderCode()??this._vertexSourceCode}get fragmentSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:this._pipelineContext?._getFragmentShaderCode()??this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}getPipelineGenerationOptions(){return{platformName:this._engine.shaderPlatformName,shaderLanguage:this._shaderLanguage,shaderNameOrContent:this.name,key:this._key,defines:this.defines.split(`
`),addGlobalDefines:!1,extendedProcessingOptions:{indexParameters:this._indexParameters,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,supportsUniformBuffers:this._engine.supportsUniformBuffers},extendedCreatePipelineOptions:{transformFeedbackVaryings:this._transformFeedbackVaryings,createAsRaw:!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride)}}}_rebuildProgram(e,t,r,i){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(s,a)=>{i&&i(a)},this.onCompiled=()=>{let s=this.getEngine().scenes;if(s)for(let a=0;a<s.length;a++)s[a].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback?.(r)},this._fallbacks=null,this._prepareEffect()}_onRenderingStateCompiled(e){if(this._pipelineContext=e,this._pipelineContext.setEngine(this._engine),this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,this._attributesNames,this._attributes),this._attributesNames)for(let t=0;t<this._attributesNames.length;t++){let r=this._attributesNames[t];this._attributeLocationByName[r]=this._attributes[t]}this._engine.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh()}_prepareEffect(e=!1){let t=this._pipelineContext;this._isReady=!1;try{let r=!!(this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride),i=r?null:this.defines,s=r?this._vertexSourceCodeOverride:this._vertexSourceCode,a=r?this._fragmentSourceCodeOverride:this._fragmentSourceCode,o=this._engine;this._pipelineContext=Dr({existingPipelineContext:e?t:null,vertex:s,fragment:a,context:o.shaderPlatformName==="WEBGL2"?o._gl:void 0,rebuildRebind:(h,l,u,c)=>this._rebuildProgram(h,l,u,c),defines:i,transformFeedbackVaryings:this._transformFeedbackVaryings,name:this._key.replace(/\r/g,"").replace(/\n/g,"|"),createAsRaw:r,parallelShaderCompile:o._caps.parallelShaderCompile,shaderProcessingContext:this._processingContext,onRenderingStateCompiled:h=>{t&&!e&&this._engine._deletePipelineContext(t),h&&this._onRenderingStateCompiled(h)}},this._engine.createPipelineContext.bind(this._engine),this._engine._preparePipelineContext.bind(this._engine),this._engine._executeWhenRenderingStateIsCompiled.bind(this._engine)),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(r){this._processCompilationErrors(r,t)}}_getShaderCodeAndErrorLine(e,t,r){let i=r?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/,s=null;if(t&&e){let a=t.match(i);if(a&&a.length===2){let o=parseInt(a[1]),h=e.split(`
`,-1);h.length>=o&&(s=`Offending line [${o}] in ${r?"fragment":"vertex"} code: ${h[o-1]}`)}}return[e,s]}_processCompilationErrors(e,t=null){this._compilationError=e.message;let r=this._attributesNames,i=this._fallbacks;if(C.Error("Unable to compile effect:"),C.Error("Uniforms: "+this._uniformsNames.map(function(a){return" "+a})),C.Error("Attributes: "+r.map(function(a){return" "+a})),C.Error(`Defines:
`+this.defines),n.LogShaderCodeOnCompilationError){let a=null,o=null,h=null;this._pipelineContext?._getVertexShaderCode()&&([h,a]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),h&&(C.Error("Vertex code:"),C.Error(h))),this._pipelineContext?._getFragmentShaderCode()&&([h,o]=this._getShaderCodeAndErrorLine(this._pipelineContext?._getFragmentShaderCode(),this._compilationError,!0),h&&(C.Error("Fragment code:"),C.Error(h))),a&&C.Error(a),o&&C.Error(o)}C.Error("Error: "+this._compilationError);let s=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,s()),i?(this._pipelineContext=null,i.hasMoreFallbacks?(this._allFallbacksProcessed=!1,C.Error("Trying next fallback."),this.defines=i.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,s(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||s())}get isSupported(){return this._compilationError===""}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){let r=e+"Ex";if(this._samplerList.indexOf(r+"0")===-1){let i=this._samplerList.indexOf(e);for(let a=1;a<t.length;a++){let o=r+(a-1).toString();this._samplerList.splice(i+a,0,o)}let s=0;for(let a of this._samplerList)this._samplers[a]=s,s+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}bindUniformBuffer(e,t){let r=this._uniformBuffersNames[t];r===void 0||n._BaseCache[r]===e&&this._engine._features.useUBOBindingCache||(n._BaseCache[r]=e,this._engine.bindUniformBufferBase(e,r,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,r){return this._pipelineContext.setInt2(e,t,r),this}setInt3(e,t,r,i){return this._pipelineContext.setInt3(e,t,r,i),this}setInt4(e,t,r,i,s){return this._pipelineContext.setInt4(e,t,r,i,s),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setUInt(e,t),this}setUInt2(e,t,r){return this._pipelineContext.setUInt2(e,t,r),this}setUInt3(e,t,r,i){return this._pipelineContext.setUInt3(e,t,r,i),this}setUInt4(e,t,r,i,s){return this._pipelineContext.setUInt4(e,t,r,i,s),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,r){return this._pipelineContext.setFloat2(e,t,r),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,r,i){return this._pipelineContext.setFloat3(e,t,r,i),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,r,i,s){return this._pipelineContext.setFloat4(e,t,r,i,s),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,r){return this._pipelineContext.setColor4(e,t,r),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}dispose(){this._pipelineContext&&bt(this._pipelineContext),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,t,r,i=$.GLSL){t&&(oe.GetShadersStore(i)[`${e}PixelShader`]=t),r&&(oe.GetShadersStore(i)[`${e}VertexShader`]=r)}static ResetCache(){n._BaseCache={}}};he.LogShaderCodeOnCompilationError=!0;he._UniqueIdSeed=0;he._BaseCache={};he.ShadersStore=oe.ShadersStore;he.IncludesShadersStore=oe.IncludesShadersStore;var ye=class{static get Now(){return k()&&window.performance&&window.performance.now?window.performance.now():Date.now()}};var Et=class{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}};var At=class{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){this.stencilMaterial=void 0,this.stencilGlobal?.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){if(!e)return;let t=!this.useStencilGlobalOnly&&!!this.stencilMaterial?.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}};var Lr=(()=>{class n{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=n.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=n.KEEP,this.opDepthFail=n.KEEP,this.opStencilDepthPass=n.REPLACE}get stencilFunc(){return this.func}set stencilFunc(t){this.func=t}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(t){this.funcRef=t}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(t){this.funcMask=t}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(t){this.opStencilFail=t}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(t){this.opDepthFail=t}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(t){this.opStencilDepthPass=t}get stencilMask(){return this.mask}set stencilMask(t){this.mask=t}get stencilTest(){return this.enabled}set stencilTest(t){this.enabled=t}}return n.ALWAYS=519,n.KEEP=7680,n.REPLACE=7681,n})();var Ft=class{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,r,i){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===r&&this._blendConstants[3]===i||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=r,this._blendConstants[3]=i,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,r,i){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===r&&this._blendFunctionParameters[3]===i||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=r,this._blendFunctionParameters[3]=i,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}};var Ge=class{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,r=1,i=1,s=2,a=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=r,this._cachedAnisotropicFilteringLevel=i,this.samplingMode=s,this._comparisonFunction=a,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}};var Y=function(n){return n[n.Unknown=0]="Unknown",n[n.Url=1]="Url",n[n.Temp=2]="Temp",n[n.Raw=3]="Raw",n[n.Dynamic=4]="Dynamic",n[n.RenderTarget=5]="RenderTarget",n[n.MultiRenderTarget=6]="MultiRenderTarget",n[n.Cube=7]="Cube",n[n.CubeRaw=8]="CubeRaw",n[n.CubePrefiltered=9]="CubePrefiltered",n[n.Raw3D=10]="Raw3D",n[n.Raw2DArray=11]="Raw2DArray",n[n.DepthStencil=12]="DepthStencil",n[n.CubeRawRGBD=13]="CubeRawRGBD",n[n.Depth=14]="Depth",n}(Y||{}),We=(()=>{class n extends Ge{get useMipMaps(){return this.generateMipMaps}set useMipMaps(t){this.generateMipMaps=t}get uniqueId(){return this._uniqueId}_setUniqueId(t){this._uniqueId=t}getEngine(){return this._engine}get source(){return this._source}constructor(t,r,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new L,this.onErrorObservable=new L,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=Y.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._creationFlags=0,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._premulAlpha=!1,this._dynamicTextureSource=null,this._engine=t,this._source=r,this._uniqueId=n._Counter++,i||(this._hardwareTexture=t._createHardwareTexture())}incrementReferences(){this._references++}updateSize(t,r,i=1){this._engine.updateTextureDimensions(this,t,r,i),this.width=t,this.height=r,this.depth=i,this.baseWidth=t,this.baseHeight=r,this.baseDepth=i,this._size=t*r*i}_rebuild(){if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){let r=this.onRebuildCallback(this),i=s=>{s._swapAndDie(this,!1),this.isReady=r.isReady};r.isAsync?r.proxy.then(i):i(r.proxy);return}let t;switch(this.source){case Y.Temp:break;case Y.Url:t=this._engine.createTexture(this._originalUrl??this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,r=>{r._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case Y.Raw:t=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,this._creationFlags,this._useSRGBBuffer),t._swapAndDie(this,!1),this.isReady=!0;break;case Y.Raw3D:t=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case Y.Raw2DArray:t=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case Y.Dynamic:t=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),t._swapAndDie(this,!1),this._dynamicTextureSource&&this._engine.updateDynamicTexture(this,this._dynamicTextureSource,this.invertY,this._premulAlpha,this.format,!0);break;case Y.Cube:t=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{t._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer,ArrayBuffer.isView(this._buffer)?this._buffer:null);return;case Y.CubeRaw:t=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this._originalFormat??this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),t._swapAndDie(this,!1),this.isReady=!0;break;case Y.CubeRawRGBD:return;case Y.CubePrefiltered:t=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,r=>{r&&r._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),t._sphericalPolynomial=this._sphericalPolynomial;return;case Y.DepthStencil:case Y.Depth:break}}_swapAndDie(t,r=!0){this._hardwareTexture?.setUsage(t._source,this.generateMipMaps,this.is2DArray,this.isCube,this.is3D,this.width,this.height,this.depth),t._hardwareTexture=this._hardwareTexture,r&&(t._isRGBD=this._isRGBD),this._lodTextureHigh&&(t._lodTextureHigh&&t._lodTextureHigh.dispose(),t._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(t._lodTextureMid&&t._lodTextureMid.dispose(),t._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(t._lodTextureLow&&t._lodTextureLow.dispose(),t._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(t._irradianceTexture&&t._irradianceTexture.dispose(),t._irradianceTexture=this._irradianceTexture);let i=this._engine.getLoadedTexturesCache(),s=i.indexOf(this);s!==-1&&i.splice(s,1),s=i.indexOf(t),s===-1&&i.push(t)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null,this._dynamicTextureSource=null)}}return n._Counter=0,n})();function Qt(n,e){if(k()){let{requestAnimationFrame:t}=e||window;if(typeof t=="function")return t(n)}else if(typeof requestAnimationFrame=="function")return requestAnimationFrame(n);return setTimeout(n,16)}var Ie=(()=>{class n{get frameId(){return this._frameId}get isWebGPU(){return this._isWebGPU}_getShaderProcessor(t){return this._shaderProcessor}get shaderPlatformName(){return this._shaderPlatformName}_clearEmptyResources(){this._emptyTexture=null,this._emptyCubeTexture=null,this._emptyTexture3D=null,this._emptyTexture2DArray=null}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(t){t!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=t,t?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}setColorWrite(t){t!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=t)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}_getGlobalDefines(t){if(t){this.isNDCHalfZRange?t.IS_NDC_HALF_ZRANGE="":delete t.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?t.USE_REVERSE_DEPTHBUFFER="":delete t.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?t.USE_EXACT_SRGB_CONVERSIONS="":delete t.USE_EXACT_SRGB_CONVERSIONS;return}else{let r="";return this.isNDCHalfZRange&&(r+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(r&&(r+=`
`),r+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(r&&(r+=`
`),r+="#define USE_EXACT_SRGB_CONVERSIONS"),r}}_rebuildInternalTextures(){let t=this._internalTexturesCache.slice();for(let r of t)r._rebuild()}_rebuildRenderTargetWrappers(){let t=this._renderTargetWrapperCache.slice();for(let r of t)r._rebuild()}_rebuildEffects(){for(let t in this._compiledEffects){let r=this._compiledEffects[t];r._pipelineContext=null,r._prepareEffect()}he.ResetCache()}_rebuildGraphicsResources(){this.wipeCaches(!0),this._rebuildEffects(),this._rebuildComputeEffects?.(),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0)}_flagContextRestored(){C.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1}_restoreEngineAfterContextLost(t){setTimeout(()=>Oe(this,null,function*(){this._clearEmptyResources();let r=this._depthCullingState.depthTest,i=this._depthCullingState.depthFunc,s=this._depthCullingState.depthMask,a=this._stencilState.stencilTest;yield t(),this._rebuildGraphicsResources(),this._depthCullingState.depthTest=r,this._depthCullingState.depthFunc=i,this._depthCullingState.depthMask=s,this._stencilState.stencilTest=a,this._flagContextRestored()}),0)}get isDisposed(){return this._isDisposed}get snapshotRendering(){return!1}set snapshotRendering(t){}get snapshotRenderingMode(){return 0}set snapshotRenderingMode(t){}getClassName(){return"AbstractEngine"}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){let t=new Uint8Array(4),r=[t,t,t,t,t,t];this._emptyCubeTexture=this.createRawCubeTexture(r,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get activeRenderLoops(){return this._activeRenderLoops}stopRenderLoop(t){if(!t){this._activeRenderLoops.length=0,this._cancelFrame();return}let r=this._activeRenderLoops.indexOf(t);r>=0&&(this._activeRenderLoops.splice(r,1),this._activeRenderLoops.length==0&&this._cancelFrame())}_cancelFrame(){if(this._frameHandler!==0){let t=this._frameHandler;if(this._frameHandler=0,k()){let{cancelAnimationFrame:r}=this.getHostWindow()||window;if(typeof r=="function")return r(t)}else if(typeof cancelAnimationFrame=="function")return cancelAnimationFrame(t);return clearTimeout(t)}}beginFrame(){this.onBeginFrameObservable.notifyObservers(this)}endFrame(){this._frameId++,this.onEndFrameObservable.notifyObservers(this)}_renderLoop(){if(this._frameHandler=0,!this._contextWasLost){let t=!0;(this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(t=!1),t&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}_renderFrame(){for(let t=0;t<this._activeRenderLoops.length;t++){let r=this._activeRenderLoops[t];r()}}_renderViews(){return!1}_queueNewFrame(t,r){return Qt(t,r)}runRenderLoop(t){this._activeRenderLoops.indexOf(t)===-1&&(this._activeRenderLoops.push(t),this._activeRenderLoops.length===1&&this._frameHandler===0&&(this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(t){this._depthCullingState.depthTest=t}setZOffset(t){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-t:t}getZOffset(){let t=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-t:t}setZOffsetUnits(t){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-t:t}getZOffsetUnits(){let t=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-t:t}getHostWindow(){return k()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(t){this._compatibilityMode=!0}_rebuildTextures(){for(let t of this.scenes)t._rebuildTextures();for(let t of this._virtualScenes)t._rebuildTextures()}_releaseRenderTargetWrapper(t){let r=this._renderTargetWrapperCache.indexOf(t);r!==-1&&this._renderTargetWrapperCache.splice(r,1)}get currentViewport(){return this._cachedViewport}setViewport(t,r,i){let s=r||this.getRenderWidth(),a=i||this.getRenderHeight(),o=t.x||0,h=t.y||0;this._cachedViewport=t,this._viewport(o*s,h*a,s*t.width,a*t.height)}createCanvasImage(){return document.createElement("img")}get description(){let t=this.name+this.version;return this._caps.parallelShaderCompile&&(t+=" - Parallel shader compilation"),t}_createTextureBase(t,r,i,s,a=3,o=null,h=null,l,u,c=null,f=null,_=null,d=null,m,T,R){t=t||"";let g=t.substr(0,5)==="data:",F=t.substr(0,5)==="blob:",E=g&&t.indexOf(";base64,")!==-1,x=f||new We(this,Y.Url);x!==f&&(x.label=t.substring(0,60));let y=t;this._transformTextureUrl&&!E&&!f&&!c&&(t=this._transformTextureUrl(t)),y!==t&&(x._originalUrl=y);let B=t.lastIndexOf("."),w=d||(B>-1?t.substring(B).toLowerCase():""),j=null;w.indexOf("?")>-1&&(w=w.split("?")[0]);for(let D of n._TextureLoaders)if(D.canLoad(w,m)){j=D;break}s&&s.addPendingData(x),x.url=t,x.generateMipMaps=!r,x.samplingMode=a,x.invertY=i,x._useSRGBBuffer=this._getUseSRGBBuffer(!!R,r),this._doNotHandleContextLost||(x._buffer=c);let J=null;o&&!f&&(J=x.onLoadedObservable.add(o)),f||this._internalTexturesCache.push(x);let W=(D,P)=>{s&&s.removePendingData(x),t===y?(J&&x.onLoadedObservable.remove(J),G.UseFallbackTexture&&t!==G.FallbackTexture&&this._createTextureBase(G.FallbackTexture,r,x.invertY,s,a,null,h,l,u,c,x),D=(D||"Unknown error")+(G.UseFallbackTexture?" - Fallback texture was used":""),x.onErrorObservable.notifyObservers({message:D,exception:P}),h&&h(D,P)):(C.Warn(`Failed to load ${t}, falling back to ${y}`),this._createTextureBase(y,r,x.invertY,s,a,o,h,l,u,c,x,_,d,m,T,R))};if(j){let D=P=>{j.loadData(P,x,(se,le,ge,ne,ae,ce)=>{ce?W("TextureLoader failed to load data"):l(x,w,s,{width:se,height:le},x.invertY,!ge,ne,()=>(ae(),!1),a)},T)};c?c instanceof ArrayBuffer?D(new Uint8Array(c)):ArrayBuffer.isView(c)?D(c):h&&h("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(t,P=>D(new Uint8Array(P)),void 0,s?s.offlineProvider:void 0,!0,(P,se)=>{W("Unable to load "+(P&&P.responseURL,se))})}else{let D=P=>{F&&!this._doNotHandleContextLost&&(x._buffer=P),l(x,w,s,P,x.invertY,r,!1,u,a)};!g||E?c&&(typeof c.decoding=="string"||c.close)?D(c):n._FileToolsLoadImage(t||"",D,W,s?s.offlineProvider:null,m,x.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof c=="string"||c instanceof ArrayBuffer||ArrayBuffer.isView(c)||c instanceof Blob?n._FileToolsLoadImage(c,D,W,s?s.offlineProvider:null,m,x.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):c&&D(c)}return x}_rebuildBuffers(){for(let t of this._uniformBuffers)t._rebuildAfterContextLost()}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:He()?document:null}getLoadedTexturesCache(){return this._internalTexturesCache}clearInternalTexturesCache(){this._internalTexturesCache.length=0}getCaps(){return this._caps}resetTextureCache(){for(let t in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,t)&&(this._boundTexturesCache[t]=null);this._currentTextureChannel=-1}get name(){return this._name}set name(t){this._name=t}static get NpmPackage(){return"babylonjs@7.12.0"}static get Version(){return"7.12.0"}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}setHardwareScalingLevel(t){this._hardwareScalingLevel=t,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(t){this._doNotHandleContextLost=t}get isStencilEnable(){return this._isStencilEnable}getCreationOptions(){return this._creationOptions}constructor(t,r,i){this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new Et,this._stencilStateComposer=new At,this._stencilState=new Lr,this._alphaState=new Ft,this._alphaMode=1,this._alphaEquation=0,this._activeRequests=[],this._badOS=!1,this._badDesktopOS=!1,this._compatibilityMode=!0,this._internalTexturesCache=new Array,this._currentRenderTarget=null,this._boundTexturesCache={},this._activeChannel=0,this._currentTextureChannel=-1,this._viewportCached={x:0,y:0,z:0,w:0},this._isWebGPU=!1,this.onCanvasBlurObservable=new L,this.onCanvasFocusObservable=new L,this.onNewSceneAddedObservable=new L,this.onResizeObservable=new L,this.onCanvasPointerOutObservable=new L,this.disablePerformanceMonitorInBackground=!1,this.disableVertexArrayObjects=!1,this._frameId=0,this.hostInformation={isMobile:!1},this.isFullscreen=!1,this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.currentRenderPassId=0,this.isPointerLock=!1,this.postProcesses=[],this.canvasTabIndex=1,this._contextWasLost=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this._renderTargetWrapperCache=new Array,this._compiledEffects={},this._isDisposed=!1,this.scenes=[],this._virtualScenes=new Array,this.onBeforeTextureInitObservable=new L,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this._frameHandler=0,this._activeRenderLoops=new Array,this._windowIsBackground=!1,this._boundRenderFunction=()=>this._renderLoop(),this.onBeforeShaderCompilationObservable=new L,this.onAfterShaderCompilationObservable=new L,this.onBeginFrameObservable=new L,this.onEndFrameObservable=new L,this._transformTextureUrl=null,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._highPrecisionShadersAllowed=!0,this.onContextLostObservable=new L,this.onContextRestoredObservable=new L,this._name="",this.premultipliedAlpha=!0,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._doNotHandleContextLost=!1,this.cullBackFaces=null,this._renderPassNames=["main"],this._fps=60,this._deltaTime=0,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this.onDisposeObservable=new L,G.Instances.push(this),this.startTime=ye.Now,this._stencilStateComposer.stencilGlobal=this._stencilState,te.SetMatrixPrecision(!!r.useHighPrecisionMatrix),it()&&navigator.userAgent&&(this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)),this.adaptToDeviceRatio=i??!1,r.antialias=t??r.antialias,r.deterministicLockstep=r.deterministicLockstep??!1,r.lockstepMaxSteps=r.lockstepMaxSteps??4,r.timeStep=r.timeStep??1/60,r.audioEngine=r.audioEngine??!0,r.stencil=r.stencil??!0,this._audioContext=r.audioEngineOptions?.audioContext??null,this._audioDestination=r.audioEngineOptions?.audioDestination??null,this.premultipliedAlpha=r.premultipliedAlpha??!0,this._doNotHandleContextLost=!!r.doNotHandleContextLost,this._isStencilEnable=!!r.stencil,this.useExactSrgbConversions=r.useExactSrgbConversions??!1;let s=k()&&window.devicePixelRatio||1,a=r.limitDeviceRatio||s;i=i||r.adaptToDeviceRatio||!1,this._hardwareScalingLevel=i?1/Math.min(a,s):1,this._lastDevicePixelRatio=s,this._creationOptions=r}resize(t=!1){let r,i;if(this.adaptToDeviceRatio){let s=k()&&window.devicePixelRatio||1,a=this._lastDevicePixelRatio/s;this._lastDevicePixelRatio=s,this._hardwareScalingLevel*=a}if(k()&&He())if(this._renderingCanvas){let s=this._renderingCanvas.getBoundingClientRect?this._renderingCanvas.getBoundingClientRect():{width:this._renderingCanvas.width*this._hardwareScalingLevel,height:this._renderingCanvas.height*this._hardwareScalingLevel};r=this._renderingCanvas.clientWidth||s.width||this._renderingCanvas.width||100,i=this._renderingCanvas.clientHeight||s.height||this._renderingCanvas.height||100}else r=window.innerWidth,i=window.innerHeight;else r=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100;this.setSize(r/this._hardwareScalingLevel,i/this._hardwareScalingLevel,t)}setSize(t,r,i=!1){if(!this._renderingCanvas||(t=t|0,r=r|0,!i&&this._renderingCanvas.width===t&&this._renderingCanvas.height===r))return!1;if(this._renderingCanvas.width=t,this._renderingCanvas.height=r,this.scenes){for(let s=0;s<this.scenes.length;s++){let a=this.scenes[s];for(let o=0;o<a.cameras.length;o++){let h=a.cameras[o];h._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}createRawTexture(t,r,i,s,a,o,h,l,u,c,f){throw v("engine.rawTexture")}createRawCubeTexture(t,r,i,s,a,o,h,l){throw v("engine.rawTexture")}createRawTexture3D(t,r,i,s,a,o,h,l,u,c,f){throw v("engine.rawTexture")}createRawTexture2DArray(t,r,i,s,a,o,h,l,u,c,f){throw v("engine.rawTexture")}_sharedInit(t){this._renderingCanvas=t}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{let t=navigator.userAgent;this.hostInformation.isMobile=t.indexOf("Mobile")!==-1||t.indexOf("Mac")!==-1&&He()&&"ontouchend"in document},this._checkForMobile(),k()&&window.addEventListener("resize",this._checkForMobile))}createVideoElement(t){return document.createElement("video")}_reportDrawCall(t=1){this._drawCalls?.addCount(t,!1)}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}_createImageBitmapFromSource(t,r){throw new Error("createImageBitmapFromSource is not implemented")}createImageBitmap(t,r){return createImageBitmap(t,r)}resizeImageBitmap(t,r,i){throw new Error("resizeImageBitmap is not implemented")}getFontOffset(t){throw new Error("getFontOffset is not implemented")}static _CreateCanvas(t,r){if(typeof document>"u")return new OffscreenCanvas(t,r);let i=document.createElement("canvas");return i.width=t,i.height=r,i}createCanvas(t,r){return n._CreateCanvas(t,r)}static _FileToolsLoadImage(t,r,i,s,a,o){throw v("FileTools")}_loadFile(t,r,i,s,a,o){let h=at(t,r,i,s,a,o);return this._activeRequests.push(h),h.onCompleteObservable.add(()=>{let l=this._activeRequests.indexOf(h);l!==-1&&this._activeRequests.splice(l,1)}),h}static _FileToolsLoadFile(t,r,i,s,a,o){if(ze.loadFile)return ze.loadFile(t,r,i,s,a,o);throw v("FileTools")}dispose(){for(this.releaseEffects(),this._isDisposed=!0,this.stopRenderLoop(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._renderingCanvas=null,this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(;this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();this.releaseComputeEffects?.(),he.ResetCache();for(let r of this._activeRequests)r.abort();this._boundRenderFunction=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onNewSceneAddedObservable.clear(),k()&&window.removeEventListener("resize",this._checkForMobile);let t=G.Instances.indexOf(this);t>=0&&G.Instances.splice(t,1),G.Instances.length||(G.OnEnginesDisposedObservable.notifyObservers(this),G.OnEnginesDisposedObservable.clear()),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}static DefaultLoadingScreenFactory(t){throw v("LoadingScreen")}}return n._TextureLoaders=[],n._RenderPassIdCounter=0,n._RescalePostProcessFactory=null,n})();var Ct=class{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||(this._MSAARenderBuffers=[]),this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(let e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}getMSAARenderBuffer(e=0){return this._MSAARenderBuffers?.[e]??null}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}};var $t=class{},U=class n extends Ie{get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return he.ShadersRepository}static set ShadersRepository(e){he.ShadersRepository=e}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}snapshotRenderingReset(){this.snapshotRendering=!1}constructor(e,t,r,i){if(r=r||{},super(t??r.antialias,r,i),this._name="WebGL",this.forcePOTTextures=!1,this.validateShaderPrograms=!1,this.disableUniformBuffers=!1,this._webGLVersion=1,this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},!e)return;let s=null;if(e.getContext){if(s=e,this._renderingCanvas=s,r.preserveDrawingBuffer===void 0&&(r.preserveDrawingBuffer=!1),r.xrCompatible===void 0&&(r.xrCompatible=!1),navigator&&navigator.userAgent){this._setupMobileChecks();let h=navigator.userAgent;for(let l of n.ExceptionList){let u=l.key,c=l.targets;if(new RegExp(u).test(h)){if(l.capture&&l.captureConstraint){let _=l.capture,d=l.captureConstraint,T=new RegExp(_).exec(h);if(T&&T.length>0&&parseInt(T[T.length-1])>=d)continue}for(let _ of c)switch(_){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":r.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost||(this._onContextLost=h=>{h.preventDefault(),this._contextWasLost=!0,C.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(()=>this._initGLContext())},s.addEventListener("webglcontextlost",this._onContextLost,!1),s.addEventListener("webglcontextrestored",this._onContextRestored,!1),r.powerPreference=r.powerPreference||"high-performance"),this._badDesktopOS&&(r.xrCompatible=!1),!r.disableWebGL2Support)try{this._gl=s.getContext("webgl2",r)||s.getContext("experimental-webgl2",r),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!s)throw new Error("The provided canvas is null or undefined.");try{this._gl=s.getContext("webgl",r)||s.getContext("experimental-webgl",r)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";let h=this._gl.getContextAttributes();h&&(r.stencil=h.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),r.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=r.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let h=0;h<this._caps.maxVertexAttribs;h++)this._currentBufferPointers[h]=new $t;this._shaderProcessor=this.webGLVersion>1?new ct:new lt;let a=`Babylon.js v${n.Version}`;C.Log(a+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",a);let o=ie(this._gl);o.validateShaderPrograms=this.validateShaderPrograms,o.parallelShaderCompile=this._caps.parallelShaderCompile}_clearEmptyResources(){this._dummyFramebuffer=null,super._clearEmptyResources()}_getShaderProcessingContext(e){return null}areAllEffectsReady(){for(let e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,colorBufferHalfFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._caps.supportFloatTexturesResolve=this._caps.colorBufferFloat,this._caps.rg11b10ufColorRenderable=this._caps.colorBufferFloat,this._glVersion=this._gl.getParameter(this._gl.VERSION);let e=this._gl.getExtension("WEBGL_debug_renderer_info");if(e!=null&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{let t=this._gl.getExtension("WEBGL_draw_buffers");if(t!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=t.drawBuffersWEBGL.bind(t),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let r=0;r<16;r++)this._gl["COLOR_ATTACHMENT"+r+"_WEBGL"]=t["COLOR_ATTACHMENT"+r+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{let t=this._gl.getExtension("WEBGL_depth_texture");t!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=t.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{let t=this._gl.getExtension("OES_vertex_array_object");t!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=t.createVertexArrayOES.bind(t),this._gl.bindVertexArray=t.bindVertexArrayOES.bind(t),this._gl.deleteVertexArray=t.deleteVertexArrayOES.bind(t))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{let t=this._gl.getExtension("ANGLE_instanced_arrays");t!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=t.drawArraysInstancedANGLE.bind(t),this._gl.drawElementsInstanced=t.drawElementsInstancedANGLE.bind(t),this._gl.vertexAttribDivisor=t.vertexAttribDivisorANGLE.bind(t)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){let t=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),r=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);t&&r&&(this._caps.highPrecisionShaderSupported=t.precision!==0&&r.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{let t=this._gl.getExtension("EXT_blend_minmax");t!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=t.MAX_EXT,this._gl.MIN=t.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8};else{let t=this._gl.getExtension("EXT_sRGB");t!=null&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:t.SRGB_EXT,SRGB8:t.SRGB_ALPHA_EXT,SRGB8_ALPHA8:t.SRGB_ALPHA_EXT})}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let t=0;t<this._maxSimultaneousTextures;t++)this._nextFreeTextureSlots.push(t);this._glRenderer==="Mali-G72"&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:typeof HTMLImageElement>"u",supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!1,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);let e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}extractDriverInfo(){let e=this.getGlInfo();return e&&e.renderer?e.renderer:""}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}clear(e,t,r,i=!1){let s=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=s;let a=0;if(t&&e){let o=!0;if(this._currentRenderTarget){let h=this._currentRenderTarget.texture?.format;if(h===8||h===9||h===10||h===11){let l=this._currentRenderTarget.texture?.type;l===7||l===5?(n._TempClearColorUint32[0]=e.r*255,n._TempClearColorUint32[1]=e.g*255,n._TempClearColorUint32[2]=e.b*255,n._TempClearColorUint32[3]=e.a*255,this._gl.clearBufferuiv(this._gl.COLOR,0,n._TempClearColorUint32),o=!1):(n._TempClearColorInt32[0]=e.r*255,n._TempClearColorInt32[1]=e.g*255,n._TempClearColorInt32[2]=e.b*255,n._TempClearColorInt32[3]=e.a*255,this._gl.clearBufferiv(this._gl.COLOR,0,n._TempClearColorInt32),o=!1)}}o&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),a|=this._gl.COLOR_BUFFER_BIT)}r&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),a|=this._gl.DEPTH_BUFFER_BIT),i&&(this._gl.clearStencil(0),a|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(a)}_viewport(e,t,r,i){(e!==this._viewportCached.x||t!==this._viewportCached.y||r!==this._viewportCached.z||i!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=r,this._viewportCached.w=i,this._gl.viewport(e,t,r,i))}endFrame(){super.endFrame(),this._badOS&&this.flushFramebuffer()}get performanceMonitor(){throw new Error("Not Supported by ThinEngine")}bindFramebuffer(e,t=0,r,i,s,a=0,o=0){let h=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(h._MSAAFramebuffer?h._MSAAFramebuffer:h._framebuffer);let l=this._gl;e.isMulti||(e.is2DArray||e.is3D?l.framebufferTextureLayer(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,e.texture._hardwareTexture?.underlyingResource,a,o):e.isCube?l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_CUBE_MAP_POSITIVE_X+t,e.texture._hardwareTexture?.underlyingResource,a):h._currentLOD!==a&&(l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,e.texture._hardwareTexture?.underlyingResource,a),h._currentLOD=a));let u=e._depthStencilTexture;if(u){e.is3D&&(e.texture.width!==u.width||e.texture.height!==u.height||e.texture.depth!==u.depth)&&C.Warn("Depth/Stencil attachment for 3D target must have same dimensions as color attachment");let c=e._depthStencilTextureWithStencil?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT;e.is2DArray||e.is3D?l.framebufferTextureLayer(l.FRAMEBUFFER,c,u._hardwareTexture?.underlyingResource,a,o):e.isCube?l.framebufferTexture2D(l.FRAMEBUFFER,c,l.TEXTURE_CUBE_MAP_POSITIVE_X+t,u._hardwareTexture?.underlyingResource,a):l.framebufferTexture2D(l.FRAMEBUFFER,c,l.TEXTURE_2D,u._hardwareTexture?.underlyingResource,a)}this._cachedViewport&&!s?this.setViewport(this._cachedViewport,r,i):(r||(r=e.width,a&&(r=r/Math.pow(2,a))),i||(i=e.height,a&&(i=i/Math.pow(2,a))),this._viewport(0,0,r,i)),this.wipeCaches()}setState(e,t=0,r,i=!1,s,a,o=0){(this._depthCullingState.cull!==e||r)&&(this._depthCullingState.cull=e);let h=this.cullBackFaces??s??!0?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==h||r)&&(this._depthCullingState.cullFace=h),this.setZOffset(t),this.setZOffsetUnits(o);let l=i?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==l||r)&&(this._depthCullingState.frontFace=l),this._stencilStateComposer.stencilMaterial=a}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){let t=this._getTextureTarget(e);this._bindTextureDirectly(t,e,!0),this._gl.generateMipmap(t),this._bindTextureDirectly(t,null)}unBindFramebuffer(e,t=!1,r){let i=e;this._currentRenderTarget=null;let s=this._gl;if(i._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,t,r);return}s.bindFramebuffer(s.READ_FRAMEBUFFER,i._MSAAFramebuffer),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,i._framebuffer),s.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s.COLOR_BUFFER_BIT,s.NEAREST)}e.texture?.generateMipMaps&&!t&&!e.isCube&&this.generateMipmaps(e.texture),r&&(i._MSAAFramebuffer&&this._bindUnboundFramebuffer(i._framebuffer),r()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e,t,r){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){let r=this._gl.createBuffer();if(!r)throw new Error("Unable to create vertex buffer");let i=new Se(r);return this.bindArrayBuffer(i),typeof e!="number"?e instanceof Array?(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t),i.capacity=e.length*4):(this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),i.capacity=e.byteLength):(this._gl.bufferData(this._gl.ARRAY_BUFFER,new Uint8Array(e),t),i.capacity=e),this._resetVertexBufferBinding(),i.references=1,i}createDynamicVertexBuffer(e,t){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t,r){let i=this._gl.createBuffer(),s=new Se(i);if(!i)throw new Error("Unable to create index buffer");this.bindIndexBuffer(s);let a=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,a,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),s.references=1,s.is32Bits=a.BYTES_PER_ELEMENT===4,s}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let r=0;r<e.length;r++)if(e[r]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,r){let i=e.program,s=this._gl.getUniformBlockIndex(i,t);this._gl.uniformBlockBinding(i,s,r)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,r,i,s,a,o){let h=this._currentBufferPointers[t];if(!h)return;let l=!1;h.active?(h.buffer!==e&&(h.buffer=e,l=!0),h.size!==r&&(h.size=r,l=!0),h.type!==i&&(h.type=i,l=!0),h.normalized!==s&&(h.normalized=s,l=!0),h.stride!==a&&(h.stride=a,l=!0),h.offset!==o&&(h.offset=o,l=!0)):(l=!0,h.active=!0,h.index=t,h.size=r,h.type=i,h.normalized=s,h.stride=a,h.offset=o,h.buffer=e),(l||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),i===this._gl.UNSIGNED_INT||i===this._gl.INT?this._gl.vertexAttribIPointer(t,r,i,a,o):this._gl.vertexAttribPointer(t,r,i,s,a,o))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,r){let i=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let s=0;s<i.length;s++){let a=t.getAttributeLocation(s);if(a>=0){let o=i[s],h=null;if(r&&(h=r[o]),h||(h=e[o]),!h)continue;this._gl.enableVertexAttribArray(a),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[a]=!0);let l=h.getBuffer();l&&(this._vertexAttribPointer(l,a,h.getSize(),h.type,h.normalized,h.byteStride,h.byteOffset),h.getIsInstanced()&&(this._gl.vertexAttribDivisor(a,h.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(l))))}}}recordVertexArrayObject(e,t,r,i){let s=this._gl.createVertexArray();if(!s)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(s),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,r,i),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),s}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,r,i,s){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==s){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=s;let a=s.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let o=0;for(let h=0;h<a;h++)if(h<r.length){let l=s.getAttributeLocation(h);l>=0&&(this._gl.enableVertexAttribArray(l),this._vertexAttribArraysEnabled[l]=!0,this._vertexAttribPointer(e,l,r[h],this._gl.FLOAT,!1,i,o)),o+=r[h]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,r,i){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r,this._bindVertexBuffersAttributes(e,r,i)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,r=this._currentInstanceLocations.length;t<r;t++){let i=this._currentInstanceBuffers[t];e!=i&&i.references&&(e=i,this.bindArrayBuffer(i));let s=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(s,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,r){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),r[0].index!==void 0)this.bindInstancesBuffer(e,r,!0);else for(let i=0;i<4;i++){let s=r[i];this._vertexAttribArraysEnabled[s]||(this._gl.enableVertexAttribArray(s),this._vertexAttribArraysEnabled[s]=!0),this._vertexAttribPointer(e,s,4,this._gl.FLOAT,!1,64,i*16),this._gl.vertexAttribDivisor(s,1),this._currentInstanceLocations.push(s),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,r=!0){this.bindArrayBuffer(e);let i=0;if(r)for(let s=0;s<t.length;s++){let a=t[s];i+=a.attributeSize*4}for(let s=0;s<t.length;s++){let a=t[s];a.index===void 0&&(a.index=this._currentEffect.getAttributeLocationByName(a.attributeName)),!(a.index<0)&&(this._vertexAttribArraysEnabled[a.index]||(this._gl.enableVertexAttribArray(a.index),this._vertexAttribArraysEnabled[a.index]=!0),this._vertexAttribPointer(e,a.index,a.attributeSize,a.attributeType||this._gl.FLOAT,a.normalized||!1,i,a.offset),this._gl.vertexAttribDivisor(a.index,a.divisor===void 0?1:a.divisor),this._currentInstanceLocations.push(a.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;let t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,r;for(;(r=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(r,1),this._currentInstanceBuffers.splice(r,1),t=!0,r=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,r,i){this.drawElementsType(e?0:1,t,r,i)}drawPointClouds(e,t,r){this.drawArraysType(2,e,t,r)}drawUnIndexed(e,t,r,i){this.drawArraysType(e?0:1,t,r,i)}drawElementsType(e,t,r,i){this.applyStates(),this._reportDrawCall();let s=this._drawMode(e),a=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;i?this._gl.drawElementsInstanced(s,r,a,t*o,i):this._gl.drawElements(s,r,a,t*o)}drawArraysType(e,t,r,i){this.applyStates(),this._reportDrawCall();let s=this._drawMode(e);i?this._gl.drawArraysInstanced(s,t,r,i):this._gl.drawArrays(s,t,r)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];let t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){let t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,bt(t),this._gl.deleteProgram(t.program))}_getGlobalDefines(e){return ot(e,this.isNDCHalfZRange,this.useReverseDepthBuffer,this.useExactSrgbConversions)}createEffect(e,t,r,i,s,a,o,h,l,u=$.GLSL){let c=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,f=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,_=this._getGlobalDefines(),d=s??t.defines??"";_&&(d+=_);let m=c+"+"+f+"@"+d;if(this._compiledEffects[m]){let R=this._compiledEffects[m];return o&&R.isReady()&&o(R),R}this._gl&&ie(this._gl);let T=new he(e,t,r,i,this,s,a,o,h,l,m,t.shaderLanguage??u);return this._compiledEffects[m]=T,T}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,r,i,s=null){let a=ie(this._gl);return a._contextWasLost=this._contextWasLost,a.validateShaderPrograms=this.validateShaderPrograms,kt(e,t,r,i||this._gl,s)}createShaderProgram(e,t,r,i,s,a=null){let o=ie(this._gl);return o._contextWasLost=this._contextWasLost,o.validateShaderPrograms=this.validateShaderPrograms,Vt(e,t,r,i,s||this._gl,a)}inlineShaderCode(e){return e}createPipelineContext(e){if(this._gl){let r=ie(this._gl);r.parallelShaderCompile=this._caps.parallelShaderCompile}let t=xr(this._gl,e);return t.engine=this,t}createMaterialContext(){}createDrawContext(){}_finalizePipelineContext(e){return Kt(e,this._gl,this.validateShaderPrograms)}_preparePipelineContext(e,t,r,i,s,a,o,h,l,u){let c=ie(this._gl);return c._contextWasLost=this._contextWasLost,c.validateShaderPrograms=this.validateShaderPrograms,c._createShaderProgramInjection=this._createShaderProgram.bind(this),c.createRawShaderProgramInjection=this.createRawShaderProgram.bind(this),c.createShaderProgramInjection=this.createShaderProgram.bind(this),c.loadFileInjection=this._loadFile.bind(this),yr(e,t,r,i,s,a,o,h,l,u)}_createShaderProgram(e,t,r,i,s=null){return ht(e,t,r,i,s)}_isRenderingStateCompiled(e){let t=e;return this._isDisposed||t._isDisposed?!1:this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(t),!0):!1}_executeWhenRenderingStateIsCompiled(e,t){Rr(e,t)}getUniforms(e,t){let r=new Array,i=e;for(let s=0;s<t.length;s++)r.push(this._gl.getUniformLocation(i.program,t[s]));return r}getAttributes(e,t){let r=[],i=e;for(let s=0;s<t.length;s++)try{r.push(this._gl.getAttribLocation(i.program,t[s]))}catch{r.push(-1)}return r}enableEffect(e){e=e!==null&&br(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,r){return e?(this._gl.uniform2i(e,t,r),!0):!1}setInt3(e,t,r,i){return e?(this._gl.uniform3i(e,t,r,i),!0):!1}setInt4(e,t,r,i,s){return e?(this._gl.uniform4i(e,t,r,i,s),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,r){return e?(this._gl.uniform2ui(e,t,r),!0):!1}setUInt3(e,t,r,i){return e?(this._gl.uniform3ui(e,t,r,i),!0):!1}setUInt4(e,t,r,i,s){return e?(this._gl.uniform4ui(e,t,r,i,s),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,r){return e?(this._gl.uniform2f(e,t,r),!0):!1}setFloat3(e,t,r,i){return e?(this._gl.uniform3f(e,t,r,i),!0):!1}setFloat4(e,t,r,i,s){return e?(this._gl.uniform4f(e,t,r,i,s),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;let e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){let r=this._gl,i=r.NEAREST,s=r.NEAREST;switch(e){case 11:i=r.LINEAR,t?s=r.LINEAR_MIPMAP_NEAREST:s=r.LINEAR;break;case 3:i=r.LINEAR,t?s=r.LINEAR_MIPMAP_LINEAR:s=r.LINEAR;break;case 8:i=r.NEAREST,t?s=r.NEAREST_MIPMAP_LINEAR:s=r.NEAREST;break;case 4:i=r.NEAREST,t?s=r.NEAREST_MIPMAP_NEAREST:s=r.NEAREST;break;case 5:i=r.NEAREST,t?s=r.LINEAR_MIPMAP_NEAREST:s=r.LINEAR;break;case 6:i=r.NEAREST,t?s=r.LINEAR_MIPMAP_LINEAR:s=r.LINEAR;break;case 7:i=r.NEAREST,s=r.LINEAR;break;case 1:i=r.NEAREST,s=r.NEAREST;break;case 9:i=r.LINEAR,t?s=r.NEAREST_MIPMAP_NEAREST:s=r.NEAREST;break;case 10:i=r.LINEAR,t?s=r.NEAREST_MIPMAP_LINEAR:s=r.NEAREST;break;case 2:i=r.LINEAR,s=r.LINEAR;break;case 12:i=r.LINEAR,s=r.NEAREST;break}return{min:s,mag:i}}_createTexture(){let e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new Ct(this._createTexture(),this._gl)}_createInternalTexture(e,t,r=!0,i=Y.Unknown){let s=!1,a=0,o=3,h=5,l=!1,u=1,c;t!==void 0&&typeof t=="object"?(s=!!t.generateMipMaps,a=t.type===void 0?0:t.type,o=t.samplingMode===void 0?3:t.samplingMode,h=t.format===void 0?5:t.format,l=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,u=t.samples??1,c=t.label):s=!!t,l&&(l=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU)),(a===1&&!this._caps.textureFloatLinearFiltering||a===2&&!this._caps.textureHalfFloatLinearFiltering)&&(o=1),a===1&&!this._caps.textureFloat&&(a=0,C.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));let f=this._gl,_=new We(this,i),d=e.width||e,m=e.height||e,T=e.depth||0,R=e.layers||0,g=this._getSamplingParameters(o,s),F=R!==0?f.TEXTURE_2D_ARRAY:T!==0?f.TEXTURE_3D:f.TEXTURE_2D,E=this._getRGBABufferInternalSizedFormat(a,h,l),x=this._getInternalFormat(h),y=this._getWebGLTextureType(a);return this._bindTextureDirectly(F,_),R!==0?(_.is2DArray=!0,f.texImage3D(F,0,E,d,m,R,0,x,y,null)):T!==0?(_.is3D=!0,f.texImage3D(F,0,E,d,m,T,0,x,y,null)):f.texImage2D(F,0,E,d,m,0,x,y,null),f.texParameteri(F,f.TEXTURE_MAG_FILTER,g.mag),f.texParameteri(F,f.TEXTURE_MIN_FILTER,g.min),f.texParameteri(F,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(F,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),s&&this._gl.generateMipmap(F),this._bindTextureDirectly(F,null),_._useSRGBBuffer=l,_.baseWidth=d,_.baseHeight=m,_.width=d,_.height=m,_.depth=R,_.isReady=!0,_.samples=u,_.generateMipMaps=s,_.samplingMode=o,_.type=a,_.format=h,_.label=c,this._internalTexturesCache.push(_),_}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||t)}createTexture(e,t,r,i,s=3,a=null,o=null,h=null,l=null,u=null,c=null,f,_,d,m){return this._createTextureBase(e,t,r,i,s,a,o,(...T)=>this._prepareWebGLTexture(...T,u),(T,R,g,F,E,x)=>{let y=this._gl,B=g.width===T&&g.height===R;E._creationFlags=d??0;let w=this._getTexImageParametersForCreateTexture(E.format,E._useSRGBBuffer);if(B)return y.texImage2D(y.TEXTURE_2D,0,w.internalFormat,w.format,w.type,g),!1;let j=this._caps.maxTextureSize;if(g.width>j||g.height>j||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=T,this._workingCanvas.height=R,this._workingContext.drawImage(g,0,0,g.width,g.height,0,0,T,R),y.texImage2D(y.TEXTURE_2D,0,w.internalFormat,w.format,w.type,this._workingCanvas),E.width=T,E.height=R),!1;{let X=new We(this,Y.Temp);this._bindTextureDirectly(y.TEXTURE_2D,X,!0),y.texImage2D(y.TEXTURE_2D,0,w.internalFormat,w.format,w.type,g),this._rescaleTexture(X,E,i,w.format,()=>{this._releaseTexture(X),this._bindTextureDirectly(y.TEXTURE_2D,E,!0),x()})}return!0},h,l,u,c,f,_,m)}_getTexImageParametersForCreateTexture(e,t){let r,i;return this.webGLVersion===1?(r=this._getInternalFormat(e,t),i=r):(r=this._getInternalFormat(e,!1),i=this._getRGBABufferInternalSizedFormat(0,e,t)),{internalFormat:i,format:r,type:this._gl.UNSIGNED_BYTE}}_rescaleTexture(e,t,r,i,s){}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,r=!1){let i=this._getTextureTarget(t),s=this._getSamplingParameters(e,t.useMipMaps||r);this._setTextureParameterInteger(i,this._gl.TEXTURE_MAG_FILTER,s.mag,t),this._setTextureParameterInteger(i,this._gl.TEXTURE_MIN_FILTER,s.min),r&&(t.generateMipMaps=!0,this._gl.generateMipmap(i)),this._bindTextureDirectly(i,null),t.samplingMode=e}updateTextureDimensions(e,t,r,i=1){}updateTextureWrappingMode(e,t,r=null,i=null){let s=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),r!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(r),e),e._cachedWrapV=r),(e.is2DArray||e.is3D)&&i!==null&&(this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(i),e),e._cachedWrapR=i),this._bindTextureDirectly(s,null)}_uploadCompressedDataToTextureDirectly(e,t,r,i,s,a=0,o=0){let h=this._gl,l=h.TEXTURE_2D;if(e.isCube&&(l=h.TEXTURE_CUBE_MAP_POSITIVE_X+a),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=h.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=h.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=h.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=h.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=h.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=h.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=h.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(l,o,t,r,i,0,s)}_uploadDataToTextureDirectly(e,t,r=0,i=0,s,a=!1){let o=this._gl,h=this._getWebGLTextureType(e.type),l=this._getInternalFormat(e.format),u=s===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(s,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let c=o.TEXTURE_2D;e.isCube&&(c=o.TEXTURE_CUBE_MAP_POSITIVE_X+r);let f=Math.round(Math.log(e.width)*Math.LOG2E),_=Math.round(Math.log(e.height)*Math.LOG2E),d=a?e.width:Math.pow(2,Math.max(f-i,0)),m=a?e.height:Math.pow(2,Math.max(_-i,0));o.texImage2D(c,i,u,d,m,0,l,h,t)}updateTextureData(e,t,r,i,s,a,o=0,h=0,l=!1){let u=this._gl,c=this._getWebGLTextureType(e.type),f=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let _=u.TEXTURE_2D,d=u.TEXTURE_2D;e.isCube&&(d=u.TEXTURE_CUBE_MAP_POSITIVE_X+o,_=u.TEXTURE_CUBE_MAP),this._bindTextureDirectly(_,e,!0),u.texSubImage2D(d,h,r,i,s,a,f,c,t),l&&this._gl.generateMipmap(d),this._bindTextureDirectly(_,null)}_uploadArrayBufferViewToTexture(e,t,r=0,i=0){let s=this._gl,a=e.isCube?s.TEXTURE_CUBE_MAP:s.TEXTURE_2D;this._bindTextureDirectly(a,e,!0),this._uploadDataToTextureDirectly(e,t,r,i),this._bindTextureDirectly(a,null,!0)}_prepareWebGLTextureContinuation(e,t,r,i,s){let a=this._gl;if(!a)return;let o=this._getSamplingParameters(s,!r);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,o.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,o.min),!r&&!i&&a.generateMipmap(a.TEXTURE_2D),this._bindTextureDirectly(a.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,r,i,s,a,o,h,l,u){let c=this.getCaps().maxTextureSize,f=Math.min(c,this.needPOTTextures?_t(i.width,c):i.width),_=Math.min(c,this.needPOTTextures?_t(i.height,c):i.height),d=this._gl;if(d){if(!e._hardwareTexture){r&&r.removePendingData(e);return}this._bindTextureDirectly(d.TEXTURE_2D,e,!0),this._unpackFlipY(s===void 0?!0:!!s),e.baseWidth=i.width,e.baseHeight=i.height,e.width=f,e.height=_,e.isReady=!0,e.type=e.type!==-1?e.type:0,e.format=e.format!==-1?e.format:u??(t===".jpg"&&!e._useSRGBBuffer?4:5),!h(f,_,i,t,e,()=>{this._prepareWebGLTextureContinuation(e,r,a,o,l)})&&this._prepareWebGLTextureContinuation(e,r,a,o,l)}}_setupFramebufferDepthAttachments(e,t,r,i,s=1){let a=this._gl;if(e&&t)return this._createRenderBuffer(r,i,s,a.DEPTH_STENCIL,a.DEPTH24_STENCIL8,a.DEPTH_STENCIL_ATTACHMENT);if(t){let o=a.DEPTH_COMPONENT16;return this._webGLVersion>1&&(o=a.DEPTH_COMPONENT32F),this._createRenderBuffer(r,i,s,o,o,a.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(r,i,s,a.STENCIL_INDEX8,a.STENCIL_INDEX8,a.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,r,i,s,a,o=!0){let l=this._gl.createRenderbuffer();return this._updateRenderBuffer(l,e,t,r,i,s,a,o)}_updateRenderBuffer(e,t,r,i,s,a,o,h=!0){let l=this._gl;return l.bindRenderbuffer(l.RENDERBUFFER,e),i>1&&l.renderbufferStorageMultisample?l.renderbufferStorageMultisample(l.RENDERBUFFER,i,a,t,r):l.renderbufferStorage(l.RENDERBUFFER,s,t,r),l.framebufferRenderbuffer(l.FRAMEBUFFER,o,l.RENDERBUFFER,e),h&&l.bindRenderbuffer(l.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture),this.unbindAllTextures();let t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_deleteTexture(e){e?.release()}_setProgram(e){this._currentProgram!==e&&(Tr(e,this._gl),this._currentProgram=e)}bindSamplers(e){let t=e.getPipelineContext();this._setProgram(t.program);let r=e.getSamplers();for(let i=0;i<r.length;i++){let s=e.getUniform(r[i]);s&&(this._boundUniforms[i]=s)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,r=!1,i=!1){let s=!1,a=t&&t._associatedChannel>-1;if(r&&a&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||i){if(this._activateCurrentTexture(),t&&t.isMultiview)throw C.Error(["_bindTextureDirectly called with a multiview texture!",e,t]),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,t?._hardwareTexture?.underlyingResource??null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else r&&(s=!0,this._activateCurrentTexture());return a&&!r&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),s}_bindTexture(e,t,r){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;let i=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(i,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,r,i){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,r))}_bindSamplerUniformToChannel(e,t){let r=this._boundUniforms[e];!r||r._currentState===t||(this._gl.uniform1i(r,t),r._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,r=!1,i=!1,s=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video){this._activeChannel=e;let l=t.getInternalTexture();l&&(l._associatedChannel=e),t.update()}else if(t.delayLoadState===4)return t.delayLoad(),!1;let a;i?a=t.depthStencilTexture:t.isReady()?a=t.getInternalTexture():t.isCube?a=this.emptyCubeTexture:t.is3D?a=this.emptyTexture3D:t.is2DArray?a=this.emptyTexture2DArray:a=this.emptyTexture,!r&&a&&(a._associatedChannel=e);let o=!0;this._boundTexturesCache[e]===a&&(r||this._bindSamplerUniformToChannel(a._associatedChannel,e),o=!1),this._activeChannel=e;let h=this._getTextureTarget(a);if(o&&this._bindTextureDirectly(h,a,r),a&&!a.isMultiview){if(a.isCube&&a._cachedCoordinatesMode!==t.coordinatesMode){a._cachedCoordinatesMode=t.coordinatesMode;let l=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=l,t.wrapV=l}a._cachedWrapU!==t.wrapU&&(a._cachedWrapU=t.wrapU,this._setTextureParameterInteger(h,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),a)),a._cachedWrapV!==t.wrapV&&(a._cachedWrapV=t.wrapV,this._setTextureParameterInteger(h,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),a)),a.is3D&&a._cachedWrapR!==t.wrapR&&(a._cachedWrapR=t.wrapR,this._setTextureParameterInteger(h,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),a)),this._setAnisotropicLevel(h,a,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,r,i){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==r.length)&&(this._textureUnits=new Int32Array(r.length));for(let s=0;s<r.length;s++){let a=r[s].getInternalTexture();a?(this._textureUnits[s]=e+s,a._associatedChannel=e+s):this._textureUnits[s]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let s=0;s<r.length;s++)this._setTexture(this._textureUnits[s],r[s],!0)}}_setAnisotropicLevel(e,t,r){let i=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(r=1),i&&t._cachedAnisotropicFilteringLevel!==r&&(this._setTextureParameterFloat(e,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=r)}_setTextureParameterFloat(e,t,r,i){this._bindTextureDirectly(e,i,!0,!0),this._gl.texParameterf(e,t,r)}_setTextureParameterInteger(e,t,r,i){i&&this._bindTextureDirectly(e,i,!0,!0),this._gl.texParameteri(e,t,r)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){for(let e in this._compiledEffects){let t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}dispose(){k()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored))),super.dispose(),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.unbindAllAttributes(),this._boundUniforms={},this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._currentProgram=null,this._creationOptions.loseContextOnDispose&&this._gl.getExtension("WEBGL_lose_context")?.loseContext(),gr(this._gl)}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){let t=this._gl;for(;t.getError()!==t.NO_ERROR;);let r=!0,i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);let s=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,s),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i,0);let a=t.checkFramebufferStatus(t.FRAMEBUFFER);if(r=r&&a===t.FRAMEBUFFER_COMPLETE,r=r&&t.getError()===t.NO_ERROR,r&&(t.clear(t.COLOR_BUFFER_BIT),r=r&&t.getError()===t.NO_ERROR),r){t.bindFramebuffer(t.FRAMEBUFFER,null);let o=t.RGBA,h=t.UNSIGNED_BYTE,l=new Uint8Array(4);t.readPixels(0,0,1,1,o,h,l),r=r&&t.getError()===t.NO_ERROR}for(t.deleteTexture(i),t.deleteFramebuffer(s),t.bindFramebuffer(t.FRAMEBUFFER,null);!r&&t.getError()!==t.NO_ERROR;);return r}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let r=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:r=this._gl.ALPHA;break;case 1:r=this._gl.LUMINANCE;break;case 2:r=this._gl.LUMINANCE_ALPHA;break;case 6:r=this._gl.RED;break;case 7:r=this._gl.RG;break;case 4:r=t?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:r=t?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:r=this._gl.RED_INTEGER;break;case 9:r=this._gl.RG_INTEGER;break;case 10:r=this._gl.RGB_INTEGER;break;case 11:r=this._gl.RGBA_INTEGER;break}return r}_getRGBABufferInternalSizedFormat(e,t,r=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return r?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return r?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return r?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return r?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}readPixels(e,t,r,i,s=!0,a=!0){let o=s?4:3,h=s?this._gl.RGBA:this._gl.RGB,l=new Uint8Array(i*r*o);return a&&this.flushFramebuffer(),this._gl.readPixels(e,t,r,i,h,this._gl.UNSIGNED_BYTE,l),Promise.resolve(l)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{let e=Ie._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{let e=Ie._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}};U._TempClearColorUint32=new Uint32Array(4);U._TempClearColorInt32=new Int32Array(4);U.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/12\\d\\..+?Mobile",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];U.CollisionsEpsilon=.001;U._ConcatenateShader=nt;U._IsSupported=null;U._HasMajorPerformanceCaveat=null;U.CeilingPOT=ut;U.FloorPOT=ft;U.NearestPOT=Ht;U.GetExponentOfTwo=_t;U.QueueNewFrame=Qt;var V=function(n){return n[n.Texture=0]="Texture",n[n.StorageTexture=1]="StorageTexture",n[n.UniformBuffer=2]="UniformBuffer",n[n.StorageBuffer=3]="StorageBuffer",n[n.TextureWithoutSampler=4]="TextureWithoutSampler",n[n.Sampler=5]="Sampler",n[n.ExternalTexture=6]="ExternalTexture",n[n.DataBuffer=7]="DataBuffer",n}(V||{});U.prototype.createComputeEffect=function(n,e){throw new Error("createComputeEffect: This engine does not support compute shaders!")};U.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")};U.prototype.createComputeContext=function(){};U.prototype.computeDispatch=function(n,e,t,r,i,s,a){throw new Error("computeDispatch: This engine does not support compute shaders!")};U.prototype.computeDispatchIndirect=function(n,e,t,r,i,s){throw new Error("computeDispatchIndirect: This engine does not support compute shaders!")};U.prototype.areAllComputeEffectsReady=function(){return!0};U.prototype.releaseComputeEffects=function(){};U.prototype._prepareComputePipelineContext=function(n,e,t,r,i){};U.prototype._rebuildComputeEffects=function(){};Ie.prototype._executeWhenComputeStateIsCompiled=function(n,e){e(null)};U.prototype._releaseComputeEffect=function(n){};U.prototype._deleteComputePipelineContext=function(n){};function wt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}function Ri(){return typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}var _e=class n{constructor(){this._xhr=Ri(),this._requestURL=""}static get IsCustomRequestAvailable(){return Object.keys(n.CustomRequestHeaders).length>0||n.CustomRequestModifiers.length>0}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(let e in n.CustomRequestHeaders){let t=n.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return n.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,r){this._xhr.addEventListener(e,t,r)}removeEventListener(e,t,r){this._xhr.removeEventListener(e,t,r)}abort(){this._xhr.abort()}send(e){n.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(let r of n.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;r(this._xhr,t)}t=t.replace("file:http:","http:"),t=t.replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}};_e.CustomRequestHeaders={};_e.CustomRequestModifiers=new Array;_e.SkipRequestModificationForBabylonCDN=!0;var je=(()=>{class n{}return n.FilesToLoad={},n})();var St=class{static ExponentialBackoff(e=3,t=500){return(r,i,s)=>i.status!==0||s>=e||r.indexOf("file:")!==-1?-1:Math.pow(2,s)*t}};var Ae=class extends Error{};Ae._setPrototypeOf=Object.setPrototypeOf||((n,e)=>(n.__proto__=e,n));var It={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002},ke=class n extends Ae{constructor(e,t,r){super(e),this.errorCode=t,this.innerError=r,this.name="RuntimeError",Ae._setPrototypeOf(this,n.prototype)}};var _a=n=>{if(typeof TextDecoder<"u")return new TextDecoder().decode(n);let e="";for(let t=0;t<n.byteLength;t++)e+=String.fromCharCode(n[t]);return e},Bt=n=>{let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t="",r,i,s,a,o,h,l,u=0,c=ArrayBuffer.isView(n)?new Uint8Array(n.buffer,n.byteOffset,n.byteLength):new Uint8Array(n);for(;u<c.length;)r=c[u++],i=u<c.length?c[u++]:Number.NaN,s=u<c.length?c[u++]:Number.NaN,a=r>>2,o=(r&3)<<4|i>>4,h=(i&15)<<2|s>>6,l=s&63,isNaN(i)?h=l=64:isNaN(s)&&(l=64),t+=e.charAt(a)+e.charAt(o)+e.charAt(h)+e.charAt(l);return t},Jt=n=>atob(n),vr=n=>{let e=Jt(n),t=e.length,r=new Uint8Array(new ArrayBuffer(t));for(let i=0;i<t;i++)r[i]=e.charCodeAt(i);return r.buffer};var Fe=class{static SetImmediate(e){k()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}};var Or=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i),Pt=class n extends ke{constructor(e,t){super(e,It.LoadFileError),this.name="LoadFileError",Ae._setPrototypeOf(this,n.prototype),t instanceof _e?this.request=t:this.file=t}},Mt=class n extends ke{constructor(e,t){super(e,It.RequestFileError),this.request=t,this.name="RequestFileError",Ae._setPrototypeOf(this,n.prototype)}},er=class n extends ke{constructor(e,t){super(e,It.ReadFileError),this.file=t,this.name="ReadFileError",Ae._setPrototypeOf(this,n.prototype)}},bi=n=>(n=n.replace(/#/gm,"%23"),n),z={DefaultRetryStrategy:St.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:n=>n,ScriptBaseUrl:"",ScriptPreprocessUrl:n=>n,CleanUrl:bi},Ut=(n,e)=>{if(!(n&&n.indexOf("data:")===0)&&z.CorsBehavior)if(typeof z.CorsBehavior=="string"||z.CorsBehavior instanceof String)e.crossOrigin=z.CorsBehavior;else{let t=z.CorsBehavior(n);t&&(e.crossOrigin=t)}},Dt=(n,e,t,r,i="",s)=>{let a=G.LastCreatedEngine;if(typeof HTMLImageElement>"u"&&!a?._features.forceBitmapOverHTMLImageElement)return t("LoadImage is only supported in web or BabylonNative environments."),null;let o,h=!1;n instanceof ArrayBuffer||ArrayBuffer.isView(n)?typeof Blob<"u"&&typeof URL<"u"?(o=URL.createObjectURL(new Blob([n],{type:i})),h=!0):o=`data:${i};base64,`+Bt(n):n instanceof Blob?(o=URL.createObjectURL(n),h=!0):(o=z.CleanUrl(n),o=z.PreprocessUrl(n));let l=x=>{if(t){let y=o||n.toString();t(`Error while trying to load image: ${y.indexOf("http")===0||y.length<=128?y:y.slice(0,128)+"..."}`,x)}};if(a?._features.forceBitmapOverHTMLImageElement)return Be(o,x=>{a.createImageBitmap(new Blob([x],{type:i}),ve({premultiplyAlpha:"none"},s)).then(y=>{e(y),h&&URL.revokeObjectURL(o)}).catch(y=>{t&&t("Error while trying to load image: "+n,y)})},void 0,r||void 0,!0,(x,y)=>{l(y)}),null;let u=new Image;Ut(o,u);let c=[],f=()=>{c.forEach(x=>{x.target.addEventListener(x.name,x.handler)})},_=()=>{c.forEach(x=>{x.target.removeEventListener(x.name,x.handler)}),c.length=0},d=()=>{_(),e(u),h&&u.src&&URL.revokeObjectURL(u.src)},m=x=>{_(),l(x),h&&u.src&&URL.revokeObjectURL(u.src)},T=x=>{if(x.blockedURI!==u.src)return;_();let y=new Error(`CSP violation of policy ${x.effectiveDirective} ${x.blockedURI}. Current policy is ${x.originalPolicy}`);G.UseFallbackTexture=!1,l(y),h&&u.src&&URL.revokeObjectURL(u.src),u.src=""};c.push({target:u,name:"load",handler:d}),c.push({target:u,name:"error",handler:m}),c.push({target:document,name:"securitypolicyviolation",handler:T}),f();let R=o.substring(0,5)==="blob:",g=o.substring(0,5)==="data:",F=()=>{R||g||!_e.IsCustomRequestAvailable?u.src=o:Be(o,(x,y,B)=>{let w=!i&&B?B:i,j=new Blob([x],{type:w}),X=URL.createObjectURL(j);h=!0,u.src=X},void 0,r||void 0,!0,(x,y)=>{l(y)})},E=()=>{r&&r.loadImage(o,u)};if(!R&&!g&&r&&r.enableTexturesOffline)r.open(E,F);else{if(o.indexOf("file:")!==-1){let x=decodeURIComponent(o.substring(5).toLowerCase());if(je.FilesToLoad[x]&&typeof URL<"u"){try{let y;try{y=URL.createObjectURL(je.FilesToLoad[x])}catch{y=URL.createObjectURL(je.FilesToLoad[x])}u.src=y,h=!0}catch{u.src=""}return u}}F()}return u},qe=(n,e,t,r,i)=>{let s=new FileReader,a={onCompleteObservable:new L,abort:()=>s.abort()};return s.onloadend=()=>a.onCompleteObservable.notifyObservers(a),i&&(s.onerror=()=>{i(new er(`Unable to read ${n.name}`,n))}),s.onload=o=>{e(o.target.result)},t&&(s.onprogress=t),r?s.readAsArrayBuffer(n):s.readAsText(n),a},Be=(n,e,t,r,i,s,a)=>{if(n.name)return qe(n,e,t,i,s?u=>{s(void 0,u)}:void 0);let o=n;if(o.indexOf("file:")!==-1){let u=decodeURIComponent(o.substring(5).toLowerCase());u.indexOf("./")===0&&(u=u.substring(2));let c=je.FilesToLoad[u];if(c)return qe(c,e,t,i,s?f=>s(void 0,new Pt(f.message,f.file)):void 0)}let{match:h,type:l}=Ei(o);if(h){let u={onCompleteObservable:new L,abort:()=>()=>{}};try{let c=i?Lt(o):Gr(o);e(c,void 0,l)}catch(c){s?s(void 0,c):C.Error(c.message||"Failed to parse the Data URL")}return Fe.SetImmediate(()=>{u.onCompleteObservable.notifyObservers(u)}),u}return zr(o,(u,c)=>{e(u,c?.responseURL,c?.getResponseHeader("content-type"))},t,r,i,s?u=>{s(u.request,new Pt(u.message,u.request))}:void 0,a)},zr=(n,e,t,r,i,s,a)=>{n=z.CleanUrl(n),n=z.PreprocessUrl(n);let o=z.BaseUrl+n,h=!1,l={onCompleteObservable:new L,abort:()=>h=!0},u=()=>{let c=new _e,f=null,_,d=()=>{c&&(t&&c.removeEventListener("progress",t),_&&c.removeEventListener("readystatechange",_),c.removeEventListener("loadend",m))},m=()=>{d(),l.onCompleteObservable.notifyObservers(l),l.onCompleteObservable.clear(),t=void 0,_=null,m=null,s=void 0,a=void 0,e=void 0};l.abort=()=>{h=!0,m&&m(),c&&c.readyState!==(XMLHttpRequest.DONE||4)&&c.abort(),f!==null&&(clearTimeout(f),f=null),c=null};let T=g=>{let F=g.message||"Unknown error";s&&c?s(new Mt(F,c)):C.Error(F)},R=g=>{if(c){if(c.open("GET",o),a)try{a(c)}catch(F){T(F);return}i&&(c.responseType="arraybuffer"),t&&c.addEventListener("progress",t),m&&c.addEventListener("loadend",m),_=()=>{if(!(h||!c)&&c.readyState===(XMLHttpRequest.DONE||4)){if(_&&c.removeEventListener("readystatechange",_),c.status>=200&&c.status<300||c.status===0&&(!k()||Nr())){try{e&&e(i?c.response:c.responseText,c)}catch(x){T(x)}return}let F=z.DefaultRetryStrategy;if(F){let x=F(o,c,g);if(x!==-1){d(),c=new _e,f=setTimeout(()=>R(g+1),x);return}}let E=new Mt("Error status: "+c.status+" "+c.statusText+" - Unable to load "+o,c);s&&s(E)}},c.addEventListener("readystatechange",_),c.send()}};R(0)};if(r&&r.enableSceneOffline){let c=_=>{_&&_.status>400?s&&s(_):u()},f=()=>{r&&r.loadFile(z.BaseUrl+n,_=>{!h&&e&&e(_),l.onCompleteObservable.notifyObservers(l)},t?_=>{!h&&t&&t(_)}:void 0,c,i)};r.open(f,c)}else u();return l},Nr=()=>typeof location<"u"&&location.protocol==="file:",tr=n=>Or.test(n),Ei=n=>{let e=Or.exec(n);return e===null||e.length===0?{match:!1,type:""}:{match:!0,type:e[0].replace("data:","").replace("base64,","")}};function Lt(n){return vr(n.split(",")[1])}var Gr=n=>Jt(n.split(",")[1]),Ai=()=>{Ie._FileToolsLoadImage=Dt,ze.loadFile=Be,Zt.loadFile=Be};Ai();var Xe,Fi=(n,e,t,r,i,s,a,o,h,l)=>{Xe={DecodeBase64UrlToBinary:n,DecodeBase64UrlToString:e,DefaultRetryStrategy:t.DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:r,IsFileURL:i,LoadFile:s,LoadImage:a,ReadFile:o,RequestFile:h,SetCorsBehavior:l},Object.defineProperty(Xe,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(u){t.DefaultRetryStrategy=u}}),Object.defineProperty(Xe,"BaseUrl",{get:function(){return t.BaseUrl},set:function(u){t.BaseUrl=u}}),Object.defineProperty(Xe,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(u){t.PreprocessUrl=u}}),Object.defineProperty(Xe,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(u){t.CorsBehavior=u}})};Fi(Lt,Gr,z,tr,Nr,Be,Dt,qe,zr,Ut);var Ye=class n{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new n(this.width*e,this.height*t)}clone(){return new n(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new n(0,0)}add(e){return new n(this.width+e.width,this.height+e.height)}subtract(e){return new n(this.width-e.width,this.height-e.height)}scale(e){return new n(this.width*e,this.height*e)}static Lerp(e,t,r){let i=e.width+(t.width-e.width)*r,s=e.height+(t.height-e.height)*r;return new n(i,s)}};var vt=class n{get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){this._texture&&(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}static _IsRenderTargetWrapper(e){return e?.shareDepth!==void 0}constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=Ye.Zero(),this._cachedBaseSize=Ye.Zero(),this._initialSamplingMode=2,this._texture=n._IsRenderTargetWrapper(e)?e.texture:e,this._texture&&(this._engine=this._texture.getEngine())}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}};function Ci(n,e,t=!1,r){switch(n){case 3:{let s=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return r&&s.set(new Int8Array(r)),s}case 0:{let s=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return r&&s.set(new Uint8Array(r)),s}case 4:{let s=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return r&&s.set(new Int16Array(r)),s}case 5:case 8:case 9:case 10:case 2:{let s=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return r&&s.set(new Uint16Array(r)),s}case 6:{let s=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return r&&s.set(new Int32Array(r)),s}case 7:case 11:case 12:case 13:case 14:case 15:{let s=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return r&&s.set(new Uint32Array(r)),s}case 1:{let s=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return r&&s.set(new Float32Array(r)),s}}let i=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return r&&i.set(new Uint8Array(r)),i}U.prototype._readTexturePixelsSync=function(n,e,t,r=-1,i=0,s=null,a=!0,o=!1,h=0,l=0){let u=this._gl;if(!u)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){let f=u.createFramebuffer();if(!f)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=f}u.bindFramebuffer(u.FRAMEBUFFER,this._dummyFramebuffer),r>-1?u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+r,n._hardwareTexture?.underlyingResource,i):u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,n._hardwareTexture?.underlyingResource,i);let c=n.type!==void 0?this._getWebGLTextureType(n.type):u.UNSIGNED_BYTE;if(o)s||(s=Ci(n.type,4*e*t));else switch(c){case u.UNSIGNED_BYTE:s||(s=new Uint8Array(4*e*t)),c=u.UNSIGNED_BYTE;break;default:s||(s=new Float32Array(4*e*t)),c=u.FLOAT;break}return a&&this.flushFramebuffer(),u.readPixels(h,l,e,t,u.RGBA,c,s),u.bindFramebuffer(u.FRAMEBUFFER,this._currentFramebuffer),s};U.prototype._readTexturePixels=function(n,e,t,r=-1,i=0,s=null,a=!0,o=!1,h=0,l=0){return Promise.resolve(this._readTexturePixelsSync(n,e,t,r,i,s,a,o,h,l))};var O=class n extends vt{set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){this._texture&&(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){this._texture&&(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this.getScene()?.markAllMaterialsAsDirty(1,t=>t.hasTexture(this))}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){e!==this.isRGBD&&(this._texture&&(this._texture._isRGBD=e),this.getScene()?.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=wt()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=n.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=[],this.onDisposeObservable=new L,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?n._IsScene(e)?this._scene=e:this._engine=e:this._scene=G.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}getScene(){return this._scene}_getEngine(){return this._engine}getTextureMatrix(){return M.IdentityReadOnly}getReflectionTextureMatrix(){return M.IdentityReadOnly}getRefractionTextureMatrix(){return this.getReflectionTextureMatrix()}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,r,i,s,a){let o=this._getEngine();if(!o)return null;let h=o._getUseSRGBBuffer(!!s,t),l=o.getLoadedTexturesCache();for(let u=0;u<l.length;u++){let c=l[u];if((s===void 0||h===c._useSRGBBuffer)&&(i===void 0||i===c.invertY)&&c.url===e&&c.generateMipMaps===!t&&(!r||r===c.samplingMode)&&(a===void 0||a===c.isCube))return c.incrementReferences(),c}return null}_rebuild(e=!1){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){let e=this.getScene();e&&e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,r=null,i=!0,s=!1,a=0,o=0,h=Number.MAX_VALUE,l=Number.MAX_VALUE){if(!this._texture)return null;let u=this._getEngine();if(!u)return null;let c=this.getSize(),f=c.width,_=c.height;t!==0&&(f=f/Math.pow(2,t),_=_/Math.pow(2,t),f=Math.round(f),_=Math.round(_)),h=Math.min(f,h),l=Math.min(_,l);try{return this._texture.isCube?u._readTexturePixels(this._texture,h,l,e,t,r,i,s,a,o):u._readTexturePixels(this._texture,h,l,-1,t,r,i,s,a,o)}catch{return null}}_readPixelsSync(e=0,t=0,r=null,i=!0,s=!1){if(!this._texture)return null;let a=this.getSize(),o=a.width,h=a.height,l=this._getEngine();if(!l)return null;t!=0&&(o=o/Math.pow(2,t),h=h/Math.pow(2,t),o=Math.round(o),h=Math.round(h));try{return this._texture.isCube?l._readTexturePixelsSync(this._texture,o,h,e,t,r,i,s):l._readTexturePixelsSync(this._texture,o,h,-1,t,r,i,s)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);let e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){let t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(e=!1){if(!this.name&&!e)return null;let t=pe.Serialize(this);return pe.AppendSerializedAnimations(this,t),t}static WhenAllReady(e,t){let r=e.length;if(r===0){t();return}for(let i=0;i<e.length;i++){let s=e[i];if(s.isReady())--r===0&&t();else{let a=s.onLoadObservable;a?a.addOnce(()=>{--r===0&&t()}):--r===0&&t()}}}static _IsScene(e){return e.getClassName()==="Scene"}};O.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;S([I()],O.prototype,"uniqueId",void 0);S([I()],O.prototype,"name",void 0);S([I()],O.prototype,"metadata",void 0);S([I("hasAlpha")],O.prototype,"_hasAlpha",void 0);S([I("getAlphaFromRGB")],O.prototype,"_getAlphaFromRGB",void 0);S([I()],O.prototype,"level",void 0);S([I("coordinatesIndex")],O.prototype,"_coordinatesIndex",void 0);S([I()],O.prototype,"optimizeUVAllocation",void 0);S([I("coordinatesMode")],O.prototype,"_coordinatesMode",void 0);S([I()],O.prototype,"wrapU",null);S([I()],O.prototype,"wrapV",null);S([I()],O.prototype,"wrapR",void 0);S([I()],O.prototype,"anisotropicFilteringLevel",void 0);S([I()],O.prototype,"isCube",null);S([I()],O.prototype,"is3D",null);S([I()],O.prototype,"is2DArray",null);S([I()],O.prototype,"gammaSpace",null);S([I()],O.prototype,"invertZ",void 0);S([I()],O.prototype,"lodLevelInAlpha",void 0);S([I()],O.prototype,"lodGenerationOffset",null);S([I()],O.prototype,"lodGenerationScale",null);S([I()],O.prototype,"linearSpecularLOD",null);S([_r()],O.prototype,"irradianceTexture",null);S([I()],O.prototype,"isRenderTarget",void 0);var Ve=(()=>{class n{static Instantiate(t){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[t])return this.RegisteredExternalClasses[t];let r=Qe(t);if(r)return r;C.Warn(t+" not found, you may have missed an import.");let i=t.split("."),s=window||this;for(let a=0,o=i.length;a<o;a++)s=s[i[a]];return typeof s!="function"?null:s}}return n.RegisteredExternalClasses={},n})();var Ze=class n{constructor(e,t,r,i){this.normal=new b(e,t,r),this.d=i}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new n(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){let e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){let t=n._TmpMatrix;e.invertToRef(t);let r=t.m,i=this.normal.x,s=this.normal.y,a=this.normal.z,o=this.d,h=i*r[0]+s*r[1]+a*r[2]+o*r[3],l=i*r[4]+s*r[5]+a*r[6]+o*r[7],u=i*r[8]+s*r[9]+a*r[10]+o*r[11],c=i*r[12]+s*r[13]+a*r[14]+o*r[15];return new n(h,l,u,c)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,r){let i=t.x-e.x,s=t.y-e.y,a=t.z-e.z,o=r.x-e.x,h=r.y-e.y,l=r.z-e.z,u=s*l-a*h,c=a*o-i*l,f=i*h-s*o,_=Math.sqrt(u*u+c*c+f*f),d;return _!==0?d=1/_:d=0,this.normal.x=u*d,this.normal.y=c*d,this.normal.z=f*d,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return b.Dot(this.normal,e)<=t}signedDistanceTo(e){return b.Dot(e,this.normal)+this.d}static FromArray(e){return new n(e[0],e[1],e[2],e[3])}static FromPoints(e,t,r){let i=new n(0,0,0,0);return i.copyFromPoints(e,t,r),i}static FromPositionAndNormal(e,t){let r=new n(0,0,0,0);return this.FromPositionAndNormalToRef(e,t,r)}static FromPositionAndNormalToRef(e,t,r){return r.normal.copyFrom(t),r.normal.normalize(),r.d=-e.dot(r.normal),r}static SignedDistanceToPlaneFromPositionAndNormal(e,t,r){let i=-(t.x*e.x+t.y*e.y+t.z*e.z);return b.Dot(r,t)+i}};Ze._TmpMatrix=M.Identity();function kr(n,e,t=!1){let r=e.width,i=e.height;if(n instanceof Float32Array){let l=n.byteLength/n.BYTES_PER_ELEMENT,u=new Uint8Array(l);for(;--l>=0;){let c=n[l];c<0?c=0:c>1&&(c=1),u[l]=c*255}n=u}let s=document.createElement("canvas");s.width=r,s.height=i;let a=s.getContext("2d");if(!a)return null;let o=a.createImageData(r,i);if(o.data.set(n),a.putImageData(o,0,0),t){let l=document.createElement("canvas");l.width=r,l.height=i;let u=l.getContext("2d");return u?(u.translate(0,i),u.scale(1,-1),u.drawImage(s,0,0),l.toDataURL("image/png")):null}return s.toDataURL("image/png")}function Vr(n,e=0,t=0){let r=n.getInternalTexture();if(!r)return null;let i=n._readPixelsSync(e,t);return i?kr(i,n.getSize(),r.invertY):null}function Kr(n,e=0,t=0){return Oe(this,null,function*(){let r=n.getInternalTexture();if(!r)return null;let i=yield n.readPixels(e,t);return i?kr(i,n.getSize(),r.invertY):null})}var rr=(()=>{class n{}return n.UseOpenGLOrientationForUV=!1,n})();var A=class n extends O{static _CreateVideoTexture(e,t,r,i=!1,s=!1,a=n.TRILINEAR_SAMPLINGMODE,o={},h,l=5){throw v("VideoTexture")}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}constructor(e,t,r,i,s=n.TRILINEAR_SAMPLINGMODE,a=null,o=null,h=null,l=!1,u,c,f,_,d){super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedIdentity3x2=!0,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new L,this._isBlocking=!0,this.name=e||"",this.url=e;let m,T=!1,R=null,g=!0;typeof r=="object"&&r!==null?(m=r.noMipmap??!1,i=r.invertY??!rr.UseOpenGLOrientationForUV,s=r.samplingMode??n.TRILINEAR_SAMPLINGMODE,a=r.onLoad??null,o=r.onError??null,h=r.buffer??null,l=r.deleteBuffer??!1,u=r.format,c=r.mimeType,f=r.loaderOptions,_=r.creationFlags,T=r.useSRGBBuffer??!1,R=r.internalTexture??null,g=r.gammaSpace??g):m=!!r,this._gammaSpace=g,this._noMipmap=m,this._invertY=i===void 0?!rr.UseOpenGLOrientationForUV:i,this._initialSamplingMode=s,this._buffer=h,this._deleteBuffer=l,this._mimeType=c,this._loaderOptions=f,this._creationFlags=_,this._useSRGBBuffer=T,this._forcedExtension=d,u&&(this._format=u);let F=this.getScene(),E=this._getEngine();if(!E)return;E.onBeforeTextureInitObservable.notifyObservers(this);let x=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),a&&a(),!this.isBlocking&&F&&F.resetCachedMaterial()},y=(B,w)=>{this._loadingError=!0,this._errorObject={message:B,exception:w},o&&o(B,w),n.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url&&!R){this._delayedOnLoad=x,this._delayedOnError=y;return}if(this._texture=R??this._getFromCache(this.url,m,s,this._invertY,T,this.isCube),this._texture)if(this._texture.isReady)Fe.SetImmediate(()=>x());else{let B=this._texture.onLoadedObservable.add(x);this._texture.onErrorObservable.add(w=>{y(w.message,w.exception),this._texture?.onLoadedObservable.remove(B)})}else if(!F||!F.useDelayedTextureLoading){try{this._texture=E.createTexture(this.url,m,this._invertY,F,s,x,y,this._buffer,void 0,this._format,this._forcedExtension,c,f,_,T)}catch(B){throw y("error loading",B),B}l&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=x,this._delayedOnError=y}updateURL(e,t=null,r,i){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1,s=>s.hasTexture(this))),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=i,this.delayLoadState=4,r&&(this._delayedOnLoad=r),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;let e=this.getScene();e&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer,this.isCube),this._texture?this._delayedOnLoad&&(this._texture.isReady?Fe.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,r,i){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,r-=this.wRotationCenter,b.TransformCoordinatesFromFloatsToRef(e,t,r,this._rowGenerationMatrix,i),i.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,i.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,i.z+=this.wRotationCenter}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=M.Zero(),this._rowGenerationMatrix=new M,this._t0=b.Zero(),this._t1=b.Zero(),this._t2=b.Zero()),M.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(M.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,H.Matrix[0]),M.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,H.Matrix[1]),M.ScalingToRef(this._cachedUScale,this._cachedVScale,0,H.Matrix[2]),M.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,H.Matrix[3]),H.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(H.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(H.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(H.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),M.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));let t=this.getScene();if(!t)return this._cachedTextureMatrix;let r=this._cachedIdentity3x2;return this._cachedIdentity3x2=this._cachedTextureMatrix.isIdentityAs3x2(),this.optimizeUVAllocation&&r!==this._cachedIdentity3x2&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedTextureMatrix}getReflectionTextureMatrix(){let e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===n.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=M.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=M.Zero());let t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case n.PLANAR_MODE:{M.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case n.PROJECTION_MODE:{M.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);let r=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=r.updateFlag,r.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:M.IdentityToRef(this._cachedReflectionTextureMatrix);break}return t&&e.markAllMaterialsAsDirty(1,r=>r.hasTexture(this)),this._cachedReflectionTextureMatrix}clone(){let e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return pe.Clone(()=>new n(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){let e=this.name;n.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");let t=super.serialize(n._SerializeInternalTextureUniqueId);return t?((n.SerializeBuffers||n.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substr(0,5)==="data:"?(t.base64String=this._buffer,t.name=t.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?t.base64String="data:image/png;base64,"+Bt(this._buffer):(n.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(t.base64String=!this._engine||this._engine._features.supportSyncTextureRead?Vr(this):Kr(this))),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t._creationFlags=this._creationFlags,t._useSRGBBuffer=this._useSRGBBuffer,n._SerializeInternalTextureUniqueId&&(t.internalTextureUniqueId=this._texture?.uniqueId??void 0),t.noMipmap=this._noMipmap,this.name=e,t):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null,this._buffer=null}static Parse(e,t,r){if(e.customType){let l=Ve.Instantiate(e.customType).Parse(e,t,r);return e.samplingMode&&l.updateSamplingMode&&l._samplingMode&&l._samplingMode!==e.samplingMode&&l.updateSamplingMode(e.samplingMode),l}if(e.isCube&&!e.isRenderTarget)return n._CubeTextureParser(e,t,r);let i=e.internalTextureUniqueId!==void 0;if(!e.name&&!e.isRenderTarget&&!i)return null;let s;if(i){let h=t.getEngine().getLoadedTexturesCache();for(let l of h)if(l.uniqueId===e.internalTextureUniqueId){s=l;break}}let a=h=>{if(h&&h._texture&&(h._texture._cachedWrapU=null,h._texture._cachedWrapV=null,h._texture._cachedWrapR=null),e.samplingMode){let l=e.samplingMode;h&&h.samplingMode!==l&&h.updateSamplingMode(l)}if(h&&e.animations)for(let l=0;l<e.animations.length;l++){let u=e.animations[l],c=Qe("BABYLON.Animation");c&&h.animations.push(c.Parse(u))}i&&!s&&h?._texture?._setUniqueId(e.internalTextureUniqueId)};return pe.Parse(()=>{let h=!0;if(e.noMipmap&&(h=!1),e.mirrorPlane){let l=n._CreateMirror(e.name,e.renderTargetSize,t,h);return l._waitingRenderList=e.renderList,l.mirrorPlane=Ze.FromArray(e.mirrorPlane),a(l),l}else if(e.isRenderTarget){let l=null;if(e.isCube){if(t.reflectionProbes)for(let u=0;u<t.reflectionProbes.length;u++){let c=t.reflectionProbes[u];if(c.name===e.name)return c.cubeTexture}}else l=n._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,h,e._creationFlags??0),l._waitingRenderList=e.renderList;return a(l),l}else if(e.isVideo){let l=n._CreateVideoTexture(r+(e.url||e.name),r+(e.src||e.url),t,h,e.invertY,e.samplingMode,e.settings||{});return a(l),l}else{let l;if(e.base64String&&!s)l=n.CreateFromBase64String(e.base64String,e.base64String,t,!h,e.invertY,e.samplingMode,()=>{a(l)},e._creationFlags??0,e._useSRGBBuffer??!1),l.name=e.name;else{let u;e.name&&(e.name.indexOf("://")>0||e.name.startsWith("data:"))?u=e.name:u=r+e.name,e.url&&(e.url.startsWith("data:")||n.UseSerializedUrlIfAny)&&(u=e.url);let c={noMipmap:!h,invertY:e.invertY,samplingMode:e.samplingMode,onLoad:()=>{a(l)},internalTexture:s};l=new n(u,t,c)}return l}},e,t)}static CreateFromBase64String(e,t,r,i,s,a=n.TRILINEAR_SAMPLINGMODE,o=null,h=null,l=5,u,c){return new n("data:"+t,r,i,s,a,o,h,e,!1,l,void 0,void 0,u,c)}static LoadFromDataString(e,t,r,i=!1,s,a=!0,o=n.TRILINEAR_SAMPLINGMODE,h=null,l=null,u=5,c,f){return e.substr(0,5)!=="data:"&&(e="data:"+e),new n(e,r,s,a,o,h,l,t,i,u,void 0,void 0,c,f)}};A.SerializeBuffers=!0;A.ForceSerializeBuffers=!1;A.OnTextureLoadErrorObservable=new L;A._SerializeInternalTextureUniqueId=!1;A._CubeTextureParser=(n,e,t)=>{throw v("CubeTexture")};A._CreateMirror=(n,e,t,r)=>{throw v("MirrorTexture")};A._CreateRenderTargetTexture=(n,e,t,r,i)=>{throw v("RenderTargetTexture")};A.NEAREST_SAMPLINGMODE=1;A.NEAREST_NEAREST_MIPLINEAR=8;A.BILINEAR_SAMPLINGMODE=2;A.LINEAR_LINEAR_MIPNEAREST=11;A.TRILINEAR_SAMPLINGMODE=3;A.LINEAR_LINEAR_MIPLINEAR=3;A.NEAREST_NEAREST_MIPNEAREST=4;A.NEAREST_LINEAR_MIPNEAREST=5;A.NEAREST_LINEAR_MIPLINEAR=6;A.NEAREST_LINEAR=7;A.NEAREST_NEAREST=1;A.LINEAR_NEAREST_MIPNEAREST=9;A.LINEAR_NEAREST_MIPLINEAR=10;A.LINEAR_LINEAR=2;A.LINEAR_NEAREST=12;A.EXPLICIT_MODE=0;A.SPHERICAL_MODE=1;A.PLANAR_MODE=2;A.CUBIC_MODE=3;A.PROJECTION_MODE=4;A.SKYBOX_MODE=5;A.INVCUBIC_MODE=6;A.EQUIRECTANGULAR_MODE=7;A.FIXED_EQUIRECTANGULAR_MODE=8;A.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;A.CLAMP_ADDRESSMODE=0;A.WRAP_ADDRESSMODE=1;A.MIRROR_ADDRESSMODE=2;A.UseSerializedUrlIfAny=!1;S([I()],A.prototype,"url",void 0);S([I()],A.prototype,"uOffset",void 0);S([I()],A.prototype,"vOffset",void 0);S([I()],A.prototype,"uScale",void 0);S([I()],A.prototype,"vScale",void 0);S([I()],A.prototype,"uAng",void 0);S([I()],A.prototype,"vAng",void 0);S([I()],A.prototype,"wAng",void 0);S([I()],A.prototype,"uRotationCenter",void 0);S([I()],A.prototype,"vRotationCenter",void 0);S([I()],A.prototype,"wRotationCenter",void 0);S([I()],A.prototype,"homogeneousRotationInUVTransform",void 0);S([I()],A.prototype,"isBlocking",null);Re("BABYLON.Texture",A);pe._TextureParser=A.Parse;var Hr=(()=>{class n{static get UniqueId(){let t=this._UniqueIdCounter;return this._UniqueIdCounter++,t}}return n._UniqueIdCounter=1,n})();var Wr=(()=>{class n{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(t,r){n.Enabled&&(this._current+=t,r&&this._fetchResult())}beginMonitoring(){n.Enabled&&(this._startMonitoringTime=ye.Now)}endMonitoring(t=!0){if(!n.Enabled)return;t&&this.fetchNewFrame();let r=ye.Now;this._current=r-this._startMonitoringTime,t&&this._fetchResult()}endFrame(){this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;let t=ye.Now;t-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=t,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}return n.Enabled=!0,n})();var Ot=class{constructor(){this._gpuTimeInFrameId=-1,this.counter=new Wr}_addDuration(e,t){e<this._gpuTimeInFrameId||(this._gpuTimeInFrameId!==e?(this.counter._fetchResult(),this.counter.fetchNewFrame(),this.counter.addCount(t,!1),this._gpuTimeInFrameId=e):this.counter.addCount(t,!1))}};var De=class n{get options(){return this._options}get shaderPath(){return this._shaderPath}constructor(e,t,r,i={}){if(this._bindings={},this._samplers={},this._contextIsDirty=!1,this.fastMode=!1,this.onCompiled=null,this.onError=null,this.name=e,this._engine=t,this.uniqueId=Hr.UniqueId,t.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new Ot),!this._engine.getCaps().supportComputeShaders){C.Error("This engine does not support compute shaders!");return}if(!i.bindingsMapping){C.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!");return}this._context=t.createComputeContext(),this._shaderPath=r,this._options=ve({bindingsMapping:{},defines:[]},i)}getClassName(){return"ComputeShader"}setTexture(e,t,r=!0){let i=this._bindings[e];this._bindings[e]={type:r?V.Texture:V.TextureWithoutSampler,object:t,indexInGroupEntries:i?.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t||i.type!==this._bindings[e].type)}setStorageTexture(e,t){let r=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!r||r.object!==t),this._bindings[e]={type:V.StorageTexture,object:t,indexInGroupEntries:r?.indexInGroupEntries}}setExternalTexture(e,t){let r=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!r||r.object!==t),this._bindings[e]={type:V.ExternalTexture,object:t,indexInGroupEntries:r?.indexInGroupEntries}}setVideoTexture(e,t){return t.externalTexture?(this.setExternalTexture(e,t.externalTexture),!0):!1}setUniformBuffer(e,t){let r=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!r||r.object!==t),this._bindings[e]={type:n._BufferIsDataBuffer(t)?V.DataBuffer:V.UniformBuffer,object:t,indexInGroupEntries:r?.indexInGroupEntries}}setStorageBuffer(e,t){let r=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!r||r.object!==t),this._bindings[e]={type:n._BufferIsDataBuffer(t)?V.DataBuffer:V.StorageBuffer,object:t,indexInGroupEntries:r?.indexInGroupEntries}}setTextureSampler(e,t){let r=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!r||!t.compareSampler(r.object)),this._bindings[e]={type:V.Sampler,object:t,indexInGroupEntries:r?.indexInGroupEntries}}isReady(){let e=this._effect;for(let s in this._bindings){let a=this._bindings[s],o=a.type,h=a.object;switch(o){case V.Texture:case V.TextureWithoutSampler:case V.StorageTexture:{if(!h.isReady())return!1;break}case V.ExternalTexture:{if(!h.isReady())return!1;break}}}let t=[],r=this._shaderPath;if(this._options.defines)for(let s=0;s<this._options.defines.length;s++)t.push(this._options.defines[s]);let i=t.join(`
`);return this._cachedDefines!==i&&(this._cachedDefines=i,e=this._engine.createComputeEffect(r,{defines:i,entryPoint:this._options.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this._effect=e),!!e.isReady()}dispatch(e,t,r){return!this.fastMode&&!this._checkContext()?!1:(this._engine.computeDispatch(this._effect,this._context,this._bindings,e,t,r,this._options.bindingsMapping,this.gpuTimeInFrame),!0)}dispatchIndirect(e,t=0){if(!this.fastMode&&!this._checkContext())return!1;let r=n._BufferIsDataBuffer(e)?e:e.getBuffer();return this._engine.computeDispatchIndirect(this._effect,this._context,this._bindings,r,t,this._options.bindingsMapping,this.gpuTimeInFrame),!0}_checkContext(){if(!this.isReady())return!1;for(let e in this._bindings){let t=this._bindings[e];if(!this._options.bindingsMapping[e])throw new Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+e+"'");switch(t.type){case V.Texture:{let r=this._samplers[e],i=t.object;(!r||!i._texture||!r.compareSampler(i._texture))&&(this._samplers[e]=new Ge().setParameters(i.wrapU,i.wrapV,i.wrapR,i.anisotropicFilteringLevel,i._texture.samplingMode,i._texture?._comparisonFunction),this._contextIsDirty=!0);break}case V.ExternalTexture:{this._contextIsDirty=!0;break}case V.UniformBuffer:{let r=t.object;r.getBuffer()!==t.buffer&&(t.buffer=r.getBuffer(),this._contextIsDirty=!0);break}}}return this._contextIsDirty&&(this._contextIsDirty=!1,this._context.clear()),!0}dispatchWhenReady(e,t,r,i=10){return new Promise(s=>{let a=()=>{this.dispatch(e,t,r)?s():setTimeout(a,i)};a()})}serialize(){let e=pe.Serialize(this);e.options=this._options,e.shaderPath=this._shaderPath,e.bindings={},e.textures={};for(let t in this._bindings){let r=this._bindings[t],i=r.object;switch(r.type){case V.Texture:case V.TextureWithoutSampler:case V.StorageTexture:{let s=i.serialize();s&&(e.textures[t]=s,e.bindings[t]={type:r.type});break}case V.UniformBuffer:break}}return e}static Parse(e,t,r){let i=pe.Parse(()=>new n(e.name,t.getEngine(),e.shaderPath,e.options),e,t,r);for(let s in e.textures){let a=e.bindings[s],o=A.Parse(e.textures[s],t,r);a.type===V.Texture?i.setTexture(s,o):a.type===V.TextureWithoutSampler?i.setTexture(s,o,!1):i.setStorageTexture(s,o)}return i}static _BufferIsDataBuffer(e){return e.underlyingResource!==void 0}};S([I()],De.prototype,"name",void 0);S([I()],De.prototype,"fastMode",void 0);Re("BABYLON.ComputeShader",De);var Ke=class{constructor(e,t,r=3,i){this._engine=e,this._label=i,this._engine._storageBuffers.push(this),this._create(t,r)}_create(e,t){this._bufferSize=e,this._creationFlags=t,this._buffer=this._engine.createStorageBuffer(e,t,this._label)}_rebuild(){this._create(this._bufferSize,this._creationFlags)}getBuffer(){return this._buffer}update(e,t,r){this._buffer&&this._engine.updateStorageBuffer(this._buffer,e,t,r)}read(e,t,r,i){return this._engine.readFromStorageBuffer(this._buffer,e,t,r,i)}dispose(){let e=this._engine._storageBuffers,t=e.indexOf(this);t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._releaseBuffer(this._buffer),this._buffer=null}};var jr=(n,e,t)=>!n||n.getClassName&&n.getClassName()==="Mesh"?null:n.getClassName&&(n.getClassName()==="SubMesh"||n.getClassName()==="PhysicsBody")?n.clone(e):n.clone?n.clone():Array.isArray(n)?n.slice():t&&typeof n=="object"?ve({},n):null;function wi(n){let e=[];do Object.getOwnPropertyNames(n).forEach(function(t){e.indexOf(t)===-1&&e.push(t)});while(n=Object.getPrototypeOf(n));return e}var zt=class{static DeepCopy(e,t,r,i,s=!1){let a=wi(e);for(let o of a){if(o[0]==="_"&&(!i||i.indexOf(o)===-1)||o.endsWith("Observable")||r&&r.indexOf(o)!==-1)continue;let h=e[o],l=typeof h;if(l!=="function")try{if(l==="object")if(h instanceof Uint8Array)t[o]=Uint8Array.from(h);else if(h instanceof Array){if(t[o]=[],h.length>0)if(typeof h[0]=="object")for(let u=0;u<h.length;u++){let c=jr(h[u],t,s);t[o].indexOf(c)===-1&&t[o].push(c)}else t[o]=h.slice(0)}else t[o]=jr(h,t,s);else t[o]=h}catch(u){C.Warn(u.message)}}}};var K=class n{static get BaseUrl(){return z.BaseUrl}static set BaseUrl(e){z.BaseUrl=e}static get CleanUrl(){return z.CleanUrl}static set CleanUrl(e){z.CleanUrl=e}static IsAbsoluteUrl(e){return e.indexOf("//")===0?!0:e.indexOf("://")===-1||e.indexOf(".")===-1||e.indexOf("/")===-1||e.indexOf(":")>e.indexOf("/")?!1:e.indexOf("://")<e.indexOf(".")||e.indexOf("data:")===0||e.indexOf("blob:")===0}static set ScriptBaseUrl(e){z.ScriptBaseUrl=e}static get ScriptBaseUrl(){return z.ScriptBaseUrl}static set ScriptPreprocessUrl(e){z.ScriptPreprocessUrl=e}static get ScriptPreprocessUrl(){return z.ScriptPreprocessUrl}static get DefaultRetryStrategy(){return z.DefaultRetryStrategy}static set DefaultRetryStrategy(e){z.DefaultRetryStrategy=e}static get CorsBehavior(){return z.CorsBehavior}static set CorsBehavior(e){z.CorsBehavior=e}static get UseFallbackTexture(){return G.UseFallbackTexture}static set UseFallbackTexture(e){G.UseFallbackTexture=e}static get RegisteredExternalClasses(){return Ve.RegisteredExternalClasses}static set RegisteredExternalClasses(e){Ve.RegisteredExternalClasses=e}static get fallbackTexture(){return G.FallbackTexture}static set fallbackTexture(e){G.FallbackTexture=e}static FetchToRef(e,t,r,i,s,a){let o=Math.abs(e)*r%r|0,h=Math.abs(t)*i%i|0,l=(o+h*r)*4;a.r=s[l]/255,a.g=s[l+1]/255,a.b=s[l+2]/255,a.a=s[l+3]/255}static Mix(e,t,r){return 0}static Instantiate(e){return Ve.Instantiate(e)}static SetImmediate(e){Fe.SetImmediate(e)}static IsExponentOfTwo(e){return!0}static FloatRound(e){return Math.fround(e)}static GetFilename(e){let t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){let r=e.lastIndexOf("/");return r<0?t?e:"":e.substring(0,r+1)}static ToDegrees(e){return e*180/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,r=.9){let i=this.ToRadians(e),s=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-r)*Math.sin(s)+r*Math.sin(i),(1-r)*Math.cos(s)+r*Math.cos(i)))}static MakeArray(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]}static GetPointerPrefix(e){let t="pointer";return k()&&!window.PointerEvent&&(t="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(t="mouse"),t}static SetCorsBehavior(e,t){Ut(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static get PreprocessUrl(){return z.PreprocessUrl}static set PreprocessUrl(e){z.PreprocessUrl=e}static LoadImage(e,t,r,i,s,a){return Dt(e,t,r,i,s,a)}static LoadFile(e,t,r,i,s,a){return Be(e,t,r,i,s,a)}static LoadFileAsync(e,t=!0){return new Promise((r,i)=>{Be(e,s=>{r(s)},void 0,void 0,t,(s,a)=>{i(a)})})}static GetBabylonScriptURL(e,t){if(!e)return"";if(n.ScriptBaseUrl&&e.startsWith(n._DefaultCdnUrl)){let r=n.ScriptBaseUrl[n.ScriptBaseUrl.length-1]==="/"?n.ScriptBaseUrl.substring(0,n.ScriptBaseUrl.length-1):n.ScriptBaseUrl;e=e.replace(n._DefaultCdnUrl,r)}return e=n.ScriptPreprocessUrl(e),t&&(e=n.GetAbsoluteUrl(e)),e}static LoadBabylonScript(e,t,r,i){e=n.GetBabylonScriptURL(e),n.LoadScript(e,t,r)}static LoadBabylonScriptAsync(e){return e=n.GetBabylonScriptURL(e),n.LoadScriptAsync(e)}static LoadScript(e,t,r,i){if(typeof importScripts=="function"){try{importScripts(e),t()}catch(o){r?.(`Unable to load script '${e}' in worker`,o)}return}else if(!k()){r?.(`Cannot load script '${e}' outside of a window or a worker`);return}let s=document.getElementsByTagName("head")[0],a=document.createElement("script");a.setAttribute("type","text/javascript"),a.setAttribute("src",e),i&&(a.id=i),a.onload=()=>{t&&t()},a.onerror=o=>{r&&r(`Unable to load script '${e}'`,o)},s.appendChild(a)}static LoadScriptAsync(e,t){return new Promise((r,i)=>{this.LoadScript(e,()=>{r()},(s,a)=>{i(a||new Error(s))},t)})}static ReadFileAsDataURL(e,t,r){let i=new FileReader,s={onCompleteObservable:new L,abort:()=>i.abort()};return i.onloadend=()=>{s.onCompleteObservable.notifyObservers(s)},i.onload=a=>{t(a.target.result)},i.onprogress=r,i.readAsDataURL(e),s}static ReadFile(e,t,r,i,s){return qe(e,t,r,i,s)}static FileAsURL(e){let t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,r,i){zt.DeepCopy(e,t,r,i)}static IsEmpty(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let r=0;r<t.length;r++){let i=t[r];e.addEventListener(i.name,i.handler,!1);try{window.parent&&window.parent.addEventListener(i.name,i.handler,!1)}catch{}}}static UnregisterTopRootEvents(e,t){for(let r=0;r<t.length;r++){let i=t[r];e.removeEventListener(i.name,i.handler);try{e.parent&&e.parent.removeEventListener(i.name,i.handler)}catch{}}}static DumpFramebuffer(e,t,r,i,s="image/png",a,o){return Oe(this,null,function*(){throw v("DumpTools")})}static DumpData(e,t,r,i,s="image/png",a,o=!1,h=!1,l){throw v("DumpTools")}static DumpDataAsync(e,t,r,i="image/png",s,a=!1,o=!1,h){throw v("DumpTools")}static _IsOffScreenCanvas(e){return e.convertToBlob!==void 0}static ToBlob(e,t,r="image/png",i){!n._IsOffScreenCanvas(e)&&!e.toBlob&&(e.toBlob=function(s,a,o){setTimeout(()=>{let h=atob(this.toDataURL(a,o).split(",")[1]),l=h.length,u=new Uint8Array(l);for(let c=0;c<l;c++)u[c]=h.charCodeAt(c);s(new Blob([u]))})}),n._IsOffScreenCanvas(e)?e.convertToBlob({type:r,quality:i}).then(s=>t(s)):e.toBlob(function(s){t(s)},r,i)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){let r=new Date;t="screenshot_"+((r.getFullYear()+"-"+(r.getMonth()+1)).slice(2)+"-"+r.getDate()+"_"+r.getHours()+"-"+("0"+r.getMinutes()).slice(-2))+".png"}n.Download(e,t)}else if(e&&typeof URL<"u"){let r=URL.createObjectURL(e),i=window.open("");if(!i)return;let s=i.document.createElement("img");s.onload=function(){URL.revokeObjectURL(r)},s.src=r,i.document.body.appendChild(s)}}static EncodeScreenshotCanvasData(e,t,r="image/png",i,s){if(typeof i=="string"||!t)this.ToBlob(e,function(a){a&&n.DownloadBlob(a,i),t&&t("")},r,s);else if(t){if(n._IsOffScreenCanvas(e)){e.convertToBlob({type:r,quality:s}).then(o=>{let h=new FileReader;h.readAsDataURL(o),h.onloadend=()=>{let l=h.result;t(l)}});return}let a=e.toDataURL(r,s);t(a)}}static Download(e,t){if(typeof URL>"u")return;let r=window.URL.createObjectURL(e),i=document.createElement("a");document.body.appendChild(i),i.style.display="none",i.href=r,i.download=t,i.addEventListener("click",()=>{i.parentElement&&i.parentElement.removeChild(i)}),i.click(),window.URL.revokeObjectURL(r)}static BackCompatCameraNoPreventDefault(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1}static CreateScreenshot(e,t,r,i,s="image/png",a=!1,o){throw v("ScreenshotTools")}static CreateScreenshotAsync(e,t,r,i="image/png",s){throw v("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,r,i,s="image/png",a=1,o=!1,h,l=!1,u=!1,c=!0,f){throw v("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,r,i="image/png",s=1,a=!1,o,h=!1,l=!1,u=!0,c){throw v("ScreenshotTools")}static RandomId(){return wt()}static IsBase64(e){return tr(e)}static DecodeBase64(e){return Lt(e)}static get errorsCount(){return C.errorsCount}static Log(e){C.Log(e)}static Warn(e){C.Warn(e)}static Error(e){C.Error(e)}static get LogCache(){return C.LogCache}static ClearLogCache(){C.ClearLogCache()}static set LogLevels(e){C.LogLevels=e}static set PerformanceLogLevel(e){if((e&n.PerformanceUserMarkLogLevel)===n.PerformanceUserMarkLogLevel){n.StartPerformanceCounter=n._StartUserMark,n.EndPerformanceCounter=n._EndUserMark;return}if((e&n.PerformanceConsoleLogLevel)===n.PerformanceConsoleLogLevel){n.StartPerformanceCounter=n._StartPerformanceConsole,n.EndPerformanceCounter=n._EndPerformanceConsole;return}n.StartPerformanceCounter=n._StartPerformanceCounterDisabled,n.EndPerformanceCounter=n._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!n._Performance){if(!k())return;n._Performance=window.performance}!t||!n._Performance.mark||n._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){!t||!n._Performance.mark||(n._Performance.mark(e+"-End"),n._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){t&&(n._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){t&&(n._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return ye.Now}static GetClassName(e,t=!1){let r=null;return!t&&e.getClassName?r=e.getClassName():(e instanceof Object&&(r=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),r||(r=typeof e)),r}static First(e,t){for(let r of e)if(t(r))return r;return null}static getFullClassName(e,t=!1){let r=null,i=null;if(!t&&e.getClassName)r=e.getClassName();else{if(e instanceof Object){let s=t?e:Object.getPrototypeOf(e);r=s.constructor.__bjsclassName__,i=s.constructor.__bjsmoduleName__}r||(r=typeof e)}return r?(i!=null?i+".":"")+r:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return it()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}};K.UseCustomRequestHeaders=!1;K.CustomRequestHeaders=_e.CustomRequestHeaders;K.GetDOMTextContent=st;K._DefaultCdnUrl="https://cdn.babylonjs.com";K.GetAbsoluteUrl=typeof document=="object"?n=>{let e=document.createElement("a");return e.href=n,e.href}:typeof URL=="function"&&typeof location=="object"?n=>new URL(n,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")};K.NoneLogLevel=C.NoneLogLevel;K.MessageLogLevel=C.MessageLogLevel;K.WarningLogLevel=C.WarningLogLevel;K.ErrorLogLevel=C.ErrorLogLevel;K.AllLogLevel=C.AllLogLevel;K.IsWindowObjectExist=k;K.PerformanceNoneLogLevel=0;K.PerformanceUserMarkLogLevel=1;K.PerformanceConsoleLogLevel=2;K.StartPerformanceCounter=K._StartPerformanceCounterDisabled;K.EndPerformanceCounter=K._EndPerformanceCounterDisabled;var Xr=class n{constructor(e,t,r,i=0){this.iterations=e,this.index=i-1,this._done=!1,this._fn=t,this._successCallback=r}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,r,i=0){let s=new n(e,t,r,i);return s.executeNext(),s}static SyncAsyncForLoop(e,t,r,i,s,a=0){return n.Run(Math.ceil(e/t),o=>{s&&s()?o.breakLoop():setTimeout(()=>{for(let h=0;h<t;++h){let l=o.index*t+h;if(l>=e)break;if(r(l),s&&s()){o.breakLoop();break}}o.executeNext()},a)},i)}};K.Mix=Ar;K.IsExponentOfTwo=Er;G.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";U.prototype.createUniformBuffer=function(n,e){let t=this._gl.createBuffer();if(!t)throw new Error("Unable to create uniform buffer");let r=new Se(t);return this.bindUniformBuffer(r),n instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,n,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(n),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),r.references=1,r};U.prototype.createDynamicUniformBuffer=function(n,e){let t=this._gl.createBuffer();if(!t)throw new Error("Unable to create dynamic uniform buffer");let r=new Se(t);return this.bindUniformBuffer(r),n instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,n,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(n),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),r.references=1,r};U.prototype.updateUniformBuffer=function(n,e,t,r){this.bindUniformBuffer(n),t===void 0&&(t=0),r===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+r)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+r)),this.bindUniformBuffer(null)};U.prototype.bindUniformBuffer=function(n){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,n?n.underlyingResource:null)};U.prototype.bindUniformBufferBase=function(n,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,n?n.underlyingResource:null)};U.prototype.bindUniformBlock=function(n,e,t){let r=n.program,i=this._gl.getUniformBlockIndex(r,e);i!==4294967295&&this._gl.uniformBlockBinding(r,i,t)};var de=class n{constructor(e,t,r,i,s=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||s,this._dynamic=r,this._name=i??"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){let r=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;let i=this._uniformLocationPointer-r;for(let s=0;s<i;s++)this._data.push(0)}}addUniform(e,t,r=0){if(this._noUBO||this._uniformLocations[e]!==void 0)return;let i;if(r>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:r},t==16)t=t*r;else{let a=(4-t)*r;t=t*r+a}i=[];for(let s=0;s<t;s++)i.push(0)}else{if(t instanceof Array)i=t,t=i.length;else{t=t,i=[];for(let s=0;s<t;s++)i.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let s=0;s<t;s++)this._data.push(i[s]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.asArray()))}addFloat2(e,t,r){let i=[t,r];this.addUniform(e,i)}addFloat3(e,t,r,i){let s=[t,r,i];this.addUniform(e,s)}addColor3(e,t){let r=[t.r,t.g,t.b];this.addUniform(e,r)}addColor4(e,t,r){let i=[t.r,t.g,t.b,r];this.addUniform(e,i)}addVector3(e,t){let r=[t.x,t.y,t.z];this.addUniform(e,r)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_getNames(){let e=[],t=0;for(let r in this._uniformLocations)if(e.push(r),++t===10)break;return e.join(",")}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()):this._buffer=this._engine.createUniformBuffer(this._bufferData,this._name+"_UniformList:"+this._getNames()),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}_rebuildAfterContextLost(){this._engine._features.trackUbosInFrame&&(this._buffers=[],this._currentFrameId=0),this._rebuild()}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let r=0;r<e.length;++r)if(e[r]!==t[r])return!1;return!0}_copyBuffer(e,t){for(let r=0;r<e.length;++r)t[r]=e[r]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(n._UpdatedUbosInFrame[this._name]||(n._UpdatedUbosInFrame[this._name]=0),n._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,r){this._checkNewFrame();let i=this._uniformLocations[e];if(i===void 0){if(this._buffer){C.Error("Cannot add an uniform after UBO has been created. uniformName="+e);return}this.addUniform(e,r),i=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let s=0;s<r;s++)this._bufferData[i+s]=t[s];else{let s=!1;for(let a=0;a<r;a++)(r===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[i+a]!==Math.fround(t[a]))&&(s=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[i+a]=t[a]);this._needSync=this._needSync||s}}updateUniformArray(e,t,r){this._checkNewFrame();let i=this._uniformLocations[e];if(i===void 0){C.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.");return}this._buffer||this.create();let s=this._uniformArraySizes[e];if(this._dynamic)for(let a=0;a<r;a++)this._bufferData[i+a]=t[a];else{let a=!1,o=0,h=0;for(let l=0;l<r;l++)if(this._bufferData[i+h*4+o]!==K.FloatRound(t[l])&&(a=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[i+h*4+o]=t[l]),o++,o===s.strideSize){for(;o<4;o++)this._bufferData[i+h*4+o]=0;o=0,h++}this._needSync=this._needSync||a}}_cacheMatrix(e,t){this._checkNewFrame();let r=this._valueCache[e],i=t.updateFlag;return r!==void 0&&r===i?!1:(this._valueCache[e]=i,!0)}_updateMatrix3x3ForUniform(e,t){for(let r=0;r<3;r++)n._TempBuffer[r*4]=t[r*3],n._TempBuffer[r*4+1]=t[r*3+1],n._TempBuffer[r*4+2]=t[r*3+2],n._TempBuffer[r*4+3]=0;this.updateUniform(e,n._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let r=0;r<2;r++)n._TempBuffer[r*4]=t[r*2],n._TempBuffer[r*4+1]=t[r*2+1],n._TempBuffer[r*4+2]=0,n._TempBuffer[r*4+3]=0;this.updateUniform(e,n._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){n._TempBuffer[0]=t,this.updateUniform(e,n._TempBuffer,1)}_updateFloat2ForEffect(e,t,r,i=""){this._currentEffect.setFloat2(e+i,t,r)}_updateFloat2ForUniform(e,t,r){n._TempBuffer[0]=t,n._TempBuffer[1]=r,this.updateUniform(e,n._TempBuffer,2)}_updateFloat3ForEffect(e,t,r,i,s=""){this._currentEffect.setFloat3(e+s,t,r,i)}_updateFloat3ForUniform(e,t,r,i){n._TempBuffer[0]=t,n._TempBuffer[1]=r,n._TempBuffer[2]=i,this.updateUniform(e,n._TempBuffer,3)}_updateFloat4ForEffect(e,t,r,i,s,a=""){this._currentEffect.setFloat4(e+a,t,r,i,s)}_updateFloat4ForUniform(e,t,r,i,s){n._TempBuffer[0]=t,n._TempBuffer[1]=r,n._TempBuffer[2]=i,n._TempBuffer[3]=s,this.updateUniform(e,n._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){n._TempBufferInt32View.set(t),this.updateUniformArray(e,n._TempBuffer,t.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(e,t){n._TempBufferUInt32View.set(t),this.updateUniformArray(e,n._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.asArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){n._TempBuffer[0]=t.x,n._TempBuffer[1]=t.y,n._TempBuffer[2]=t.z,this.updateUniform(e,n._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){n._TempBuffer[0]=t.x,n._TempBuffer[1]=t.y,n._TempBuffer[2]=t.z,n._TempBuffer[3]=t.w,this.updateUniform(e,n._TempBuffer,4)}_updateColor3ForEffect(e,t,r=""){this._currentEffect.setColor3(e+r,t)}_updateColor3ForUniform(e,t){n._TempBuffer[0]=t.r,n._TempBuffer[1]=t.g,n._TempBuffer[2]=t.b,this.updateUniform(e,n._TempBuffer,3)}_updateColor4ForEffect(e,t,r,i=""){this._currentEffect.setColor4(e+i,t,r)}_updateDirectColor4ForEffect(e,t,r=""){this._currentEffect.setDirectColor4(e+r,t)}_updateColor4ForUniform(e,t,r){n._TempBuffer[0]=t.r,n._TempBuffer[1]=t.g,n._TempBuffer[2]=t.b,n._TempBuffer[3]=r,this.updateUniform(e,n._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){n._TempBuffer[0]=t.r,n._TempBuffer[1]=t.g,n._TempBuffer[2]=t.b,n._TempBuffer[3]=t.a,this.updateUniform(e,n._TempBuffer,4)}_updateIntForEffect(e,t,r=""){this._currentEffect.setInt(e+r,t)}_updateIntForUniform(e,t){n._TempBufferInt32View[0]=t,this.updateUniform(e,n._TempBuffer,1)}_updateInt2ForEffect(e,t,r,i=""){this._currentEffect.setInt2(e+i,t,r)}_updateInt2ForUniform(e,t,r){n._TempBufferInt32View[0]=t,n._TempBufferInt32View[1]=r,this.updateUniform(e,n._TempBuffer,2)}_updateInt3ForEffect(e,t,r,i,s=""){this._currentEffect.setInt3(e+s,t,r,i)}_updateInt3ForUniform(e,t,r,i){n._TempBufferInt32View[0]=t,n._TempBufferInt32View[1]=r,n._TempBufferInt32View[2]=i,this.updateUniform(e,n._TempBuffer,3)}_updateInt4ForEffect(e,t,r,i,s,a=""){this._currentEffect.setInt4(e+a,t,r,i,s)}_updateInt4ForUniform(e,t,r,i,s){n._TempBufferInt32View[0]=t,n._TempBufferInt32View[1]=r,n._TempBufferInt32View[2]=i,n._TempBufferInt32View[3]=s,this.updateUniform(e,n._TempBuffer,4)}_updateUIntForEffect(e,t,r=""){this._currentEffect.setUInt(e+r,t)}_updateUIntForUniform(e,t){n._TempBufferUInt32View[0]=t,this.updateUniform(e,n._TempBuffer,1)}_updateUInt2ForEffect(e,t,r,i=""){this._currentEffect.setUInt2(e+i,t,r)}_updateUInt2ForUniform(e,t,r){n._TempBufferUInt32View[0]=t,n._TempBufferUInt32View[1]=r,this.updateUniform(e,n._TempBuffer,2)}_updateUInt3ForEffect(e,t,r,i,s=""){this._currentEffect.setUInt3(e+s,t,r,i)}_updateUInt3ForUniform(e,t,r,i){n._TempBufferUInt32View[0]=t,n._TempBufferUInt32View[1]=r,n._TempBufferUInt32View[2]=i,this.updateUniform(e,n._TempBuffer,3)}_updateUInt4ForEffect(e,t,r,i,s,a=""){this._currentEffect.setUInt4(e+a,t,r,i,s)}_updateUInt4ForUniform(e,t,r,i,s){n._TempBufferUInt32View[0]=t,n._TempBufferUInt32View[1]=r,n._TempBufferUInt32View[2]=i,n._TempBufferUInt32View[3]=s,this.updateUniform(e,n._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}bindTexture(e,t){this._currentEffect._bindTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;let e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let r=0;r<this._buffers.length;++r){let i=this._buffers[r][0];this._engine._releaseBuffer(i)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}};de._UpdatedUbosInFrame={};de._MAX_UNIFORM_SIZE=256;de._TempBuffer=new Float32Array(de._MAX_UNIFORM_SIZE);de._TempBufferInt32View=new Int32Array(de._TempBuffer.buffer);de._TempBufferUInt32View=new Uint32Array(de._TempBuffer.buffer);var Si="boundingInfoComputeShader",Ii=`struct Results {minX : atomic<i32>,
minY : atomic<i32>,
minZ : atomic<i32>,
maxX : atomic<i32>,
maxY : atomic<i32>,
maxZ : atomic<i32>,
dummy1 : i32,
dummy2 : i32,};fn floatToBits(value: f32)->i32 {return bitcast<i32>(value);}
fn bitsToFloat(value: i32)->f32 {return bitcast<f32>(value);}
fn atomicMinFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value>=oldValue) {break;}
if (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}
fn atomicMaxFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value<=oldValue) {break;}
if (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}
fn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>
{let offset=i32(index) *4; 
let m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}
const identity=mat4x4f(
vec4f(1.0,0.0,0.0,0.0),
vec4f(0.0,1.0,0.0,0.0),
vec4f(0.0,0.0,1.0,0.0),
vec4f(0.0,0.0,0.0,1.0)
);struct Settings {indexResult : u32,
#ifdef MORPHTARGETS
morphTargetTextureInfo: vec3f,
#endif
};@group(0) @binding(0) var<storage,read> positionBuffer : array<f32>;@group(0) @binding(1) var<storage,read_write> resultBuffer : array<Results>;@group(0) @binding(7) var<uniform> settings : Settings;
#if NUM_BONE_INFLUENCERS>0
@group(0) @binding(2) var boneSampler : texture_2d<f32>;@group(0) @binding(3) var<storage,read> indexBuffer : array<vec4f>;@group(0) @binding(4) var<storage,read> weightBuffer : array<vec4f>;
#if NUM_BONE_INFLUENCERS>4
@group(0) @binding(5) var<storage,read> indexExtraBuffer : array<vec4f>;@group(0) @binding(6) var<storage,read> weightExtraBuffer : array<vec4f>;
#endif
#endif
#ifdef MORPHTARGETS
@group(0) @binding(8) var morphTargets : texture_2d_array<f32>;@group(0) @binding(9) var<storage,read> morphTargetInfluences : array<f32>;@group(0) @binding(10) var<storage,read> morphTargetTextureIndices : array<f32>;
#endif
#ifdef MORPHTARGETS
fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : u32)->vec3f
{ 
let vertexID=f32(vertexIndex)*settings.morphTargetTextureInfo.x;let y=floor(vertexID/settings.morphTargetTextureInfo.y);let x=vertexID-y*settings.morphTargetTextureInfo.y;let textureUV=vec2<i32>(i32(x),i32(y));return textureLoad(morphTargets,textureUV,i32(morphTargetTextureIndices[targetIndex]),0).xyz;}
#endif
@compute @workgroup_size(64,1,1)
fn main(@builtin(global_invocation_id) global_id : vec3<u32>) {let index=global_id.x;if (index>=arrayLength(&positionBuffer)/3) {return;}
let position=vec3f(positionBuffer[index*3],positionBuffer[index*3+1],positionBuffer[index*3+2]);var finalWorld=identity;var positionUpdated=position;
#if NUM_BONE_INFLUENCERS>0
var influence : mat4x4<f32>;let matricesIndices=indexBuffer[index];let matricesWeights=weightBuffer[index];influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
let matricesIndicesExtra=indexExtraBuffer[index];let matricesWeightsExtra=weightExtraBuffer[index];influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.x)*matricesWeightsExtra.x;
#if NUM_BONE_INFLUENCERS>5
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.y)*matricesWeightsExtra.y;
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.z)*matricesWeightsExtra.z;
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.w)*matricesWeightsExtra.w;
#endif 
#endif 
finalWorld=finalWorld*influence;
#endif
#ifdef MORPHTARGETS
for (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {positionUpdated=positionUpdated+(readVector3FromRawSampler(i,index)-position)*morphTargetInfluences[i];}
#endif
var worldPos=finalWorld*vec4f(positionUpdated.x,positionUpdated.y,positionUpdated.z,1.0);atomicMinFloat(&resultBuffer[settings.indexResult].minX,worldPos.x);atomicMinFloat(&resultBuffer[settings.indexResult].minY,worldPos.y);atomicMinFloat(&resultBuffer[settings.indexResult].minZ,worldPos.z);atomicMaxFloat(&resultBuffer[settings.indexResult].maxX,worldPos.x);atomicMaxFloat(&resultBuffer[settings.indexResult].maxY,worldPos.y);atomicMaxFloat(&resultBuffer[settings.indexResult].maxZ,worldPos.z);}`;oe.ShadersStoreWGSL[Si]=Ii;var qr=class{constructor(e){this._computeShaders={},this._positionBuffers={},this._indexBuffers={},this._weightBuffers={},this._indexExtraBuffers={},this._weightExtraBuffers={},this._morphTargetInfluenceBuffers={},this._morphTargetTextureIndexBuffers={},this._ubos=[],this._uboIndex=0,this._engine=e}_getComputeShader(e){let t,r=e.join(`
`);return this._computeShaders[r]?t=this._computeShaders[r]:(t=new De("boundingInfoCompute",this._engine,"boundingInfo",{bindingsMapping:{positionBuffer:{group:0,binding:0},resultBuffer:{group:0,binding:1},boneSampler:{group:0,binding:2},indexBuffer:{group:0,binding:3},weightBuffer:{group:0,binding:4},indexExtraBuffer:{group:0,binding:5},weightExtraBuffer:{group:0,binding:6},settings:{group:0,binding:7},morphTargets:{group:0,binding:8},morphTargetInfluences:{group:0,binding:9},morphTargetTextureIndices:{group:0,binding:10}},defines:e}),this._computeShaders[r]=t),t}_getUBO(){if(this._uboIndex>=this._ubos.length){let e=new de(this._engine);e.addUniform("indexResult",4),e.addFloat3("morphTargetTextureInfo",0,0,0),this._ubos.push(e)}return this._ubos[this._uboIndex++]}_extractDataAndLink(e,t,r,i,s,a){let o,h=t.getTotalVertices();if(a[t.uniqueId])o=a[t.uniqueId];else{let l=t.getVertexBuffer(r)?.getFloatData(h);o=new Ke(this._engine,Float32Array.BYTES_PER_ELEMENT*h*i),o.update(l),a[t.uniqueId]=o}e.setStorageBuffer(s,o)}_prepareStorage(e,t,r,i,s,a){let o;i[r]?o=i[r]:(o=new Ke(this._engine,Float32Array.BYTES_PER_ELEMENT*s),i[r]=o),o.update(a),e.setStorageBuffer(t,o)}processAsync(e){Array.isArray(e)||(e=[e]),this._uboIndex=0;let t=8*e.length,r,i;!this._resultData||this._resultData.length!==t?(this._resultBuffer?.dispose(),r=new Float32Array(t),i=new Ke(this._engine,Float32Array.BYTES_PER_ELEMENT*t),this._resultData=r,this._resultBuffer=i):(r=this._resultData,i=this._resultBuffer);for(let o=0;o<e.length;o++)r[o*8+0]=Number.POSITIVE_INFINITY,r[o*8+1]=Number.POSITIVE_INFINITY,r[o*8+2]=Number.POSITIVE_INFINITY,r[o*8+3]=Number.NEGATIVE_INFINITY,r[o*8+4]=Number.NEGATIVE_INFINITY,r[o*8+5]=Number.NEGATIVE_INFINITY;i.update(r);let s=[],a=[];for(let o=0;o<e.length;o++){let h=e[o],l=h.getTotalVertices(),u=[""];if(l===0||!h.getVertexBuffer||!h.getVertexBuffer(Pe.PositionKind))continue;a.push(h),h&&h.useBones&&h.computeBonesUsingShaders&&h.skeleton&&u.push("#define NUM_BONE_INFLUENCERS "+h.numBoneInfluencers);let c=h.morphTargetManager;c&&c.numInfluencers>0&&(u.push("MORPHTARGETS"),u.push("#define NUM_MORPH_INFLUENCERS "+c.numInfluencers));let f=this._getComputeShader(u);this._extractDataAndLink(f,h,Pe.PositionKind,3,"positionBuffer",this._positionBuffers);let _=this._getUBO();if(_.updateUInt("indexResult",a.length-1),h&&h.useBones&&h.computeBonesUsingShaders&&h.skeleton&&h.skeleton.useTextureToStoreBoneMatrices){this._extractDataAndLink(f,h,Pe.MatricesIndicesKind,4,"indexBuffer",this._indexBuffers),this._extractDataAndLink(f,h,Pe.MatricesWeightsKind,4,"weightBuffer",this._weightBuffers);let d=h.skeleton.getTransformMatrixTexture(h);f.setTexture("boneSampler",d,!1),h.numBoneInfluencers>4&&(this._extractDataAndLink(f,h,Pe.MatricesIndicesExtraKind,4,"indexExtraBuffer",this._indexExtraBuffers),this._extractDataAndLink(f,h,Pe.MatricesWeightsExtraKind,4,"weightExtraBuffer",this._weightExtraBuffers))}if(c&&c.numInfluencers>0){let d=c._targetStoreTexture;f.setTexture("morphTargets",d,!1),this._prepareStorage(f,"morphTargetInfluences",h.uniqueId,this._morphTargetInfluenceBuffers,c.numInfluencers,c.influences),this._prepareStorage(f,"morphTargetTextureIndices",h.uniqueId,this._morphTargetTextureIndexBuffers,c.numInfluencers,c._morphTargetTextureIndices),_.updateFloat3("morphTargetTextureInfo",c._textureVertexStride,c._textureWidth,c._textureHeight)}_.update(),f.setStorageBuffer("resultBuffer",i),f.setUniformBuffer("settings",_),s.push(f.dispatchWhenReady(Math.ceil(l/64)))}return s.length===0?Promise.resolve():Promise.all(s).then(()=>i.read(void 0,void 0,r,!0).then(()=>{for(let o=0;o<a.length;o++)a[o]._refreshBoundingInfoDirect({minimum:b.FromArray(r,o*8),maximum:b.FromArray(r,o*8+3)})}))}_disposeCache(e){for(let t in e)e[t].dispose()}dispose(){this._disposeCache(this._positionBuffers),this._positionBuffers={},this._disposeCache(this._indexBuffers),this._indexBuffers={},this._disposeCache(this._weightBuffers),this._weightBuffers={},this._disposeCache(this._morphTargetInfluenceBuffers),this._morphTargetInfluenceBuffers={},this._disposeCache(this._morphTargetTextureIndexBuffers),this._morphTargetTextureIndexBuffers={},this._resultBuffer.dispose(),this._resultBuffer=void 0,this._resultData=void 0;for(let e of this._ubos)e.dispose();this._ubos=[],this._computeShaders={},this._engine=null}};export{Ee as a,b,we as c,fe as d,M as e,H as f,zt as g,S as h,Ui as i,I as j,_r as k,Di as l,Li as m,vi as n,Oi as o,zi as p,Ni as q,Gi as r,ki as s,Vi as t,Ki as u,Hi as v,fr as w,v as x,me as y,pe as z,Ye as A,_e as B,k as C,it as D,He as E,st as F,ye as G,It as H,ke as I,_a as J,wr as K,Js as L,Sr as M,Rt as N,Fe as O,bt as P,he as Q,Et as R,At as S,Y as T,We as U,Ie as V,Pt as W,Dt as X,qe as Y,Be as Z,zr as _,tr as $,Lt as aa,wt as ba,Er as ca,Ar as da,Ht as ea,ft as fa,_t as ga,K as ha,Xr as ia,br as ja,Se as ka,Ct as la,U as ma,de as na,Wr as oa,Ze as pa,Hr as qa,rr as ra,Ci as sa,vt as ta,O as ua,A as va,Ke as wa,V as xa,Ot as ya,De as za,qr as Aa};
