import{$ as Eg,A as yg,B as gr,C as so,D as Bf,E as kS,F as RO,G as Mi,H as zo,I as Wo,J as PO,K as MO,L as DO,M as OO,N as wO,O as GS,P as NO,Q as $t,R as FO,S as LO,T as ke,U as Je,V as Se,W as BO,X as zS,Y as VO,Z as UO,_ as kO,a as j,aa as Ag,b as p,ba as ts,c as De,ca as Vf,d as q,da as WS,e as N,ea as GO,f as O,fa as zO,g as ei,ga as Rr,h as v,ha as H,i as Q,ia as no,j as I,ja as HS,k as Qe,ka as WO,l as At,la as Ho,m as mu,ma as at,n as gu,na as _r,o as mi,oa as Ps,p as Go,pa as zs,q as EO,qa as xu,r as _u,ra as it,s as Sg,sa as XS,t as AO,ta as vu,u as Lf,ua as Qi,v as IO,va as z,w as bl,wa as HO,x as We,xa as sn,y as di,ya as Ig,z as ae,za as XO}from"./chunk-3HLKOFEH.js";import{A as jS,B as wa,C as Na,D as Wf,E as Sc,F as qS,G as Hf,H as Fa,a as xr,b as er,c as cs,d as Yi,e as Br,f as Ms,g as oo,h as kf,i as Ds,j as Vr,k as Pa,l as bt,m as It,n as Tc,o as ao,p as Gf,q as lo,r as Cc,s as Ma,t as bc,u as YS,v as Da,w as co,x as zf,y as Oa,z as $S}from"./chunk-XTARVFIT.js";import{A as Uf,B as gi,C as y,a as ie,b as Kt,c as SO,d as $e,e as P,f as Et,g as yO,h as U,i as pu,j as Cg,k as je,l as Ir,m as bg,n as me,p as ls,q as rn,r as Ff,t as xe,u as X,v as oe,w as gt,x as F,y as pe,z as D}from"./chunk-WHUUA6IU.js";var KS=null;var QS=1,YO=Symbol("SIGNAL");function ki(s){let e=KS;return KS=s,e}function $O(){return KS}var ZS={version:0,lastCleanEpoch:0,dirty:!1,producerNode:void 0,producerLastReadVersion:void 0,producerIndexOfThis:void 0,nextProducerIndex:0,liveConsumerNode:void 0,liveConsumerIndexOfThis:void 0,consumerAllowSignalWrites:!1,consumerIsAlwaysLive:!1,producerMustRecompute:()=>!1,producerRecomputeValue:()=>{},consumerMarkedDirty:()=>{},consumerOnSignalRead:()=>{}};function I2(s){if(!(ry(s)&&!s.dirty)&&!(!s.dirty&&s.lastCleanEpoch===QS)){if(!s.producerMustRecompute(s)&&!ey(s)){s.dirty=!1,s.lastCleanEpoch=QS;return}s.producerRecomputeValue(s),s.dirty=!1,s.lastCleanEpoch=QS}}function JS(s){return s&&(s.nextProducerIndex=0),ki(s)}function jO(s,e){if(ki(e),!(!s||s.producerNode===void 0||s.producerIndexOfThis===void 0||s.producerLastReadVersion===void 0)){if(ry(s))for(let t=s.nextProducerIndex;t<s.producerNode.length;t++)iy(s.producerNode[t],s.producerIndexOfThis[t]);for(;s.producerNode.length>s.nextProducerIndex;)s.producerNode.pop(),s.producerLastReadVersion.pop(),s.producerIndexOfThis.pop()}}function ey(s){sy(s);for(let e=0;e<s.producerNode.length;e++){let t=s.producerNode[e],i=s.producerLastReadVersion[e];if(i!==t.version||(I2(t),i!==t.version))return!0}return!1}function ty(s){if(sy(s),ry(s))for(let e=0;e<s.producerNode.length;e++)iy(s.producerNode[e],s.producerIndexOfThis[e]);s.producerNode.length=s.producerLastReadVersion.length=s.producerIndexOfThis.length=0,s.liveConsumerNode&&(s.liveConsumerNode.length=s.liveConsumerIndexOfThis.length=0)}function iy(s,e){if(R2(s),s.liveConsumerNode.length===1&&P2(s))for(let i=0;i<s.producerNode.length;i++)iy(s.producerNode[i],s.producerIndexOfThis[i]);let t=s.liveConsumerNode.length-1;if(s.liveConsumerNode[e]=s.liveConsumerNode[t],s.liveConsumerIndexOfThis[e]=s.liveConsumerIndexOfThis[t],s.liveConsumerNode.length--,s.liveConsumerIndexOfThis.length--,e<s.liveConsumerNode.length){let i=s.liveConsumerIndexOfThis[e],r=s.liveConsumerNode[e];sy(r),r.producerIndexOfThis[i]=e}}function ry(s){return s.consumerIsAlwaysLive||(s?.liveConsumerNode?.length??0)>0}function sy(s){s.producerNode??=[],s.producerIndexOfThis??=[],s.producerLastReadVersion??=[]}function R2(s){s.liveConsumerNode??=[],s.liveConsumerIndexOfThis??=[]}function P2(s){return s.producerNode!==void 0}function M2(){throw new Error}var D2=M2;function qO(s){D2=s}function Nt(s){return typeof s=="function"}function Tu(s){let t=s(i=>{Error.call(i),i.stack=new Error().stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var Rg=Tu(s=>function(t){s(this),this.message=t?`${t.length} errors occurred during unsubscription:
${t.map((i,r)=>`${r+1}) ${i.toString()}`).join(`
  `)}`:"",this.name="UnsubscriptionError",this.errors=t});function Xf(s,e){if(s){let t=s.indexOf(e);0<=t&&s.splice(t,1)}}var Pr=class s{constructor(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let e;if(!this.closed){this.closed=!0;let{_parentage:t}=this;if(t)if(this._parentage=null,Array.isArray(t))for(let n of t)n.remove(this);else t.remove(this);let{initialTeardown:i}=this;if(Nt(i))try{i()}catch(n){e=n instanceof Rg?n.errors:[n]}let{_finalizers:r}=this;if(r){this._finalizers=null;for(let n of r)try{QO(n)}catch(o){e=e??[],o instanceof Rg?e=[...e,...o.errors]:e.push(o)}}if(e)throw new Rg(e)}}add(e){var t;if(e&&e!==this)if(this.closed)QO(e);else{if(e instanceof s){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}}_hasParent(e){let{_parentage:t}=this;return t===e||Array.isArray(t)&&t.includes(e)}_addParent(e){let{_parentage:t}=this;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e}_removeParent(e){let{_parentage:t}=this;t===e?this._parentage=null:Array.isArray(t)&&Xf(t,e)}remove(e){let{_finalizers:t}=this;t&&Xf(t,e),e instanceof s&&e._removeParent(this)}};Pr.EMPTY=(()=>{let s=new Pr;return s.closed=!0,s})();var ny=Pr.EMPTY;function Pg(s){return s instanceof Pr||s&&"closed"in s&&Nt(s.remove)&&Nt(s.add)&&Nt(s.unsubscribe)}function QO(s){Nt(s)?s():s.unsubscribe()}var ho={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1};var Cu={setTimeout(s,e,...t){let{delegate:i}=Cu;return i?.setTimeout?i.setTimeout(s,e,...t):setTimeout(s,e,...t)},clearTimeout(s){let{delegate:e}=Cu;return(e?.clearTimeout||clearTimeout)(s)},delegate:void 0};function Mg(s){Cu.setTimeout(()=>{let{onUnhandledError:e}=ho;if(e)e(s);else throw s})}function Yf(){}var KO=oy("C",void 0,void 0);function ZO(s){return oy("E",void 0,s)}function JO(s){return oy("N",s,void 0)}function oy(s,e,t){return{kind:s,value:e,error:t}}var yc=null;function bu(s){if(ho.useDeprecatedSynchronousErrorHandling){let e=!yc;if(e&&(yc={errorThrown:!1,error:null}),s(),e){let{errorThrown:t,error:i}=yc;if(yc=null,t)throw i}}else s()}function ew(s){ho.useDeprecatedSynchronousErrorHandling&&yc&&(yc.errorThrown=!0,yc.error=s)}var Ec=class extends Pr{constructor(e){super(),this.isStopped=!1,e?(this.destination=e,Pg(e)&&e.add(this)):this.destination=N2}static create(e,t,i){return new Su(e,t,i)}next(e){this.isStopped?ly(JO(e),this):this._next(e)}error(e){this.isStopped?ly(ZO(e),this):(this.isStopped=!0,this._error(e))}complete(){this.isStopped?ly(KO,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(e){this.destination.next(e)}_error(e){try{this.destination.error(e)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}},O2=Function.prototype.bind;function ay(s,e){return O2.call(s,e)}var cy=class{constructor(e){this.partialObserver=e}next(e){let{partialObserver:t}=this;if(t.next)try{t.next(e)}catch(i){Dg(i)}}error(e){let{partialObserver:t}=this;if(t.error)try{t.error(e)}catch(i){Dg(i)}else Dg(e)}complete(){let{partialObserver:e}=this;if(e.complete)try{e.complete()}catch(t){Dg(t)}}},Su=class extends Ec{constructor(e,t,i){super();let r;if(Nt(e)||!e)r={next:e??void 0,error:t??void 0,complete:i??void 0};else{let n;this&&ho.useDeprecatedNextContext?(n=Object.create(e),n.unsubscribe=()=>this.unsubscribe(),r={next:e.next&&ay(e.next,n),error:e.error&&ay(e.error,n),complete:e.complete&&ay(e.complete,n)}):r=e}this.destination=new cy(r)}};function Dg(s){ho.useDeprecatedSynchronousErrorHandling?ew(s):Mg(s)}function w2(s){throw s}function ly(s,e){let{onStoppedNotification:t}=ho;t&&Cu.setTimeout(()=>t(s,e))}var N2={closed:!0,next:Yf,error:w2,complete:Yf};var yu=typeof Symbol=="function"&&Symbol.observable||"@@observable";function nn(s){return s}function hy(...s){return uy(s)}function uy(s){return s.length===0?nn:s.length===1?s[0]:function(t){return s.reduce((i,r)=>r(i),t)}}var Di=(()=>{class s{constructor(t){t&&(this._subscribe=t)}lift(t){let i=new s;return i.source=this,i.operator=t,i}subscribe(t,i,r){let n=L2(t)?t:new Su(t,i,r);return bu(()=>{let{operator:o,source:a}=this;n.add(o?o.call(n,a):a?this._subscribe(n):this._trySubscribe(n))}),n}_trySubscribe(t){try{return this._subscribe(t)}catch(i){t.error(i)}}forEach(t,i){return i=tw(i),new i((r,n)=>{let o=new Su({next:a=>{try{t(a)}catch(l){n(l),o.unsubscribe()}},error:n,complete:r});this.subscribe(o)})}_subscribe(t){var i;return(i=this.source)===null||i===void 0?void 0:i.subscribe(t)}[yu](){return this}pipe(...t){return uy(t)(this)}toPromise(t){return t=tw(t),new t((i,r)=>{let n;this.subscribe(o=>n=o,o=>r(o),()=>i(n))})}}return s.create=e=>new s(e),s})();function tw(s){var e;return(e=s??ho.Promise)!==null&&e!==void 0?e:Promise}function F2(s){return s&&Nt(s.next)&&Nt(s.error)&&Nt(s.complete)}function L2(s){return s&&s instanceof Ec||F2(s)&&Pg(s)}function dy(s){return Nt(s?.lift)}function ai(s){return e=>{if(dy(e))return e.lift(function(t){try{return s(t,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function li(s,e,t,i,r){return new fy(s,e,t,i,r)}var fy=class extends Ec{constructor(e,t,i,r,n,o){super(e),this.onFinalize=n,this.shouldUnsubscribe=o,this._next=t?function(a){try{t(a)}catch(l){e.error(l)}}:super._next,this._error=r?function(a){try{r(a)}catch(l){e.error(l)}finally{this.unsubscribe()}}:super._error,this._complete=i?function(){try{i()}catch(a){e.error(a)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){let{closed:t}=this;super.unsubscribe(),!t&&((e=this.onFinalize)===null||e===void 0||e.call(this))}}};function Eu(){return ai((s,e)=>{let t=null;s._refCount++;let i=li(e,void 0,void 0,void 0,()=>{if(!s||s._refCount<=0||0<--s._refCount){t=null;return}let r=s._connection,n=t;t=null,r&&(!n||r===n)&&r.unsubscribe(),e.unsubscribe()});s.subscribe(i),i.closed||(t=s.connect())})}var Au=class extends Di{constructor(e,t){super(),this.source=e,this.subjectFactory=t,this._subject=null,this._refCount=0,this._connection=null,dy(e)&&(this.lift=e.lift)}_subscribe(e){return this.getSubject().subscribe(e)}getSubject(){let e=this._subject;return(!e||e.isStopped)&&(this._subject=this.subjectFactory()),this._subject}_teardown(){this._refCount=0;let{_connection:e}=this;this._subject=this._connection=null,e?.unsubscribe()}connect(){let e=this._connection;if(!e){e=this._connection=new Pr;let t=this.getSubject();e.add(this.source.subscribe(li(t,void 0,()=>{this._teardown(),t.complete()},i=>{this._teardown(),t.error(i)},()=>this._teardown()))),e.closed&&(this._connection=null,e=Pr.EMPTY)}return e}refCount(){return Eu()(this)}};var iw=Tu(s=>function(){s(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});var Os=(()=>{class s extends Di{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(t){let i=new Og(this,this);return i.operator=t,i}_throwIfClosed(){if(this.closed)throw new iw}next(t){bu(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(let i of this.currentObservers)i.next(t)}})}error(t){bu(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=t;let{observers:i}=this;for(;i.length;)i.shift().error(t)}})}complete(){bu(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;let{observers:t}=this;for(;t.length;)t.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0}_trySubscribe(t){return this._throwIfClosed(),super._trySubscribe(t)}_subscribe(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)}_innerSubscribe(t){let{hasError:i,isStopped:r,observers:n}=this;return i||r?ny:(this.currentObservers=null,n.push(t),new Pr(()=>{this.currentObservers=null,Xf(n,t)}))}_checkFinalizedStatuses(t){let{hasError:i,thrownError:r,isStopped:n}=this;i?t.error(r):n&&t.complete()}asObservable(){let t=new Di;return t.source=this,t}}return s.create=(e,t)=>new Og(e,t),s})(),Og=class extends Os{constructor(e,t){super(),this.destination=e,this.source=t}next(e){var t,i;(i=(t=this.destination)===null||t===void 0?void 0:t.next)===null||i===void 0||i.call(t,e)}error(e){var t,i;(i=(t=this.destination)===null||t===void 0?void 0:t.error)===null||i===void 0||i.call(t,e)}complete(){var e,t;(t=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||t===void 0||t.call(e)}_subscribe(e){var t,i;return(i=(t=this.source)===null||t===void 0?void 0:t.subscribe(e))!==null&&i!==void 0?i:ny}};var is=class extends Os{constructor(e){super(),this._value=e}get value(){return this.getValue()}_subscribe(e){let t=super._subscribe(e);return!t.closed&&e.next(this._value),t}getValue(){let{hasError:e,thrownError:t,_value:i}=this;if(e)throw t;return this._throwIfClosed(),i}next(e){super.next(this._value=e)}};var on=new Di(s=>s.complete());function rw(s){return s&&Nt(s.schedule)}function sw(s){return s[s.length-1]}function nw(s){return Nt(sw(s))?s.pop():void 0}function Sl(s){return rw(sw(s))?s.pop():void 0}function aw(s,e,t,i){function r(n){return n instanceof t?n:new t(function(o){o(n)})}return new(t||(t=Promise))(function(n,o){function a(h){try{c(i.next(h))}catch(u){o(u)}}function l(h){try{c(i.throw(h))}catch(u){o(u)}}function c(h){h.done?n(h.value):r(h.value).then(a,l)}c((i=i.apply(s,e||[])).next())})}function ow(s){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&s[e],i=0;if(t)return t.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&i>=s.length&&(s=void 0),{value:s&&s[i++],done:!s}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Ac(s){return this instanceof Ac?(this.v=s,this):new Ac(s)}function lw(s,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(s,e||[]),r,n=[];return r={},a("next"),a("throw"),a("return",o),r[Symbol.asyncIterator]=function(){return this},r;function o(f){return function(m){return Promise.resolve(m).then(f,u)}}function a(f,m){i[f]&&(r[f]=function(g){return new Promise(function(_,x){n.push([f,g,_,x])>1||l(f,g)})},m&&(r[f]=m(r[f])))}function l(f,m){try{c(i[f](m))}catch(g){d(n[0][3],g)}}function c(f){f.value instanceof Ac?Promise.resolve(f.value.v).then(h,u):d(n[0][2],f)}function h(f){l("next",f)}function u(f){l("throw",f)}function d(f,m){f(m),n.shift(),n.length&&l(n[0][0],n[0][1])}}function cw(s){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=s[Symbol.asyncIterator],t;return e?e.call(s):(s=typeof ow=="function"?ow(s):s[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(n){t[n]=s[n]&&function(o){return new Promise(function(a,l){o=s[n](o),r(a,l,o.done,o.value)})}}function r(n,o,a,l){Promise.resolve(l).then(function(c){n({value:c,done:a})},o)}}var wg=s=>s&&typeof s.length=="number"&&typeof s!="function";function Ng(s){return Nt(s?.then)}function Fg(s){return Nt(s[yu])}function Lg(s){return Symbol.asyncIterator&&Nt(s?.[Symbol.asyncIterator])}function Bg(s){return new TypeError(`You provided ${s!==null&&typeof s=="object"?"an invalid object":`'${s}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}function B2(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Vg=B2();function Ug(s){return Nt(s?.[Vg])}function kg(s){return lw(this,arguments,function*(){let t=s.getReader();try{for(;;){let{value:i,done:r}=yield Ac(t.read());if(r)return yield Ac(void 0);yield yield Ac(i)}}finally{t.releaseLock()}})}function Gg(s){return Nt(s?.getReader)}function $r(s){if(s instanceof Di)return s;if(s!=null){if(Fg(s))return V2(s);if(wg(s))return U2(s);if(Ng(s))return k2(s);if(Lg(s))return hw(s);if(Ug(s))return G2(s);if(Gg(s))return z2(s)}throw Bg(s)}function V2(s){return new Di(e=>{let t=s[yu]();if(Nt(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function U2(s){return new Di(e=>{for(let t=0;t<s.length&&!e.closed;t++)e.next(s[t]);e.complete()})}function k2(s){return new Di(e=>{s.then(t=>{e.closed||(e.next(t),e.complete())},t=>e.error(t)).then(null,Mg)})}function G2(s){return new Di(e=>{for(let t of s)if(e.next(t),e.closed)return;e.complete()})}function hw(s){return new Di(e=>{W2(s,e).catch(t=>e.error(t))})}function z2(s){return hw(kg(s))}function W2(s,e){var t,i,r,n;return aw(this,void 0,void 0,function*(){try{for(t=cw(s);i=yield t.next(),!i.done;){let o=i.value;if(e.next(o),e.closed)return}}catch(o){r={error:o}}finally{try{i&&!i.done&&(n=t.return)&&(yield n.call(t))}finally{if(r)throw r.error}}e.complete()})}function Ws(s,e,t,i=0,r=!1){let n=e.schedule(function(){t(),r?s.add(this.schedule(null,i)):this.unsubscribe()},i);if(s.add(n),!r)return n}function zg(s,e=0){return ai((t,i)=>{t.subscribe(li(i,r=>Ws(i,s,()=>i.next(r),e),()=>Ws(i,s,()=>i.complete(),e),r=>Ws(i,s,()=>i.error(r),e)))})}function Wg(s,e=0){return ai((t,i)=>{i.add(s.schedule(()=>t.subscribe(i),e))})}function uw(s,e){return $r(s).pipe(Wg(e),zg(e))}function dw(s,e){return $r(s).pipe(Wg(e),zg(e))}function fw(s,e){return new Di(t=>{let i=0;return e.schedule(function(){i===s.length?t.complete():(t.next(s[i++]),t.closed||this.schedule())})})}function pw(s,e){return new Di(t=>{let i;return Ws(t,e,()=>{i=s[Vg](),Ws(t,e,()=>{let r,n;try{({value:r,done:n}=i.next())}catch(o){t.error(o);return}n?t.complete():t.next(r)},0,!0)}),()=>Nt(i?.return)&&i.return()})}function Hg(s,e){if(!s)throw new Error("Iterable cannot be null");return new Di(t=>{Ws(t,e,()=>{let i=s[Symbol.asyncIterator]();Ws(t,e,()=>{i.next().then(r=>{r.done?t.complete():t.next(r.value)})},0,!0)})})}function mw(s,e){return Hg(kg(s),e)}function gw(s,e){if(s!=null){if(Fg(s))return uw(s,e);if(wg(s))return fw(s,e);if(Ng(s))return dw(s,e);if(Lg(s))return Hg(s,e);if(Ug(s))return pw(s,e);if(Gg(s))return mw(s,e)}throw Bg(s)}function Mr(s,e){return e?gw(s,e):$r(s)}function Rt(...s){let e=Sl(s);return Mr(s,e)}function Iu(s,e){let t=Nt(s)?s:()=>s,i=r=>r.error(t());return new Di(e?r=>e.schedule(i,0,r):i)}function py(s){return!!s&&(s instanceof Di||Nt(s.lift)&&Nt(s.subscribe))}var La=Tu(s=>function(){s(this),this.name="EmptyError",this.message="no elements in sequence"});function ti(s,e){return ai((t,i)=>{let r=0;t.subscribe(li(i,n=>{i.next(s.call(e,n,r++))}))})}var{isArray:H2}=Array;function X2(s,e){return H2(e)?s(...e):s(e)}function _w(s){return ti(e=>X2(s,e))}var{isArray:Y2}=Array,{getPrototypeOf:$2,prototype:j2,keys:q2}=Object;function xw(s){if(s.length===1){let e=s[0];if(Y2(e))return{args:e,keys:null};if(Q2(e)){let t=q2(e);return{args:t.map(i=>e[i]),keys:t}}}return{args:s,keys:null}}function Q2(s){return s&&typeof s=="object"&&$2(s)===j2}function vw(s,e){return s.reduce((t,i,r)=>(t[i]=e[r],t),{})}function Xg(...s){let e=Sl(s),t=nw(s),{args:i,keys:r}=xw(s);if(i.length===0)return Mr([],e);let n=new Di(K2(i,e,r?o=>vw(r,o):nn));return t?n.pipe(_w(t)):n}function K2(s,e,t=nn){return i=>{Tw(e,()=>{let{length:r}=s,n=new Array(r),o=r,a=r;for(let l=0;l<r;l++)Tw(e,()=>{let c=Mr(s[l],e),h=!1;c.subscribe(li(i,u=>{n[l]=u,h||(h=!0,a--),a||i.next(t(n.slice()))},()=>{--o||i.complete()}))},i)},i)}}function Tw(s,e,t){s?Ws(t,s,e):e()}function Cw(s,e,t,i,r,n,o,a){let l=[],c=0,h=0,u=!1,d=()=>{u&&!l.length&&!c&&e.complete()},f=g=>c<i?m(g):l.push(g),m=g=>{n&&e.next(g),c++;let _=!1;$r(t(g,h++)).subscribe(li(e,x=>{r?.(x),n?f(x):e.next(x)},()=>{_=!0},void 0,()=>{if(_)try{for(c--;l.length&&c<i;){let x=l.shift();o?Ws(e,o,()=>m(x)):m(x)}d()}catch(x){e.error(x)}}))};return s.subscribe(li(e,f,()=>{u=!0,d()})),()=>{a?.()}}function Ur(s,e,t=1/0){return Nt(e)?Ur((i,r)=>ti((n,o)=>e(i,n,r,o))($r(s(i,r))),t):(typeof e=="number"&&(t=e),ai((i,r)=>Cw(i,r,s,t)))}function my(s=1/0){return Ur(nn,s)}function bw(){return my(1)}function Ru(...s){return bw()(Mr(s,Sl(s)))}function Yg(s){return new Di(e=>{$r(s()).subscribe(e)})}function wn(s,e){return ai((t,i)=>{let r=0;t.subscribe(li(i,n=>s.call(e,n,r++)&&i.next(n)))})}function yl(s){return ai((e,t)=>{let i=null,r=!1,n;i=e.subscribe(li(t,void 0,void 0,o=>{n=$r(s(o,yl(s)(e))),i?(i.unsubscribe(),i=null,n.subscribe(t)):r=!0})),r&&(i.unsubscribe(),i=null,n.subscribe(t))})}function Sw(s,e,t,i,r){return(n,o)=>{let a=t,l=e,c=0;n.subscribe(li(o,h=>{let u=c++;l=a?s(l,h,u):(a=!0,h),i&&o.next(l)},r&&(()=>{a&&o.next(l),o.complete()})))}}function Ic(s,e){return Nt(e)?Ur(s,e,1):Ur(s,1)}function El(s){return ai((e,t)=>{let i=!1;e.subscribe(li(t,r=>{i=!0,t.next(r)},()=>{i||t.next(s),t.complete()}))})}function Ba(s){return s<=0?()=>on:ai((e,t)=>{let i=0;e.subscribe(li(t,r=>{++i<=s&&(t.next(r),s<=i&&t.complete())}))})}function gy(s){return ti(()=>s)}function $g(s=Z2){return ai((e,t)=>{let i=!1;e.subscribe(li(t,r=>{i=!0,t.next(r)},()=>i?t.complete():t.error(s())))})}function Z2(){return new La}function Pu(s){return ai((e,t)=>{try{e.subscribe(t)}finally{t.add(s)}})}function uo(s,e){let t=arguments.length>=2;return i=>i.pipe(s?wn((r,n)=>s(r,n,i)):nn,Ba(1),t?El(e):$g(()=>new La))}function Mu(s){return s<=0?()=>on:ai((e,t)=>{let i=[];e.subscribe(li(t,r=>{i.push(r),s<i.length&&i.shift()},()=>{for(let r of i)t.next(r);t.complete()},void 0,()=>{i=null}))})}function _y(s,e){let t=arguments.length>=2;return i=>i.pipe(s?wn((r,n)=>s(r,n,i)):nn,Mu(1),t?El(e):$g(()=>new La))}function xy(s,e){return ai(Sw(s,e,arguments.length>=2,!0))}function vy(...s){let e=Sl(s);return ai((t,i)=>{(e?Ru(s,t,e):Ru(s,t)).subscribe(i)})}function Nn(s,e){return ai((t,i)=>{let r=null,n=0,o=!1,a=()=>o&&!r&&i.complete();t.subscribe(li(i,l=>{r?.unsubscribe();let c=0,h=n++;$r(s(l,h)).subscribe(r=li(i,u=>i.next(e?e(l,u,h,c++):u),()=>{r=null,a()}))},()=>{o=!0,a()}))})}function Ty(s){return ai((e,t)=>{$r(s).subscribe(li(t,()=>t.complete(),Yf)),!t.closed&&e.subscribe(t)})}function kr(s,e,t){let i=Nt(s)||e||t?{next:s,error:e,complete:t}:s;return i?ai((r,n)=>{var o;(o=i.subscribe)===null||o===void 0||o.call(i);let a=!0;r.subscribe(li(n,l=>{var c;(c=i.next)===null||c===void 0||c.call(i,l),n.next(l)},()=>{var l;a=!1,(l=i.complete)===null||l===void 0||l.call(i),n.complete()},l=>{var c;a=!1,(c=i.error)===null||c===void 0||c.call(i,l),n.error(l)},()=>{var l,c;a&&((l=i.unsubscribe)===null||l===void 0||l.call(i)),(c=i.finalize)===null||c===void 0||c.call(i)}))}):nn}var _t=class extends Error{constructor(e,t){super(C_(e,t)),this.code=e}};function C_(s,e){return`${`NG0${Math.abs(s)}`}${e?": "+e:""}`}function b_(s){return{toString:s}.toString()}var Oy=globalThis;function Gi(s){for(let e in s)if(s[e]===Gi)return e;throw Error("Could not find renamed property on target object.")}function an(s){if(typeof s=="string")return s;if(Array.isArray(s))return"["+s.map(an).join(", ")+"]";if(s==null)return""+s;if(s.overriddenName)return`${s.overriddenName}`;if(s.name)return`${s.name}`;let e=s.toString();if(e==null)return""+e;let t=e.indexOf(`
`);return t===-1?e:e.substring(0,t)}function yw(s,e){return s==null||s===""?e===null?"":e:e==null||e===""?s:s+" "+e}var J2=Gi({__forward_ref__:Gi});function oN(s){return s.__forward_ref__=oN,s.toString=function(){return an(this())},s}function Ln(s){return aN(s)?s():s}function aN(s){return typeof s=="function"&&s.hasOwnProperty(J2)&&s.__forward_ref__===oN}function Ft(s){return{token:s.token,providedIn:s.providedIn||null,factory:s.factory,value:void 0}}function S_(s){return{providers:s.providers||[],imports:s.imports||[]}}function y_(s){return Ew(s,cN)||Ew(s,hN)}function lN(s){return y_(s)!==null}function Ew(s,e){return s.hasOwnProperty(e)?s[e]:null}function eU(s){let e=s&&(s[cN]||s[hN]);return e||null}function Aw(s){return s&&(s.hasOwnProperty(Iw)||s.hasOwnProperty(tU))?s[Iw]:null}var cN=Gi({\u0275prov:Gi}),Iw=Gi({\u0275inj:Gi}),hN=Gi({ngInjectableDef:Gi}),tU=Gi({ngInjectorDef:Gi}),Pt=class{constructor(e,t){this._desc=e,this.ngMetadataName="InjectionToken",this.\u0275prov=void 0,typeof t=="number"?this.__NG_ELEMENT_ID__=t:t!==void 0&&(this.\u0275prov=Ft({token:this,providedIn:t.providedIn||"root",factory:t.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}};function uN(s){return s&&!!s.\u0275providers}var iU=Gi({\u0275cmp:Gi}),rU=Gi({\u0275dir:Gi}),sU=Gi({\u0275pipe:Gi}),nU=Gi({\u0275mod:Gi}),i_=Gi({\u0275fac:Gi}),$f=Gi({__NG_ELEMENT_ID__:Gi}),Rw=Gi({__NG_ENV_ID__:Gi});function oU(s){return typeof s=="string"?s:s==null?"":String(s)}function aU(s){return typeof s=="function"?s.name||s.toString():typeof s=="object"&&s!=null&&typeof s.type=="function"?s.type.name||s.type.toString():oU(s)}function lU(s,e){let t=e?`. Dependency path: ${e.join(" > ")} > ${s}`:"";throw new _t(-200,s)}function uE(s,e){throw new _t(-201,!1)}var Ht=function(s){return s[s.Default=0]="Default",s[s.Host=1]="Host",s[s.Self=2]="Self",s[s.SkipSelf=4]="SkipSelf",s[s.Optional=8]="Optional",s}(Ht||{}),wy;function dN(){return wy}function Fn(s){let e=wy;return wy=s,e}function fN(s,e,t){let i=y_(s);if(i&&i.providedIn=="root")return i.value===void 0?i.value=i.factory():i.value;if(t&Ht.Optional)return null;if(e!==void 0)return e;uE(s,"Injector")}var cU={},jf=cU,hU="__NG_DI_FLAG__",r_="ngTempTokenPath",uU="ngTokenPath",dU=/\n/gm,fU="\u0275",Pw="__source",Nu;function pU(){return Nu}function Al(s){let e=Nu;return Nu=s,e}function mU(s,e=Ht.Default){if(Nu===void 0)throw new _t(-203,!1);return Nu===null?fN(s,void 0,e):Nu.get(s,e&Ht.Optional?null:void 0,e)}function ni(s,e=Ht.Default){return(dN()||mU)(Ln(s),e)}function Ue(s,e=Ht.Default){return ni(s,E_(e))}function E_(s){return typeof s>"u"||typeof s=="number"?s:0|(s.optional&&8)|(s.host&&1)|(s.self&&2)|(s.skipSelf&&4)}function Ny(s){let e=[];for(let t=0;t<s.length;t++){let i=Ln(s[t]);if(Array.isArray(i)){if(i.length===0)throw new _t(900,!1);let r,n=Ht.Default;for(let o=0;o<i.length;o++){let a=i[o],l=gU(a);typeof l=="number"?l===-1?r=a.token:n|=l:r=a}e.push(ni(r,n))}else e.push(ni(i))}return e}function gU(s){return s[hU]}function _U(s,e,t,i){let r=s[r_];throw e[Pw]&&r.unshift(e[Pw]),s.message=xU(`
`+s.message,r,t,i),s[uU]=r,s[r_]=null,s}function xU(s,e,t,i=null){s=s&&s.charAt(0)===`
`&&s.charAt(1)==fU?s.slice(2):s;let r=an(e);if(Array.isArray(e))r=e.map(an).join(" -> ");else if(typeof e=="object"){let n=[];for(let o in e)if(e.hasOwnProperty(o)){let a=e[o];n.push(o+":"+(typeof a=="string"?JSON.stringify(a):an(a)))}r=`{${n.join(", ")}}`}return`${t}${i?"("+i+")":""}[${r}]: ${s.replace(dU,`
  `)}`}function Lu(s,e){let t=s.hasOwnProperty(i_);return t?s[i_]:null}function dE(s,e){s.forEach(t=>Array.isArray(t)?dE(t,e):e(t))}function pN(s,e,t){e>=s.length?s.push(t):s.splice(e,0,t)}function s_(s,e){return e>=s.length-1?s.pop():s.splice(e,1)[0]}var qf={},po=[],Mc=new Pt(""),mN=new Pt("",-1),gN=new Pt(""),n_=class{get(e,t=jf){if(t===jf){let i=new Error(`NullInjectorError: No provider for ${an(e)}!`);throw i.name="NullInjectorError",i}return t}},_N=function(s){return s[s.OnPush=0]="OnPush",s[s.Default=1]="Default",s}(_N||{}),Yo=function(s){return s[s.Emulated=0]="Emulated",s[s.None=2]="None",s[s.ShadowDom=3]="ShadowDom",s}(Yo||{}),Bu=function(s){return s[s.None=0]="None",s[s.SignalBased=1]="SignalBased",s[s.HasDecoratorInputTransform=2]="HasDecoratorInputTransform",s}(Bu||{});function vU(s,e,t){let i=s.length;for(;;){let r=s.indexOf(e,t);if(r===-1)return r;if(r===0||s.charCodeAt(r-1)<=32){let n=e.length;if(r+n===i||s.charCodeAt(r+n)<=32)return r}t=r+1}}function Fy(s,e,t){let i=0;for(;i<t.length;){let r=t[i];if(typeof r=="number"){if(r!==0)break;i++;let n=t[i++],o=t[i++],a=t[i++];s.setAttribute(e,o,a,n)}else{let n=r,o=t[++i];CU(n)?s.setProperty(e,n,o):s.setAttribute(e,n,o),i++}}return i}function TU(s){return s===3||s===4||s===6}function CU(s){return s.charCodeAt(0)===64}function fE(s,e){if(!(e===null||e.length===0))if(s===null||s.length===0)s=e.slice();else{let t=-1;for(let i=0;i<e.length;i++){let r=e[i];typeof r=="number"?t=r:t===0||(t===-1||t===2?Mw(s,t,r,null,e[++i]):Mw(s,t,r,null,null))}}return s}function Mw(s,e,t,i,r){let n=0,o=s.length;if(e===-1)o=-1;else for(;n<s.length;){let a=s[n++];if(typeof a=="number"){if(a===e){o=-1;break}else if(a>e){o=n-1;break}}}for(;n<s.length;){let a=s[n];if(typeof a=="number")break;if(a===t){if(i===null){r!==null&&(s[n+1]=r);return}else if(i===s[n+1]){s[n+2]=r;return}}n++,i!==null&&n++,r!==null&&n++}o!==-1&&(s.splice(o,0,e),n=o+1),s.splice(n++,0,t),i!==null&&s.splice(n++,0,i),r!==null&&s.splice(n++,0,r)}var xN="ng-template";function bU(s,e,t,i){let r=0;if(i){for(;r<e.length&&typeof e[r]=="string";r+=2)if(e[r]==="class"&&vU(e[r+1].toLowerCase(),t,0)!==-1)return!0}else if(pE(s))return!1;if(r=e.indexOf(1,r),r>-1){let n;for(;++r<e.length&&typeof(n=e[r])=="string";)if(n.toLowerCase()===t)return!0}return!1}function pE(s){return s.type===4&&s.value!==xN}function SU(s,e,t){let i=s.type===4&&!t?xN:s.value;return e===i}function yU(s,e,t){let i=4,r=s.attrs,n=r!==null?IU(r):0,o=!1;for(let a=0;a<e.length;a++){let l=e[a];if(typeof l=="number"){if(!o&&!fo(i)&&!fo(l))return!1;if(o&&fo(l))continue;o=!1,i=l|i&1;continue}if(!o)if(i&4){if(i=2|i&1,l!==""&&!SU(s,l,t)||l===""&&e.length===1){if(fo(i))return!1;o=!0}}else if(i&8){if(r===null||!bU(s,r,l,t)){if(fo(i))return!1;o=!0}}else{let c=e[++a],h=EU(l,r,pE(s),t);if(h===-1){if(fo(i))return!1;o=!0;continue}if(c!==""){let u;if(h>n?u="":u=r[h+1].toLowerCase(),i&2&&c!==u){if(fo(i))return!1;o=!0}}}}return fo(i)||o}function fo(s){return(s&1)===0}function EU(s,e,t,i){if(e===null)return-1;let r=0;if(i||!t){let n=!1;for(;r<e.length;){let o=e[r];if(o===s)return r;if(o===3||o===6)n=!0;else if(o===1||o===2){let a=e[++r];for(;typeof a=="string";)a=e[++r];continue}else{if(o===4)break;if(o===0){r+=4;continue}}r+=n?1:2}return-1}else return RU(e,s)}function AU(s,e,t=!1){for(let i=0;i<e.length;i++)if(yU(s,e[i],t))return!0;return!1}function IU(s){for(let e=0;e<s.length;e++){let t=s[e];if(TU(t))return e}return s.length}function RU(s,e){let t=s.indexOf(4);if(t>-1)for(t++;t<s.length;){let i=s[t];if(typeof i=="number")return-1;if(i===e)return t;t++}return-1}function Dw(s,e){return s?":not("+e.trim()+")":e}function PU(s){let e=s[0],t=1,i=2,r="",n=!1;for(;t<s.length;){let o=s[t];if(typeof o=="string")if(i&2){let a=s[++t];r+="["+o+(a.length>0?'="'+a+'"':"")+"]"}else i&8?r+="."+o:i&4&&(r+=" "+o);else r!==""&&!fo(o)&&(e+=Dw(n,r),r=""),i=o,n=n||!fo(i);t++}return r!==""&&(e+=Dw(n,r)),e}function MU(s){return s.map(PU).join(",")}function DU(s){let e=[],t=[],i=1,r=2;for(;i<s.length;){let n=s[i];if(typeof n=="string")r===2?n!==""&&e.push(n,s[++i]):r===8&&t.push(n);else{if(!fo(r))break;r=n}i++}return{attrs:e,classes:t}}function Wu(s){return b_(()=>{let e=SN(s),t=Kt(ie({},e),{decls:s.decls,vars:s.vars,template:s.template,consts:s.consts||null,ngContentSelectors:s.ngContentSelectors,onPush:s.changeDetection===_N.OnPush,directiveDefs:null,pipeDefs:null,dependencies:e.standalone&&s.dependencies||null,getStandaloneInjector:null,signals:s.signals??!1,data:s.data||{},encapsulation:s.encapsulation||Yo.Emulated,styles:s.styles||po,_:null,schemas:s.schemas||null,tView:null,id:""});yN(t);let i=s.dependencies;return t.directiveDefs=ww(i,!1),t.pipeDefs=ww(i,!0),t.id=NU(t),t})}function OU(s){return Dc(s)||vN(s)}function wU(s){return s!==null}function A_(s){return b_(()=>({type:s.type,bootstrap:s.bootstrap||po,declarations:s.declarations||po,imports:s.imports||po,exports:s.exports||po,transitiveCompileScopes:null,schemas:s.schemas||null,id:s.id||null}))}function Ow(s,e){if(s==null)return qf;let t={};for(let i in s)if(s.hasOwnProperty(i)){let r=s[i],n,o,a=Bu.None;Array.isArray(r)?(a=r[0],n=r[1],o=r[2]??n):(n=r,o=r),e?(t[n]=a!==Bu.None?[i,a]:i,e[n]=o):t[n]=i}return t}function mE(s){return b_(()=>{let e=SN(s);return yN(e),e})}function Dc(s){return s[iU]||null}function vN(s){return s[rU]||null}function TN(s){return s[sU]||null}function CN(s){let e=Dc(s)||vN(s)||TN(s);return e!==null?e.standalone:!1}function bN(s,e){let t=s[nU]||null;if(!t&&e===!0)throw new Error(`Type ${an(s)} does not have '\u0275mod' property.`);return t}function SN(s){let e={};return{type:s.type,providersResolver:null,factory:null,hostBindings:s.hostBindings||null,hostVars:s.hostVars||0,hostAttrs:s.hostAttrs||null,contentQueries:s.contentQueries||null,declaredInputs:e,inputTransforms:null,inputConfig:s.inputs||qf,exportAs:s.exportAs||null,standalone:s.standalone===!0,signals:s.signals===!0,selectors:s.selectors||po,viewQuery:s.viewQuery||null,features:s.features||null,setInput:null,findHostDirectiveDefs:null,hostDirectives:null,inputs:Ow(s.inputs,e),outputs:Ow(s.outputs),debugInfo:null}}function yN(s){s.features?.forEach(e=>e(s))}function ww(s,e){if(!s)return null;let t=e?TN:OU;return()=>(typeof s=="function"?s():s).map(i=>t(i)).filter(wU)}function NU(s){let e=0,t=[s.selectors,s.ngContentSelectors,s.hostVars,s.hostAttrs,s.consts,s.vars,s.decls,s.encapsulation,s.standalone,s.signals,s.exportAs,JSON.stringify(s.inputs),JSON.stringify(s.outputs),Object.getOwnPropertyNames(s.type.prototype),!!s.contentQueries,!!s.viewQuery].join("|");for(let r of t)e=Math.imul(31,e)+r.charCodeAt(0)<<0;return e+=2147483648,"c"+e}function Nc(s){return{\u0275providers:s}}function FU(...s){return{\u0275providers:EN(!0,s),\u0275fromNgModule:!0}}function EN(s,...e){let t=[],i=new Set,r,n=o=>{t.push(o)};return dE(e,o=>{let a=o;Ly(a,n,[],i)&&(r||=[],r.push(a))}),r!==void 0&&AN(r,n),t}function AN(s,e){for(let t=0;t<s.length;t++){let{ngModule:i,providers:r}=s[t];gE(r,n=>{e(n,i)})}}function Ly(s,e,t,i){if(s=Ln(s),!s)return!1;let r=null,n=Aw(s),o=!n&&Dc(s);if(!n&&!o){let l=s.ngModule;if(n=Aw(l),n)r=l;else return!1}else{if(o&&!o.standalone)return!1;r=s}let a=i.has(r);if(o){if(a)return!1;if(i.add(r),o.dependencies){let l=typeof o.dependencies=="function"?o.dependencies():o.dependencies;for(let c of l)Ly(c,e,t,i)}}else if(n){if(n.imports!=null&&!a){i.add(r);let c;try{dE(n.imports,h=>{Ly(h,e,t,i)&&(c||=[],c.push(h))})}finally{}c!==void 0&&AN(c,e)}if(!a){let c=Lu(r)||(()=>new r);e({provide:r,useFactory:c,deps:po},r),e({provide:gN,useValue:r,multi:!0},r),e({provide:Mc,useValue:()=>ni(r),multi:!0},r)}let l=n.providers;if(l!=null&&!a){let c=s;gE(l,h=>{e(h,c)})}}else return!1;return r!==s&&s.providers!==void 0}function gE(s,e){for(let t of s)uN(t)&&(t=t.\u0275providers),Array.isArray(t)?gE(t,e):e(t)}var LU=Gi({provide:String,useValue:Gi});function IN(s){return s!==null&&typeof s=="object"&&LU in s}function BU(s){return!!(s&&s.useExisting)}function VU(s){return!!(s&&s.useFactory)}function By(s){return typeof s=="function"}var I_=new Pt(""),Kg={},UU={},Cy;function _E(){return Cy===void 0&&(Cy=new n_),Cy}var Vn=class{},Qf=class extends Vn{get destroyed(){return this._destroyed}constructor(e,t,i,r){super(),this.parent=t,this.source=i,this.scopes=r,this.records=new Map,this._ngOnDestroyHooks=new Set,this._onDestroyHooks=[],this._destroyed=!1,Uy(e,o=>this.processProvider(o)),this.records.set(mN,Du(void 0,this)),r.has("environment")&&this.records.set(Vn,Du(void 0,this));let n=this.records.get(I_);n!=null&&typeof n.value=="string"&&this.scopes.add(n.value),this.injectorDefTypes=new Set(this.get(gN,po,Ht.Self))}destroy(){this.assertNotDestroyed(),this._destroyed=!0;let e=ki(null);try{for(let i of this._ngOnDestroyHooks)i.ngOnDestroy();let t=this._onDestroyHooks;this._onDestroyHooks=[];for(let i of t)i()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear(),ki(e)}}onDestroy(e){return this.assertNotDestroyed(),this._onDestroyHooks.push(e),()=>this.removeOnDestroy(e)}runInContext(e){this.assertNotDestroyed();let t=Al(this),i=Fn(void 0),r;try{return e()}finally{Al(t),Fn(i)}}get(e,t=jf,i=Ht.Default){if(this.assertNotDestroyed(),e.hasOwnProperty(Rw))return e[Rw](this);i=E_(i);let r,n=Al(this),o=Fn(void 0);try{if(!(i&Ht.SkipSelf)){let l=this.records.get(e);if(l===void 0){let c=XU(e)&&y_(e);c&&this.injectableDefInScope(c)?l=Du(Vy(e),Kg):l=null,this.records.set(e,l)}if(l!=null)return this.hydrate(e,l)}let a=i&Ht.Self?_E():this.parent;return t=i&Ht.Optional&&t===jf?null:t,a.get(e,t)}catch(a){if(a.name==="NullInjectorError"){if((a[r_]=a[r_]||[]).unshift(an(e)),n)throw a;return _U(a,e,"R3InjectorError",this.source)}else throw a}finally{Fn(o),Al(n)}}resolveInjectorInitializers(){let e=ki(null),t=Al(this),i=Fn(void 0),r;try{let n=this.get(Mc,po,Ht.Self);for(let o of n)o()}finally{Al(t),Fn(i),ki(e)}}toString(){let e=[],t=this.records;for(let i of t.keys())e.push(an(i));return`R3Injector[${e.join(", ")}]`}assertNotDestroyed(){if(this._destroyed)throw new _t(205,!1)}processProvider(e){e=Ln(e);let t=By(e)?e:Ln(e&&e.provide),i=GU(e);if(!By(e)&&e.multi===!0){let r=this.records.get(t);r||(r=Du(void 0,Kg,!0),r.factory=()=>Ny(r.multi),this.records.set(t,r)),t=e,r.multi.push(e)}this.records.set(t,i)}hydrate(e,t){let i=ki(null);try{return t.value===Kg&&(t.value=UU,t.value=t.factory()),typeof t.value=="object"&&t.value&&HU(t.value)&&this._ngOnDestroyHooks.add(t.value),t.value}finally{ki(i)}}injectableDefInScope(e){if(!e.providedIn)return!1;let t=Ln(e.providedIn);return typeof t=="string"?t==="any"||this.scopes.has(t):this.injectorDefTypes.has(t)}removeOnDestroy(e){let t=this._onDestroyHooks.indexOf(e);t!==-1&&this._onDestroyHooks.splice(t,1)}};function Vy(s){let e=y_(s),t=e!==null?e.factory:Lu(s);if(t!==null)return t;if(s instanceof Pt)throw new _t(204,!1);if(s instanceof Function)return kU(s);throw new _t(204,!1)}function kU(s){if(s.length>0)throw new _t(204,!1);let t=eU(s);return t!==null?()=>t.factory(s):()=>new s}function GU(s){if(IN(s))return Du(void 0,s.useValue);{let e=zU(s);return Du(e,Kg)}}function zU(s,e,t){let i;if(By(s)){let r=Ln(s);return Lu(r)||Vy(r)}else if(IN(s))i=()=>Ln(s.useValue);else if(VU(s))i=()=>s.useFactory(...Ny(s.deps||[]));else if(BU(s))i=()=>ni(Ln(s.useExisting));else{let r=Ln(s&&(s.useClass||s.provide));if(WU(s))i=()=>new r(...Ny(s.deps));else return Lu(r)||Vy(r)}return i}function Du(s,e,t=!1){return{factory:s,value:e,multi:t?[]:void 0}}function WU(s){return!!s.deps}function HU(s){return s!==null&&typeof s=="object"&&typeof s.ngOnDestroy=="function"}function XU(s){return typeof s=="function"||typeof s=="object"&&s instanceof Pt}function Uy(s,e){for(let t of s)Array.isArray(t)?Uy(t,e):t&&uN(t)?Uy(t.\u0275providers,e):e(t)}function qo(s,e){s instanceof Qf&&s.assertNotDestroyed();let t,i=Al(s),r=Fn(void 0);try{return e()}finally{Al(i),Fn(r)}}function YU(){return dN()!==void 0||pU()!=null}function $U(s){return typeof s=="function"}var cn=0,Zt=1,Lt=2,hs=3,mo=4,go=5,$o=6,Nw=7,Pl=8,Vu=9,Ua=10,us=11,Kf=12,Fw=13,op=14,Un=15,Zf=16,Ou=17,R_=18,P_=19,RN=20,Rl=21,by=22,Bn=23,kn=25,PN=1,Jf=6,ka=7,o_=8,a_=9,ln=10,l_=function(s){return s[s.None=0]="None",s[s.HasTransplantedViews=2]="HasTransplantedViews",s}(l_||{});function Va(s){return Array.isArray(s)&&typeof s[PN]=="object"}function Qo(s){return Array.isArray(s)&&s[PN]===!0}function MN(s){return(s.flags&4)!==0}function M_(s){return s.componentOffset>-1}function jU(s){return(s.flags&1)===1}function ap(s){return!!s.template}function c_(s){return(s[Lt]&512)!==0}var ky=class{constructor(e,t,i){this.previousValue=e,this.currentValue=t,this.firstChange=i}isFirstChange(){return this.firstChange}};function DN(s,e,t,i){e!==null?e.applyValueToInputSignal(e,i):s[t]=i}function D_(){return ON}function ON(s){return s.type.prototype.ngOnChanges&&(s.setInput=QU),qU}D_.ngInherit=!0;function qU(){let s=NN(this),e=s?.current;if(e){let t=s.previous;if(t===qf)s.previous=e;else for(let i in e)t[i]=e[i];s.current=null,this.ngOnChanges(e)}}function QU(s,e,t,i,r){let n=this.declaredInputs[i],o=NN(s)||KU(s,{previous:qf,current:null}),a=o.current||(o.current={}),l=o.previous,c=l[n];a[n]=new ky(c&&c.currentValue,t,l===qf),DN(s,e,r,t)}var wN="__ngSimpleChanges__";function NN(s){return s[wN]||null}function KU(s,e){return s[wN]=e}var Lw=null;var Il=function(s,e,t){Lw?.(s,e,t)},ZU="svg",JU="math";function Ga(s){for(;Array.isArray(s);)s=s[cn];return s}function Ko(s,e){return Ga(e[s.index])}function ek(s,e){return s.data[e]}function lp(s,e){let t=e[s];return Va(t)?t:t[cn]}function xE(s){return(s[Lt]&128)===128}function tk(s){return Qo(s[hs])}function Bw(s,e){return e==null?null:s[e]}function FN(s){s[Ou]=0}function LN(s){s[Lt]&1024||(s[Lt]|=1024,xE(s)&&O_(s))}function ep(s){return!!(s[Lt]&9216||s[Bn]?.dirty)}function Gy(s){s[Ua].changeDetectionScheduler?.notify(7),s[Lt]&64&&(s[Lt]|=1024),ep(s)&&O_(s)}function O_(s){s[Ua].changeDetectionScheduler?.notify(0);let e=Oc(s);for(;e!==null&&!(e[Lt]&8192||(e[Lt]|=8192,!xE(e)));)e=Oc(e)}function BN(s,e){if((s[Lt]&256)===256)throw new _t(911,!1);s[Rl]===null&&(s[Rl]=[]),s[Rl].push(e)}function ik(s,e){if(s[Rl]===null)return;let t=s[Rl].indexOf(e);t!==-1&&s[Rl].splice(t,1)}function Oc(s){let e=s[hs];return Qo(e)?e[hs]:e}var Oi={lFrame:$N(null),bindingsEnabled:!0,skipHydrationRootTNode:null};var VN=!1;function rk(){return Oi.lFrame.elementDepthCount}function sk(){Oi.lFrame.elementDepthCount++}function nk(){Oi.lFrame.elementDepthCount--}function UN(){return Oi.bindingsEnabled}function cp(){return Oi.skipHydrationRootTNode!==null}function ok(s){return Oi.skipHydrationRootTNode===s}function ak(s){Oi.skipHydrationRootTNode=s}function lk(){Oi.skipHydrationRootTNode=null}function jo(){return Oi.lFrame.lView}function kN(){return Oi.lFrame.tView}function Ha(){let s=GN();for(;s!==null&&s.type===64;)s=s.parent;return s}function GN(){return Oi.lFrame.currentTNode}function ck(){let s=Oi.lFrame,e=s.currentTNode;return s.isParent?e:e.parent}function vE(s,e){let t=Oi.lFrame;t.currentTNode=s,t.isParent=e}function zN(){return Oi.lFrame.isParent}function hk(){Oi.lFrame.isParent=!1}function WN(){return VN}function Vw(s){VN=s}function uk(s){return Oi.lFrame.bindingIndex=s}function dk(){return Oi.lFrame.inI18n}function fk(s,e){let t=Oi.lFrame;t.bindingIndex=t.bindingRootIndex=s,zy(e)}function pk(){return Oi.lFrame.currentDirectiveIndex}function zy(s){Oi.lFrame.currentDirectiveIndex=s}function HN(s){Oi.lFrame.currentQueryIndex=s}function mk(s){let e=s[Zt];return e.type===2?e.declTNode:e.type===1?s[go]:null}function XN(s,e,t){if(t&Ht.SkipSelf){let r=e,n=s;for(;r=r.parent,r===null&&!(t&Ht.Host);)if(r=mk(n),r===null||(n=n[op],r.type&10))break;if(r===null)return!1;e=r,s=n}let i=Oi.lFrame=YN();return i.currentTNode=e,i.lView=s,!0}function TE(s){let e=YN(),t=s[Zt];Oi.lFrame=e,e.currentTNode=t.firstChild,e.lView=s,e.tView=t,e.contextLView=s,e.bindingIndex=t.bindingStartIndex,e.inI18n=!1}function YN(){let s=Oi.lFrame,e=s===null?null:s.child;return e===null?$N(s):e}function $N(s){let e={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:s,child:null,inI18n:!1};return s!==null&&(s.child=e),e}function jN(){let s=Oi.lFrame;return Oi.lFrame=s.parent,s.currentTNode=null,s.lView=null,s}var qN=jN;function CE(){let s=jN();s.isParent=!0,s.tView=null,s.selectedIndex=-1,s.contextLView=null,s.elementDepthCount=0,s.currentDirectiveIndex=-1,s.currentNamespace=null,s.bindingRootIndex=-1,s.bindingIndex=-1,s.currentQueryIndex=0}function gk(){return Oi.lFrame.selectedIndex}function wc(s){Oi.lFrame.selectedIndex=s}function QN(){return Oi.lFrame.currentNamespace}var KN=!0;function _k(){return KN}function Dl(s){KN=s}function xk(s,e,t){let{ngOnChanges:i,ngOnInit:r,ngDoCheck:n}=e.type.prototype;if(i){let o=ON(e);(t.preOrderHooks??=[]).push(s,o),(t.preOrderCheckHooks??=[]).push(s,o)}r&&(t.preOrderHooks??=[]).push(0-s,r),n&&((t.preOrderHooks??=[]).push(s,n),(t.preOrderCheckHooks??=[]).push(s,n))}function ZN(s,e){for(let t=e.directiveStart,i=e.directiveEnd;t<i;t++){let n=s.data[t].type.prototype,{ngAfterContentInit:o,ngAfterContentChecked:a,ngAfterViewInit:l,ngAfterViewChecked:c,ngOnDestroy:h}=n;o&&(s.contentHooks??=[]).push(-t,o),a&&((s.contentHooks??=[]).push(t,a),(s.contentCheckHooks??=[]).push(t,a)),l&&(s.viewHooks??=[]).push(-t,l),c&&((s.viewHooks??=[]).push(t,c),(s.viewCheckHooks??=[]).push(t,c)),h!=null&&(s.destroyHooks??=[]).push(t,h)}}function Zg(s,e,t){JN(s,e,3,t)}function Jg(s,e,t,i){(s[Lt]&3)===t&&JN(s,e,t,i)}function Sy(s,e){let t=s[Lt];(t&3)===e&&(t&=16383,t+=1,s[Lt]=t)}function JN(s,e,t,i){let r=i!==void 0?s[Ou]&65535:0,n=i??-1,o=e.length-1,a=0;for(let l=r;l<o;l++)if(typeof e[l+1]=="number"){if(a=e[l],i!=null&&a>=i)break}else e[l]<0&&(s[Ou]+=65536),(a<n||n==-1)&&(vk(s,t,e,l),s[Ou]=(s[Ou]&4294901760)+l+2),l++}function Uw(s,e){Il(4,s,e);let t=ki(null);try{e.call(s)}finally{ki(t),Il(5,s,e)}}function vk(s,e,t,i){let r=t[i]<0,n=t[i+1],o=r?-t[i]:t[i],a=s[o];r?s[Lt]>>14<s[Ou]>>16&&(s[Lt]&3)===e&&(s[Lt]+=16384,Uw(a,n)):Uw(a,n)}var Fu=-1,tp=class{constructor(e,t,i){this.factory=e,this.resolving=!1,this.canSeeViewProviders=t,this.injectImpl=i}};function Tk(s){return s instanceof tp}function Ck(s){return(s.flags&8)!==0}function bk(s){return(s.flags&16)!==0}var yy={},Wy=class{constructor(e,t){this.injector=e,this.parentInjector=t}get(e,t,i){i=E_(i);let r=this.injector.get(e,yy,i);return r!==yy||t===yy?r:this.parentInjector.get(e,t,i)}};function eF(s){return s!==Fu}function h_(s){return s&32767}function Sk(s){return s>>16}function u_(s,e){let t=Sk(s),i=e;for(;t>0;)i=i[op],t--;return i}var Hy=!0;function kw(s){let e=Hy;return Hy=s,e}var yk=256,tF=yk-1,iF=5,Ek=0,Xo={};function Ak(s,e,t){let i;typeof t=="string"?i=t.charCodeAt(0)||0:t.hasOwnProperty($f)&&(i=t[$f]),i==null&&(i=t[$f]=Ek++);let r=i&tF,n=1<<r;e.data[s+(r>>iF)]|=n}function rF(s,e){let t=sF(s,e);if(t!==-1)return t;let i=e[Zt];i.firstCreatePass&&(s.injectorIndex=e.length,Ey(i.data,s),Ey(e,null),Ey(i.blueprint,null));let r=bE(s,e),n=s.injectorIndex;if(eF(r)){let o=h_(r),a=u_(r,e),l=a[Zt].data;for(let c=0;c<8;c++)e[n+c]=a[o+c]|l[o+c]}return e[n+8]=r,n}function Ey(s,e){s.push(0,0,0,0,0,0,0,0,e)}function sF(s,e){return s.injectorIndex===-1||s.parent&&s.parent.injectorIndex===s.injectorIndex||e[s.injectorIndex+8]===null?-1:s.injectorIndex}function bE(s,e){if(s.parent&&s.parent.injectorIndex!==-1)return s.parent.injectorIndex;let t=0,i=null,r=e;for(;r!==null;){if(i=cF(r),i===null)return Fu;if(t++,r=r[op],i.injectorIndex!==-1)return i.injectorIndex|t<<16}return Fu}function Ik(s,e,t){Ak(s,e,t)}function nF(s,e,t){if(t&Ht.Optional||s!==void 0)return s;uE(e,"NodeInjector")}function oF(s,e,t,i){if(t&Ht.Optional&&i===void 0&&(i=null),!(t&(Ht.Self|Ht.Host))){let r=s[Vu],n=Fn(void 0);try{return r?r.get(e,i,t&Ht.Optional):fN(e,i,t&Ht.Optional)}finally{Fn(n)}}return nF(i,e,t)}function aF(s,e,t,i=Ht.Default,r){if(s!==null){if(e[Lt]&2048&&!(i&Ht.Self)){let o=Ok(s,e,t,i,Xo);if(o!==Xo)return o}let n=lF(s,e,t,i,Xo);if(n!==Xo)return n}return oF(e,t,i,r)}function lF(s,e,t,i,r){let n=Mk(t);if(typeof n=="function"){if(!XN(e,s,i))return i&Ht.Host?nF(r,t,i):oF(e,t,i,r);try{let o;if(o=n(i),o==null&&!(i&Ht.Optional))uE(t);else return o}finally{qN()}}else if(typeof n=="number"){let o=null,a=sF(s,e),l=Fu,c=i&Ht.Host?e[Un][go]:null;for((a===-1||i&Ht.SkipSelf)&&(l=a===-1?bE(s,e):e[a+8],l===Fu||!zw(i,!1)?a=-1:(o=e[Zt],a=h_(l),e=u_(l,e)));a!==-1;){let h=e[Zt];if(Gw(n,a,h.data)){let u=Rk(a,e,t,o,i,c);if(u!==Xo)return u}l=e[a+8],l!==Fu&&zw(i,e[Zt].data[a+8]===c)&&Gw(n,a,e)?(o=h,a=h_(l),e=u_(l,e)):a=-1}}return r}function Rk(s,e,t,i,r,n){let o=e[Zt],a=o.data[s+8],l=i==null?M_(a)&&Hy:i!=o&&(a.type&3)!==0,c=r&Ht.Host&&n===a,h=Pk(a,o,t,l,c);return h!==null?ip(e,o,h,a):Xo}function Pk(s,e,t,i,r){let n=s.providerIndexes,o=e.data,a=n&1048575,l=s.directiveStart,c=s.directiveEnd,h=n>>20,u=i?a:a+h,d=r?a+h:c;for(let f=u;f<d;f++){let m=o[f];if(f<l&&t===m||f>=l&&m.type===t)return f}if(r){let f=o[l];if(f&&ap(f)&&f.type===t)return l}return null}function ip(s,e,t,i){let r=s[t],n=e.data;if(Tk(r)){let o=r;o.resolving&&lU(aU(n[t]));let a=kw(o.canSeeViewProviders);o.resolving=!0;let l,c=o.injectImpl?Fn(o.injectImpl):null,h=XN(s,i,Ht.Default);try{r=s[t]=o.factory(void 0,n,s,i),e.firstCreatePass&&t>=i.directiveStart&&xk(t,n[t],e)}finally{c!==null&&Fn(c),kw(a),o.resolving=!1,qN()}}return r}function Mk(s){if(typeof s=="string")return s.charCodeAt(0)||0;let e=s.hasOwnProperty($f)?s[$f]:void 0;return typeof e=="number"?e>=0?e&tF:Dk:e}function Gw(s,e,t){let i=1<<s;return!!(t[e+(s>>iF)]&i)}function zw(s,e){return!(s&Ht.Self)&&!(s&Ht.Host&&e)}var Pc=class{constructor(e,t){this._tNode=e,this._lView=t}get(e,t,i){return aF(this._tNode,this._lView,e,E_(i),t)}};function Dk(){return new Pc(Ha(),jo())}function SE(s){return b_(()=>{let e=s.prototype.constructor,t=e[i_]||Xy(e),i=Object.prototype,r=Object.getPrototypeOf(s.prototype).constructor;for(;r&&r!==i;){let n=r[i_]||Xy(r);if(n&&n!==t)return n;r=Object.getPrototypeOf(r)}return n=>new n})}function Xy(s){return aN(s)?()=>{let e=Xy(Ln(s));return e&&e()}:Lu(s)}function Ok(s,e,t,i,r){let n=s,o=e;for(;n!==null&&o!==null&&o[Lt]&2048&&!(o[Lt]&512);){let a=lF(n,o,t,i|Ht.Self,Xo);if(a!==Xo)return a;let l=n.parent;if(!l){let c=o[RN];if(c){let h=c.get(t,Xo,i);if(h!==Xo)return h}l=cF(o),o=o[op]}n=l}return r}function cF(s){let e=s[Zt],t=e.type;return t===2?e.declTNode:t===1?s[go]:null}function Ww(s,e=null,t=null,i){let r=hF(s,e,t,i);return r.resolveInjectorInitializers(),r}function hF(s,e=null,t=null,i,r=new Set){let n=[t||po,FU(s)];return i=i||(typeof s=="object"?void 0:an(s)),new Qf(n,e||_E(),i||null,r)}var Rc=class Rc{static create(e,t){if(Array.isArray(e))return Ww({name:""},t,e,"");{let i=e.name??"";return Ww({name:i},e.parent,e.providers,i)}}};Rc.THROW_IF_NOT_FOUND=jf,Rc.NULL=new n_,Rc.\u0275prov=Ft({token:Rc,providedIn:"any",factory:()=>ni(mN)}),Rc.__NG_ELEMENT_ID__=-1;var za=Rc;var wk=new Pt("");wk.__NG_ELEMENT_ID__=s=>{let e=Ha();if(e===null)throw new _t(204,!1);if(e.type&2)return e.value;if(s&Ht.Optional)return null;throw new _t(204,!1)};var Nk="ngOriginalError";function Ay(s){return s[Nk]}var Wa=class{constructor(){this._console=console}handleError(e){let t=this._findOriginalError(e);this._console.error("ERROR",e),t&&this._console.error("ORIGINAL ERROR",t)}_findOriginalError(e){let t=e&&Ay(e);for(;t&&Ay(t);)t=Ay(t);return t||null}},uF=new Pt("",{providedIn:"root",factory:()=>Ue(Wa).handleError.bind(void 0)}),dF=(()=>{let e=class e{};e.__NG_ELEMENT_ID__=Fk,e.__NG_ENV_ID__=i=>i;let s=e;return s})(),Yy=class extends dF{constructor(e){super(),this._lView=e}onDestroy(e){return BN(this._lView,e),()=>ik(this._lView,e)}};function Fk(){return new Yy(jo())}function Lk(){return yE(Ha(),jo())}function yE(s,e){return new w_(Ko(s,e))}var w_=(()=>{let e=class e{constructor(i){this.nativeElement=i}};e.__NG_ELEMENT_ID__=Lk;let s=e;return s})();var Fc=(()=>{let e=class e{constructor(){this.taskId=0,this.pendingTasks=new Set,this.hasPendingTasks=new is(!1)}get _hasPendingTasks(){return this.hasPendingTasks.value}add(){this._hasPendingTasks||this.hasPendingTasks.next(!0);let i=this.taskId++;return this.pendingTasks.add(i),i}remove(i){this.pendingTasks.delete(i),this.pendingTasks.size===0&&this._hasPendingTasks&&this.hasPendingTasks.next(!1)}ngOnDestroy(){this.pendingTasks.clear(),this._hasPendingTasks&&this.hasPendingTasks.next(!1)}};e.\u0275prov=Ft({token:e,providedIn:"root",factory:()=>new e});let s=e;return s})();var $y=class extends Os{constructor(e=!1){super(),this.destroyRef=void 0,this.pendingTasks=void 0,this.__isAsync=e,YU()&&(this.destroyRef=Ue(dF,{optional:!0})??void 0,this.pendingTasks=Ue(Fc,{optional:!0})??void 0)}emit(e){let t=ki(null);try{super.next(e)}finally{ki(t)}}subscribe(e,t,i){let r=e,n=t||(()=>null),o=i;if(e&&typeof e=="object"){let l=e;r=l.next?.bind(l),n=l.error?.bind(l),o=l.complete?.bind(l)}this.__isAsync&&(n=this.wrapInTimeout(n),r&&(r=this.wrapInTimeout(r)),o&&(o=this.wrapInTimeout(o)));let a=super.subscribe({next:r,error:n,complete:o});return e instanceof Pr&&e.add(a),a}wrapInTimeout(e){return t=>{let i=this.pendingTasks?.add();setTimeout(()=>{e(t),i!==void 0&&this.pendingTasks?.remove(i)})}}},ws=$y;var Bk="ngSkipHydration",Vk="ngskiphydration";function fF(s){let e=s.mergedAttrs;if(e===null)return!1;for(let t=0;t<e.length;t+=2){let i=e[t];if(typeof i=="number")return!1;if(typeof i=="string"&&i.toLowerCase()===Vk)return!0}return!1}function pF(s){return s.hasAttribute(Bk)}function d_(s){return(s.flags&128)===128}function Uk(s){if(d_(s))return!0;let e=s.parent;for(;e;){if(d_(s)||fF(e))return!0;e=e.parent}return!1}var mF=new Map,kk=0;function Gk(){return kk++}function zk(s){mF.set(s[P_],s)}function Wk(s){mF.delete(s[P_])}var Hw="__ngContext__";function Uu(s,e){Va(e)?(s[Hw]=e[P_],zk(e)):s[Hw]=e}function gF(s){return xF(s[Kf])}function _F(s){return xF(s[mo])}function xF(s){for(;s!==null&&!Qo(s);)s=s[mo];return s}var jy;function vF(s){jy=s}function N_(){if(jy!==void 0)return jy;if(typeof document<"u")return document;throw new _t(210,!1)}var F_=new Pt("",{providedIn:"root",factory:()=>Hk}),Hk="ng",EE=new Pt(""),Gn=new Pt("",{providedIn:"platform",factory:()=>"unknown"});var AE=new Pt("",{providedIn:"root",factory:()=>N_().body?.querySelector("[ngCspNonce]")?.getAttribute("ngCspNonce")||null});function Xk(){let s=new Hu;return Ue(Gn)==="browser"&&(s.store=Yk(N_(),Ue(F_))),s}var Hu=(()=>{let e=class e{constructor(){this.store={},this.onSerializeCallbacks={}}get(i,r){return this.store[i]!==void 0?this.store[i]:r}set(i,r){this.store[i]=r}remove(i){delete this.store[i]}hasKey(i){return this.store.hasOwnProperty(i)}get isEmpty(){return Object.keys(this.store).length===0}onSerialize(i,r){this.onSerializeCallbacks[i]=r}toJson(){for(let i in this.onSerializeCallbacks)if(this.onSerializeCallbacks.hasOwnProperty(i))try{this.store[i]=this.onSerializeCallbacks[i]()}catch(r){console.warn("Exception in onSerialize callback: ",r)}return JSON.stringify(this.store).replace(/</g,"\\u003C")}};e.\u0275prov=Ft({token:e,providedIn:"root",factory:Xk});let s=e;return s})();function Yk(s,e){let t=s.getElementById(e+"-state");if(t?.textContent)try{return JSON.parse(t.textContent)}catch(i){console.warn("Exception while restoring TransferState for app "+e,i)}return{}}var TF="h",CF="b",qy=function(s){return s.FirstChild="f",s.NextSibling="n",s}(qy||{}),$k="e",jk="t",IE="c",bF="x",f_="r",qk="i",Qk="n",SF="d";var Kk="__nghData__",yF=Kk,Iy="ngh",Zk="nghm",EF=()=>null;function Jk(s,e,t=!1){let i=s.getAttribute(Iy);if(i==null)return null;let[r,n]=i.split("|");if(i=t?n:r,!i)return null;let o=n?`|${n}`:"",a=t?r:o,l={};if(i!==""){let h=e.get(Hu,null,{optional:!0});h!==null&&(l=h.get(yF,[])[Number(i)])}let c={data:l,firstChild:s.firstChild??null};return t&&(c.firstChild=s,L_(c,0,s.nextSibling)),a?s.setAttribute(Iy,a):s.removeAttribute(Iy),c}function e3(){EF=Jk}function RE(s,e,t=!1){return EF(s,e,t)}function t3(s){let e=s._lView;return e[Zt].type===2?null:(c_(e)&&(e=e[kn]),e)}function i3(s){return s.textContent?.replace(/\s/gm,"")}function r3(s){let e=N_(),t=e.createNodeIterator(s,NodeFilter.SHOW_COMMENT,{acceptNode(n){let o=i3(n);return o==="ngetn"||o==="ngtns"?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}}),i,r=[];for(;i=t.nextNode();)r.push(i);for(let n of r)n.textContent==="ngetn"?n.replaceWith(e.createTextNode("")):n.remove()}function L_(s,e,t){s.segmentHeads??={},s.segmentHeads[e]=t}function Qy(s,e){return s.segmentHeads?.[e]??null}function s3(s,e){let t=s.data,i=t[$k]?.[e]??null;return i===null&&t[IE]?.[e]&&(i=PE(s,e)),i}function AF(s,e){return s.data[IE]?.[e]??null}function PE(s,e){let t=AF(s,e)??[],i=0;for(let r of t)i+=r[f_]*(r[bF]??1);return i}function n3(s){if(typeof s.disconnectedNodes>"u"){let e=s.data[SF];s.disconnectedNodes=e?new Set(e):null}return s.disconnectedNodes}function B_(s,e){if(typeof s.disconnectedNodes>"u"){let t=s.data[SF];s.disconnectedNodes=t?new Set(t):null}return!!n3(s)?.has(e)}var jg=new Pt(""),IF=!1,RF=new Pt("",{providedIn:"root",factory:()=>IF});var o3=/^>|^->|<!--|-->|--!>|<!-$/g,a3=/(<|>)/g,l3="\u200B$1\u200B";function c3(s){return s.replace(o3,e=>e.replace(a3,l3))}function h3(s){return s.ownerDocument.body}function PF(s){return s instanceof Function?s():s}function qg(s){return(s??Ue(za)).get(Gn)==="browser"}var Lc=function(s){return s[s.Important=1]="Important",s[s.DashCase=2]="DashCase",s}(Lc||{}),u3;function ME(s,e){return u3(s,e)}function wu(s,e,t,i,r){if(i!=null){let n,o=!1;Qo(i)?n=i:Va(i)&&(o=!0,i=i[cn]);let a=Ga(i);s===0&&t!==null?r==null?FF(e,t,a):p_(e,t,a,r||null,!0):s===1&&t!==null?p_(e,t,a,r||null,!0):s===2?NE(e,a,o):s===3&&e.destroyNode(a),n!=null&&I3(e,s,n,t,r)}}function MF(s,e){return s.createText(e)}function DF(s,e){return s.createComment(c3(e))}function DE(s,e,t){return s.createElement(e,t)}function d3(s,e){OF(s,e),e[cn]=null,e[go]=null}function f3(s,e,t,i,r,n){i[cn]=r,i[go]=e,V_(s,i,t,1,r,n)}function OF(s,e){e[Ua].changeDetectionScheduler?.notify(8),V_(s,e,e[us],2,null,null)}function p3(s){let e=s[Kf];if(!e)return Ry(s[Zt],s);for(;e;){let t=null;if(Va(e))t=e[Kf];else{let i=e[ln];i&&(t=i)}if(!t){for(;e&&!e[mo]&&e!==s;)Va(e)&&Ry(e[Zt],e),e=e[hs];e===null&&(e=s),Va(e)&&Ry(e[Zt],e),t=e&&e[mo]}e=t}}function m3(s,e,t,i){let r=ln+i,n=t.length;i>0&&(t[r-1][mo]=e),i<n-ln?(e[mo]=t[r],pN(t,ln+i,e)):(t.push(e),e[mo]=null),e[hs]=t;let o=e[Zf];o!==null&&t!==o&&wF(o,e);let a=e[R_];a!==null&&a.insertView(s),Gy(e),e[Lt]|=128}function wF(s,e){let t=s[a_],i=e[hs];if(Va(i))s[Lt]|=l_.HasTransplantedViews;else{let r=i[hs][Un];e[Un]!==r&&(s[Lt]|=l_.HasTransplantedViews)}t===null?s[a_]=[e]:t.push(e)}function OE(s,e){let t=s[a_],i=t.indexOf(e);t.splice(i,1)}function Ky(s,e){if(s.length<=ln)return;let t=ln+e,i=s[t];if(i){let r=i[Zf];r!==null&&r!==s&&OE(r,i),e>0&&(s[t-1][mo]=i[mo]);let n=s_(s,ln+e);d3(i[Zt],i);let o=n[R_];o!==null&&o.detachView(n[Zt]),i[hs]=null,i[mo]=null,i[Lt]&=-129}return i}function NF(s,e){if(!(e[Lt]&256)){let t=e[us];t.destroyNode&&V_(s,e,t,3,null,null),p3(e)}}function Ry(s,e){if(e[Lt]&256)return;let t=ki(null);try{e[Lt]&=-129,e[Lt]|=256,e[Bn]&&ty(e[Bn]),_3(s,e),g3(s,e),e[Zt].type===1&&e[us].destroy();let i=e[Zf];if(i!==null&&Qo(e[hs])){i!==e[hs]&&OE(i,e);let r=e[R_];r!==null&&r.detachView(s)}Wk(e)}finally{ki(t)}}function g3(s,e){let t=s.cleanup,i=e[Nw];if(t!==null)for(let n=0;n<t.length-1;n+=2)if(typeof t[n]=="string"){let o=t[n+3];o>=0?i[o]():i[-o].unsubscribe(),n+=2}else{let o=i[t[n+1]];t[n].call(o)}i!==null&&(e[Nw]=null);let r=e[Rl];if(r!==null){e[Rl]=null;for(let n=0;n<r.length;n++){let o=r[n];o()}}}function _3(s,e){let t;if(s!=null&&(t=s.destroyHooks)!=null)for(let i=0;i<t.length;i+=2){let r=e[t[i]];if(!(r instanceof tp)){let n=t[i+1];if(Array.isArray(n))for(let o=0;o<n.length;o+=2){let a=r[n[o]],l=n[o+1];Il(4,a,l);try{l.call(a)}finally{Il(5,a,l)}}else{Il(4,r,n);try{n.call(r)}finally{Il(5,r,n)}}}}}function x3(s,e,t){return v3(s,e.parent,t)}function v3(s,e,t){let i=e;for(;i!==null&&i.type&40;)e=i,i=e.parent;if(i===null)return t[cn];{let{componentOffset:r}=i;if(r>-1){let{encapsulation:n}=s.data[i.directiveStart+r];if(n===Yo.None||n===Yo.Emulated)return null}return Ko(i,t)}}function p_(s,e,t,i,r){s.insertBefore(e,t,i,r)}function FF(s,e,t){s.appendChild(e,t)}function Xw(s,e,t,i,r){i!==null?p_(s,e,t,i,r):FF(s,e,t)}function T3(s,e,t,i){s.removeChild(e,t,i)}function wE(s,e){return s.parentNode(e)}function C3(s,e){return s.nextSibling(e)}function b3(s,e,t){return y3(s,e,t)}function S3(s,e,t){return s.type&40?Ko(s,t):null}var y3=S3,Yw;function E3(s,e,t,i){let r=x3(s,i,e),n=e[us],o=i.parent||e[go],a=b3(o,i,e);if(r!=null)if(Array.isArray(t))for(let l=0;l<t.length;l++)Xw(n,r,t[l],a,!1);else Xw(n,r,t,a,!1);Yw!==void 0&&Yw(n,i,e,t,r)}function e_(s,e){if(e!==null){let t=e.type;if(t&3)return Ko(e,s);if(t&4)return Zy(-1,s[e.index]);if(t&8){let i=e.child;if(i!==null)return e_(s,i);{let r=s[e.index];return Qo(r)?Zy(-1,r):Ga(r)}}else{if(t&32)return ME(e,s)()||Ga(s[e.index]);{let i=LF(s,e);if(i!==null){if(Array.isArray(i))return i[0];let r=Oc(s[Un]);return e_(r,i)}else return e_(s,e.next)}}}return null}function LF(s,e){if(e!==null){let i=s[Un][go],r=e.projection;return i.projection[r]}return null}function Zy(s,e){let t=ln+s+1;if(t<e.length){let i=e[t],r=i[Zt].firstChild;if(r!==null)return e_(i,r)}return e[ka]}function NE(s,e,t){let i=wE(s,e);i&&T3(s,i,e,t)}function BF(s){s.textContent=""}function FE(s,e,t,i,r,n,o){for(;t!=null;){let a=i[t.index],l=t.type;if(o&&e===0&&(a&&Uu(Ga(a),i),t.flags|=2),(t.flags&32)!==32)if(l&8)FE(s,e,t.child,i,r,n,!1),wu(e,s,r,a,n);else if(l&32){let c=ME(t,i),h;for(;h=c();)wu(e,s,r,h,n);wu(e,s,r,a,n)}else l&16?A3(s,e,i,t,r,n):wu(e,s,r,a,n);t=o?t.projectionNext:t.next}}function V_(s,e,t,i,r,n){FE(t,i,s.firstChild,e,r,n,!1)}function A3(s,e,t,i,r,n){let o=t[Un],l=o[go].projection[i.projection];if(Array.isArray(l))for(let c=0;c<l.length;c++){let h=l[c];wu(e,s,r,h,n)}else{let c=l,h=o[hs];d_(i)&&(c.flags|=128),FE(s,e,c,h,r,n,!0)}}function I3(s,e,t,i,r){let n=t[ka],o=Ga(t);n!==o&&wu(e,s,i,n,r);for(let a=ln;a<t.length;a++){let l=t[a];V_(l[Zt],l,s,e,i,n)}}function R3(s,e,t){s.setAttribute(e,"style",t)}function VF(s,e,t){t===""?s.removeAttribute(e,"class"):s.setAttribute(e,"class",t)}function UF(s,e,t){let{mergedAttrs:i,classes:r,styles:n}=t;i!==null&&Fy(s,e,i),r!==null&&VF(s,e,r),n!==null&&R3(s,e,n)}var kF={};function P3(s,e,t,i){if(!i)if((e[Lt]&3)===3){let n=s.preOrderCheckHooks;n!==null&&Zg(e,n,t)}else{let n=s.preOrderHooks;n!==null&&Jg(e,n,0,t)}wc(t)}function hp(s,e=Ht.Default){let t=jo();if(t===null)return ni(s,e);let i=Ha();return aF(i,t,Ln(s),e)}function GF(s,e,t,i,r,n){let o=ki(null);try{let a=null;r&Bu.SignalBased&&(a=e[i][YO]),a!==null&&a.transformFn!==void 0&&(n=a.transformFn(n)),r&Bu.HasDecoratorInputTransform&&(n=s.inputTransforms[i].call(e,n)),s.setInput!==null?s.setInput(e,a,n,t,i):DN(e,a,i,n)}finally{ki(o)}}function M3(s,e){let t=s.hostBindingOpCodes;if(t!==null)try{for(let i=0;i<t.length;i++){let r=t[i];if(r<0)wc(~r);else{let n=r,o=t[++i],a=t[++i];fk(o,n);let l=e[n];a(2,l)}}}finally{wc(-1)}}function LE(s,e,t,i,r,n,o,a,l,c,h){let u=e.blueprint.slice();return u[cn]=r,u[Lt]=i|4|128|8|64,(c!==null||s&&s[Lt]&2048)&&(u[Lt]|=2048),FN(u),u[hs]=u[op]=s,u[Pl]=t,u[Ua]=o||s&&s[Ua],u[us]=a||s&&s[us],u[Vu]=l||s&&s[Vu]||null,u[go]=n,u[P_]=Gk(),u[$o]=h,u[RN]=c,u[Un]=e.type==2?s[Un]:u,u}function zF(s,e,t,i,r){let n=s.data[e];if(n===null)n=D3(s,e,t,i,r),dk()&&(n.flags|=32);else if(n.type&64){n.type=t,n.value=i,n.attrs=r;let o=ck();n.injectorIndex=o===null?-1:o.injectorIndex}return vE(n,!0),n}function D3(s,e,t,i,r){let n=GN(),o=zN(),a=o?n:n&&n.parent,l=s.data[e]=U3(s,a,t,e,i,r);return s.firstChild===null&&(s.firstChild=l),n!==null&&(o?n.child==null&&l.parent!==null&&(n.child=l):n.next===null&&(n.next=l,l.prev=n)),l}function WF(s,e,t,i){if(t===0)return-1;let r=e.length;for(let n=0;n<t;n++)e.push(i),s.blueprint.push(i),s.data.push(null);return r}function HF(s,e,t,i,r){let n=gk(),o=i&2;try{wc(-1),o&&e.length>kn&&P3(s,e,kn,!1),Il(o?2:0,r),t(i,r)}finally{wc(n),Il(o?3:1,r)}}function XF(s,e,t){if(MN(e)){let i=ki(null);try{let r=e.directiveStart,n=e.directiveEnd;for(let o=r;o<n;o++){let a=s.data[o];if(a.contentQueries){let l=t[o];a.contentQueries(1,l,o)}}}finally{ki(i)}}}function O3(s,e,t){UN()&&(H3(s,e,t,Ko(t,e)),(t.flags&64)===64&&QF(s,e,t))}function w3(s,e,t=Ko){let i=e.localNames;if(i!==null){let r=e.index+1;for(let n=0;n<i.length;n+=2){let o=i[n+1],a=o===-1?t(e,s):s[o];s[r++]=a}}}function YF(s){let e=s.tView;return e===null||e.incompleteFirstPass?s.tView=$F(1,null,s.template,s.decls,s.vars,s.directiveDefs,s.pipeDefs,s.viewQuery,s.schemas,s.consts,s.id):e}function $F(s,e,t,i,r,n,o,a,l,c,h){let u=kn+i,d=u+r,f=N3(u,d),m=typeof c=="function"?c():c;return f[Zt]={type:s,blueprint:f,template:t,queries:null,viewQuery:a,declTNode:e,data:f.slice().fill(null,u),bindingStartIndex:u,expandoStartIndex:d,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:typeof n=="function"?n():n,pipeRegistry:typeof o=="function"?o():o,firstChild:null,schemas:l,consts:m,incompleteFirstPass:!1,ssrId:h}}function N3(s,e){let t=[];for(let i=0;i<e;i++)t.push(i<s?null:kF);return t}function F3(s,e,t,i){let n=i.get(RF,IF)||t===Yo.ShadowDom,o=s.selectRootElement(e,n);return L3(o),o}function L3(s){jF(s)}var jF=()=>null;function B3(s){pF(s)?BF(s):r3(s)}function V3(){jF=B3}function U3(s,e,t,i,r,n){let o=e?e.injectorIndex:-1,a=0;return cp()&&(a|=128),{type:t,index:i,insertBeforeIndex:null,injectorIndex:o,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,componentOffset:-1,propertyBindings:null,flags:a,providerIndexes:0,value:r,attrs:n,mergedAttrs:null,localNames:null,initialInputs:void 0,inputs:null,outputs:null,tView:null,next:null,prev:null,projectionNext:null,child:null,parent:e,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}function $w(s,e,t,i,r){for(let n in e){if(!e.hasOwnProperty(n))continue;let o=e[n];if(o===void 0)continue;i??={};let a,l=Bu.None;Array.isArray(o)?(a=o[0],l=o[1]):a=o;let c=n;if(r!==null){if(!r.hasOwnProperty(n))continue;c=r[n]}s===0?jw(i,t,c,a,l):jw(i,t,c,a)}return i}function jw(s,e,t,i,r){let n;s.hasOwnProperty(t)?(n=s[t]).push(e,i):n=s[t]=[e,i],r!==void 0&&n.push(r)}function k3(s,e,t){let i=e.directiveStart,r=e.directiveEnd,n=s.data,o=e.attrs,a=[],l=null,c=null;for(let h=i;h<r;h++){let u=n[h],d=t?t.get(u):null,f=d?d.inputs:null,m=d?d.outputs:null;l=$w(0,u.inputs,h,l,f),c=$w(1,u.outputs,h,c,m);let g=l!==null&&o!==null&&!pE(e)?J3(l,h,o):null;a.push(g)}l!==null&&(l.hasOwnProperty("class")&&(e.flags|=8),l.hasOwnProperty("style")&&(e.flags|=16)),e.initialInputs=a,e.inputs=l,e.outputs=c}function G3(s,e,t,i){if(UN()){let r=i===null?null:{"":-1},n=Y3(s,t),o,a;n===null?o=a=null:[o,a]=n,o!==null&&qF(s,e,t,o,r,a),r&&$3(t,i,r)}t.mergedAttrs=fE(t.mergedAttrs,t.attrs)}function qF(s,e,t,i,r,n){for(let c=0;c<i.length;c++)Ik(rF(t,e),s,i[c].type);q3(t,s.data.length,i.length);for(let c=0;c<i.length;c++){let h=i[c];h.providersResolver&&h.providersResolver(h)}let o=!1,a=!1,l=WF(s,e,i.length,null);for(let c=0;c<i.length;c++){let h=i[c];t.mergedAttrs=fE(t.mergedAttrs,h.hostAttrs),Q3(s,t,e,l,h),j3(l,h,r),h.contentQueries!==null&&(t.flags|=4),(h.hostBindings!==null||h.hostAttrs!==null||h.hostVars!==0)&&(t.flags|=64);let u=h.type.prototype;!o&&(u.ngOnChanges||u.ngOnInit||u.ngDoCheck)&&((s.preOrderHooks??=[]).push(t.index),o=!0),!a&&(u.ngOnChanges||u.ngDoCheck)&&((s.preOrderCheckHooks??=[]).push(t.index),a=!0),l++}k3(s,t,n)}function z3(s,e,t,i,r){let n=r.hostBindings;if(n){let o=s.hostBindingOpCodes;o===null&&(o=s.hostBindingOpCodes=[]);let a=~e.index;W3(o)!=a&&o.push(a),o.push(t,i,n)}}function W3(s){let e=s.length;for(;e>0;){let t=s[--e];if(typeof t=="number"&&t<0)return t}return 0}function H3(s,e,t,i){let r=t.directiveStart,n=t.directiveEnd;M_(t)&&K3(e,t,s.data[r+t.componentOffset]),s.firstCreatePass||rF(t,e),Uu(i,e);let o=t.initialInputs;for(let a=r;a<n;a++){let l=s.data[a],c=ip(e,s,a,t);if(Uu(c,e),o!==null&&Z3(e,a-r,c,l,t,o),ap(l)){let h=lp(t.index,e);h[Pl]=ip(e,s,a,t)}}}function QF(s,e,t){let i=t.directiveStart,r=t.directiveEnd,n=t.index,o=pk();try{wc(n);for(let a=i;a<r;a++){let l=s.data[a],c=e[a];zy(a),(l.hostBindings!==null||l.hostVars!==0||l.hostAttrs!==null)&&X3(l,c)}}finally{wc(-1),zy(o)}}function X3(s,e){s.hostBindings!==null&&s.hostBindings(1,e)}function Y3(s,e){let t=s.directiveRegistry,i=null,r=null;if(t)for(let n=0;n<t.length;n++){let o=t[n];if(AU(e,o.selectors,!1))if(i||(i=[]),ap(o))if(o.findHostDirectiveDefs!==null){let a=[];r=r||new Map,o.findHostDirectiveDefs(o,a,r),i.unshift(...a,o);let l=a.length;Jy(s,e,l)}else i.unshift(o),Jy(s,e,0);else r=r||new Map,o.findHostDirectiveDefs?.(o,i,r),i.push(o)}return i===null?null:[i,r]}function Jy(s,e,t){e.componentOffset=t,(s.components??=[]).push(e.index)}function $3(s,e,t){if(e){let i=s.localNames=[];for(let r=0;r<e.length;r+=2){let n=t[e[r+1]];if(n==null)throw new _t(-301,!1);i.push(e[r],n)}}}function j3(s,e,t){if(t){if(e.exportAs)for(let i=0;i<e.exportAs.length;i++)t[e.exportAs[i]]=s;ap(e)&&(t[""]=s)}}function q3(s,e,t){s.flags|=1,s.directiveStart=e,s.directiveEnd=e+t,s.providerIndexes=e}function Q3(s,e,t,i,r){s.data[i]=r;let n=r.factory||(r.factory=Lu(r.type,!0)),o=new tp(n,ap(r),hp);s.blueprint[i]=o,t[i]=o,z3(s,e,i,WF(s,t,r.hostVars,kF),r)}function K3(s,e,t){let i=Ko(e,s),r=YF(t),n=s[Ua].rendererFactory,o=16;t.signals?o=4096:t.onPush&&(o=64);let a=BE(s,LE(s,r,null,o,i,e,null,n.createRenderer(i,t),null,null,null));s[e.index]=a}function Z3(s,e,t,i,r,n){let o=n[e];if(o!==null)for(let a=0;a<o.length;){let l=o[a++],c=o[a++],h=o[a++],u=o[a++];GF(i,t,l,c,h,u)}}function J3(s,e,t){let i=null,r=0;for(;r<t.length;){let n=t[r];if(n===0){r+=4;continue}else if(n===5){r+=2;continue}if(typeof n=="number")break;if(s.hasOwnProperty(n)){i===null&&(i=[]);let o=s[n];for(let a=0;a<o.length;a+=3)if(o[a]===e){i.push(n,o[a+1],o[a+2],t[r+1]);break}}r+=2}return i}function eG(s,e,t,i){return[s,!0,0,e,null,i,null,t,null,null]}function KF(s,e){let t=s.contentQueries;if(t!==null){let i=ki(null);try{for(let r=0;r<t.length;r+=2){let n=t[r],o=t[r+1];if(o!==-1){let a=s.data[o];HN(n),a.contentQueries(2,e[o],o)}}}finally{ki(i)}}}function BE(s,e){return s[Kf]?s[Fw][mo]=e:s[Kf]=e,s[Fw]=e,e}function eE(s,e,t){HN(0);let i=ki(null);try{e(s,t)}finally{ki(i)}}function tG(s,e){let t=s[Vu],i=t?t.get(Wa,null):null;i&&i.handleError(e)}function ZF(s,e,t,i,r){for(let n=0;n<t.length;){let o=t[n++],a=t[n++],l=t[n++],c=e[o],h=s.data[o];GF(h,c,i,a,l,r)}}function iG(s,e){let t=lp(e,s),i=t[Zt];rG(i,t);let r=t[cn];r!==null&&t[$o]===null&&(t[$o]=RE(r,t[Vu])),JF(i,t,t[Pl])}function rG(s,e){for(let t=e.length;t<s.blueprint.length;t++)e.push(s.blueprint[t])}function JF(s,e,t){TE(e);try{let i=s.viewQuery;i!==null&&eE(1,i,t);let r=s.template;r!==null&&HF(s,e,r,1,t),s.firstCreatePass&&(s.firstCreatePass=!1),e[R_]?.finishViewCreation(s),s.staticContentQueries&&KF(s,e),s.staticViewQueries&&eE(2,s.viewQuery,t);let n=s.components;n!==null&&sG(e,n)}catch(i){throw s.firstCreatePass&&(s.incompleteFirstPass=!0,s.firstCreatePass=!1),i}finally{e[Lt]&=-5,CE()}}function sG(s,e){for(let t=0;t<e.length;t++)iG(s,e[t])}function qw(s,e){return!e||e.firstChild===null||d_(s)}function nG(s,e,t,i=!0){let r=e[Zt];if(m3(r,e,s,t),i){let o=Zy(t,s),a=e[us],l=wE(a,s[ka]);l!==null&&f3(r,s[go],a,e,l,o)}let n=e[$o];n!==null&&n.firstChild!==null&&(n.firstChild=null)}function m_(s,e,t,i,r=!1){for(;t!==null;){let n=e[t.index];n!==null&&i.push(Ga(n)),Qo(n)&&oG(n,i);let o=t.type;if(o&8)m_(s,e,t.child,i);else if(o&32){let a=ME(t,e),l;for(;l=a();)i.push(l)}else if(o&16){let a=LF(e,t);if(Array.isArray(a))i.push(...a);else{let l=Oc(e[Un]);m_(l[Zt],l,a,i,!0)}}t=r?t.projectionNext:t.next}return i}function oG(s,e){for(let t=ln;t<s.length;t++){let i=s[t],r=i[Zt].firstChild;r!==null&&m_(i[Zt],i,r,e)}s[ka]!==s[cn]&&e.push(s[ka])}var eL=[];function aG(s){return s[Bn]??lG(s)}function lG(s){let e=eL.pop()??Object.create(hG);return e.lView=s,e}function cG(s){s.lView[Bn]!==s&&(s.lView=null,eL.push(s))}var hG=Kt(ie({},ZS),{consumerIsAlwaysLive:!0,consumerMarkedDirty:s=>{O_(s.lView)},consumerOnSignalRead(){this.lView[Bn]=this}});function uG(s){let e=s[Bn]??Object.create(dG);return e.lView=s,e}var dG=Kt(ie({},ZS),{consumerIsAlwaysLive:!0,consumerMarkedDirty:s=>{let e=Oc(s.lView);for(;e&&!tL(e[Zt]);)e=Oc(e);e&&LN(e)},consumerOnSignalRead(){this.lView[Bn]=this}});function tL(s){return s.type!==2}var fG=100;function iL(s,e=!0,t=0){let i=s[Ua],r=i.rendererFactory,n=!1;n||r.begin?.();try{pG(s,t)}catch(o){throw e&&tG(s,o),o}finally{n||(r.end?.(),i.inlineEffectRunner?.flush())}}function pG(s,e){let t=WN();try{Vw(!0),tE(s,e);let i=0;for(;ep(s);){if(i===fG)throw new _t(103,!1);i++,tE(s,1)}}finally{Vw(t)}}function mG(s,e,t,i){let r=e[Lt];if((r&256)===256)return;let n=!1,o=!1;!n&&e[Ua].inlineEffectRunner?.flush(),TE(e);let a=!0,l=null,c=null;n||(tL(s)?(c=aG(e),l=JS(c)):$O()===null?(a=!1,c=uG(e),l=JS(c)):e[Bn]&&(ty(e[Bn]),e[Bn]=null));try{FN(e),uk(s.bindingStartIndex),t!==null&&HF(s,e,t,2,i);let h=(r&3)===3;if(!n)if(h){let f=s.preOrderCheckHooks;f!==null&&Zg(e,f,null)}else{let f=s.preOrderHooks;f!==null&&Jg(e,f,0,null),Sy(e,0)}if(o||gG(e),rL(e,0),s.contentQueries!==null&&KF(s,e),!n)if(h){let f=s.contentCheckHooks;f!==null&&Zg(e,f)}else{let f=s.contentHooks;f!==null&&Jg(e,f,1),Sy(e,1)}M3(s,e);let u=s.components;u!==null&&nL(e,u,0);let d=s.viewQuery;if(d!==null&&eE(2,d,i),!n)if(h){let f=s.viewCheckHooks;f!==null&&Zg(e,f)}else{let f=s.viewHooks;f!==null&&Jg(e,f,2),Sy(e,2)}if(s.firstUpdatePass===!0&&(s.firstUpdatePass=!1),e[by]){for(let f of e[by])f();e[by]=null}n||(e[Lt]&=-73)}catch(h){throw n||O_(e),h}finally{c!==null&&(jO(c,l),a&&cG(c)),CE()}}function rL(s,e){for(let t=gF(s);t!==null;t=_F(t))for(let i=ln;i<t.length;i++){let r=t[i];sL(r,e)}}function gG(s){for(let e=gF(s);e!==null;e=_F(e)){if(!(e[Lt]&l_.HasTransplantedViews))continue;let t=e[a_];for(let i=0;i<t.length;i++){let r=t[i];LN(r)}}}function _G(s,e,t){let i=lp(e,s);sL(i,t)}function sL(s,e){xE(s)&&tE(s,e)}function tE(s,e){let i=s[Zt],r=s[Lt],n=s[Bn],o=!!(e===0&&r&16);if(o||=!!(r&64&&e===0),o||=!!(r&1024),o||=!!(n?.dirty&&ey(n)),o||=!1,n&&(n.dirty=!1),s[Lt]&=-9217,o)mG(i,s,i.template,s[Pl]);else if(r&8192){rL(s,1);let a=i.components;a!==null&&nL(s,a,1)}}function nL(s,e,t){for(let i=0;i<e.length;i++)_G(s,e[i],t)}function oL(s,e){let t=WN()?64:1088;for(s[Ua].changeDetectionScheduler?.notify(e);s;){s[Lt]|=t;let i=Oc(s);if(c_(s)&&!i)return s;s=i}return null}var ku=class{get rootNodes(){let e=this._lView,t=e[Zt];return m_(t,e,t.firstChild,[])}constructor(e,t,i=!0){this._lView=e,this._cdRefInjectingView=t,this.notifyErrorHandler=i,this._appRef=null,this._attachedToViewContainer=!1}get context(){return this._lView[Pl]}set context(e){this._lView[Pl]=e}get destroyed(){return(this._lView[Lt]&256)===256}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){let e=this._lView[hs];if(Qo(e)){let t=e[o_],i=t?t.indexOf(this):-1;i>-1&&(Ky(e,i),s_(t,i))}this._attachedToViewContainer=!1}NF(this._lView[Zt],this._lView)}onDestroy(e){BN(this._lView,e)}markForCheck(){oL(this._cdRefInjectingView||this._lView,4)}detach(){this._lView[Lt]&=-129}reattach(){Gy(this._lView),this._lView[Lt]|=128}detectChanges(){this._lView[Lt]|=1024,iL(this._lView,this.notifyErrorHandler)}checkNoChanges(){}attachToViewContainerRef(){if(this._appRef)throw new _t(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null;let e=c_(this._lView),t=this._lView[Zf];t!==null&&!e&&OE(t,this._lView),OF(this._lView[Zt],this._lView)}attachToAppRef(e){if(this._attachedToViewContainer)throw new _t(902,!1);this._appRef=e;let t=c_(this._lView),i=this._lView[Zf];i!==null&&!t&&wF(i,this._lView),Gy(this._lView)}};var xG=new RegExp(`^(\\d+)*(${CF}|${TF})*(.*)`);function vG(s){let e=s.match(xG),[t,i,r,n]=e,o=i?parseInt(i,10):r,a=[];for(let[l,c,h]of n.matchAll(/(f|n)(\d*)/g)){let u=parseInt(h,10)||1;a.push(c,u)}return[o,...a]}function TG(s){return!s.prev&&s.parent?.type===8}function Py(s){return s.index-kn}function CG(s,e){let t=s.i18nNodes;if(t)return t.get(e)}function U_(s,e,t,i){let r=Py(i),n=CG(s,r);if(n===void 0){let o=s.data[Qk];if(o?.[r])n=SG(o[r],t);else if(e.firstChild===i)n=s.firstChild;else{let a=i.prev===null,l=i.prev??i.parent;if(TG(i)){let c=Py(i.parent);n=Qy(s,c)}else{let c=Ko(l,t);if(a)n=c.firstChild;else{let h=Py(l),u=Qy(s,h);if(l.type===2&&u){let f=PE(s,h)+1;n=k_(f,u)}else n=c.nextSibling}}}}return n}function k_(s,e){let t=e;for(let i=0;i<s;i++)t=t.nextSibling;return t}function bG(s,e){let t=s;for(let i=0;i<e.length;i+=2){let r=e[i],n=e[i+1];for(let o=0;o<n;o++)switch(r){case qy.FirstChild:t=t.firstChild;break;case qy.NextSibling:t=t.nextSibling;break}}return t}function SG(s,e){let[t,...i]=vG(s),r;if(t===TF)r=e[Un][cn];else if(t===CF)r=h3(e[Un][cn]);else{let n=Number(t);r=Ga(e[n+kn])}return bG(r,i)}var yG=!1;function EG(s){yG=s}function AG(s){let e=s[$o];if(e){let{i18nNodes:t,dehydratedIcuData:i}=e;if(t&&i){let r=s[us];for(let n of i.values())IG(r,t,n)}e.i18nNodes=void 0,e.dehydratedIcuData=void 0}}function IG(s,e,t){for(let i of t.node.cases[t.case]){let r=e.get(i.index-kn);r&&NE(s,r,!1)}}function aL(s){let e=s[Jf]??[],i=s[hs][us];for(let r of e)RG(r,i);s[Jf]=po}function RG(s,e){let t=0,i=s.firstChild;if(i){let r=s.data[f_];for(;t<r;){let n=i.nextSibling;NE(e,i,!1),i=n,t++}}}function lL(s){aL(s);for(let e=ln;e<s.length;e++)g_(s[e])}function g_(s){AG(s);let e=s[Zt];for(let t=kn;t<e.bindingStartIndex;t++)if(Qo(s[t])){let i=s[t];lL(i)}else Va(s[t])&&g_(s[t])}function PG(s){let e=s._views;for(let t of e){let i=t3(t);if(i!==null&&i[cn]!==null)if(Va(i))g_(i);else{let r=i[cn];g_(r),lL(i)}}}function MG(s,e){let t=[];for(let i of e)for(let r=0;r<(i[bF]??1);r++){let n={data:i,firstChild:null};i[f_]>0&&(n.firstChild=s,s=k_(i[f_],s)),t.push(n)}return[s,t]}var cL=()=>null;function DG(s,e){let t=s[Jf];return!e||t===null||t.length===0?null:t[0].data[qk]===e?t.shift():(aL(s),null)}function OG(){cL=DG}function Qw(s,e){return cL(s,e)}var rp=class{},VE=new Pt("",{providedIn:"root",factory:()=>!1});var hL=new Pt(""),iE=class{},__=class{};function wG(s){let e=Error(`No component factory found for ${an(s)}.`);return e[NG]=s,e}var NG="ngComponent";var rE=class{resolveComponentFactory(e){throw wG(e)}},HE=class HE{};HE.NULL=new rE;var Gu=HE,zu=class{};var FG=(()=>{let e=class e{};e.\u0275prov=Ft({token:e,providedIn:"root",factory:()=>null});let s=e;return s})();var Kw=new Set;function Xu(s){Kw.has(s)||(Kw.add(s),performance?.mark?.("mark_feature_usage",{detail:{feature:s}}))}function uL(s){let e=!0;return setTimeout(()=>{e&&(e=!1,s())}),typeof Oy.requestAnimationFrame=="function"&&Oy.requestAnimationFrame(()=>{e&&(e=!1,s())}),()=>{e=!1}}function Zw(s){let e=!0;return queueMicrotask(()=>{e&&s()}),()=>{e=!1}}function Jw(...s){}var vr=class s{constructor({enableLongStackTrace:e=!1,shouldCoalesceEventChangeDetection:t=!1,shouldCoalesceRunChangeDetection:i=!1}){if(this.hasPendingMacrotasks=!1,this.hasPendingMicrotasks=!1,this.isStable=!0,this.onUnstable=new ws(!1),this.onMicrotaskEmpty=new ws(!1),this.onStable=new ws(!1),this.onError=new ws(!1),typeof Zone>"u")throw new _t(908,!1);Zone.assertZonePatched();let r=this;r._nesting=0,r._outer=r._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(r._inner=r._inner.fork(new Zone.TaskTrackingZoneSpec)),e&&Zone.longStackTraceZoneSpec&&(r._inner=r._inner.fork(Zone.longStackTraceZoneSpec)),r.shouldCoalesceEventChangeDetection=!i&&t,r.shouldCoalesceRunChangeDetection=i,r.callbackScheduled=!1,VG(r)}static isInAngularZone(){return typeof Zone<"u"&&Zone.current.get("isAngularZone")===!0}static assertInAngularZone(){if(!s.isInAngularZone())throw new _t(909,!1)}static assertNotInAngularZone(){if(s.isInAngularZone())throw new _t(909,!1)}run(e,t,i){return this._inner.run(e,t,i)}runTask(e,t,i,r){let n=this._inner,o=n.scheduleEventTask("NgZoneEvent: "+r,e,LG,Jw,Jw);try{return n.runTask(o,t,i)}finally{n.cancelTask(o)}}runGuarded(e,t,i){return this._inner.runGuarded(e,t,i)}runOutsideAngular(e){return this._outer.run(e)}},LG={};function UE(s){if(s._nesting==0&&!s.hasPendingMicrotasks&&!s.isStable)try{s._nesting++,s.onMicrotaskEmpty.emit(null)}finally{if(s._nesting--,!s.hasPendingMicrotasks)try{s.runOutsideAngular(()=>s.onStable.emit(null))}finally{s.isStable=!0}}}function BG(s){s.isCheckStableRunning||s.callbackScheduled||(s.callbackScheduled=!0,Zone.root.run(()=>{uL(()=>{s.callbackScheduled=!1,sE(s),s.isCheckStableRunning=!0,UE(s),s.isCheckStableRunning=!1})}),sE(s))}function VG(s){let e=()=>{BG(s)};s._inner=s._inner.fork({name:"angular",properties:{isAngularZone:!0},onInvokeTask:(t,i,r,n,o,a)=>{if(UG(a))return t.invokeTask(r,n,o,a);try{return eN(s),t.invokeTask(r,n,o,a)}finally{(s.shouldCoalesceEventChangeDetection&&n.type==="eventTask"||s.shouldCoalesceRunChangeDetection)&&e(),tN(s)}},onInvoke:(t,i,r,n,o,a,l)=>{try{return eN(s),t.invoke(r,n,o,a,l)}finally{s.shouldCoalesceRunChangeDetection&&!s.callbackScheduled&&!kG(a)&&e(),tN(s)}},onHasTask:(t,i,r,n)=>{t.hasTask(r,n),i===r&&(n.change=="microTask"?(s._hasPendingMicrotasks=n.microTask,sE(s),UE(s)):n.change=="macroTask"&&(s.hasPendingMacrotasks=n.macroTask))},onHandleError:(t,i,r,n)=>(t.handleError(r,n),s.runOutsideAngular(()=>s.onError.emit(n)),!1)})}function sE(s){s._hasPendingMicrotasks||(s.shouldCoalesceEventChangeDetection||s.shouldCoalesceRunChangeDetection)&&s.callbackScheduled===!0?s.hasPendingMicrotasks=!0:s.hasPendingMicrotasks=!1}function eN(s){s._nesting++,s.isStable&&(s.isStable=!1,s.onUnstable.emit(null))}function tN(s){s._nesting--,UE(s)}var nE=class{constructor(){this.hasPendingMicrotasks=!1,this.hasPendingMacrotasks=!1,this.isStable=!0,this.onUnstable=new ws,this.onMicrotaskEmpty=new ws,this.onStable=new ws,this.onError=new ws}run(e,t,i){return e.apply(t,i)}runGuarded(e,t,i){return e.apply(t,i)}runOutsideAngular(e){return e()}runTask(e,t,i,r){return e.apply(t,i)}};function UG(s){return dL(s,"__ignore_ng_zone__")}function kG(s){return dL(s,"__scheduler_tick__")}function dL(s,e){return!Array.isArray(s)||s.length!==1?!1:s[0]?.data?.[e]===!0}var fL=(()=>{let e=class e{constructor(){this.handler=null,this.internalCallbacks=[]}execute(){this.executeInternalCallbacks(),this.handler?.execute()}executeInternalCallbacks(){let i=[...this.internalCallbacks];this.internalCallbacks.length=0;for(let r of i)r()}ngOnDestroy(){this.handler?.destroy(),this.handler=null,this.internalCallbacks.length=0}};e.\u0275prov=Ft({token:e,providedIn:"root",factory:()=>new e});let s=e;return s})();function oE(s,e,t){let i=t?s.styles:null,r=t?s.classes:null,n=0;if(e!==null)for(let o=0;o<e.length;o++){let a=e[o];if(typeof a=="number")n=a;else if(n==1)r=yw(r,a);else if(n==2){let l=a,c=e[++o];i=yw(i,l+": "+c+";")}}t?s.styles=i:s.stylesWithoutHost=i,t?s.classes=r:s.classesWithoutHost=r}var x_=class extends Gu{constructor(e){super(),this.ngModule=e}resolveComponentFactory(e){let t=Dc(e);return new sp(t,this.ngModule)}};function iN(s){let e=[];for(let t in s){if(!s.hasOwnProperty(t))continue;let i=s[t];i!==void 0&&e.push({propName:Array.isArray(i)?i[0]:i,templateName:t})}return e}function GG(s){let e=s.toLowerCase();return e==="svg"?ZU:e==="math"?JU:null}var sp=class extends __{get inputs(){let e=this.componentDef,t=e.inputTransforms,i=iN(e.inputs);if(t!==null)for(let r of i)t.hasOwnProperty(r.propName)&&(r.transform=t[r.propName]);return i}get outputs(){return iN(this.componentDef.outputs)}constructor(e,t){super(),this.componentDef=e,this.ngModule=t,this.componentType=e.type,this.selector=MU(e.selectors),this.ngContentSelectors=e.ngContentSelectors?e.ngContentSelectors:[],this.isBoundToModule=!!t}create(e,t,i,r){let n=ki(null);try{r=r||this.ngModule;let o=r instanceof Vn?r:r?.injector;o&&this.componentDef.getStandaloneInjector!==null&&(o=this.componentDef.getStandaloneInjector(o)||o);let a=o?new Wy(e,o):e,l=a.get(zu,null);if(l===null)throw new _t(407,!1);let c=a.get(FG,null),h=a.get(fL,null),u=a.get(rp,null),d={rendererFactory:l,sanitizer:c,inlineEffectRunner:null,afterRenderEventManager:h,changeDetectionScheduler:u},f=l.createRenderer(null,this.componentDef),m=this.componentDef.selectors[0][0]||"div",g=i?F3(f,i,this.componentDef.encapsulation,a):DE(f,m,GG(m)),_=512;this.componentDef.signals?_|=4096:this.componentDef.onPush||(_|=16);let x=null;g!==null&&(x=RE(g,a,!0));let b=$F(0,null,null,1,0,null,null,null,null,null,null),C=LE(null,b,null,_,null,null,d,f,a,null,x);TE(C);let R,E;try{let S=this.componentDef,A,L=null;S.findHostDirectiveDefs?(A=[],L=new Map,S.findHostDirectiveDefs(S,A,L),A.push(S)):A=[S];let G=zG(C,g),W=WG(G,g,S,A,C,d,f);E=ek(b,kn),g&&YG(f,S,g,i),t!==void 0&&$G(E,this.ngContentSelectors,t),R=XG(W,S,A,L,C,[jG]),JF(b,C,null)}finally{CE()}return new aE(this.componentType,R,yE(E,C),C,E)}finally{ki(n)}}},aE=class extends iE{constructor(e,t,i,r,n){super(),this.location=i,this._rootLView=r,this._tNode=n,this.previousInputValues=null,this.instance=t,this.hostView=this.changeDetectorRef=new ku(r,void 0,!1),this.componentType=e}setInput(e,t){let i=this._tNode.inputs,r;if(i!==null&&(r=i[e])){if(this.previousInputValues??=new Map,this.previousInputValues.has(e)&&Object.is(this.previousInputValues.get(e),t))return;let n=this._rootLView;ZF(n[Zt],n,r,e,t),this.previousInputValues.set(e,t);let o=lp(this._tNode.index,n);oL(o,1)}}get injector(){return new Pc(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(e){this.hostView.onDestroy(e)}};function zG(s,e){let t=s[Zt],i=kn;return s[i]=e,zF(t,i,2,"#host",null)}function WG(s,e,t,i,r,n,o){let a=r[Zt];HG(i,s,e,o);let l=null;e!==null&&(l=RE(e,r[Vu]));let c=n.rendererFactory.createRenderer(e,t),h=16;t.signals?h=4096:t.onPush&&(h=64);let u=LE(r,YF(t),null,h,r[s.index],s,n,c,null,null,l);return a.firstCreatePass&&Jy(a,s,i.length-1),BE(r,u),r[s.index]=u}function HG(s,e,t,i){for(let r of s)e.mergedAttrs=fE(e.mergedAttrs,r.hostAttrs);e.mergedAttrs!==null&&(oE(e,e.mergedAttrs,!0),t!==null&&UF(i,t,e))}function XG(s,e,t,i,r,n){let o=Ha(),a=r[Zt],l=Ko(o,r);qF(a,r,o,t,null,i);for(let h=0;h<t.length;h++){let u=o.directiveStart+h,d=ip(r,a,u,o);Uu(d,r)}QF(a,r,o),l&&Uu(l,r);let c=ip(r,a,o.directiveStart+o.componentOffset,o);if(s[Pl]=r[Pl]=c,n!==null)for(let h of n)h(c,e);return XF(a,o,r),c}function YG(s,e,t,i){if(i)Fy(s,t,["ng-version","18.0.4"]);else{let{attrs:r,classes:n}=DU(e.selectors[0]);r&&Fy(s,t,r),n&&n.length>0&&VF(s,t,n.join(" "))}}function $G(s,e,t){let i=s.projection=[];for(let r=0;r<e.length;r++){let n=t[r];i.push(n!=null?Array.from(n):null)}}function jG(){let s=Ha();ZN(jo()[Zt],s)}var G_=(()=>{let e=class e{};e.__NG_ELEMENT_ID__=qG;let s=e;return s})();function qG(){let s=Ha();return KG(s,jo())}var QG=G_,pL=class extends QG{constructor(e,t,i){super(),this._lContainer=e,this._hostTNode=t,this._hostLView=i}get element(){return yE(this._hostTNode,this._hostLView)}get injector(){return new Pc(this._hostTNode,this._hostLView)}get parentInjector(){let e=bE(this._hostTNode,this._hostLView);if(eF(e)){let t=u_(e,this._hostLView),i=h_(e),r=t[Zt].data[i+8];return new Pc(r,t)}else return new Pc(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(e){let t=rN(this._lContainer);return t!==null&&t[e]||null}get length(){return this._lContainer.length-ln}createEmbeddedView(e,t,i){let r,n;typeof i=="number"?r=i:i!=null&&(r=i.index,n=i.injector);let o=Qw(this._lContainer,e.ssrId),a=e.createEmbeddedViewImpl(t||{},n,o);return this.insertImpl(a,r,qw(this._hostTNode,o)),a}createComponent(e,t,i,r,n){let o=e&&!$U(e),a;if(o)a=t;else{let m=t||{};a=m.index,i=m.injector,r=m.projectableNodes,n=m.environmentInjector||m.ngModuleRef}let l=o?e:new sp(Dc(e)),c=i||this.parentInjector;if(!n&&l.ngModule==null){let g=(o?c:this.parentInjector).get(Vn,null);g&&(n=g)}let h=Dc(l.componentType??{}),u=Qw(this._lContainer,h?.id??null),d=u?.firstChild??null,f=l.create(c,r,d,n);return this.insertImpl(f.hostView,a,qw(this._hostTNode,u)),f}insert(e,t){return this.insertImpl(e,t,!0)}insertImpl(e,t,i){let r=e._lView;if(tk(r)){let a=this.indexOf(e);if(a!==-1)this.detach(a);else{let l=r[hs],c=new pL(l,l[go],l[hs]);c.detach(c.indexOf(e))}}let n=this._adjustIndex(t),o=this._lContainer;return nG(o,r,n,i),e.attachToViewContainerRef(),pN(My(o),n,e),e}move(e,t){return this.insert(e,t)}indexOf(e){let t=rN(this._lContainer);return t!==null?t.indexOf(e):-1}remove(e){let t=this._adjustIndex(e,-1),i=Ky(this._lContainer,t);i&&(s_(My(this._lContainer),t),NF(i[Zt],i))}detach(e){let t=this._adjustIndex(e,-1),i=Ky(this._lContainer,t);return i&&s_(My(this._lContainer),t)!=null?new ku(i):null}_adjustIndex(e,t=0){return e??this.length+t}};function rN(s){return s[o_]}function My(s){return s[o_]||(s[o_]=[])}function KG(s,e){let t,i=e[s.index];return Qo(i)?t=i:(t=eG(i,e,null,s),e[s.index]=t,BE(e,t)),mL(t,e,s,i),new pL(t,s,e)}function ZG(s,e){let t=s[us],i=t.createComment(""),r=Ko(e,s),n=wE(t,r);return p_(t,n,i,C3(t,r),!1),i}var mL=_L,gL=()=>!1;function _L(s,e,t,i){if(s[ka])return;let r;t.type&8?r=Ga(i):r=ZG(e,t),s[ka]=r}function JG(s,e,t){if(s[ka]&&s[Jf])return!0;let i=t[$o],r=e.index-kn;if(!i||Uk(e)||B_(i,r))return!1;let o=Qy(i,r),a=i.data[IE]?.[r],[l,c]=MG(o,a);return s[ka]=l,s[Jf]=c,!0}function ez(s,e,t,i){gL(s,t,e)||_L(s,e,t,i)}function tz(){mL=ez,gL=JG}var Ml=class{},np=class{};var lE=class extends Ml{constructor(e,t,i){super(),this._parent=t,this._bootstrapComponents=[],this.destroyCbs=[],this.componentFactoryResolver=new x_(this);let r=bN(e);this._bootstrapComponents=PF(r.bootstrap),this._r3Injector=hF(e,t,[{provide:Ml,useValue:this},{provide:Gu,useValue:this.componentFactoryResolver},...i],an(e),new Set(["environment"])),this._r3Injector.resolveInjectorInitializers(),this.instance=this._r3Injector.get(e)}get injector(){return this._r3Injector}destroy(){let e=this._r3Injector;!e.destroyed&&e.destroy(),this.destroyCbs.forEach(t=>t()),this.destroyCbs=null}onDestroy(e){this.destroyCbs.push(e)}},cE=class extends np{constructor(e){super(),this.moduleType=e}create(e){return new lE(this.moduleType,e,[])}};var v_=class extends Ml{constructor(e){super(),this.componentFactoryResolver=new x_(this),this.instance=null;let t=new Qf([...e.providers,{provide:Ml,useValue:this},{provide:Gu,useValue:this.componentFactoryResolver}],e.parent||_E(),e.debugName,new Set(["environment"]));this.injector=t,e.runEnvironmentInitializers&&t.resolveInjectorInitializers()}destroy(){this.injector.destroy()}onDestroy(e){this.injector.onDestroy(e)}};function kE(s,e,t=null){return new v_({providers:s,parent:e,debugName:t,runEnvironmentInitializers:!0}).injector}function up(s){return(s.flags&32)===32}var iz=xL;function xL(s,e,t,i){return Dl(!0),e[us].createComment("")}function rz(s,e,t,i){let r=e[$o],n=!r||cp()||up(t)||B_(r,i);if(Dl(n),n)return xL(s,e,t,i);let o=r.data[jk]?.[i]??null;o!==null&&t.tView!==null&&t.tView.ssrId===null&&(t.tView.ssrId=o);let a=U_(r,s,e,t);L_(r,i,a);let l=PE(r,i);return k_(l,a)}function sz(){iz=rz}function sN(s,e,t,i,r){let n=e.inputs,o=r?"class":"style";ZF(s,t,n[o],o,i)}function nz(s,e,t,i,r,n){let o=e.consts,a=Bw(o,r),l=zF(e,s,2,i,a);return G3(e,t,l,Bw(o,n)),l.attrs!==null&&oE(l,l.attrs,!1),l.mergedAttrs!==null&&oE(l,l.mergedAttrs,!0),e.queries!==null&&e.queries.elementStart(e,l),l}function vL(s,e,t,i){let r=jo(),n=kN(),o=kn+s,a=r[us],l=n.firstCreatePass?nz(o,n,r,e,t,i):n.data[o],c=CL(n,r,l,a,e,s);r[o]=c;let h=jU(l);return vE(l,!0),UF(a,c,l),!up(l)&&_k()&&E3(n,r,c,l),rk()===0&&Uu(c,r),sk(),h&&(O3(n,r,l),XF(n,l,r)),i!==null&&w3(r,l),vL}function TL(){let s=Ha();zN()?hk():(s=s.parent,vE(s,!1));let e=s;ok(e)&&lk(),nk();let t=kN();return t.firstCreatePass&&(ZN(t,s),MN(s)&&t.queries.elementEnd(s)),e.classesWithoutHost!=null&&Ck(e)&&sN(t,e,jo(),e.classesWithoutHost,!0),e.stylesWithoutHost!=null&&bk(e)&&sN(t,e,jo(),e.stylesWithoutHost,!1),TL}function Bc(s,e,t,i){return vL(s,e,t,i),TL(),Bc}var CL=(s,e,t,i,r,n)=>(Dl(!0),DE(i,r,QN()));function oz(s,e,t,i,r,n){let o=e[$o],a=!o||cp()||up(t)||B_(o,n);if(Dl(a),a)return DE(i,r,QN());let l=U_(o,s,e,t);return AF(o,n)&&L_(o,n,l.nextSibling),o&&(fF(t)||pF(l))&&M_(t)&&(ak(t),BF(l)),l}function az(){CL=oz}var lz=(s,e,t,i)=>(Dl(!0),DF(e[us],""));function cz(s,e,t,i){let r,n=e[$o],o=!n||cp()||up(t);if(Dl(o),o)return DF(e[us],"");let a=U_(n,s,e,t),l=s3(n,i);return L_(n,i,a),r=k_(l,a),r}function hz(){lz=cz}var T_="en-US";var uz=T_;function dz(s){typeof s=="string"&&(uz=s.toLowerCase().replace(/_/g,"-"))}var fz=(s,e,t,i,r)=>(Dl(!0),MF(e[us],i));function pz(s,e,t,i,r){let n=e[$o],o=!n||cp()||up(t)||B_(n,r);return Dl(o),o?MF(e[us],i):U_(n,s,e,t)}function mz(){fz=pz}var gz=(()=>{let e=class e{constructor(i){this._injector=i,this.cachedInjectors=new Map}getOrCreateStandaloneInjector(i){if(!i.standalone)return null;if(!this.cachedInjectors.has(i)){let r=EN(!1,i.type),n=r.length>0?kE([r],this._injector,`Standalone[${i.type.name}]`):null;this.cachedInjectors.set(i,n)}return this.cachedInjectors.get(i)}ngOnDestroy(){try{for(let i of this.cachedInjectors.values())i!==null&&i.destroy()}finally{this.cachedInjectors.clear()}}};e.\u0275prov=Ft({token:e,providedIn:"environment",factory:()=>new e(ni(Vn))});let s=e;return s})();function Yu(s){Xu("NgStandalone"),s.getStandaloneInjector=e=>e.get(gz).getOrCreateStandaloneInjector(s)}var z_=(()=>{let e=class e{log(i){console.log(i)}warn(i){console.warn(i)}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"platform"});let s=e;return s})();var bL=new Pt("");function dp(s){return!!s&&typeof s.then=="function"}function SL(s){return!!s&&typeof s.subscribe=="function"}var yL=new Pt(""),EL=(()=>{let e=class e{constructor(){this.initialized=!1,this.done=!1,this.donePromise=new Promise((i,r)=>{this.resolve=i,this.reject=r}),this.appInits=Ue(yL,{optional:!0})??[]}runInitializers(){if(this.initialized)return;let i=[];for(let n of this.appInits){let o=n();if(dp(o))i.push(o);else if(SL(o)){let a=new Promise((l,c)=>{o.subscribe({complete:l,error:c})});i.push(a)}}let r=()=>{this.done=!0,this.resolve()};Promise.all(i).then(()=>{r()}).catch(n=>{this.reject(n)}),i.length===0&&r(),this.initialized=!0}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})(),$u=new Pt("");function _z(){qO(()=>{throw new _t(600,!1)})}function xz(s){return s.isBoundToModule}var vz=10;function Tz(s,e,t){try{let i=t();return dp(i)?i.catch(r=>{throw e.runOutsideAngular(()=>s.handleError(r)),r}):i}catch(i){throw e.runOutsideAngular(()=>s.handleError(i)),i}}var Xa=(()=>{let e=class e{constructor(){this._bootstrapListeners=[],this._runningTick=!1,this._destroyed=!1,this._destroyListeners=[],this._views=[],this.internalErrorHandler=Ue(uF),this.afterRenderEffectManager=Ue(fL),this.zonelessEnabled=Ue(VE),this.externalTestViews=new Set,this.beforeRender=new Os,this.afterTick=new Os,this.componentTypes=[],this.components=[],this.isStable=Ue(Fc).hasPendingTasks.pipe(ti(i=>!i)),this._injector=Ue(Vn)}get allViews(){return[...this.externalTestViews.keys(),...this._views]}get destroyed(){return this._destroyed}get injector(){return this._injector}bootstrap(i,r){let n=i instanceof __;if(!this._injector.get(EL).done){let f=!n&&CN(i),m=!1;throw new _t(405,m)}let a;n?a=i:a=this._injector.get(Gu).resolveComponentFactory(i),this.componentTypes.push(a.componentType);let l=xz(a)?void 0:this._injector.get(Ml),c=r||a.selector,h=a.create(za.NULL,[],c,l),u=h.location.nativeElement,d=h.injector.get(bL,null);return d?.registerApplication(u),h.onDestroy(()=>{this.detachView(h.hostView),Dy(this.components,h),d?.unregisterApplication(u)}),this._loadComponent(h),h}tick(){this._tick(!0)}_tick(i){if(this._runningTick)throw new _t(101,!1);let r=ki(null);try{this._runningTick=!0,this.detectChangesInAttachedViews(i)}catch(n){this.internalErrorHandler(n)}finally{this._runningTick=!1,ki(r),this.afterTick.next()}}detectChangesInAttachedViews(i){let r=null;this._injector.destroyed||(r=this._injector.get(zu,null,{optional:!0}));let n=0,o=this.afterRenderEffectManager;for(;n<vz;){let a=n===0;if(i||!a){this.beforeRender.next(a);for(let{_lView:l,notifyErrorHandler:c}of this._views)Cz(l,c,a,this.zonelessEnabled)}else r?.begin?.(),r?.end?.();if(n++,o.executeInternalCallbacks(),!this.allViews.some(({_lView:l})=>ep(l))&&(o.execute(),!this.allViews.some(({_lView:l})=>ep(l))))break}}attachView(i){let r=i;this._views.push(r),r.attachToAppRef(this)}detachView(i){let r=i;Dy(this._views,r),r.detachFromAppRef()}_loadComponent(i){this.attachView(i.hostView),this.tick(),this.components.push(i);let r=this._injector.get($u,[]);[...this._bootstrapListeners,...r].forEach(n=>n(i))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(i=>i()),this._views.slice().forEach(i=>i.destroy())}finally{this._destroyed=!0,this._views=[],this._bootstrapListeners=[],this._destroyListeners=[]}}onDestroy(i){return this._destroyListeners.push(i),()=>Dy(this._destroyListeners,i)}destroy(){if(this._destroyed)throw new _t(406,!1);let i=this._injector;i.destroy&&!i.destroyed&&i.destroy()}get viewCount(){return this._views.length}warnIfDestroyed(){}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})();function Dy(s,e){let t=s.indexOf(e);t>-1&&s.splice(t,1)}var Qg;function GE(s){Qg??=new WeakMap;let e=Qg.get(s);if(e)return e;let t=s.isStable.pipe(uo(i=>i)).toPromise().then(()=>{});return Qg.set(s,t),s.onDestroy(()=>Qg?.delete(s)),t}function Cz(s,e,t,i){if(!t&&!ep(s))return;iL(s,e,t&&!i?0:1)}var hE=class{constructor(e,t){this.ngModuleFactory=e,this.componentFactories=t}},zE=(()=>{let e=class e{compileModuleSync(i){return new cE(i)}compileModuleAsync(i){return Promise.resolve(this.compileModuleSync(i))}compileModuleAndAllComponentsSync(i){let r=this.compileModuleSync(i),n=bN(i),o=PF(n.declarations).reduce((a,l)=>{let c=Dc(l);return c&&a.push(new sp(c)),a},[]);return new hE(r,o)}compileModuleAndAllComponentsAsync(i){return Promise.resolve(this.compileModuleAndAllComponentsSync(i))}clearCache(){}clearCacheFor(i){}getModuleId(i){}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})();var bz=(()=>{let e=class e{constructor(){this.zone=Ue(vr),this.changeDetectionScheduler=Ue(rp),this.applicationRef=Ue(Xa)}initialize(){this._onMicrotaskEmptySubscription||(this._onMicrotaskEmptySubscription=this.zone.onMicrotaskEmpty.subscribe({next:()=>{this.changeDetectionScheduler.runningTick||this.zone.run(()=>{this.applicationRef.tick()})}}))}ngOnDestroy(){this._onMicrotaskEmptySubscription?.unsubscribe()}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})(),Sz=new Pt("",{factory:()=>!1});function AL({ngZoneFactory:s,ignoreChangesOutsideZone:e}){return s??=()=>new vr(RL()),[{provide:vr,useFactory:s},{provide:Mc,multi:!0,useFactory:()=>{let t=Ue(bz,{optional:!0});return()=>t.initialize()}},{provide:Mc,multi:!0,useFactory:()=>{let t=Ue(Ez);return()=>{t.initialize()}}},{provide:uF,useFactory:yz},e===!0?{provide:hL,useValue:!0}:[]]}function yz(){let s=Ue(vr),e=Ue(Wa);return t=>s.runOutsideAngular(()=>e.handleError(t))}function IL(s){let e=s?.ignoreChangesOutsideZone,t=AL({ngZoneFactory:()=>{let i=RL(s);return i.shouldCoalesceEventChangeDetection&&Xu("NgZone_CoalesceEvent"),new vr(i)},ignoreChangesOutsideZone:e});return Nc([{provide:Sz,useValue:!0},{provide:VE,useValue:!1},t])}function RL(s){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:s?.eventCoalescing??!1,shouldCoalesceRunChangeDetection:s?.runCoalescing??!1}}var Ez=(()=>{let e=class e{constructor(){this.subscription=new Pr,this.initialized=!1,this.zone=Ue(vr),this.pendingTasks=Ue(Fc)}initialize(){if(this.initialized)return;this.initialized=!0;let i=null;!this.zone.isStable&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(i=this.pendingTasks.add()),this.zone.runOutsideAngular(()=>{this.subscription.add(this.zone.onStable.subscribe(()=>{vr.assertNotInAngularZone(),queueMicrotask(()=>{i!==null&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(this.pendingTasks.remove(i),i=null)})}))}),this.subscription.add(this.zone.onUnstable.subscribe(()=>{vr.assertInAngularZone(),i??=this.pendingTasks.add()}))}ngOnDestroy(){this.subscription.unsubscribe()}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})();var Az=(()=>{let e=class e{constructor(){this.appRef=Ue(Xa),this.taskService=Ue(Fc),this.ngZone=Ue(vr),this.zonelessEnabled=Ue(VE),this.disableScheduling=Ue(hL,{optional:!0})??!1,this.zoneIsDefined=typeof Zone<"u"&&!!Zone.root.run,this.schedulerTickApplyArgs=[{data:{__scheduler_tick__:!0}}],this.subscriptions=new Pr,this.cancelScheduledCallback=null,this.shouldRefreshViews=!1,this.useMicrotaskScheduler=!1,this.runningTick=!1,this.pendingRenderTaskId=null,this.subscriptions.add(this.appRef.afterTick.subscribe(()=>{this.runningTick||this.cleanup()})),this.subscriptions.add(this.ngZone.onUnstable.subscribe(()=>{this.runningTick||this.cleanup()})),this.disableScheduling||=!this.zonelessEnabled&&(this.ngZone instanceof nE||!this.zoneIsDefined)}notify(i){if(!this.zonelessEnabled&&i===5)return;switch(i){case 3:case 2:case 0:case 4:case 5:case 1:{this.shouldRefreshViews=!0;break}case 8:case 7:case 6:case 9:default:}if(!this.shouldScheduleTick())return;let r=this.useMicrotaskScheduler?Zw:uL;this.pendingRenderTaskId=this.taskService.add(),this.zoneIsDefined?Zone.root.run(()=>{this.cancelScheduledCallback=r(()=>{this.tick(this.shouldRefreshViews)})}):this.cancelScheduledCallback=r(()=>{this.tick(this.shouldRefreshViews)})}shouldScheduleTick(){return!(this.disableScheduling||this.pendingRenderTaskId!==null||this.runningTick||this.appRef._runningTick||!this.zonelessEnabled&&this.zoneIsDefined&&vr.isInAngularZone())}tick(i){if(this.runningTick||this.appRef.destroyed)return;let r=this.taskService.add();try{this.ngZone.run(()=>{this.runningTick=!0,this.appRef._tick(i)},void 0,this.schedulerTickApplyArgs)}catch(n){throw this.taskService.remove(r),n}finally{this.cleanup()}this.useMicrotaskScheduler=!0,Zw(()=>{this.useMicrotaskScheduler=!1,this.taskService.remove(r)})}ngOnDestroy(){this.subscriptions.unsubscribe(),this.cleanup()}cleanup(){if(this.shouldRefreshViews=!1,this.runningTick=!1,this.cancelScheduledCallback?.(),this.cancelScheduledCallback=null,this.pendingRenderTaskId!==null){let i=this.pendingRenderTaskId;this.pendingRenderTaskId=null,this.taskService.remove(i)}}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})();function Iz(){return typeof $localize<"u"&&$localize.locale||T_}var WE=new Pt("",{providedIn:"root",factory:()=>Ue(WE,Ht.Optional|Ht.SkipSelf)||Iz()});var PL=new Pt("");var t_=null;function Rz(s=[],e){return za.create({name:e,providers:[{provide:I_,useValue:"platform"},{provide:PL,useValue:new Set([()=>t_=null])},...s]})}function Pz(s=[]){if(t_)return t_;let e=Rz(s);return t_=e,_z(),Mz(e),e}function Mz(s){s.get(EE,null)?.forEach(t=>t())}var fp=(()=>{let e=class e{};e.__NG_ELEMENT_ID__=Dz;let s=e;return s})();function Dz(s){return Oz(Ha(),jo(),(s&16)===16)}function Oz(s,e,t){if(M_(s)&&!t){let i=lp(s.index,e);return new ku(i,i)}else if(s.type&47){let i=e[Un];return new ku(i,e)}return null}function ML(s){try{let{rootComponent:e,appProviders:t,platformProviders:i}=s,r=Pz(i),n=[AL({}),{provide:rp,useExisting:Az},...t||[]],a=new v_({providers:n,parent:r,debugName:"",runEnvironmentInitializers:!1}).injector,l=a.get(vr);return l.run(()=>{a.resolveInjectorInitializers();let c=a.get(Wa,null),h;l.runOutsideAngular(()=>{h=l.onError.subscribe({next:f=>{c.handleError(f)}})});let u=()=>a.destroy(),d=r.get(PL);return d.add(u),a.onDestroy(()=>{h.unsubscribe(),d.delete(u)}),Tz(c,l,()=>{let f=a.get(EL);return f.runInitializers(),f.donePromise.then(()=>{let m=a.get(WE,T_);dz(m||T_);let g=a.get(Xa);return e!==void 0&&g.bootstrap(e),g})})})}catch(e){return Promise.reject(e)}}var nN=!1;function wz(){nN||(nN=!0,e3(),az(),mz(),hz(),sz(),tz(),OG(),V3())}function Nz(s,e){return GE(s)}function DL(){return Nc([{provide:jg,useFactory:()=>{let s=!0;return qg()&&(s=!!Ue(Hu,{optional:!0})?.get(yF,null)),s&&Xu("NgHydration"),s}},{provide:Mc,useValue:()=>{EG(!1),qg()&&Ue(jg)&&(Fz(),wz())},multi:!0},{provide:RF,useFactory:()=>qg()&&Ue(jg)},{provide:$u,useFactory:()=>{if(qg()&&Ue(jg)){let s=Ue(Xa),e=Ue(za);return()=>{Nz(s,e).then(()=>{PG(s)})}}return()=>{}},multi:!0}])}function Fz(){let s=N_(),e;for(let t of s.body.childNodes)if(t.nodeType===Node.COMMENT_NODE&&t.textContent?.trim()===Zk){e=t;break}if(!e)throw new _t(-507,!1)}var LL=null;function ju(){return LL}function BL(s){LL??=s}var W_=class{};var hn=new Pt(""),VL=(()=>{let e=class e{historyGo(i){throw new Error("")}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:()=>Ue(kz),providedIn:"platform"});let s=e;return s})();var kz=(()=>{let e=class e extends VL{constructor(){super(),this._doc=Ue(hn),this._location=window.location,this._history=window.history}getBaseHrefFromDOM(){return ju().getBaseHref(this._doc)}onPopState(i){let r=ju().getGlobalEventTarget(this._doc,"window");return r.addEventListener("popstate",i,!1),()=>r.removeEventListener("popstate",i)}onHashChange(i){let r=ju().getGlobalEventTarget(this._doc,"window");return r.addEventListener("hashchange",i,!1),()=>r.removeEventListener("hashchange",i)}get href(){return this._location.href}get protocol(){return this._location.protocol}get hostname(){return this._location.hostname}get port(){return this._location.port}get pathname(){return this._location.pathname}get search(){return this._location.search}get hash(){return this._location.hash}set pathname(i){this._location.pathname=i}pushState(i,r,n){this._history.pushState(i,r,n)}replaceState(i,r,n){this._history.replaceState(i,r,n)}forward(){this._history.forward()}back(){this._history.back()}historyGo(i=0){this._history.go(i)}getState(){return this._history.state}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:()=>new e,providedIn:"platform"});let s=e;return s})();function UL(s,e){if(s.length==0)return e;if(e.length==0)return s;let t=0;return s.endsWith("/")&&t++,e.startsWith("/")&&t++,t==2?s+e.substring(1):t==1?s+e:s+"/"+e}function OL(s){let e=s.match(/#|\?|$/),t=e&&e.index||s.length,i=t-(s[t-1]==="/"?1:0);return s.slice(0,i)+s.slice(t)}function Vc(s){return s&&s[0]!=="?"?"?"+s:s}var X_=(()=>{let e=class e{historyGo(i){throw new Error("")}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:()=>Ue(kL),providedIn:"root"});let s=e;return s})(),Gz=new Pt(""),kL=(()=>{let e=class e extends X_{constructor(i,r){super(),this._platformLocation=i,this._removeListenerFns=[],this._baseHref=r??this._platformLocation.getBaseHrefFromDOM()??Ue(hn).location?.origin??""}ngOnDestroy(){for(;this._removeListenerFns.length;)this._removeListenerFns.pop()()}onPopState(i){this._removeListenerFns.push(this._platformLocation.onPopState(i),this._platformLocation.onHashChange(i))}getBaseHref(){return this._baseHref}prepareExternalUrl(i){return UL(this._baseHref,i)}path(i=!1){let r=this._platformLocation.pathname+Vc(this._platformLocation.search),n=this._platformLocation.hash;return n&&i?`${r}${n}`:r}pushState(i,r,n,o){let a=this.prepareExternalUrl(n+Vc(o));this._platformLocation.pushState(i,r,a)}replaceState(i,r,n,o){let a=this.prepareExternalUrl(n+Vc(o));this._platformLocation.replaceState(i,r,a)}forward(){this._platformLocation.forward()}back(){this._platformLocation.back()}getState(){return this._platformLocation.getState()}historyGo(i=0){this._platformLocation.historyGo?.(i)}};e.\u0275fac=function(r){return new(r||e)(ni(VL),ni(Gz,8))},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})();var mp=(()=>{let e=class e{constructor(i){this._subject=new ws,this._urlChangeListeners=[],this._urlChangeSubscription=null,this._locationStrategy=i;let r=this._locationStrategy.getBaseHref();this._basePath=Hz(OL(wL(r))),this._locationStrategy.onPopState(n=>{this._subject.emit({url:this.path(!0),pop:!0,state:n.state,type:n.type})})}ngOnDestroy(){this._urlChangeSubscription?.unsubscribe(),this._urlChangeListeners=[]}path(i=!1){return this.normalize(this._locationStrategy.path(i))}getState(){return this._locationStrategy.getState()}isCurrentPathEqualTo(i,r=""){return this.path()==this.normalize(i+Vc(r))}normalize(i){return e.stripTrailingSlash(Wz(this._basePath,wL(i)))}prepareExternalUrl(i){return i&&i[0]!=="/"&&(i="/"+i),this._locationStrategy.prepareExternalUrl(i)}go(i,r="",n=null){this._locationStrategy.pushState(n,"",i,r),this._notifyUrlChangeListeners(this.prepareExternalUrl(i+Vc(r)),n)}replaceState(i,r="",n=null){this._locationStrategy.replaceState(n,"",i,r),this._notifyUrlChangeListeners(this.prepareExternalUrl(i+Vc(r)),n)}forward(){this._locationStrategy.forward()}back(){this._locationStrategy.back()}historyGo(i=0){this._locationStrategy.historyGo?.(i)}onUrlChange(i){return this._urlChangeListeners.push(i),this._urlChangeSubscription??=this.subscribe(r=>{this._notifyUrlChangeListeners(r.url,r.state)}),()=>{let r=this._urlChangeListeners.indexOf(i);this._urlChangeListeners.splice(r,1),this._urlChangeListeners.length===0&&(this._urlChangeSubscription?.unsubscribe(),this._urlChangeSubscription=null)}}_notifyUrlChangeListeners(i="",r){this._urlChangeListeners.forEach(n=>n(i,r))}subscribe(i,r,n){return this._subject.subscribe({next:i,error:r,complete:n})}};e.normalizeQueryParams=Vc,e.joinWithSlash=UL,e.stripTrailingSlash=OL,e.\u0275fac=function(r){return new(r||e)(ni(X_))},e.\u0275prov=Ft({token:e,factory:()=>zz(),providedIn:"root"});let s=e;return s})();function zz(){return new mp(ni(X_))}function Wz(s,e){if(!s||!e.startsWith(s))return e;let t=e.substring(s.length);return t===""||["/",";","?","#"].includes(t[0])?t:e}function wL(s){return s.replace(/\/index.html$/,"")}function Hz(s){if(new RegExp("^(https?:)?//").test(s)){let[,t]=s.split(/\/\/[^\/]+/);return t}return s}function XE(s,e){e=encodeURIComponent(e);for(let t of s.split(";")){let i=t.indexOf("="),[r,n]=i==-1?[t,""]:[t.slice(0,i),t.slice(i+1)];if(r.trim()===e)return decodeURIComponent(n)}return null}var YE=(()=>{let e=class e{};e.\u0275fac=function(r){return new(r||e)},e.\u0275mod=A_({type:e}),e.\u0275inj=S_({});let s=e;return s})(),$E="browser",Xz="server";function GL(s){return s===$E}function gp(s){return s===Xz}var H_=class{};var $_=class s{constructor(e){this.normalizedNames=new Map,this.lazyUpdate=null,e?typeof e=="string"?this.lazyInit=()=>{this.headers=new Map,e.split(`
`).forEach(t=>{let i=t.indexOf(":");if(i>0){let r=t.slice(0,i),n=r.toLowerCase(),o=t.slice(i+1).trim();this.maybeSetNormalizedName(r,n),this.headers.has(n)?this.headers.get(n).push(o):this.headers.set(n,[o])}})}:typeof Headers<"u"&&e instanceof Headers?(this.headers=new Map,e.forEach((t,i)=>{this.setHeaderEntries(i,t)})):this.lazyInit=()=>{this.headers=new Map,Object.entries(e).forEach(([t,i])=>{this.setHeaderEntries(t,i)})}:this.headers=new Map}has(e){return this.init(),this.headers.has(e.toLowerCase())}get(e){this.init();let t=this.headers.get(e.toLowerCase());return t&&t.length>0?t[0]:null}keys(){return this.init(),Array.from(this.normalizedNames.values())}getAll(e){return this.init(),this.headers.get(e.toLowerCase())||null}append(e,t){return this.clone({name:e,value:t,op:"a"})}set(e,t){return this.clone({name:e,value:t,op:"s"})}delete(e,t){return this.clone({name:e,value:t,op:"d"})}maybeSetNormalizedName(e,t){this.normalizedNames.has(t)||this.normalizedNames.set(t,e)}init(){this.lazyInit&&(this.lazyInit instanceof s?this.copyFrom(this.lazyInit):this.lazyInit(),this.lazyInit=null,this.lazyUpdate&&(this.lazyUpdate.forEach(e=>this.applyUpdate(e)),this.lazyUpdate=null))}copyFrom(e){e.init(),Array.from(e.headers.keys()).forEach(t=>{this.headers.set(t,e.headers.get(t)),this.normalizedNames.set(t,e.normalizedNames.get(t))})}clone(e){let t=new s;return t.lazyInit=this.lazyInit&&this.lazyInit instanceof s?this.lazyInit:this,t.lazyUpdate=(this.lazyUpdate||[]).concat([e]),t}applyUpdate(e){let t=e.name.toLowerCase();switch(e.op){case"a":case"s":let i=e.value;if(typeof i=="string"&&(i=[i]),i.length===0)return;this.maybeSetNormalizedName(e.name,t);let r=(e.op==="a"?this.headers.get(t):void 0)||[];r.push(...i),this.headers.set(t,r);break;case"d":let n=e.value;if(!n)this.headers.delete(t),this.normalizedNames.delete(t);else{let o=this.headers.get(t);if(!o)return;o=o.filter(a=>n.indexOf(a)===-1),o.length===0?(this.headers.delete(t),this.normalizedNames.delete(t)):this.headers.set(t,o)}break}}setHeaderEntries(e,t){let i=(Array.isArray(t)?t:[t]).map(n=>n.toString()),r=e.toLowerCase();this.headers.set(r,i),this.maybeSetNormalizedName(e,r)}forEach(e){this.init(),Array.from(this.normalizedNames.keys()).forEach(t=>e(this.normalizedNames.get(t),this.headers.get(t)))}};var qL=function(s){return s[s.Sent=0]="Sent",s[s.UploadProgress=1]="UploadProgress",s[s.ResponseHeader=2]="ResponseHeader",s[s.DownloadProgress=3]="DownloadProgress",s[s.Response=4]="Response",s[s.User=5]="User",s}(qL||{}),jE=class{constructor(e,t=200,i="OK"){this.headers=e.headers||new $_,this.status=e.status!==void 0?e.status:t,this.statusText=e.statusText||i,this.url=e.url||null,this.ok=this.status>=200&&this.status<300}};var j_=class s extends jE{constructor(e={}){super(e),this.type=qL.Response,this.body=e.body!==void 0?e.body:null}clone(e={}){return new s({body:e.body!==void 0?e.body:this.body,headers:e.headers||this.headers,status:e.status!==void 0?e.status:this.status,statusText:e.statusText||this.statusText,url:e.url||this.url||void 0})}};var Yz=new Pt("");var $z=new Pt(""),zL="b",WL="h",HL="s",XL="st",YL="u",$L="rt",Y_=new Pt(""),jz=["GET","HEAD"];function qz(s,e){let f=Ue(Y_),{isCacheActive:t}=f,i=SO(f,["isCacheActive"]),{transferCache:r,method:n}=s;if(!t||r===!1||n==="POST"&&!i.includePostRequests&&!r||n!=="POST"&&!jz.includes(n)||!i.includeRequestsWithAuthHeaders&&Qz(s)||i.filter?.(s)===!1)return e(s);let o=Ue(Hu),a=Ue($z,{optional:!0}),l=gp(Ue(Gn));if(a&&!l)throw new _t(2803,!1);let c=l&&a?eW(s.url,a):s.url,h=Zz(s,c),u=o.get(h,null),d=i.includeHeaders;if(typeof r=="object"&&r.includeHeaders&&(d=r.includeHeaders),u){let{[zL]:m,[$L]:g,[WL]:_,[HL]:x,[XL]:b,[YL]:C}=u,R=m;switch(g){case"arraybuffer":R=new TextEncoder().encode(m).buffer;break;case"blob":R=new Blob([m]);break}let E=new $_(_);return Rt(new j_({body:R,headers:E,status:x,statusText:b,url:C}))}return e(s).pipe(kr(m=>{m instanceof j_&&l&&o.set(h,{[zL]:m.body,[WL]:Kz(m.headers,d),[HL]:m.status,[XL]:m.statusText,[YL]:c,[$L]:s.responseType})}))}function Qz(s){return s.headers.has("authorization")||s.headers.has("proxy-authorization")}function Kz(s,e){if(!e)return{};let t={};for(let i of e){let r=s.getAll(i);r!==null&&(t[i]=r)}return t}function jL(s){return[...s.keys()].sort().map(e=>`${e}=${s.getAll(e)}`).join("&")}function Zz(s,e){let{params:t,method:i,responseType:r}=s,n=jL(t),o=s.serializeBody();o instanceof URLSearchParams?o=jL(o):typeof o!="string"&&(o="");let a=[i,r,e,o,n].join("|"),l=Jz(a);return l}function Jz(s){let e=0;for(let t of s)e=Math.imul(31,e)+t.charCodeAt(0)<<0;return e+=2147483648,e.toString()}function QL(s){return[{provide:Y_,useFactory:()=>(Xu("NgHttpTransferCache"),ie({isCacheActive:!0},s))},{provide:Yz,useValue:qz,multi:!0,deps:[Hu,Y_]},{provide:$u,multi:!0,useFactory:()=>{let e=Ue(Xa),t=Ue(Y_);return()=>{GE(e).then(()=>{t.isCacheActive=!1})}}}]}function eW(s,e){let t=new URL(s,"resolve://").origin,i=e[t];return i?s.replace(t,i):s}var KE=class extends W_{constructor(){super(...arguments),this.supportsDOMEvents=!0}},ZE=class s extends KE{static makeCurrent(){BL(new s)}onAndCancel(e,t,i){return e.addEventListener(t,i),()=>{e.removeEventListener(t,i)}}dispatchEvent(e,t){e.dispatchEvent(t)}remove(e){e.parentNode&&e.parentNode.removeChild(e)}createElement(e,t){return t=t||this.getDefaultDocument(),t.createElement(e)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}isShadowRoot(e){return e instanceof DocumentFragment}getGlobalEventTarget(e,t){return t==="window"?window:t==="document"?e:t==="body"?e.body:null}getBaseHref(e){let t=iW();return t==null?null:rW(t)}resetBaseElement(){_p=null}getUserAgent(){return window.navigator.userAgent}getCookie(e){return XE(document.cookie,e)}},_p=null;function iW(){return _p=_p||document.querySelector("base"),_p?_p.getAttribute("href"):null}function rW(s){return new URL(s,document.baseURI).pathname}var sW=(()=>{let e=class e{build(){return new XMLHttpRequest}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac});let s=e;return s})(),JE=new Pt(""),e1=(()=>{let e=class e{constructor(i,r){this._zone=r,this._eventNameToPlugin=new Map,i.forEach(n=>{n.manager=this}),this._plugins=i.slice().reverse()}addEventListener(i,r,n){return this._findPluginFor(r).addEventListener(i,r,n)}getZone(){return this._zone}_findPluginFor(i){let r=this._eventNameToPlugin.get(i);if(r)return r;if(r=this._plugins.find(o=>o.supports(i)),!r)throw new _t(5101,!1);return this._eventNameToPlugin.set(i,r),r}};e.\u0275fac=function(r){return new(r||e)(ni(JE),ni(vr))},e.\u0275prov=Ft({token:e,factory:e.\u0275fac});let s=e;return s})(),q_=class{constructor(e){this._doc=e}},qE="ng-app-id",t1=(()=>{let e=class e{constructor(i,r,n,o={}){this.doc=i,this.appId=r,this.nonce=n,this.platformId=o,this.styleRef=new Map,this.hostNodes=new Set,this.styleNodesInDOM=this.collectServerRenderedStyles(),this.platformIsServer=gp(o),this.resetHostNodes()}addStyles(i){for(let r of i)this.changeUsageCount(r,1)===1&&this.onStyleAdded(r)}removeStyles(i){for(let r of i)this.changeUsageCount(r,-1)<=0&&this.onStyleRemoved(r)}ngOnDestroy(){let i=this.styleNodesInDOM;i&&(i.forEach(r=>r.remove()),i.clear());for(let r of this.getAllStyles())this.onStyleRemoved(r);this.resetHostNodes()}addHost(i){this.hostNodes.add(i);for(let r of this.getAllStyles())this.addStyleToHost(i,r)}removeHost(i){this.hostNodes.delete(i)}getAllStyles(){return this.styleRef.keys()}onStyleAdded(i){for(let r of this.hostNodes)this.addStyleToHost(r,i)}onStyleRemoved(i){let r=this.styleRef;r.get(i)?.elements?.forEach(n=>n.remove()),r.delete(i)}collectServerRenderedStyles(){let i=this.doc.head?.querySelectorAll(`style[${qE}="${this.appId}"]`);if(i?.length){let r=new Map;return i.forEach(n=>{n.textContent!=null&&r.set(n.textContent,n)}),r}return null}changeUsageCount(i,r){let n=this.styleRef;if(n.has(i)){let o=n.get(i);return o.usage+=r,o.usage}return n.set(i,{usage:r,elements:[]}),r}getStyleElement(i,r){let n=this.styleNodesInDOM,o=n?.get(r);if(o?.parentNode===i)return n.delete(r),o.removeAttribute(qE),o;{let a=this.doc.createElement("style");return this.nonce&&a.setAttribute("nonce",this.nonce),a.textContent=r,this.platformIsServer&&a.setAttribute(qE,this.appId),i.appendChild(a),a}}addStyleToHost(i,r){let n=this.getStyleElement(i,r),o=this.styleRef,a=o.get(r)?.elements;a?a.push(n):o.set(r,{elements:[n],usage:1})}resetHostNodes(){let i=this.hostNodes;i.clear(),i.add(this.doc.head)}};e.\u0275fac=function(r){return new(r||e)(ni(hn),ni(F_),ni(AE,8),ni(Gn))},e.\u0275prov=Ft({token:e,factory:e.\u0275fac});let s=e;return s})(),QE={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/Math/MathML"},iA=/%COMP%/g,i1="%COMP%",nW=`_nghost-${i1}`,oW=`_ngcontent-${i1}`,aW=!0,lW=new Pt("",{providedIn:"root",factory:()=>aW});function cW(s){return oW.replace(iA,s)}function hW(s){return nW.replace(iA,s)}function r1(s,e){return e.map(t=>t.replace(iA,s))}var KL=(()=>{let e=class e{constructor(i,r,n,o,a,l,c,h=null){this.eventManager=i,this.sharedStylesHost=r,this.appId=n,this.removeStylesOnCompDestroy=o,this.doc=a,this.platformId=l,this.ngZone=c,this.nonce=h,this.rendererByCompId=new Map,this.platformIsServer=gp(l),this.defaultRenderer=new xp(i,a,c,this.platformIsServer)}createRenderer(i,r){if(!i||!r)return this.defaultRenderer;this.platformIsServer&&r.encapsulation===Yo.ShadowDom&&(r=Kt(ie({},r),{encapsulation:Yo.Emulated}));let n=this.getOrCreateRenderer(i,r);return n instanceof Q_?n.applyToHost(i):n instanceof vp&&n.applyStyles(),n}getOrCreateRenderer(i,r){let n=this.rendererByCompId,o=n.get(r.id);if(!o){let a=this.doc,l=this.ngZone,c=this.eventManager,h=this.sharedStylesHost,u=this.removeStylesOnCompDestroy,d=this.platformIsServer;switch(r.encapsulation){case Yo.Emulated:o=new Q_(c,h,r,this.appId,u,a,l,d);break;case Yo.ShadowDom:return new eA(c,h,i,r,a,l,this.nonce,d);default:o=new vp(c,h,r,u,a,l,d);break}n.set(r.id,o)}return o}ngOnDestroy(){this.rendererByCompId.clear()}};e.\u0275fac=function(r){return new(r||e)(ni(e1),ni(t1),ni(F_),ni(lW),ni(hn),ni(Gn),ni(vr),ni(AE))},e.\u0275prov=Ft({token:e,factory:e.\u0275fac});let s=e;return s})(),xp=class{constructor(e,t,i,r){this.eventManager=e,this.doc=t,this.ngZone=i,this.platformIsServer=r,this.data=Object.create(null),this.throwOnSyntheticProps=!0,this.destroyNode=null}destroy(){}createElement(e,t){return t?this.doc.createElementNS(QE[t]||t,e):this.doc.createElement(e)}createComment(e){return this.doc.createComment(e)}createText(e){return this.doc.createTextNode(e)}appendChild(e,t){(ZL(e)?e.content:e).appendChild(t)}insertBefore(e,t,i){e&&(ZL(e)?e.content:e).insertBefore(t,i)}removeChild(e,t){e&&e.removeChild(t)}selectRootElement(e,t){let i=typeof e=="string"?this.doc.querySelector(e):e;if(!i)throw new _t(-5104,!1);return t||(i.textContent=""),i}parentNode(e){return e.parentNode}nextSibling(e){return e.nextSibling}setAttribute(e,t,i,r){if(r){t=r+":"+t;let n=QE[r];n?e.setAttributeNS(n,t,i):e.setAttribute(t,i)}else e.setAttribute(t,i)}removeAttribute(e,t,i){if(i){let r=QE[i];r?e.removeAttributeNS(r,t):e.removeAttribute(`${i}:${t}`)}else e.removeAttribute(t)}addClass(e,t){e.classList.add(t)}removeClass(e,t){e.classList.remove(t)}setStyle(e,t,i,r){r&(Lc.DashCase|Lc.Important)?e.style.setProperty(t,i,r&Lc.Important?"important":""):e.style[t]=i}removeStyle(e,t,i){i&Lc.DashCase?e.style.removeProperty(t):e.style[t]=""}setProperty(e,t,i){e!=null&&(e[t]=i)}setValue(e,t){e.nodeValue=t}listen(e,t,i){if(typeof e=="string"&&(e=ju().getGlobalEventTarget(this.doc,e),!e))throw new Error(`Unsupported event target ${e} for event ${t}`);return this.eventManager.addEventListener(e,t,this.decoratePreventDefault(i))}decoratePreventDefault(e){return t=>{if(t==="__ngUnwrap__")return e;(this.platformIsServer?this.ngZone.runGuarded(()=>e(t)):e(t))===!1&&t.preventDefault()}}};function ZL(s){return s.tagName==="TEMPLATE"&&s.content!==void 0}var eA=class extends xp{constructor(e,t,i,r,n,o,a,l){super(e,n,o,l),this.sharedStylesHost=t,this.hostEl=i,this.shadowRoot=i.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);let c=r1(r.id,r.styles);for(let h of c){let u=document.createElement("style");a&&u.setAttribute("nonce",a),u.textContent=h,this.shadowRoot.appendChild(u)}}nodeOrShadowRoot(e){return e===this.hostEl?this.shadowRoot:e}appendChild(e,t){return super.appendChild(this.nodeOrShadowRoot(e),t)}insertBefore(e,t,i){return super.insertBefore(this.nodeOrShadowRoot(e),t,i)}removeChild(e,t){return super.removeChild(this.nodeOrShadowRoot(e),t)}parentNode(e){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(e)))}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}},vp=class extends xp{constructor(e,t,i,r,n,o,a,l){super(e,n,o,a),this.sharedStylesHost=t,this.removeStylesOnCompDestroy=r,this.styles=l?r1(l,i.styles):i.styles}applyStyles(){this.sharedStylesHost.addStyles(this.styles)}destroy(){this.removeStylesOnCompDestroy&&this.sharedStylesHost.removeStyles(this.styles)}},Q_=class extends vp{constructor(e,t,i,r,n,o,a,l){let c=r+"-"+i.id;super(e,t,i,n,o,a,l,c),this.contentAttr=cW(c),this.hostAttr=hW(c)}applyToHost(e){this.applyStyles(),this.setAttribute(e,this.hostAttr,"")}createElement(e,t){let i=super.createElement(e,t);return super.setAttribute(i,this.contentAttr,""),i}},uW=(()=>{let e=class e extends q_{constructor(i){super(i)}supports(i){return!0}addEventListener(i,r,n){return i.addEventListener(r,n,!1),()=>this.removeEventListener(i,r,n)}removeEventListener(i,r,n){return i.removeEventListener(r,n)}};e.\u0275fac=function(r){return new(r||e)(ni(hn))},e.\u0275prov=Ft({token:e,factory:e.\u0275fac});let s=e;return s})(),JL=["alt","control","meta","shift"],dW={"\b":"Backspace","	":"Tab","\x7F":"Delete","\x1B":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},fW={alt:s=>s.altKey,control:s=>s.ctrlKey,meta:s=>s.metaKey,shift:s=>s.shiftKey},pW=(()=>{let e=class e extends q_{constructor(i){super(i)}supports(i){return e.parseEventName(i)!=null}addEventListener(i,r,n){let o=e.parseEventName(r),a=e.eventCallback(o.fullKey,n,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>ju().onAndCancel(i,o.domEventName,a))}static parseEventName(i){let r=i.toLowerCase().split("."),n=r.shift();if(r.length===0||!(n==="keydown"||n==="keyup"))return null;let o=e._normalizeKey(r.pop()),a="",l=r.indexOf("code");if(l>-1&&(r.splice(l,1),a="code."),JL.forEach(h=>{let u=r.indexOf(h);u>-1&&(r.splice(u,1),a+=h+".")}),a+=o,r.length!=0||o.length===0)return null;let c={};return c.domEventName=n,c.fullKey=a,c}static matchEventFullKeyCode(i,r){let n=dW[i.key]||i.key,o="";return r.indexOf("code.")>-1&&(n=i.code,o="code."),n==null||!n?!1:(n=n.toLowerCase(),n===" "?n="space":n==="."&&(n="dot"),JL.forEach(a=>{if(a!==n){let l=fW[a];l(i)&&(o+=a+".")}}),o+=n,o===r)}static eventCallback(i,r,n){return o=>{e.matchEventFullKeyCode(o,i)&&n.runGuarded(()=>r(o))}}static _normalizeKey(i){return i==="esc"?"escape":i}};e.\u0275fac=function(r){return new(r||e)(ni(hn))},e.\u0275prov=Ft({token:e,factory:e.\u0275fac});let s=e;return s})();function s1(s,e){return ML(ie({rootComponent:s},mW(e)))}function mW(s){return{appProviders:[...TW,...s?.providers??[]],platformProviders:vW}}function gW(){ZE.makeCurrent()}function _W(){return new Wa}function xW(){return vF(document),document}var vW=[{provide:Gn,useValue:$E},{provide:EE,useValue:gW,multi:!0},{provide:hn,useFactory:xW,deps:[]}];var TW=[{provide:I_,useValue:"root"},{provide:Wa,useFactory:_W,deps:[]},{provide:JE,useClass:uW,multi:!0,deps:[hn,vr,Gn]},{provide:JE,useClass:pW,multi:!0,deps:[hn]},KL,t1,e1,{provide:zu,useExisting:KL},{provide:H_,useClass:sW,deps:[]},[]];var n1=(()=>{let e=class e{constructor(i){this._doc=i}getTitle(){return this._doc.title}setTitle(i){this._doc.title=i||""}};e.\u0275fac=function(r){return new(r||e)(ni(hn))},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})();var tA=function(s){return s[s.NoHttpTransferCache=0]="NoHttpTransferCache",s[s.HttpTransferCacheOptions=1]="HttpTransferCacheOptions",s[s.I18nSupport=2]="I18nSupport",s[s.EventReplay=3]="EventReplay",s}(tA||{});function o1(...s){let e=[],t=new Set,i=t.has(tA.HttpTransferCacheOptions);for(let{\u0275providers:r,\u0275kind:n}of s)t.add(n),r.length&&e.push(r);return Nc([[],DL(),t.has(tA.NoHttpTransferCache)||i?[]:QL({}),e])}var Ut="primary",Lp=Symbol("RouteTitle"),aA=class{constructor(e){this.params=e||{}}has(e){return Object.prototype.hasOwnProperty.call(this.params,e)}get(e){if(this.has(e)){let t=this.params[e];return Array.isArray(t)?t[0]:t}return null}getAll(e){if(this.has(e)){let t=this.params[e];return Array.isArray(t)?t:[t]}return[]}get keys(){return Object.keys(this.params)}};function ed(s){return new aA(s)}function bW(s,e,t){let i=t.path.split("/");if(i.length>s.length||t.pathMatch==="full"&&(e.hasChildren()||i.length<s.length))return null;let r={};for(let n=0;n<i.length;n++){let o=i[n],a=s[n];if(o[0]===":")r[o.substring(1)]=a;else if(o!==a.path)return null}return{consumed:s.slice(0,i.length),posParams:r}}function SW(s,e){if(s.length!==e.length)return!1;for(let t=0;t<s.length;++t)if(!Zo(s[t],e[t]))return!1;return!0}function Zo(s,e){let t=s?lA(s):void 0,i=e?lA(e):void 0;if(!t||!i||t.length!=i.length)return!1;let r;for(let n=0;n<t.length;n++)if(r=t[n],!p1(s[r],e[r]))return!1;return!0}function lA(s){return[...Object.keys(s),...Object.getOwnPropertySymbols(s)]}function p1(s,e){if(Array.isArray(s)&&Array.isArray(e)){if(s.length!==e.length)return!1;let t=[...s].sort(),i=[...e].sort();return t.every((r,n)=>i[n]===r)}else return s===e}function m1(s){return s.length>0?s[s.length-1]:null}function wl(s){return py(s)?s:dp(s)?Mr(Promise.resolve(s)):Rt(s)}var yW={exact:_1,subset:x1},g1={exact:EW,subset:AW,ignored:()=>!0};function a1(s,e,t){return yW[t.paths](s.root,e.root,t.matrixParams)&&g1[t.queryParams](s.queryParams,e.queryParams)&&!(t.fragment==="exact"&&s.fragment!==e.fragment)}function EW(s,e){return Zo(s,e)}function _1(s,e,t){if(!kc(s.segments,e.segments)||!J_(s.segments,e.segments,t)||s.numberOfChildren!==e.numberOfChildren)return!1;for(let i in e.children)if(!s.children[i]||!_1(s.children[i],e.children[i],t))return!1;return!0}function AW(s,e){return Object.keys(e).length<=Object.keys(s).length&&Object.keys(e).every(t=>p1(s[t],e[t]))}function x1(s,e,t){return v1(s,e,e.segments,t)}function v1(s,e,t,i){if(s.segments.length>t.length){let r=s.segments.slice(0,t.length);return!(!kc(r,t)||e.hasChildren()||!J_(r,t,i))}else if(s.segments.length===t.length){if(!kc(s.segments,t)||!J_(s.segments,t,i))return!1;for(let r in e.children)if(!s.children[r]||!x1(s.children[r],e.children[r],i))return!1;return!0}else{let r=t.slice(0,s.segments.length),n=t.slice(s.segments.length);return!kc(s.segments,r)||!J_(s.segments,r,i)||!s.children[Ut]?!1:v1(s.children[Ut],e,n,i)}}function J_(s,e,t){return e.every((i,r)=>g1[t](s[r].parameters,i.parameters))}var Ol=class{constructor(e=new Ai([],{}),t={},i=null){this.root=e,this.queryParams=t,this.fragment=i}get queryParamMap(){return this._queryParamMap??=ed(this.queryParams),this._queryParamMap}toString(){return PW.serialize(this)}},Ai=class{constructor(e,t){this.segments=e,this.children=t,this.parent=null,Object.values(t).forEach(i=>i.parent=this)}hasChildren(){return this.numberOfChildren>0}get numberOfChildren(){return Object.keys(this.children).length}toString(){return ex(this)}},Uc=class{constructor(e,t){this.path=e,this.parameters=t}get parameterMap(){return this._parameterMap??=ed(this.parameters),this._parameterMap}toString(){return C1(this)}};function IW(s,e){return kc(s,e)&&s.every((t,i)=>Zo(t.parameters,e[i].parameters))}function kc(s,e){return s.length!==e.length?!1:s.every((t,i)=>t.path===e[i].path)}function RW(s,e){let t=[];return Object.entries(s.children).forEach(([i,r])=>{i===Ut&&(t=t.concat(e(r,i)))}),Object.entries(s.children).forEach(([i,r])=>{i!==Ut&&(t=t.concat(e(r,i)))}),t}var NA=(()=>{let e=class e{};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:()=>new Ap,providedIn:"root"});let s=e;return s})(),Ap=class{parse(e){let t=new hA(e);return new Ol(t.parseRootSegment(),t.parseQueryParams(),t.parseFragment())}serialize(e){let t=`/${Tp(e.root,!0)}`,i=OW(e.queryParams),r=typeof e.fragment=="string"?`#${MW(e.fragment)}`:"";return`${t}${i}${r}`}},PW=new Ap;function ex(s){return s.segments.map(e=>C1(e)).join("/")}function Tp(s,e){if(!s.hasChildren())return ex(s);if(e){let t=s.children[Ut]?Tp(s.children[Ut],!1):"",i=[];return Object.entries(s.children).forEach(([r,n])=>{r!==Ut&&i.push(`${r}:${Tp(n,!1)}`)}),i.length>0?`${t}(${i.join("//")})`:t}else{let t=RW(s,(i,r)=>r===Ut?[Tp(s.children[Ut],!1)]:[`${r}:${Tp(i,!1)}`]);return Object.keys(s.children).length===1&&s.children[Ut]!=null?`${ex(s)}/${t[0]}`:`${ex(s)}/(${t.join("//")})`}}function T1(s){return encodeURIComponent(s).replace(/%40/g,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",")}function K_(s){return T1(s).replace(/%3B/gi,";")}function MW(s){return encodeURI(s)}function cA(s){return T1(s).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/%26/gi,"&")}function tx(s){return decodeURIComponent(s)}function l1(s){return tx(s.replace(/\+/g,"%20"))}function C1(s){return`${cA(s.path)}${DW(s.parameters)}`}function DW(s){return Object.entries(s).map(([e,t])=>`;${cA(e)}=${cA(t)}`).join("")}function OW(s){let e=Object.entries(s).map(([t,i])=>Array.isArray(i)?i.map(r=>`${K_(t)}=${K_(r)}`).join("&"):`${K_(t)}=${K_(i)}`).filter(t=>t);return e.length?`?${e.join("&")}`:""}var wW=/^[^\/()?;#]+/;function rA(s){let e=s.match(wW);return e?e[0]:""}var NW=/^[^\/()?;=#]+/;function FW(s){let e=s.match(NW);return e?e[0]:""}var LW=/^[^=?&#]+/;function BW(s){let e=s.match(LW);return e?e[0]:""}var VW=/^[^&#]+/;function UW(s){let e=s.match(VW);return e?e[0]:""}var hA=class{constructor(e){this.url=e,this.remaining=e}parseRootSegment(){return this.consumeOptional("/"),this.remaining===""||this.peekStartsWith("?")||this.peekStartsWith("#")?new Ai([],{}):new Ai([],this.parseChildren())}parseQueryParams(){let e={};if(this.consumeOptional("?"))do this.parseQueryParam(e);while(this.consumeOptional("&"));return e}parseFragment(){return this.consumeOptional("#")?decodeURIComponent(this.remaining):null}parseChildren(){if(this.remaining==="")return{};this.consumeOptional("/");let e=[];for(this.peekStartsWith("(")||e.push(this.parseSegment());this.peekStartsWith("/")&&!this.peekStartsWith("//")&&!this.peekStartsWith("/(");)this.capture("/"),e.push(this.parseSegment());let t={};this.peekStartsWith("/(")&&(this.capture("/"),t=this.parseParens(!0));let i={};return this.peekStartsWith("(")&&(i=this.parseParens(!1)),(e.length>0||Object.keys(t).length>0)&&(i[Ut]=new Ai(e,t)),i}parseSegment(){let e=rA(this.remaining);if(e===""&&this.peekStartsWith(";"))throw new _t(4009,!1);return this.capture(e),new Uc(tx(e),this.parseMatrixParams())}parseMatrixParams(){let e={};for(;this.consumeOptional(";");)this.parseParam(e);return e}parseParam(e){let t=FW(this.remaining);if(!t)return;this.capture(t);let i="";if(this.consumeOptional("=")){let r=rA(this.remaining);r&&(i=r,this.capture(i))}e[tx(t)]=tx(i)}parseQueryParam(e){let t=BW(this.remaining);if(!t)return;this.capture(t);let i="";if(this.consumeOptional("=")){let o=UW(this.remaining);o&&(i=o,this.capture(i))}let r=l1(t),n=l1(i);if(e.hasOwnProperty(r)){let o=e[r];Array.isArray(o)||(o=[o],e[r]=o),o.push(n)}else e[r]=n}parseParens(e){let t={};for(this.capture("(");!this.consumeOptional(")")&&this.remaining.length>0;){let i=rA(this.remaining),r=this.remaining[i.length];if(r!=="/"&&r!==")"&&r!==";")throw new _t(4010,!1);let n;i.indexOf(":")>-1?(n=i.slice(0,i.indexOf(":")),this.capture(n),this.capture(":")):e&&(n=Ut);let o=this.parseChildren();t[n]=Object.keys(o).length===1?o[Ut]:new Ai([],o),this.consumeOptional("//")}return t}peekStartsWith(e){return this.remaining.startsWith(e)}consumeOptional(e){return this.peekStartsWith(e)?(this.remaining=this.remaining.substring(e.length),!0):!1}capture(e){if(!this.consumeOptional(e))throw new _t(4011,!1)}};function b1(s){return s.segments.length>0?new Ai([],{[Ut]:s}):s}function S1(s){let e={};for(let[i,r]of Object.entries(s.children)){let n=S1(r);if(i===Ut&&n.segments.length===0&&n.hasChildren())for(let[o,a]of Object.entries(n.children))e[o]=a;else(n.segments.length>0||n.hasChildren())&&(e[i]=n)}let t=new Ai(s.segments,e);return kW(t)}function kW(s){if(s.numberOfChildren===1&&s.children[Ut]){let e=s.children[Ut];return new Ai(s.segments.concat(e.segments),e.children)}return s}function Ip(s){return s instanceof Ol}function GW(s,e,t=null,i=null){let r=y1(s);return E1(r,e,t,i)}function y1(s){let e;function t(n){let o={};for(let l of n.children){let c=t(l);o[l.outlet]=c}let a=new Ai(n.url,o);return n===s&&(e=a),a}let i=t(s.root),r=b1(i);return e??r}function E1(s,e,t,i){let r=s;for(;r.parent;)r=r.parent;if(e.length===0)return sA(r,r,r,t,i);let n=zW(e);if(n.toRoot())return sA(r,r,new Ai([],{}),t,i);let o=WW(n,r,s),a=o.processChildren?Sp(o.segmentGroup,o.index,n.commands):I1(o.segmentGroup,o.index,n.commands);return sA(r,o.segmentGroup,a,t,i)}function ix(s){return typeof s=="object"&&s!=null&&!s.outlets&&!s.segmentPath}function Rp(s){return typeof s=="object"&&s!=null&&s.outlets}function sA(s,e,t,i,r){let n={};i&&Object.entries(i).forEach(([l,c])=>{n[l]=Array.isArray(c)?c.map(h=>`${h}`):`${c}`});let o;s===e?o=t:o=A1(s,e,t);let a=b1(S1(o));return new Ol(a,n,r)}function A1(s,e,t){let i={};return Object.entries(s.children).forEach(([r,n])=>{n===e?i[r]=t:i[r]=A1(n,e,t)}),new Ai(s.segments,i)}var rx=class{constructor(e,t,i){if(this.isAbsolute=e,this.numberOfDoubleDots=t,this.commands=i,e&&i.length>0&&ix(i[0]))throw new _t(4003,!1);let r=i.find(Rp);if(r&&r!==m1(i))throw new _t(4004,!1)}toRoot(){return this.isAbsolute&&this.commands.length===1&&this.commands[0]=="/"}};function zW(s){if(typeof s[0]=="string"&&s.length===1&&s[0]==="/")return new rx(!0,0,s);let e=0,t=!1,i=s.reduce((r,n,o)=>{if(typeof n=="object"&&n!=null){if(n.outlets){let a={};return Object.entries(n.outlets).forEach(([l,c])=>{a[l]=typeof c=="string"?c.split("/"):c}),[...r,{outlets:a}]}if(n.segmentPath)return[...r,n.segmentPath]}return typeof n!="string"?[...r,n]:o===0?(n.split("/").forEach((a,l)=>{l==0&&a==="."||(l==0&&a===""?t=!0:a===".."?e++:a!=""&&r.push(a))}),r):[...r,n]},[]);return new rx(t,e,i)}var Ku=class{constructor(e,t,i){this.segmentGroup=e,this.processChildren=t,this.index=i}};function WW(s,e,t){if(s.isAbsolute)return new Ku(e,!0,0);if(!t)return new Ku(e,!1,NaN);if(t.parent===null)return new Ku(t,!0,0);let i=ix(s.commands[0])?0:1,r=t.segments.length-1+i;return HW(t,r,s.numberOfDoubleDots)}function HW(s,e,t){let i=s,r=e,n=t;for(;n>r;){if(n-=r,i=i.parent,!i)throw new _t(4005,!1);r=i.segments.length}return new Ku(i,!1,r-n)}function XW(s){return Rp(s[0])?s[0].outlets:{[Ut]:s}}function I1(s,e,t){if(s??=new Ai([],{}),s.segments.length===0&&s.hasChildren())return Sp(s,e,t);let i=YW(s,e,t),r=t.slice(i.commandIndex);if(i.match&&i.pathIndex<s.segments.length){let n=new Ai(s.segments.slice(0,i.pathIndex),{});return n.children[Ut]=new Ai(s.segments.slice(i.pathIndex),s.children),Sp(n,0,r)}else return i.match&&r.length===0?new Ai(s.segments,{}):i.match&&!s.hasChildren()?uA(s,e,t):i.match?Sp(s,0,r):uA(s,e,t)}function Sp(s,e,t){if(t.length===0)return new Ai(s.segments,{});{let i=XW(t),r={};if(Object.keys(i).some(n=>n!==Ut)&&s.children[Ut]&&s.numberOfChildren===1&&s.children[Ut].segments.length===0){let n=Sp(s.children[Ut],e,t);return new Ai(s.segments,n.children)}return Object.entries(i).forEach(([n,o])=>{typeof o=="string"&&(o=[o]),o!==null&&(r[n]=I1(s.children[n],e,o))}),Object.entries(s.children).forEach(([n,o])=>{i[n]===void 0&&(r[n]=o)}),new Ai(s.segments,r)}}function YW(s,e,t){let i=0,r=e,n={match:!1,pathIndex:0,commandIndex:0};for(;r<s.segments.length;){if(i>=t.length)return n;let o=s.segments[r],a=t[i];if(Rp(a))break;let l=`${a}`,c=i<t.length-1?t[i+1]:null;if(r>0&&l===void 0)break;if(l&&c&&typeof c=="object"&&c.outlets===void 0){if(!h1(l,c,o))return n;i+=2}else{if(!h1(l,{},o))return n;i++}r++}return{match:!0,pathIndex:r,commandIndex:i}}function uA(s,e,t){let i=s.segments.slice(0,e),r=0;for(;r<t.length;){let n=t[r];if(Rp(n)){let l=$W(n.outlets);return new Ai(i,l)}if(r===0&&ix(t[0])){let l=s.segments[e];i.push(new Uc(l.path,c1(t[0]))),r++;continue}let o=Rp(n)?n.outlets[Ut]:`${n}`,a=r<t.length-1?t[r+1]:null;o&&a&&ix(a)?(i.push(new Uc(o,c1(a))),r+=2):(i.push(new Uc(o,{})),r++)}return new Ai(i,{})}function $W(s){let e={};return Object.entries(s).forEach(([t,i])=>{typeof i=="string"&&(i=[i]),i!==null&&(e[t]=uA(new Ai([],{}),0,i))}),e}function c1(s){let e={};return Object.entries(s).forEach(([t,i])=>e[t]=`${i}`),e}function h1(s,e,t){return s==t.path&&Zo(e,t.parameters)}var yp="imperative",rs=function(s){return s[s.NavigationStart=0]="NavigationStart",s[s.NavigationEnd=1]="NavigationEnd",s[s.NavigationCancel=2]="NavigationCancel",s[s.NavigationError=3]="NavigationError",s[s.RoutesRecognized=4]="RoutesRecognized",s[s.ResolveStart=5]="ResolveStart",s[s.ResolveEnd=6]="ResolveEnd",s[s.GuardsCheckStart=7]="GuardsCheckStart",s[s.GuardsCheckEnd=8]="GuardsCheckEnd",s[s.RouteConfigLoadStart=9]="RouteConfigLoadStart",s[s.RouteConfigLoadEnd=10]="RouteConfigLoadEnd",s[s.ChildActivationStart=11]="ChildActivationStart",s[s.ChildActivationEnd=12]="ChildActivationEnd",s[s.ActivationStart=13]="ActivationStart",s[s.ActivationEnd=14]="ActivationEnd",s[s.Scroll=15]="Scroll",s[s.NavigationSkipped=16]="NavigationSkipped",s}(rs||{}),zn=class{constructor(e,t){this.id=e,this.url=t}},Pp=class extends zn{constructor(e,t,i="imperative",r=null){super(e,t),this.type=rs.NavigationStart,this.navigationTrigger=i,this.restoredState=r}toString(){return`NavigationStart(id: ${this.id}, url: '${this.url}')`}},Gc=class extends zn{constructor(e,t,i){super(e,t),this.urlAfterRedirects=i,this.type=rs.NavigationEnd}toString(){return`NavigationEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}')`}},dn=function(s){return s[s.Redirect=0]="Redirect",s[s.SupersededByNewNavigation=1]="SupersededByNewNavigation",s[s.NoDataFromResolver=2]="NoDataFromResolver",s[s.GuardRejected=3]="GuardRejected",s}(dn||{}),dA=function(s){return s[s.IgnoredSameUrlNavigation=0]="IgnoredSameUrlNavigation",s[s.IgnoredByUrlHandlingStrategy=1]="IgnoredByUrlHandlingStrategy",s}(dA||{}),Ya=class extends zn{constructor(e,t,i,r){super(e,t),this.reason=i,this.code=r,this.type=rs.NavigationCancel}toString(){return`NavigationCancel(id: ${this.id}, url: '${this.url}')`}},zc=class extends zn{constructor(e,t,i,r){super(e,t),this.reason=i,this.code=r,this.type=rs.NavigationSkipped}},Mp=class extends zn{constructor(e,t,i,r){super(e,t),this.error=i,this.target=r,this.type=rs.NavigationError}toString(){return`NavigationError(id: ${this.id}, url: '${this.url}', error: ${this.error})`}},sx=class extends zn{constructor(e,t,i,r){super(e,t),this.urlAfterRedirects=i,this.state=r,this.type=rs.RoutesRecognized}toString(){return`RoutesRecognized(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},fA=class extends zn{constructor(e,t,i,r){super(e,t),this.urlAfterRedirects=i,this.state=r,this.type=rs.GuardsCheckStart}toString(){return`GuardsCheckStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},pA=class extends zn{constructor(e,t,i,r,n){super(e,t),this.urlAfterRedirects=i,this.state=r,this.shouldActivate=n,this.type=rs.GuardsCheckEnd}toString(){return`GuardsCheckEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state}, shouldActivate: ${this.shouldActivate})`}},mA=class extends zn{constructor(e,t,i,r){super(e,t),this.urlAfterRedirects=i,this.state=r,this.type=rs.ResolveStart}toString(){return`ResolveStart(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},gA=class extends zn{constructor(e,t,i,r){super(e,t),this.urlAfterRedirects=i,this.state=r,this.type=rs.ResolveEnd}toString(){return`ResolveEnd(id: ${this.id}, url: '${this.url}', urlAfterRedirects: '${this.urlAfterRedirects}', state: ${this.state})`}},_A=class{constructor(e){this.route=e,this.type=rs.RouteConfigLoadStart}toString(){return`RouteConfigLoadStart(path: ${this.route.path})`}},xA=class{constructor(e){this.route=e,this.type=rs.RouteConfigLoadEnd}toString(){return`RouteConfigLoadEnd(path: ${this.route.path})`}},vA=class{constructor(e){this.snapshot=e,this.type=rs.ChildActivationStart}toString(){return`ChildActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},TA=class{constructor(e){this.snapshot=e,this.type=rs.ChildActivationEnd}toString(){return`ChildActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},CA=class{constructor(e){this.snapshot=e,this.type=rs.ActivationStart}toString(){return`ActivationStart(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}},bA=class{constructor(e){this.snapshot=e,this.type=rs.ActivationEnd}toString(){return`ActivationEnd(path: '${this.snapshot.routeConfig&&this.snapshot.routeConfig.path||""}')`}};var Dp=class{},td=class{constructor(e,t){this.url=e,this.navigationBehaviorOptions=t}};var SA=class{constructor(e){this.injector=e,this.outlet=null,this.route=null,this.children=new ux(this.injector),this.attachRef=null}},ux=(()=>{let e=class e{constructor(i){this.parentInjector=i,this.contexts=new Map}onChildOutletCreated(i,r){let n=this.getOrCreateContext(i);n.outlet=r,this.contexts.set(i,n)}onChildOutletDestroyed(i){let r=this.getContext(i);r&&(r.outlet=null,r.attachRef=null)}onOutletDeactivated(){let i=this.contexts;return this.contexts=new Map,i}onOutletReAttached(i){this.contexts=i}getOrCreateContext(i){let r=this.getContext(i);return r||(r=new SA(this.parentInjector),this.contexts.set(i,r)),r}getContext(i){return this.contexts.get(i)||null}};e.\u0275fac=function(r){return new(r||e)(ni(Vn))},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})(),nx=class{constructor(e){this._root=e}get root(){return this._root.value}parent(e){let t=this.pathFromRoot(e);return t.length>1?t[t.length-2]:null}children(e){let t=yA(e,this._root);return t?t.children.map(i=>i.value):[]}firstChild(e){let t=yA(e,this._root);return t&&t.children.length>0?t.children[0].value:null}siblings(e){let t=EA(e,this._root);return t.length<2?[]:t[t.length-2].children.map(r=>r.value).filter(r=>r!==e)}pathFromRoot(e){return EA(e,this._root).map(t=>t.value)}};function yA(s,e){if(s===e.value)return e;for(let t of e.children){let i=yA(s,t);if(i)return i}return null}function EA(s,e){if(s===e.value)return[e];for(let t of e.children){let i=EA(s,t);if(i.length)return i.unshift(e),i}return[]}var un=class{constructor(e,t){this.value=e,this.children=t}toString(){return`TreeNode(${this.value})`}};function Qu(s){let e={};return s&&s.children.forEach(t=>e[t.value.outlet]=t),e}var ox=class extends nx{constructor(e,t){super(e),this.snapshot=t,FA(this,e)}toString(){return this.snapshot.toString()}};function R1(s){let e=jW(s),t=new is([new Uc("",{})]),i=new is({}),r=new is({}),n=new is({}),o=new is(""),a=new id(t,i,n,o,r,Ut,s,e.root);return a.snapshot=e.root,new ox(new un(a,[]),e)}function jW(s){let e={},t={},i={},r="",n=new Zu([],e,i,r,t,Ut,s,null,{});return new lx("",new un(n,[]))}var id=class{constructor(e,t,i,r,n,o,a,l){this.urlSubject=e,this.paramsSubject=t,this.queryParamsSubject=i,this.fragmentSubject=r,this.dataSubject=n,this.outlet=o,this.component=a,this._futureSnapshot=l,this.title=this.dataSubject?.pipe(ti(c=>c[Lp]))??Rt(void 0),this.url=e,this.params=t,this.queryParams=i,this.fragment=r,this.data=n}get routeConfig(){return this._futureSnapshot.routeConfig}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=this.params.pipe(ti(e=>ed(e))),this._paramMap}get queryParamMap(){return this._queryParamMap??=this.queryParams.pipe(ti(e=>ed(e))),this._queryParamMap}toString(){return this.snapshot?this.snapshot.toString():`Future(${this._futureSnapshot})`}};function ax(s,e,t="emptyOnly"){let i,{routeConfig:r}=s;return e!==null&&(t==="always"||r?.path===""||!e.component&&!e.routeConfig?.loadComponent)?i={params:ie(ie({},e.params),s.params),data:ie(ie({},e.data),s.data),resolve:ie(ie(ie(ie({},s.data),e.data),r?.data),s._resolvedData)}:i={params:ie({},s.params),data:ie({},s.data),resolve:ie(ie({},s.data),s._resolvedData??{})},r&&M1(r)&&(i.resolve[Lp]=r.title),i}var Zu=class{get title(){return this.data?.[Lp]}constructor(e,t,i,r,n,o,a,l,c){this.url=e,this.params=t,this.queryParams=i,this.fragment=r,this.data=n,this.outlet=o,this.component=a,this.routeConfig=l,this._resolve=c}get root(){return this._routerState.root}get parent(){return this._routerState.parent(this)}get firstChild(){return this._routerState.firstChild(this)}get children(){return this._routerState.children(this)}get pathFromRoot(){return this._routerState.pathFromRoot(this)}get paramMap(){return this._paramMap??=ed(this.params),this._paramMap}get queryParamMap(){return this._queryParamMap??=ed(this.queryParams),this._queryParamMap}toString(){let e=this.url.map(i=>i.toString()).join("/"),t=this.routeConfig?this.routeConfig.path:"";return`Route(url:'${e}', path:'${t}')`}},lx=class extends nx{constructor(e,t){super(t),this.url=e,FA(this,t)}toString(){return P1(this._root)}};function FA(s,e){e.value._routerState=s,e.children.forEach(t=>FA(s,t))}function P1(s){let e=s.children.length>0?` { ${s.children.map(P1).join(", ")} } `:"";return`${s.value}${e}`}function nA(s){if(s.snapshot){let e=s.snapshot,t=s._futureSnapshot;s.snapshot=t,Zo(e.queryParams,t.queryParams)||s.queryParamsSubject.next(t.queryParams),e.fragment!==t.fragment&&s.fragmentSubject.next(t.fragment),Zo(e.params,t.params)||s.paramsSubject.next(t.params),SW(e.url,t.url)||s.urlSubject.next(t.url),Zo(e.data,t.data)||s.dataSubject.next(t.data)}else s.snapshot=s._futureSnapshot,s.dataSubject.next(s._futureSnapshot.data)}function AA(s,e){let t=Zo(s.params,e.params)&&IW(s.url,e.url),i=!s.parent!=!e.parent;return t&&!i&&(!s.parent||AA(s.parent,e.parent))}function M1(s){return typeof s.title=="string"||s.title===null}var qW=(()=>{let e=class e{constructor(){this.activated=null,this._activatedRoute=null,this.name=Ut,this.activateEvents=new ws,this.deactivateEvents=new ws,this.attachEvents=new ws,this.detachEvents=new ws,this.parentContexts=Ue(ux),this.location=Ue(G_),this.changeDetector=Ue(fp),this.inputBinder=Ue(LA,{optional:!0}),this.supportsBindingToComponentInputs=!0}get activatedComponentRef(){return this.activated}ngOnChanges(i){if(i.name){let{firstChange:r,previousValue:n}=i.name;if(r)return;this.isTrackedInParentContexts(n)&&(this.deactivate(),this.parentContexts.onChildOutletDestroyed(n)),this.initializeOutletWithName()}}ngOnDestroy(){this.isTrackedInParentContexts(this.name)&&this.parentContexts.onChildOutletDestroyed(this.name),this.inputBinder?.unsubscribeFromRouteData(this)}isTrackedInParentContexts(i){return this.parentContexts.getContext(i)?.outlet===this}ngOnInit(){this.initializeOutletWithName()}initializeOutletWithName(){if(this.parentContexts.onChildOutletCreated(this.name,this),this.activated)return;let i=this.parentContexts.getContext(this.name);i?.route&&(i.attachRef?this.attach(i.attachRef,i.route):this.activateWith(i.route,i.injector))}get isActivated(){return!!this.activated}get component(){if(!this.activated)throw new _t(4012,!1);return this.activated.instance}get activatedRoute(){if(!this.activated)throw new _t(4012,!1);return this._activatedRoute}get activatedRouteData(){return this._activatedRoute?this._activatedRoute.snapshot.data:{}}detach(){if(!this.activated)throw new _t(4012,!1);this.location.detach();let i=this.activated;return this.activated=null,this._activatedRoute=null,this.detachEvents.emit(i.instance),i}attach(i,r){this.activated=i,this._activatedRoute=r,this.location.insert(i.hostView),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.attachEvents.emit(i.instance)}deactivate(){if(this.activated){let i=this.component;this.activated.destroy(),this.activated=null,this._activatedRoute=null,this.deactivateEvents.emit(i)}}activateWith(i,r){if(this.isActivated)throw new _t(4013,!1);this._activatedRoute=i;let n=this.location,a=i.snapshot.component,l=this.parentContexts.getOrCreateContext(this.name).children,c=new IA(i,l,n.injector);this.activated=n.createComponent(a,{index:n.length,injector:c,environmentInjector:r}),this.changeDetector.markForCheck(),this.inputBinder?.bindActivatedRouteToOutletComponent(this),this.activateEvents.emit(this.activated.instance)}};e.\u0275fac=function(r){return new(r||e)},e.\u0275dir=mE({type:e,selectors:[["router-outlet"]],inputs:{name:"name"},outputs:{activateEvents:"activate",deactivateEvents:"deactivate",attachEvents:"attach",detachEvents:"detach"},exportAs:["outlet"],standalone:!0,features:[D_]});let s=e;return s})(),IA=class s{__ngOutletInjector(e){return new s(this.route,this.childContexts,e)}constructor(e,t,i){this.route=e,this.childContexts=t,this.parent=i}get(e,t){return e===id?this.route:e===ux?this.childContexts:this.parent.get(e,t)}},LA=new Pt("");function QW(s,e,t){let i=Op(s,e._root,t?t._root:void 0);return new ox(i,e)}function Op(s,e,t){if(t&&s.shouldReuseRoute(e.value,t.value.snapshot)){let i=t.value;i._futureSnapshot=e.value;let r=KW(s,e,t);return new un(i,r)}else{if(s.shouldAttach(e.value)){let n=s.retrieve(e.value);if(n!==null){let o=n.route;return o.value._futureSnapshot=e.value,o.children=e.children.map(a=>Op(s,a)),o}}let i=ZW(e.value),r=e.children.map(n=>Op(s,n));return new un(i,r)}}function KW(s,e,t){return e.children.map(i=>{for(let r of t.children)if(s.shouldReuseRoute(i.value,r.value.snapshot))return Op(s,i,r);return Op(s,i)})}function ZW(s){return new id(new is(s.url),new is(s.params),new is(s.queryParams),new is(s.fragment),new is(s.data),s.outlet,s.component,s)}var wp=class{constructor(e,t){this.redirectTo=e,this.navigationBehaviorOptions=t}},D1="ngNavigationCancelingError";function cx(s,e){let{redirectTo:t,navigationBehaviorOptions:i}=Ip(e)?{redirectTo:e,navigationBehaviorOptions:void 0}:e,r=O1(!1,dn.Redirect);return r.url=t,r.navigationBehaviorOptions=i,r}function O1(s,e){let t=new Error(`NavigationCancelingError: ${s||""}`);return t[D1]=!0,t.cancellationCode=e,t}function JW(s){return w1(s)&&Ip(s.url)}function w1(s){return!!s&&s[D1]}var e4=(()=>{let e=class e{};e.\u0275fac=function(r){return new(r||e)},e.\u0275cmp=Wu({type:e,selectors:[["ng-component"]],standalone:!0,features:[Yu],decls:1,vars:0,template:function(r,n){r&1&&Bc(0,"router-outlet")},dependencies:[qW],encapsulation:2});let s=e;return s})();function t4(s,e){return s.providers&&!s._injector&&(s._injector=kE(s.providers,e,`Route: ${s.path}`)),s._injector??e}function BA(s){let e=s.children&&s.children.map(BA),t=e?Kt(ie({},s),{children:e}):ie({},s);return!t.component&&!t.loadComponent&&(e||t.loadChildren)&&t.outlet&&t.outlet!==Ut&&(t.component=e4),t}function _o(s){return s.outlet||Ut}function i4(s,e){let t=s.filter(i=>_o(i)===e);return t.push(...s.filter(i=>_o(i)!==e)),t}function Bp(s){if(!s)return null;if(s.routeConfig?._injector)return s.routeConfig._injector;for(let e=s.parent;e;e=e.parent){let t=e.routeConfig;if(t?._loadedInjector)return t._loadedInjector;if(t?._injector)return t._injector}return null}var r4=(s,e,t,i)=>ti(r=>(new RA(e,r.targetRouterState,r.currentRouterState,t,i).activate(s),r)),RA=class{constructor(e,t,i,r,n){this.routeReuseStrategy=e,this.futureState=t,this.currState=i,this.forwardEvent=r,this.inputBindingEnabled=n}activate(e){let t=this.futureState._root,i=this.currState?this.currState._root:null;this.deactivateChildRoutes(t,i,e),nA(this.futureState.root),this.activateChildRoutes(t,i,e)}deactivateChildRoutes(e,t,i){let r=Qu(t);e.children.forEach(n=>{let o=n.value.outlet;this.deactivateRoutes(n,r[o],i),delete r[o]}),Object.values(r).forEach(n=>{this.deactivateRouteAndItsChildren(n,i)})}deactivateRoutes(e,t,i){let r=e.value,n=t?t.value:null;if(r===n)if(r.component){let o=i.getContext(r.outlet);o&&this.deactivateChildRoutes(e,t,o.children)}else this.deactivateChildRoutes(e,t,i);else n&&this.deactivateRouteAndItsChildren(t,i)}deactivateRouteAndItsChildren(e,t){e.value.component&&this.routeReuseStrategy.shouldDetach(e.value.snapshot)?this.detachAndStoreRouteSubtree(e,t):this.deactivateRouteAndOutlet(e,t)}detachAndStoreRouteSubtree(e,t){let i=t.getContext(e.value.outlet),r=i&&e.value.component?i.children:t,n=Qu(e);for(let o of Object.values(n))this.deactivateRouteAndItsChildren(o,r);if(i&&i.outlet){let o=i.outlet.detach(),a=i.children.onOutletDeactivated();this.routeReuseStrategy.store(e.value.snapshot,{componentRef:o,route:e,contexts:a})}}deactivateRouteAndOutlet(e,t){let i=t.getContext(e.value.outlet),r=i&&e.value.component?i.children:t,n=Qu(e);for(let o of Object.values(n))this.deactivateRouteAndItsChildren(o,r);i&&(i.outlet&&(i.outlet.deactivate(),i.children.onOutletDeactivated()),i.attachRef=null,i.route=null)}activateChildRoutes(e,t,i){let r=Qu(t);e.children.forEach(n=>{this.activateRoutes(n,r[n.value.outlet],i),this.forwardEvent(new bA(n.value.snapshot))}),e.children.length&&this.forwardEvent(new TA(e.value.snapshot))}activateRoutes(e,t,i){let r=e.value,n=t?t.value:null;if(nA(r),r===n)if(r.component){let o=i.getOrCreateContext(r.outlet);this.activateChildRoutes(e,t,o.children)}else this.activateChildRoutes(e,t,i);else if(r.component){let o=i.getOrCreateContext(r.outlet);if(this.routeReuseStrategy.shouldAttach(r.snapshot)){let a=this.routeReuseStrategy.retrieve(r.snapshot);this.routeReuseStrategy.store(r.snapshot,null),o.children.onOutletReAttached(a.contexts),o.attachRef=a.componentRef,o.route=a.route.value,o.outlet&&o.outlet.attach(a.componentRef,a.route.value),nA(a.route.value),this.activateChildRoutes(e,null,o.children)}else{let a=Bp(r.snapshot);o.attachRef=null,o.route=r,o.injector=a??o.injector,o.outlet&&o.outlet.activateWith(r,o.injector),this.activateChildRoutes(e,null,o.children)}}else this.activateChildRoutes(e,null,i)}},hx=class{constructor(e){this.path=e,this.route=this.path[this.path.length-1]}},Ju=class{constructor(e,t){this.component=e,this.route=t}};function s4(s,e,t){let i=s._root,r=e?e._root:null;return Cp(i,r,t,[i.value])}function n4(s){let e=s.routeConfig?s.routeConfig.canActivateChild:null;return!e||e.length===0?null:{node:s,guards:e}}function sd(s,e){let t=Symbol(),i=e.get(s,t);return i===t?typeof s=="function"&&!lN(s)?s:e.get(s):i}function Cp(s,e,t,i,r={canDeactivateChecks:[],canActivateChecks:[]}){let n=Qu(e);return s.children.forEach(o=>{o4(o,n[o.value.outlet],t,i.concat([o.value]),r),delete n[o.value.outlet]}),Object.entries(n).forEach(([o,a])=>Ep(a,t.getContext(o),r)),r}function o4(s,e,t,i,r={canDeactivateChecks:[],canActivateChecks:[]}){let n=s.value,o=e?e.value:null,a=t?t.getContext(s.value.outlet):null;if(o&&n.routeConfig===o.routeConfig){let l=a4(o,n,n.routeConfig.runGuardsAndResolvers);l?r.canActivateChecks.push(new hx(i)):(n.data=o.data,n._resolvedData=o._resolvedData),n.component?Cp(s,e,a?a.children:null,i,r):Cp(s,e,t,i,r),l&&a&&a.outlet&&a.outlet.isActivated&&r.canDeactivateChecks.push(new Ju(a.outlet.component,o))}else o&&Ep(e,a,r),r.canActivateChecks.push(new hx(i)),n.component?Cp(s,null,a?a.children:null,i,r):Cp(s,null,t,i,r);return r}function a4(s,e,t){if(typeof t=="function")return t(s,e);switch(t){case"pathParamsChange":return!kc(s.url,e.url);case"pathParamsOrQueryParamsChange":return!kc(s.url,e.url)||!Zo(s.queryParams,e.queryParams);case"always":return!0;case"paramsOrQueryParamsChange":return!AA(s,e)||!Zo(s.queryParams,e.queryParams);case"paramsChange":default:return!AA(s,e)}}function Ep(s,e,t){let i=Qu(s),r=s.value;Object.entries(i).forEach(([n,o])=>{r.component?e?Ep(o,e.children.getContext(n),t):Ep(o,null,t):Ep(o,e,t)}),r.component?e&&e.outlet&&e.outlet.isActivated?t.canDeactivateChecks.push(new Ju(e.outlet.component,r)):t.canDeactivateChecks.push(new Ju(null,r)):t.canDeactivateChecks.push(new Ju(null,r))}function Vp(s){return typeof s=="function"}function l4(s){return typeof s=="boolean"}function c4(s){return s&&Vp(s.canLoad)}function h4(s){return s&&Vp(s.canActivate)}function u4(s){return s&&Vp(s.canActivateChild)}function d4(s){return s&&Vp(s.canDeactivate)}function f4(s){return s&&Vp(s.canMatch)}function N1(s){return s instanceof La||s?.name==="EmptyError"}var Z_=Symbol("INITIAL_VALUE");function rd(){return Nn(s=>Xg(s.map(e=>e.pipe(Ba(1),vy(Z_)))).pipe(ti(e=>{for(let t of e)if(t!==!0){if(t===Z_)return Z_;if(t===!1||p4(t))return t}return!0}),wn(e=>e!==Z_),Ba(1)))}function p4(s){return Ip(s)||s instanceof wp}function m4(s,e){return Ur(t=>{let{targetSnapshot:i,currentSnapshot:r,guards:{canActivateChecks:n,canDeactivateChecks:o}}=t;return o.length===0&&n.length===0?Rt(Kt(ie({},t),{guardsResult:!0})):g4(o,i,r,s).pipe(Ur(a=>a&&l4(a)?_4(i,n,s,e):Rt(a)),ti(a=>Kt(ie({},t),{guardsResult:a})))})}function g4(s,e,t,i){return Mr(s).pipe(Ur(r=>b4(r.component,r.route,t,e,i)),uo(r=>r!==!0,!0))}function _4(s,e,t,i){return Mr(e).pipe(Ic(r=>Ru(v4(r.route.parent,i),x4(r.route,i),C4(s,r.path,t),T4(s,r.route,t))),uo(r=>r!==!0,!0))}function x4(s,e){return s!==null&&e&&e(new CA(s)),Rt(!0)}function v4(s,e){return s!==null&&e&&e(new vA(s)),Rt(!0)}function T4(s,e,t){let i=e.routeConfig?e.routeConfig.canActivate:null;if(!i||i.length===0)return Rt(!0);let r=i.map(n=>Yg(()=>{let o=Bp(e)??t,a=sd(n,o),l=h4(a)?a.canActivate(e,s):qo(o,()=>a(e,s));return wl(l).pipe(uo())}));return Rt(r).pipe(rd())}function C4(s,e,t){let i=e[e.length-1],n=e.slice(0,e.length-1).reverse().map(o=>n4(o)).filter(o=>o!==null).map(o=>Yg(()=>{let a=o.guards.map(l=>{let c=Bp(o.node)??t,h=sd(l,c),u=u4(h)?h.canActivateChild(i,s):qo(c,()=>h(i,s));return wl(u).pipe(uo())});return Rt(a).pipe(rd())}));return Rt(n).pipe(rd())}function b4(s,e,t,i,r){let n=e&&e.routeConfig?e.routeConfig.canDeactivate:null;if(!n||n.length===0)return Rt(!0);let o=n.map(a=>{let l=Bp(e)??r,c=sd(a,l),h=d4(c)?c.canDeactivate(s,e,t,i):qo(l,()=>c(s,e,t,i));return wl(h).pipe(uo())});return Rt(o).pipe(rd())}function S4(s,e,t,i){let r=e.canLoad;if(r===void 0||r.length===0)return Rt(!0);let n=r.map(o=>{let a=sd(o,s),l=c4(a)?a.canLoad(e,t):qo(s,()=>a(e,t));return wl(l)});return Rt(n).pipe(rd(),F1(i))}function F1(s){return hy(kr(e=>{if(typeof e!="boolean")throw cx(s,e)}),ti(e=>e===!0))}function y4(s,e,t,i){let r=e.canMatch;if(!r||r.length===0)return Rt(!0);let n=r.map(o=>{let a=sd(o,s),l=f4(a)?a.canMatch(e,t):qo(s,()=>a(e,t));return wl(l)});return Rt(n).pipe(rd(),F1(i))}var Np=class{constructor(e){this.segmentGroup=e||null}},Fp=class extends Error{constructor(e){super(),this.urlTree=e}};function qu(s){return Iu(new Np(s))}function E4(s){return Iu(new _t(4e3,!1))}function A4(s){return Iu(O1(!1,dn.GuardRejected))}var PA=class{constructor(e,t){this.urlSerializer=e,this.urlTree=t}lineralizeSegments(e,t){let i=[],r=t.root;for(;;){if(i=i.concat(r.segments),r.numberOfChildren===0)return Rt(i);if(r.numberOfChildren>1||!r.children[Ut])return E4(`${e.redirectTo}`);r=r.children[Ut]}}applyRedirectCommands(e,t,i,r,n){if(typeof t!="string"){let a=t,{queryParams:l,fragment:c,routeConfig:h,url:u,outlet:d,params:f,data:m,title:g}=r,_=qo(n,()=>a({params:f,data:m,queryParams:l,fragment:c,routeConfig:h,url:u,outlet:d,title:g}));if(_ instanceof Ol)throw new Fp(_);t=_}let o=this.applyRedirectCreateUrlTree(t,this.urlSerializer.parse(t),e,i);if(t[0]==="/")throw new Fp(o);return o}applyRedirectCreateUrlTree(e,t,i,r){let n=this.createSegmentGroup(e,t.root,i,r);return new Ol(n,this.createQueryParams(t.queryParams,this.urlTree.queryParams),t.fragment)}createQueryParams(e,t){let i={};return Object.entries(e).forEach(([r,n])=>{if(typeof n=="string"&&n[0]===":"){let a=n.substring(1);i[r]=t[a]}else i[r]=n}),i}createSegmentGroup(e,t,i,r){let n=this.createSegments(e,t.segments,i,r),o={};return Object.entries(t.children).forEach(([a,l])=>{o[a]=this.createSegmentGroup(e,l,i,r)}),new Ai(n,o)}createSegments(e,t,i,r){return t.map(n=>n.path[0]===":"?this.findPosParam(e,n,r):this.findOrReturn(n,i))}findPosParam(e,t,i){let r=i[t.path.substring(1)];if(!r)throw new _t(4001,!1);return r}findOrReturn(e,t){let i=0;for(let r of t){if(r.path===e.path)return t.splice(i),r;i++}return e}},MA={matched:!1,consumedSegments:[],remainingSegments:[],parameters:{},positionalParamSegments:{}};function I4(s,e,t,i,r){let n=VA(s,e,t);return n.matched?(i=t4(e,i),y4(i,e,t,r).pipe(ti(o=>o===!0?n:ie({},MA)))):Rt(n)}function VA(s,e,t){if(e.path==="**")return R4(t);if(e.path==="")return e.pathMatch==="full"&&(s.hasChildren()||t.length>0)?ie({},MA):{matched:!0,consumedSegments:[],remainingSegments:t,parameters:{},positionalParamSegments:{}};let r=(e.matcher||bW)(t,s,e);if(!r)return ie({},MA);let n={};Object.entries(r.posParams??{}).forEach(([a,l])=>{n[a]=l.path});let o=r.consumed.length>0?ie(ie({},n),r.consumed[r.consumed.length-1].parameters):n;return{matched:!0,consumedSegments:r.consumed,remainingSegments:t.slice(r.consumed.length),parameters:o,positionalParamSegments:r.posParams??{}}}function R4(s){return{matched:!0,parameters:s.length>0?m1(s).parameters:{},consumedSegments:s,remainingSegments:[],positionalParamSegments:{}}}function u1(s,e,t,i){return t.length>0&&D4(s,t,i)?{segmentGroup:new Ai(e,M4(i,new Ai(t,s.children))),slicedSegments:[]}:t.length===0&&O4(s,t,i)?{segmentGroup:new Ai(s.segments,P4(s,t,i,s.children)),slicedSegments:t}:{segmentGroup:new Ai(s.segments,s.children),slicedSegments:t}}function P4(s,e,t,i){let r={};for(let n of t)if(dx(s,e,n)&&!i[_o(n)]){let o=new Ai([],{});r[_o(n)]=o}return ie(ie({},i),r)}function M4(s,e){let t={};t[Ut]=e;for(let i of s)if(i.path===""&&_o(i)!==Ut){let r=new Ai([],{});t[_o(i)]=r}return t}function D4(s,e,t){return t.some(i=>dx(s,e,i)&&_o(i)!==Ut)}function O4(s,e,t){return t.some(i=>dx(s,e,i))}function dx(s,e,t){return(s.hasChildren()||e.length>0)&&t.pathMatch==="full"?!1:t.path===""}function w4(s,e,t,i){return _o(s)!==i&&(i===Ut||!dx(e,t,s))?!1:VA(e,s,t).matched}function N4(s,e,t){return e.length===0&&!s.children[t]}var DA=class{};function F4(s,e,t,i,r,n,o="emptyOnly"){return new OA(s,e,t,i,r,o,n).recognize()}var L4=31,OA=class{constructor(e,t,i,r,n,o,a){this.injector=e,this.configLoader=t,this.rootComponentType=i,this.config=r,this.urlTree=n,this.paramsInheritanceStrategy=o,this.urlSerializer=a,this.applyRedirects=new PA(this.urlSerializer,this.urlTree),this.absoluteRedirectCount=0,this.allowRedirects=!0}noMatchError(e){return new _t(4002,`'${e.segmentGroup}'`)}recognize(){let e=u1(this.urlTree.root,[],[],this.config).segmentGroup;return this.match(e).pipe(ti(({children:t,rootSnapshot:i})=>{let r=new un(i,t),n=new lx("",r),o=GW(i,[],this.urlTree.queryParams,this.urlTree.fragment);return o.queryParams=this.urlTree.queryParams,n.url=this.urlSerializer.serialize(o),{state:n,tree:o}}))}match(e){let t=new Zu([],Object.freeze({}),Object.freeze(ie({},this.urlTree.queryParams)),this.urlTree.fragment,Object.freeze({}),Ut,this.rootComponentType,null,{});return this.processSegmentGroup(this.injector,this.config,e,Ut,t).pipe(ti(i=>({children:i,rootSnapshot:t})),yl(i=>{if(i instanceof Fp)return this.urlTree=i.urlTree,this.match(i.urlTree.root);throw i instanceof Np?this.noMatchError(i):i}))}processSegmentGroup(e,t,i,r,n){return i.segments.length===0&&i.hasChildren()?this.processChildren(e,t,i,n):this.processSegment(e,t,i,i.segments,r,!0,n).pipe(ti(o=>o instanceof un?[o]:[]))}processChildren(e,t,i,r){let n=[];for(let o of Object.keys(i.children))o==="primary"?n.unshift(o):n.push(o);return Mr(n).pipe(Ic(o=>{let a=i.children[o],l=i4(t,o);return this.processSegmentGroup(e,l,a,o,r)}),xy((o,a)=>(o.push(...a),o)),El(null),_y(),Ur(o=>{if(o===null)return qu(i);let a=L1(o);return B4(a),Rt(a)}))}processSegment(e,t,i,r,n,o,a){return Mr(t).pipe(Ic(l=>this.processSegmentAgainstRoute(l._injector??e,t,l,i,r,n,o,a).pipe(yl(c=>{if(c instanceof Np)return Rt(null);throw c}))),uo(l=>!!l),yl(l=>{if(N1(l))return N4(i,r,n)?Rt(new DA):qu(i);throw l}))}processSegmentAgainstRoute(e,t,i,r,n,o,a,l){return w4(i,r,n,o)?i.redirectTo===void 0?this.matchSegmentAgainstRoute(e,r,i,n,o,l):this.allowRedirects&&a?this.expandSegmentAgainstRouteUsingRedirect(e,r,t,i,n,o,l):qu(r):qu(r)}expandSegmentAgainstRouteUsingRedirect(e,t,i,r,n,o,a){let{matched:l,parameters:c,consumedSegments:h,positionalParamSegments:u,remainingSegments:d}=VA(t,r,n);if(!l)return qu(t);typeof r.redirectTo=="string"&&r.redirectTo[0]==="/"&&(this.absoluteRedirectCount++,this.absoluteRedirectCount>L4&&(this.allowRedirects=!1));let f=new Zu(n,c,Object.freeze(ie({},this.urlTree.queryParams)),this.urlTree.fragment,d1(r),_o(r),r.component??r._loadedComponent??null,r,f1(r)),m=ax(f,a,this.paramsInheritanceStrategy);f.params=Object.freeze(m.params),f.data=Object.freeze(m.data);let g=this.applyRedirects.applyRedirectCommands(h,r.redirectTo,u,f,e);return this.applyRedirects.lineralizeSegments(r,g).pipe(Ur(_=>this.processSegment(e,i,t,_.concat(d),o,!1,a)))}matchSegmentAgainstRoute(e,t,i,r,n,o){let a=I4(t,i,r,e,this.urlSerializer);return i.path==="**"&&(t.children={}),a.pipe(Nn(l=>l.matched?(e=i._injector??e,this.getChildConfig(e,i,r).pipe(Nn(({routes:c})=>{let h=i._loadedInjector??e,{parameters:u,consumedSegments:d,remainingSegments:f}=l,m=new Zu(d,u,Object.freeze(ie({},this.urlTree.queryParams)),this.urlTree.fragment,d1(i),_o(i),i.component??i._loadedComponent??null,i,f1(i)),g=ax(m,o,this.paramsInheritanceStrategy);m.params=Object.freeze(g.params),m.data=Object.freeze(g.data);let{segmentGroup:_,slicedSegments:x}=u1(t,d,f,c);if(x.length===0&&_.hasChildren())return this.processChildren(h,c,_,m).pipe(ti(C=>new un(m,C)));if(c.length===0&&x.length===0)return Rt(new un(m,[]));let b=_o(i)===n;return this.processSegment(h,c,_,x,b?Ut:n,!0,m).pipe(ti(C=>new un(m,C instanceof un?[C]:[])))}))):qu(t)))}getChildConfig(e,t,i){return t.children?Rt({routes:t.children,injector:e}):t.loadChildren?t._loadedRoutes!==void 0?Rt({routes:t._loadedRoutes,injector:t._loadedInjector}):S4(e,t,i,this.urlSerializer).pipe(Ur(r=>r?this.configLoader.loadChildren(e,t).pipe(kr(n=>{t._loadedRoutes=n.routes,t._loadedInjector=n.injector})):A4(t))):Rt({routes:[],injector:e})}};function B4(s){s.sort((e,t)=>e.value.outlet===Ut?-1:t.value.outlet===Ut?1:e.value.outlet.localeCompare(t.value.outlet))}function V4(s){let e=s.value.routeConfig;return e&&e.path===""}function L1(s){let e=[],t=new Set;for(let i of s){if(!V4(i)){e.push(i);continue}let r=e.find(n=>i.value.routeConfig===n.value.routeConfig);r!==void 0?(r.children.push(...i.children),t.add(r)):e.push(i)}for(let i of t){let r=L1(i.children);e.push(new un(i.value,r))}return e.filter(i=>!t.has(i))}function d1(s){return s.data||{}}function f1(s){return s.resolve||{}}function U4(s,e,t,i,r,n){return Ur(o=>F4(s,e,t,i,o.extractedUrl,r,n).pipe(ti(({state:a,tree:l})=>Kt(ie({},o),{targetSnapshot:a,urlAfterRedirects:l}))))}function k4(s,e){return Ur(t=>{let{targetSnapshot:i,guards:{canActivateChecks:r}}=t;if(!r.length)return Rt(t);let n=new Set(r.map(l=>l.route)),o=new Set;for(let l of n)if(!o.has(l))for(let c of B1(l))o.add(c);let a=0;return Mr(o).pipe(Ic(l=>n.has(l)?G4(l,i,s,e):(l.data=ax(l,l.parent,s).resolve,Rt(void 0))),kr(()=>a++),Mu(1),Ur(l=>a===o.size?Rt(t):on))})}function B1(s){let e=s.children.map(t=>B1(t)).flat();return[s,...e]}function G4(s,e,t,i){let r=s.routeConfig,n=s._resolve;return r?.title!==void 0&&!M1(r)&&(n[Lp]=r.title),z4(n,s,e,i).pipe(ti(o=>(s._resolvedData=o,s.data=ax(s,s.parent,t).resolve,null)))}function z4(s,e,t,i){let r=lA(s);if(r.length===0)return Rt({});let n={};return Mr(r).pipe(Ur(o=>W4(s[o],e,t,i).pipe(uo(),kr(a=>{if(a instanceof wp)throw cx(new Ap,a);n[o]=a}))),Mu(1),gy(n),yl(o=>N1(o)?on:Iu(o)))}function W4(s,e,t,i){let r=Bp(e)??i,n=sd(s,r),o=n.resolve?n.resolve(e,t):qo(r,()=>n(e,t));return wl(o)}function oA(s){return Nn(e=>{let t=s(e);return t?Mr(t).pipe(ti(()=>e)):Rt(e)})}var V1=(()=>{let e=class e{buildTitle(i){let r,n=i.root;for(;n!==void 0;)r=this.getResolvedTitleForRoute(n)??r,n=n.children.find(o=>o.outlet===Ut);return r}getResolvedTitleForRoute(i){return i.data[Lp]}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:()=>Ue(H4),providedIn:"root"});let s=e;return s})(),H4=(()=>{let e=class e extends V1{constructor(i){super(),this.title=i}updateTitle(i){let r=this.buildTitle(i);r!==void 0&&this.title.setTitle(r)}};e.\u0275fac=function(r){return new(r||e)(ni(n1))},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})(),UA=new Pt("",{providedIn:"root",factory:()=>({})}),kA=new Pt(""),X4=(()=>{let e=class e{constructor(){this.componentLoaders=new WeakMap,this.childrenLoaders=new WeakMap,this.compiler=Ue(zE)}loadComponent(i){if(this.componentLoaders.get(i))return this.componentLoaders.get(i);if(i._loadedComponent)return Rt(i._loadedComponent);this.onLoadStartListener&&this.onLoadStartListener(i);let r=wl(i.loadComponent()).pipe(ti(U1),kr(o=>{this.onLoadEndListener&&this.onLoadEndListener(i),i._loadedComponent=o}),Pu(()=>{this.componentLoaders.delete(i)})),n=new Au(r,()=>new Os).pipe(Eu());return this.componentLoaders.set(i,n),n}loadChildren(i,r){if(this.childrenLoaders.get(r))return this.childrenLoaders.get(r);if(r._loadedRoutes)return Rt({routes:r._loadedRoutes,injector:r._loadedInjector});this.onLoadStartListener&&this.onLoadStartListener(r);let o=Y4(r,this.compiler,i,this.onLoadEndListener).pipe(Pu(()=>{this.childrenLoaders.delete(r)})),a=new Au(o,()=>new Os).pipe(Eu());return this.childrenLoaders.set(r,a),a}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})();function Y4(s,e,t,i){return wl(s.loadChildren()).pipe(ti(U1),Ur(r=>r instanceof np||Array.isArray(r)?Rt(r):Mr(e.compileModuleAsync(r))),ti(r=>{i&&i(s);let n,o,a=!1;return Array.isArray(r)?(o=r,a=!0):(n=r.create(t).injector,o=n.get(kA,[],{optional:!0,self:!0}).flat()),{routes:o.map(BA),injector:n}}))}function $4(s){return s&&typeof s=="object"&&"default"in s}function U1(s){return $4(s)?s.default:s}var GA=(()=>{let e=class e{};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:()=>Ue(j4),providedIn:"root"});let s=e;return s})(),j4=(()=>{let e=class e{shouldProcessUrl(i){return!0}extract(i){return i}merge(i,r){return i}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})(),q4=new Pt("");var Q4=new Pt(""),K4=(()=>{let e=class e{get hasRequestedNavigation(){return this.navigationId!==0}constructor(){this.currentNavigation=null,this.currentTransition=null,this.lastSuccessfulNavigation=null,this.events=new Os,this.transitionAbortSubject=new Os,this.configLoader=Ue(X4),this.environmentInjector=Ue(Vn),this.urlSerializer=Ue(NA),this.rootContexts=Ue(ux),this.location=Ue(mp),this.inputBindingEnabled=Ue(LA,{optional:!0})!==null,this.titleStrategy=Ue(V1),this.options=Ue(UA,{optional:!0})||{},this.paramsInheritanceStrategy=this.options.paramsInheritanceStrategy||"emptyOnly",this.urlHandlingStrategy=Ue(GA),this.createViewTransition=Ue(q4,{optional:!0}),this.navigationErrorHandler=Ue(Q4,{optional:!0}),this.navigationId=0,this.afterPreactivation=()=>Rt(void 0),this.rootComponentType=null;let i=n=>this.events.next(new _A(n)),r=n=>this.events.next(new xA(n));this.configLoader.onLoadEndListener=r,this.configLoader.onLoadStartListener=i}complete(){this.transitions?.complete()}handleNavigationRequest(i){let r=++this.navigationId;this.transitions?.next(Kt(ie(ie({},this.transitions.value),i),{id:r}))}setupNavigations(i,r,n){return this.transitions=new is({id:0,currentUrlTree:r,currentRawUrl:r,extractedUrl:this.urlHandlingStrategy.extract(r),urlAfterRedirects:this.urlHandlingStrategy.extract(r),rawUrl:r,extras:{},resolve:()=>{},reject:()=>{},promise:Promise.resolve(!0),source:yp,restoredState:null,currentSnapshot:n.snapshot,targetSnapshot:null,currentRouterState:n,targetRouterState:null,guards:{canActivateChecks:[],canDeactivateChecks:[]},guardsResult:null}),this.transitions.pipe(wn(o=>o.id!==0),ti(o=>Kt(ie({},o),{extractedUrl:this.urlHandlingStrategy.extract(o.rawUrl)})),Nn(o=>{let a=!1,l=!1;return Rt(o).pipe(Nn(c=>{if(this.navigationId>o.id)return this.cancelNavigationTransition(o,"",dn.SupersededByNewNavigation),on;this.currentTransition=o,this.currentNavigation={id:c.id,initialUrl:c.rawUrl,extractedUrl:c.extractedUrl,trigger:c.source,extras:c.extras,previousNavigation:this.lastSuccessfulNavigation?Kt(ie({},this.lastSuccessfulNavigation),{previousNavigation:null}):null};let h=!i.navigated||this.isUpdatingInternalState()||this.isUpdatedBrowserUrl(),u=c.extras.onSameUrlNavigation??i.onSameUrlNavigation;if(!h&&u!=="reload"){let d="";return this.events.next(new zc(c.id,this.urlSerializer.serialize(c.rawUrl),d,dA.IgnoredSameUrlNavigation)),c.resolve(!1),on}if(this.urlHandlingStrategy.shouldProcessUrl(c.rawUrl))return Rt(c).pipe(Nn(d=>{let f=this.transitions?.getValue();return this.events.next(new Pp(d.id,this.urlSerializer.serialize(d.extractedUrl),d.source,d.restoredState)),f!==this.transitions?.getValue()?on:Promise.resolve(d)}),U4(this.environmentInjector,this.configLoader,this.rootComponentType,i.config,this.urlSerializer,this.paramsInheritanceStrategy),kr(d=>{o.targetSnapshot=d.targetSnapshot,o.urlAfterRedirects=d.urlAfterRedirects,this.currentNavigation=Kt(ie({},this.currentNavigation),{finalUrl:d.urlAfterRedirects});let f=new sx(d.id,this.urlSerializer.serialize(d.extractedUrl),this.urlSerializer.serialize(d.urlAfterRedirects),d.targetSnapshot);this.events.next(f)}));if(h&&this.urlHandlingStrategy.shouldProcessUrl(c.currentRawUrl)){let{id:d,extractedUrl:f,source:m,restoredState:g,extras:_}=c,x=new Pp(d,this.urlSerializer.serialize(f),m,g);this.events.next(x);let b=R1(this.rootComponentType).snapshot;return this.currentTransition=o=Kt(ie({},c),{targetSnapshot:b,urlAfterRedirects:f,extras:Kt(ie({},_),{skipLocationChange:!1,replaceUrl:!1})}),this.currentNavigation.finalUrl=f,Rt(o)}else{let d="";return this.events.next(new zc(c.id,this.urlSerializer.serialize(c.extractedUrl),d,dA.IgnoredByUrlHandlingStrategy)),c.resolve(!1),on}}),kr(c=>{let h=new fA(c.id,this.urlSerializer.serialize(c.extractedUrl),this.urlSerializer.serialize(c.urlAfterRedirects),c.targetSnapshot);this.events.next(h)}),ti(c=>(this.currentTransition=o=Kt(ie({},c),{guards:s4(c.targetSnapshot,c.currentSnapshot,this.rootContexts)}),o)),m4(this.environmentInjector,c=>this.events.next(c)),kr(c=>{if(o.guardsResult=c.guardsResult,c.guardsResult&&typeof c.guardsResult!="boolean")throw cx(this.urlSerializer,c.guardsResult);let h=new pA(c.id,this.urlSerializer.serialize(c.extractedUrl),this.urlSerializer.serialize(c.urlAfterRedirects),c.targetSnapshot,!!c.guardsResult);this.events.next(h)}),wn(c=>c.guardsResult?!0:(this.cancelNavigationTransition(c,"",dn.GuardRejected),!1)),oA(c=>{if(c.guards.canActivateChecks.length)return Rt(c).pipe(kr(h=>{let u=new mA(h.id,this.urlSerializer.serialize(h.extractedUrl),this.urlSerializer.serialize(h.urlAfterRedirects),h.targetSnapshot);this.events.next(u)}),Nn(h=>{let u=!1;return Rt(h).pipe(k4(this.paramsInheritanceStrategy,this.environmentInjector),kr({next:()=>u=!0,complete:()=>{u||this.cancelNavigationTransition(h,"",dn.NoDataFromResolver)}}))}),kr(h=>{let u=new gA(h.id,this.urlSerializer.serialize(h.extractedUrl),this.urlSerializer.serialize(h.urlAfterRedirects),h.targetSnapshot);this.events.next(u)}))}),oA(c=>{let h=u=>{let d=[];u.routeConfig?.loadComponent&&!u.routeConfig._loadedComponent&&d.push(this.configLoader.loadComponent(u.routeConfig).pipe(kr(f=>{u.component=f}),ti(()=>{})));for(let f of u.children)d.push(...h(f));return d};return Xg(h(c.targetSnapshot.root)).pipe(El(null),Ba(1))}),oA(()=>this.afterPreactivation()),Nn(()=>{let{currentSnapshot:c,targetSnapshot:h}=o,u=this.createViewTransition?.(this.environmentInjector,c.root,h.root);return u?Mr(u).pipe(ti(()=>o)):Rt(o)}),ti(c=>{let h=QW(i.routeReuseStrategy,c.targetSnapshot,c.currentRouterState);return this.currentTransition=o=Kt(ie({},c),{targetRouterState:h}),this.currentNavigation.targetRouterState=h,o}),kr(()=>{this.events.next(new Dp)}),r4(this.rootContexts,i.routeReuseStrategy,c=>this.events.next(c),this.inputBindingEnabled),Ba(1),kr({next:c=>{a=!0,this.lastSuccessfulNavigation=this.currentNavigation,this.events.next(new Gc(c.id,this.urlSerializer.serialize(c.extractedUrl),this.urlSerializer.serialize(c.urlAfterRedirects))),this.titleStrategy?.updateTitle(c.targetRouterState.snapshot),c.resolve(!0)},complete:()=>{a=!0}}),Ty(this.transitionAbortSubject.pipe(kr(c=>{throw c}))),Pu(()=>{!a&&!l&&this.cancelNavigationTransition(o,"",dn.SupersededByNewNavigation),this.currentTransition?.id===o.id&&(this.currentNavigation=null,this.currentTransition=null)}),yl(c=>{if(l=!0,w1(c))this.events.next(new Ya(o.id,this.urlSerializer.serialize(o.extractedUrl),c.message,c.cancellationCode)),JW(c)?this.events.next(new td(c.url,c.navigationBehaviorOptions)):o.resolve(!1);else{let h=new Mp(o.id,this.urlSerializer.serialize(o.extractedUrl),c,o.targetSnapshot??void 0);try{let u=qo(this.environmentInjector,()=>this.navigationErrorHandler?.(h));if(u instanceof wp){let{message:d,cancellationCode:f}=cx(this.urlSerializer,u);this.events.next(new Ya(o.id,this.urlSerializer.serialize(o.extractedUrl),d,f)),this.events.next(new td(u.redirectTo,u.navigationBehaviorOptions))}else{this.events.next(h);let d=i.errorHandler(c);o.resolve(!!d)}}catch(u){this.options.resolveNavigationPromiseOnError?o.resolve(!1):o.reject(u)}}return on}))}))}cancelNavigationTransition(i,r,n){let o=new Ya(i.id,this.urlSerializer.serialize(i.extractedUrl),r,n);this.events.next(o),i.resolve(!1)}isUpdatingInternalState(){return this.currentTransition?.extractedUrl.toString()!==this.currentTransition?.currentUrlTree.toString()}isUpdatedBrowserUrl(){return this.urlHandlingStrategy.extract(this.urlSerializer.parse(this.location.path(!0))).toString()!==this.currentTransition?.extractedUrl.toString()&&!this.currentTransition?.extras.skipLocationChange}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})();function Z4(s){return s!==yp}var J4=(()=>{let e=class e{};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:()=>Ue(eH),providedIn:"root"});let s=e;return s})(),wA=class{shouldDetach(e){return!1}store(e,t){}shouldAttach(e){return!1}retrieve(e){return null}shouldReuseRoute(e,t){return e.routeConfig===t.routeConfig}},eH=(()=>{let e=class e extends wA{};e.\u0275fac=(()=>{let i;return function(n){return(i||(i=SE(e)))(n||e)}})(),e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})(),k1=(()=>{let e=class e{};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:()=>Ue(tH),providedIn:"root"});let s=e;return s})(),tH=(()=>{let e=class e extends k1{constructor(){super(...arguments),this.location=Ue(mp),this.urlSerializer=Ue(NA),this.options=Ue(UA,{optional:!0})||{},this.canceledNavigationResolution=this.options.canceledNavigationResolution||"replace",this.urlHandlingStrategy=Ue(GA),this.urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred",this.currentUrlTree=new Ol,this.rawUrlTree=this.currentUrlTree,this.currentPageId=0,this.lastSuccessfulId=-1,this.routerState=R1(null),this.stateMemento=this.createStateMemento()}getCurrentUrlTree(){return this.currentUrlTree}getRawUrlTree(){return this.rawUrlTree}restoredState(){return this.location.getState()}get browserPageId(){return this.canceledNavigationResolution!=="computed"?this.currentPageId:this.restoredState()?.\u0275routerPageId??this.currentPageId}getRouterState(){return this.routerState}createStateMemento(){return{rawUrlTree:this.rawUrlTree,currentUrlTree:this.currentUrlTree,routerState:this.routerState}}registerNonRouterCurrentEntryChangeListener(i){return this.location.subscribe(r=>{r.type==="popstate"&&i(r.url,r.state)})}handleRouterEvent(i,r){if(i instanceof Pp)this.stateMemento=this.createStateMemento();else if(i instanceof zc)this.rawUrlTree=r.initialUrl;else if(i instanceof sx){if(this.urlUpdateStrategy==="eager"&&!r.extras.skipLocationChange){let n=this.urlHandlingStrategy.merge(r.finalUrl,r.initialUrl);this.setBrowserUrl(n,r)}}else i instanceof Dp?(this.currentUrlTree=r.finalUrl,this.rawUrlTree=this.urlHandlingStrategy.merge(r.finalUrl,r.initialUrl),this.routerState=r.targetRouterState,this.urlUpdateStrategy==="deferred"&&(r.extras.skipLocationChange||this.setBrowserUrl(this.rawUrlTree,r))):i instanceof Ya&&(i.code===dn.GuardRejected||i.code===dn.NoDataFromResolver)?this.restoreHistory(r):i instanceof Mp?this.restoreHistory(r,!0):i instanceof Gc&&(this.lastSuccessfulId=i.id,this.currentPageId=this.browserPageId)}setBrowserUrl(i,r){let n=this.urlSerializer.serialize(i);if(this.location.isCurrentPathEqualTo(n)||r.extras.replaceUrl){let o=this.browserPageId,a=ie(ie({},r.extras.state),this.generateNgRouterState(r.id,o));this.location.replaceState(n,"",a)}else{let o=ie(ie({},r.extras.state),this.generateNgRouterState(r.id,this.browserPageId+1));this.location.go(n,"",o)}}restoreHistory(i,r=!1){if(this.canceledNavigationResolution==="computed"){let n=this.browserPageId,o=this.currentPageId-n;o!==0?this.location.historyGo(o):this.currentUrlTree===i.finalUrl&&o===0&&(this.resetState(i),this.resetUrlToCurrentUrlTree())}else this.canceledNavigationResolution==="replace"&&(r&&this.resetState(i),this.resetUrlToCurrentUrlTree())}resetState(i){this.routerState=this.stateMemento.routerState,this.currentUrlTree=this.stateMemento.currentUrlTree,this.rawUrlTree=this.urlHandlingStrategy.merge(this.currentUrlTree,i.finalUrl??this.rawUrlTree)}resetUrlToCurrentUrlTree(){this.location.replaceState(this.urlSerializer.serialize(this.rawUrlTree),"",this.generateNgRouterState(this.lastSuccessfulId,this.currentPageId))}generateNgRouterState(i,r){return this.canceledNavigationResolution==="computed"?{navigationId:i,\u0275routerPageId:r}:{navigationId:i}}};e.\u0275fac=(()=>{let i;return function(n){return(i||(i=SE(e)))(n||e)}})(),e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})(),bp=function(s){return s[s.COMPLETE=0]="COMPLETE",s[s.FAILED=1]="FAILED",s[s.REDIRECTING=2]="REDIRECTING",s}(bp||{});function iH(s,e){s.events.pipe(wn(t=>t instanceof Gc||t instanceof Ya||t instanceof Mp||t instanceof zc),ti(t=>t instanceof Gc||t instanceof zc?bp.COMPLETE:(t instanceof Ya?t.code===dn.Redirect||t.code===dn.SupersededByNewNavigation:!1)?bp.REDIRECTING:bp.FAILED),wn(t=>t!==bp.REDIRECTING),Ba(1)).subscribe(()=>{e()})}function rH(s){throw s}var sH={paths:"exact",fragment:"ignored",matrixParams:"ignored",queryParams:"exact"},nH={paths:"subset",fragment:"ignored",matrixParams:"ignored",queryParams:"subset"},G1=(()=>{let e=class e{get currentUrlTree(){return this.stateManager.getCurrentUrlTree()}get rawUrlTree(){return this.stateManager.getRawUrlTree()}get events(){return this._events}get routerState(){return this.stateManager.getRouterState()}constructor(){this.disposed=!1,this.console=Ue(z_),this.stateManager=Ue(k1),this.options=Ue(UA,{optional:!0})||{},this.pendingTasks=Ue(Fc),this.urlUpdateStrategy=this.options.urlUpdateStrategy||"deferred",this.navigationTransitions=Ue(K4),this.urlSerializer=Ue(NA),this.location=Ue(mp),this.urlHandlingStrategy=Ue(GA),this._events=new Os,this.errorHandler=this.options.errorHandler||rH,this.navigated=!1,this.routeReuseStrategy=Ue(J4),this.onSameUrlNavigation=this.options.onSameUrlNavigation||"ignore",this.config=Ue(kA,{optional:!0})?.flat()??[],this.componentInputBindingEnabled=!!Ue(LA,{optional:!0}),this.eventsSubscription=new Pr,this.resetConfig(this.config),this.navigationTransitions.setupNavigations(this,this.currentUrlTree,this.routerState).subscribe({error:i=>{this.console.warn(i)}}),this.subscribeToNavigationEvents()}subscribeToNavigationEvents(){let i=this.navigationTransitions.events.subscribe(r=>{try{let n=this.navigationTransitions.currentTransition,o=this.navigationTransitions.currentNavigation;if(n!==null&&o!==null){if(this.stateManager.handleRouterEvent(r,o),r instanceof Ya&&r.code!==dn.Redirect&&r.code!==dn.SupersededByNewNavigation)this.navigated=!0;else if(r instanceof Gc)this.navigated=!0;else if(r instanceof td){let a=r.navigationBehaviorOptions,l=this.urlHandlingStrategy.merge(r.url,n.currentRawUrl),c=ie({info:n.extras.info,skipLocationChange:n.extras.skipLocationChange,replaceUrl:n.extras.replaceUrl||this.urlUpdateStrategy==="eager"||Z4(n.source)},a);this.scheduleNavigation(l,yp,null,c,{resolve:n.resolve,reject:n.reject,promise:n.promise})}}aH(r)&&this._events.next(r)}catch(n){this.navigationTransitions.transitionAbortSubject.next(n)}});this.eventsSubscription.add(i)}resetRootComponentType(i){this.routerState.root.component=i,this.navigationTransitions.rootComponentType=i}initialNavigation(){this.setUpLocationChangeListener(),this.navigationTransitions.hasRequestedNavigation||this.navigateToSyncWithBrowser(this.location.path(!0),yp,this.stateManager.restoredState())}setUpLocationChangeListener(){this.nonRouterCurrentEntryChangeSubscription??=this.stateManager.registerNonRouterCurrentEntryChangeListener((i,r)=>{setTimeout(()=>{this.navigateToSyncWithBrowser(i,"popstate",r)},0)})}navigateToSyncWithBrowser(i,r,n){let o={replaceUrl:!0},a=n?.navigationId?n:null;if(n){let c=ie({},n);delete c.navigationId,delete c.\u0275routerPageId,Object.keys(c).length!==0&&(o.state=c)}let l=this.parseUrl(i);this.scheduleNavigation(l,r,a,o)}get url(){return this.serializeUrl(this.currentUrlTree)}getCurrentNavigation(){return this.navigationTransitions.currentNavigation}get lastSuccessfulNavigation(){return this.navigationTransitions.lastSuccessfulNavigation}resetConfig(i){this.config=i.map(BA),this.navigated=!1}ngOnDestroy(){this.dispose()}dispose(){this.navigationTransitions.complete(),this.nonRouterCurrentEntryChangeSubscription&&(this.nonRouterCurrentEntryChangeSubscription.unsubscribe(),this.nonRouterCurrentEntryChangeSubscription=void 0),this.disposed=!0,this.eventsSubscription.unsubscribe()}createUrlTree(i,r={}){let{relativeTo:n,queryParams:o,fragment:a,queryParamsHandling:l,preserveFragment:c}=r,h=c?this.currentUrlTree.fragment:a,u=null;switch(l){case"merge":u=ie(ie({},this.currentUrlTree.queryParams),o);break;case"preserve":u=this.currentUrlTree.queryParams;break;default:u=o||null}u!==null&&(u=this.removeEmptyProps(u));let d;try{let f=n?n.snapshot:this.routerState.snapshot.root;d=y1(f)}catch{(typeof i[0]!="string"||i[0][0]!=="/")&&(i=[]),d=this.currentUrlTree.root}return E1(d,i,u,h??null)}navigateByUrl(i,r={skipLocationChange:!1}){let n=Ip(i)?i:this.parseUrl(i),o=this.urlHandlingStrategy.merge(n,this.rawUrlTree);return this.scheduleNavigation(o,yp,null,r)}navigate(i,r={skipLocationChange:!1}){return oH(i),this.navigateByUrl(this.createUrlTree(i,r),r)}serializeUrl(i){return this.urlSerializer.serialize(i)}parseUrl(i){try{return this.urlSerializer.parse(i)}catch{return this.urlSerializer.parse("/")}}isActive(i,r){let n;if(r===!0?n=ie({},sH):r===!1?n=ie({},nH):n=r,Ip(i))return a1(this.currentUrlTree,i,n);let o=this.parseUrl(i);return a1(this.currentUrlTree,o,n)}removeEmptyProps(i){return Object.entries(i).reduce((r,[n,o])=>(o!=null&&(r[n]=o),r),{})}scheduleNavigation(i,r,n,o,a){if(this.disposed)return Promise.resolve(!1);let l,c,h;a?(l=a.resolve,c=a.reject,h=a.promise):h=new Promise((d,f)=>{l=d,c=f});let u=this.pendingTasks.add();return iH(this,()=>{queueMicrotask(()=>this.pendingTasks.remove(u))}),this.navigationTransitions.handleNavigationRequest({source:r,restoredState:n,currentUrlTree:this.currentUrlTree,currentRawUrl:this.currentUrlTree,rawUrl:i,extras:o,resolve:l,reject:c,promise:h,currentSnapshot:this.routerState.snapshot,currentRouterState:this.routerState}),h.catch(d=>Promise.reject(d))}};e.\u0275fac=function(r){return new(r||e)},e.\u0275prov=Ft({token:e,factory:e.\u0275fac,providedIn:"root"});let s=e;return s})();function oH(s){for(let e=0;e<s.length;e++)if(s[e]==null)throw new _t(4008,!1)}function aH(s){return!(s instanceof Dp)&&!(s instanceof td)}var lH=new Pt("");function z1(s,...e){return Nc([{provide:kA,multi:!0,useValue:s},[],{provide:id,useFactory:cH,deps:[G1]},{provide:$u,multi:!0,useFactory:hH},e.map(t=>t.\u0275providers)])}function cH(s){return s.routerState.root}function hH(){let s=Ue(za);return e=>{let t=s.get(Xa);if(e!==t.components[0])return;let i=s.get(G1),r=s.get(uH);s.get(dH)===1&&i.initialNavigation(),s.get(fH,null,Ht.Optional)?.setUpPreloading(),s.get(lH,null,Ht.Optional)?.init(),i.resetRootComponentType(t.componentTypes[0]),r.closed||(r.next(),r.complete(),r.unsubscribe())}}var uH=new Pt("",{factory:()=>new Os}),dH=new Pt("",{providedIn:"root",factory:()=>1});var fH=new Pt("");var W1=[];var H1={providers:[IL({eventCoalescing:!0}),z1(W1),o1()]};var Jt=(()=>{class s{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[]}static AddParser(t,i){this._BabylonFileParsers[t]=i}static GetParser(t){return this._BabylonFileParsers[t]?this._BabylonFileParsers[t]:null}static AddIndividualParser(t,i){this._IndividualBabylonFileParsers[t]=i}static GetIndividualParser(t){return this._IndividualBabylonFileParsers[t]?this._IndividualBabylonFileParsers[t]:null}static Parse(t,i,r,n){for(let o in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,o)&&this._BabylonFileParsers[o](t,i,r,n)}get environmentTexture(){return this._environmentTexture}set environmentTexture(t){this._environmentTexture=t}getNodes(){let t=[];return t=t.concat(this.meshes),t=t.concat(this.lights),t=t.concat(this.cameras),t=t.concat(this.transformNodes),this.skeletons.forEach(i=>t=t.concat(i.bones)),t}}return s._BabylonFileParsers={},s._IndividualBabylonFileParsers={},s})();P("BABYLON.AbstractScene",Jt);var Nl=(()=>{class s{constructor(){this.hoverCursor="",this.actions=[],this.isRecursive=!1,this.disposeWhenUnowned=!0}static get HasTriggers(){for(let t in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,t))return!0;return!1}static get HasPickTriggers(){for(let t in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,t)){let i=parseInt(t);if(i>=1&&i<=7)return!0}return!1}static HasSpecificTrigger(t){for(let i in s.Triggers)if(Object.prototype.hasOwnProperty.call(s.Triggers,i)&&parseInt(i)===t)return!0;return!1}}return s.Triggers={},s})();var jt=(()=>{class s{constructor(t,i){this.triggerOptions=t,this.onBeforeExecuteObservable=new U,t.parameter?(this.trigger=t.trigger,this._triggerParameter=t.parameter):t.trigger?this.trigger=t.trigger:this.trigger=t,this._nextActiveAction=this,this._condition=i}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(t){this._triggerParameter=t}_evaluateConditionForCurrentFrame(){let t=this._condition;if(!t)return!0;let i=this._actionManager.getScene().getRenderId();return t._evaluationId!==i&&(t._evaluationId=i,t._currentResult=t.isValid()),t._currentResult}_executeCurrent(t){this._evaluateConditionForCurrentFrame()&&(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(t),this.skipToNextActiveAction())}execute(t){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(t){return this._child=t,t._actionManager=this._actionManager,t._prepare(),t}_getProperty(t){return this._actionManager._getProperty(t)}_getEffectiveTarget(t,i){return this._actionManager._getEffectiveTarget(t,i)}serialize(t){return null}_serialize(t,i){let r={type:1,children:[],name:t.name,properties:t.properties||[]};if(this._child&&this._child.serialize(r),this._condition){let n=this._condition.serialize();return n.children.push(r),i&&i.children.push(n),n}return i&&i.children.push(r),r}}return s._SerializeValueAsString=e=>typeof e=="number"?e.toString():typeof e=="boolean"?e?"true":"false":e instanceof j?e.x+", "+e.y:e instanceof p?e.x+", "+e.y+", "+e.z:e instanceof X?e.r+", "+e.g+", "+e.b:e instanceof oe?e.r+", "+e.g+", "+e.b+", "+e.a:e,s._GetTargetProperty=e=>({name:"target",targetType:e._isMesh?"MeshProperties":e._isLight?"LightProperties":e._isCamera?"CameraProperties":e._isMaterial?"MaterialProperties":"SceneProperties",value:e._isScene?"Scene":e.name}),s})();P("BABYLON.Action",jt);var Ii=class s{constructor(e,t,i,r,n,o){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=r,this.sourceEvent=n,this.additionalData=o}static CreateNew(e,t,i){let r=e.getScene();return new s(e,r.pointerX,r.pointerY,r.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,r){return new s(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,r)}static CreateNewFromScene(e,t){return new s(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,r){return new s(e,t.x,t.y,null,i,r)}};var Fl=class{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}},HA=(()=>{class s extends Fl{static get IsEqual(){return s._IsEqual}static get IsDifferent(){return s._IsDifferent}static get IsGreater(){return s._IsGreater}static get IsLesser(){return s._IsLesser}constructor(t,i,r,n,o=s.IsEqual){super(t),this.propertyPath=r,this.value=n,this.operator=o,this._target=i,this._effectiveTarget=this._getEffectiveTarget(i,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case s.IsGreater:return this._effectiveTarget[this._property]>this.value;case s.IsLesser:return this._effectiveTarget[this._property]<this.value;case s.IsEqual:case s.IsDifferent:{let t;return this.value.equals?t=this.value.equals(this._effectiveTarget[this._property]):t=this.value===this._effectiveTarget[this._property],this.operator===s.IsEqual?t:!t}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[jt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:jt._SerializeValueAsString(this.value)},{name:"operator",value:s.GetOperatorName(this.operator)}]})}static GetOperatorName(t){switch(t){case s._IsEqual:return"IsEqual";case s._IsDifferent:return"IsDifferent";case s._IsGreater:return"IsGreater";case s._IsLesser:return"IsLesser";default:return""}}}return s._IsEqual=0,s._IsDifferent=1,s._IsGreater=2,s._IsLesser=3,s})(),zA=class extends Fl{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}},WA=class extends Fl{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[jt._GetTargetProperty(this._target),{name:"value",value:this.value}]})}};P("BABYLON.ValueCondition",HA);P("BABYLON.PredicateCondition",zA);P("BABYLON.StateCondition",WA);var XA=class extends jt{constructor(e,t,i,r){super(e,r),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[jt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}},YA=class extends jt{constructor(e,t,i,r){super(e,r),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[jt._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}},$A=class extends jt{constructor(e,t,i,r,n){super(e,n),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[jt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:jt._SerializeValueAsString(this.value)}]},e)}},jA=class extends jt{constructor(e,t,i,r,n){super(e,n),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),typeof this._effectiveTarget[this._property]!="number"&&F.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[jt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:jt._SerializeValueAsString(this.value)}]},e)}},qA=class extends jt{constructor(e,t,i,r,n,o){super(e,o),this.from=i,this.to=r,this.loop=n,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[jt._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:jt._SerializeValueAsString(this.loop)||!1}]},e)}},QA=class extends jt{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[jt._GetTargetProperty(this._target)]},e)}},Up=class extends jt{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}},KA=class extends jt{constructor(e,t,i,r=!0){super(e,i),this.children=t,this.enableChildrenConditions=r}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(let t of this.children)(!this.enableChildrenConditions||t._evaluateConditionForCurrentFrame())&&t.execute(e)}serialize(e){let t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let i=0;i<this.children.length;i++)t.combine.push(this.children[i].serialize(null));return t}},ZA=class extends jt{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}},fx=class extends jt{constructor(e,t,i,r){super(e,r),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;let e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=p.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[jt._GetTargetProperty(this._target),jt._GetTargetProperty(this._parent)]},e)}};P("BABYLON.SetParentAction",fx);P("BABYLON.ExecuteCodeAction",ZA);P("BABYLON.DoNothingAction",Up);P("BABYLON.StopAnimationAction",QA);P("BABYLON.PlayAnimationAction",qA);P("BABYLON.IncrementValueAction",jA);P("BABYLON.SetValueAction",$A);P("BABYLON.SetStateAction",YA);P("BABYLON.SetParentAction",fx);P("BABYLON.SwitchBooleanAction",XA);P("BABYLON.CombineAction",KA);var JA=(()=>{class s extends Nl{constructor(t){super(),t=t||me.LastCreatedScene,t&&(this._scene=t,t.actionManagers.push(this))}dispose(){let t=this._scene.actionManagers.indexOf(this);for(let r=0;r<this.actions.length;r++){let n=this.actions[r];s.Triggers[n.trigger]--,s.Triggers[n.trigger]===0&&delete s.Triggers[n.trigger]}this.actions.length=0,t>-1&&this._scene.actionManagers.splice(t,1);let i=this._scene.meshes.filter(r=>r.actionManager===this);for(let r of i)r.actionManager=null}getScene(){return this._scene}hasSpecificTriggers(t){for(let i=0;i<this.actions.length;i++){let r=this.actions[i];if(t.indexOf(r.trigger)>-1)return!0}return!1}hasSpecificTriggers2(t,i){for(let r=0;r<this.actions.length;r++){let n=this.actions[r];if(t==n.trigger||i==n.trigger)return!0}return!1}hasSpecificTrigger(t,i){for(let r=0;r<this.actions.length;r++){let n=this.actions[r];if(n.trigger===t)if(i){if(i(n.getTriggerParameter()))return!0}else return!0}return!1}get hasPointerTriggers(){for(let t=0;t<this.actions.length;t++){let i=this.actions[t];if(i.trigger>=s.OnPickTrigger&&i.trigger<=s.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let t=0;t<this.actions.length;t++){let i=this.actions[t];if(i.trigger>=s.OnPickTrigger&&i.trigger<=s.OnPickUpTrigger)return!0}return!1}registerAction(t){return t.trigger===s.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(F.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(t),this.getScene()._registeredActions++,s.Triggers[t.trigger]?s.Triggers[t.trigger]++:s.Triggers[t.trigger]=1,t._actionManager=this,t._prepare(),t)}unregisterAction(t){let i=this.actions.indexOf(t);return i!==-1?(this.actions.splice(i,1),s.Triggers[t.trigger]-=1,s.Triggers[t.trigger]===0&&delete s.Triggers[t.trigger],t._actionManager=null,this.getScene()._registeredActions--,!0):!1}processTrigger(t,i){for(let r=0;r<this.actions.length;r++){let n=this.actions[r];if(n.trigger===t){if(i&&(t===s.OnKeyUpTrigger||t===s.OnKeyDownTrigger)){let o=n.getTriggerParameter();if(typeof o=="function"){if(!o(i))continue}else if(o&&o!==i.sourceEvent.keyCode){if(!o.toLowerCase)continue;let a=o.toLowerCase();if(a!==i.sourceEvent.key){let l=i.sourceEvent.charCode?i.sourceEvent.charCode:i.sourceEvent.keyCode;if(String.fromCharCode(l).toLowerCase()!==a)continue}}}n._executeCurrent(i)}}}_getEffectiveTarget(t,i){let r=i.split(".");for(let n=0;n<r.length-1;n++)t=t[r[n]];return t}_getProperty(t){let i=t.split(".");return i[i.length-1]}serialize(t){let i={children:new Array,name:t,type:3,properties:new Array};for(let r=0;r<this.actions.length;r++){let n={type:0,children:new Array,name:s.GetTriggerName(this.actions[r].trigger),properties:new Array},o=this.actions[r].triggerOptions;if(o&&typeof o!="number")if(o.parameter instanceof Node)n.properties.push(jt._GetTargetProperty(o.parameter));else if(typeof o.parameter=="object"){let a={};ei.DeepCopy(o.parameter,a,["mesh"]),o.parameter&&o.parameter.mesh&&(a._meshId=o.parameter.mesh.id),n.properties.push({name:"parameter",targetType:null,value:a})}else n.properties.push({name:"parameter",targetType:null,value:o.parameter});this.actions[r].serialize(n),i.children.push(n)}return i}static Parse(t,i,r){let n=new s(r);i===null?r.actionManager=n:i.actionManager=n;let o=(c,h)=>{let u=Et("BABYLON."+c);return u&&new u(...h)},a=(c,h,u,d)=>{if(d===null){let _=parseFloat(h);return h==="true"||h==="false"?h==="true":isNaN(_)?h:_}let f=d.split("."),m=h.split(",");for(let _=0;_<f.length;_++)u=u[f[_]];if(typeof u=="boolean")return m[0]==="true";if(typeof u=="string")return m[0];let g=[];for(let _=0;_<m.length;_++)g.push(parseFloat(m[_]));return u instanceof p?p.FromArray(g):u instanceof De?De.FromArray(g):u instanceof X?X.FromArray(g):u instanceof oe?oe.FromArray(g):parseFloat(m[0])},l=(c,h,u,d,f=null)=>{if(c.detached)return;let m=[],g=null,_=null,x=c.combine&&c.combine.length>0;if(c.type===2?m.push(n):m.push(h),x){let C=[];for(let R=0;R<c.combine.length;R++)l(c.combine[R],s.NothingTrigger,u,d,C);m.push(C)}else for(let C=0;C<c.properties.length;C++){let R=c.properties[C].value,E=c.properties[C].name,S=c.properties[C].targetType;E==="target"?S==="SceneProperties"?R=g=r:S==="MaterialProperties"?R=g=r.getMaterialByName(R):R=g=r.getNodeByName(R):E==="parent"?R=r.getNodeByName(R):E==="sound"?r.getSoundByName&&(R=r.getSoundByName(R)):E!=="propertyPath"?c.type===2&&E==="operator"?R=HA[R]:R=a(E,R,g,E==="value"?_:null):_=R,m.push(R)}if(f===null?m.push(u):m.push(null),c.name==="InterpolateValueAction"){let C=m[m.length-2];m[m.length-1]=C,m[m.length-2]=u}let b=o(c.name,m);if(b instanceof Fl&&u!==null){let C=new Up(h,u);d?d.then(C):n.registerAction(C),d=C}f===null?b instanceof Fl?(u=b,b=d):(u=null,d?d.then(b):n.registerAction(b)):f.push(b);for(let C=0;C<c.children.length;C++)l(c.children[C],h,u,b,null)};for(let c=0;c<t.children.length;c++){let h,u=t.children[c];if(u.properties.length>0){let d=u.properties[0].value,f=u.properties[0].targetType===null?d:r.getMeshByName(d);f._meshId&&(f.mesh=r.getMeshById(f._meshId)),h={trigger:s[u.name],parameter:f}}else h=s[u.name];for(let d=0;d<u.children.length;d++)u.detached||l(u.children[d],h,null,null)}}static GetTriggerName(t){switch(t){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}return s.NothingTrigger=0,s.OnPickTrigger=1,s.OnLeftPickTrigger=2,s.OnRightPickTrigger=3,s.OnCenterPickTrigger=4,s.OnPickDownTrigger=5,s.OnDoublePickTrigger=6,s.OnPickUpTrigger=7,s.OnPickOutTrigger=16,s.OnLongPressTrigger=8,s.OnPointerOverTrigger=9,s.OnPointerOutTrigger=10,s.OnEveryFrameTrigger=11,s.OnIntersectionEnterTrigger=12,s.OnIntersectionExitTrigger=13,s.OnKeyDownTrigger=14,s.OnKeyUpTrigger=15,s})();var eI=class extends jt{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){this._sound!==void 0&&this._sound.play()}serialize(e){return super._serialize({name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}},tI=class extends jt{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){this._sound!==void 0&&this._sound.stop()}serialize(e){return super._serialize({name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}};P("BABYLON.PlaySoundAction",eI);P("BABYLON.StopSoundAction",tI);var kp=function(s){return s[s.NONE=0]="NONE",s[s.STEP=1]="STEP",s}(kp||{});var Ll=class s{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new s(this.name,this.from,this.to)}};var iI=class{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new U,this._onClonedObservable=new U}},Xe=class s{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,r){let n=this._NodeConstructors[e];return n?n(t,i,r):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;let t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){let i=this._parentNode._children.indexOf(this);i!==-1&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._isDirty=!0,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){let e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null,i=!0){this._isDirty=!1,this._nodeDataStorage=new iI,this.state="",this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new U,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=N.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new U,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||me.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache(),i&&this._addToSceneRootNodes()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return this._behaviors.indexOf(e)!==-1?this:(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this)}removeBehavior(e){let t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(let t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={}}updateCache(e){!e&&this.isSynchronized()||this._updateCache()}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,t=!1,i){if(this._children)for(let r=0;r<this._children.length;r++){let n=this._children[r];(!i||i(n))&&e.push(n),t||n._getDescendants(e,!1,i)}}getDescendants(e,t){let i=[];return this._getDescendants(i,e,t),i}getChildMeshes(e,t){let i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r.cullingStrategy!==void 0),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){let i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=s._AnimationRangeFactory(e,t,i);for(let r=0,n=this.animations.length;r<n;r++)this.animations[r]&&this.animations[r].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.animations.length;i<r;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}clone(e,t,i){let r=ae.Clone(()=>new s(e,this.getScene()),this);if(t&&(r.parent=t),!i){let n=this.getDescendants(!0);for(let o=0;o<n.length;o++){let a=n[o];a.clone(e+"."+a.name,r)}}return r}getAnimationRanges(){let e=[],t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,r){let n=this.getAnimationRange(e);return n?this._scene.beginAnimation(this,n.from,n.to,t,i,r):null}serializeAnimationRanges(){let e=[];for(let t in this._ranges){let i=this._ranges[t];if(!i)continue;let r={};r.name=t,r.from=i.from,r.to=i.to,e.push(r)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=N.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){let i=this.getDescendants(!0);for(let r of i)r.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(let i of this._behaviors)i.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let r=0;r<t.ranges.length;r++){let n=t.ranges[r];e.createAnimationRange(n.name,n.from,n.to)}}getHierarchyBoundingVectors(e=!0,t=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let i,r,n=this;if(n.getBoundingInfo&&n.subMeshes){let o=n.getBoundingInfo();i=o.boundingBox.minimumWorld.clone(),r=o.boundingBox.maximumWorld.clone()}else i=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new p(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){let o=this.getDescendants(!1);for(let a of o){let l=a;if(l.computeWorldMatrix(!0),t&&!t(l)||!l.getBoundingInfo||l.getTotalVertices()===0)continue;let h=l.getBoundingInfo().boundingBox,u=h.minimumWorld,d=h.maximumWorld;p.CheckExtends(u,i,r),p.CheckExtends(d,i,r)}}return{min:i,max:r}}};Xe._AnimationRangeFactory=(s,e,t)=>{throw We("AnimationRange")};Xe._NodeConstructors={};v([I()],Xe.prototype,"name",void 0);v([I()],Xe.prototype,"id",void 0);v([I()],Xe.prototype,"uniqueId",void 0);v([I()],Xe.prototype,"state",void 0);v([I()],Xe.prototype,"metadata",void 0);var rI=Object.freeze(new q(0,0,0,0)),sI=Object.freeze(p.Zero()),nI=Object.freeze(j.Zero()),oI=Object.freeze(yg.Zero()),aI=Object.freeze(X.Black()),lI=Object.freeze(new oe(0,0,0,0)),xo={key:0,repeatCount:0,loopMode:2},te=class s{static _PrepareAnimation(e,t,i,r,n,o,a,l){let c;if(!isNaN(parseFloat(n))&&isFinite(n)?c=s.ANIMATIONTYPE_FLOAT:n instanceof q?c=s.ANIMATIONTYPE_QUATERNION:n instanceof p?c=s.ANIMATIONTYPE_VECTOR3:n instanceof j?c=s.ANIMATIONTYPE_VECTOR2:n instanceof X?c=s.ANIMATIONTYPE_COLOR3:n instanceof oe?c=s.ANIMATIONTYPE_COLOR4:n instanceof yg&&(c=s.ANIMATIONTYPE_SIZE),c==null)return null;let h=new s(e,t,i,c,a),u=[{frame:0,value:n},{frame:r,value:o}];return h.setKeys(u),l!==void 0&&h.setEasingFunction(l),h}static CreateAnimation(e,t,i,r){let n=new s(e+"Animation",e,i,t,s.ANIMATIONLOOPMODE_CONSTANT);return n.setEasingFunction(r),n}static CreateAndStartAnimation(e,t,i,r,n,o,a,l,c,h,u){let d=s._PrepareAnimation(e,i,r,n,o,a,l,c);return!d||(t.getScene&&(u=t.getScene()),!u)?null:u.beginDirectAnimation(t,[d],0,n,d.loopMode===1,1,h)}static CreateAndStartHierarchyAnimation(e,t,i,r,n,o,a,l,c,h,u){let d=s._PrepareAnimation(e,r,n,o,a,l,c,h);return d?t.getScene().beginDirectHierarchyAnimation(t,i,[d],0,o,d.loopMode===1,1,u):null}static CreateMergeAndStartAnimation(e,t,i,r,n,o,a,l,c,h){let u=s._PrepareAnimation(e,i,r,n,o,a,l,c);return u?(t.animations.push(u),t.getScene().beginAnimation(t,0,n,u.loopMode===1,1,h)):null}static MakeAnimationAdditive(e,t,i,r=!1,n){let o;typeof t=="object"?o=t:o={referenceFrame:t??0,range:i,cloneOriginalAnimation:r,clonedAnimationName:n};let a=e;if(o.cloneOriginalAnimation&&(a=e.clone(),a.name=o.clonedAnimationName||a.name),!a._keys.length)return a;let l=o.referenceFrame&&o.referenceFrame>=0?o.referenceFrame:0,c=0,h=a._keys[0],u=a._keys.length-1,d=a._keys[u],f={referenceValue:h.value,referencePosition:O.Vector3[0],referenceQuaternion:O.Quaternion[0],referenceScaling:O.Vector3[1],keyPosition:O.Vector3[2],keyQuaternion:O.Quaternion[1],keyScaling:O.Vector3[3]},m=h.frame,g=d.frame;if(o.range){let b=a.getRange(o.range);b&&(m=b.from,g=b.to)}else m=o.fromFrame??m,g=o.toFrame??g;if(m!==h.frame&&(c=a.createKeyForFrame(m)),g!==d.frame&&(u=a.createKeyForFrame(g)),a._keys.length===1){let b=a._getKeyValue(a._keys[0]);f.referenceValue=b.clone?b.clone():b}else if(l<=h.frame){let b=a._getKeyValue(h.value);f.referenceValue=b.clone?b.clone():b}else if(l>=d.frame){let b=a._getKeyValue(d.value);f.referenceValue=b.clone?b.clone():b}else{xo.key=0;let b=a._interpolate(l,xo);f.referenceValue=b.clone?b.clone():b}a.dataType===s.ANIMATIONTYPE_QUATERNION?f.referenceValue.normalize().conjugateInPlace():a.dataType===s.ANIMATIONTYPE_MATRIX&&(f.referenceValue.decompose(f.referenceScaling,f.referenceQuaternion,f.referencePosition),f.referenceQuaternion.normalize().conjugateInPlace());let _=Number.MAX_VALUE,x=o.clipKeys?[]:null;for(let b=c;b<=u;b++){let C=a._keys[b];if((x||o.cloneOriginalAnimation)&&(C={frame:C.frame,value:C.value.clone?C.value.clone():C.value,inTangent:C.inTangent,outTangent:C.outTangent,interpolation:C.interpolation,lockedTangent:C.lockedTangent},x&&(_===Number.MAX_VALUE&&(_=C.frame),C.frame-=_,x.push(C))),!(b&&a.dataType!==s.ANIMATIONTYPE_FLOAT&&C.value===h.value))switch(a.dataType){case s.ANIMATIONTYPE_MATRIX:C.value.decompose(f.keyScaling,f.keyQuaternion,f.keyPosition),f.keyPosition.subtractInPlace(f.referencePosition),f.keyScaling.divideInPlace(f.referenceScaling),f.referenceQuaternion.multiplyToRef(f.keyQuaternion,f.keyQuaternion),N.ComposeToRef(f.keyScaling,f.keyQuaternion,f.keyPosition,C.value);break;case s.ANIMATIONTYPE_QUATERNION:f.referenceValue.multiplyToRef(C.value,C.value);break;case s.ANIMATIONTYPE_VECTOR2:case s.ANIMATIONTYPE_VECTOR3:case s.ANIMATIONTYPE_COLOR3:case s.ANIMATIONTYPE_COLOR4:C.value.subtractToRef(f.referenceValue,C.value);break;case s.ANIMATIONTYPE_SIZE:C.value.width-=f.referenceValue.width,C.value.height-=f.referenceValue.height;break;default:C.value-=f.referenceValue}}return x&&a.setKeys(x,!0),a}static TransitionTo(e,t,i,r,n,o,a,l=null){if(a<=0)return i[e]=t,l&&l(),null;let c=n*(a/1e3);o.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:c,value:t}]),i.animations||(i.animations=[]),i.animations.push(o);let h=r.beginAnimation(i,0,c,!1);return h.onAnimationEnd=l,h}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(let e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,r,n,o){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=r,this.loopMode=n,this.enableBlending=o,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=r,this.loopMode=n===void 0?s.ANIMATIONLOOPMODE_CYCLE:n,this.uniqueId=s._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let i=!0;for(let r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((t,i)=>t.frame-i.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new Ll(e,t,i))}deleteRange(e,t=!0){let i=this._ranges[e];if(i){if(t){let r=i.from,n=i.to;for(let o=this._keys.length-1;o>=0;o--)this._keys[o].frame>=r&&this._keys[o].frame<=n&&this._keys.splice(o,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return xe.Lerp(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,r,n){return xe.Hermite(e,t,i,r,n)}quaternionInterpolateFunction(e,t,i){return q.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,r,n){return q.Hermite(e,t,i,r,n).normalize()}vector3InterpolateFunction(e,t,i){return p.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,r,n){return p.Hermite(e,t,i,r,n)}vector2InterpolateFunction(e,t,i){return j.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,r,n){return j.Hermite(e,t,i,r,n)}sizeInterpolateFunction(e,t,i){return yg.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return X.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,r,n){return X.Hermite(e,t,i,r,n)}color4InterpolateFunction(e,t,i){return oe.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,r,n){return oe.Hermite(e,t,i,r,n)}_getKeyValue(e){return typeof e=="function"?e():e}evaluate(e){return xo.key=0,this._interpolate(e,xo)}_interpolate(e,t,i=!1){if(t.loopMode===s.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;let r=this._keys,n=r.length,o=t.key;for(;o>=0&&e<r[o].frame;)--o;for(;o+1<=n-1&&e>=r[o+1].frame;)++o;if(t.key=o,o<0)return i?void 0:this._getKeyValue(r[0].value);if(o+1>n-1)return i?void 0:this._getKeyValue(r[n-1].value);let a=r[o],l=r[o+1];if(i&&(e===a.frame||e===l.frame))return;let c=this._getKeyValue(a.value),h=this._getKeyValue(l.value);if(a.interpolation===kp.STEP)return l.frame>e?c:h;let u=a.outTangent!==void 0&&l.inTangent!==void 0,d=l.frame-a.frame,f=(e-a.frame)/d,m=a.easingFunction||this.getEasingFunction();switch(m!==null&&(f=m.ease(f)),this.dataType){case s.ANIMATIONTYPE_FLOAT:{let g=u?this.floatInterpolateFunctionWithTangents(c,a.outTangent*d,h,l.inTangent*d,f):this.floatInterpolateFunction(c,h,f);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return g;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(t.offsetValue??0)*t.repeatCount+g}break}case s.ANIMATIONTYPE_QUATERNION:{let g=u?this.quaternionInterpolateFunctionWithTangents(c,a.outTangent.scale(d),h,l.inTangent.scale(d),f):this.quaternionInterpolateFunction(c,h,f);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return g;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return g.addInPlace((t.offsetValue||rI).scale(t.repeatCount))}return g}case s.ANIMATIONTYPE_VECTOR3:{let g=u?this.vector3InterpolateFunctionWithTangents(c,a.outTangent.scale(d),h,l.inTangent.scale(d),f):this.vector3InterpolateFunction(c,h,f);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return g;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return g.add((t.offsetValue||sI).scale(t.repeatCount))}break}case s.ANIMATIONTYPE_VECTOR2:{let g=u?this.vector2InterpolateFunctionWithTangents(c,a.outTangent.scale(d),h,l.inTangent.scale(d),f):this.vector2InterpolateFunction(c,h,f);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return g;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return g.add((t.offsetValue||nI).scale(t.repeatCount))}break}case s.ANIMATIONTYPE_SIZE:{switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(c,h,f);case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(c,h,f).add((t.offsetValue||oI).scale(t.repeatCount))}break}case s.ANIMATIONTYPE_COLOR3:{let g=u?this.color3InterpolateFunctionWithTangents(c,a.outTangent.scale(d),h,l.inTangent.scale(d),f):this.color3InterpolateFunction(c,h,f);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return g;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return g.add((t.offsetValue||aI).scale(t.repeatCount))}break}case s.ANIMATIONTYPE_COLOR4:{let g=u?this.color4InterpolateFunctionWithTangents(c,a.outTangent.scale(d),h,l.inTangent.scale(d),f):this.color4InterpolateFunction(c,h,f);switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return g;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return g.add((t.offsetValue||lI).scale(t.repeatCount))}break}case s.ANIMATIONTYPE_MATRIX:{switch(t.loopMode){case s.ANIMATIONLOOPMODE_CYCLE:case s.ANIMATIONLOOPMODE_CONSTANT:case s.ANIMATIONLOOPMODE_YOYO:return s.AllowMatricesInterpolation?this.matrixInterpolateFunction(c,h,f,t.workValue):c;case s.ANIMATIONLOOPMODE_RELATIVE:case s.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return c}break}}return 0}matrixInterpolateFunction(e,t,i,r){return s.AllowMatrixDecomposeForInterpolation?r?(N.DecomposeLerpToRef(e,t,i,r),r):N.DecomposeLerp(e,t,i):r?(N.LerpToRef(e,t,i,r),r):N.Lerp(e,t,i)}clone(){let e=new s(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(let t in this._ranges){let i=this._ranges[t];i&&(e._ranges[t]=i.clone())}}return e}setKeys(e,t=!1){this._keys=t?e:e.slice(0)}createKeyForFrame(e){xo.key=0;let t=this._interpolate(e,xo,!0);if(!t)return this._keys[xo.key].frame===e?xo.key:xo.key+1;let i={frame:e,value:t.clone?t.clone():t};return this._keys.splice(xo.key+1,0,i),xo.key+1}serialize(){let e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;let t=this.dataType;e.keys=[];let i=this.getKeys();for(let r=0;r<i.length;r++){let n=i[r],o={};switch(o.frame=n.frame,t){case s.ANIMATIONTYPE_FLOAT:o.values=[n.value],n.inTangent!==void 0&&o.values.push(n.inTangent),n.outTangent!==void 0&&(n.inTangent===void 0&&o.values.push(void 0),o.values.push(n.outTangent)),n.interpolation!==void 0&&(n.inTangent===void 0&&o.values.push(void 0),n.outTangent===void 0&&o.values.push(void 0),o.values.push(n.interpolation));break;case s.ANIMATIONTYPE_QUATERNION:case s.ANIMATIONTYPE_MATRIX:case s.ANIMATIONTYPE_VECTOR3:case s.ANIMATIONTYPE_COLOR3:case s.ANIMATIONTYPE_COLOR4:o.values=n.value.asArray(),n.inTangent!=null&&o.values.push(n.inTangent.asArray()),n.outTangent!=null&&(n.inTangent===void 0&&o.values.push(void 0),o.values.push(n.outTangent.asArray())),n.interpolation!==void 0&&(n.inTangent===void 0&&o.values.push(void 0),n.outTangent===void 0&&o.values.push(void 0),o.values.push(n.interpolation));break}e.keys.push(o)}e.ranges=[];for(let r in this._ranges){let n=this._ranges[r];if(!n)continue;let o={};o.name=r,o.from=n.from,o.to=n.to,e.ranges.push(o)}return e}static _UniversalLerp(e,t,i){let r=e.constructor;return r.Lerp?r.Lerp(e,t,i):r.Slerp?r.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){let t=new s(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,r=[],n,o;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),o=0;o<e.keys.length;o++){let a=e.keys[o],l,c,h;switch(i){case s.ANIMATIONTYPE_FLOAT:n=a.values[0],a.values.length>=2&&(l=a.values[1]),a.values.length>=3&&(c=a.values[2]),a.values.length>=4&&(h=a.values[3]);break;case s.ANIMATIONTYPE_QUATERNION:if(n=q.FromArray(a.values),a.values.length>=8){let d=q.FromArray(a.values.slice(4,8));d.equals(q.Zero())||(l=d)}if(a.values.length>=12){let d=q.FromArray(a.values.slice(8,12));d.equals(q.Zero())||(c=d)}a.values.length>=13&&(h=a.values[12]);break;case s.ANIMATIONTYPE_MATRIX:n=N.FromArray(a.values),a.values.length>=17&&(h=a.values[16]);break;case s.ANIMATIONTYPE_COLOR3:n=X.FromArray(a.values),a.values[3]&&(l=X.FromArray(a.values[3])),a.values[4]&&(c=X.FromArray(a.values[4])),a.values[5]&&(h=a.values[5]);break;case s.ANIMATIONTYPE_COLOR4:n=oe.FromArray(a.values),a.values[4]&&(l=oe.FromArray(a.values[4])),a.values[5]&&(c=oe.FromArray(a.values[5])),a.values[6]&&(h=oe.FromArray(a.values[6]));break;case s.ANIMATIONTYPE_VECTOR3:default:n=p.FromArray(a.values),a.values[3]&&(l=p.FromArray(a.values[3])),a.values[4]&&(c=p.FromArray(a.values[4])),a.values[5]&&(h=a.values[5]);break}let u={};u.frame=a.frame,u.value=n,l!=null&&(u.inTangent=l),c!=null&&(u.outTangent=c),h!=null&&(u.interpolation=h),r.push(u)}if(t.setKeys(r),e.ranges)for(o=0;o<e.ranges.length;o++)n=e.ranges[o],t.createRange(n.name,n.from,n.to);return t}static AppendSerializedAnimations(e,t){ae.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((i,r)=>{let n=new gr;n.addEventListener("readystatechange",()=>{if(n.readyState==4)if(n.status==200){let o=JSON.parse(n.responseText);if(o.animations&&(o=o.animations),o.length){let a=[];for(let l of o)a.push(this.Parse(l));i(a)}else{let a=this.Parse(o);e&&(a.name=e),i(a)}}else r("Unable to load the animation")}),n.open("GET",t),n.send()})}static ParseFromSnippetAsync(e){return new Promise((t,i)=>{let r=new gr;r.addEventListener("readystatechange",()=>{if(r.readyState==4)if(r.status==200){let n=JSON.parse(JSON.parse(r.responseText).jsonPayload);if(n.animations){let o=JSON.parse(n.animations),a=[];for(let l of o.animations){let c=this.Parse(l);c.snippetId=e,a.push(c)}t(a)}else{let o=JSON.parse(n.animation),a=this.Parse(o);a.snippetId=e,t(a)}}else i("Unable to load the snippet "+e)}),r.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),r.send()})}};te._UniqueIdGenerator=0;te.AllowMatricesInterpolation=!1;te.AllowMatrixDecomposeForInterpolation=!0;te.SnippetUrl="https://snippet.babylonjs.com";te.ANIMATIONTYPE_FLOAT=0;te.ANIMATIONTYPE_VECTOR3=1;te.ANIMATIONTYPE_QUATERNION=2;te.ANIMATIONTYPE_MATRIX=3;te.ANIMATIONTYPE_COLOR3=4;te.ANIMATIONTYPE_COLOR4=7;te.ANIMATIONTYPE_VECTOR2=5;te.ANIMATIONTYPE_SIZE=6;te.ANIMATIONLOOPMODE_RELATIVE=0;te.ANIMATIONLOOPMODE_CYCLE=1;te.ANIMATIONLOOPMODE_CONSTANT=2;te.ANIMATIONLOOPMODE_YOYO=4;te.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5;te.CreateFromSnippetAsync=te.ParseFromSnippetAsync;P("BABYLON.Animation",te);Xe._AnimationRangeFactory=(s,e,t)=>new Ll(s,e,t);var cI=class extends jt{constructor(e,t,i,r,n=1e3,o,a,l){super(e,o),this.duration=1e3,this.onInterpolationDoneObservable=new U,this.propertyPath=i,this.value=r,this.duration=n,this.stopOtherAnimations=a,this.onInterpolationDone=l,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){let e=this._actionManager.getScene(),t=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}],i;if(typeof this.value=="number")i=te.ANIMATIONTYPE_FLOAT;else if(this.value instanceof X)i=te.ANIMATIONTYPE_COLOR3;else if(this.value instanceof p)i=te.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof N)i=te.ANIMATIONTYPE_MATRIX;else if(this.value instanceof q)i=te.ANIMATIONTYPE_QUATERNION;else{F.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");return}let r=new te("InterpolateValueAction",this._property,100*(1e3/this.duration),i,te.ANIMATIONLOOPMODE_CONSTANT);r.setKeys(t),this.stopOtherAnimations&&e.stopAnimation(this._effectiveTarget);let n=()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()};e.beginDirectAnimation(this._effectiveTarget,[r],0,100,!1,1,n)}serialize(e){return super._serialize({name:"InterpolateValueAction",properties:[jt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:jt._SerializeValueAsString(this.value)},{name:"duration",value:jt._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:jt._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)}};P("BABYLON.InterpolateValueAction",cI);var px=class{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,r){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=r,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===te.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=N.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){let o={frame:0,value:this._minValue};this._keys.splice(0,0,o)}if(this._target instanceof Array){let o=0;for(let a of this._target)this._preparePath(a,o),this._getOriginalValues(o),o++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];let n=t.getEvents();n&&n.length>0&&n.forEach(o=>{this._events.push(o._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){let i=this._animation.targetPropertyPath;if(i.length>1){let r=e;for(let n=0;n<i.length-1;n++){let o=i[n];if(r=r[o],r===void 0)throw new Error(`Invalid property (${o}) in property path (${i.join(".")})`)}this._targetPath=i[i.length-1],this._activeTargets[t]=r}else this._targetPath=i[0],this._activeTargets[t]=e;if(this._activeTargets[t][this._targetPath]===void 0)throw new Error(`Invalid property (${this._targetPath}) in property path (${i.join(".")})`)}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(let i of this._target)this._originalValue[t]!==void 0&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){let e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){let r=this._target[i];this._setValue(r,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t,i=this._activeTargets[e];i.getLocalMatrix&&this._targetPath==="_matrix"?t=i.getLocalMatrix():t=i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_setValue(e,t,i,r,n){if(this._currentActiveTarget=t,this._weight=r,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){let a=t[this._targetPath];a.clone?this._originalBlendValue=a.clone():this._originalBlendValue=a}this._originalBlendValue.m?te.AllowMatrixDecomposeForInterpolation?this._currentValue?N.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=N.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?N.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=N.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=te._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);let o=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=o}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i?.clone?this._currentValue=i.clone():this._currentValue=i;r!==-1?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[n]):this._animationState.loopMode===te.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[n],t[this._targetPath]):t[this._targetPath]=this._originalValue[n]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e,t=-1){let i=this._animation.getKeys();e<i[0].frame?e=i[0].frame:e>i[i.length-1].frame&&(e=i[i.length-1].frame);let r=this._events;if(r.length)for(let o=0;o<r.length;o++)r[o].onlyOnce||(r[o].isDone=r[o].frame<e);this._currentFrame=e;let n=this._animation._interpolate(e,this._animationState);this.setValue(n,t)}_prepareForSpeedRatioChange(e){let t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,r,n,o=-1){let a=this._animation,l=a.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let c=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);let h=i-t,u,d=e*(a.framePerSecond*n)/1e3+this._absoluteFrameOffset,f=0,m=!1,g=r&&this._animationState.loopMode===te.ANIMATIONLOOPMODE_YOYO;if(g){let C=(d-t)/h,R=Math.sin(C*Math.PI);d=Math.abs(R)*h+t;let S=R>=0?1:-1;this._yoyoDirection!==S&&(m=!0),this._yoyoDirection=S}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=d,!r&&i>=t&&(d>=h&&n>0||d<=0&&n<0))c=!1,f=a._getKeyValue(this._maxValue);else if(!r&&t>=i&&(d<=h&&n<0||d>=0&&n>0))c=!1,f=a._getKeyValue(this._minValue);else if(this._animationState.loopMode!==te.ANIMATIONLOOPMODE_CYCLE){let C=i.toString()+t.toString();if(!this._offsetsCache[C]){this._animationState.repeatCount=0,this._animationState.loopMode=te.ANIMATIONLOOPMODE_CYCLE;let R=a._interpolate(t,this._animationState),E=a._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),a.dataType){case te.ANIMATIONTYPE_FLOAT:this._offsetsCache[C]=E-R;break;case te.ANIMATIONTYPE_QUATERNION:this._offsetsCache[C]=E.subtract(R);break;case te.ANIMATIONTYPE_VECTOR3:this._offsetsCache[C]=E.subtract(R);break;case te.ANIMATIONTYPE_VECTOR2:this._offsetsCache[C]=E.subtract(R);break;case te.ANIMATIONTYPE_SIZE:this._offsetsCache[C]=E.subtract(R);break;case te.ANIMATIONTYPE_COLOR3:this._offsetsCache[C]=E.subtract(R);break;default:break}this._highLimitsCache[C]=E}f=this._highLimitsCache[C],u=this._offsetsCache[C]}if(u===void 0)switch(a.dataType){case te.ANIMATIONTYPE_FLOAT:u=0;break;case te.ANIMATIONTYPE_QUATERNION:u=rI;break;case te.ANIMATIONTYPE_VECTOR3:u=sI;break;case te.ANIMATIONTYPE_VECTOR2:u=nI;break;case te.ANIMATIONTYPE_SIZE:u=oI;break;case te.ANIMATIONTYPE_COLOR3:u=aI;break;case te.ANIMATIONTYPE_COLOR4:u=lI;break}let _;if(this._host&&this._host.syncRoot){let C=this._host.syncRoot,R=(C.masterFrame-C.fromFrame)/(C.toFrame-C.fromFrame);_=t+h*R}else d>0&&t>i||d<0&&t<i?_=c&&h!==0?i+d%h:t:_=c&&h!==0?t+d%h:i;let x=this._events;if(!g&&(n>0&&this.currentFrame>_||n<0&&this.currentFrame<_)||g&&m){this._onLoop();for(let C=0;C<x.length;C++)x[C].onlyOnce||(x[C].isDone=!1);this._animationState.key=n>0?0:a.getKeys().length-1}this._currentFrame=_,this._animationState.repeatCount=h===0?0:d/h>>0,this._animationState.highLimitValue=f,this._animationState.offsetValue=u;let b=a._interpolate(_,this._animationState);if(this.setValue(b,o),x.length){for(let C=0;C<x.length;C++)if(h>=0&&_>=x[C].frame&&x[C].frame>=t||h<0&&_<=x[C].frame&&x[C].frame<=t){let R=x[C];R.isDone||(R.onlyOnce&&(x.splice(C,1),C--),R.isDone=!0,R.action(_))}}return c||(this._stopped=!0),c}};var _i=(()=>{class s{constructor(t){this.length=0,this.data=new Array(t),this._id=s._GlobalId++}push(t){this.data[this.length++]=t,this.length>this.data.length&&(this.data.length*=2)}forEach(t){for(let i=0;i<this.length;i++)t(this.data[i])}sort(t){this.data.sort(t)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(t){if(t.length!==0){this.length+t.length>this.data.length&&(this.data.length=(this.length+t.length)*2);for(let i=0;i<t.length;i++)this.data[this.length++]=(t.data||t)[i]}}indexOf(t){let i=this.data.indexOf(t);return i>=this.length?-1:i}contains(t){return this.indexOf(t)!==-1}}return s._GlobalId=0,s})(),fn=class extends _i{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++){let i=(e.data||e)[t];this.pushNoDuplicate(i)}}}};var Wc=class{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((t,i)=>this.add(t,i))}get(e){let t=this._data[e];if(t!==void 0)return t}getOrAddWithFactory(e,t){let i=this.get(e);return i!==void 0||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){let i=this.get(e);return i!==void 0?i:(this.add(e,t),t)}contains(e){return this._data[e]!==void 0}add(e,t){return this._data[e]!==void 0?!1:(this._data[e]=t,++this._count,!0)}set(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)}getAndRemove(e){let t=this.get(e);return t!==void 0?(delete this._data[e],--this._count,t):null}remove(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(let t in this._data){let i=this._data[t];e(t,i)}}first(e){for(let t in this._data){let i=this._data[t],r=e(t,i);if(r)return r}return null}};function mx(s){s.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}var Gr=class s{constructor(){this._dirty=!0,this._tempColor=new oe(0,0,0,0),this._globalCurve=new oe(0,0,0,0),this._highlightsCurve=new oe(0,0,0,0),this._midtonesCurve=new oe(0,0,0,0),this._shadowsCurve=new oe(0,0,0,0),this._positiveCurve=new oe(0,0,0,0),this._negativeCurve=new oe(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",r="vCameraColorCurveNeutral",n="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(r,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(n,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}_getColorGradingDataToRef(e,t,i,r,n){e!=null&&(e=s._Clamp(e,0,360),t=s._Clamp(t,-100,100),i=s._Clamp(i,-100,100),r=s._Clamp(r,-100,100),t=s._ApplyColorGradingSliderNonlinear(t),t*=.5,r=s._ApplyColorGradingSliderNonlinear(r),t<0&&(t*=-1,e=(e+180)%360),s._FromHSBToRef(e,t,50+.25*r,n),n.scaleToRef(2,n),n.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,r){let n=s._Clamp(e,0,360),o=s._Clamp(t/100,0,1),a=s._Clamp(i/100,0,1);if(o===0)r.r=a,r.g=a,r.b=a;else{n/=60;let l=Math.floor(n),c=n-l,h=a*(1-o),u=a*(1-o*c),d=a*(1-o*(1-c));switch(l){case 0:r.r=a,r.g=d,r.b=h;break;case 1:r.r=u,r.g=a,r.b=h;break;case 2:r.r=h,r.g=a,r.b=d;break;case 3:r.r=h,r.g=u,r.b=a;break;case 4:r.r=d,r.g=h,r.b=a;break;default:r.r=a,r.g=h,r.b=u;break}}r.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return ae.Clone(()=>new s,this)}serialize(){return ae.Serialize(this)}static Parse(e){return ae.Parse(()=>new s,e,null,null)}};Gr.PrepareUniforms=mx;v([I()],Gr.prototype,"_globalHue",void 0);v([I()],Gr.prototype,"_globalDensity",void 0);v([I()],Gr.prototype,"_globalSaturation",void 0);v([I()],Gr.prototype,"_globalExposure",void 0);v([I()],Gr.prototype,"_highlightsHue",void 0);v([I()],Gr.prototype,"_highlightsDensity",void 0);v([I()],Gr.prototype,"_highlightsSaturation",void 0);v([I()],Gr.prototype,"_highlightsExposure",void 0);v([I()],Gr.prototype,"_midtonesHue",void 0);v([I()],Gr.prototype,"_midtonesDensity",void 0);v([I()],Gr.prototype,"_midtonesSaturation",void 0);v([I()],Gr.prototype,"_midtonesExposure",void 0);ae._ColorCurvesParser=Gr.Parse;function gx(s,e){e.EXPOSURE&&s.push("exposureLinear"),e.CONTRAST&&s.push("contrast"),e.COLORGRADING&&s.push("colorTransformSettings"),(e.VIGNETTE||e.DITHER)&&s.push("vInverseScreenSize"),e.VIGNETTE&&(s.push("vignetteSettings1"),s.push("vignetteSettings2")),e.COLORCURVES&&mx(s),e.DITHER&&s.push("ditherIntensity")}function _x(s,e){e.COLORGRADING&&s.push("txColorTransform")}var rt=class s{constructor(){this.colorCurves=new Gr,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=s.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new oe(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=s.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new U}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=0,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}if(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===s._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,!this._toneMappingEnabled)e.TONEMAPPING=0;else switch(this._toneMappingType){case s.TONEMAPPING_KHR_PBR_NEUTRAL:e.TONEMAPPING=3;break;case s.TONEMAPPING_ACES:e.TONEMAPPING=2;break;default:e.TONEMAPPING=1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||!!e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&Gr.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){let i=1/e.getEngine().getRenderWidth(),r=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,r),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){let n=t??r/i,o=Math.tan(this.vignetteCameraFov*.5),a=o*n,l=Math.sqrt(a*o);a=WS(a,l,this.vignetteStretch),o=WS(o,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",a,o,-a*this.vignetteCenterX,-o*this.vignetteCenterY);let c=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,c)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);let i=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return ae.Clone(()=>new s,this)}serialize(){return ae.Serialize(this)}static Parse(e){let t=ae.Parse(()=>new s,e,null,null);return e.vignetteCentreX!==void 0&&(t.vignetteCenterX=e.vignetteCentreX),e.vignetteCentreY!==void 0&&(t.vignetteCenterY=e.vignetteCentreY),t}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}};rt.TONEMAPPING_STANDARD=0;rt.TONEMAPPING_ACES=1;rt.TONEMAPPING_KHR_PBR_NEUTRAL=2;rt.PrepareUniforms=gx;rt.PrepareSamplers=_x;rt._VIGNETTEMODE_MULTIPLY=0;rt._VIGNETTEMODE_OPAQUE=1;v([EO()],rt.prototype,"colorCurves",void 0);v([I()],rt.prototype,"_colorCurvesEnabled",void 0);v([Qe("colorGradingTexture")],rt.prototype,"_colorGradingTexture",void 0);v([I()],rt.prototype,"_colorGradingEnabled",void 0);v([I()],rt.prototype,"_colorGradingWithGreenDepth",void 0);v([I()],rt.prototype,"_colorGradingBGR",void 0);v([I()],rt.prototype,"_exposure",void 0);v([I()],rt.prototype,"_toneMappingEnabled",void 0);v([I()],rt.prototype,"_toneMappingType",void 0);v([I()],rt.prototype,"_contrast",void 0);v([I()],rt.prototype,"vignetteStretch",void 0);v([I()],rt.prototype,"vignetteCenterX",void 0);v([I()],rt.prototype,"vignetteCenterY",void 0);v([I()],rt.prototype,"vignetteWeight",void 0);v([_u()],rt.prototype,"vignetteColor",void 0);v([I()],rt.prototype,"vignetteCameraFov",void 0);v([I()],rt.prototype,"_vignetteBlendMode",void 0);v([I()],rt.prototype,"_vignetteEnabled",void 0);v([I()],rt.prototype,"_ditheringEnabled",void 0);v([I()],rt.prototype,"_ditheringIntensity",void 0);v([I()],rt.prototype,"_skipFinalColorClamp",void 0);v([I()],rt.prototype,"_applyByPostProcess",void 0);v([I()],rt.prototype,"_isEnabled",void 0);ae._ImageProcessingConfigurationParser=rt.Parse;P("BABYLON.ImageProcessingConfiguration",rt);var oi=class{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(y.NormalKind))return null;let i=this.pickedMesh.getIndices();i?.length===0&&(i=null);let r,n=O.Vector3[0],o=O.Vector3[1],a=O.Vector3[2];if(t){let c=this.pickedMesh.getVerticesData(y.NormalKind),h=i?p.FromArrayToRef(c,i[this.faceId*3]*3,n):n.copyFromFloats(c[this.faceId*3*3],c[this.faceId*3*3+1],c[this.faceId*3*3+2]),u=i?p.FromArrayToRef(c,i[this.faceId*3+1]*3,o):o.copyFromFloats(c[(this.faceId*3+1)*3],c[(this.faceId*3+1)*3+1],c[(this.faceId*3+1)*3+2]),d=i?p.FromArrayToRef(c,i[this.faceId*3+2]*3,a):a.copyFromFloats(c[(this.faceId*3+2)*3],c[(this.faceId*3+2)*3+1],c[(this.faceId*3+2)*3+2]);h=h.scale(this.bu),u=u.scale(this.bv),d=d.scale(1-this.bu-this.bv),r=new p(h.x+u.x+d.x,h.y+u.y+d.y,h.z+u.z+d.z)}else{let c=this.pickedMesh.getVerticesData(y.PositionKind),h=i?p.FromArrayToRef(c,i[this.faceId*3]*3,n):n.copyFromFloats(c[this.faceId*3*3],c[this.faceId*3*3+1],c[this.faceId*3*3+2]),u=i?p.FromArrayToRef(c,i[this.faceId*3+1]*3,o):o.copyFromFloats(c[(this.faceId*3+1)*3],c[(this.faceId*3+1)*3+1],c[(this.faceId*3+1)*3+2]),d=i?p.FromArrayToRef(c,i[this.faceId*3+2]*3,a):a.copyFromFloats(c[(this.faceId*3+2)*3],c[(this.faceId*3+2)*3+1],c[(this.faceId*3+2)*3+2]),f=h.subtract(u),m=d.subtract(u);r=p.Cross(f,m)}let l=(c,h)=>{let u=c.getWorldMatrix();c.nonUniformScaling&&(O.Matrix[0].copyFrom(u),u=O.Matrix[0],u.setTranslationFromFloats(0,0,0),u.invert(),u.transposeToRef(O.Matrix[1]),u=O.Matrix[1]),p.TransformNormalToRef(h,u,h)};if(e&&l(this.pickedMesh,r),this.ray){let c=O.Vector3[0].copyFrom(r);e||l(this.pickedMesh,c),p.Dot(c,this.ray.direction)>0&&r.negateInPlace()}return r.normalize(),r}getTextureCoordinates(e=y.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;let t=this.pickedMesh.getIndices();if(!t)return null;let i=this.pickedMesh.getVerticesData(e);if(!i)return null;let r=j.FromArray(i,t[this.faceId*3]*2),n=j.FromArray(i,t[this.faceId*3+1]*2),o=j.FromArray(i,t[this.faceId*3+2]*2);return r=r.scale(this.bu),n=n.scale(this.bv),o=o.scale(1-this.bu-this.bv),new j(r.x+n.x+o.x,r.y+n.y+o.y)}};var $a=class{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[y.PositionKind])return;let e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[y.PositionKind]=new y(this._scene.getEngine(),e,y.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){let e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){let e=this._vertexBuffers[y.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){let i=this._scene.activeCamera;return!i||(t=t||i._postProcesses.filter(r=>r!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(i,e,t!=null),!0)}directRender(e,t=null,i=!1,r=0,n=0,o=!1){let a=this._scene.getEngine();for(let l=0;l<e.length;l++){l<e.length-1?e[l+1].activate(this._scene.activeCamera,t?.texture):(t?a.bindFramebuffer(t,r,void 0,void 0,i,n):o||a.restoreDefaultFramebuffer(),a._debugInsertMarker?.(`post process ${e[l].name} output`));let c=e[l],h=c.apply();h&&(c.onBeforeRenderObservable.notifyObservers(h),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,h),a.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(h))}a.setDepthBuffer(!0),a.setDepthWrite(!0)}_finalizeFrame(e,t,i,r,n=!1){let o=this._scene.activeCamera;if(!o||(r=r||o._postProcesses.filter(l=>l!=null),r.length===0||!this._scene.postProcessesEnabled))return;let a=this._scene.getEngine();for(let l=0,c=r.length;l<c;l++){let h=r[l];if(l<c-1?h._outputTexture=r[l+1].activate(o,t?.texture):(t?(a.bindFramebuffer(t,i,void 0,void 0,n),h._outputTexture=t):(a.restoreDefaultFramebuffer(),h._outputTexture=null),a._debugInsertMarker?.(`post process ${r[l].name} output`)),e)break;let u=h.apply();u&&(h.onBeforeRenderObservable.notifyObservers(u),this._prepareBuffers(),a.bindBuffers(this._vertexBuffers,this._indexBuffer,u),a.drawElementsType(0,0,6),h.onAfterRenderObservable.notifyObservers(u))}a.setDepthBuffer(!0),a.setDepthWrite(!0),a.setAlphaMode(0)}dispose(){let e=this._vertexBuffers[y.PositionKind];e&&(e.dispose(),this._vertexBuffers[y.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}};var Gp=class s{set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=s.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=s.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=s.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,i=null,r=null,n=null){this.index=e,this._opaqueSubMeshes=new _i(256),this._transparentSubMeshes=new _i(256),this._alphaTestSubMeshes=new _i(256),this._depthOnlySubMeshes=new _i(256),this._particleSystems=new _i(256),this._spriteManagers=new _i(256),this._empty=!0,this._edgesRenderers=new fn(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=n}render(e,t,i,r){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}let n=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(n.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),n.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);let o=n.getStencilBuffer();if(n.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(n.setStencilBuffer(o),this._scene.useOrderIndependentTransparency){let a=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);a.length&&this._renderTransparent(a)}else this._renderTransparent(this._transparentSubMeshes);n.setAlphaMode(0)}if(n.setStencilBuffer(!1),this._edgesRenderers.length){for(let a=0;a<this._edgesRenderers.length;a++)this._edgesRenderers.data[a].render();n.setAlphaMode(0)}n.setStencilBuffer(o)}_renderOpaqueSorted(e){s._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){s._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){s._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,r){let n=0,o,a=i?i.globalPosition:s._ZeroVector;if(r)for(;n<e.length;n++)o=e.data[n],o._alphaIndex=o.getMesh().alphaIndex,o._distanceToCamera=p.Distance(o.getBoundingInfo().boundingSphere.centerWorld,a);let l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);let c=l[0].getMesh().getScene();for(n=0;n<l.length;n++)if(o=l[n],!(c._activeMeshesFrozenButKeepClipping&&!o.isInFrustum(c._frustumPlanes))){if(r){let h=o.getMaterial();if(h&&h.needDepthPrePass){let u=h.getScene().getEngine();u.setColorWrite(!1),u.setAlphaMode(0),o.render(!1),u.setColorWrite(!0)}}o.render(r)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:s.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){let i=e.getMesh(),r=t.getMesh();return i.material&&r.material?i.material.uniqueId-r.material.uniqueId:i.uniqueId-r.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),i===void 0&&(i=e.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t.isEnabled()&&t.isVisible&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;let t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){let r=this._particleSystems.data[i];if((t&&t.layerMask&r.layerMask)===0)continue;let n=r.emitter;(!n.position||!e||e.indexOf(n)!==-1)&&this._scene._activeParticles.addCount(r.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;let e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){let i=this._spriteManagers.data[t];(e&&e.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}};Gp._ZeroVector=p.Zero();var hI=class{},Hc=(()=>{class s{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(t){t!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=t,this._maintainStateBetweenFrames||this.restoreDispachedFlags())}restoreDispachedFlags(){for(let t of this._scene.meshes)if(t.subMeshes)for(let i of t.subMeshes)i._wasDispatched=!1;if(this._scene.spriteManagers)for(let t of this._scene.spriteManagers)t._wasDispatched=!1;for(let t of this._scene.particleSystems)t._wasDispatched=!1}constructor(t){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new hI,this._maintainStateBetweenFrames=!1,this._scene=t;for(let i=s.MIN_RENDERINGGROUPS;i<s.MAX_RENDERINGGROUPS;i++)this._autoClearDepthStencil[i]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(t){let i=t||0;return this._prepareRenderingGroup(i),this._renderingGroups[i]}_clearDepthStencilBuffer(t=!0,i=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,t,i),this._depthStencilBufferAlreadyCleaned=!0)}render(t,i,r,n){let o=this._renderingGroupInfo;if(o.scene=this._scene,o.camera=this._scene.activeCamera,this._scene.spriteManagers&&n)for(let a=0;a<this._scene.spriteManagers.length;a++){let l=this._scene.spriteManagers[a];this.dispatchSprites(l)}for(let a=s.MIN_RENDERINGGROUPS;a<s.MAX_RENDERINGGROUPS;a++){this._depthStencilBufferAlreadyCleaned=a===s.MIN_RENDERINGGROUPS;let l=this._renderingGroups[a];if(!l||l._empty)continue;let c=1<<a;if(o.renderingGroupId=a,this._scene.onBeforeRenderingGroupObservable.notifyObservers(o,c),s.AUTOCLEAR){let h=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(a):this._autoClearDepthStencil[a];h&&h.autoClear&&this._clearDepthStencilBuffer(h.depth,h.stencil)}for(let h of this._scene._beforeRenderingGroupDrawStage)h.action(a);l.render(t,n,r,i);for(let h of this._scene._afterRenderingGroupDrawStage)h.action(a);this._scene.onAfterRenderingGroupObservable.notifyObservers(o,c)}}reset(){if(!this.maintainStateBetweenFrames)for(let t=s.MIN_RENDERINGGROUPS;t<s.MAX_RENDERINGGROUPS;t++){let i=this._renderingGroups[t];i&&i.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let t=s.MIN_RENDERINGGROUPS;t<s.MAX_RENDERINGGROUPS;t++){let i=this._renderingGroups[t];i&&i.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let t=s.MIN_RENDERINGGROUPS;t<s.MAX_RENDERINGGROUPS;t++){let i=this._renderingGroups[t];i&&i.dispose()}}_prepareRenderingGroup(t){this._renderingGroups[t]===void 0&&(this._renderingGroups[t]=new Gp(t,this._scene,this._customOpaqueSortCompareFn[t],this._customAlphaTestSortCompareFn[t],this._customTransparentSortCompareFn[t]))}dispatchSprites(t){this.maintainStateBetweenFrames&&t._wasDispatched||(t._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatchSprites(t))}dispatchParticles(t){this.maintainStateBetweenFrames&&t._wasDispatched||(t._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatchParticles(t))}dispatch(t,i,r){i===void 0&&(i=t.getMesh()),!(this.maintainStateBetweenFrames&&t._wasDispatched)&&(t._wasDispatched=!0,this.getRenderingGroup(i.renderingGroupId).dispatch(t,i,r))}setRenderingOrder(t,i=null,r=null,n=null){if(this._customOpaqueSortCompareFn[t]=i,this._customAlphaTestSortCompareFn[t]=r,this._customTransparentSortCompareFn[t]=n,this._renderingGroups[t]){let o=this._renderingGroups[t];o.opaqueSortCompareFn=this._customOpaqueSortCompareFn[t],o.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[t],o.transparentSortCompareFn=this._customTransparentSortCompareFn[t]}}setRenderingAutoClearDepthStencil(t,i,r=!0,n=!0){this._autoClearDepthStencil[t]={autoClear:i,depth:r,stencil:n}}getAutoClearDepthStencilSetup(t){return this._autoClearDepthStencil[t]}}return s.MAX_RENDERINGGROUPS=4,s.MIN_RENDERINGGROUPS=0,s.AUTOCLEAR=!0,s})();var ye=(()=>{class s{}return s.NAME_EFFECTLAYER="EffectLayer",s.NAME_LAYER="Layer",s.NAME_LENSFLARESYSTEM="LensFlareSystem",s.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer",s.NAME_PARTICLESYSTEM="ParticleSystem",s.NAME_GAMEPAD="Gamepad",s.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue",s.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer",s.NAME_PREPASSRENDERER="PrePassRenderer",s.NAME_DEPTHRENDERER="DepthRenderer",s.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer",s.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager",s.NAME_SPRITE="Sprite",s.NAME_SUBSURFACE="SubSurface",s.NAME_OUTLINERENDERER="Outline",s.NAME_PROCEDURALTEXTURE="ProceduralTexture",s.NAME_SHADOWGENERATOR="ShadowGenerator",s.NAME_OCTREE="Octree",s.NAME_PHYSICSENGINE="PhysicsEngine",s.NAME_AUDIO="Audio",s.NAME_FLUIDRENDERER="FluidRenderer",s.STEP_ISREADYFORMESH_EFFECTLAYER=0,s.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,s.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,s.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,s.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,s.STEP_BEFORECAMERADRAW_PREPASS=0,s.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,s.STEP_BEFORECAMERADRAW_LAYER=2,s.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,s.STEP_BEFORERENDERTARGETDRAW_LAYER=1,s.STEP_BEFORERENDERINGMESH_PREPASS=0,s.STEP_BEFORERENDERINGMESH_OUTLINE=1,s.STEP_AFTERRENDERINGMESH_PREPASS=0,s.STEP_AFTERRENDERINGMESH_OUTLINE=1,s.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,s.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,s.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,s.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,s.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,s.STEP_BEFORECLEAR_PREPASS=1,s.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,s.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,s.STEP_AFTERRENDERTARGETDRAW_LAYER=1,s.STEP_AFTERCAMERADRAW_PREPASS=0,s.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,s.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,s.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,s.STEP_AFTERCAMERADRAW_LAYER=4,s.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,s.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,s.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,s.STEP_AFTERRENDER_AUDIO=0,s.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,s.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,s.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,s.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,s.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,s.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,s.STEP_POINTERMOVE_SPRITE=0,s.STEP_POINTERDOWN_SPRITE=0,s.STEP_POINTERUP_SPRITE=0,s})(),zi=class s extends Array{constructor(e){super(...e)}static Create(){return Object.create(s.prototype)}registerStep(e,t,i){let r=0,n=Number.MAX_VALUE;for(;r<this.length&&(n=this[r].index,!(e<n));r++);this.splice(r,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}};var Ae=(()=>{class s{}return s.POINTERDOWN=1,s.POINTERUP=2,s.POINTERMOVE=4,s.POINTERWHEEL=8,s.POINTERPICK=16,s.POINTERTAP=32,s.POINTERDOUBLETAP=64,s})(),xx=class{constructor(e,t){this.type=e,this.event=t}},vx=class extends xx{constructor(e,t,i,r){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new j(i,r)}},ds=class extends xx{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,i,r=null){super(e,t),this._pickInfo=i,this._inputManager=r}_generatePickInfo(){this._inputManager&&(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),this._inputManager=null)}};var vo=(()=>{class s{}return s.KEYDOWN=1,s.KEYUP=2,s})(),nd=class{constructor(e,t){this.type=e,this.event=t}},zp=class extends nd{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}};var Le=function(s){return s[s.Generic=0]="Generic",s[s.Keyboard=1]="Keyboard",s[s.Mouse=2]="Mouse",s[s.Touch=3]="Touch",s[s.DualShock=4]="DualShock",s[s.Xbox=5]="Xbox",s[s.Switch=6]="Switch",s[s.DualSense=7]="DualSense",s}(Le||{}),Ye=function(s){return s[s.Horizontal=0]="Horizontal",s[s.Vertical=1]="Vertical",s[s.LeftClick=2]="LeftClick",s[s.MiddleClick=3]="MiddleClick",s[s.RightClick=4]="RightClick",s[s.BrowserBack=5]="BrowserBack",s[s.BrowserForward=6]="BrowserForward",s[s.MouseWheelX=7]="MouseWheelX",s[s.MouseWheelY=8]="MouseWheelY",s[s.MouseWheelZ=9]="MouseWheelZ",s[s.Move=12]="Move",s}(Ye||{}),Tx=function(s){return s[s.Horizontal=0]="Horizontal",s[s.Vertical=1]="Vertical",s[s.LeftClick=2]="LeftClick",s[s.MiddleClick=3]="MiddleClick",s[s.RightClick=4]="RightClick",s[s.BrowserBack=5]="BrowserBack",s[s.BrowserForward=6]="BrowserForward",s[s.MouseWheelX=7]="MouseWheelX",s[s.MouseWheelY=8]="MouseWheelY",s[s.MouseWheelZ=9]="MouseWheelZ",s[s.DeltaHorizontal=10]="DeltaHorizontal",s[s.DeltaVertical=11]="DeltaVertical",s}(Tx||{});var od=(()=>{class s{}return s.DOM_DELTA_PIXEL=0,s.DOM_DELTA_LINE=1,s.DOM_DELTA_PAGE=2,s})();var To=class{static CreateDeviceEvent(e,t,i,r,n,o,a){switch(e){case Le.Keyboard:return this._CreateKeyboardEvent(i,r,n,o);case Le.Mouse:if(i===Ye.MouseWheelX||i===Ye.MouseWheelY||i===Ye.MouseWheelZ)return this._CreateWheelEvent(e,t,i,r,n,o);case Le.Touch:return this._CreatePointerEvent(e,t,i,r,n,o,a);default:throw`Unable to generate event for device ${Le[e]}`}}static _CreatePointerEvent(e,t,i,r,n,o,a){let l=this._CreateMouseEvent(e,t,i,r,n,o);e===Le.Mouse?(l.deviceType=Le.Mouse,l.pointerId=1,l.pointerType="mouse"):(l.deviceType=Le.Touch,l.pointerId=a??t,l.pointerType="touch");let c=0;return c+=n.pollInput(e,t,Ye.LeftClick),c+=n.pollInput(e,t,Ye.RightClick)*2,c+=n.pollInput(e,t,Ye.MiddleClick)*4,l.buttons=c,i===Ye.Move?l.type="pointermove":i>=Ye.LeftClick&&i<=Ye.RightClick&&(l.type=r===1?"pointerdown":"pointerup",l.button=i-2),l}static _CreateWheelEvent(e,t,i,r,n,o){let a=this._CreateMouseEvent(e,t,i,r,n,o);switch(a.pointerId=1,a.type="wheel",a.deltaMode=od.DOM_DELTA_PIXEL,a.deltaX=0,a.deltaY=0,a.deltaZ=0,i){case Ye.MouseWheelX:a.deltaX=r;break;case Ye.MouseWheelY:a.deltaY=r;break;case Ye.MouseWheelZ:a.deltaZ=r;break}return a}static _CreateMouseEvent(e,t,i,r,n,o){let a=this._CreateEvent(o),l=n.pollInput(e,t,Ye.Horizontal),c=n.pollInput(e,t,Ye.Vertical);return o?(a.movementX=0,a.movementY=0,a.offsetX=a.movementX-o.getBoundingClientRect().x,a.offsetY=a.movementY-o.getBoundingClientRect().y):(a.movementX=n.pollInput(e,t,Tx.DeltaHorizontal),a.movementY=n.pollInput(e,t,Tx.DeltaVertical),a.offsetX=0,a.offsetY=0),this._CheckNonCharacterKeys(a,n),a.clientX=l,a.clientY=c,a.x=l,a.y=c,a.deviceType=e,a.deviceSlot=t,a.inputIndex=i,a}static _CreateKeyboardEvent(e,t,i,r){let n=this._CreateEvent(r);return this._CheckNonCharacterKeys(n,i),n.deviceType=Le.Keyboard,n.deviceSlot=0,n.inputIndex=e,n.type=t===1?"keydown":"keyup",n.key=String.fromCharCode(e),n.keyCode=e,n}static _CheckNonCharacterKeys(e,t){let i=t.isDeviceAvailable(Le.Keyboard),r=i&&t.pollInput(Le.Keyboard,0,18)===1,n=i&&t.pollInput(Le.Keyboard,0,17)===1,o=i&&(t.pollInput(Le.Keyboard,0,91)===1||t.pollInput(Le.Keyboard,0,92)===1||t.pollInput(Le.Keyboard,0,93)===1),a=i&&t.pollInput(Le.Keyboard,0,16)===1;e.altKey=r,e.ctrlKey=n,e.metaKey=o,e.shiftKey=a}static _CreateEvent(e){let t={};return t.preventDefault=()=>{},t.target=e,t}};var Cx=class{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(r,n,o,a)=>{let l=To.CreateDeviceEvent(r,n,o,a,this);i(r,n,l)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===Le.Mouse||e===Le.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}};var X1=255,Y1=Object.keys(Ye).length/2,bx=class{constructor(e,t,i,r){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=H.IsSafari(),this._usingMacOS=Bf()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=n=>{},this._keyboardUpEvent=n=>{},this._keyboardBlurEvent=n=>{},this._pointerMoveEvent=n=>{},this._pointerDownEvent=n=>{},this._pointerUpEvent=n=>{},this._pointerCancelEvent=n=>{},this._pointerWheelEvent=n=>{},this._pointerBlurEvent=n=>{},this._pointerMacOSChromeOutEvent=n=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Bf()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._isUsingChromium=Bf()&&navigator.userAgent&&navigator.userAgent.indexOf("Chrome")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=n=>{},this._gamepadDisconnectedEvent=n=>{},this._eventPrefix=H.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=r,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){let r=this._inputs[e][t];if(!r)throw`Unable to find device ${Le[e]}`;e>=Le.DualShock&&e<=Le.DualSense&&this._updateDevice(e,t,i);let n=r[i];if(n===void 0)throw`Unable to find input ${i} for device ${Le[e]} in slot ${t}`;return i===Ye.Move&&H.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),n}isDeviceAvailable(e){return this._inputs[e]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){let e=this?._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(let t of this._inputs)if(t)for(let i in t){let r=+i,n=t[r];if(n)for(let o=0;o<n.length;o++)n[o]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),this._usingMacOS&&this._isUsingChromium&&this._elementToAttachTo.removeEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){let e=navigator.getGamepads();for(let t of e)t&&this._addGamePad(t)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(Le.Mouse,0,0,0)}_addGamePad(e){let t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,r){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,Y1);let n=this._inputs[e][t];n[0]=i,n[1]=r}_registerDevice(e,t,i){if(t===void 0)throw`Unable to register device ${Le[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){let r=new Array(i);r.fill(0),this._inputs[e][t]=r,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Le.Keyboard,0,X1));let t=this._inputs[Le.Keyboard][0];if(t){t[e.keyCode]=1;let i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&e.key!=="Meta"&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(Le.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Le.Keyboard,0,X1));let t=this._inputs[Le.Keyboard][0];if(t){t[e.keyCode]=0;let i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&e.key==="Meta"&&this._metaKeys.length>0){for(let r of this._metaKeys){let n=To.CreateDeviceEvent(Le.Keyboard,0,r,0,this,this._elementToAttachTo);t[r]=0,this._onInputChanged(Le.Keyboard,0,n)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(Le.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){let e=this._inputs[Le.Keyboard][0];for(let t=0;t<e.length;t++)if(e[t]!==0){e[t]=0;let i=To.CreateDeviceEvent(Le.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Le.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=Bf()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{let r=this._getPointerType(i),n=r===Le.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(r===Le.Touch&&n===-1){let a=this._activeTouchIds.indexOf(-1);if(a>=0)n=a,this._activeTouchIds[a]=i.pointerId,this._onDeviceConnected(r,n);else{H.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[r]||(this._inputs[r]={}),this._inputs[r][n]||this._addPointerDevice(r,n,i.clientX,i.clientY);let o=this._inputs[r][n];if(o){let a=i;a.inputIndex=Ye.Move,o[Ye.Horizontal]=i.clientX,o[Ye.Vertical]=i.clientY,r===Le.Touch&&o[Ye.LeftClick]===0&&(o[Ye.LeftClick]=1),i.pointerId===void 0&&(i.pointerId=this._mouseId),this._onInputChanged(r,n,a),!this._usingSafari&&i.button!==-1&&(a.inputIndex=i.button+2,o[i.button+2]=o[i.button+2]?0:1,this._onInputChanged(r,n,a))}},this._pointerDownEvent=i=>{let r=this._getPointerType(i),n=r===Le.Mouse?0:i.pointerId;if(r===Le.Touch){let a=this._activeTouchIds.indexOf(i.pointerId);if(a===-1&&(a=this._activeTouchIds.indexOf(-1)),a>=0)n=a,this._activeTouchIds[a]=i.pointerId;else{H.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[r]||(this._inputs[r]={}),this._inputs[r][n]?r===Le.Touch&&this._onDeviceConnected(r,n):this._addPointerDevice(r,n,i.clientX,i.clientY);let o=this._inputs[r][n];if(o){let a=o[Ye.Horizontal],l=o[Ye.Vertical];if(r===Le.Mouse){if(i.pointerId===void 0&&(i.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch{}o[Ye.Horizontal]=i.clientX,o[Ye.Vertical]=i.clientY,o[i.button+2]=1;let c=i;c.inputIndex=i.button+2,this._onInputChanged(r,n,c),(a!==i.clientX||l!==i.clientY)&&(c.inputIndex=Ye.Move,this._onInputChanged(r,n,c))}},this._pointerUpEvent=i=>{let r=this._getPointerType(i),n=r===Le.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(r===Le.Touch){if(n===-1)return;this._activeTouchIds[n]=-1}let o=this._inputs[r]?.[n];if(o&&o[i.button+2]!==0){let a=o[Ye.Horizontal],l=o[Ye.Vertical];o[Ye.Horizontal]=i.clientX,o[Ye.Vertical]=i.clientY,o[i.button+2]=0;let c=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),(a!==i.clientX||l!==i.clientY)&&(c.inputIndex=Ye.Move,this._onInputChanged(r,n,c)),c.inputIndex=i.button+2,r===Le.Mouse&&this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&this._elementToAttachTo.hasPointerCapture?.(i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(r,n,c),r===Le.Touch&&this._onDeviceDisconnected(r,n)}},this._pointerCancelEvent=i=>{if(i.pointerType==="mouse"){let r=this._inputs[Le.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let n=Ye.LeftClick;n<=Ye.BrowserForward;n++)if(r[n]===1){r[n]=0;let o=To.CreateDeviceEvent(Le.Mouse,0,n,0,this,this._elementToAttachTo);this._onInputChanged(Le.Mouse,0,o)}}else{let r=this._activeTouchIds.indexOf(i.pointerId);if(r===-1)return;this._elementToAttachTo.hasPointerCapture?.(i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._inputs[Le.Touch][r][Ye.LeftClick]=0;let n=To.CreateDeviceEvent(Le.Touch,r,Ye.LeftClick,0,this,this._elementToAttachTo,i.pointerId);this._onInputChanged(Le.Touch,r,n),this._activeTouchIds[r]=-1,this._onDeviceDisconnected(Le.Touch,r)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";let e=!1,t=function(){};try{let i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch{}this._pointerBlurEvent=()=>{if(this.isDeviceAvailable(Le.Mouse)){let i=this._inputs[Le.Mouse][0];this._mouseId>=0&&this._elementToAttachTo.hasPointerCapture?.(this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let r=Ye.LeftClick;r<=Ye.BrowserForward;r++)if(i[r]===1){i[r]=0;let n=To.CreateDeviceEvent(Le.Mouse,0,r,0,this,this._elementToAttachTo);this._onInputChanged(Le.Mouse,0,n)}}if(this.isDeviceAvailable(Le.Touch)){let i=this._inputs[Le.Touch];for(let r=0;r<this._activeTouchIds.length;r++){let n=this._activeTouchIds[r];if(this._elementToAttachTo.hasPointerCapture?.(n)&&this._elementToAttachTo.releasePointerCapture(n),n!==-1&&i[r]?.[Ye.LeftClick]===1){i[r][Ye.LeftClick]=0;let o=To.CreateDeviceEvent(Le.Touch,r,Ye.LeftClick,0,this,this._elementToAttachTo,n);this._onInputChanged(Le.Touch,r,o),this._activeTouchIds[r]=-1,this._onDeviceDisconnected(Le.Touch,r)}}}},this._pointerWheelEvent=i=>{let r=Le.Mouse,n=0;this._inputs[r]||(this._inputs[r]=[]),this._inputs[r][n]||(this._pointerActive=!0,this._registerDevice(r,n,Y1));let o=this._inputs[r][n];if(o){o[Ye.MouseWheelX]=i.deltaX||0,o[Ye.MouseWheelY]=i.deltaY||i.wheelDelta||0,o[Ye.MouseWheelZ]=i.deltaZ||0;let a=i;i.pointerId===void 0&&(i.pointerId=this._mouseId),o[Ye.MouseWheelX]!==0&&(a.inputIndex=Ye.MouseWheelX,this._onInputChanged(r,n,a)),o[Ye.MouseWheelY]!==0&&(a.inputIndex=Ye.MouseWheelY,this._onInputChanged(r,n,a)),o[Ye.MouseWheelZ]!==0&&(a.inputIndex=Ye.MouseWheelZ,this._onInputChanged(r,n,a))}},this._usingMacOS&&this._isUsingChromium&&(this._pointerMacOSChromeOutEvent=i=>{i.buttons>1&&this._pointerCancelEvent(i)},this._elementToAttachTo.addEventListener("lostpointercapture",this._pointerMacOSChromeOutEvent)),this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,e?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(Le.Mouse)){let i=this._inputs[Le.Mouse][0];i[Ye.MouseWheelX]=0,i[Ye.MouseWheelY]=0,i[Ye.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){let t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){let r=navigator.getGamepads()[t];if(r&&e===this._gamepads[t]){let n=this._inputs[e][t];i>=r.buttons.length?n[i]=r.axes[i-r.buttons.length].valueOf():n[i]=r.buttons[i].value}}_getGamepadDeviceType(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?Le.DualSense:Le.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?Le.Xbox:e.indexOf("057e")!==-1?Le.Switch:Le.Generic}_getPointerType(e){let t=Le.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(t=Le.Touch),t}};var Wp=class{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new U,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}};var Sx=class{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=o=>{for(let a=0;a<this._devices.length;a++){let l=this._devices[a];for(let c in l){let h=+c;o._addDevice(new Wp(this._deviceInputSystem,a,h))}}this._registeredManagers.push(o)},this.unregisterManager=o=>{let a=this._registeredManagers.indexOf(o);a>-1&&this._registeredManagers.splice(a,1)};let t=Object.keys(Le).length/2;this._devices=new Array(t);let i=(o,a)=>{this._devices[o]||(this._devices[o]=new Array),this._devices[o][a]||(this._devices[o][a]=a);for(let l of this._registeredManagers){let c=new Wp(this._deviceInputSystem,o,a);l._addDevice(c)}},r=(o,a)=>{this._devices[o]?.[a]&&delete this._devices[o][a];for(let l of this._registeredManagers)l._removeDevice(o,a)},n=(o,a,l)=>{if(l)for(let c of this._registeredManagers)c._onInputChanged(o,a,l)};typeof _native<"u"?this._deviceInputSystem=new Cx(i,r,n):this._deviceInputSystem=new bx(e,i,r,n)}dispose(){this._deviceInputSystem.dispose()}};var yx=class{getDeviceSource(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(t=>!!t):[]}constructor(e){let t=Object.keys(Le).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new Sx(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new U(i=>{for(let r of this._devices)if(r)for(let n of r)n&&this.onDeviceConnectedObservable.notifyObserver(i,n)}),this.onDeviceDisconnectedObservable=new U,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){let i=this._devices[e]?.[t];this.onDeviceDisconnectedObservable.notifyObservers(i),this._devices[e]?.[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){this._devices[e]?.[t]?.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case Le.Keyboard:case Le.Mouse:this._firstDevice[e]=0;break;case Le.Touch:case Le.DualSense:case Le.DualShock:case Le.Xbox:case Le.Switch:case Le.Generic:{delete this._firstDevice[e];let t=this._devices[e];if(t){for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}break}}}};var Ex=class{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}},Jo=(()=>{class s{constructor(t){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new j(0,0),this._previousStartingPointerPosition=new j(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=t||me.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&(this._movePointerInfo._generatePickInfo(),this._movePointerInfo=null),this._pointerOverMesh}getMeshUnderPointerByPointerId(t){return this._meshUnderPointerId[t]||null}get unTranslatedPointer(){return new j(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(t){this._pointerX=t}get pointerY(){return this._pointerY}set pointerY(t){this._pointerY=t}_updatePointerPosition(t){let i=this._scene.getEngine().getInputElementClientRect();i&&(this._pointerX=t.clientX-i.left,this._pointerY=t.clientY-i.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(t,i){let r=this._scene,n=r.getEngine(),o=n.getInputElement();o&&(o.tabIndex=n.canvasTabIndex,r.doNotHandleCursors||(o.style.cursor=r.defaultCursor)),this._setCursorAndPointerOverMesh(t,i,r);for(let c of r._pointerMoveStage){t=t||this._pickMove(i);let h=!!t?.pickedMesh;t=c.action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,h,o)}let a=i.inputIndex>=Ye.MouseWheelX&&i.inputIndex<=Ye.MouseWheelZ?Ae.POINTERWHEEL:Ae.POINTERMOVE;r.onPointerMove&&(t=t||this._pickMove(i),r.onPointerMove(i,t,a));let l;t?(l=new ds(a,i,t),this._setRayOnPointerInfo(t,i)):(l=new ds(a,i,null,this),this._movePointerInfo=l),r.onPointerObservable.hasObservers()&&r.onPointerObservable.notifyObservers(l,a)}_setRayOnPointerInfo(t,i){let r=this._scene;t&&r._pickingAvailable&&(t.ray||(t.ray=r.createPickingRay(i.offsetX,i.offsetY,N.Identity(),r.activeCamera)))}_addCameraPointerObserver(t,i){return this._cameraObserverCount++,this._scene.onPointerObservable.add(t,i)}_removeCameraPointerObserver(t){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(t)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(t,i,r){let n=this._scene,o=new vx(r,i,this._unTranslatedPointerX,this._unTranslatedPointerY);return t&&(o.originalPickingInfo=t,o.ray=t.ray,i.pointerType==="xr-near"&&t.originMesh&&(o.nearInteractionPickingInfo=t)),n.onPrePointerObservable.notifyObservers(o,r),!!o.skipOnPointerObservable}_pickMove(t){let i=this._scene,r=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,i.pointerMovePredicate,i.pointerMoveFastCheck,i.cameraToUseForPointers,i.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(r,t,i),r}_setCursorAndPointerOverMesh(t,i,r){let o=r.getEngine().getInputElement();if(t?.pickedMesh){if(this.setPointerOverMesh(t.pickedMesh,i.pointerId,t,i),!r.doNotHandleCursors&&o&&this._pointerOverMesh){let a=this._pointerOverMesh._getActionManagerForTrigger();a&&a.hasPointerTriggers&&(o.style.cursor=a.hoverCursor||r.hoverCursor)}}else this.setPointerOverMesh(null,i.pointerId,t,i)}simulatePointerMove(t,i){let r=new PointerEvent("pointermove",i);r.inputIndex=Ye.Move,!this._checkPrePointerObservable(t,r,Ae.POINTERMOVE)&&this._processPointerMove(t,r)}simulatePointerDown(t,i){let r=new PointerEvent("pointerdown",i);r.inputIndex=r.button+2,!this._checkPrePointerObservable(t,r,Ae.POINTERDOWN)&&this._processPointerDown(t,r)}_processPointerDown(t,i){let r=this._scene;if(t?.pickedMesh){this._pickedDownMesh=t.pickedMesh;let a=t.pickedMesh._getActionManagerForTrigger();if(a){if(a.hasPickTriggers)switch(a.processTrigger(5,Ii.CreateNew(t.pickedMesh,i,t)),i.button){case 0:a.processTrigger(2,Ii.CreateNew(t.pickedMesh,i,t));break;case 1:a.processTrigger(4,Ii.CreateNew(t.pickedMesh,i,t));break;case 2:a.processTrigger(3,Ii.CreateNew(t.pickedMesh,i,t));break}a.hasSpecificTrigger(8)&&window.setTimeout(()=>{let l=r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,c=>c.isPickable&&c.isVisible&&c.isReady()&&c.actionManager&&c.actionManager.hasSpecificTrigger(8)&&c===this._pickedDownMesh,!1,r.cameraToUseForPointers);l?.pickedMesh&&a&&this._totalPointersPressed!==0&&Date.now()-this._startingPointerTime>s.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,a.processTrigger(8,Ii.CreateNew(l.pickedMesh,i)))},s.LongPressDelay)}}else for(let a of r._pointerDownStage)t=a.action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,i,!1);let n,o=Ae.POINTERDOWN;t?(r.onPointerDown&&r.onPointerDown(i,t,o),n=new ds(o,i,t),this._setRayOnPointerInfo(t,i)):n=new ds(o,i,null,this),r.onPointerObservable.hasObservers()&&r.onPointerObservable.notifyObservers(n,o)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(t,i,r){let n=new PointerEvent("pointerup",i);n.inputIndex=Ye.Move;let o=new Ex;r?o.doubleClick=!0:o.singleClick=!0,!this._checkPrePointerObservable(t,n,Ae.POINTERUP)&&this._processPointerUp(t,n,o)}_processPointerUp(t,i,r){let n=this._scene;if(t?.pickedMesh){if(this._pickedUpMesh=t.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(n.onPointerPick&&n.onPointerPick(i,t),r.singleClick&&!r.ignore&&n.onPointerObservable.observers.length>this._cameraObserverCount)){let a=Ae.POINTERPICK,l=new ds(a,i,t);this._setRayOnPointerInfo(t,i),n.onPointerObservable.notifyObservers(l,a)}let o=t.pickedMesh._getActionManagerForTrigger();if(o&&!r.ignore){o.processTrigger(7,Ii.CreateNew(t.pickedMesh,i,t)),!r.hasSwiped&&r.singleClick&&o.processTrigger(1,Ii.CreateNew(t.pickedMesh,i,t));let a=t.pickedMesh._getActionManagerForTrigger(6);r.doubleClick&&a&&a.processTrigger(6,Ii.CreateNew(t.pickedMesh,i,t))}}else if(!r.ignore)for(let o of n._pointerUpStage)t=o.action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,i,r.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){let o=this._pickedDownMesh._getActionManagerForTrigger(16);o&&o.processTrigger(16,Ii.CreateNew(this._pickedDownMesh,i))}if(!r.ignore){let o=new ds(Ae.POINTERUP,i,t);if(this._setRayOnPointerInfo(t,i),n.onPointerObservable.notifyObservers(o,Ae.POINTERUP),n.onPointerUp&&n.onPointerUp(i,t,Ae.POINTERUP),!r.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let a=0;if(r.singleClick?a=Ae.POINTERTAP:r.doubleClick&&(a=Ae.POINTERDOUBLETAP),a){let l=new ds(a,i,t);n.onPointerObservable.hasObservers()&&n.onPointerObservable.hasSpecificMask(a)&&n.onPointerObservable.notifyObservers(l,a)}}}}isPointerCaptured(t=0){return this._pointerCaptures[t]}attachControl(t=!0,i=!0,r=!0,n=null){let o=this._scene,a=o.getEngine();n||(n=a.getInputElement()),this._alreadyAttached&&this.detachControl(),n&&(this._alreadyAttachedTo=n),this._deviceSourceManager=new yx(a),this._initActionManager=l=>{if(!this._meshPickProceed){let c=o.skipPointerUpPicking||o._registeredActions===0&&!this._checkForPicking()&&!o.onPointerUp?null:o.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,o.pointerUpPredicate,o.pointerUpFastCheck,o.cameraToUseForPointers,o.pointerUpTrianglePredicate);this._currentPickResult=c,c&&(l=c.hit&&c.pickedMesh?c.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return l},this._delayedSimpleClick=(l,c,h)=>{if((Date.now()-this._previousStartingPointerTime>s.DoubleClickDelay&&!this._doubleClickOccured||l!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,c.singleClick=!0,c.ignore=!1,this._delayedClicks[l])){let u=this._delayedClicks[l].evt,d=Ae.POINTERTAP,f=new ds(d,u,this._currentPickResult);o.onPointerObservable.hasObservers()&&o.onPointerObservable.hasSpecificMask(d)&&o.onPointerObservable.notifyObservers(f,d),this._delayedClicks[l]=null}},this._initClickEvent=(l,c,h,u)=>{let d=new Ex;this._currentPickResult=null;let f=null,m=l.hasSpecificMask(Ae.POINTERPICK)||c.hasSpecificMask(Ae.POINTERPICK)||l.hasSpecificMask(Ae.POINTERTAP)||c.hasSpecificMask(Ae.POINTERTAP)||l.hasSpecificMask(Ae.POINTERDOUBLETAP)||c.hasSpecificMask(Ae.POINTERDOUBLETAP);!m&&Nl&&(f=this._initActionManager(f,d),f&&(m=f.hasPickTriggers));let g=!1;if(m){let _=h.button;if(d.hasSwiped=this._isPointerSwiping(),!d.hasSwiped){let x=!s.ExclusiveDoubleClickMode;if(x||(x=!l.hasSpecificMask(Ae.POINTERDOUBLETAP)&&!c.hasSpecificMask(Ae.POINTERDOUBLETAP),x&&!Nl.HasSpecificTrigger(6)&&(f=this._initActionManager(f,d),f&&(x=!f.hasSpecificTrigger(6)))),x)(Date.now()-this._previousStartingPointerTime>s.DoubleClickDelay||_!==this._previousButtonPressed)&&(d.singleClick=!0,u(d,this._currentPickResult),g=!0);else{let C={evt:h,clickInfo:d,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,_,d,u),s.DoubleClickDelay)};this._delayedClicks[_]=C}let b=l.hasSpecificMask(Ae.POINTERDOUBLETAP)||c.hasSpecificMask(Ae.POINTERDOUBLETAP);!b&&Nl.HasSpecificTrigger(6)&&(f=this._initActionManager(f,d),f&&(b=f.hasSpecificTrigger(6))),b&&(_===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<s.DoubleClickDelay&&!this._doubleClickOccured?(!d.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,d.doubleClick=!0,d.ignore=!1,s.ExclusiveDoubleClickMode&&this._delayedClicks[_]&&(clearTimeout(this._delayedClicks[_]?.timeoutId),this._delayedClicks[_]=null),u(d,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=_,s.ExclusiveDoubleClickMode?(this._delayedClicks[_]&&(clearTimeout(this._delayedClicks[_]?.timeoutId),this._delayedClicks[_]=null),u(d,this._previousPickResult)):u(d,this._currentPickResult)),g=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=_))}}g||u(d,this._currentPickResult)},this._onPointerMove=l=>{if(this._updatePointerPosition(l),!this._isSwiping&&this._swipeButtonPressed!==-1&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>s.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>s.DragMovementThreshold),a.isPointerLock&&a._verifyPointerLock(),this._checkPrePointerObservable(null,l,l.inputIndex>=Ye.MouseWheelX&&l.inputIndex<=Ye.MouseWheelZ?Ae.POINTERWHEEL:Ae.POINTERMOVE)||!o.cameraToUseForPointers&&!o.activeCamera)return;if(o.skipPointerMovePicking){this._processPointerMove(new oi,l);return}o.pointerMovePredicate||(o.pointerMovePredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(h.enablePointerMoveEvents||o.constantlyUpdateMeshUnderPointer||h._getActionManagerForTrigger()!==null)&&(!o.cameraToUseForPointers||(o.cameraToUseForPointers.layerMask&h.layerMask)!==0));let c=o._registeredActions>0||o.constantlyUpdateMeshUnderPointer?this._pickMove(l):null;this._processPointerMove(c,l)},this._onPointerDown=l=>{if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,s.ExclusiveDoubleClickMode){for(let h=0;h<this._delayedClicks.length;h++)if(this._delayedClicks[h])if(l.button===h)clearTimeout(this._delayedClicks[h]?.timeoutId);else{let u=this._delayedClicks[h].clickInfo;this._doubleClickOccured=!1,u.singleClick=!0,u.ignore=!1;let d=this._delayedClicks[h].evt,f=Ae.POINTERTAP,m=new ds(f,d,this._currentPickResult);o.onPointerObservable.hasObservers()&&o.onPointerObservable.hasSpecificMask(f)&&o.onPointerObservable.notifyObservers(m,f),this._delayedClicks[h]=null}}if(this._updatePointerPosition(l),this._swipeButtonPressed===-1&&(this._swipeButtonPressed=l.button),o.preventDefaultOnPointerDown&&n&&(l.preventDefault(),n.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,l,Ae.POINTERDOWN)||!o.cameraToUseForPointers&&!o.activeCamera)return;this._pointerCaptures[l.pointerId]=!0,o.pointerDownPredicate||(o.pointerDownPredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(!o.cameraToUseForPointers||(o.cameraToUseForPointers.layerMask&h.layerMask)!==0)),this._pickedDownMesh=null;let c;o.skipPointerDownPicking||o._registeredActions===0&&!this._checkForPicking()&&!o.onPointerDown?c=new oi:c=o.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,o.pointerDownPredicate,o.pointerDownFastCheck,o.cameraToUseForPointers,o.pointerDownTrianglePredicate),this._processPointerDown(c,l)},this._onPointerUp=l=>{this._totalPointersPressed!==0&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(l),o.preventDefaultOnPointerUp&&n&&(l.preventDefault(),n.focus()),this._initClickEvent(o.onPrePointerObservable,o.onPointerObservable,l,(c,h)=>{if(o.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!c.ignore)){if(this._checkPrePointerObservable(null,l,Ae.POINTERUP)){this._swipeButtonPressed===l.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1),l.buttons===0&&(this._pointerCaptures[l.pointerId]=!1);return}c.hasSwiped||(c.singleClick&&o.onPrePointerObservable.hasSpecificMask(Ae.POINTERTAP)&&this._checkPrePointerObservable(null,l,Ae.POINTERTAP)&&(this._skipPointerTap=!0),c.doubleClick&&o.onPrePointerObservable.hasSpecificMask(Ae.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,l,Ae.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}if(!this._pointerCaptures[l.pointerId]){this._swipeButtonPressed===l.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}l.buttons===0&&(this._pointerCaptures[l.pointerId]=!1),!(!o.cameraToUseForPointers&&!o.activeCamera)&&(o.pointerUpPredicate||(o.pointerUpPredicate=u=>u.isPickable&&u.isVisible&&u.isReady()&&u.isEnabled()&&(!o.cameraToUseForPointers||(o.cameraToUseForPointers.layerMask&u.layerMask)!==0)),!this._meshPickProceed&&(Nl&&Nl.HasTriggers||this._checkForPicking()||o.onPointerUp)&&this._initActionManager(null,c),h||(h=this._currentPickResult),this._processPointerUp(h,l,c),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===l.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))}))},this._onKeyDown=l=>{let c=vo.KEYDOWN;if(o.onPreKeyboardObservable.hasObservers()){let h=new zp(c,l);if(o.onPreKeyboardObservable.notifyObservers(h,c),h.skipOnKeyboardObservable)return}if(o.onKeyboardObservable.hasObservers()){let h=new nd(c,l);o.onKeyboardObservable.notifyObservers(h,c)}o.actionManager&&o.actionManager.processTrigger(14,Ii.CreateNewFromScene(o,l))},this._onKeyUp=l=>{let c=vo.KEYUP;if(o.onPreKeyboardObservable.hasObservers()){let h=new zp(c,l);if(o.onPreKeyboardObservable.notifyObservers(h,c),h.skipOnKeyboardObservable)return}if(o.onKeyboardObservable.hasObservers()){let h=new nd(c,l);o.onKeyboardObservable.notifyObservers(h,c)}o.actionManager&&o.actionManager.processTrigger(15,Ii.CreateNewFromScene(o,l))},this._deviceSourceManager.onDeviceConnectedObservable.add(l=>{l.deviceType===Le.Mouse?l.onInputChangedObservable.add(c=>{this._originMouseEvent=c,c.inputIndex===Ye.LeftClick||c.inputIndex===Ye.MiddleClick||c.inputIndex===Ye.RightClick||c.inputIndex===Ye.BrowserBack||c.inputIndex===Ye.BrowserForward?i&&l.getInput(c.inputIndex)===1?this._onPointerDown(c):t&&l.getInput(c.inputIndex)===0&&this._onPointerUp(c):r&&(c.inputIndex===Ye.Move?this._onPointerMove(c):(c.inputIndex===Ye.MouseWheelX||c.inputIndex===Ye.MouseWheelY||c.inputIndex===Ye.MouseWheelZ)&&this._onPointerMove(c))}):l.deviceType===Le.Touch?l.onInputChangedObservable.add(c=>{c.inputIndex===Ye.LeftClick&&(i&&l.getInput(c.inputIndex)===1?(this._onPointerDown(c),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):t&&l.getInput(c.inputIndex)===0&&(this._onPointerUp(c),this._totalPointersPressed===0&&(this._isMultiTouchGesture=!1))),r&&c.inputIndex===Ye.Move&&this._onPointerMove(c)}):l.deviceType===Le.Keyboard&&l.onInputChangedObservable.add(c=>{c.type==="keydown"?this._onKeyDown(c):c.type==="keyup"&&this._onKeyUp(c)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(t,i=0,r,n){if(this._meshUnderPointerId[i]===t&&(!t||!t._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;let o=this._meshUnderPointerId[i],a;o&&(a=o._getActionManagerForTrigger(10),a&&a.processTrigger(10,Ii.CreateNew(o,n,{pointerId:i}))),t?(this._meshUnderPointerId[i]=t,this._pointerOverMesh=t,a=t._getActionManagerForTrigger(9),a&&a.processTrigger(9,Ii.CreateNew(t,n,{pointerId:i,pickResult:r}))):(delete this._meshUnderPointerId[i],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(t){this._pointerOverMesh===t&&(this._pointerOverMesh=null),this._pickedDownMesh===t&&(this._pickedDownMesh=null),this._pickedUpMesh===t&&(this._pickedUpMesh=null);for(let i in this._meshUnderPointerId)this._meshUnderPointerId[i]===t&&delete this._meshUnderPointerId[i]}}return s.DragMovementThreshold=10,s.LongPressDelay=500,s.DoubleClickDelay=300,s.ExclusiveDoubleClickMode=!1,s})();var ea=class s{static GetPlanes(e){let t=[];for(let i=0;i<6;i++)t.push(new zs(0,0,0,0));return s.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){let i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){s.GetNearPlaneToRef(e,t[0]),s.GetFarPlaneToRef(e,t[1]),s.GetLeftPlaneToRef(e,t[2]),s.GetRightPlaneToRef(e,t[3]),s.GetTopPlaneToRef(e,t[4]),s.GetBottomPlaneToRef(e,t[5])}static IsPointInFrustum(e,t){for(let i=0;i<6;i++)if(t[i].dotCoordinate(e)<0)return!1;return!0}};var Ax=class{constructor(){this.pointerDownFastCheck=!1,this.pointerUpFastCheck=!1,this.pointerMoveFastCheck=!1,this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1}};var Wn=function(s){return s[s.BackwardCompatible=0]="BackwardCompatible",s[s.Intermediate=1]="Intermediate",s[s.Aggressive=2]="Aggressive",s}(Wn||{}),Te=(()=>{class s extends Jt{static DefaultMaterialFactory(t){throw We("StandardMaterial")}static CollisionCoordinatorFactory(){throw We("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(t){this._environmentTexture!==t&&(this._environmentTexture=t,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(t){if(t!==this._performancePriority){switch(this._performancePriority=t,t){case Wn.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case Wn.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case Wn.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}this.onScenePerformancePriorityChangedObservable.notifyObservers(t)}}set forceWireframe(t){this._forceWireframe!==t&&(this._forceWireframe=t,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(t){this._skipFrustumClipping!==t&&(this._skipFrustumClipping=t)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(t){this._forcePointsCloud!==t&&(this._forcePointsCloud=t,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(t){this._animationPropertiesOverride=t}set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}set beforeRender(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),t&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t))}set afterRender(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),t&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(t))}set beforeCameraRender(t){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(t)}set afterCameraRender(t){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(t)}get pointerDownPredicate(){return this._pointerPickingConfiguration.pointerDownPredicate}set pointerDownPredicate(t){this._pointerPickingConfiguration.pointerDownPredicate=t}get pointerUpPredicate(){return this._pointerPickingConfiguration.pointerUpPredicate}set pointerUpPredicate(t){this._pointerPickingConfiguration.pointerUpPredicate=t}get pointerMovePredicate(){return this._pointerPickingConfiguration.pointerMovePredicate}set pointerMovePredicate(t){this._pointerPickingConfiguration.pointerMovePredicate=t}get pointerDownFastCheck(){return this._pointerPickingConfiguration.pointerDownFastCheck}set pointerDownFastCheck(t){this._pointerPickingConfiguration.pointerDownFastCheck=t}get pointerUpFastCheck(){return this._pointerPickingConfiguration.pointerUpFastCheck}set pointerUpFastCheck(t){this._pointerPickingConfiguration.pointerUpFastCheck=t}get pointerMoveFastCheck(){return this._pointerPickingConfiguration.pointerMoveFastCheck}set pointerMoveFastCheck(t){this._pointerPickingConfiguration.pointerMoveFastCheck=t}get skipPointerMovePicking(){return this._pointerPickingConfiguration.skipPointerMovePicking}set skipPointerMovePicking(t){this._pointerPickingConfiguration.skipPointerMovePicking=t}get skipPointerDownPicking(){return this._pointerPickingConfiguration.skipPointerDownPicking}set skipPointerDownPicking(t){this._pointerPickingConfiguration.skipPointerDownPicking=t}get skipPointerUpPicking(){return this._pointerPickingConfiguration.skipPointerUpPicking}set skipPointerUpPicking(t){this._pointerPickingConfiguration.skipPointerUpPicking=t}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return Jo.DragMovementThreshold}static set DragMovementThreshold(t){Jo.DragMovementThreshold=t}static get LongPressDelay(){return Jo.LongPressDelay}static set LongPressDelay(t){Jo.LongPressDelay=t}static get DoubleClickDelay(){return Jo.DoubleClickDelay}static set DoubleClickDelay(t){Jo.DoubleClickDelay=t}static get ExclusiveDoubleClickMode(){return Jo.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(t){Jo.ExclusiveDoubleClickMode=t}bindEyePosition(t,i="vEyePosition",r=!1){let n=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:this.activeCamera.globalPosition,o=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return O.Vector4[0].set(n.x,n.y,n.z,o?-1:1),t&&(r?t.setFloat3(i,O.Vector4[0].x,O.Vector4[0].y,O.Vector4[0].z):t.setVector4(i,O.Vector4[0])),O.Vector4[0]}finalizeSceneUbo(){let t=this.getSceneUniformBuffer(),i=this.bindEyePosition(null);return t.updateFloat4("vEyePosition",i.x,i.y,i.z,i.w),t.update(),t}set useRightHandedSystem(t){this._useRightHandedSystem!==t&&(this._useRightHandedSystem=t,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(t){this._currentStepId=t}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(t){this._fogEnabled!==t&&(this._fogEnabled=t,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(t){this._fogMode!==t&&(this._fogMode=t,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(t){this._shadowsEnabled!==t&&(this._shadowsEnabled=t,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(t){this._lightsEnabled!==t&&(this._lightsEnabled=t,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(t){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),t&&(this._unObserveActiveCameras=bg(t,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=t}get activeCamera(){return this._activeCamera}set activeCamera(t){t!==this._activeCamera&&(this._activeCamera=t,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=s.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(t){this._defaultMaterial=t}set texturesEnabled(t){this._texturesEnabled!==t&&(this._texturesEnabled=t,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(t){this._skeletonsEnabled!==t&&(this._skeletonsEnabled=t,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=s.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(let t of this._transientComponents)t.register();this._transientComponents.length=0}}_addComponent(t){this._components.push(t),this._transientComponents.push(t);let i=t;i.addFromContainer&&i.serialize&&this._serializableComponents.push(i)}_getComponent(t){for(let i of this._components)if(i.name===t)return i;return null}constructor(t,i){super(),this._inputManager=new Jo(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new oe(.2,.2,.3,1),this.ambientColor=new X(0,0,0),this.environmentIntensity=1,this._performancePriority=Wn.BackwardCompatible,this.onScenePerformancePriorityChangedObservable=new U,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new U,this._onDisposeObserver=null,this.onBeforeRenderObservable=new U,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new U,this.onAfterRenderCameraObservable=new U,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new U,this.onAfterAnimationsObservable=new U,this.onBeforeDrawPhaseObservable=new U,this.onAfterDrawPhaseObservable=new U,this.onReadyObservable=new U,this.onBeforeCameraRenderObservable=new U,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new U,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new U,this.onAfterActiveMeshesEvaluationObservable=new U,this.onBeforeParticlesRenderingObservable=new U,this.onAfterParticlesRenderingObservable=new U,this.onDataLoadedObservable=new U,this.onNewCameraAddedObservable=new U,this.onCameraRemovedObservable=new U,this.onNewLightAddedObservable=new U,this.onLightRemovedObservable=new U,this.onNewGeometryAddedObservable=new U,this.onGeometryRemovedObservable=new U,this.onNewTransformNodeAddedObservable=new U,this.onTransformNodeRemovedObservable=new U,this.onNewMeshAddedObservable=new U,this.onMeshRemovedObservable=new U,this.onNewSkeletonAddedObservable=new U,this.onSkeletonRemovedObservable=new U,this.onNewMaterialAddedObservable=new U,this.onNewMultiMaterialAddedObservable=new U,this.onMaterialRemovedObservable=new U,this.onMultiMaterialRemovedObservable=new U,this.onNewTextureAddedObservable=new U,this.onTextureRemovedObservable=new U,this.onBeforeRenderTargetsRenderObservable=new U,this.onAfterRenderTargetsRenderObservable=new U,this.onBeforeStepObservable=new U,this.onAfterStepObservable=new U,this.onActiveCameraChanged=new U,this.onActiveCamerasChanged=new U,this.onBeforeRenderingGroupObservable=new U,this.onAfterRenderingGroupObservable=new U,this.onMeshImportedObservable=new U,this.onAnimationFileImportedObservable=new U,this._registeredForLateAnimationBindings=new fn(256),this._pointerPickingConfiguration=new Ax,this.onPrePointerObservable=new U,this.onPointerObservable=new U,this.onPreKeyboardObservable=new U,this.onKeyboardObservable=new U,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=s.FOGMODE_NONE,this.fogColor=new X(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new p(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new fn(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new Ps,this._activeIndices=new Ps,this._activeParticles=new Ps,this._activeBones=new Ps,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new _i(256),this._processedMaterials=new _i(256),this._renderTargets=new fn(256),this._materialsRenderTargets=new fn(256),this._activeParticleSystems=new _i(256),this._activeSkeletons=new fn(32),this._softwareSkinnedMeshes=new fn(32),this._activeAnimatables=new Array,this._transformMatrix=N.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=zi.Create(),this._beforeClearStage=zi.Create(),this._beforeRenderTargetClearStage=zi.Create(),this._gatherRenderTargetsStage=zi.Create(),this._gatherActiveCameraRenderTargetsStage=zi.Create(),this._isReadyForMeshStage=zi.Create(),this._beforeEvaluateActiveMeshStage=zi.Create(),this._evaluateSubMeshStage=zi.Create(),this._preActiveMeshStage=zi.Create(),this._cameraDrawRenderTargetStage=zi.Create(),this._beforeCameraDrawStage=zi.Create(),this._beforeRenderTargetDrawStage=zi.Create(),this._beforeRenderingGroupDrawStage=zi.Create(),this._beforeRenderingMeshStage=zi.Create(),this._afterRenderingMeshStage=zi.Create(),this._afterRenderingGroupDrawStage=zi.Create(),this._afterCameraDrawStage=zi.Create(),this._afterCameraPostProcessStage=zi.Create(),this._afterRenderTargetDrawStage=zi.Create(),this._afterRenderTargetPostProcessStage=zi.Create(),this._afterRenderStage=zi.Create(),this._pointerMoveStage=zi.Create(),this._pointerDownStage=zi.Create(),this._pointerUpStage=zi.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[];let r=ie({useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1},i);t=this._engine=t||me.LastCreatedEngine,r.virtual?t._virtualScenes.push(this):(me._LastCreatedScene=this,t.scenes.push(this)),this._uid=null,this._renderingManager=new Hc(this),$a&&(this.postProcessManager=new $a(this)),so()&&this.attachControl(),this._createUbo(),rt&&(this._imageProcessingConfiguration=new rt),this.setDefaultCandidateProviders(),r.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=r.useMaterialMeshMap,this.useClonedMeshMap=r.useClonedMeshMap,(!i||!i.virtual)&&t.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(t){return this._defaultSubMeshCandidates.data=t.subMeshes,this._defaultSubMeshCandidates.length=t.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=()=>this._getDefaultMeshCandidates(),this.getActiveSubMeshCandidates=t=>this._getDefaultSubMeshCandidates(t),this.getIntersectingSubMeshCandidates=(t,i)=>this._getDefaultSubMeshCandidates(t),this.getCollidingSubMeshCandidates=(t,i)=>this._getDefaultSubMeshCandidates(t)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(t){this._inputManager.pointerX=t}get pointerY(){return this._inputManager.pointerY}set pointerY(t){this._inputManager.pointerY=t}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(t,i,r=1){return this._cachedEffect!==i||this._cachedMaterial!==t||this._cachedVisibility!==r}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio!==void 0?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(t,i){return this._inputManager.simulatePointerMove(t,i),this}simulatePointerDown(t,i){return this._inputManager.simulatePointerDown(t,i),this}simulatePointerUp(t,i,r){return this._inputManager.simulatePointerUp(t,i,r),this}isPointerCaptured(t=0){return this._inputManager.isPointerCaptured(t)}attachControl(t=!0,i=!0,r=!0){this._inputManager.attachControl(t,i,r)}detachControl(){this._inputManager.detachControl()}isReady(t=!0){if(this._isDisposed)return!1;let i,r=this.getEngine(),n=r.currentRenderPassId;r.currentRenderPassId=this.activeCamera?.renderPassId??n;let o=!0;for(this._pendingData.length>0&&(o=!1),this.prePassRenderer?.update(),this.useOrderIndependentTransparency&&this.depthPeelingRenderer&&o&&(o=this.depthPeelingRenderer.isReady()),t&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),i=0;i<this.meshes.length;i++){let a=this.meshes[i];if(!a.subMeshes||a.subMeshes.length===0)continue;if(!a.isReady(!0)){o=!1;continue}let l=a.hasThinInstances||a.getClassName()==="InstancedMesh"||a.getClassName()==="InstancedLinesMesh"||r.getCaps().instancedArrays&&a.instances.length>0;for(let h of this._isReadyForMeshStage)h.action(a,l)||(o=!1);if(!t)continue;let c=a.material||this.defaultMaterial;if(c)if(c._storeEffectOnSubMeshes)for(let h of a.subMeshes){let u=h.getMaterial();u&&u.hasRenderTargetTextures&&u.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(u)===-1&&(this._processedMaterials.push(u),this._materialsRenderTargets.concatWithNoDuplicate(u.getRenderTargetTextures()))}else c.hasRenderTargetTextures&&c.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(c)===-1&&(this._processedMaterials.push(c),this._materialsRenderTargets.concatWithNoDuplicate(c.getRenderTargetTextures()))}if(t)for(i=0;i<this._materialsRenderTargets.length;++i)this._materialsRenderTargets.data[i].isReadyForRendering()||(o=!1);for(i=0;i<this.geometries.length;i++)this.geometries[i].delayLoadState===2&&(o=!1);if(this.activeCameras&&this.activeCameras.length>0)for(let a of this.activeCameras)a.isReady(!0)||(o=!1);else this.activeCamera&&(this.activeCamera.isReady(!0)||(o=!1));for(let a of this.particleSystems)a.isReady()||(o=!1);if(this.layers)for(let a of this.layers)a.isReady()||(o=!1);return r.areAllEffectsReady()||(o=!1),r.currentRenderPassId=n,o}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(t){this.onBeforeRenderObservable.add(t)}unregisterBeforeRender(t){this.onBeforeRenderObservable.removeCallback(t)}registerAfterRender(t){this.onAfterRenderObservable.add(t)}unregisterAfterRender(t){this.onAfterRenderObservable.removeCallback(t)}_executeOnceBeforeRender(t){let i=()=>{t(),setTimeout(()=>{this.unregisterBeforeRender(i)})};this.registerBeforeRender(i)}executeOnceBeforeRender(t,i){i!==void 0?setTimeout(()=>{this._executeOnceBeforeRender(t)},i):this._executeOnceBeforeRender(t)}addPendingData(t){this._pendingData.push(t)}removePendingData(t){let i=this.isLoading,r=this._pendingData.indexOf(t);r!==-1&&this._pendingData.splice(r,1),i&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(t,i=!1){this.onReadyObservable.addOnce(t),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(i)}whenReadyAsync(t=!1){return new Promise(i=>{this.executeWhenReady(()=>{i()},t)})}_checkIsReady(t=!1){if(this._registerTransientComponents(),this.isReady(t)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(t)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=Mi.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(t,i,r,n){!r&&!n&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===t.updateFlag&&this._projectionUpdateFlag===i.updateFlag)&&(this._viewUpdateFlag=t.updateFlag,this._projectionUpdateFlag=i.updateFlag,this._viewMatrix=t,this._projectionMatrix=i,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?ea.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=ea.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(r,n):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(t){let i=new _r(this._engine,void 0,!1,t??"scene");return i.addUniform("viewProjection",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}setSceneUniformBuffer(t){this._sceneUbo=t,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return xu.UniqueId}addMesh(t,i=!1){this._blockEntityCollection||(this.meshes.push(t),t._resyncLightSources(),t.parent||t._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(t),i&&t.getChildMeshes().forEach(r=>{this.addMesh(r)}))}removeMesh(t,i=!1){let r=this.meshes.indexOf(t);return r!==-1&&(this.meshes[r]=this.meshes[this.meshes.length-1],this.meshes.pop(),t.parent||t._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(t),this.onMeshRemovedObservable.notifyObservers(t),i&&t.getChildMeshes().forEach(n=>{this.removeMesh(n)}),r}addTransformNode(t){this._blockEntityCollection||t.getScene()===this&&t._indexInSceneTransformNodesArray!==-1||(t._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(t),t.parent||t._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(t))}removeTransformNode(t){let i=t._indexInSceneTransformNodesArray;if(i!==-1){if(i!==this.transformNodes.length-1){let r=this.transformNodes[this.transformNodes.length-1];this.transformNodes[i]=r,r._indexInSceneTransformNodesArray=i}t._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),t.parent||t._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(t),i}removeSkeleton(t){let i=this.skeletons.indexOf(t);return i!==-1&&(this.skeletons.splice(i,1),this.onSkeletonRemovedObservable.notifyObservers(t),this._executeActiveContainerCleanup(this._activeSkeletons)),i}removeMorphTargetManager(t){let i=this.morphTargetManagers.indexOf(t);return i!==-1&&this.morphTargetManagers.splice(i,1),i}removeLight(t){let i=this.lights.indexOf(t);if(i!==-1){for(let r of this.meshes)r._removeLightSource(t,!1);this.lights.splice(i,1),this.sortLightsByPriority(),t.parent||t._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(t),i}removeCamera(t){let i=this.cameras.indexOf(t);if(i!==-1&&(this.cameras.splice(i,1),t.parent||t._removeFromSceneRootNodes()),this.activeCameras){let r=this.activeCameras.indexOf(t);r!==-1&&this.activeCameras.splice(r,1)}return this.activeCamera===t&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(t),i}removeParticleSystem(t){let i=this.particleSystems.indexOf(t);return i!==-1&&(this.particleSystems.splice(i,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),i}removeAnimation(t){let i=this.animations.indexOf(t);return i!==-1&&this.animations.splice(i,1),i}stopAnimation(t,i,r){}removeAnimationGroup(t){let i=this.animationGroups.indexOf(t);return i!==-1&&this.animationGroups.splice(i,1),i}removeMultiMaterial(t){let i=this.multiMaterials.indexOf(t);return i!==-1&&this.multiMaterials.splice(i,1),this.onMultiMaterialRemovedObservable.notifyObservers(t),i}removeMaterial(t){let i=t._indexInSceneMaterialArray;if(i!==-1&&i<this.materials.length){if(i!==this.materials.length-1){let r=this.materials[this.materials.length-1];this.materials[i]=r,r._indexInSceneMaterialArray=i}t._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(t),i}removeActionManager(t){let i=this.actionManagers.indexOf(t);return i!==-1&&this.actionManagers.splice(i,1),i}removeTexture(t){let i=this.textures.indexOf(t);return i!==-1&&this.textures.splice(i,1),this.onTextureRemovedObservable.notifyObservers(t),i}addLight(t){if(!this._blockEntityCollection){this.lights.push(t),this.sortLightsByPriority(),t.parent||t._addToSceneRootNodes();for(let i of this.meshes)i.lightSources.indexOf(t)===-1&&(i.lightSources.push(t),i._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(t)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(xr.CompareLightsPriority)}addCamera(t){this._blockEntityCollection||(this.cameras.push(t),this.onNewCameraAddedObservable.notifyObservers(t),t.parent||t._addToSceneRootNodes())}addSkeleton(t){this._blockEntityCollection||(this.skeletons.push(t),this.onNewSkeletonAddedObservable.notifyObservers(t))}addParticleSystem(t){this._blockEntityCollection||this.particleSystems.push(t)}addAnimation(t){this._blockEntityCollection||this.animations.push(t)}addAnimationGroup(t){this._blockEntityCollection||this.animationGroups.push(t)}addMultiMaterial(t){this._blockEntityCollection||(this.multiMaterials.push(t),this.onNewMultiMaterialAddedObservable.notifyObservers(t))}addMaterial(t){this._blockEntityCollection||t.getScene()===this&&t._indexInSceneMaterialArray!==-1||(t._indexInSceneMaterialArray=this.materials.length,this.materials.push(t),this.onNewMaterialAddedObservable.notifyObservers(t))}addMorphTargetManager(t){this._blockEntityCollection||this.morphTargetManagers.push(t)}addGeometry(t){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[t.uniqueId]=this.geometries.length),this.geometries.push(t))}addActionManager(t){this.actionManagers.push(t)}addTexture(t){this._blockEntityCollection||(this.textures.push(t),this.onNewTextureAddedObservable.notifyObservers(t))}switchActiveCamera(t,i=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=t,i&&t.attachControl())}setActiveCameraById(t){let i=this.getCameraById(t);return i?(this.activeCamera=i,i):null}setActiveCameraByName(t){let i=this.getCameraByName(t);return i?(this.activeCamera=i,i):null}getAnimationGroupByName(t){for(let i=0;i<this.animationGroups.length;i++)if(this.animationGroups[i].name===t)return this.animationGroups[i];return null}_getMaterial(t,i){for(let r=0;r<this.materials.length;r++){let n=this.materials[r];if(i(n))return n}if(t)for(let r=0;r<this.multiMaterials.length;r++){let n=this.multiMaterials[r];if(i(n))return n}return null}getMaterialByUniqueID(t,i=!1){return this._getMaterial(i,r=>r.uniqueId===t)}getMaterialById(t,i=!1){return this._getMaterial(i,r=>r.id===t)}getMaterialByName(t,i=!1){return this._getMaterial(i,r=>r.name===t)}getLastMaterialById(t,i=!1){for(let r=this.materials.length-1;r>=0;r--)if(this.materials[r].id===t)return this.materials[r];if(i){for(let r=this.multiMaterials.length-1;r>=0;r--)if(this.multiMaterials[r].id===t)return this.multiMaterials[r]}return null}getTextureByUniqueId(t){for(let i=0;i<this.textures.length;i++)if(this.textures[i].uniqueId===t)return this.textures[i];return null}getTextureByName(t){for(let i=0;i<this.textures.length;i++)if(this.textures[i].name===t)return this.textures[i];return null}getCameraById(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].id===t)return this.cameras[i];return null}getCameraByUniqueId(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].uniqueId===t)return this.cameras[i];return null}getCameraByName(t){for(let i=0;i<this.cameras.length;i++)if(this.cameras[i].name===t)return this.cameras[i];return null}getBoneById(t){for(let i=0;i<this.skeletons.length;i++){let r=this.skeletons[i];for(let n=0;n<r.bones.length;n++)if(r.bones[n].id===t)return r.bones[n]}return null}getBoneByName(t){for(let i=0;i<this.skeletons.length;i++){let r=this.skeletons[i];for(let n=0;n<r.bones.length;n++)if(r.bones[n].name===t)return r.bones[n]}return null}getLightByName(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].name===t)return this.lights[i];return null}getLightById(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].id===t)return this.lights[i];return null}getLightByUniqueId(t){for(let i=0;i<this.lights.length;i++)if(this.lights[i].uniqueId===t)return this.lights[i];return null}getParticleSystemById(t){for(let i=0;i<this.particleSystems.length;i++)if(this.particleSystems[i].id===t)return this.particleSystems[i];return null}getGeometryById(t){for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].id===t)return this.geometries[i];return null}_getGeometryByUniqueId(t){if(this._geometriesByUniqueId){let i=this._geometriesByUniqueId[t];if(i!==void 0)return this.geometries[i]}else for(let i=0;i<this.geometries.length;i++)if(this.geometries[i].uniqueId===t)return this.geometries[i];return null}pushGeometry(t,i){return!i&&this._getGeometryByUniqueId(t.uniqueId)?!1:(this.addGeometry(t),this.onNewGeometryAddedObservable.notifyObservers(t),!0)}removeGeometry(t){let i;if(this._geometriesByUniqueId){if(i=this._geometriesByUniqueId[t.uniqueId],i===void 0)return!1}else if(i=this.geometries.indexOf(t),i<0)return!1;if(i!==this.geometries.length-1){let r=this.geometries[this.geometries.length-1];r&&(this.geometries[i]=r,this._geometriesByUniqueId&&(this._geometriesByUniqueId[r.uniqueId]=i))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[t.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(t),!0}getGeometries(){return this.geometries}getMeshById(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].id===t)return this.meshes[i];return null}getMeshesById(t){return this.meshes.filter(function(i){return i.id===t})}getTransformNodeById(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].id===t)return this.transformNodes[i];return null}getTransformNodeByUniqueId(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].uniqueId===t)return this.transformNodes[i];return null}getTransformNodesById(t){return this.transformNodes.filter(function(i){return i.id===t})}getMeshByUniqueId(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].uniqueId===t)return this.meshes[i];return null}getLastMeshById(t){for(let i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===t)return this.meshes[i];return null}getLastTransformNodeById(t){for(let i=this.transformNodes.length-1;i>=0;i--)if(this.transformNodes[i].id===t)return this.transformNodes[i];return null}getLastEntryById(t){let i;for(i=this.meshes.length-1;i>=0;i--)if(this.meshes[i].id===t)return this.meshes[i];for(i=this.transformNodes.length-1;i>=0;i--)if(this.transformNodes[i].id===t)return this.transformNodes[i];for(i=this.cameras.length-1;i>=0;i--)if(this.cameras[i].id===t)return this.cameras[i];for(i=this.lights.length-1;i>=0;i--)if(this.lights[i].id===t)return this.lights[i];return null}getNodeById(t){let i=this.getMeshById(t);if(i)return i;let r=this.getTransformNodeById(t);if(r)return r;let n=this.getLightById(t);if(n)return n;let o=this.getCameraById(t);if(o)return o;let a=this.getBoneById(t);return a||null}getNodeByName(t){let i=this.getMeshByName(t);if(i)return i;let r=this.getTransformNodeByName(t);if(r)return r;let n=this.getLightByName(t);if(n)return n;let o=this.getCameraByName(t);if(o)return o;let a=this.getBoneByName(t);return a||null}getMeshByName(t){for(let i=0;i<this.meshes.length;i++)if(this.meshes[i].name===t)return this.meshes[i];return null}getTransformNodeByName(t){for(let i=0;i<this.transformNodes.length;i++)if(this.transformNodes[i].name===t)return this.transformNodes[i];return null}getLastSkeletonById(t){for(let i=this.skeletons.length-1;i>=0;i--)if(this.skeletons[i].id===t)return this.skeletons[i];return null}getSkeletonByUniqueId(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].uniqueId===t)return this.skeletons[i];return null}getSkeletonById(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].id===t)return this.skeletons[i];return null}getSkeletonByName(t){for(let i=0;i<this.skeletons.length;i++)if(this.skeletons[i].name===t)return this.skeletons[i];return null}getMorphTargetManagerById(t){for(let i=0;i<this.morphTargetManagers.length;i++)if(this.morphTargetManagers[i].uniqueId===t)return this.morphTargetManagers[i];return null}getMorphTargetById(t){for(let i=0;i<this.morphTargetManagers.length;++i){let r=this.morphTargetManagers[i];for(let n=0;n<r.numTargets;++n){let o=r.getTarget(n);if(o.id===t)return o}}return null}getMorphTargetByName(t){for(let i=0;i<this.morphTargetManagers.length;++i){let r=this.morphTargetManagers[i];for(let n=0;n<r.numTargets;++n){let o=r.getTarget(n);if(o.name===t)return o}}return null}getPostProcessByName(t){for(let i=0;i<this.postProcesses.length;++i){let r=this.postProcesses[i];if(r.name===t)return r}return null}isActiveMesh(t){return this._activeMeshes.indexOf(t)!==-1}get uid(){return this._uid||(this._uid=H.RandomId()),this._uid}addExternalData(t,i){return this._externalData||(this._externalData=new Wc),this._externalData.add(t,i)}getExternalData(t){return this._externalData?this._externalData.get(t):null}getOrAddExternalDataWithFactory(t,i){return this._externalData||(this._externalData=new Wc),this._externalData.getOrAddWithFactory(t,i)}removeExternalData(t){return this._externalData.remove(t)}_evaluateSubMesh(t,i,r,n){if(n||t.isInFrustum(this._frustumPlanes)){for(let a of this._evaluateSubMeshStage)a.action(i,t);let o=t.getMaterial();o!=null&&(o.hasRenderTargetTextures&&o.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(o)===-1&&(this._processedMaterials.push(o),this._materialsRenderTargets.concatWithNoDuplicate(o.getRenderTargetTextures())),this._renderingManager.dispatch(t,i,o))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(t){this._preventFreeActiveMeshesAndRenderingGroups!==t&&(t&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=t)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let t=0;t<this.activeCameras.length;t++){let i=this.activeCameras[t];i&&i._activeMeshes&&i._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let t=0;t<this.textures.length;t++){let i=this.textures[t];i&&i.renderList&&i.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(t=!1,i,r,n=!0,o=!1){return this.executeWhenReady(()=>{if(!this.activeCamera){r&&r("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=o,this._skipEvaluateActiveMeshesCompletely=t,n)for(let a=0;a<this._activeMeshes.length;a++)this._activeMeshes.data[a]._freeze();i&&i()}),this}unfreezeActiveMeshes(){for(let t=0;t<this.meshes.length;t++){let i=this.meshes[t];i._internalAbstractMeshDataInfo&&(i._internalAbstractMeshDataInfo._isActive=!1)}for(let t=0;t<this._activeMeshes.length;t++)this._activeMeshes.data[t]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(t){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>t.dispose())}_evaluateActiveMeshes(){if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&(this.activeCamera?._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){let r=this._activeMeshes.length;for(let n=0;n<r;n++)this._activeMeshes.data[n].computeWorldMatrix()}if(this._activeParticleSystems){let r=this._activeParticleSystems.length;for(let n=0;n<r;n++)this._activeParticleSystems.data[n].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(let r of this._beforeEvaluateActiveMeshStage)r.action();let t=this.getActiveMeshCandidates(),i=t.length;for(let r=0;r<i;r++){let n=t.data[r];if(n._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,n.isBlocked||(this._totalVertices.addCount(n.getTotalVertices(),!1),!n.isReady()||!n.isEnabled()||n.scaling.hasAZeroComponent))continue;n.computeWorldMatrix(),n.actionManager&&n.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(n);let o=this.customLODSelector?this.customLODSelector(n,this.activeCamera):n.getLOD(this.activeCamera);if(n._internalAbstractMeshDataInfo._currentLOD=o,n._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,o!=null&&(o!==n&&o.billboardMode!==0&&o.computeWorldMatrix(),n._preActivate(),n.isVisible&&n.visibility>0&&n.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||n.alwaysSelectAsActiveMesh||n.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(n),this.activeCamera._activeMeshes.push(n),o!==n&&o._activate(this._renderId,!1);for(let a of this._preActiveMeshStage)a.action(n);n._activate(this._renderId,!1)&&(n.isAnInstance?n._internalAbstractMeshDataInfo._actAsRegularMesh&&(o=n):o._internalAbstractMeshDataInfo._onlyForInstances=!1,o._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(n,o)),n._postActivate()}}if(this.onAfterActiveMeshesEvaluationObservable.notifyObservers(this),this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let r=0;r<this.particleSystems.length;r++){let n=this.particleSystems[r];if(!n.isStarted()||!n.emitter)continue;let o=n.emitter;(!o.position||o.isEnabled())&&(this._activeParticleSystems.push(n),n.animate(),this._renderingManager.dispatchParticles(n))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(t,i){this._skeletonsEnabled&&i.skeleton!==null&&i.skeleton!==void 0&&(this._activeSkeletons.pushNoDuplicate(i.skeleton)&&(i.skeleton.prepare(),this._activeBones.addCount(i.skeleton.bones.length,!1)),i.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(i));let r=t.hasInstances||t.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||i.alwaysSelectAsActiveMesh;if(i&&i.subMeshes&&i.subMeshes.length>0){let n=this.getActiveSubMeshCandidates(i),o=n.length;r=r||o===1;for(let a=0;a<o;a++){let l=n.data[a];this._evaluateSubMesh(l,i,t,r)}}}updateTransformMatrix(t){let i=this.activeCamera;if(i)if(i._renderingMultiview){let r=i._rigCameras[0],n=i._rigCameras[1];this.setTransformMatrix(r.getViewMatrix(),r.getProjectionMatrix(t),n.getViewMatrix(),n.getProjectionMatrix(t))}else this.setTransformMatrix(i.getViewMatrix(),i.getProjectionMatrix(t))}_bindFrameBuffer(t,i=!0){t&&t._multiviewTexture?t._multiviewTexture._bindFrameBuffer():t&&t.outputRenderTarget?t.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),i&&this._clearFrameBuffer(t)}_clearFrameBuffer(t){if(!(t&&t._multiviewTexture))if(t&&t.outputRenderTarget&&!t._renderingMultiview){let i=t.outputRenderTarget;i.onClearObservable.hasObservers()?i.onClearObservable.notifyObservers(this._engine):!i.skipInitialClear&&!t.isRightCamera&&(this.autoClear&&this._engine.clear(i.clearColor||this.clearColor,!i._cleared,!0,!0),i._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(t,i,r=!0){if(t&&t._skipRendering)return;let n=this._engine;if(this._activeCamera=t,!this.activeCamera)throw new Error("Active camera not set");if(n.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&r){let a=!0;t._renderingMultiview&&t.outputRenderTarget&&(a=t.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,t.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),t._renderingMultiview&&t.outputRenderTarget&&(t.outputRenderTarget.skipInitialClear=a)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let a=0;a<this._softwareSkinnedMeshes.length;a++){let l=this._softwareSkinnedMeshes.data[a];l.applySkeleton(l.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),i&&i.customRenderTargets&&i.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(i.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(let a of this._gatherActiveCameraRenderTargetsStage)a.action(this._renderTargets);let o=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){H.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let a=0;a<this._renderTargets.length;a++){let l=this._renderTargets.data[a];if(l._shouldRender()){this._renderId++;let c=l.activeCamera&&l.activeCamera!==this.activeCamera;l.render(c,this.dumpNextRenderTargets),o=!0}}H.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(let a of this._cameraDrawRenderTargetStage)o=a.action(this.activeCamera)||o;this._intermediateRendering=!1}this._engine.currentRenderPassId=t.outputRenderTarget?.renderPassId??t.renderPassId??0,o&&!this.prePass&&(this._bindFrameBuffer(this._activeCamera,!1),this.updateTransformMatrix()),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!t._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(let a of this._beforeCameraDrawStage)a.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),n.snapshotRendering&&n.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(let a of this._afterCameraDrawStage)a.action(this.activeCamera);if(this.postProcessManager&&!t._multiviewTexture){let a=t.outputRenderTarget?t.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(t.isIntermediate,a)}for(let a of this._afterCameraPostProcessStage)a.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(t,i=!0){if(t.cameraRigMode===0||t._renderingMultiview){t._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(t,void 0,i),this.onAfterRenderCameraObservable.notifyObservers(t);return}if(t._useMultiviewToSingleView)this._renderMultiviewToSingleView(t);else{this.onBeforeCameraRenderObservable.notifyObservers(t);for(let r=0;r<t._rigCameras.length;r++)this._renderForCamera(t._rigCameras[r],t)}this._activeCamera=t,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(t)}_checkIntersections(){for(let t=0;t<this._meshesForIntersections.length;t++){let i=this._meshesForIntersections.data[t];if(i.actionManager)for(let r=0;i.actionManager&&r<i.actionManager.actions.length;r++){let n=i.actionManager.actions[r];if(n.trigger===12||n.trigger===13){let o=n.getTriggerParameter(),a=o.mesh?o.mesh:o,l=a.intersectsMesh(i,o.usePreciseIntersection),c=i._intersectionsInProgress.indexOf(a);l&&c===-1?n.trigger===12?(n._executeCurrent(Ii.CreateNew(i,void 0,a)),i._intersectionsInProgress.push(a)):n.trigger===13&&i._intersectionsInProgress.push(a):!l&&c>-1&&(n.trigger===13&&n._executeCurrent(Ii.CreateNew(i,void 0,a)),(!i.actionManager.hasSpecificTrigger(13,h=>{let u=h.mesh?h.mesh:h;return a===u})||n.trigger===13)&&i._intersectionsInProgress.splice(c,1))}}}}_advancePhysicsEngineStep(t){}_animate(t){}animate(){if(this._engine.isDeterministicLockStep()){let t=Math.max(s.MinDeltaTime,Math.min(this._engine.getDeltaTime(),s.MaxDeltaTime))+this._timeAccumulator,i=this._engine.getTimeStep(),r=1e3/i/1e3,n=0,o=this._engine.getLockstepMaxSteps(),a=Math.floor(t/i);for(a=Math.min(a,o);t>0&&n<a;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=i*r,this._animate(i),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(i),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,n++,t-=i;this._timeAccumulator=t<0?0:t}else{let t=this.useConstantAnimationDeltaTime?16:Math.max(s.MinDeltaTime,Math.min(this._engine.getDeltaTime(),s.MaxDeltaTime));this._animationRatio=t*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(t){if(t?.outputRenderTarget&&!t?.isRigCamera&&(t.outputRenderTarget._cleared=!1),t?.rigCameras?.length)for(let i=0;i<t.rigCameras.length;++i){let r=t.rigCameras[i].outputRenderTarget;r&&(r._cleared=!1)}}resetDrawCache(t){if(this.meshes)for(let i of this.meshes)i.resetDrawCache(t)}render(t=!0,i=!1){if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),this.activeCameras?.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),i||this.animate();for(let o of this._beforeCameraUpdateStage)o.action();if(t){if(this.activeCameras&&this.activeCameras.length>0)for(let o=0;o<this.activeCameras.length;o++){let a=this.activeCameras[o];if(a.update(),a.cameraRigMode!==0)for(let l=0;l<a._rigCameras.length;l++)a._rigCameras[l].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let o=0;o<this.activeCamera._rigCameras.length;o++)this.activeCamera._rigCameras[o].update()}this.onBeforeRenderObservable.notifyObservers(this);let r=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);let n=this.activeCameras?.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){H.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let o=0;o<this.customRenderTargets.length;o++){let a=this.customRenderTargets[o];if(a._shouldRender()){if(this._renderId++,this.activeCamera=a.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");r.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),a.render(n!==this.activeCamera,this.dumpNextRenderTargets)}}H.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=n?.renderPassId??0,this.activeCamera=n,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(let o of this._beforeClearStage)o.action();this._clearFrameBuffer(this.activeCamera);for(let o of this._gatherRenderTargetsStage)o.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let o=0;o<this.activeCameras.length;o++)this._processSubCameras(this.activeCameras[o],o>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(let o of this._afterRenderStage)o.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let o=0;o<this._toBeDisposed.length;o++){let a=this._toBeDisposed[o];a&&a.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let t=0;t<this.materials.length;t++)this.materials[t].freeze()}unfreezeMaterials(){for(let t=0;t<this.materials.length;t++)this.materials[t].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this.stopAllAnimations&&(this._activeAnimatables.forEach(o=>{o.onAnimationEndObservable.clear(),o.onAnimationEnd=null}),this.stopAllAnimations()),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;let t=this._activeRequests.slice();for(let o of t)o.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(o){F.Error("An error occurred while calling onDisposeObservable!",o)}if(this.detachControl(),this._engine.getInputElement())for(let o=0;o<this.cameras.length;o++)this.cameras[o].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,o=>o.dispose(!0)),this._disposeList(this.transformNodes,o=>o.dispose(!0));let r=this.cameras;this._disposeList(r),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let n=this._engine.scenes.indexOf(this);n>-1&&this._engine.scenes.splice(n,1),me._LastCreatedScene===this&&(this._engine.scenes.length>0?me._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:me._LastCreatedScene=null),n=this._engine._virtualScenes.indexOf(this),n>-1&&this._engine._virtualScenes.splice(n,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this._isDisposed=!0}_disposeList(t,i){let r=t.slice(0);i=i??(n=>n.dispose());for(let n of r)i(n);t.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let t=0;t<this.meshes.length;t++){let r=this.meshes[t].geometry;r&&r.clearCachedData()}}cleanCachedTextureBuffer(){for(let t of this.textures)t._buffer&&(t._buffer=null)}getWorldExtends(t){let i=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new p(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return t=t||(()=>!0),this.meshes.filter(t).forEach(n=>{if(n.computeWorldMatrix(!0),!n.subMeshes||n.subMeshes.length===0||n.infiniteDistance)return;let o=n.getBoundingInfo(),a=o.boundingBox.minimumWorld,l=o.boundingBox.maximumWorld;p.CheckExtends(a,i,r),p.CheckExtends(l,i,r)}),{min:i,max:r}}createPickingRay(t,i,r,n,o=!1){throw We("Ray")}createPickingRayToRef(t,i,r,n,o,a=!1,l=!1){throw We("Ray")}createPickingRayInCameraSpace(t,i,r){throw We("Ray")}createPickingRayInCameraSpaceToRef(t,i,r,n){throw We("Ray")}get _pickingAvailable(){return!1}pick(t,i,r,n,o,a){let l=We("Ray",!0);return l&&F.Warn(l),new oi}pickWithBoundingInfo(t,i,r,n,o){let a=We("Ray",!0);return a&&F.Warn(a),new oi}pickWithRay(t,i,r,n){throw We("Ray")}multiPick(t,i,r,n,o){throw We("Ray")}multiPickWithRay(t,i,r){throw We("Ray")}setPointerOverMesh(t,i,r){this._inputManager.setPointerOverMesh(t,i,r)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(let t of this.geometries)t._rebuild();for(let t of this.meshes)t._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(let t of this._components)t.rebuild();for(let t of this.particleSystems)t.rebuild();if(this.spriteManagers)for(let t of this.spriteManagers)t.rebuild()}_rebuildTextures(){for(let t of this.textures)t._rebuild(!0);this.markAllMaterialsAsDirty(1)}_getByTags(t,i,r){if(i===void 0)return t;let n=[];for(let o in t){let a=t[o];di&&di.MatchesQuery(a,i)&&(!r||r(a))&&n.push(a)}return n}getMeshesByTags(t,i){return this._getByTags(this.meshes,t,i)}getCamerasByTags(t,i){return this._getByTags(this.cameras,t,i)}getLightsByTags(t,i){return this._getByTags(this.lights,t,i)}getMaterialByTags(t,i){return this._getByTags(this.materials,t,i).concat(this._getByTags(this.multiMaterials,t,i))}getTransformNodesByTags(t,i){return this._getByTags(this.transformNodes,t,i)}setRenderingOrder(t,i=null,r=null,n=null){this._renderingManager.setRenderingOrder(t,i,r,n)}setRenderingAutoClearDepthStencil(t,i,r=!0,n=!0){this._renderingManager.setRenderingAutoClearDepthStencil(t,i,r,n)}getAutoClearDepthStencilSetup(t){return this._renderingManager.getAutoClearDepthStencilSetup(t)}_forceBlockMaterialDirtyMechanism(t){this._blockMaterialDirtyMechanism=t}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(t){this._blockMaterialDirtyMechanism!==t&&(this._blockMaterialDirtyMechanism=t,t||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(t,i){if(!this._blockMaterialDirtyMechanism)for(let r of this.materials)i&&!i(r)||r.markAsDirty(t)}_loadFile(t,i,r,n,o,a,l){let c=UO(t,i,r,n?this.offlineProvider:void 0,o,a,l);return this._activeRequests.push(c),c.onCompleteObservable.add(h=>{this._activeRequests.splice(this._activeRequests.indexOf(h),1)}),c}_loadFileAsync(t,i,r,n,o){return new Promise((a,l)=>{this._loadFile(t,c=>{a(c)},i,r,n,(c,h)=>{l(h)},o)})}_requestFile(t,i,r,n,o,a,l){let c=kO(t,i,r,n?this.offlineProvider:void 0,o,a,l);return this._activeRequests.push(c),c.onCompleteObservable.add(h=>{this._activeRequests.splice(this._activeRequests.indexOf(h),1)}),c}_requestFileAsync(t,i,r,n,o){return new Promise((a,l)=>{this._requestFile(t,c=>{a(c)},i,r,n,c=>{l(c)},o)})}_readFile(t,i,r,n,o){let a=VO(t,i,r,n,o);return this._activeRequests.push(a),a.onCompleteObservable.add(l=>{this._activeRequests.splice(this._activeRequests.indexOf(l),1)}),a}_readFileAsync(t,i,r){return new Promise((n,o)=>{this._readFile(t,a=>{n(a)},i,r,a=>{o(a)})})}getPerfCollector(){throw We("performanceViewerSceneExtension")}setActiveCameraByID(t){return this.setActiveCameraById(t)}getMaterialByID(t){return this.getMaterialById(t)}getLastMaterialByID(t){return this.getLastMaterialById(t)}getTextureByUniqueID(t){return this.getTextureByUniqueId(t)}getCameraByID(t){return this.getCameraById(t)}getCameraByUniqueID(t){return this.getCameraByUniqueId(t)}getBoneByID(t){return this.getBoneById(t)}getLightByID(t){return this.getLightById(t)}getLightByUniqueID(t){return this.getLightByUniqueId(t)}getParticleSystemByID(t){return this.getParticleSystemById(t)}getGeometryByID(t){return this.getGeometryById(t)}getMeshByID(t){return this.getMeshById(t)}getMeshByUniqueID(t){return this.getMeshByUniqueId(t)}getLastMeshByID(t){return this.getLastMeshById(t)}getMeshesByID(t){return this.getMeshesById(t)}getTransformNodeByID(t){return this.getTransformNodeById(t)}getTransformNodeByUniqueID(t){return this.getTransformNodeByUniqueId(t)}getTransformNodesByID(t){return this.getTransformNodesById(t)}getNodeByID(t){return this.getNodeById(t)}getLastEntryByID(t){return this.getLastEntryById(t)}getLastSkeletonByID(t){return this.getLastSkeletonById(t)}}return s.FOGMODE_NONE=0,s.FOGMODE_EXP=1,s.FOGMODE_EXP2=2,s.FOGMODE_LINEAR=3,s.MinDeltaTime=1,s.MaxDeltaTime=1e3,s})();P("BABYLON.Scene",Te);var Ke=function(s){return s[s.LOCAL=0]="LOCAL",s[s.WORLD=1]="WORLD",s[s.BONE=2]="BONE",s}(Ke||{}),qt=class{};qt.X=new p(1,0,0);qt.Y=new p(0,1,0);qt.Z=new p(0,0,1);var Xc=function(s){return s[s.X=0]="X",s[s.Y=1]="Y",s[s.Z=2]="Z",s}(Xc||{});var ss=class s extends Xe{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){e.updateFlag===this._localMatrix.updateFlag&&!this._needToCompose||(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,r=null,n=null,o=null,a=null){super(e,t.getScene(),!1),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=r?.clone()??N.Identity(),this._restMatrix=n??this._localMatrix.clone(),this._bindMatrix=o??this._localMatrix.clone(),this._index=a,this._absoluteMatrix=new N,this._absoluteBindMatrix=new N,this._absoluteInverseBindMatrix=new N,this._finalMatrix=new N,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){let i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){let e=O.Vector3[0],t=O.Quaternion[0],i=O.Vector3[1];this.getRestMatrix().decompose(e,t,i),this._linkedTransformNode.position.copyFrom(i),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??q.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(t),this._linkedTransformNode.scaling.copyFrom(e)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=p.Zero(),this._localRotation=q.Zero(),this._localPosition=p.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,N.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateAbsoluteBindMatrices();this._scalingDeterminant=this._absoluteBindMatrix.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=Ke.LOCAL,i,r=!0){let n=this.getLocalMatrix();if(t==Ke.LOCAL)r?(n.addAtIndex(12,e.x),n.addAtIndex(13,e.y),n.addAtIndex(14,e.z)):n.setTranslationFromFloats(e.x,e.y,e.z);else{let o=null;i&&(o=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let a=s._TmpMats[0],l=s._TmpVecs[0];this.parent?i&&o?(a.copyFrom(this.parent.getAbsoluteMatrix()),a.multiplyToRef(o,a)):a.copyFrom(this.parent.getAbsoluteMatrix()):N.IdentityToRef(a),r&&a.setTranslationFromFloats(0,0,0),a.invert(),p.TransformCoordinatesToRef(e,a,l),r?(n.addAtIndex(12,l.x),n.addAtIndex(13,l.y),n.addAtIndex(14,l.z)):n.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()}translate(e,t=Ke.LOCAL,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=Ke.LOCAL,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,Ke.WORLD,t)}scale(e,t,i,r=!1){let n=this.getLocalMatrix(),o=s._TmpMats[0];N.ScalingToRef(e,t,i,o),o.multiplyToRef(n,n),o.invert();for(let a of this.children){let l=a.getLocalMatrix();l.multiplyToRef(o,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),a._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),r)for(let a of this.children)a.scale(e,t,i,r)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,r=Ke.LOCAL,n){if(r===Ke.LOCAL){let l=s._TmpQuat;q.RotationYawPitchRollToRef(e,t,i,l),this.setRotationQuaternion(l,r,n);return}let o=s._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(o,n))return;let a=s._TmpMats[1];N.RotationYawPitchRollToRef(e,t,i,a),o.multiplyToRef(a,a),this._rotateWithMatrix(a,r,n)}rotate(e,t,i=Ke.LOCAL,r){let n=s._TmpMats[0];n.setTranslationFromFloats(0,0,0),N.RotationAxisToRef(e,t,n),this._rotateWithMatrix(n,i,r)}setAxisAngle(e,t,i=Ke.LOCAL,r){if(i===Ke.LOCAL){let a=s._TmpQuat;q.RotationAxisToRef(e,t,a),this.setRotationQuaternion(a,i,r);return}let n=s._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,r))return;let o=s._TmpMats[1];N.RotationAxisToRef(e,t,o),n.multiplyToRef(o,o),this._rotateWithMatrix(o,i,r)}setRotation(e,t=Ke.LOCAL,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=Ke.LOCAL,i){if(t===Ke.LOCAL){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}let r=s._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,i))return;let n=s._TmpMats[1];N.FromQuaternionToRef(e,n),r.multiplyToRef(n,n),this._rotateWithMatrix(n,t,i)}setRotationMatrix(e,t=Ke.LOCAL,i){if(t===Ke.LOCAL){let o=s._TmpQuat;q.FromRotationMatrixToRef(e,o),this.setRotationQuaternion(o,t,i);return}let r=s._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(r,i))return;let n=s._TmpMats[1];n.copyFrom(e),r.multiplyToRef(e,n),this._rotateWithMatrix(n,t,i)}_rotateWithMatrix(e,t=Ke.LOCAL,i){let r=this.getLocalMatrix(),n=r.m[12],o=r.m[13],a=r.m[14],l=this.getParent(),c=s._TmpMats[3],h=s._TmpMats[4];l&&t==Ke.WORLD?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteMatrix()),h.copyFrom(c),h.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(h,r)):t==Ke.WORLD&&i?(c.copyFrom(i.getWorldMatrix()),h.copyFrom(c),h.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(h,r)):r.multiplyToRef(e,r),r.setTranslationFromFloats(n,o,a),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){let i=s._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),N.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):N.IdentityToRef(i),e.invert(),isNaN(e.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=Ke.LOCAL,t=null){let i=p.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=Ke.LOCAL,t,i){if(e==Ke.LOCAL){let r=this.getLocalMatrix();i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}else{let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let n=s._TmpMats[0];t&&r?(n.copyFrom(this.getAbsoluteMatrix()),n.multiplyToRef(r,n)):n=this.getAbsoluteMatrix(),i.x=n.m[12],i.y=n.m[13],i.z=n.m[14]}}getAbsolutePosition(e=null){let t=p.Zero();return this.getPositionToRef(Ke.WORLD,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(Ke.WORLD,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);let i=this._skeleton.getPoseMatrix();i&&this._absoluteMatrix.multiplyToRef(i,this._absoluteMatrix)}let e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){let i=p.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let n=s._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&r&&n.multiplyToRef(r,n),p.TransformNormalToRef(e,n,i),i.normalize()}getRotation(e=Ke.LOCAL,t=null){let i=p.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=Ke.LOCAL,t=null,i){let r=s._TmpQuat;this.getRotationQuaternionToRef(e,t,r),r.toEulerAnglesToRef(i)}getRotationQuaternion(e=Ke.LOCAL,t=null){let i=q.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=Ke.LOCAL,t=null,i){if(e==Ke.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{let r=s._TmpMats[0],n=this.getAbsoluteMatrix();t?n.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(n),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.decompose(void 0,i,void 0)}}getRotationMatrix(e=Ke.LOCAL,t){let i=N.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=Ke.LOCAL,t,i){if(e==Ke.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{let r=s._TmpMats[0],n=this.getAbsoluteMatrix();t?n.multiplyToRef(t.getWorldMatrix(),r):r.copyFrom(n),r.multiplyAtIndex(0,this._scalingDeterminant),r.multiplyAtIndex(1,this._scalingDeterminant),r.multiplyAtIndex(2,this._scalingDeterminant),r.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){let i=p.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let n=s._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&r&&n.multiplyToRef(r,n),p.TransformCoordinatesToRef(e,n,i)}getLocalPositionFromAbsolute(e,t=null){let i=p.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let r=null;t&&(r=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let n=s._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&r&&n.multiplyToRef(r,n),n.invert(),p.TransformCoordinatesToRef(e,n,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}};ss._TmpVecs=Ir.BuildArray(2,p.Zero);ss._TmpQuat=q.Identity();ss._TmpMats=Ir.BuildArray(5,N.Identity);var Ix=class{get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,this._goToFrame!==null&&this.goToFrame(this._goToFrame)}get elapsedTime(){return this._localDelayOffset===null?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,r=100,n=!1,o=1,a,l,c,h=!1,u=0){this.target=t,this.fromFrame=i,this.toFrame=r,this.loopAnimation=n,this.onAnimationEnd=a,this.onAnimationLoop=c,this.isAdditive=h,this.playOrder=u,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new U,this.onAnimationLoopObservable=new U,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=o,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){let t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){let r=t[i],n=new px(e,r,this._scene,this);n._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(n)}}getAnimationByTargetProperty(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){let e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){let e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){let t=this._runtimeAnimations;if(t[0]){let i=t[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??t[0].currentFrame;let r=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/i*1e3/this.speedRatio;this._manualJumpDelay=-r}for(let i=0;i<t.length;i++)t[i].goToFrame(e,this._weight);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1){if(e||t){let r=this._scene._activeAnimatables.indexOf(this);if(r>-1){let n=this._runtimeAnimations;for(let o=n.length-1;o>=0;o--){let a=n[o];e&&a.animation.name!=e||t&&!t(a.target)||(a.dispose(),n.splice(o,1))}n.length==0&&(i||this._scene._activeAnimatables.splice(r,1),this._raiseOnAnimationEnd())}}else{let r=this._scene._activeAnimatables.indexOf(this);if(r>-1){i||this._scene._activeAnimatables.splice(r,1);let n=this._runtimeAnimations;for(let o=0;o<n.length;o++)n[o].dispose();this._runtimeAnimations.length=0,this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,this._weight===0)return!0;let t=!1,i=this._runtimeAnimations,r;for(r=0;r<i.length;r++){let o=i[r].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||o}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(r=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(r,1),r=0;r<i.length;r++)i[r].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}};Te.prototype._animate=function(s){if(!this.animationsEnabled)return;let e=Mi.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=e}this.deltaTime=s!==void 0?s:this.useConstantAnimationDeltaTime?16:(e-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=e;let t=this._activeAnimatables;if(t.length===0)return;this._animationTime+=this.deltaTime;let i=this._animationTime;for(let r=0;r<t.length;r++){let n=t[r];!n._animate(i)&&n.disposeOnEnd&&r--}this._processLateAnimationBindings()};Te.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((s,e)=>s.playOrder-e.playOrder)};Te.prototype.beginWeightedAnimation=function(s,e,t,i=1,r,n=1,o,a,l,c,h=!1){let u=this.beginAnimation(s,e,t,r,n,o,a,!1,l,c,h);return u.weight=i,u};Te.prototype.beginAnimation=function(s,e,t,i,r=1,n,o,a=!0,l,c,h=!1){e>t&&r>0&&(r*=-1),a&&this.stopAnimation(s,void 0,l),o||(o=new Ix(this,s,e,t,i,r,n,void 0,c,h));let u=l?l(s):!0;if(s.animations&&u&&o.appendAnimations(s,s.animations),s.getAnimatables){let d=s.getAnimatables();for(let f=0;f<d.length;f++)this.beginAnimation(d[f],e,t,i,r,n,o,a,l,c)}return o.reset(),o};Te.prototype.beginHierarchyAnimation=function(s,e,t,i,r,n=1,o,a,l=!0,c,h,u=!1){let d=s.getDescendants(e),f=[];f.push(this.beginAnimation(s,t,i,r,n,o,a,l,c,void 0,u));for(let m of d)f.push(this.beginAnimation(m,t,i,r,n,o,a,l,c,void 0,u));return f};Te.prototype.beginDirectAnimation=function(s,e,t,i,r,n,o,a,l=!1){if(n===void 0&&(n=1),t>i&&n>0)n*=-1;else if(i>t&&n<0){let h=i;i=t,t=h}return new Ix(this,s,t,i,r,n,o,e,a,l)};Te.prototype.beginDirectHierarchyAnimation=function(s,e,t,i,r,n,o,a,l,c=!1){let h=s.getDescendants(e),u=[];u.push(this.beginDirectAnimation(s,t,i,r,n,o,a,l,c));for(let d of h)u.push(this.beginDirectAnimation(d,t,i,r,n,o,a,l,c));return u};Te.prototype.getAnimatableByTarget=function(s){for(let e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===s)return this._activeAnimatables[e];return null};Te.prototype.getAllAnimatablesByTarget=function(s){let e=[];for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].target===s&&e.push(this._activeAnimatables[t]);return e};Te.prototype.stopAnimation=function(s,e,t){let i=this.getAllAnimatablesByTarget(s);for(let r of i)r.stop(e,t)};Te.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let s=0;s<this._activeAnimatables.length;s++)this._activeAnimatables[s].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(let s of this.animationGroups)s.stop()};Te.prototype._registerTargetForLateAnimationBinding=function(s,e){let t=s.target;this._registeredForLateAnimationBindings.pushNoDuplicate(t),t._lateAnimationHolders||(t._lateAnimationHolders={}),t._lateAnimationHolders[s.targetPath]||(t._lateAnimationHolders[s.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),s.isAdditive?(t._lateAnimationHolders[s.targetPath].additiveAnimations.push(s),t._lateAnimationHolders[s.targetPath].totalAdditiveWeight+=s.weight):(t._lateAnimationHolders[s.targetPath].animations.push(s),t._lateAnimationHolders[s.targetPath].totalWeight+=s.weight)};Te.prototype._processLateAnimationBindingsForMatrices=function(s){if(s.totalWeight===0&&s.totalAdditiveWeight===0)return s.originalValue;let e=1,t=O.Vector3[0],i=O.Vector3[1],r=O.Quaternion[0],n=0,o=s.animations[0],a=s.originalValue,l=1,c=!1;if(s.totalWeight<1)l=1-s.totalWeight,a.decompose(i,r,t);else{if(n=1,e=s.totalWeight,l=o.weight/e,l==1)if(s.totalAdditiveWeight)c=!0;else return o.currentValue;o.currentValue.decompose(i,r,t)}if(!c){i.scaleInPlace(l),t.scaleInPlace(l),r.scaleInPlace(l);for(let u=n;u<s.animations.length;u++){let d=s.animations[u];if(d.weight===0)continue;l=d.weight/e;let f=O.Vector3[2],m=O.Vector3[3],g=O.Quaternion[1];d.currentValue.decompose(m,g,f),m.scaleAndAddToRef(l,i),g.scaleAndAddToRef(q.Dot(r,g)>0?l:-l,r),f.scaleAndAddToRef(l,t)}r.normalize()}for(let u=0;u<s.additiveAnimations.length;u++){let d=s.additiveAnimations[u];if(d.weight===0)continue;let f=O.Vector3[2],m=O.Vector3[3],g=O.Quaternion[1];d.currentValue.decompose(m,g,f),m.multiplyToRef(i,m),p.LerpToRef(i,m,d.weight,i),r.multiplyToRef(g,g),q.SlerpToRef(r,g,d.weight,r),f.scaleAndAddToRef(d.weight,t)}let h=o?o._animationState.workValue:O.Matrix[0].clone();return N.ComposeToRef(i,r,t,h),h};Te.prototype._processLateAnimationBindingsForQuaternions=function(s,e){if(s.totalWeight===0&&s.totalAdditiveWeight===0)return e;let t=s.animations[0],i=s.originalValue,r=e;if(s.totalWeight===0&&s.totalAdditiveWeight>0)r.copyFrom(i);else if(s.animations.length===1){if(q.SlerpToRef(i,t.currentValue,Math.min(1,s.totalWeight),r),s.totalAdditiveWeight===0)return r}else if(s.animations.length>1){let n=1,o,a;if(s.totalWeight<1){let c=1-s.totalWeight;o=[],a=[],o.push(i),a.push(c)}else{if(s.animations.length===2&&(q.SlerpToRef(s.animations[0].currentValue,s.animations[1].currentValue,s.animations[1].weight/s.totalWeight,e),s.totalAdditiveWeight===0))return e;o=[],a=[],n=s.totalWeight}for(let c=0;c<s.animations.length;c++){let h=s.animations[c];o.push(h.currentValue),a.push(h.weight/n)}let l=0;for(let c=0;c<o.length;){if(!c){q.SlerpToRef(o[c],o[c+1],a[c+1]/(a[c]+a[c+1]),e),r=e,l=a[c]+a[c+1],c+=2;continue}l+=a[c],q.SlerpToRef(r,o[c],a[c]/l,r),c++}}for(let n=0;n<s.additiveAnimations.length;n++){let o=s.additiveAnimations[n];o.weight!==0&&(r.multiplyToRef(o.currentValue,O.Quaternion[0]),q.SlerpToRef(r,O.Quaternion[0],o.weight,r))}return r};Te.prototype._processLateAnimationBindings=function(){if(this._registeredForLateAnimationBindings.length){for(let s=0;s<this._registeredForLateAnimationBindings.length;s++){let e=this._registeredForLateAnimationBindings.data[s];for(let t in e._lateAnimationHolders){let i=e._lateAnimationHolders[t],r=i.animations[0],n=i.originalValue;if(n==null)continue;let o=te.AllowMatrixDecomposeForInterpolation&&n.m,a=e[t];if(o)a=this._processLateAnimationBindingsForMatrices(i);else if(n.w!==void 0)a=this._processLateAnimationBindingsForQuaternions(i,a||q.Identity());else{let c=0,h=1,u=r&&r._animationState.loopMode===te.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(i.totalWeight<1)u?a=n.clone?n.clone():n:r&&n.scale?a=n.scale(1-i.totalWeight):r?a=n*(1-i.totalWeight):n.clone?a=n.clone():a=n;else if(r){h=i.totalWeight;let d=r.weight/h;d!==1?r.currentValue.scale?a=r.currentValue.scale(d):a=r.currentValue*d:a=r.currentValue,u&&(a.addToRef?a.addToRef(n,a):a+=n),c=1}for(let d=c;d<i.animations.length;d++){let f=i.animations[d],m=f.weight/h;if(m)f.currentValue.scaleAndAddToRef?f.currentValue.scaleAndAddToRef(m,a):a+=f.currentValue*m;else continue}for(let d=0;d<i.additiveAnimations.length;d++){let f=i.additiveAnimations[d],m=f.weight;if(m)f.currentValue.scaleAndAddToRef?f.currentValue.scaleAndAddToRef(m,a):a+=f.currentValue*m;else continue}}e[t]=a}e._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}};ss.prototype.copyAnimationRange=function(s,e,t,i=!1,r=null){this.animations.length===0&&(this.animations.push(new te(this.name,"_matrix",s.animations[0].framePerSecond,te.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));let n=s.animations[0].getRange(e);if(!n)return!1;let o=n.from,a=n.to,l=s.animations[0].getKeys(),c=s.length,h=s.getParent(),u=this.getParent(),d=i&&h&&c&&this.length&&c!==this.length,f=d&&u&&h?u.length/h.length:1,m=i&&!u&&r&&(r.x!==1||r.y!==1||r.z!==1),g=this.animations[0].getKeys(),_,x,b;for(let C=0,R=l.length;C<R;C++)_=l[C],_.frame>=o&&_.frame<=a&&(i?(b=_.value.clone(),d?(x=b.getTranslation(),b.setTranslation(x.scaleInPlace(f))):m&&r?(x=b.getTranslation(),b.setTranslation(x.multiplyInPlace(r))):b=_.value):b=_.value,g.push({frame:_.frame+t,value:b}));return this.animations[0].createRange(e,o+t,a+t),!0};var Hp=function(s){return s[s.CW=0]="CW",s[s.CCW=1]="CCW",s}(Hp||{});var ad=class s{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return this._radians*180/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,t){let i=t.subtract(e),r=Math.atan2(i.y,i.x);return new s(r)}static BetweenTwoVectors(e,t){let i=e.lengthSquared()*t.lengthSquared();if(i===0)return new s(Math.PI/2);i=Math.sqrt(i);let r=e.dot(t)/i;r=xe.Clamp(r,-1,1);let n=Math.acos(r);return new s(n)}static FromRadians(e){return new s(e)}static FromDegrees(e){return new s(e*Math.PI/180)}},uI=class{constructor(e,t,i){this.startPoint=e,this.midPoint=t,this.endPoint=i;let r=Math.pow(t.x,2)+Math.pow(t.y,2),n=(Math.pow(e.x,2)+Math.pow(e.y,2)-r)/2,o=(r-Math.pow(i.x,2)-Math.pow(i.y,2))/2,a=(e.x-t.x)*(t.y-i.y)-(t.x-i.x)*(e.y-t.y);this.centerPoint=new j((n*(t.y-i.y)-o*(e.y-t.y))/a,((e.x-t.x)*o-(t.x-i.x)*n)/a),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=ad.BetweenTwoPoints(this.centerPoint,this.startPoint);let l=this.startAngle.degrees(),c=ad.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),h=ad.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();c-l>180&&(c-=360),c-l<-180&&(c+=360),h-c>180&&(h-=360),h-c<-180&&(h+=360),this.orientation=c-l<0?Hp.CW:Hp.CCW,this.angle=ad.FromDegrees(this.orientation===Hp.CW?l-h:h-l)}},ld=class s{constructor(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new j(e,t))}addLineTo(e,t){if(this.closed)return this;let i=new j(e,t),r=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(r).length(),this}addArcTo(e,t,i,r,n=36){if(this.closed)return this;let o=this._points[this._points.length-1],a=new j(e,t),l=new j(i,r),c=new uI(o,a,l),h=c.angle.radians()/n;c.orientation===Hp.CW&&(h*=-1);let u=c.startAngle.radians()+h;for(let d=0;d<n;d++){let f=Math.cos(u)*c.radius+c.centerPoint.x,m=Math.sin(u)*c.radius+c.centerPoint.y;this.addLineTo(f,m),u+=h}return this}addQuadraticCurveTo(e,t,i,r,n=36){if(this.closed)return this;let o=(l,c,h,u)=>(1-l)*(1-l)*c+2*l*(1-l)*h+l*l*u,a=this._points[this._points.length-1];for(let l=0;l<=n;l++){let c=l/n,h=o(c,a.x,e,i),u=o(c,a.y,t,r);this.addLineTo(h,u)}return this}addBezierCurveTo(e,t,i,r,n,o,a=36){if(this.closed)return this;let l=(h,u,d,f,m)=>(1-h)*(1-h)*(1-h)*u+3*h*(1-h)*(1-h)*d+3*h*h*(1-h)*f+h*h*h*m,c=this._points[this._points.length-1];for(let h=0;h<=a;h++){let u=h/a,d=l(u,c.x,e,i,n),f=l(u,c.y,t,r,o);this.addLineTo(d,f)}return this}isPointInside(e){let t=!1,i=this._points.length;for(let r=i-1,n=0;n<i;r=n++){let o=this._points[r],a=this._points[n],l=a.x-o.x,c=a.y-o.y;if(Math.abs(c)>Number.EPSILON){if(c<0&&(o=this._points[n],l=-l,a=this._points[r],c=-c),e.y<o.y||e.y>a.y)continue;if(e.y===o.y&&e.x===o.x)return!0;{let h=c*(e.x-o.x)-l*(e.y-o.y);if(h===0)return!0;if(h<0)continue;t=!t}}else{if(e.y!==o.y)continue;if(a.x<=e.x&&e.x<=o.x||o.x<=e.x&&e.x<=a.x)return!0}}return t}close(){return this.closed=!0,this}length(){let e=this._length;if(this.closed){let t=this._points[this._points.length-1],i=this._points[0];e+=i.subtract(t).length()}return e}area(){let e=this._points.length,t=0;for(let i=e-1,r=0;r<e;i=r++)t+=this._points[i].x*this._points[r].y-this._points[r].x*this._points[i].y;return t*.5}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return j.Zero();let t=e*this.length(),i=0;for(let r=0;r<this._points.length;r++){let n=(r+1)%this._points.length,o=this._points[r],l=this._points[n].subtract(o),c=l.length()+i;if(t>=i&&t<=c){let h=l.normalize(),u=t-i;return new j(o.x+h.x*u,o.y+h.y*u)}i=c}return j.Zero()}static StartingAt(e,t){return new s(e,t)}},Yc=class s{constructor(e,t=null,i,r=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:p.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:N.Identity()};for(let n=0;n<e.length;n++)this._curve[n]=e[n].clone();this._raw=i||!1,this._alignTangentsWithPath=r,this._compute(t,r)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?p.TransformCoordinates(p.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?p.TransformCoordinates(p.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?p.TransformCoordinates(p.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,i=0;for(let r=0;r<this._curve.length-1;r++){let n=this._curve[r+0],o=this._curve[r+1].subtract(n).normalize(),a=this._distances[r+1]-this._distances[r+0],l=Math.min(Math.max(p.Dot(o,e.subtract(n).normalize()),0)*p.Distance(n,e)/a,1),c=p.Distance(n.add(o.scale(l*a)),e);c<t&&(t=c,i=(this._distances[r+0]+a*l)/this.length())}return i}slice(e=0,t=1){if(e<0&&(e=1-e*-1%1),t<0&&(t=1-t*-1%1),e>t){let c=e;e=t,t=c}let i=this.getCurve(),r=this.getPointAt(e),n=this.getPreviousPointIndexAt(e),o=this.getPointAt(t),a=this.getPreviousPointIndexAt(t)+1,l=[];return e!==0&&(n++,l.push(r)),l.push(...i.slice(n,a)),(t!==1||e===1)&&l.push(o),new s(l,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,i=!1){for(let r=0;r<e.length;r++)this._curve[r].x=e[r].x,this._curve[r].y=e[r].y,this._curve[r].z=e[r].z;return this._compute(t,i),this}_compute(e,t=!1){let i=this._curve.length;if(i<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();let r=this._tangents[0],n=this._normalVector(r,e);this._normals[0]=n,this._raw||this._normals[0].normalize(),this._binormals[0]=p.Cross(r,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;let o,a,l,c,h;for(let u=1;u<i;u++)o=this._getLastNonNullVector(u),u<i-1&&(a=this._getFirstNonNullVector(u),this._tangents[u]=t?a:o.add(a),this._tangents[u].normalize()),this._distances[u]=this._distances[u-1]+this._curve[u].subtract(this._curve[u-1]).length(),l=this._tangents[u],h=this._binormals[u-1],this._normals[u]=p.Cross(h,l),this._raw||(this._normals[u].length()===0?(c=this._normals[u-1],this._normals[u]=c.clone()):this._normals[u].normalize()),this._binormals[u]=p.Cross(l,this._normals[u]),this._raw||this._binormals[u].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,i=this._curve[e+t].subtract(this._curve[e]);for(;i.length()===0&&e+t+1<this._curve.length;)t++,i=this._curve[e+t].subtract(this._curve[e]);return i}_getLastNonNullVector(e){let t=1,i=this._curve[e].subtract(this._curve[e-t]);for(;i.length()===0&&e>t+1;)t++,i=this._curve[e].subtract(this._curve[e-t]);return i}_normalVector(e,t){let i,r=e.length();if(r===0&&(r=1),t==null){let n;xe.WithinEpsilon(Math.abs(e.y)/r,1,je)?xe.WithinEpsilon(Math.abs(e.x)/r,1,je)?xe.WithinEpsilon(Math.abs(e.z)/r,1,je)?n=p.Zero():n=new p(0,0,1):n=new p(1,0,0):n=new p(0,-1,0),i=p.Cross(e,n)}else i=p.Cross(e,t),p.CrossToRef(i,e,i);return i.normalize(),i}_updatePointAtData(e,t=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;let i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);let r=i[0],n,o=0,a=e*this.length();for(let l=1;l<i.length;l++){n=i[l];let c=p.Distance(r,n);if(o+=c,o===a)return this._setPointAtData(e,1,n,l,t);if(o>a){let u=(o-a)/c,d=r.subtract(n),f=n.add(d.scaleInPlace(u));return this._setPointAtData(e,1-u,f,l-1,t)}r=n}return this._pointAtData}_setPointAtData(e,t,i,r,n){return this._pointAtData.point=i,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=r,this._pointAtData.interpolateReady=n,n&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=N.Identity();let e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){let t=e+1,i=this._tangents[e].clone(),r=this._normals[e].clone(),n=this._binormals[e].clone(),o=this._tangents[t].clone(),a=this._normals[t].clone(),l=this._binormals[t].clone(),c=q.RotationQuaternionFromAxis(r,n,i),h=q.RotationQuaternionFromAxis(a,l,o);q.Slerp(c,h,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}},cd=class s{static CreateQuadraticBezier(e,t,i,r){r=r>2?r:3;let n=[],o=(a,l,c,h)=>(1-a)*(1-a)*l+2*a*(1-a)*c+a*a*h;for(let a=0;a<=r;a++)n.push(new p(o(a/r,e.x,t.x,i.x),o(a/r,e.y,t.y,i.y),o(a/r,e.z,t.z,i.z)));return new s(n)}static CreateCubicBezier(e,t,i,r,n){n=n>3?n:4;let o=[],a=(l,c,h,u,d)=>(1-l)*(1-l)*(1-l)*c+3*l*(1-l)*(1-l)*h+3*l*l*(1-l)*u+l*l*l*d;for(let l=0;l<=n;l++)o.push(new p(a(l/n,e.x,t.x,i.x,r.x),a(l/n,e.y,t.y,i.y,r.y),a(l/n,e.z,t.z,i.z,r.z)));return new s(o)}static CreateHermiteSpline(e,t,i,r,n){let o=[],a=1/n;for(let l=0;l<=n;l++)o.push(p.Hermite(e,t,i,r,l*a));return new s(o)}static CreateCatmullRomSpline(e,t,i){let r=[],n=1/t,o=0;if(i){let a=e.length;for(let l=0;l<a;l++){o=0;for(let c=0;c<t;c++)r.push(p.CatmullRom(e[l%a],e[(l+1)%a],e[(l+2)%a],e[(l+3)%a],o)),o+=n}r.push(r[0])}else{let a=[];a.push(e[0].clone()),Array.prototype.push.apply(a,e),a.push(e[e.length-1].clone());let l=0;for(;l<a.length-3;l++){o=0;for(let c=0;c<t;c++)r.push(p.CatmullRom(a[l],a[l+1],a[l+2],a[l+3],o)),o+=n}l--,r.push(p.CatmullRom(a[l],a[l+1],a[l+2],a[l+3],o))}return new s(r)}static ArcThru3Points(e,t,i,r=32,n=!1,o=!1){let a=[],l=t.subtract(e),c=i.subtract(t),h=e.subtract(i),u=p.Cross(l,c),d=u.length();if(d<Math.pow(10,-8))return new s(a);let f=l.lengthSquared(),m=c.lengthSquared(),g=h.lengthSquared(),_=u.lengthSquared(),x=l.length(),b=c.length(),C=h.length(),R=.5*x*b*C/d,E=p.Dot(l,h),S=p.Dot(l,c),A=p.Dot(c,h),L=-.5*m*E/_,G=-.5*g*S/_,W=-.5*f*A/_,$=e.scale(L).add(t.scale(G)).add(i.scale(W)),we=e.subtract($).normalize(),_e=p.Cross(u,we).normalize();if(o){let ce=2*Math.PI/r;for(let ne=0;ne<=2*Math.PI;ne+=ce)a.push($.add(we.scale(R*Math.cos(ne)).add(_e.scale(R*Math.sin(ne)))));a.push(e)}else{let ce=1/r,ne=0,Fe=p.Zero();do Fe=$.add(we.scale(R*Math.cos(ne)).add(_e.scale(R*Math.sin(ne)))),a.push(Fe),ne+=ce;while(!Fe.equalsWithEpsilon(i,R*ce*1.1));a.push(i),n&&a.push(e)}return new s(a)}constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}getPoints(){return this._points}length(){return this._length}continue(e){let t=this._points[this._points.length-1],i=this._points.slice(),r=e.getPoints();for(let o=1;o<r.length;o++)i.push(r[o].subtract(r[0]).add(t));return new s(i)}_computeLength(e){let t=0;for(let i=1;i<e.length;i++)t+=e[i].subtract(e[i-1]).length();return t}};var fs=(()=>{class s{constructor(){this._easingMode=s.EASINGMODE_EASEIN}setEasingMode(t){let i=Math.min(Math.max(t,0),2);this._easingMode=i}getEasingMode(){return this._easingMode}easeInCore(t){throw new Error("You must implement this method")}ease(t){switch(this._easingMode){case s.EASINGMODE_EASEIN:return this.easeInCore(t);case s.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-t)}return t>=.5?(1-this.easeInCore((1-t)*2))*.5+.5:this.easeInCore(t*2)*.5}}return s.EASINGMODE_EASEIN=0,s.EASINGMODE_EASEOUT=1,s.EASINGMODE_EASEINOUT=2,s})(),Rx=class extends fs{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}},Px=class extends fs{constructor(e=1){super(),this.amplitude=e}easeInCore(e){let t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}};var Mx=class extends fs{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}};var Dx=class extends fs{easeInCore(e){return e*e}};var hd=class extends fs{easeInCore(e){return 1-Math.sin(1.5707963267948966*(1-e))}};var Ox=class s{constructor(e,t,i){this.frame=e,this.action=t,this.onlyOnce=i,this.isDone=!1}_clone(){return new s(this.frame,this.action,this.onlyOnce)}};var dI=class{getClassName(){return"TargetedAnimation"}serialize(){let e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}},ud=class s{get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this.syncWithMask(!0))}syncWithMask(e=!1){if(!this.mask&&!e){this._numActiveAnimatables=this._targetedAnimations.length;return}this._numActiveAnimatables=0;for(let t=0;t<this._animatables.length;++t){let i=this._animatables[t];!this.mask||this.mask.disabled||this.mask.retainsTarget(i.target.name)?(this._numActiveAnimatables++,i.paused&&i.restart()):i.paused||i.pause()}}removeUnmaskedAnimations(){if(!(!this.mask||this.mask.disabled)){for(let e=0;e<this._animatables.length;++e){let t=this._animatables[e];this.mask.retainsTarget(t.target.name)||(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){let t=this._targetedAnimations[e];this.mask.retainsTarget(t.target.name)||(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}set from(e){if(this._from!==e){this._from=e;for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.fromFrame=this._from}}}get to(){return this._to}set to(e){if(this._to!==e){this._to=e;for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.toFrame=this._to}}}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.isAdditive=this._isAdditive}}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let t=0;t<this._animatables.length;t++)this._animatables[t].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,e!==null))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){e=e??this._from,t=t??this._to;let i=this.targetedAnimations[0].animation.framePerSecond*this._speedRatio;return(t-e)/i}static MergeAnimationGroups(e,t=!0,i=!1,r){if(e.length===0)return null;r=r??e[0].weight;let n=Number.MAX_VALUE,o=-Number.MAX_VALUE;if(i)for(let l of e)l.from<n&&(n=l.from),l.to>o&&(o=l.to);let a=new s(e[0].name+"_merged",e[0]._scene,r);for(let l of e){i&&l.normalize(n,o);for(let c of l.targetedAnimations)a.addTargetedAnimation(c.animation,c.target);t&&l.dispose()}return a}constructor(e,t=null,i=-1,r=0){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._parentContainer=null,this.onAnimationEndObservable=new U,this.onAnimationLoopObservable=new U,this.onAnimationGroupLoopObservable=new U,this.onAnimationGroupEndObservable=new U,this.onAnimationGroupPauseObservable=new U,this.onAnimationGroupPlayObservable=new U,this.metadata=null,this._mask=null,this._animationLoopFlags=[],this._scene=t||me.LastCreatedScene,this._weight=i,this._playOrder=r,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){let i=new dI;i.animation=e,i.target=t;let r=e.getKeys();return this._from>r[0].frame&&(this._from=r[0].frame),this._to<r[r.length-1].frame&&(this._to=r[r.length-1].frame),this._enableBlending!==null&&(e.enableBlending=this._enableBlending),this._blendingSpeed!==null&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){e==null&&(e=this._from),t==null&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){let n=this._targetedAnimations[i].animation.getKeys(),o=n[0],a=n[n.length-1];if(o.frame>e){let l={frame:e,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation};n.splice(0,0,l)}if(a.frame<t){let l={frame:t,value:a.value,inTangent:a.inTangent,outTangent:a.outTangent,interpolation:a.interpolation};n.push(l)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._numActiveAnimatables&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,r,n){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let o=0;o<this._targetedAnimations.length;o++){let a=this._targetedAnimations[o],l=this._scene.beginDirectAnimation(a.target,[a.animation],i!==void 0?i:this._from,r!==void 0?r:this._to,e,t,void 0,void 0,n!==void 0?n:this._isAdditive);l.weight=this._weight,l.playOrder=this._playOrder,l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(a),this._checkAnimationGroupEnded(l)},this._processLoop(l,a,o),this._animatables.push(l)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(e!==void 0&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.syncWithMask(),this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this._isStarted)return this;let e=this._animatables.slice();for(let i=0;i<e.length;i++)e[i].stop(void 0,void 0,!0);let t=0;for(let i=0;i<this._scene._activeAnimatables.length;i++){let r=this._scene._activeAnimatables[i];r._runtimeAnimations.length>0&&(this._scene._activeAnimatables[t++]=r)}return this._scene._activeAnimatables.length=t,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++){let i=this._animatables[t];i.weight=e}return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}dispose(){this._targetedAnimations.length=0,this._animatables.length=0;let e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){let t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e){let t=this._animatables.indexOf(e);t>-1&&this._animatables.splice(t,1),this._animatables.length===0&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){let r=new s(e||this.name,this._scene,this._weight,this._playOrder);r._from=this.from,r._to=this.to,r._speedRatio=this.speedRatio,r._loopAnimation=this.loopAnimation,r._isAdditive=this.isAdditive,r._enableBlending=this.enableBlending,r._blendingSpeed=this.blendingSpeed,r.metadata=this.metadata,r.mask=this.mask;for(let n of this._targetedAnimations)r.addTargetedAnimation(i?n.animation.clone():n.animation,t?t(n.target):n.target);return r}serialize(){let e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){let i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return di&&di.HasTags(this)&&(e.tags=di.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){let i=new s(e.name,t,e.weight,e.playOrder);for(let r=0;r<e.targetedAnimations.length;r++){let n=e.targetedAnimations[r],o=te.Parse(n.animation),a=n.targetId;if(n.animation.property==="influence"){let l=t.getMorphTargetById(a);l&&i.addTargetedAnimation(o,l)}else{let l=t.getNodeById(a);l!=null&&i.addTargetedAnimation(o,l)}}return di&&di.AddTagsTo(i,e.tags),e.from!==null&&e.to!==null&&i.normalize(e.from,e.to),e.speedRatio!==void 0&&(i._speedRatio=e.speedRatio),e.loopAnimation!==void 0&&(i._loopAnimation=e.loopAnimation),e.isAdditive!==void 0&&(i._isAdditive=e.isAdditive),e.weight!==void 0&&(i._weight=e.weight),e.playOrder!==void 0&&(i._playOrder=e.playOrder),e.enableBlending!==void 0&&(i._enableBlending=e.enableBlending),e.blendingSpeed!==void 0&&(i._blendingSpeed=e.blendingSpeed),e.metadata!==void 0&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t,i,r=!1,n){let o;typeof t=="object"?o=t:o={referenceFrame:t,range:i,cloneOriginalAnimationGroup:r,clonedAnimationName:n};let a=e;o.cloneOriginalAnimationGroup&&(a=e.clone(o.clonedAnimationGroupName||a.name));let l=a.targetedAnimations;for(let c=0;c<l.length;c++){let h=l[c];h.animation=te.MakeAnimationAdditive(h.animation,o)}if(a.isAdditive=!0,o.clipKeys){let c=Number.MAX_VALUE,h=-Number.MAX_VALUE,u=a.targetedAnimations;for(let d=0;d<u.length;d++){let g=u[d].animation.getKeys();c>g[0].frame&&(c=g[0].frame),h<g[g.length-1].frame&&(h=g[g.length-1].frame)}a._from=c,a._to=h}return a}static ClipKeys(e,t,i,r,n){let o=e.clone(r||e.name);return s.ClipKeysInPlace(o,t,i,n)}static ClipKeysInPlace(e,t,i,r){return s.ClipInPlace(e,t,i,r,!1)}static ClipFrames(e,t,i,r,n){let o=e.clone(r||e.name);return s.ClipFramesInPlace(o,t,i,n)}static ClipFramesInPlace(e,t,i,r){return s.ClipInPlace(e,t,i,r,!0)}static ClipInPlace(e,t,i,r,n=!1){let o=Number.MAX_VALUE,a=-Number.MAX_VALUE,l=e.targetedAnimations;for(let c=0;c<l.length;c++){let h=l[c],u=r?h.animation:h.animation.clone();n&&(u.createKeyForFrame(t),u.createKeyForFrame(i));let d=u.getKeys(),f=[],m=Number.MAX_VALUE;for(let g=0;g<d.length;g++){let _=d[g];if(!n&&g>=t&&g<=i||n&&_.frame>=t&&_.frame<=i){let x={frame:_.frame,value:_.value.clone?_.value.clone():_.value,inTangent:_.inTangent,outTangent:_.outTangent,interpolation:_.interpolation,lockedTangent:_.lockedTangent};m===Number.MAX_VALUE&&(m=x.frame),x.frame-=m,f.push(x)}}if(f.length===0){l.splice(c,1),c--;continue}o>f[0].frame&&(o=f[0].frame),a<f[f.length-1].frame&&(a=f[f.length-1].frame),u.setKeys(f,!0),h.animation=u}return e._from=o,e._to=a,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}};function Xp(s,e,t){try{let i=s.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function $1(s=25){let e;return(t,i,r)=>{let n=performance.now();e===void 0||n-e>s?(e=n,setTimeout(()=>{Xp(t,i,r)},0)):Xp(t,i,r)}}function j1(s,e,t,i,r){let n=()=>{let o,a=l=>{l.done?t(l.value):o===void 0?o=!0:n()};do o=void 0,!r||!r.aborted?e(s,a,i):i(new Error("Aborted")),o===void 0&&(o=!1);while(o)};n()}function Yp(s,e){let t;return j1(s,Xp,i=>t=i,i=>{throw i},e),t}function wx(s,e,t){return new Promise((i,r)=>{j1(s,e,i,r,t)})}function q1(s,e){return(...t)=>Yp(s(...t),e)}var Dr=class s{constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}toGlobal(e,t){return new s(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new s(this.x,this.y,this.width,this.height)}};var Ce=class s extends Xe{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){let e=0,t=0;if(this.mode===s.PERSPECTIVE_CAMERA)this.fovMode===s.FOVMODE_VERTICAL_FIXED?(t=this.minZ*2*Math.tan(this.fov/2),e=this.getEngine().getAspectRatio(this)*t):(e=this.minZ*2*Math.tan(this.fov/2),t=e/this.getEngine().getAspectRatio(this));else{let i=this.getEngine().getRenderWidth()/2,r=this.getEngine().getRenderHeight()/2;e=(this.orthoRight??i)-(this.orthoLeft??-i),t=(this.orthoTop??r)-(this.orthoBottom??-r)}return e*t}set orthoLeft(e){this._orthoLeft=e;for(let t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(let t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(let t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(let t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(let t of this._rigCameras)t.mode=e}get mode(){return this._mode}get hasMoved(){return this._hasMoved}constructor(e,t,i,r=!0){super(e,i,!1),this._position=p.Zero(),this._upVector=p.Up(),this.oblique=null,this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=s.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new Dr(0,0,1,1),this.layerMask=268435455,this.fovMode=s.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=s.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new U,this.onProjectionMatrixChangedObservable=new U,this.onAfterCheckInputsObservable=new U,this.onRestoreStateObservable=new U,this.isRigCamera=!1,this._hasMoved=!1,this._rigCameras=new Array,this._skipRendering=!1,this._projectionMatrix=new N,this._postProcesses=new Array,this._activeMeshes=new _i(256),this._globalPosition=p.Zero(),this._computedViewMatrix=N.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=N.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=q.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),r&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){let e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(let t of this._postProcesses)if(t&&!t.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.obliqueAngle=void 0,this._cache.obliqueLength=void 0,this._cache.obliqueOffset=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;let t=this.getEngine();return this.mode===s.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:(e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),this.oblique&&(e=e&&this._cache.obliqueAngle===this.oblique.angle&&this._cache.obliqueLength===this.oblique.length&&this._cache.obliqueOffset===this.oblique.offset)),e}attachControl(e,t){}detachControl(e){}update(){this._hasMoved=!1,this._checkInputs(),this.cameraRigMode!==s.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){let e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let t=0,i=this._rigCameras.length;t<i;t++){let r=this._rigCameras[t],n=r._rigPostProcess;n?(n.getEffectName()==="pass"&&(r.isIntermediate=this._postProcesses.length===0),r._postProcesses=this._postProcesses.slice(0).concat(n),n.markTextureDirty()):r._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(F.Error("You're trying to reuse a post process not defined as reusable."),0):(t==null||t<0?this._postProcesses.push(e):this._postProcesses[t]===null?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){let t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)}_getViewMatrix(){return N.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this._hasMoved=!0,this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;let t=this.getEngine(),i=this.getScene(),r=t.useReverseDepthBuffer;if(this.mode===s.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=t.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);let n;i.useRightHandedSystem?n=N.PerspectiveFovRHToRef:n=N.PerspectiveFovLHToRef,n(this.fov,t.getAspectRatio(this),r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===s.FOVMODE_VERTICAL_FIXED,t.isNDCHalfZRange,this.projectionPlaneTilt,r)}else{let n=t.getRenderWidth()/2,o=t.getRenderHeight()/2;i.useRightHandedSystem?this.oblique?N.ObliqueOffCenterRHToRef(this.orthoLeft??-n,this.orthoRight??n,this.orthoBottom??-o,this.orthoTop??o,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):N.OrthoOffCenterRHToRef(this.orthoLeft??-n,this.orthoRight??n,this.orthoBottom??-o,this.orthoTop??o,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange):this.oblique?N.ObliqueOffCenterLHToRef(this.orthoLeft??-n,this.orthoRight??n,this.orthoBottom??-o,this.orthoTop??o,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this.oblique.length,this.oblique.angle,this._computeObliqueDistance(this.oblique.offset),this._projectionMatrix,t.isNDCHalfZRange):N.OrthoOffCenterLHToRef(this.orthoLeft??-n,this.orthoRight??n,this.orthoBottom??-o,this.orthoTop??o,r?this.maxZ:this.minZ,r?this.minZ:this.maxZ,this._projectionMatrix,t.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.obliqueAngle=this.oblique?.angle,this._cache.obliqueLength=this.oblique?.length,this._cache.obliqueOffset=this.oblique?.offset,this._cache.renderWidth=t.getRenderWidth(),this._cache.renderHeight=t.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_computeObliqueDistance(e){let t=this,i=this;return(t.radius||(i.target?p.Distance(this.position,i.target):this.position.length()))+e}_updateFrustumPlanes(){this._refreshFrustumPlanes&&(this.getTransformationMatrix(),this._frustumPlanes?ea.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=ea.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let i=!1;return this.rigCameras.forEach(r=>{r._updateFrustumPlanes(),i=i||e.isInFrustum(r._frustumPlanes)}),i}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw We("Ray")}getForwardRayToRef(e,t=100,i,r){throw We("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){let r=this._rigCameras.pop();r&&r.dispose()}if(this._parentContainer){let r=this._parentContainer.cameras.indexOf(this);r>-1&&this._parentContainer.cameras.splice(r,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==s.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let r=this._postProcesses.length;for(;--r>=0;){let n=this._postProcesses[r];n&&n.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){let i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=H.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==s.RIG_MODE_NONE){let i=this.createRigCamera(this.name+"_L",0);i&&(i._isLeftCamera=!0);let r=this.createRigCamera(this.name+"_R",1);r&&(r._isRightCamera=!0),i&&r&&(this._rigCameras.push(i),this._rigCameras.push(r))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return N.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,e==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=H.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===s.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){let e=ae.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),ae.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){let i=ae.Clone(s.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){let t=p.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){p.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,r=0,n=!0){let o=Xe.Construct(e,t,i,{interaxial_distance:r,isStereoscopicSideBySide:n});return o||(()=>s._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){let i=e.type,r=s.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),n=ae.Parse(r,e,t);if(e.parentId!==void 0&&(n._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(n._waitingParentInstanceIndex=e.parentInstanceIndex),n.inputs&&(n.inputs.parse(e),n._setupInputs()),e.upVector&&(n.upVector=p.FromArray(e.upVector)),n.setPosition&&(n.position.copyFromFloats(0,0,0),n.setPosition(p.FromArray(e.position))),e.target&&n.setTarget&&n.setTarget(p.FromArray(e.target)),e.cameraRigMode){let o=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};n.setCameraRigMode(e.cameraRigMode,o)}if(e.animations){for(let o=0;o<e.animations.length;o++){let a=e.animations[o],l=Et("BABYLON.Animation");l&&n.animations.push(l.Parse(a))}Xe.ParseAnimationRanges(n,e,t)}return e.autoAnimate&&t.beginAnimation(n,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&n.setEnabled(e.isEnabled),n}_calculateHandednessMultiplier(){let e=this.getScene().useRightHandedSystem?-1:1;return this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}};Ce._CreateDefaultParsedCamera=(s,e)=>{throw We("UniversalCamera")};Ce.PERSPECTIVE_CAMERA=0;Ce.ORTHOGRAPHIC_CAMERA=1;Ce.FOVMODE_VERTICAL_FIXED=0;Ce.FOVMODE_HORIZONTAL_FIXED=1;Ce.RIG_MODE_NONE=0;Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;Ce.RIG_MODE_STEREOSCOPIC_INTERLACED=14;Ce.RIG_MODE_VR=20;Ce.RIG_MODE_CUSTOM=22;Ce.ForceAttachControlToAlwaysPreventDefault=!1;v([mi("position")],Ce.prototype,"_position",void 0);v([mi("upVector")],Ce.prototype,"_upVector",void 0);v([I()],Ce.prototype,"orthoLeft",null);v([I()],Ce.prototype,"orthoRight",null);v([I()],Ce.prototype,"orthoBottom",null);v([I()],Ce.prototype,"orthoTop",null);v([I()],Ce.prototype,"fov",void 0);v([I()],Ce.prototype,"projectionPlaneTilt",void 0);v([I()],Ce.prototype,"minZ",void 0);v([I()],Ce.prototype,"maxZ",void 0);v([I()],Ce.prototype,"inertia",void 0);v([I()],Ce.prototype,"mode",null);v([I()],Ce.prototype,"layerMask",void 0);v([I()],Ce.prototype,"fovMode",void 0);v([I()],Ce.prototype,"cameraRigMode",void 0);v([I()],Ce.prototype,"interaxialDistance",void 0);v([I()],Ce.prototype,"isStereoscopicSideBySide",void 0);var $c=class{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}};var Co=class s{constructor(e,t,i){this.vectors=Ir.BuildArray(8,p.Zero),this.center=p.Zero(),this.centerWorld=p.Zero(),this.extendSize=p.Zero(),this.extendSizeWorld=p.Zero(),this.directions=Ir.BuildArray(3,p.Zero),this.vectorsWorld=Ir.BuildArray(8,p.Zero),this.minimumWorld=p.Zero(),this.maximumWorld=p.Zero(),this.minimum=p.Zero(),this.maximum=p.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){let r=e.x,n=e.y,o=e.z,a=t.x,l=t.y,c=t.z,h=this.vectors;this.minimum.copyFromFloats(r,n,o),this.maximum.copyFromFloats(a,l,c),h[0].copyFromFloats(r,n,o),h[1].copyFromFloats(a,l,c),h[2].copyFromFloats(a,n,o),h[3].copyFromFloats(r,l,o),h[4].copyFromFloats(r,n,c),h[5].copyFromFloats(a,l,o),h[6].copyFromFloats(r,l,c),h[7].copyFromFloats(a,n,c),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||N.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){let t=s._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),r=i.length();i.normalizeFromLength(r);let n=r*e,o=i.scaleInPlace(n*.5),a=this.center.subtractToRef(o,t[1]),l=this.center.addToRef(o,t[2]);return this.reConstruct(a,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){let t=this.minimumWorld,i=this.maximumWorld,r=this.directions,n=this.vectorsWorld,o=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let a=0;a<8;++a)n[a].copyFrom(o[a]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let a=0;a<8;++a){let l=n[a];p.TransformCoordinatesToRef(o[a],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}p.FromArrayToRef(e.m,0,r[0]),p.FromArrayToRef(e.m,4,r[1]),p.FromArrayToRef(e.m,8,r[2]),this._worldMatrix=e}isInFrustum(e){return s.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return s.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){let t=this.minimumWorld,i=this.maximumWorld,r=t.x,n=t.y,o=t.z,a=i.x,l=i.y,c=i.z,h=e.x,u=e.y,d=e.z,f=-je;return!(a-h<f||f>h-r||l-u<f||f>u-n||c-d<f||f>d-o)}intersectsSphere(e){return s.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){let i=this.minimumWorld,r=this.maximumWorld,n=i.x,o=i.y,a=i.z,l=r.x,c=r.y,h=r.z,u=e.x,d=e.y,f=e.z,m=t.x,g=t.y,_=t.z;return!(l<u||n>m||c<d||o>g||h<f||a>_)}dispose(){this._drawWrapperFront?.dispose(),this._drawWrapperBack?.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,r){let n=s._TmpVector3[0];return p.ClampToRef(i,e,t,n),p.DistanceSquared(i,n)<=r*r}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){let r=t[i];for(let n=0;n<8;++n)if(r.dotCoordinate(e[n])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let r=!0,n=t[i];for(let o=0;o<8;++o)if(n.dotCoordinate(e[o])>=0){r=!1;break}if(r)return!1}return!0}};Co._TmpVector3=Ir.BuildArray(3,p.Zero);var ta=class s{constructor(e,t,i){this.center=p.Zero(),this.centerWorld=p.Zero(),this.minimum=p.Zero(),this.maximum=p.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);let r=p.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=r*.5,this._update(i||N.IdentityReadOnly)}scale(e){let t=this.radius*e,i=s._TmpVector3,r=i[0].setAll(t),n=this.center.subtractToRef(r,i[1]),o=this.center.addToRef(r,i[2]);return this.reConstruct(n,o,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{p.TransformCoordinatesToRef(this.center,e,this.centerWorld);let t=s._TmpVector3[0];p.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){let t=this.centerWorld,i=this.radiusWorld;for(let r=0;r<6;r++)if(e[r].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){let t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){let t=p.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){let i=p.DistanceSquared(e.centerWorld,t.centerWorld),r=e.radiusWorld+t.radiusWorld;return!(r*r<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);let r=new s(this._TmpVector3[0],this._TmpVector3[2]);return i?r._worldMatrix=i:r._worldMatrix=N.Identity(),r}};ta._TmpVector3=Ir.BuildArray(3,p.Zero);var fI={min:0,max:0},pI={min:0,max:0},Q1=(s,e,t)=>{let i=p.Dot(e.centerWorld,s),r=Math.abs(p.Dot(e.directions[0],s))*e.extendSize.x,n=Math.abs(p.Dot(e.directions[1],s))*e.extendSize.y,o=Math.abs(p.Dot(e.directions[2],s))*e.extendSize.z,a=r+n+o;t.min=i-a,t.max=i+a},Ns=(s,e,t)=>(Q1(s,e,fI),Q1(s,t,pI),!(fI.min>pI.max||pI.min>fI.max)),dr=class s{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new Co(e,t,i),this.boundingSphere=new ta(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){let i=s._TmpVector3[0].copyFrom(e).subtractInPlace(t),r=s._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,r,this.boundingBox.getWorldMatrix()),this}encapsulate(e){let t=p.Minimize(this.minimum,e),i=p.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){let t=O.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);let i=O.Vector3[0];return p.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,i),this.encapsulate(i),p.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,i),this.encapsulate(i),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return(t===2||t===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?t===1||t===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){let e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,s._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!ta.Intersects(this.boundingSphere,e.boundingSphere)||!Co.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;let i=this.boundingBox,r=e.boundingBox;return!(!Ns(i.directions[0],i,r)||!Ns(i.directions[1],i,r)||!Ns(i.directions[2],i,r)||!Ns(r.directions[0],i,r)||!Ns(r.directions[1],i,r)||!Ns(r.directions[2],i,r)||!Ns(p.Cross(i.directions[0],r.directions[0]),i,r)||!Ns(p.Cross(i.directions[0],r.directions[1]),i,r)||!Ns(p.Cross(i.directions[0],r.directions[2]),i,r)||!Ns(p.Cross(i.directions[1],r.directions[0]),i,r)||!Ns(p.Cross(i.directions[1],r.directions[1]),i,r)||!Ns(p.Cross(i.directions[1],r.directions[2]),i,r)||!Ns(p.Cross(i.directions[2],r.directions[0]),i,r)||!Ns(p.Cross(i.directions[2],r.directions[1]),i,r)||!Ns(p.Cross(i.directions[2],r.directions[2]),i,r))}};dr._TmpVector3=Ir.BuildArray(2,p.Zero);var dd=class{static extractMinAndMaxIndexed(e,t,i,r,n,o){for(let a=i;a<i+r;a++){let l=t[a]*3,c=e[l],h=e[l+1],u=e[l+2];n.minimizeInPlaceFromFloats(c,h,u),o.maximizeInPlaceFromFloats(c,h,u)}}static extractMinAndMax(e,t,i,r,n,o){for(let a=t,l=t*r;a<t+i;a++,l+=r){let c=e[l],h=e[l+1],u=e[l+2];n.minimizeInPlaceFromFloats(c,h,u),o.maximizeInPlaceFromFloats(c,h,u)}}};v([bl.filter((...[s,e])=>!Array.isArray(s)&&!Array.isArray(e))],dd,"extractMinAndMaxIndexed",null);v([bl.filter((...[s])=>!Array.isArray(s))],dd,"extractMinAndMax",null);function K1(s,e,t,i,r=null){let n=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new p(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return dd.extractMinAndMaxIndexed(s,e,t,i,n,o),r&&(n.x-=n.x*r.x+r.y,n.y-=n.y*r.x+r.y,n.z-=n.z*r.x+r.y,o.x+=o.x*r.x+r.y,o.y+=o.y*r.x+r.y,o.z+=o.z*r.x+r.y),{minimum:n,maximum:o}}function ja(s,e,t,i=null,r){let n=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new p(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return r||(r=3),dd.extractMinAndMax(s,e,t,r,n,o),i&&(n.x-=n.x*i.x+i.y,n.y-=n.y*i.x+i.y,n.z-=n.z*i.x+i.y,o.x+=o.x*i.x+i.y,o.y+=o.y*i.x+i.y,o.z+=o.z*i.x+i.y),{minimum:n,maximum:o}}var Xt=class{static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!0,this._wasPreviouslyUsingInstances=null,this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,i=!0){this.effect=e,t!==void 0&&(this.defines=t),i&&this.drawContext?.reset()}dispose(){this.drawContext?.dispose()}};var Wi=class s{get materialDefines(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:this._getDrawWrapper()?.defines}set materialDefines(e){let t=this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0);t.defines=e}_getDrawWrapper(e,t=!1){e=e??this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new Xt(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){t&&this._drawWrappers[e]?.dispose(),this._drawWrappers[e]=void 0}get effect(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:this._getDrawWrapper()?.effect??null}get _drawWrapper(){return this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,r=!0){let n=this._drawWrapper;n.setEffect(e,t,r),i!==void 0&&(n.materialContext=i),e||(n.defines=null,n.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e);return}else for(let t of this._drawWrappers)t?.dispose();this._drawWrappers=[]}static AddToMesh(e,t,i,r,n,o,a,l=!0){return new s(e,t,i,r,n,o,a,l)}constructor(e,t,i,r,n,o,a,l=!0,c=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=r,this.indexCount=n,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=o,this._renderingMesh=a||o,c&&o.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=o.subMeshes.length-1,l&&(this.refreshBoundingInfo(),o.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal||this._mesh.hasThinInstances?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){let e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){let t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId)??this._renderingMesh.material;if(t){if(this._isMultiMaterial(t)){let i=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==i&&(this._currentMaterial=i,this.resetDrawCache()),i}}else return e?this._mesh.getScene().defaultMaterial:null;return t}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(y.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;let t=this._renderingMesh.getIndices(),i;if(this.indexStart===0&&this.indexCount===t.length){let r=this._renderingMesh.getBoundingInfo();i={minimum:r.minimum.clone(),maximum:r.maximum.clone()}}else i=K1(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new dr(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){let t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){let t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){let i=[];for(let r=this.indexStart;r<this.indexStart+this.indexCount;r+=3)i.push(e[r],e[r+1],e[r+1],e[r+2],e[r+2],e[r]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){let t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,i,r,n){let o=this.getMaterial();if(!o)return null;let a=3,l=!1;switch(o.fillMode){case 3:case 5:case 6:case 8:return null;case 7:a=1,l=!0;break;default:break}return o.fillMode===4?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,r):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,r):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,r,n):this._intersectTriangles(e,t,i,a,l,r,n)}_intersectLines(e,t,i,r,n){let o=null;for(let a=this.indexStart;a<this.indexStart+this.indexCount;a+=2){let l=t[i[a]],c=t[i[a+1]],h=e.intersectionSegment(l,c,r);if(!(h<0)&&(n||!o||h<o.distance)&&(o=new $c(null,null,h),o.faceId=a/2,n))break}return o}_intersectUnIndexedLines(e,t,i,r,n){let o=null;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=2){let l=t[a],c=t[a+1],h=e.intersectionSegment(l,c,r);if(!(h<0)&&(n||!o||h<o.distance)&&(o=new $c(null,null,h),o.faceId=a/2,n))break}return o}_intersectTriangles(e,t,i,r,n,o,a){let l=null,c=-1;for(let h=this.indexStart;h<this.indexStart+this.indexCount-(3-r);h+=r){c++;let u=i[h],d=i[h+1],f=i[h+2];if(n&&f===4294967295){h+=2;continue}let m=t[u],g=t[d],_=t[f];if(!m||!g||!_||a&&!a(m,g,_,e,u,d,f))continue;let x=e.intersectsTriangle(m,g,_);if(x){if(x.distance<0)continue;if((o||!l||x.distance<l.distance)&&(l=x,l.faceId=c,o))break}}return l}_intersectUnIndexedTriangles(e,t,i,r,n){let o=null;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=3){let l=t[a],c=t[a+1],h=t[a+2];if(n&&!n(l,c,h,e,-1,-1,-1))continue;let u=e.intersectsTriangle(l,c,h);if(u){if(u.distance<0)continue;if((r||!o||u.distance<o.distance)&&(o=u,o.faceId=a/3,r))break}}return o}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){let i=new s(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){let r=this.getBoundingInfo();if(!r)return i;i._boundingInfo=new dr(r.minimum,r.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);let e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,r,n,o=!0){let a=Number.MAX_VALUE,l=-Number.MAX_VALUE,h=(n||r).getIndices();for(let u=t;u<t+i;u++){let d=h[u];d<a&&(a=d),d>l&&(l=d)}return new s(e,a,l-a+1,t,i,r,n,o)}};var jc=class{},le=class s{constructor(){this.uniqueId=0,this.metadata={},this._applyTo=q1(this._applyToCoroutine.bind(this)),this.uniqueId=s._UniqueIDGenerator,s._UniqueIDGenerator++}set(e,t){switch(e.length||F.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case y.PositionKind:this.positions=e;break;case y.NormalKind:this.normals=e;break;case y.TangentKind:this.tangents=e;break;case y.UVKind:this.uvs=e;break;case y.UV2Kind:this.uvs2=e;break;case y.UV3Kind:this.uvs3=e;break;case y.UV4Kind:this.uvs4=e;break;case y.UV5Kind:this.uvs5=e;break;case y.UV6Kind:this.uvs6=e;break;case y.ColorKind:this.colors=e;break;case y.MatricesIndicesKind:this.matricesIndices=e;break;case y.MatricesWeightsKind:this.matricesWeights=e;break;case y.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case y.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){if(this.positions&&(e.setVerticesData(y.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(y.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(y.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(y.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(y.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(y.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(y.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(y.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(y.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(y.ColorKind,this.colors,t),this.hasVertexAlpha&&e.hasVertexAlpha!==void 0&&(e.hasVertexAlpha=!0),i&&(yield)),this.matricesIndices&&(e.setVerticesData(y.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(y.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(y.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(y.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),e.subMeshes&&this.materialInfos&&this.materialInfos.length>1){let r=e;r.subMeshes=[];for(let n of this.materialInfos)new Wi(n.materialIndex,n.verticesStart,n.verticesCount,n.indexStart,n.indexCount,r)}return this}_update(e,t,i){return this.positions&&e.updateVerticesData(y.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(y.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(y.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(y.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(y.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(y.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(y.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(y.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(y.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(y.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(y.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(y.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(y.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(y.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,r=e.length){let n=O.Vector3[0],o=O.Vector3[1];for(let a=i;a<i+r;a+=3)p.FromArrayToRef(e,a,n),p.TransformCoordinatesToRef(n,t,o),e[a]=o.x,e[a+1]=o.y,e[a+2]=o.z}static _TransformVector3Normals(e,t,i=0,r=e.length){let n=O.Vector3[0],o=O.Vector3[1];for(let a=i;a<i+r;a+=3)p.FromArrayToRef(e,a,n),p.TransformNormalToRef(n,t,o),e[a]=o.x,e[a+1]=o.y,e[a+2]=o.z}static _TransformVector4Normals(e,t,i=0,r=e.length){let n=O.Vector4[0],o=O.Vector4[1];for(let a=i;a<i+r;a+=4)De.FromArrayToRef(e,a,n),De.TransformNormalToRef(n,t,o),e[a]=o.x,e[a+1]=o.y,e[a+2]=o.z,e[a+3]=o.w}static _FlipFaces(e,t=0,i=e.length){for(let r=t;r<t+i;r+=3){let n=e[r+1];e[r+1]=e[r+2],e[r+2]=n}}transform(e){let t=e.determinant()<0;return this.positions&&s._TransformVector3Coordinates(this.positions,e),this.normals&&s._TransformVector3Normals(this.normals,e),this.tangents&&s._TransformVector4Normals(this.tangents,e),t&&this.indices&&s._FlipFaces(this.indices),this}splitBasedOnMaterialID(){if(!this.materialInfos||this.materialInfos.length<2)return[this];let e=[];for(let t of this.materialInfos){let i=new s;if(this.positions&&(i.positions=this.positions.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.normals&&(i.normals=this.normals.slice(t.verticesStart*3,(t.verticesCount+t.verticesStart)*3)),this.tangents&&(i.tangents=this.tangents.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.colors&&(i.colors=this.colors.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.uvs&&(i.uvs=this.uvs.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs2&&(i.uvs2=this.uvs2.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs3&&(i.uvs3=this.uvs3.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs4&&(i.uvs4=this.uvs4.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs5&&(i.uvs5=this.uvs5.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.uvs6&&(i.uvs6=this.uvs6.slice(t.verticesStart*2,(t.verticesCount+t.verticesStart)*2)),this.matricesIndices&&(i.matricesIndices=this.matricesIndices.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesIndicesExtra&&(i.matricesIndicesExtra=this.matricesIndicesExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeights&&(i.matricesWeights=this.matricesWeights.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.matricesWeightsExtra&&(i.matricesWeightsExtra=this.matricesWeightsExtra.slice(t.verticesStart*4,(t.verticesCount+t.verticesStart)*4)),this.indices){i.indices=[];for(let n=t.indexStart;n<t.indexStart+t.indexCount;n++)i.indices.push(this.indices[n]-t.verticesStart)}let r=new jc;r.indexStart=0,r.indexCount=i.indices?i.indices.length:0,r.materialIndex=t.materialIndex,r.verticesStart=0,r.verticesCount=(i.positions?i.positions.length:0)/3,i.materialInfos=[r],e.push(i)}return e}merge(e,t=!1,i=!1,r=!1,n=!1){let o=Array.isArray(e)?e.map(a=>({vertexData:a})):[{vertexData:e}];return Yp(this._mergeCoroutine(void 0,o,t,!1,i,r,n))}*_mergeCoroutine(e,t,i=!1,r,n,o=!1,a=!1){this._validate();let l=t.map(f=>f.vertexData),c=this;if(a)for(let f of l)f&&(f._validate(),!this.normals&&f.normals&&(this.normals=new Float32Array(this.positions.length)),!this.tangents&&f.tangents&&(this.tangents=new Float32Array(this.positions.length/3*4)),!this.uvs&&f.uvs&&(this.uvs=new Float32Array(this.positions.length/3*2)),!this.uvs2&&f.uvs2&&(this.uvs2=new Float32Array(this.positions.length/3*2)),!this.uvs3&&f.uvs3&&(this.uvs3=new Float32Array(this.positions.length/3*2)),!this.uvs4&&f.uvs4&&(this.uvs4=new Float32Array(this.positions.length/3*2)),!this.uvs5&&f.uvs5&&(this.uvs5=new Float32Array(this.positions.length/3*2)),!this.uvs6&&f.uvs6&&(this.uvs6=new Float32Array(this.positions.length/3*2)),!this.colors&&f.colors&&(this.colors=new Float32Array(this.positions.length/3*4),this.colors.fill(1)),!this.matricesIndices&&f.matricesIndices&&(this.matricesIndices=new Float32Array(this.positions.length/3*4)),!this.matricesWeights&&f.matricesWeights&&(this.matricesWeights=new Float32Array(this.positions.length/3*4)),!this.matricesIndicesExtra&&f.matricesIndicesExtra&&(this.matricesIndicesExtra=new Float32Array(this.positions.length/3*4)),!this.matricesWeightsExtra&&f.matricesWeightsExtra&&(this.matricesWeightsExtra=new Float32Array(this.positions.length/3*4)));for(let f of l)if(f){if(a)this.normals&&!f.normals&&(f.normals=new Float32Array(f.positions.length)),this.tangents&&!f.tangents&&(f.tangents=new Float32Array(f.positions.length/3*4)),this.uvs&&!f.uvs&&(f.uvs=new Float32Array(f.positions.length/3*2)),this.uvs2&&!f.uvs2&&(f.uvs2=new Float32Array(f.positions.length/3*2)),this.uvs3&&!f.uvs3&&(f.uvs3=new Float32Array(f.positions.length/3*2)),this.uvs4&&!f.uvs4&&(f.uvs4=new Float32Array(f.positions.length/3*2)),this.uvs5&&!f.uvs5&&(f.uvs5=new Float32Array(f.positions.length/3*2)),this.uvs6&&!f.uvs6&&(f.uvs6=new Float32Array(f.positions.length/3*2)),this.colors&&!f.colors&&(f.colors=new Float32Array(f.positions.length/3*4),f.colors.fill(1)),this.matricesIndices&&!f.matricesIndices&&(f.matricesIndices=new Float32Array(f.positions.length/3*4)),this.matricesWeights&&!f.matricesWeights&&(f.matricesWeights=new Float32Array(f.positions.length/3*4)),this.matricesIndicesExtra&&!f.matricesIndicesExtra&&(f.matricesIndicesExtra=new Float32Array(f.positions.length/3*4)),this.matricesWeightsExtra&&!f.matricesWeightsExtra&&(f.matricesWeightsExtra=new Float32Array(f.positions.length/3*4));else if(f._validate(),!this.normals!=!f.normals||!this.tangents!=!f.tangents||!this.uvs!=!f.uvs||!this.uvs2!=!f.uvs2||!this.uvs3!=!f.uvs3||!this.uvs4!=!f.uvs4||!this.uvs5!=!f.uvs5||!this.uvs6!=!f.uvs6||!this.colors!=!f.colors||!this.matricesIndices!=!f.matricesIndices||!this.matricesWeights!=!f.matricesWeights||!this.matricesIndicesExtra!=!f.matricesIndicesExtra||!this.matricesWeightsExtra!=!f.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes")}if(o){let f=0,m=0,g=0,_=[],x=null,b=[];for(let R of this.splitBasedOnMaterialID())b.push({vertexData:R,transform:e});for(let R of t)if(R.vertexData)for(let E of R.vertexData.splitBasedOnMaterialID())b.push({vertexData:E,transform:R.transform});b.sort((R,E)=>{let S=R.vertexData.materialInfos?R.vertexData.materialInfos[0].materialIndex:0,A=E.vertexData.materialInfos?E.vertexData.materialInfos[0].materialIndex:0;return S>A?1:S===A?0:-1});for(let R of b){let E=R.vertexData;if(E.materialInfos?f=E.materialInfos[0].materialIndex:f=0,x&&x.materialIndex===f)x.indexCount+=E.indices.length,x.verticesCount+=E.positions.length/3;else{let S=new jc;S.materialIndex=f,S.indexStart=m,S.indexCount=E.indices.length,S.verticesStart=g,S.verticesCount=E.positions.length/3,_.push(S),x=S}m+=E.indices.length,g+=E.positions.length/3}let C=b.splice(0,1)[0];c=C.vertexData,e=C.transform,l=b.map(R=>R.vertexData),t=b,this.materialInfos=_}let h=l.reduce((f,m)=>f+(m.indices?.length??0),c.indices?.length??0),d=n||l.some(f=>f.indices===c.indices)?c.indices?.slice():c.indices;if(h>0){let f=d?.length??0;if(d||(d=new Array(h)),d.length!==h){if(Array.isArray(d))d.length=h;else{let g=i||d instanceof Uint32Array?new Uint32Array(h):new Uint16Array(h);g.set(d),d=g}e&&e.determinant()<0&&s._FlipFaces(d,0,f)}let m=c.positions?c.positions.length/3:0;for(let{vertexData:g,transform:_}of t)if(g.indices){for(let x=0;x<g.indices.length;x++)d[f+x]=g.indices[x]+m;_&&_.determinant()<0&&s._FlipFaces(d,f,g.indices.length),m+=g.positions.length/3,f+=g.indices.length,r&&(yield)}}return this.indices=d,this.positions=s._MergeElement(y.PositionKind,c.positions,e,t.map(f=>[f.vertexData.positions,f.transform])),r&&(yield),c.normals&&(this.normals=s._MergeElement(y.NormalKind,c.normals,e,t.map(f=>[f.vertexData.normals,f.transform])),r&&(yield)),c.tangents&&(this.tangents=s._MergeElement(y.TangentKind,c.tangents,e,t.map(f=>[f.vertexData.tangents,f.transform])),r&&(yield)),c.uvs&&(this.uvs=s._MergeElement(y.UVKind,c.uvs,e,t.map(f=>[f.vertexData.uvs,f.transform])),r&&(yield)),c.uvs2&&(this.uvs2=s._MergeElement(y.UV2Kind,c.uvs2,e,t.map(f=>[f.vertexData.uvs2,f.transform])),r&&(yield)),c.uvs3&&(this.uvs3=s._MergeElement(y.UV3Kind,c.uvs3,e,t.map(f=>[f.vertexData.uvs3,f.transform])),r&&(yield)),c.uvs4&&(this.uvs4=s._MergeElement(y.UV4Kind,c.uvs4,e,t.map(f=>[f.vertexData.uvs4,f.transform])),r&&(yield)),c.uvs5&&(this.uvs5=s._MergeElement(y.UV5Kind,c.uvs5,e,t.map(f=>[f.vertexData.uvs5,f.transform])),r&&(yield)),c.uvs6&&(this.uvs6=s._MergeElement(y.UV6Kind,c.uvs6,e,t.map(f=>[f.vertexData.uvs6,f.transform])),r&&(yield)),c.colors&&(this.colors=s._MergeElement(y.ColorKind,c.colors,e,t.map(f=>[f.vertexData.colors,f.transform])),(c.hasVertexAlpha!==void 0||t.some(f=>f.vertexData.hasVertexAlpha!==void 0))&&(this.hasVertexAlpha=c.hasVertexAlpha||t.some(f=>f.vertexData.hasVertexAlpha)),r&&(yield)),c.matricesIndices&&(this.matricesIndices=s._MergeElement(y.MatricesIndicesKind,c.matricesIndices,e,t.map(f=>[f.vertexData.matricesIndices,f.transform])),r&&(yield)),c.matricesWeights&&(this.matricesWeights=s._MergeElement(y.MatricesWeightsKind,c.matricesWeights,e,t.map(f=>[f.vertexData.matricesWeights,f.transform])),r&&(yield)),c.matricesIndicesExtra&&(this.matricesIndicesExtra=s._MergeElement(y.MatricesIndicesExtraKind,c.matricesIndicesExtra,e,t.map(f=>[f.vertexData.matricesIndicesExtra,f.transform])),r&&(yield)),c.matricesWeightsExtra&&(this.matricesWeightsExtra=s._MergeElement(y.MatricesWeightsExtraKind,c.matricesWeightsExtra,e,t.map(f=>[f.vertexData.matricesWeightsExtra,f.transform]))),this}static _MergeElement(e,t,i,r){let n=r.filter(l=>l[0]!==null&&l[0]!==void 0);if(!t&&n.length==0)return t;if(!t)return this._MergeElement(e,n[0][0],n[0][1],n.slice(1));let o=n.reduce((l,c)=>l+c[0].length,t.length),a=e===y.PositionKind?s._TransformVector3Coordinates:e===y.NormalKind?s._TransformVector3Normals:e===y.TangentKind?s._TransformVector4Normals:()=>{};if(t instanceof Float32Array){let l=new Float32Array(o);l.set(t),i&&a(l,i,0,t.length);let c=t.length;for(let[h,u]of n)l.set(h,c),u&&a(l,u,c,h.length),c+=h.length;return l}else{let l=new Array(o);for(let h=0;h<t.length;h++)l[h]=t[h];i&&a(l,i,0,t.length);let c=t.length;for(let[h,u]of n){for(let d=0;d<h.length;d++)l[c+d]=h[d];u&&a(l,u,c,h.length),c+=h.length}return l}}_validate(){if(!this.positions)throw new Wo("Positions are required",zo.MeshInvalidPositionsError);let e=(r,n)=>{let o=y.DeduceStride(r);if(n.length%o!==0)throw new Error("The "+r+"s array count must be a multiple of "+o);return n.length/o},t=e(y.PositionKind,this.positions),i=(r,n)=>{let o=e(r,n);if(o!==t)throw new Error("The "+r+"s element count ("+o+") does not match the positions count ("+t+")")};this.normals&&i(y.NormalKind,this.normals),this.tangents&&i(y.TangentKind,this.tangents),this.uvs&&i(y.UVKind,this.uvs),this.uvs2&&i(y.UV2Kind,this.uvs2),this.uvs3&&i(y.UV3Kind,this.uvs3),this.uvs4&&i(y.UV4Kind,this.uvs4),this.uvs5&&i(y.UV5Kind,this.uvs5),this.uvs6&&i(y.UV6Kind,this.uvs6),this.colors&&i(y.ColorKind,this.colors),this.matricesIndices&&i(y.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(y.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(y.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(y.MatricesWeightsExtraKind,this.matricesWeightsExtra)}clone(){let e=this.serialize();return s.Parse(e)}serialize(){let e={};if(this.positions&&(e.positions=Array.from(this.positions)),this.normals&&(e.normals=Array.from(this.normals)),this.tangents&&(e.tangents=Array.from(this.tangents)),this.uvs&&(e.uvs=Array.from(this.uvs)),this.uvs2&&(e.uvs2=Array.from(this.uvs2)),this.uvs3&&(e.uvs3=Array.from(this.uvs3)),this.uvs4&&(e.uvs4=Array.from(this.uvs4)),this.uvs5&&(e.uvs5=Array.from(this.uvs5)),this.uvs6&&(e.uvs6=Array.from(this.uvs6)),this.colors&&(e.colors=Array.from(this.colors),e.hasVertexAlpha=this.hasVertexAlpha),this.matricesIndices&&(e.matricesIndices=Array.from(this.matricesIndices),e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=Array.from(this.matricesWeights)),this.matricesIndicesExtra&&(e.matricesIndicesExtra=Array.from(this.matricesIndicesExtra),e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=Array.from(this.matricesWeightsExtra)),e.indices=Array.from(this.indices),this.materialInfos){e.materialInfos=[];for(let t of this.materialInfos){let i={indexStart:t.indexStart,indexCount:t.indexCount,materialIndex:t.materialIndex,verticesStart:t.verticesStart,verticesCount:t.verticesCount};e.materialInfos.push(i)}}return e}static ExtractFromMesh(e,t,i){return s._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return s._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){let r=new s;if(e.isVerticesDataPresent(y.PositionKind)&&(r.positions=e.getVerticesData(y.PositionKind,t,i)),e.isVerticesDataPresent(y.NormalKind)&&(r.normals=e.getVerticesData(y.NormalKind,t,i)),e.isVerticesDataPresent(y.TangentKind)&&(r.tangents=e.getVerticesData(y.TangentKind,t,i)),e.isVerticesDataPresent(y.UVKind)&&(r.uvs=e.getVerticesData(y.UVKind,t,i)),e.isVerticesDataPresent(y.UV2Kind)&&(r.uvs2=e.getVerticesData(y.UV2Kind,t,i)),e.isVerticesDataPresent(y.UV3Kind)&&(r.uvs3=e.getVerticesData(y.UV3Kind,t,i)),e.isVerticesDataPresent(y.UV4Kind)&&(r.uvs4=e.getVerticesData(y.UV4Kind,t,i)),e.isVerticesDataPresent(y.UV5Kind)&&(r.uvs5=e.getVerticesData(y.UV5Kind,t,i)),e.isVerticesDataPresent(y.UV6Kind)&&(r.uvs6=e.getVerticesData(y.UV6Kind,t,i)),e.isVerticesDataPresent(y.ColorKind)){let n=e.geometry||e,o=n.getVertexBuffer(y.ColorKind),a=n.getVerticesData(y.ColorKind,t,i);if(o.getSize()===3){let l=new Float32Array(a.length*4/3);for(let c=0,h=0;c<a.length;c+=3,h+=4)l[h]=a[c],l[h+1]=a[c+1],l[h+2]=a[c+2],l[h+3]=1;r.colors=l}else if(o.getSize()===4)r.colors=a;else throw new Error(`Unexpected number of color components: ${o.getSize()}`)}return e.isVerticesDataPresent(y.MatricesIndicesKind)&&(r.matricesIndices=e.getVerticesData(y.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(y.MatricesWeightsKind)&&(r.matricesWeights=e.getVerticesData(y.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(y.MatricesIndicesExtraKind)&&(r.matricesIndicesExtra=e.getVerticesData(y.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(y.MatricesWeightsExtraKind)&&(r.matricesWeightsExtra=e.getVerticesData(y.MatricesWeightsExtraKind,t,i)),r.indices=e.getIndices(t,i),r}static CreateRibbon(e){throw We("ribbonBuilder")}static CreateBox(e){throw We("boxBuilder")}static CreateTiledBox(e){throw We("tiledBoxBuilder")}static CreateTiledPlane(e){throw We("tiledPlaneBuilder")}static CreateSphere(e){throw We("sphereBuilder")}static CreateCylinder(e){throw We("cylinderBuilder")}static CreateTorus(e){throw We("torusBuilder")}static CreateLineSystem(e){throw We("linesBuilder")}static CreateDashedLines(e){throw We("linesBuilder")}static CreateGround(e){throw We("groundBuilder")}static CreateTiledGround(e){throw We("groundBuilder")}static CreateGroundFromHeightMap(e){throw We("groundBuilder")}static CreatePlane(e){throw We("planeBuilder")}static CreateDisc(e){throw We("discBuilder")}static CreatePolygon(e,t,i,r,n,o,a){throw We("polygonBuilder")}static CreateIcoSphere(e){throw We("icoSphereBuilder")}static CreatePolyhedron(e){throw We("polyhedronBuilder")}static CreateCapsule(e={orientation:p.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw We("capsuleBuilder")}static CreateTorusKnot(e){throw We("torusKnotBuilder")}static ComputeNormals(e,t,i,r){let n=0,o=0,a=0,l=0,c=0,h=0,u=0,d=0,f=0,m=0,g=0,_=0,x=0,b=0,C=0,R=0,E=0,S=0,A=0,L=0,G=!1,W=!1,$=!1,re=!1,we=1,_e=0,ce=null;r&&(G=!!r.facetNormals,W=!!r.facetPositions,$=!!r.facetPartitioning,we=r.useRightHandedSystem===!0?-1:1,_e=r.ratio||0,re=!!r.depthSort,ce=r.distanceTo,re&&ce===void 0&&(ce=p.Zero()));let ne=0,Fe=0,Oe=0,he=0;for($&&r&&r.bbSize&&(ne=r.subDiv.X*_e/r.bbSize.x,Fe=r.subDiv.Y*_e/r.bbSize.y,Oe=r.subDiv.Z*_e/r.bbSize.z,he=r.subDiv.max*r.subDiv.max,r.facetPartitioning.length=0),n=0;n<e.length;n++)i[n]=0;let ee=t.length/3|0;for(n=0;n<ee;n++){if(_=t[n*3]*3,x=_+1,b=_+2,C=t[n*3+1]*3,R=C+1,E=C+2,S=t[n*3+2]*3,A=S+1,L=S+2,o=e[_]-e[C],a=e[x]-e[R],l=e[b]-e[E],c=e[S]-e[C],h=e[A]-e[R],u=e[L]-e[E],d=we*(a*u-l*h),f=we*(l*c-o*u),m=we*(o*h-a*c),g=Math.sqrt(d*d+f*f+m*m),g=g===0?1:g,d/=g,f/=g,m/=g,G&&r&&(r.facetNormals[n].x=d,r.facetNormals[n].y=f,r.facetNormals[n].z=m),W&&r&&(r.facetPositions[n].x=(e[_]+e[C]+e[S])/3,r.facetPositions[n].y=(e[x]+e[R]+e[A])/3,r.facetPositions[n].z=(e[b]+e[E]+e[L])/3),$&&r){let V=Math.floor((r.facetPositions[n].x-r.bInfo.minimum.x*_e)*ne),Y=Math.floor((r.facetPositions[n].y-r.bInfo.minimum.y*_e)*Fe),J=Math.floor((r.facetPositions[n].z-r.bInfo.minimum.z*_e)*Oe),Me=Math.floor((e[_]-r.bInfo.minimum.x*_e)*ne),Re=Math.floor((e[x]-r.bInfo.minimum.y*_e)*Fe),et=Math.floor((e[b]-r.bInfo.minimum.z*_e)*Oe),Tt=Math.floor((e[C]-r.bInfo.minimum.x*_e)*ne),Yt=Math.floor((e[R]-r.bInfo.minimum.y*_e)*Fe),si=Math.floor((e[E]-r.bInfo.minimum.z*_e)*Oe),Er=Math.floor((e[S]-r.bInfo.minimum.x*_e)*ne),Xi=Math.floor((e[A]-r.bInfo.minimum.y*_e)*Fe),Ie=Math.floor((e[L]-r.bInfo.minimum.z*_e)*Oe),st=Me+r.subDiv.max*Re+he*et,vi=Tt+r.subDiv.max*Yt+he*si,sr=Er+r.subDiv.max*Xi+he*Ie,Ar=V+r.subDiv.max*Y+he*J;r.facetPartitioning[Ar]=r.facetPartitioning[Ar]?r.facetPartitioning[Ar]:new Array,r.facetPartitioning[st]=r.facetPartitioning[st]?r.facetPartitioning[st]:new Array,r.facetPartitioning[vi]=r.facetPartitioning[vi]?r.facetPartitioning[vi]:new Array,r.facetPartitioning[sr]=r.facetPartitioning[sr]?r.facetPartitioning[sr]:new Array,r.facetPartitioning[st].push(n),vi!=st&&r.facetPartitioning[vi].push(n),sr==vi||sr==st||r.facetPartitioning[sr].push(n),Ar==st||Ar==vi||Ar==sr||r.facetPartitioning[Ar].push(n)}if(re&&r&&r.facetPositions){let V=r.depthSortedFacets[n];V.ind=n*3,V.sqDistance=p.DistanceSquared(r.facetPositions[n],ce)}i[_]+=d,i[x]+=f,i[b]+=m,i[C]+=d,i[R]+=f,i[E]+=m,i[S]+=d,i[A]+=f,i[L]+=m}for(n=0;n<i.length/3;n++)d=i[n*3],f=i[n*3+1],m=i[n*3+2],g=Math.sqrt(d*d+f*f+m*m),g=g===0?1:g,d/=g,f/=g,m/=g,i[n*3]=d,i[n*3+1]=f,i[n*3+2]=m}static _ComputeSides(e,t,i,r,n,o,a){let l=i.length,c=r.length,h,u;switch(e=e||s.DEFAULTSIDE,e){case s.FRONTSIDE:break;case s.BACKSIDE:for(h=0;h<l;h+=3){let d=i[h];i[h]=i[h+2],i[h+2]=d}for(u=0;u<c;u++)r[u]=-r[u];break;case s.DOUBLESIDE:{let d=t.length,f=d/3;for(let _=0;_<d;_++)t[d+_]=t[_];for(h=0;h<l;h+=3)i[h+l]=i[h+2]+f,i[h+1+l]=i[h+1]+f,i[h+2+l]=i[h]+f;for(u=0;u<c;u++)r[c+u]=-r[u];let m=n.length,g=0;for(g=0;g<m;g++)n[g+m]=n[g];for(o=o||new De(0,0,1,1),a=a||new De(0,0,1,1),g=0,h=0;h<m/2;h++)n[g]=o.x+(o.z-o.x)*n[g],n[g+1]=o.y+(o.w-o.y)*n[g+1],n[g+m]=a.x+(a.z-a.x)*n[g+m],n[g+m+1]=a.y+(a.w-a.y)*n[g+m+1],g+=2;break}}}static Parse(e){let t=new s,i=e.positions;i&&t.set(i,y.PositionKind);let r=e.normals;r&&t.set(r,y.NormalKind);let n=e.tangents;n&&t.set(n,y.TangentKind);let o=e.uvs;o&&t.set(o,y.UVKind);let a=e.uvs2;a&&t.set(a,y.UV2Kind);let l=e.uvs3;l&&t.set(l,y.UV3Kind);let c=e.uvs4;c&&t.set(c,y.UV4Kind);let h=e.uvs5;h&&t.set(h,y.UV5Kind);let u=e.uvs6;u&&t.set(u,y.UV6Kind);let d=e.colors;d&&(t.set(oe.CheckColors4(d,i.length/3),y.ColorKind),e.hasVertexAlpha!==void 0&&(t.hasVertexAlpha=e.hasVertexAlpha));let f=e.matricesIndices;f&&t.set(f,y.MatricesIndicesKind);let m=e.matricesWeights;m&&t.set(m,y.MatricesWeightsKind);let g=e.indices;g&&(t.indices=g);let _=e.materialInfos;if(_){t.materialInfos=[];for(let x of _){let b=new jc;b.indexCount=x.indexCount,b.indexStart=x.indexStart,b.verticesCount=x.verticesCount,b.verticesStart=x.verticesStart,b.materialIndex=x.materialIndex,t.materialInfos.push(b)}}return t}static ImportVertexData(e,t){let i=s.Parse(e);t.setAllVerticesData(i,e.updatable)}};le.FRONTSIDE=0;le.BACKSIDE=1;le.DOUBLESIDE=2;le.DEFAULTSIDE=0;le._UniqueIDGenerator=0;v([bl.filter((...[s])=>!Array.isArray(s))],le,"_TransformVector3Coordinates",null);v([bl.filter((...[s])=>!Array.isArray(s))],le,"_TransformVector3Normals",null);v([bl.filter((...[s])=>!Array.isArray(s))],le,"_TransformVector4Normals",null);v([bl.filter((...[s])=>!Array.isArray(s))],le,"_FlipFaces",null);var pn=(()=>{class s{static get ForceFullSceneLoadingForIncremental(){return s._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(t){s._ForceFullSceneLoadingForIncremental=t}static get ShowLoadingScreen(){return s._ShowLoadingScreen}static set ShowLoadingScreen(t){s._ShowLoadingScreen=t}static get loggingLevel(){return s._LoggingLevel}static set loggingLevel(t){s._LoggingLevel=t}static get CleanBoneMatrixWeights(){return s._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(t){s._CleanBoneMatrixWeights=t}}return s._ForceFullSceneLoadingForIncremental=!1,s._ShowLoadingScreen=!0,s._CleanBoneMatrixWeights=!1,s._LoggingLevel=0,s})();var nr=class s{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){let t=new s(s.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}constructor(e,t,i,r=!1,n=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||me.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=r,i?this.setAllVerticesData(i,r):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),n&&(this.applyToMesh(n),n.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer"));let e=new Set;for(let t in this._vertexBuffers)e.add(this._vertexBuffers[t].getWrapperBuffer());e.forEach(t=>{t._rebuild()})}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,r){i&&Array.isArray(t)&&(t=new Float32Array(t));let n=new y(this._engine,t,e,{updatable:i,postponeInternalCreation:this._meshes.length===0,stride:r,label:"Geometry_"+this.id+"_"+e});this.setVerticesBuffer(n)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){let r=e.getKind();this._vertexBuffers[r]&&i&&this._vertexBuffers[r].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[r]=e;let n=this._meshes,o=n.length;if(r===y.PositionKind){this._totalVertices=t??e._maxVerticesCount,this._updateExtend(e.getFloatData(this._totalVertices)),this._resetPointsArrayCache();let a=this._extend&&this._extend.minimum||new p(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),l=this._extend&&this._extend.maximum||new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);for(let c=0;c<o;c++){let h=n[c];h.buildBoundingInfo(a,l),h._createGlobalSubMesh(h.isUnIndexed),h.computeWorldMatrix(!0),h.synchronizeInstances()}}this._notifyUpdate(r)}updateVerticesDataDirectly(e,t,i,r=!1){let n=this.getVertexBuffer(e);n&&(n.updateDirectly(t,i,r),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){let r=this.getVertexBuffer(e);r&&(r.update(t),e===y.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){let i=this._meshes;for(let r of i){r.hasBoundingInfo?r.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):r.buildBoundingInfo(this._extend.minimum,this._extend.maximum);let n=r.subMeshes;for(let o of n)o.refreshBoundingInfo()}}}_bind(e,t,i,r){if(!e)return;t===void 0&&(t=this._indexBuffer);let n=this.getVertexBuffers();if(!n)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!r){this._engine.bindBuffers(n,t,e,i);return}let o=r||this._vertexArrayObjects,a=this._engine;o[e.key]||(o[e.key]=a.recordVertexArrayObject(n,t,e,i)),a.bindVertexArrayObject(o[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){let r=this.getVertexBuffer(e);return r?r.getFloatData(this._totalVertices,i||t&&this._meshes.length!==1):null}isVertexBufferUpdatable(e){let t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){let e=[],t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{let r=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),r)for(let n of this._meshes)n._createGlobalSubMesh(!0)}}setIndexBuffer(e,t,i){this._indices=[],this._indexBufferIsUpdatable=!1,this._indexBuffer=e,this._totalVertices=t,this._totalIndices=i,e.is32Bits||(e.is32Bits=this._totalIndices>65535);for(let r of this._meshes)r._createGlobalSubMesh(!0),r.synchronizeInstances();this._notifyUpdate()}setIndices(e,t=null,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i,"Geometry_"+this.id+"_IndexBuffer")),t!=null&&(this._totalVertices=t);for(let r of this._meshes)r._createGlobalSubMesh(!0),r.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._totalIndices!==void 0?this._totalIndices:this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;let i=this._indices;return!t&&(!e||this._meshes.length===1)?i:i.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){let i=this._meshes,r=i.indexOf(e);r!==-1&&(i.splice(r,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,i.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;let t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();let i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(y.PositionKind),!e))return;this._extend=ja(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){let t=this._meshes.length;for(let i in this._vertexBuffers)t===1&&this._vertexBuffers[i].create(),i===y.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());t===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable,"Geometry_"+this.id+"_IndexBuffer")),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(let t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);let r=this._meshes,n=r.length;for(let o=0;o<n;o++)this._applyToMesh(r[o]);t&&t()},void 0,!0))}toLeftHanded(){let e=this.getIndices(!1);if(e!=null&&e.length>0){for(let r=0;r<e.length;r+=3){let n=e[r+0];e[r+0]=e[r+2],e[r+2]=n}this.setIndices(e)}let t=this.getVerticesData(y.PositionKind,!1);if(t!=null&&t.length>0){for(let r=0;r<t.length;r+=3)t[r+2]=-t[r+2];this.setVerticesData(y.PositionKind,t,!1)}let i=this.getVerticesData(y.NormalKind,!1);if(i!=null&&i.length>0){for(let r=0;r<i.length;r+=3)i[r+2]=-i[r+2];this.setVerticesData(y.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;let e=this.getVerticesData(y.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=p.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(let i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};let e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){let e=this._meshes,t=e.length,i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(let r in this._vertexBuffers)this._vertexBuffers[r].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){let r=this._parentContainer.geometries.indexOf(this);r>-1&&this._parentContainer.geometries.splice(r,1),this._parentContainer=null}this._isDisposed=!0}copy(e){let t=new le;t.indices=[];let i=this.getIndices();if(i)for(let l=0;l<i.length;l++)t.indices.push(i[l]);let r=!1,n=!1,o;for(o in this._vertexBuffers){let l=this.getVerticesData(o);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),o):t.set(l.slice(0),o),!n)){let c=this.getVertexBuffer(o);c&&(r=c.isUpdatable(),n=!r)}}let a=new s(e,this._scene,t,r);a.delayLoadState=this.delayLoadState,a.delayLoadingFile=this.delayLoadingFile,a._delayLoadingFunction=this._delayLoadingFunction;for(o in this._delayInfo)a._delayInfo=a._delayInfo||[],a._delayInfo.push(o);return a._boundingInfo=new dr(this._extend.minimum,this._extend.maximum),a}serialize(){let e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,di&&di.HasTags(this)&&(e.tags=di.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(let e in this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){let e=this.serialize();return this.isVerticesDataPresent(y.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(y.PositionKind)),this.isVertexBufferUpdatable(y.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(y.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(y.NormalKind)),this.isVertexBufferUpdatable(y.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(y.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(y.TangentKind)),this.isVertexBufferUpdatable(y.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(y.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(y.UVKind)),this.isVertexBufferUpdatable(y.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(y.UV2Kind)&&(e.uvs2=this._toNumberArray(this.getVerticesData(y.UV2Kind)),this.isVertexBufferUpdatable(y.UV2Kind)&&(e.uvs2._updatable=!0)),this.isVerticesDataPresent(y.UV3Kind)&&(e.uvs3=this._toNumberArray(this.getVerticesData(y.UV3Kind)),this.isVertexBufferUpdatable(y.UV3Kind)&&(e.uvs3._updatable=!0)),this.isVerticesDataPresent(y.UV4Kind)&&(e.uvs4=this._toNumberArray(this.getVerticesData(y.UV4Kind)),this.isVertexBufferUpdatable(y.UV4Kind)&&(e.uvs4._updatable=!0)),this.isVerticesDataPresent(y.UV5Kind)&&(e.uvs5=this._toNumberArray(this.getVerticesData(y.UV5Kind)),this.isVertexBufferUpdatable(y.UV5Kind)&&(e.uvs5._updatable=!0)),this.isVerticesDataPresent(y.UV6Kind)&&(e.uvs6=this._toNumberArray(this.getVerticesData(y.UV6Kind)),this.isVertexBufferUpdatable(y.UV6Kind)&&(e.uvs6._updatable=!0)),this.isVerticesDataPresent(y.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(y.ColorKind)),this.isVertexBufferUpdatable(y.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(y.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(y.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(y.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(y.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(y.MatricesWeightsKind)),this.isVertexBufferUpdatable(y.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){let i=e._geometry;return i?i.copy(t):null}static RandomId(){return H.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){let i=t.getScene(),r=e.geometryUniqueId,n=e.geometryId;if(r||n){let o=r?this._GetGeometryByLoadedUniqueId(r,i):i.getGeometryById(n);o&&o.applyToMesh(t)}else if(e instanceof ArrayBuffer){let o=t._binaryInfo;if(o.positionsAttrDesc&&o.positionsAttrDesc.count>0){let a=new Float32Array(e,o.positionsAttrDesc.offset,o.positionsAttrDesc.count);t.setVerticesData(y.PositionKind,a,!1)}if(o.normalsAttrDesc&&o.normalsAttrDesc.count>0){let a=new Float32Array(e,o.normalsAttrDesc.offset,o.normalsAttrDesc.count);t.setVerticesData(y.NormalKind,a,!1)}if(o.tangetsAttrDesc&&o.tangetsAttrDesc.count>0){let a=new Float32Array(e,o.tangetsAttrDesc.offset,o.tangetsAttrDesc.count);t.setVerticesData(y.TangentKind,a,!1)}if(o.uvsAttrDesc&&o.uvsAttrDesc.count>0){let a=new Float32Array(e,o.uvsAttrDesc.offset,o.uvsAttrDesc.count);if(it.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(y.UVKind,a,!1)}if(o.uvs2AttrDesc&&o.uvs2AttrDesc.count>0){let a=new Float32Array(e,o.uvs2AttrDesc.offset,o.uvs2AttrDesc.count);if(it.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(y.UV2Kind,a,!1)}if(o.uvs3AttrDesc&&o.uvs3AttrDesc.count>0){let a=new Float32Array(e,o.uvs3AttrDesc.offset,o.uvs3AttrDesc.count);if(it.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(y.UV3Kind,a,!1)}if(o.uvs4AttrDesc&&o.uvs4AttrDesc.count>0){let a=new Float32Array(e,o.uvs4AttrDesc.offset,o.uvs4AttrDesc.count);if(it.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(y.UV4Kind,a,!1)}if(o.uvs5AttrDesc&&o.uvs5AttrDesc.count>0){let a=new Float32Array(e,o.uvs5AttrDesc.offset,o.uvs5AttrDesc.count);if(it.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(y.UV5Kind,a,!1)}if(o.uvs6AttrDesc&&o.uvs6AttrDesc.count>0){let a=new Float32Array(e,o.uvs6AttrDesc.offset,o.uvs6AttrDesc.count);if(it.UseOpenGLOrientationForUV)for(let l=1;l<a.length;l+=2)a[l]=1-a[l];t.setVerticesData(y.UV6Kind,a,!1)}if(o.colorsAttrDesc&&o.colorsAttrDesc.count>0){let a=new Float32Array(e,o.colorsAttrDesc.offset,o.colorsAttrDesc.count);t.setVerticesData(y.ColorKind,a,!1,o.colorsAttrDesc.stride)}if(o.matricesIndicesAttrDesc&&o.matricesIndicesAttrDesc.count>0){let a=new Int32Array(e,o.matricesIndicesAttrDesc.offset,o.matricesIndicesAttrDesc.count),l=[];for(let c=0;c<a.length;c++){let h=a[c];l.push(h&255),l.push((h&65280)>>8),l.push((h&16711680)>>16),l.push(h>>24&255)}t.setVerticesData(y.MatricesIndicesKind,l,!1)}if(o.matricesIndicesExtraAttrDesc&&o.matricesIndicesExtraAttrDesc.count>0){let a=new Int32Array(e,o.matricesIndicesExtraAttrDesc.offset,o.matricesIndicesExtraAttrDesc.count),l=[];for(let c=0;c<a.length;c++){let h=a[c];l.push(h&255),l.push((h&65280)>>8),l.push((h&16711680)>>16),l.push(h>>24&255)}t.setVerticesData(y.MatricesIndicesExtraKind,l,!1)}if(o.matricesWeightsAttrDesc&&o.matricesWeightsAttrDesc.count>0){let a=new Float32Array(e,o.matricesWeightsAttrDesc.offset,o.matricesWeightsAttrDesc.count);t.setVerticesData(y.MatricesWeightsKind,a,!1)}if(o.indicesAttrDesc&&o.indicesAttrDesc.count>0){let a=new Int32Array(e,o.indicesAttrDesc.offset,o.indicesAttrDesc.count);t.setIndices(a,null)}if(o.subMeshesAttrDesc&&o.subMeshesAttrDesc.count>0){let a=new Int32Array(e,o.subMeshesAttrDesc.offset,o.subMeshesAttrDesc.count*5);t.subMeshes=[];for(let l=0;l<o.subMeshesAttrDesc.count;l++){let c=a[l*5+0],h=a[l*5+1],u=a[l*5+2],d=a[l*5+3],f=a[l*5+4];Wi.AddToMesh(c,h,u,d,f,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(y.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(y.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(y.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(y.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(y.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(y.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(y.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(y.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(y.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(y.ColorKind,oe.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(y.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{let o=[];for(let a=0;a<e.matricesIndices.length;a++){let l=e.matricesIndices[a];o.push(l&255),o.push((l&65280)>>8),o.push((l&16711680)>>16),o.push(l>>24&255)}t.setVerticesData(y.MatricesIndicesKind,o,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(y.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{let o=[];for(let a=0;a<e.matricesIndicesExtra.length;a++){let l=e.matricesIndicesExtra[a];o.push(l&255),o.push((l&65280)>>8),o.push((l&16711680)>>16),o.push(l>>24&255)}t.setVerticesData(y.MatricesIndicesExtraKind,o,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(s._CleanMatricesWeights(e,t),t.setVerticesData(y.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(y.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let o=0;o<e.subMeshes.length;o++){let a=e.subMeshes[o];Wi.AddToMesh(a.materialIndex,a.verticesStart,a.verticesCount,a.indexStart,a.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!pn.CleanBoneMatrixWeights)return;let r=0;if(e.skeletonId>-1){let u=t.getScene().getLastSkeletonById(e.skeletonId);if(!u)return;r=u.bones.length}else return;let n=t.getVerticesData(y.MatricesIndicesKind),o=t.getVerticesData(y.MatricesIndicesExtraKind),a=e.matricesWeights,l=e.matricesWeightsExtra,c=e.numBoneInfluencer,h=a.length;for(let u=0;u<h;u+=4){let d=0,f=-1;for(let m=0;m<4;m++){let g=a[u+m];d+=g,g<.001&&f<0&&(f=m)}if(l)for(let m=0;m<4;m++){let g=l[u+m];d+=g,g<.001&&f<0&&(f=m+4)}if((f<0||f>c-1)&&(f=c-1),d>.001){let m=1/d;for(let g=0;g<4;g++)a[u+g]*=m;if(l)for(let g=0;g<4;g++)l[u+g]*=m}else f>=4?(l[u+f-4]=1-d,o[u+f-4]=r):(a[u+f]=1-d,n[u+f]=r)}t.setVerticesData(y.MatricesIndicesKind,n),e.matricesWeightsExtra&&t.setVerticesData(y.MatricesIndicesExtraKind,o)}static Parse(e,t,i){let r=new s(e.id,t,void 0,e.updatable);return r._loadedUniqueId=e.uniqueId,di&&di.AddTagsTo(r,e.tags),e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r._boundingInfo=new dr(p.FromArray(e.boundingBoxMinimum),p.FromArray(e.boundingBoxMaximum)),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(y.UVKind),e.hasUVs2&&r._delayInfo.push(y.UV2Kind),e.hasUVs3&&r._delayInfo.push(y.UV3Kind),e.hasUVs4&&r._delayInfo.push(y.UV4Kind),e.hasUVs5&&r._delayInfo.push(y.UV5Kind),e.hasUVs6&&r._delayInfo.push(y.UV6Kind),e.hasColors&&r._delayInfo.push(y.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(y.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(y.MatricesWeightsKind),r._delayLoadingFunction=le.ImportVertexData):le.ImportVertexData(e,r),t.pushGeometry(r,!0),r}};var fd=class{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new mI(e)}sampleFrame(e=Mi.Now){if(this._enabled){if(this._lastFrameTimeMs!=null){let t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){let e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}},mI=class{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){let i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;let t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){let t=this._samples.length;return(e%t+t)%t}};at.prototype.setAlphaMode=function(s,e=!1){if(this._alphaMode===s){if(!e){let t=s===0;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}return}switch(s){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=s===0),this._alphaMode=s};at.prototype.updateDynamicIndexBuffer=function(s,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(s);let i;s.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};at.prototype.updateDynamicVertexBuffer=function(s,e,t,i){this.bindArrayBuffer(s),t===void 0&&(t=0);let r=e.byteLength||e.length;i===void 0||i>=r&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e instanceof ArrayBuffer?e=new Uint8Array(e,t,i):e=new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};Se.prototype.displayLoadingUI=function(){if(!so())return;let s=this.loadingScreen;s&&s.displayLoadingUI()};Se.prototype.hideLoadingUI=function(){if(!so())return;let s=this._loadingScreen;s&&s.hideLoadingUI()};Object.defineProperty(Se.prototype,"loadingScreen",{get:function(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=Se.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen},set:function(s){this._loadingScreen=s},enumerable:!0,configurable:!0});Object.defineProperty(Se.prototype,"loadingUIText",{set:function(s){this.loadingScreen.loadingUIText=s},enumerable:!0,configurable:!0});Object.defineProperty(Se.prototype,"loadingUIBackgroundColor",{set:function(s){this.loadingScreen.loadingUIBackgroundColor=s},enumerable:!0,configurable:!0});Se.prototype.getInputElement=function(){return this._renderingCanvas};Se.prototype.getRenderingCanvasClientRect=function(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null};Se.prototype.getInputElementClientRect=function(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null};Se.prototype.getAspectRatio=function(s,e=!1){let t=s.viewport;return this.getRenderWidth(e)*t.width/(this.getRenderHeight(e)*t.height)};Se.prototype.getScreenAspectRatio=function(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)};Se.prototype._verifyPointerLock=function(){this._onPointerLockChange?.()};Se.prototype.setAlphaEquation=function(s){if(this._alphaEquation!==s){switch(s){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=s}};Se.prototype.getInputElement=function(){return this._renderingCanvas};Se.prototype.getDepthFunction=function(){return this._depthCullingState.depthFunc};Se.prototype.setDepthFunction=function(s){this._depthCullingState.depthFunc=s};Se.prototype.setDepthFunctionToGreater=function(){this.setDepthFunction(516)};Se.prototype.setDepthFunctionToGreaterOrEqual=function(){this.setDepthFunction(518)};Se.prototype.setDepthFunctionToLess=function(){this.setDepthFunction(513)};Se.prototype.setDepthFunctionToLessOrEqual=function(){this.setDepthFunction(515)};Se.prototype.getDepthWrite=function(){return this._depthCullingState.depthMask};Se.prototype.setDepthWrite=function(s){this._depthCullingState.depthMask=s};Se.prototype.getStencilBuffer=function(){return this._stencilState.stencilTest};Se.prototype.setStencilBuffer=function(s){this._stencilState.stencilTest=s};Se.prototype.getStencilMask=function(){return this._stencilState.stencilMask};Se.prototype.setStencilMask=function(s){this._stencilState.stencilMask=s};Se.prototype.getStencilFunction=function(){return this._stencilState.stencilFunc};Se.prototype.getStencilFunctionReference=function(){return this._stencilState.stencilFuncRef};Se.prototype.getStencilFunctionMask=function(){return this._stencilState.stencilFuncMask};Se.prototype.setStencilFunction=function(s){this._stencilState.stencilFunc=s};Se.prototype.setStencilFunctionReference=function(s){this._stencilState.stencilFuncRef=s};Se.prototype.setStencilFunctionMask=function(s){this._stencilState.stencilFuncMask=s};Se.prototype.getStencilOperationFail=function(){return this._stencilState.stencilOpStencilFail};Se.prototype.getStencilOperationDepthFail=function(){return this._stencilState.stencilOpDepthFail};Se.prototype.getStencilOperationPass=function(){return this._stencilState.stencilOpStencilDepthPass};Se.prototype.setStencilOperationFail=function(s){this._stencilState.stencilOpStencilFail=s};Se.prototype.setStencilOperationDepthFail=function(s){this._stencilState.stencilOpDepthFail=s};Se.prototype.setStencilOperationPass=function(s){this._stencilState.stencilOpStencilDepthPass=s};Se.prototype.cacheStencilState=function(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()};Se.prototype.restoreStencilState=function(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)};Se.prototype.setAlphaConstants=function(s,e,t,i){this._alphaState.setAlphaBlendConstants(s,e,t,i)};Se.prototype.getAlphaMode=function(){return this._alphaMode};Se.prototype.getAlphaEquation=function(){return this._alphaEquation};Se.prototype.getRenderPassNames=function(){return this._renderPassNames};Se.prototype.getCurrentRenderPassName=function(){return this._renderPassNames[this.currentRenderPassId]};Se.prototype.createRenderPassId=function(s){let e=++Se._RenderPassIdCounter;return this._renderPassNames[e]=s??"NONAME",e};Se.prototype.releaseRenderPassId=function(s){this._renderPassNames[s]=void 0;for(let e=0;e<this.scenes.length;++e){let t=this.scenes[e];for(let i=0;i<t.meshes.length;++i){let r=t.meshes[i];if(r.subMeshes)for(let n=0;n<r.subMeshes.length;++n)r.subMeshes[n]._removeDrawWrapper(s)}}};Se.prototype.createDepthStencilTexture=function(s,e,t){if(e.isCube){let i=s.width||s;return this._createDepthStencilCubeTexture(i,e)}else return this._createDepthStencilTexture(s,e,t)};function pH(s){!s||!s.setAttribute||(s.setAttribute("touch-action","none"),s.style.touchAction="none",s.style.webkitTapHighlightColor="transparent")}function Nx(s,e,t){s._onCanvasFocus=()=>{s.onCanvasFocusObservable.notifyObservers(s)},s._onCanvasBlur=()=>{s.onCanvasBlurObservable.notifyObservers(s)},s._onCanvasContextMenu=r=>{s.disableContextMenu&&r.preventDefault()},e.addEventListener("focus",s._onCanvasFocus),e.addEventListener("blur",s._onCanvasBlur),e.addEventListener("contextmenu",s._onCanvasContextMenu),s._onBlur=()=>{s.disablePerformanceMonitorInBackground&&s.performanceMonitor.disable(),s._windowIsBackground=!0},s._onFocus=()=>{s.disablePerformanceMonitorInBackground&&s.performanceMonitor.enable(),s._windowIsBackground=!1},s._onCanvasPointerOut=r=>{document.elementFromPoint(r.clientX,r.clientY)!==e&&s.onCanvasPointerOutObservable.notifyObservers(r)};let i=s.getHostWindow();i&&typeof i.addEventListener=="function"&&(i.addEventListener("blur",s._onBlur),i.addEventListener("focus",s._onFocus)),e.addEventListener("pointerout",s._onCanvasPointerOut),t.doNotHandleTouchAction||pH(e),!Se.audioEngine&&t.audioEngine&&Se.AudioEngineFactory&&(Se.audioEngine=Se.AudioEngineFactory(s.getRenderingCanvas(),s.getAudioContext(),s.getAudioDestination())),kS()&&(s._onFullscreenChange=()=>{s.isFullscreen=!!document.fullscreenElement,s.isFullscreen&&s._pointerLockRequested&&e&&$p(e)},document.addEventListener("fullscreenchange",s._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",s._onFullscreenChange,!1),s._onPointerLockChange=()=>{s.isPointerLock=document.pointerLockElement===e},document.addEventListener("pointerlockchange",s._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",s._onPointerLockChange,!1)),s.enableOfflineSupport=Se.OfflineProviderFactory!==void 0,s._deterministicLockstep=!!t.deterministicLockstep,s._lockstepMaxSteps=t.lockstepMaxSteps||0,s._timeStep=t.timeStep||1/60}function Fx(s,e){me.Instances.length===1&&Se.audioEngine&&(Se.audioEngine.dispose(),Se.audioEngine=null);let t=s.getHostWindow();t&&typeof t.removeEventListener=="function"&&(t.removeEventListener("blur",s._onBlur),t.removeEventListener("focus",s._onFocus)),e&&(e.removeEventListener("focus",s._onCanvasFocus),e.removeEventListener("blur",s._onCanvasBlur),e.removeEventListener("pointerout",s._onCanvasPointerOut),e.removeEventListener("contextmenu",s._onCanvasContextMenu)),kS()&&(document.removeEventListener("fullscreenchange",s._onFullscreenChange),document.removeEventListener("mozfullscreenchange",s._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",s._onFullscreenChange),document.removeEventListener("msfullscreenchange",s._onFullscreenChange),document.removeEventListener("pointerlockchange",s._onPointerLockChange),document.removeEventListener("mspointerlockchange",s._onPointerLockChange),document.removeEventListener("mozpointerlockchange",s._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",s._onPointerLockChange))}function Lx(s){let e=document.createElement("span");e.textContent="Hg",e.style.font=s;let t=document.createElement("div");t.style.display="inline-block",t.style.width="1px",t.style.height="0px",t.style.verticalAlign="bottom";let i=document.createElement("div");i.style.whiteSpace="nowrap",i.appendChild(e),i.appendChild(t),document.body.appendChild(i);let r=0,n=0;try{n=t.getBoundingClientRect().top-e.getBoundingClientRect().top,t.style.verticalAlign="baseline",r=t.getBoundingClientRect().top-e.getBoundingClientRect().top}finally{document.body.removeChild(i)}return{ascent:r,height:n,descent:n-r}}function Bx(s,e,t){return new Promise((r,n)=>{let o=new Image;o.onload=()=>{o.decode().then(()=>{s.createImageBitmap(o,t).then(a=>{r(a)})})},o.onerror=()=>{n(`Error loading image ${o.src}`)},o.src=e})}function Vx(s,e,t,i){let n=s.createCanvas(t,i).getContext("2d");if(!n)throw new Error("Unable to get 2d context for resizeImageBitmap");return n.drawImage(e,0,0),n.getImageData(0,0,t,i).data}function Ux(s){let e=s.requestFullscreen||s.webkitRequestFullscreen;e&&e.call(s)}function kx(){let s=document;document.exitFullscreen?document.exitFullscreen():s.webkitCancelFullScreen&&s.webkitCancelFullScreen()}function $p(s){if(s.requestPointerLock){let e=s.requestPointerLock();e instanceof Promise?e.then(()=>{s.focus()}).catch(()=>{}):s.focus()}}function Gx(){document.exitPointerLock&&document.exitPointerLock()}Se.AudioEngineFactory=(s,e,t)=>new gI(s,e,t);var gI=class{get audioContext(){return this._audioContextInitialized||this._initializeAudioContext(),this._audioContext}constructor(e=null,t=null,i=null){if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!1,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new U,this.onAudioLockedObservable=new U,this._tryToRun=!1,this._onResize=()=>{this._moveButtonToTopLeft()},!so())return;typeof window.AudioContext<"u"&&(this.canUseWebAudio=!0);let r=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=i;try{r&&r.canPlayType&&(r.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||r.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch{}try{r&&r.canPlayType&&r.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch{}}lock(){this._triggerSuspendedState()}unlock(){if(this._audioContext?.state==="running"){this._hideMuteButton(),this.unlocked||(this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this));return}this._tryToRun?this._audioContext?.suspend().then(()=>{this._tryToRun=!1,this._triggerRunningState()}):this._triggerRunningState()}_resumeAudioContextOnStateChange(){this._audioContext?.addEventListener("statechange",()=>{this.unlocked&&this._audioContext?.state!=="running"&&this._resumeAudioContext()},{once:!0,passive:!0,signal:AbortSignal.timeout(3e3)})}_resumeAudioContext(){return this._audioContext?.resume?this._audioContext.resume():Promise.resolve()}_initializeAudioContext(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,this._audioContext.state==="running"&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,F.Error("Web Audio: "+e.message)}}_triggerRunningState(){this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(()=>{this._tryToRun=!1,this._muteButton&&this._hideMuteButton(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)}).catch(()=>{this._tryToRun=!1,this.unlocked=!1}))}_triggerSuspendedState(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()}_displayMuteButton(){if(this.useCustomUnlockedButton||this._muteButton)return;this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";let t=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png")+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",i=document.createElement("style");i.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(i),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",()=>{this._triggerRunningState()},!0),this._muteButton.addEventListener("click",()=>{this.unlock()},!0),window.addEventListener("resize",this._onResize)}_moveButtonToTopLeft(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")}_hideMuteButton(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)}dispose(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1}setGlobalVolume(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))}};var K=(()=>{class s extends at{static get NpmPackage(){return Se.NpmPackage}static get Version(){return Se.Version}static get Instances(){return me.Instances}static get LastCreatedEngine(){return me.LastCreatedEngine}static get LastCreatedScene(){return me.LastCreatedScene}static MarkAllMaterialsAsDirty(t,i){for(let r=0;r<s.Instances.length;r++){let n=s.Instances[r];for(let o=0;o<n.scenes.length;o++)n.scenes[o].markAllMaterialsAsDirty(t,i)}}static DefaultLoadingScreenFactory(t){return Se.DefaultLoadingScreenFactory(t)}get _supportsHardwareTextureRescaling(){return!!s._RescalePostProcessFactory}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}constructor(t,i,r,n=!1){if(super(t,i,r,n),this.customAnimationFrameRequester=null,this._performanceMonitor=new fd,this._drawCalls=new Ps,!!t&&(this._features.supportRenderPasses=!0,r=this._creationOptions,t.getContext)){let o=t;this._sharedInit(o)}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(t){super._sharedInit(t),Nx(this,t,this._creationOptions)}resizeImageBitmap(t,i,r){return Vx(this,t,i,r)}_createImageBitmapFromSource(t,i){return Bx(this,t,i)}switchFullscreen(t){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(t)}enterFullscreen(t){this.isFullscreen||(this._pointerLockRequested=t,this._renderingCanvas&&Ux(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&kx()}setDitheringState(t){t?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(t){t?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}setDirectViewport(t,i,r,n){let o=this._cachedViewport;return this._cachedViewport=null,this._viewport(t,i,r,n),o}scissorClear(t,i,r,n,o){this.enableScissor(t,i,r,n),this.clear(o,!0,!0,!0),this.disableScissor()}enableScissor(t,i,r,n){let o=this._gl;o.enable(o.SCISSOR_TEST),o.scissor(t,i,r,n)}disableScissor(){let t=this._gl;t.disable(t.SCISSOR_TEST)}_loadFileAsync(t,i,r){return new Promise((n,o)=>{this._loadFile(t,a=>{n(a)},void 0,i,r,(a,l)=>{o(l)})})}getVertexShaderSource(t){let i=this._gl.getAttachedShaders(t);return i?this._gl.getShaderSource(i[0]):null}getFragmentShaderSource(t){let i=this._gl.getAttachedShaders(t);return i?this._gl.getShaderSource(i[1]):null}set framebufferDimensionsObject(t){this._framebufferDimensionsObject=t,this._framebufferDimensionsObject&&this.onResizeObservable.notifyObservers(this)}_rebuildBuffers(){for(let t of this.scenes)t.resetCachedMaterial(),t._rebuildGeometries();for(let t of this._virtualScenes)t.resetCachedMaterial(),t._rebuildGeometries();super._rebuildBuffers()}getFontOffset(t){return Lx(t)}_cancelFrame(){if(this.customAnimationFrameRequester){if(this._frameHandler!==0){this._frameHandler=0;let{cancelAnimationFrame:t}=this.customAnimationFrameRequester;t&&t(this.customAnimationFrameRequester.requestID)}}else super._cancelFrame()}_renderLoop(){if(this._frameHandler=0,!this._contextWasLost){let t=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(t=!1),t&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0&&this._frameHandler===0&&(this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()))}enterPointerlock(){this._renderingCanvas&&$p(this._renderingCanvas)}exitPointerlock(){Gx()}beginFrame(){this._measureFps(),super.beginFrame()}_deletePipelineContext(t){let i=t;i&&i.program&&i.transformFeedback&&(this.deleteTransformFeedback(i.transformFeedback),i.transformFeedback=null),super._deletePipelineContext(t)}createShaderProgram(t,i,r,n,o,a=null){o=o||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);let l=super.createShaderProgram(t,i,r,n,o,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),l}_createShaderProgram(t,i,r,n,o=null){let a=n.createProgram();if(t.program=a,!a)throw new Error("Unable to create program");if(n.attachShader(a,i),n.attachShader(a,r),this.webGLVersion>1&&o){let l=this.createTransformFeedback();this.bindTransformFeedback(l),this.setTranformFeedbackVaryings(a,o),t.transformFeedback=l}return n.linkProgram(a),this.webGLVersion>1&&o&&this.bindTransformFeedback(null),t.context=n,t.vertexShader=i,t.fragmentShader=r,t.isParallelCompiled||this._finalizePipelineContext(t),a}_releaseTexture(t){super._releaseTexture(t)}_releaseRenderTargetWrapper(t){super._releaseRenderTargetWrapper(t),this.scenes.forEach(i=>{i.postProcesses.forEach(r=>{r._outputTexture===t&&(r._outputTexture=null)}),i.cameras.forEach(r=>{r._postProcesses.forEach(n=>{n&&n._outputTexture===t&&(n._outputTexture=null)})})})}_rescaleTexture(t,i,r,n,o){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);let a=this.createRenderTargetTexture({width:i.width,height:i.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&s._RescalePostProcessFactory&&(this._rescalePostProcess=s._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(()=>{this._rescalePostProcess.onApply=function(c){c._bindTexture("textureSampler",t)};let l=r;l||(l=this.scenes[this.scenes.length-1]),l.postProcessManager.directRender([this._rescalePostProcess],a,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,i,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,n,0,0,i.width,i.height,0),this.unBindFramebuffer(a),a.dispose(),o&&o()}))}wrapWebGLTexture(t,i=!1,r=3,n=0,o=0){let a=new Ho(t,this._gl),l=new Je(this,ke.Unknown,!0);return l._hardwareTexture=a,l.baseWidth=n,l.baseHeight=o,l.width=n,l.height=o,l.isReady=!0,l.useMipMaps=i,this.updateTextureSamplingMode(r,l),l}_uploadImageToTexture(t,i,r=0,n=0){let o=this._gl,a=this._getWebGLTextureType(t.type),l=this._getInternalFormat(t.format),c=this._getRGBABufferInternalSizedFormat(t.type,l),h=t.isCube?o.TEXTURE_CUBE_MAP:o.TEXTURE_2D;this._bindTextureDirectly(h,t,!0),this._unpackFlipY(t.invertY);let u=o.TEXTURE_2D;t.isCube&&(u=o.TEXTURE_CUBE_MAP_POSITIVE_X+r),o.texImage2D(u,n,c,l,a,i),this._bindTextureDirectly(h,null,!0)}updateTextureComparisonFunction(t,i){if(this.webGLVersion===1){F.Error("WebGL 1 does not support texture comparison.");return}let r=this._gl;t.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,t,!0),i===0?(r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_FUNC,515),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_MODE,r.NONE)):(r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_FUNC,i),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),i===0?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_FUNC,515),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_MODE,r.NONE)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_FUNC,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),t._comparisonFunction=i}createInstancesBuffer(t){let i=this._gl.createBuffer();if(!i)throw new Error("Unable to create instance buffer");let r=new WO(i);return r.capacity=t,this.bindArrayBuffer(r),this._gl.bufferData(this._gl.ARRAY_BUFFER,t,this._gl.DYNAMIC_DRAW),r.references=1,r}deleteInstancesBuffer(t){this._gl.deleteBuffer(t)}_clientWaitAsync(t,i=0,r=10){let n=this._gl;return new Promise((o,a)=>{let l=()=>{let c=n.clientWaitSync(t,i,0);if(c==n.WAIT_FAILED){a();return}if(c==n.TIMEOUT_EXPIRED){setTimeout(l,r);return}o()};l()})}_readPixelsAsync(t,i,r,n,o,a,l){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");let c=this._gl,h=c.createBuffer();c.bindBuffer(c.PIXEL_PACK_BUFFER,h),c.bufferData(c.PIXEL_PACK_BUFFER,l.byteLength,c.STREAM_READ),c.readPixels(t,i,r,n,o,a,0),c.bindBuffer(c.PIXEL_PACK_BUFFER,null);let u=c.fenceSync(c.SYNC_GPU_COMMANDS_COMPLETE,0);return u?(c.flush(),this._clientWaitAsync(u,0,10).then(()=>(c.deleteSync(u),c.bindBuffer(c.PIXEL_PACK_BUFFER,h),c.getBufferSubData(c.PIXEL_PACK_BUFFER,0,l),c.bindBuffer(c.PIXEL_PACK_BUFFER,null),c.deleteBuffer(h),l))):null}dispose(){this.hideLoadingUI(),this._rescalePostProcess&&this._rescalePostProcess.dispose(),Fx(this,this._renderingCanvas),super.dispose()}}return s.ALPHA_DISABLE=0,s.ALPHA_ADD=1,s.ALPHA_COMBINE=2,s.ALPHA_SUBTRACT=3,s.ALPHA_MULTIPLY=4,s.ALPHA_MAXIMIZED=5,s.ALPHA_ONEONE=6,s.ALPHA_PREMULTIPLIED=7,s.ALPHA_PREMULTIPLIED_PORTERDUFF=8,s.ALPHA_INTERPOLATE=9,s.ALPHA_SCREENMODE=10,s.DELAYLOADSTATE_NONE=0,s.DELAYLOADSTATE_LOADED=1,s.DELAYLOADSTATE_LOADING=2,s.DELAYLOADSTATE_NOTLOADED=4,s.NEVER=512,s.ALWAYS=519,s.LESS=513,s.EQUAL=514,s.LEQUAL=515,s.GREATER=516,s.GEQUAL=518,s.NOTEQUAL=517,s.KEEP=7680,s.REPLACE=7681,s.INCR=7682,s.DECR=7683,s.INVERT=5386,s.INCR_WRAP=34055,s.DECR_WRAP=34056,s.TEXTURE_CLAMP_ADDRESSMODE=0,s.TEXTURE_WRAP_ADDRESSMODE=1,s.TEXTURE_MIRROR_ADDRESSMODE=2,s.TEXTUREFORMAT_ALPHA=0,s.TEXTUREFORMAT_LUMINANCE=1,s.TEXTUREFORMAT_LUMINANCE_ALPHA=2,s.TEXTUREFORMAT_RGB=4,s.TEXTUREFORMAT_RGBA=5,s.TEXTUREFORMAT_RED=6,s.TEXTUREFORMAT_R=6,s.TEXTUREFORMAT_RG=7,s.TEXTUREFORMAT_RED_INTEGER=8,s.TEXTUREFORMAT_R_INTEGER=8,s.TEXTUREFORMAT_RG_INTEGER=9,s.TEXTUREFORMAT_RGB_INTEGER=10,s.TEXTUREFORMAT_RGBA_INTEGER=11,s.TEXTURETYPE_UNSIGNED_BYTE=0,s.TEXTURETYPE_UNSIGNED_INT=0,s.TEXTURETYPE_FLOAT=1,s.TEXTURETYPE_HALF_FLOAT=2,s.TEXTURETYPE_BYTE=3,s.TEXTURETYPE_SHORT=4,s.TEXTURETYPE_UNSIGNED_SHORT=5,s.TEXTURETYPE_INT=6,s.TEXTURETYPE_UNSIGNED_INTEGER=7,s.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,s.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,s.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,s.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,s.TEXTURETYPE_UNSIGNED_INT_24_8=12,s.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,s.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,s.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,s.TEXTURE_NEAREST_SAMPLINGMODE=1,s.TEXTURE_BILINEAR_SAMPLINGMODE=2,s.TEXTURE_TRILINEAR_SAMPLINGMODE=3,s.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,s.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,s.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,s.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,s.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,s.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,s.TEXTURE_NEAREST_LINEAR=7,s.TEXTURE_NEAREST_NEAREST=1,s.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,s.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,s.TEXTURE_LINEAR_LINEAR=2,s.TEXTURE_LINEAR_NEAREST=12,s.TEXTURE_EXPLICIT_MODE=0,s.TEXTURE_SPHERICAL_MODE=1,s.TEXTURE_PLANAR_MODE=2,s.TEXTURE_CUBIC_MODE=3,s.TEXTURE_PROJECTION_MODE=4,s.TEXTURE_SKYBOX_MODE=5,s.TEXTURE_INVCUBIC_MODE=6,s.TEXTURE_EQUIRECTANGULAR_MODE=7,s.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,s.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,s.SCALEMODE_FLOOR=1,s.SCALEMODE_NEAREST=2,s.SCALEMODE_CEILING=3,s})();var mH=N.Compose(p.One(),q.FromEulerAngles(0,Math.PI,0),p.Zero()),Ze=class s extends Xe{get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._cache.useBillboardPosition=(this._billboardMode&s.BILLBOARDMODE_USE_POSITION)!==0,this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==s.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(e,t=null,i=!0){super(e,t,!1),this._forward=new p(0,0,1),this._up=new p(0,1,0),this._right=new p(1,0,0),this._position=p.Zero(),this._rotation=p.Zero(),this._rotationQuaternion=null,this._scaling=p.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=s.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=N.Zero(),this._usePivotMatrix=!1,this._absolutePosition=p.Zero(),this._absoluteScaling=p.Zero(),this._absoluteRotationQuaternion=q.Identity(),this._pivotMatrix=N.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new U,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}isUsingPostMultiplyPivotMatrix(){return this._postMultiplyPivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return p.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return p.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return p.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=N.Identity()),this._poseMatrix}_isSynchronized(){let e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==s.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();let e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=N.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){let r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);r&&i&&i(this,r);for(let n of this.getChildTransformNodes(!0))n.instantiateHierarchy(r,t,i);return r}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||q.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,r;if(e.x===void 0){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],r=arguments[2]}else t=e.x,i=e.y,r=e.z;if(this.parent){let n=O.Matrix[0];this.parent.getWorldMatrix().invertToRef(n),p.TransformCoordinatesFromFloatsToRef(t,i,r,n,this.position)}else this.position.x=t,this.position.y=i,this.position.z=r;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=p.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();let e=O.Matrix[0];return this._localMatrix.invertToRef(e),p.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=p.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,r=0,n=Ke.LOCAL){let o=s._LookAtVectorCache,a=n===Ke.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(a,o),this.setDirection(o,t,i,r),n===Ke.WORLD&&this.parent)if(this.rotationQuaternion){let l=O.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);let c=O.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),l.multiplyToRef(c,l),this.rotationQuaternion.fromRotationMatrix(l)}else{let l=O.Quaternion[0];q.FromEulerVectorToRef(this.rotation,l);let c=O.Matrix[0];l.toRotationMatrix(c);let h=O.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(h),h.invert(),c.multiplyToRef(h,c),l.fromRotationMatrix(c),l.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){let t=p.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return p.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,r=0){let n=-Math.atan2(e.z,e.x)+Math.PI/2,o=Math.sqrt(e.x*e.x+e.z*e.z),a=-Math.atan2(e.y,o);return this.rotationQuaternion?q.RotationYawPitchRollToRef(n+t,a+i,r,this.rotationQuaternion):(this.rotation.x=a+i,this.rotation.y=n+t,this.rotation.z=r),this}setPivotPoint(e,t=Ke.LOCAL){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);let i=this.getWorldMatrix();if(t==Ke.WORLD){let r=O.Matrix[0];i.invertToRef(r),e=p.TransformCoordinates(e,r)}return this.setPivotMatrix(N.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){let e=p.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){let e=p.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),p.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(let t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;let r=O.Quaternion[0],n=O.Vector3[0],o=O.Vector3[1],a=O.Matrix[1];N.IdentityToRef(a);let l=O.Matrix[0];this.computeWorldMatrix(!0);let c=this.rotationQuaternion;return c||(c=s._TmpRotation,q.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),N.ComposeToRef(this.scaling,c,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(a),l.multiplyToRef(a,l)),l.decompose(o,r,n,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(r):r.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(o),this.position.copyFrom(n),this.parent=e,i&&this.setPivotMatrix(N.Identity()),this}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.setParent(null,t),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(!0),e.getFinalMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let r;if(!i||i===Ke.LOCAL)r=q.RotationAxisToRef(e,t,s._RotationAxisCache),this.rotationQuaternion.multiplyToRef(r,this.rotationQuaternion);else{if(this.parent){let n=this.parent.getWorldMatrix(),o=O.Matrix[0];n.invertToRef(o),e=p.TransformNormal(e,o),n.determinant()<0&&(t*=-1)}r=q.RotationAxisToRef(e,t,s._RotationAxisCache),r.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=q.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));let r=O.Vector3[0],n=O.Vector3[1],o=O.Vector3[2],a=O.Quaternion[0],l=O.Matrix[0],c=O.Matrix[1],h=O.Matrix[2],u=O.Matrix[3];return e.subtractToRef(this.position,r),N.TranslationToRef(r.x,r.y,r.z,l),N.TranslationToRef(-r.x,-r.y,-r.z,c),N.RotationAxisToRef(t,i,h),c.multiplyToRef(h,u),u.multiplyToRef(l,u),u.decompose(n,a,o),this.position.addInPlace(o),a.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){let r=e.scale(t);if(!i||i===Ke.LOCAL){let n=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(n)}else this.setAbsolutePosition(this.getAbsolutePosition().add(r));return this}addRotation(e,t,i){let r;this.rotationQuaternion?r=this.rotationQuaternion:(r=O.Quaternion[1],q.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,r));let n=O.Quaternion[0];return q.RotationYawPitchRollToRef(t,e,i,n),r.multiplyInPlace(n),this.rotationQuaternion||r.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==s.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(e=!1,t=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;let i=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===i||this.isSynchronized()))return this._currentRenderId=i,this._worldMatrix;t=t||this.getScene().activeCamera,this._updateCache();let r=this._cache;r.pivotMatrixUpdated=!1,r.billboardMode=this.billboardMode,r.infiniteDistance=this.infiniteDistance,r.parent=this._parentNode,this._currentRenderId=i,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;let n=this._getEffectiveParent(),o=s._TmpScaling,a=this._position;if(this._infiniteDistance&&!this.parent&&t){let c=t.getWorldMatrix(),h=new p(c.m[12],c.m[13],c.m[14]);a=s._TmpTranslation,a.copyFromFloats(this._position.x+h.x,this._position.y+h.y,this._position.z+h.z)}o.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let l;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,l=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(q.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(l=s._TmpRotation,q.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),this._usePivotMatrix){let c=O.Matrix[1];N.ScalingToRef(o.x,o.y,o.z,c);let h=O.Matrix[0];l.toRotationMatrix(h),this._pivotMatrix.multiplyToRef(c,O.Matrix[4]),O.Matrix[4].multiplyToRef(h,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(a.x,a.y,a.z)}else N.ComposeToRef(o,l,a,this._localMatrix);if(n&&n.getWorldMatrix){if(e&&n.computeWorldMatrix(e),r.useBillboardPath){if(this._transformToBoneReferal){let d=this.parent;d.getSkeleton().prepare(),d.getFinalMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),O.Matrix[7])}else O.Matrix[7].copyFrom(n.getWorldMatrix());let c=O.Vector3[5],h=O.Vector3[6],u=O.Quaternion[0];O.Matrix[7].decompose(h,u,c),N.ScalingToRef(h.x,h.y,h.z,O.Matrix[7]),O.Matrix[7].setTranslation(c),s.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(u,c),this._localMatrix.setTranslation(c)),this._localMatrix.multiplyToRef(O.Matrix[7],this._worldMatrix)}else if(this._transformToBoneReferal){let c=this.parent;c.getSkeleton().prepare(),this._localMatrix.multiplyToRef(c.getFinalMatrix(),O.Matrix[6]),O.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)}else this._localMatrix.multiplyToRef(n.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(r.useBillboardPath&&t&&this.billboardMode&&!r.useBillboardPosition){let c=O.Vector3[0];if(this._worldMatrix.getTranslationToRef(c),O.Matrix[1].copyFrom(t.getViewMatrix()),this._scene.useRightHandedSystem&&O.Matrix[1].multiplyToRef(mH,O.Matrix[1]),O.Matrix[1].setTranslationFromFloats(0,0,0),O.Matrix[1].invertToRef(O.Matrix[0]),(this.billboardMode&s.BILLBOARDMODE_ALL)!==s.BILLBOARDMODE_ALL){O.Matrix[0].decompose(void 0,O.Quaternion[0],void 0);let h=O.Vector3[1];O.Quaternion[0].toEulerAnglesToRef(h),(this.billboardMode&s.BILLBOARDMODE_X)!==s.BILLBOARDMODE_X&&(h.x=0),(this.billboardMode&s.BILLBOARDMODE_Y)!==s.BILLBOARDMODE_Y&&(h.y=0),(this.billboardMode&s.BILLBOARDMODE_Z)!==s.BILLBOARDMODE_Z&&(h.z=0),N.RotationYawPitchRollToRef(h.y,h.x,h.z,O.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(O.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(O.Vector3[0])}else if(r.useBillboardPath&&t&&r.useBillboardPosition){let c=O.Vector3[0];this._worldMatrix.getTranslationToRef(c);let h=t.globalPosition;this._worldMatrix.invertToRef(O.Matrix[1]);let u=O.Vector3[1];p.TransformCoordinatesToRef(h,O.Matrix[1],u),u.normalize();let d=-Math.atan2(u.z,u.x)+Math.PI/2,f=Math.sqrt(u.x*u.x+u.z*u.z),m=-Math.atan2(u.y,f);if(q.RotationYawPitchRollToRef(d,m,0,O.Quaternion[0]),(this.billboardMode&s.BILLBOARDMODE_ALL)!==s.BILLBOARDMODE_ALL){let g=O.Vector3[1];O.Quaternion[0].toEulerAnglesToRef(g),(this.billboardMode&s.BILLBOARDMODE_X)!==s.BILLBOARDMODE_X&&(g.x=0),(this.billboardMode&s.BILLBOARDMODE_Y)!==s.BILLBOARDMODE_Y&&(g.y=0),(this.billboardMode&s.BILLBOARDMODE_Z)!==s.BILLBOARDMODE_Z&&(g.z=0),N.RotationYawPitchRollToRef(g.y,g.x,g.z,O.Matrix[0])}else N.FromQuaternionToRef(O.Quaternion[0],O.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(O.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(O.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):n&&n._nonUniformScaling?this._updateNonUniformScalingState(n._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=N.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){let t=this.getChildren();for(let i=0;i<t.length;++i){let r=t[i];if(r){r.computeWorldMatrix();let n=O.Matrix[0];r._localMatrix.multiplyToRef(this._localMatrix,n);let o=O.Quaternion[0];n.decompose(r.scaling,o,r.position),r.rotationQuaternion?r.rotationQuaternion.copyFrom(o):o.toEulerAnglesToRef(r.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=q.Identity()),this._worldMatrix=N.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),p.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){let r=ae.Clone(()=>new s(e,this.getScene()),this);if(r.name=e,r.id=e,t&&(r.parent=t),!i){let n=this.getDescendants(!0);for(let o=0;o<n.length;o++){let a=n[o];a.clone&&a.clone(e+"."+a.name,r)}}return r}serialize(e){let t=ae.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),ae.AppendSerializedAnimations(this,t),t.ranges=this.serializeAnimationRanges(),t}static Parse(e,t,i){let r=ae.Parse(()=>new s(e.name,t),e,t,i);if(e.localMatrix?r.setPreTransformMatrix(N.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(N.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.animations){for(let n=0;n<e.animations.length;n++){let o=e.animations[n],a=Et("BABYLON.Animation");a&&r.animations.push(a.Parse(o))}Xe.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),r}getChildTransformNodes(e,t){let i=[];return this._getDescendants(i,e,r=>(!t||t(r))&&r instanceof s),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){let i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){let i=this.getChildTransformNodes(!0);for(let r of i)r.parent=null,r.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let r=null,n=null;t&&(this.rotationQuaternion?(n=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(r=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));let o=this.getHierarchyBoundingVectors(e,i),a=o.max.subtract(o.min),l=Math.max(a.x,a.y,a.z);if(l===0)return this;let c=1/l;return this.scaling.scaleInPlace(c),t&&(this.rotationQuaternion&&n?this.rotationQuaternion.copyFrom(n):this.rotation&&r&&this.rotation.copyFrom(r)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}};Ze.BILLBOARDMODE_NONE=0;Ze.BILLBOARDMODE_X=1;Ze.BILLBOARDMODE_Y=2;Ze.BILLBOARDMODE_Z=4;Ze.BILLBOARDMODE_ALL=7;Ze.BILLBOARDMODE_USE_POSITION=128;Ze.BillboardUseParentOrientation=!1;Ze._TmpRotation=q.Zero();Ze._TmpScaling=p.Zero();Ze._TmpTranslation=p.Zero();Ze._LookAtVectorCache=new p(0,0,0);Ze._RotationAxisCache=new q;v([mi("position")],Ze.prototype,"_position",void 0);v([mi("rotation")],Ze.prototype,"_rotation",void 0);v([AO("rotationQuaternion")],Ze.prototype,"_rotationQuaternion",void 0);v([mi("scaling")],Ze.prototype,"_scaling",void 0);v([I("billboardMode")],Ze.prototype,"_billboardMode",void 0);v([I()],Ze.prototype,"scalingDeterminant",void 0);v([I("infiniteDistance")],Ze.prototype,"_infiniteDistance",void 0);v([I()],Ze.prototype,"ignoreNonUniformScaling",void 0);v([I()],Ze.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);var zx=class{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new p(0,0,0),this._diffPositionForCollisions=new p(0,0,0),this._collisionResponse=!0}};var _I=class{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=p.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}},xI=class{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new _I,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new zx,this._enableDistantPicking=!1,this._rawBoundingInfo=null,this._sideOrientationHint=!1}},lt=(()=>{class s extends Ze{static get BILLBOARDMODE_NONE(){return Ze.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return Ze.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return Ze.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return Ze.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return Ze.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return Ze.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(t){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=t}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(t){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=t}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=t}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(t){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=t}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(t){this._internalAbstractMeshDataInfo._collisionRetryCount=t}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(t){this._internalAbstractMeshDataInfo._morphTargetManager!==t&&(this._internalAbstractMeshDataInfo._morphTargetManager=t,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(t){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==t&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=t,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(t){return super._updateNonUniformScalingState(t)?(this._markSubMeshesAsMiscDirty(),!0):!1}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(t){this._internalAbstractMeshDataInfo._rawBoundingInfo=t}set onCollide(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(t)}set onCollisionPositionChange(t){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(t)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(t){if(this._internalAbstractMeshDataInfo._visibility===t)return;let i=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=t,(i===1&&t!==1||i!==1&&t===1)&&this._markSubMeshesAsDirty(r=>{r.markAsMiscDirty(),r.markAsPrePassDirty()})}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(t){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=t}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(t){this._internalAbstractMeshDataInfo._renderingGroupId=t}get material(){return this._internalAbstractMeshDataInfo._material}set material(t){this._setMaterial(t)}_setMaterial(t){this._internalAbstractMeshDataInfo._material!==t&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=t,t&&t.meshMap&&(t.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(t){return this._internalAbstractMeshDataInfo._materialForRenderPass?.[t]}setMaterialForRenderPass(t,i){this.resetDrawCache(t),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[t]=i}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(t){this._internalAbstractMeshDataInfo._receiveShadows!==t&&(this._internalAbstractMeshDataInfo._receiveShadows=t,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(t){this._internalAbstractMeshDataInfo._hasVertexAlpha!==t&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=t,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(t){this._internalAbstractMeshDataInfo._useVertexColors!==t&&(this._internalAbstractMeshDataInfo._useVertexColors=t,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(t){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==t&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=t,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(t){this._internalAbstractMeshDataInfo._numBoneInfluencers!==t&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=t,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(t){this._internalAbstractMeshDataInfo._applyFog!==t&&(this._internalAbstractMeshDataInfo._applyFog=t,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(t){this._internalAbstractMeshDataInfo._enableDistantPicking=t}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(t){t!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=t,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(t)?-1:t}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=t}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(t){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(t)?-1:t}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(t){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=t}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(t){let i=this._internalAbstractMeshDataInfo._skeleton;i&&i.needInitialSkinMatrix&&i._unregisterMeshWithPoseMatrix(this),t&&t.needInitialSkinMatrix&&t._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=t,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(t,i=null){switch(super(t,i,!1),this._internalAbstractMeshDataInfo=new xI,this._waitingMaterialId=null,this.cullingStrategy=s.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new U,this.onCollisionPositionChangeObservable=new U,this.onMaterialChangedObservable=new U,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=X.Red(),this.outlineWidth=.02,this.overlayColor=X.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new p(.5,1,.5),this.ellipsoidOffset=new p(0,0,0),this.edgesWidth=1,this.edgesColor=new oe(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new U,this._onCollisionPositionChange=(r,n,o=null)=>{n.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>K.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),o&&this.onCollideObservable.notifyObservers(o),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},i=this.getScene(),i.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new _r(this.getScene().getEngine(),void 0,void 0,t,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),i.performancePriority){case Wn.Aggressive:this.doNotSyncBoundingInfo=!0;case Wn.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(t){let i=this._uniformBuffer;i.updateMatrix("world",t),i.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),i.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(t){let i="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");i+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);let r=this._internalAbstractMeshDataInfo._skeleton;return r&&(i+=", skeleton: "+r.name),t&&(i+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],i+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),i}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==Ze.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(t,i=!0){if(this.actionManager&&(i||this.actionManager.isRecursive))if(t){if(this.actionManager.hasSpecificTrigger(t))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(t,!1):null}_rebuild(t=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes){for(let i of this.subMeshes)i._rebuild();this.resetDrawCache()}}_resyncLightSources(){this._lightSources.length=0;for(let t of this.getScene().lights)t.isEnabled()&&t.canAffectMesh(this)&&this._lightSources.push(t);this._markSubMeshesAsLightDirty()}_resyncLightSource(t){let i=t.isEnabled()&&t.canAffectMesh(this),r=this._lightSources.indexOf(t),n=!1;if(r===-1){if(!i)return;this._lightSources.push(t)}else{if(i)return;n=!0,this._lightSources.splice(r,1)}this._markSubMeshesAsLightDirty(n)}_unBindEffect(){for(let t of this.subMeshes)t.setEffect(null)}_removeLightSource(t,i){let r=this._lightSources.indexOf(t);r!==-1&&(this._lightSources.splice(r,1),this._markSubMeshesAsLightDirty(i))}_markSubMeshesAsDirty(t){if(this.subMeshes)for(let i of this.subMeshes)for(let r=0;r<i._drawWrappers.length;++r){let n=i._drawWrappers[r];!n||!n.defines||!n.defines.markAllAsDirty||t(n.defines)}}_markSubMeshesAsLightDirty(t=!1){this._markSubMeshesAsDirty(i=>i.markAsLightDirty(t))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(t=>t.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(t=>t.markAsMiscDirty())}markAsDirty(t){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(t){if(this.subMeshes)for(let i of this.subMeshes)i.resetDrawCache(t)}get isBlocked(){return!1}getLOD(t){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(t){return null}setVerticesData(t,i,r,n){return this}updateVerticesData(t,i,r,n){return this}setIndices(t,i){return this}isVerticesDataPresent(t){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){return this.rawBoundingInfo??this.getBoundingInfo()}setBoundingInfo(t){return this._boundingInfo=t,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(t,i,r){return this._boundingInfo=new dr(t,i,r),this._boundingInfo}normalizeToUnitCube(t=!0,i=!1,r){return super.normalizeToUnitCube(t,i,r)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(y.MatricesIndicesKind)&&this.isVerticesDataPresent(y.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(t){}_activate(t,i){return this._renderId=t,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===Ze.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(t,i,r){return this.position.addInPlace(this.calcMovePOV(t,i,r)),this}calcMovePOV(t,i,r){let n=new N;(this.rotationQuaternion?this.rotationQuaternion:q.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(n);let a=p.Zero(),l=this.definedFacingForward?-1:1;return p.TransformCoordinatesFromFloatsToRef(t*l,i,r*l,n,a),a}rotatePOV(t,i,r){return this.rotation.addInPlace(this.calcRotatePOV(t,i,r)),this}calcRotatePOV(t,i,r){let n=this.definedFacingForward?1:-1;return new p(t*n,i,r*n)}refreshBoundingInfo(t=!1,i=!1){return this._boundingInfo&&this._boundingInfo.isLocked?this:(this._refreshBoundingInfo(this._getPositionData(t,i),null),this)}_refreshBoundingInfo(t,i){if(t){let r=ja(t,0,this.getTotalVertices(),i);this._boundingInfo?this._boundingInfo.reConstruct(r.minimum,r.maximum):this._boundingInfo=new dr(r.minimum,r.maximum)}if(this.subMeshes)for(let r=0;r<this.subMeshes.length;r++)this.subMeshes[r].refreshBoundingInfo(t);this._updateBoundingInfo()}_refreshBoundingInfoDirect(t){if(this._boundingInfo?this._boundingInfo.reConstruct(t.minimum,t.maximum):this._boundingInfo=new dr(t.minimum,t.maximum),this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(null);this._updateBoundingInfo()}_getData(t=!1,i=!1,r,n=y.PositionKind){if(r=r??this.getVerticesData(n).slice(),r&&i&&this.morphTargetManager){let o=0,a=0;for(let l=0;l<r.length;l++){let c=r[l];for(let h=0;h<this.morphTargetManager.numTargets;h++){let u=this.morphTargetManager.getTarget(h),d=u.influence;if(d!==0){let f=null;switch(n){case y.PositionKind:f=u.getPositions();break;case y.NormalKind:f=u.getNormals();break;case y.TangentKind:f=u.getTangents();break;case y.UVKind:f=u.getUVs();break}f&&(c+=(f[l]-r[l])*d)}}if(r[l]=c,o++,n===y.PositionKind&&this._positions&&o===3){o=0;let h=a*3;this._positions[a++].copyFromFloats(r[h],r[h+1],r[h+2])}}}if(r&&t&&this.skeleton){let o=this.getVerticesData(y.MatricesIndicesKind),a=this.getVerticesData(y.MatricesWeightsKind);if(a&&o){let l=this.numBoneInfluencers>4,c=l?this.getVerticesData(y.MatricesIndicesExtraKind):null,h=l?this.getVerticesData(y.MatricesWeightsExtraKind):null,u=this.skeleton.getTransformMatrices(this),d=O.Vector3[0],f=O.Matrix[0],m=O.Matrix[1],g=0;for(let _=0;_<r.length;_+=3,g+=4){f.reset();let x,b;for(x=0;x<4;x++)b=a[g+x],b>0&&(N.FromFloat32ArrayToRefScaled(u,Math.floor(o[g+x]*16),b,m),f.addToSelf(m));if(l)for(x=0;x<4;x++)b=h[g+x],b>0&&(N.FromFloat32ArrayToRefScaled(u,Math.floor(c[g+x]*16),b,m),f.addToSelf(m));n===y.NormalKind?p.TransformNormalFromFloatsToRef(r[_],r[_+1],r[_+2],f,d):p.TransformCoordinatesFromFloatsToRef(r[_],r[_+1],r[_+2],f,d),d.toArray(r,_),n===y.PositionKind&&this._positions&&this._positions[_/3].copyFrom(d)}}}return r}getNormalsData(t=!1,i=!1){return this._getData(t,i,null,y.NormalKind)}getPositionData(t=!1,i=!1,r){return this._getData(t,i,r,y.PositionKind)}_getPositionData(t,i){let r=this.getVerticesData(y.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),r&&(t&&this.skeleton||i&&this.morphTargetManager)){if(r=r.slice(),this._generatePointsArray(),this._positions){let n=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(n.length);for(let o=0;o<n.length;o++)this._internalAbstractMeshDataInfo._positions[o]=n[o]?.clone()||new p}return this.getPositionData(t,i,r)}return r}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new dr(p.Zero(),p.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(t){if(!this.subMeshes)return this;let i=this.subMeshes.length;for(let r=0;r<i;r++){let n=this.subMeshes[r];(i>1||!n.IsGlobal)&&n.updateBoundingInfo(t)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(t){return this.getBoundingInfo().isInFrustum(t,this.cullingStrategy)}isCompletelyInFrustum(t){return this.getBoundingInfo().isCompletelyInFrustum(t)}intersectsMesh(t,i=!1,r){let n=this.getBoundingInfo(),o=t.getBoundingInfo();if(n.intersects(o,i))return!0;if(r){for(let a of this.getChildMeshes())if(a.intersectsMesh(t,i,!0))return!0}return!1}intersectsPoint(t){return this.getBoundingInfo().intersectsPoint(t)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(t){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=t}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(t){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);let r=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=r.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,r.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,t,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(t,i,r){if(this._generatePointsArray(),!this._positions)return this;if(!t._lastColliderWorldVertices||!t._lastColliderTransformMatrix.equals(i)){t._lastColliderTransformMatrix=i.clone(),t._lastColliderWorldVertices=[],t._trianglePlanes=[];let n=t.verticesStart,o=t.verticesStart+t.verticesCount;for(let a=n;a<o;a++)t._lastColliderWorldVertices.push(p.TransformCoordinates(this._positions[a],i))}return r._collide(t._trianglePlanes,t._lastColliderWorldVertices,this.getIndices(),t.indexStart,t.indexStart+t.indexCount,t.verticesStart,!!t.getMaterial(),this,this._shouldConvertRHS(),t.getMaterial()?.fillMode===7),this}_processCollisionsForSubMeshes(t,i){let r=this._scene.getCollidingSubMeshCandidates(this,t),n=r.length;for(let o=0;o<n;o++){let a=r.data[o];n>1&&!a._checkCollision(t)||this._collideForSubMesh(a,i,t)}return this}_shouldConvertRHS(){return!1}_checkCollision(t){if(!this.getBoundingInfo()._checkCollision(t))return this;let i=O.Matrix[0],r=O.Matrix[1];return N.ScalingToRef(1/t._radius.x,1/t._radius.y,1/t._radius.z,i),this.worldMatrixFromCache.multiplyToRef(i,r),this._processCollisionsForSubMeshes(t,r),this}_generatePointsArray(){return!1}intersects(t,i,r,n=!1,o,a=!1){let l=new oi,c=this.getClassName(),h=c==="InstancedLinesMesh"||c==="LinesMesh"||c==="GreasedLineMesh"?this.intersectionThreshold:0,u=this.getBoundingInfo();if(!this.subMeshes||!a&&(!t.intersectsSphere(u.boundingSphere,h)||!t.intersectsBox(u.boundingBox,h)))return l;if(n)return l.hit=!a,l.pickedMesh=a?null:this,l.distance=a?0:p.Distance(t.origin,u.boundingSphere.center),l.subMeshId=0,l;if(!this._generatePointsArray())return l;let d=null,f=this._scene.getIntersectingSubMeshCandidates(this,t),m=f.length,g=!1;for(let _=0;_<m;_++){let b=f.data[_].getMaterial();if(b&&(b.fillMode==7||b.fillMode==0||b.fillMode==1||b.fillMode==2||b.fillMode==4)){g=!0;break}}if(!g)return l.hit=!0,l.pickedMesh=this,l.distance=p.Distance(t.origin,u.boundingSphere.center),l.subMeshId=-1,l;for(let _=0;_<m;_++){let x=f.data[_];if(m>1&&!a&&!x.canIntersects(t))continue;let b=x.intersects(t,this._positions,this.getIndices(),i,r);if(b&&(i||!d||b.distance<d.distance)&&(d=b,d.subMeshId=_,i))break}if(d){let _=o??this.getWorldMatrix(),x=O.Vector3[0],b=O.Vector3[1];p.TransformCoordinatesToRef(t.origin,_,x),t.direction.scaleToRef(d.distance,b);let R=p.TransformNormal(b,_).addInPlace(x);return l.hit=!0,l.distance=p.Distance(x,R),l.pickedPoint=R,l.pickedMesh=this,l.bu=d.bu||0,l.bv=d.bv||0,l.subMeshFaceId=d.faceId,l.faceId=d.faceId+f.data[d.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),l.subMeshId=d.subMeshId,l}return l}clone(t,i,r){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=[];return this}dispose(t,i=!1){let r,n=this.getScene();for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),n.freeActiveMeshes(),n.freeRenderingGroups(),n.renderingManager.maintainStateBetweenFrames&&n.renderingManager.restoreDispachedFlags(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.disposeWhenUnowned&&!this._scene.meshes.some(l=>l!==this&&l.actionManager===this.actionManager)&&this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),r=0;r<this._intersectionsInProgress.length;r++){let l=this._intersectionsInProgress[r],c=l._intersectionsInProgress.indexOf(this);l._intersectionsInProgress.splice(c,1)}this._intersectionsInProgress.length=0,n.lights.forEach(l=>{let c=l.includedOnlyMeshes.indexOf(this);c!==-1&&l.includedOnlyMeshes.splice(c,1),c=l.excludedMeshes.indexOf(this),c!==-1&&l.excludedMeshes.splice(c,1);let h=l.getShadowGenerators();if(h){let u=h.values();for(let d=u.next();d.done!==!0;d=u.next()){let m=d.value.getShadowMap();m&&m.renderList&&(c=m.renderList.indexOf(this),c!==-1&&m.renderList.splice(c,1))}}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();let a=n.getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,a.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),a.wipeCaches(),n.removeMesh(this),this._parentContainer){let l=this._parentContainer.meshes.indexOf(this);l>-1&&this._parentContainer.meshes.splice(l,1),this._parentContainer=null}if(i&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!t)for(r=0;r<n.particleSystems.length;r++)n.particleSystems[r].emitter===this&&(n.particleSystems[r].dispose(),r--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(t,i)}_initFacetData(){let t=this._internalAbstractMeshDataInfo._facetData;t.facetNormals||(t.facetNormals=[]),t.facetPositions||(t.facetPositions=[]),t.facetPartitioning||(t.facetPartitioning=new Array),t.facetNb=this.getIndices().length/3|0,t.partitioningSubdivisions=t.partitioningSubdivisions?t.partitioningSubdivisions:10,t.partitioningBBoxRatio=t.partitioningBBoxRatio?t.partitioningBBoxRatio:1.01;for(let i=0;i<t.facetNb;i++)t.facetNormals[i]=p.Zero(),t.facetPositions[i]=p.Zero();return t.facetDataEnabled=!0,this}updateFacetData(){let t=this._internalAbstractMeshDataInfo._facetData;t.facetDataEnabled||this._initFacetData();let i=this.getVerticesData(y.PositionKind),r=this.getIndices(),n=this.getVerticesData(y.NormalKind),o=this.getBoundingInfo();if(t.facetDepthSort&&!t.facetDepthSortEnabled){if(t.facetDepthSortEnabled=!0,r instanceof Uint16Array)t.depthSortedIndices=new Uint16Array(r);else if(r instanceof Uint32Array)t.depthSortedIndices=new Uint32Array(r);else{let l=!1;for(let c=0;c<r.length;c++)if(r[c]>65535){l=!0;break}l?t.depthSortedIndices=new Uint32Array(r):t.depthSortedIndices=new Uint16Array(r)}if(t.facetDepthSortFunction=function(l,c){return c.sqDistance-l.sqDistance},!t.facetDepthSortFrom){let l=this.getScene().activeCamera;t.facetDepthSortFrom=l?l.position:p.Zero()}t.depthSortedFacets=[];for(let l=0;l<t.facetNb;l++){let c={ind:l*3,sqDistance:0};t.depthSortedFacets.push(c)}t.invertedMatrix=N.Identity(),t.facetDepthSortOrigin=p.Zero()}t.bbSize.x=o.maximum.x-o.minimum.x>je?o.maximum.x-o.minimum.x:je,t.bbSize.y=o.maximum.y-o.minimum.y>je?o.maximum.y-o.minimum.y:je,t.bbSize.z=o.maximum.z-o.minimum.z>je?o.maximum.z-o.minimum.z:je;let a=t.bbSize.x>t.bbSize.y?t.bbSize.x:t.bbSize.y;if(a=a>t.bbSize.z?a:t.bbSize.z,t.subDiv.max=t.partitioningSubdivisions,t.subDiv.X=Math.floor(t.subDiv.max*t.bbSize.x/a),t.subDiv.Y=Math.floor(t.subDiv.max*t.bbSize.y/a),t.subDiv.Z=Math.floor(t.subDiv.max*t.bbSize.z/a),t.subDiv.X=t.subDiv.X<1?1:t.subDiv.X,t.subDiv.Y=t.subDiv.Y<1?1:t.subDiv.Y,t.subDiv.Z=t.subDiv.Z<1?1:t.subDiv.Z,t.facetParameters.facetNormals=this.getFacetLocalNormals(),t.facetParameters.facetPositions=this.getFacetLocalPositions(),t.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),t.facetParameters.bInfo=o,t.facetParameters.bbSize=t.bbSize,t.facetParameters.subDiv=t.subDiv,t.facetParameters.ratio=this.partitioningBBoxRatio,t.facetParameters.depthSort=t.facetDepthSort,t.facetDepthSort&&t.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(t.invertedMatrix),p.TransformCoordinatesToRef(t.facetDepthSortFrom,t.invertedMatrix,t.facetDepthSortOrigin),t.facetParameters.distanceTo=t.facetDepthSortOrigin),t.facetParameters.depthSortedFacets=t.depthSortedFacets,n&&le.ComputeNormals(i,r,n,t.facetParameters),t.facetDepthSort&&t.facetDepthSortEnabled){t.depthSortedFacets.sort(t.facetDepthSortFunction);let l=t.depthSortedIndices.length/3|0;for(let c=0;c<l;c++){let h=t.depthSortedFacets[c].ind;t.depthSortedIndices[c*3]=r[h],t.depthSortedIndices[c*3+1]=r[h+1],t.depthSortedIndices[c*3+2]=r[h+2]}this.updateIndices(t.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){let t=this._internalAbstractMeshDataInfo._facetData;return t.facetNormals||this.updateFacetData(),t.facetNormals}getFacetLocalPositions(){let t=this._internalAbstractMeshDataInfo._facetData;return t.facetPositions||this.updateFacetData(),t.facetPositions}getFacetLocalPartitioning(){let t=this._internalAbstractMeshDataInfo._facetData;return t.facetPartitioning||this.updateFacetData(),t.facetPartitioning}getFacetPosition(t){let i=p.Zero();return this.getFacetPositionToRef(t,i),i}getFacetPositionToRef(t,i){let r=this.getFacetLocalPositions()[t],n=this.getWorldMatrix();return p.TransformCoordinatesToRef(r,n,i),this}getFacetNormal(t){let i=p.Zero();return this.getFacetNormalToRef(t,i),i}getFacetNormalToRef(t,i){let r=this.getFacetLocalNormals()[t];return p.TransformNormalToRef(r,this.getWorldMatrix(),i),this}getFacetsAtLocalCoordinates(t,i,r){let n=this.getBoundingInfo(),o=this._internalAbstractMeshDataInfo._facetData,a=Math.floor((t-n.minimum.x*o.partitioningBBoxRatio)*o.subDiv.X*o.partitioningBBoxRatio/o.bbSize.x),l=Math.floor((i-n.minimum.y*o.partitioningBBoxRatio)*o.subDiv.Y*o.partitioningBBoxRatio/o.bbSize.y),c=Math.floor((r-n.minimum.z*o.partitioningBBoxRatio)*o.subDiv.Z*o.partitioningBBoxRatio/o.bbSize.z);return a<0||a>o.subDiv.max||l<0||l>o.subDiv.max||c<0||c>o.subDiv.max?null:o.facetPartitioning[a+o.subDiv.max*l+o.subDiv.max*o.subDiv.max*c]}getClosestFacetAtCoordinates(t,i,r,n,o=!1,a=!0){let l=this.getWorldMatrix(),c=O.Matrix[5];l.invertToRef(c);let h=O.Vector3[8];p.TransformCoordinatesFromFloatsToRef(t,i,r,c,h);let u=this.getClosestFacetAtLocalCoordinates(h.x,h.y,h.z,n,o,a);return n&&p.TransformCoordinatesFromFloatsToRef(n.x,n.y,n.z,l,n),u}getClosestFacetAtLocalCoordinates(t,i,r,n,o=!1,a=!0){let l=null,c=0,h=0,u=0,d=0,f=0,m=0,g=0,_=0,x=this.getFacetLocalPositions(),b=this.getFacetLocalNormals(),C=this.getFacetsAtLocalCoordinates(t,i,r);if(!C)return null;let R=Number.MAX_VALUE,E=R,S,A,L;for(let G=0;G<C.length;G++)S=C[G],A=b[S],L=x[S],d=(t-L.x)*A.x+(i-L.y)*A.y+(r-L.z)*A.z,(!o||o&&a&&d>=0||o&&!a&&d<=0)&&(d=A.x*L.x+A.y*L.y+A.z*L.z,f=-(A.x*t+A.y*i+A.z*r-d)/(A.x*A.x+A.y*A.y+A.z*A.z),m=t+A.x*f,g=i+A.y*f,_=r+A.z*f,c=m-t,h=g-i,u=_-r,E=c*c+h*h+u*u,E<R&&(R=E,l=S,n&&(n.x=m,n.y=g,n.z=_)));return l}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){let t=this._internalAbstractMeshDataInfo._facetData;return t.facetDataEnabled&&(t.facetDataEnabled=!1,t.facetPositions=[],t.facetNormals=[],t.facetPartitioning=new Array,t.facetParameters=null,t.depthSortedIndices=new Uint32Array(0)),this}updateIndices(t,i,r=!1){return this}createNormals(t){let i=this.getVerticesData(y.PositionKind),r=this.getIndices(),n;return this.isVerticesDataPresent(y.NormalKind)?n=this.getVerticesData(y.NormalKind):n=[],le.ComputeNormals(i,r,n,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(y.NormalKind,n,t),this}alignWithNormal(t,i){i||(i=qt.Y);let r=O.Vector3[0],n=O.Vector3[1];return p.CrossToRef(i,t,n),p.CrossToRef(t,n,r),this.rotationQuaternion?q.RotationQuaternionFromAxisToRef(r,t,n,this.rotationQuaternion):p.RotationFromAxisToRef(r,t,n,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw We("EdgesRenderer")}enableEdgesRendering(t,i,r){throw We("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(t=>t.emitter===this)}}return s.OCCLUSION_TYPE_NONE=0,s.OCCLUSION_TYPE_OPTIMISTIC=1,s.OCCLUSION_TYPE_STRICT=2,s.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,s.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,s.CULLINGSTRATEGY_STANDARD=0,s.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,s.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,s.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,s})();P("BABYLON.AbstractMesh",lt);var Hn=class{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){ae.Clone(()=>e,this)}serialize(){return ae.Serialize(this)}parse(e,t,i){ae.Parse(()=>this,e,t,i)}};v([I()],Hn.prototype,"func",null);v([I()],Hn.prototype,"funcRef",null);v([I()],Hn.prototype,"funcMask",null);v([I()],Hn.prototype,"opStencilFail",null);v([I()],Hn.prototype,"opDepthFail",null);v([I()],Hn.prototype,"opStencilDepthPass",null);v([I()],Hn.prototype,"mask",null);v([I()],Hn.prototype,"enabled",null);var or=function(s){return s[s.Created=1]="Created",s[s.Disposed=2]="Disposed",s[s.GetDefineNames=4]="GetDefineNames",s[s.PrepareUniformBuffer=8]="PrepareUniformBuffer",s[s.IsReadyForSubMesh=16]="IsReadyForSubMesh",s[s.PrepareDefines=32]="PrepareDefines",s[s.BindForSubMesh=64]="BindForSubMesh",s[s.PrepareEffect=128]="PrepareEffect",s[s.GetAnimatables=256]="GetAnimatables",s[s.GetActiveTextures=512]="GetActiveTextures",s[s.HasTexture=1024]="HasTexture",s[s.FillRenderTargetTextures=2048]="FillRenderTargetTextures",s[s.HasRenderTargetTextures=4096]="HasRenderTargetTextures",s[s.HardBindForSubMesh=8192]="HardBindForSubMesh",s}(or||{});var se=class s{get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;let t=this._alpha;this._alpha=e,(t===1||e===1)&&this.markAsDirty(s.MiscDirtyFlag+s.PrePassDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(s.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(s.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new U),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new U),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new U),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(s.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(s.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case s.WireFrameFillMode:case s.LineListDrawMode:case s.LineLoopDrawMode:case s.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?s.WireFrameFillMode:s.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case s.PointFillMode:case s.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?s.PointFillMode:s.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(s.MiscDirtyFlag))}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){let t=this.getScene().getEngine().getCaps().fragmentDepthSupported;e&&!t&&F.Warn("Logarithmic depth has been requested for a material on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._markAllSubMeshesAsMiscDirty()}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.sideOrientation=null,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new U,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new Hn,this._useUBO=!1,this._fillMode=s.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;let r=t||me.LastCreatedScene;r&&(this._scene=r,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||H.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new Xt(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._uniformBuffer=new _r(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),s.OnEventObservable.notifyObservers(this,or.Created))}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){let r=t.materialDefines;return r?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}_getEffectiveOrientation(e){return this.sideOrientation!==null?this.sideOrientation:e.sideOrientation}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===s.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===s.MATERIAL_OPAQUE||this._transparencyMode===s.MATERIAL_ALPHATEST}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1?!0:this._disableAlphaBlending?!1:e.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(e=!1){let t=this.getScene().meshes;for(let i of t)if(i.subMeshes){for(let r of i.subMeshes)if(r.getMaterial()===this)for(let n of r._drawWrappers)n&&this._materialContext===n.materialContext&&(n._wasPreviouslyReady=!1,n._wasPreviouslyUsingInstances=null,n._forceRebindOnNextCall=e)}e&&this.markAsDirty(s.AllDirtyFlag)}_preBind(e,t=null){let i=this._scene.getEngine(),n=(t??this.sideOrientation)===s.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,n,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),n}bind(e,t){}buildUniformLayout(){let e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(or.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){let r=i._drawWrapper;this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),r._forceRebindOnNextCall=!1}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null,i){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,Pa(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){let r=this._scene.getEngine();this._cachedDepthWriteState=r.getDepthWrite(),r.setDepthWrite(!1)}if(this.disableColorWrite){let r=this._scene.getEngine();this._cachedColorWriteState=r.getColorWrite(),r.setColorWrite(!1)}if(this.depthFunction!==0){let r=this._scene.getEngine();this._cachedDepthFunctionState=r.getDepthFunction()||0,r.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(or.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(or.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(or.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}_clonePlugins(e,t){let i={};if(this._serializePlugins(i),s._ParsePlugins(i,e,this._scene,t),this.pluginManager)for(let r of this.pluginManager._plugins){let n=e.pluginManager.getPlugin(r.name);n&&r.copyTo(n)}}getBindedMeshes(){if(this.meshMap){let e=[];for(let t in this.meshMap){let i=this.meshMap[t];i&&e.push(i)}return e}else return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(e,t,i,r){let n=ie({clipPlane:!1,useInstances:!1},i),o=this.getScene(),a=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;let l=()=>{if(!this._scene||!this._scene.getEngine())return;let c=o.clipPlane;if(n.clipPlane&&(o.clipPlane=new zs(0,0,0,1)),this._storeEffectOnSubMeshes){let h=!0,u=null;if(e.subMeshes){let d=new Wi(0,0,0,0,0,e,void 0,!1,!1);d.materialDefines&&(d.materialDefines._renderId=-1),this.isReadyForSubMesh(e,d,n.useInstances)||(d.effect&&d.effect.getCompilationError()&&d.effect.allFallbacksProcessed()?u=d.effect.getCompilationError():(h=!1,setTimeout(l,16)))}h&&(this.allowShaderHotSwapping=a,u&&r&&r(u),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=a,t&&t(this)):setTimeout(l,16);n.clipPlane&&(o.clipPlane=c)};l()}forceCompilationAsync(e,t){return new Promise((i,r)=>{this.forceCompilation(e,()=>{i()},t,n=>{r(n)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(s._DirtyCallbackArray.length=0,e&s.TextureDirtyFlag&&s._DirtyCallbackArray.push(s._TextureDirtyCallBack),e&s.LightDirtyFlag&&s._DirtyCallbackArray.push(s._LightsDirtyCallBack),e&s.FresnelDirtyFlag&&s._DirtyCallbackArray.push(s._FresnelDirtyCallBack),e&s.AttributesDirtyFlag&&s._DirtyCallbackArray.push(s._AttributeDirtyCallBack),e&s.MiscDirtyFlag&&s._DirtyCallbackArray.push(s._MiscDirtyCallBack),e&s.PrePassDirtyFlag&&s._DirtyCallbackArray.push(s._PrePassDirtyCallBack),s._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(s._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){let e=this.getScene().meshes;for(let t of e)if(t.subMeshes)for(let i of t.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;let t=this.getScene().meshes;for(let i of t)if(i.subMeshes){for(let r of i.subMeshes)if(r.getMaterial(!1)===this)for(let n of r._drawWrappers)!n||!n.defines||!n.defines.markAllAsDirty||this._materialContext===n.materialContext&&e(n.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;let e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(s._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(s._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(s._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(s._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(s._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(s._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(s._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(s._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(s._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(s._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==Wn.BackwardCompatible){this.checkReadyOnlyOnce=!0;let e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,t,i){let r=this.getScene();if(r.stopAnimation(this),r.freeProcessedMaterials(),r.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(or.Disposed,this._eventInfo),this._parentContainer){let n=this._parentContainer.materials.indexOf(this);n>-1&&this._parentContainer.materials.splice(n,1),this._parentContainer=null}if(i!==!0)if(this.meshMap)for(let n in this.meshMap){let o=this.meshMap[n];o&&(o.material=null,this.releaseVertexArrayObject(o,e))}else{let n=r.meshes;for(let o of n)o.material===this&&!o.sourceMesh&&(o.material=null,this.releaseVertexArrayObject(o,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&(this._eventInfo={})}releaseVertexArrayObject(e,t){let i=e.geometry;if(i)if(this._storeEffectOnSubMeshes){if(e.subMeshes)for(let r of e.subMeshes)i._releaseVertexArrayObject(r.effect),t&&r.effect&&r.effect.dispose()}else i._releaseVertexArrayObject(this._drawWrapper.effect)}serialize(){let e=ae.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,this._serializePlugins(e),e}_serializePlugins(e){if(e.plugins={},this.pluginManager)for(let t of this.pluginManager._plugins)e.plugins[t.getClassName()]=t.serialize()}static Parse(e,t,i){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return F.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;let n=H.Instantiate(e.customType).Parse(e,t,i);return n._loadedUniqueId=e.uniqueId,n}static _ParsePlugins(e,t,i,r){if(e.plugins)for(let n in e.plugins){let o=e.plugins[n],a=t.pluginManager?.getPlugin(o.name);if(!a){let l=H.Instantiate("BABYLON."+n);l&&(a=new l(t))}a?.parse(o,i,r)}}};se.TriangleFillMode=0;se.WireFrameFillMode=1;se.PointFillMode=2;se.PointListDrawMode=3;se.LineListDrawMode=4;se.LineLoopDrawMode=5;se.LineStripDrawMode=6;se.TriangleStripDrawMode=7;se.TriangleFanDrawMode=8;se.ClockWiseSideOrientation=0;se.CounterClockWiseSideOrientation=1;se.TextureDirtyFlag=1;se.LightDirtyFlag=2;se.FresnelDirtyFlag=4;se.AttributesDirtyFlag=8;se.MiscDirtyFlag=16;se.PrePassDirtyFlag=32;se.AllDirtyFlag=63;se.MATERIAL_OPAQUE=0;se.MATERIAL_ALPHATEST=1;se.MATERIAL_ALPHABLEND=2;se.MATERIAL_ALPHATESTANDBLEND=3;se.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0;se.MATERIAL_NORMALBLENDMETHOD_RNM=1;se.OnEventObservable=new U;se._AllDirtyCallBack=s=>s.markAllAsDirty();se._ImageProcessingDirtyCallBack=s=>s.markAsImageProcessingDirty();se._TextureDirtyCallBack=s=>s.markAsTexturesDirty();se._FresnelDirtyCallBack=s=>s.markAsFresnelDirty();se._MiscDirtyCallBack=s=>s.markAsMiscDirty();se._PrePassDirtyCallBack=s=>s.markAsPrePassDirty();se._LightsDirtyCallBack=s=>s.markAsLightDirty();se._AttributeDirtyCallBack=s=>s.markAsAttributesDirty();se._FresnelAndMiscDirtyCallBack=s=>{se._FresnelDirtyCallBack(s),se._MiscDirtyCallBack(s)};se._TextureAndMiscDirtyCallBack=s=>{se._TextureDirtyCallBack(s),se._MiscDirtyCallBack(s)};se._DirtyCallbackArray=[];se._RunDirtyCallBacks=s=>{for(let e of se._DirtyCallbackArray)e(s)};v([I()],se.prototype,"id",void 0);v([I()],se.prototype,"uniqueId",void 0);v([I()],se.prototype,"name",void 0);v([I()],se.prototype,"metadata",void 0);v([I()],se.prototype,"checkReadyOnEveryCall",void 0);v([I()],se.prototype,"checkReadyOnlyOnce",void 0);v([I()],se.prototype,"state",void 0);v([I("alpha")],se.prototype,"_alpha",void 0);v([I("backFaceCulling")],se.prototype,"_backFaceCulling",void 0);v([I("cullBackFaces")],se.prototype,"_cullBackFaces",void 0);v([I()],se.prototype,"sideOrientation",void 0);v([I("alphaMode")],se.prototype,"_alphaMode",void 0);v([I()],se.prototype,"_needDepthPrePass",void 0);v([I()],se.prototype,"disableDepthWrite",void 0);v([I()],se.prototype,"disableColorWrite",void 0);v([I()],se.prototype,"forceDepthWrite",void 0);v([I()],se.prototype,"depthFunction",void 0);v([I()],se.prototype,"separateCullingPass",void 0);v([I("fogEnabled")],se.prototype,"_fogEnabled",void 0);v([I()],se.prototype,"pointSize",void 0);v([I()],se.prototype,"zOffset",void 0);v([I()],se.prototype,"zOffsetUnits",void 0);v([I()],se.prototype,"pointsCloud",null);v([I()],se.prototype,"fillMode",null);v([I()],se.prototype,"useLogarithmicDepth",null);v([I()],se.prototype,"transparencyMode",null);var Hs=class s extends se{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().addMultiMaterial(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}_hookArray(e){let t=e.push;e.push=(...r)=>{let n=t.apply(e,r);return this._markAllSubMeshesAsTexturesDirty(),n};let i=e.splice;e.splice=(r,n)=>{let o=i.apply(e,[r,n]);return this._markAllSubMeshesAsTexturesDirty(),o}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){if(super.hasTexture(e))return!0;for(let t=0;t<this.subMaterials.length;t++)if(this.subMaterials[t]?.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let r=0;r<this.subMaterials.length;r++){let n=this.subMaterials[r];if(n){if(n._storeEffectOnSubMeshes){if(!n.isReadyForSubMesh(e,t,i))return!1;continue}if(!n.isReady(e))return!1}}return!0}clone(e,t){let i=new s(e,this.getScene());for(let r=0;r<this.subMaterials.length;r++){let n=null,o=this.subMaterials[r];t&&o?n=o.clone(e+"-"+o.name):n=this.subMaterials[r],i.subMaterials.push(n)}return i}serialize(){let e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,di&&(e.tags=di.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){let i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){let r=this.getScene();if(!r)return;if(i)for(let o=0;o<this.subMaterials.length;o++){let a=this.subMaterials[o];a&&a.dispose(e,t)}let n=r.multiMaterials.indexOf(this);n>=0&&r.multiMaterials.splice(n,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){let i=new s(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,di&&di.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(r=>i.subMaterials.push(t.getLastMaterialById(r))),i}};P("BABYLON.MultiMaterial",Hs);var Wx=class{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}};var pd=class{},vI=class{constructor(){this.visibleInstances={},this.batchCache=new Hx,this.batchCacheReplacementModeInFrozenMode=new Hx,this.instancesBufferSize=32*16*4}},Hx=class{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=[],this.hardwareInstancedRendering=[]}},TI=class{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}},CI=class{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}},k=class s extends lt{static _GetDefaultSideOrientation(e){return e||s.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(y.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(y.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new U),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new U),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new U),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new U),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new U),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this.forcedInstanceCount||this._thinInstanceDataStorage.instancesCount||0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get sideOrientation(){return this._internalMeshDataInfo._sideOrientation}set sideOrientation(e){this._internalMeshDataInfo._sideOrientation=e,this._internalAbstractMeshDataInfo._sideOrientationHint=this._scene.useRightHandedSystem&&e===1||!this._scene.useRightHandedSystem&&e===0}get overrideMaterialSideOrientation(){return this.sideOrientation}set overrideMaterialSideOrientation(e){this.sideOrientation=e,this.material&&(this.material.sideOrientation=null)}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){e&&(this.material&&this.material.sideOrientation===null||this._internalAbstractMeshDataInfo._sideOrientationHint)&&(e.sideOrientation=null),this._setMaterial(e)}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(e,t=null,i=null,r=null,n,o=!0){if(super(e,t),this._internalMeshDataInfo=new CI,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new vI,this._thinInstanceDataStorage=new TI,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=s.DEFAULTSIDE,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._scene.useRightHandedSystem?this.sideOrientation=0:this.sideOrientation=1,this._onBeforeDraw=(a,l,c)=>{a&&c&&(this._uniformBuffer?this.transferToEffect(l):c.bindOnlyWorldMatrix(l))},r){if(r._geometry&&r._geometry.applyToMesh(this),ei.DeepCopy(r,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo","physicsBody","physicsImpostor"],["_poseMatrix"]),this._internalMeshDataInfo._source=r,t.useClonedMeshMap&&(r._internalMeshDataInfo.meshMap||(r._internalMeshDataInfo.meshMap={}),r._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=r._originalBuilderSideOrientation,this._creationDataStorage=r._creationDataStorage,r._ranges){let a=r._ranges;for(let l in a)Object.prototype.hasOwnProperty.call(a,l)&&a[l]&&this.createAnimationRange(l,a[l].from,a[l].to)}if(r.metadata&&r.metadata.clone?this.metadata=r.metadata.clone():this.metadata=r.metadata,this._internalMetadata=r._internalMetadata,di&&di.HasTags(r)&&di.AddTagsTo(this,di.GetTags(r,!0)),this.setEnabled(r.isEnabled(!1)),this.parent=r.parent,this.setPivotMatrix(r.getPivotMatrix(),this._postMultiplyPivotMatrix),this.id=e+"."+r.id,this.material=r.material,!n){let a=r.getDescendants(!0);for(let l=0;l<a.length;l++){let c=a[l];c.clone&&c.clone(e+"."+c.name,this)}}if(r.morphTargetManager&&(this.morphTargetManager=r.morphTargetManager),t.getPhysicsEngine){let a=t.getPhysicsEngine();if(o&&a)if(a.getPluginVersion()===1){let l=a.getImpostorForPhysicsObject(r);l&&(this.physicsImpostor=l.clone(this))}else a.getPluginVersion()===2&&r.physicsBody&&r.physicsBody.clone(this)}for(let a=0;a<t.particleSystems.length;a++){let l=t.particleSystems[a];l.emitter===r&&l.clone(l.name,this)}this.skeleton=r.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}i!==null&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=a=>{a.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new U(this._internalMeshDataInfo._onMeshReadyObserverAdded),r&&r.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,i){let r=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));r.parent=e||this.parent,r.position=this.position.clone(),r.scaling=this.scaling.clone(),this.rotationQuaternion?r.rotationQuaternion=this.rotationQuaternion.clone():r.rotation=this.rotation.clone(),i&&i(this,r);for(let n of this.getChildTransformNodes(!0))n.getClassName()==="InstancedMesh"&&r.getClassName()==="Mesh"&&n.sourceMesh===this?n.instantiateHierarchy(r,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:r},i):n.instantiateHierarchy(r,t,i);return r}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){let i=this.getIndices(),r=this.getVerticesData(y.PositionKind);r&&i&&(t+=", flat shading: "+(r.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(let e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){let e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return F.Warn("You cannot use a mesh as LOD level twice"),this;let i=new Wx(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){let t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){let r=t._LODLevels[i];if(r.distanceOrScreenCoverage===e)return r.mesh}return null}removeLODLevel(e){let t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){let i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;let r=t||this.getBoundingInfo().boundingSphere,n=e.mode===Ce.ORTHOGRAPHIC_CAMERA?e.minZ:r.centerWorld.subtract(e.globalPosition).length(),o=n,a=1;if(i._useLODScreenCoverage){let l=e.screenArea,c=r.radiusWorld*e.minZ/n;c=c*c*Math.PI,o=c/l,a=-1}if(a*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>a*o)return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,this),this;for(let l=0;l<i._LODLevels.length;l++){let c=i._LODLevels[l];if(a*c.distanceOrScreenCoverage<a*o){if(c.mesh){if(c.mesh.delayLoadState===4)return c.mesh._checkDelayState(),this;if(c.mesh.delayLoadState===2)return this;c.mesh._preActivate(),c.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,c.mesh),c.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i,r){if(!this._geometry)return null;let n=r?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e]?.getFloatData(this.instances.length+1,i||t&&this._geometry.meshes.length!==1);return n||(n=this._geometry.getVerticesData(e,t,i)),n}getVertexBuffer(e,t){return this._geometry?(t?void 0:this._userInstancedBuffersStorage?.vertexBuffers[e])??this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){return this._geometry?!t&&this._userInstancedBuffersStorage?.vertexBuffers[e]!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e,t){if(!this._geometry)return this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1;if(!t){let i=this._userInstancedBuffersStorage?.vertexBuffers[e];if(i)return i.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){let i=[];return this._delayInfo&&this._delayInfo.forEach(function(r){i.push(r)}),i}let t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(let i in this._userInstancedBuffersStorage.vertexBuffers)t.indexOf(i)===-1&&t.push(i);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;let i=this.getEngine(),r=this.getScene(),n=t||i.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();let o=this.material||r.defaultMaterial;if(o){if(o._storeEffectOnSubMeshes)for(let l of this.subMeshes){let c=l.getMaterial();if(c){if(c._storeEffectOnSubMeshes){if(!c.isReadyForSubMesh(this,l,n))return!1}else if(!c.isReady(this,n))return!1}}else if(!o.isReady(this,n))return!1}let a=i.currentRenderPassId;for(let l of this.lightSources){let c=l.getShadowGenerators();if(!c)continue;let h=c.values();for(let u=h.next();u.done!==!0;u=h.next()){let d=u.value;if(d&&(!d.getShadowMap()?.renderList||d.getShadowMap()?.renderList&&d.getShadowMap()?.renderList?.indexOf(this)!==-1)){let m=d.getShadowMap().renderPassIds??[i.currentRenderPassId];for(let g=0;g<m.length;++g){i.currentRenderPassId=m[g];for(let _ of this.subMeshes)if(!d.isReady(_,n,_.getMaterial()?.needAlphaBlendingForMesh(this)??!1))return i.currentRenderPassId=a,!1}i.currentRenderPassId=a}}}for(let l of this._internalMeshDataInfo._LODLevels)if(l.mesh&&!l.mesh.isReady(n))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){let e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null,this)}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}_createGlobalSubMesh(e){let t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){let i=this.getIndices();if(!i)return null;let r=i.length,n=!1;if(e)n=!0;else for(let o of this.subMeshes){if(o.indexStart+o.indexCount>r){n=!0;break}if(o.verticesStart+o.verticesCount>t){n=!0;break}}if(!n)return this.subMeshes[0]}return this.releaseSubMeshes(),new Wi(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;let t=this.getTotalIndices(),i=t/e|0,r=0;for(;i%3!==0;)i++;this.releaseSubMeshes();for(let n=0;n<e&&!(r>=t);n++)Wi.CreateFromIndices(0,r,n===e-1?t-r:i,this,void 0,!1),r+=i;this.refreshBoundingInfo(),this.synchronizeInstances()}setVerticesData(e,t,i=!1,r){if(this._geometry)this._geometry.setVerticesData(e,t,i,r);else{let n=new le;n.set(t,e);let o=this.getScene();new nr(nr.RandomId(),o,n,i,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){let i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=nr.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,r){return this._geometry?(r?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){let i=this.getVerticesData(y.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(y.PositionKind,i,!1,!1),t){let r=this.getIndices(),n=this.getVerticesData(y.NormalKind);if(!n)return this;le.ComputeNormals(i,r,n),this.updateVerticesData(y.NormalKind,n,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;let e=this._geometry,t=this._geometry.copy(nr.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndexBuffer(e,t,i){let r=this._geometry;r||(r=new nr(nr.RandomId(),this.getScene(),void 0,void 0,this)),r.setIndexBuffer(e,t,i)}setIndices(e,t=null,i=!1){if(this._geometry)this._geometry.setIndices(e,t,i);else{let r=new le;r.indices=e;let n=this.getScene();new nr(nr.RandomId(),n,r,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i,r=!0){if(!this._geometry)return this;let n=this.getScene().getEngine(),o;if(this._unIndexed)o=null;else switch(this._getRenderingFillMode(i)){case se.PointFillMode:o=null;break;case se.WireFrameFillMode:o=e._getLinesIndexBuffer(this.getIndices(),n);break;default:case se.TriangleFillMode:o=this._geometry.getIndexBuffer();break}return this._bindDirect(t,o,r)}_bindDirect(e,t,i=!0){return this._geometry?(this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(e),!i||!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(e,t):this._geometry._bind(e,t,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this):this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);let n=this.getScene().getEngine();return this._unIndexed||t==se.PointFillMode?n.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==se.WireFrameFillMode?n.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):n.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}let i=this.getScene(),r=i._isInIntermediateRendering(),n=r?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,o=this._instanceDataStorage.batchCache;if(o.mustReturn=!1,o.renderSelf[e]=t||!n&&this.isEnabled()&&this.isVisible,o.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){let a=this._instanceDataStorage.visibleInstances,l=i.getRenderId(),c=r?a.intermediateDefaultRenderId:a.defaultRenderId;o.visibleInstances[e]=a[l],!o.visibleInstances[e]&&c&&(o.visibleInstances[e]=a[c])}return o.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&o.visibleInstances[e]!==null&&o.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=o,o}_renderWithInstances(e,t,i,r,n){let o=i.visibleInstances[e._id],a=o?o.length:0,l=this._instanceDataStorage,c=l.instancesBufferSize,h=l.instancesBuffer,u=l.instancesPreviousBuffer,f=(a+1)*16*4;for(;l.instancesBufferSize<f;)l.instancesBufferSize*=2;(!l.instancesData||c!=l.instancesBufferSize)&&(l.instancesData=new Float32Array(l.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousData||c!=l.instancesBufferSize)&&(l.instancesPreviousData=new Float32Array(l.instancesBufferSize/4));let m=0,g=0,_=i.renderSelf[e._id],x=!h||c!==l.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!l.isFrozen||x)){let b=this.getWorldMatrix();if(_&&(this._scene.needsPreviousWorldMatrices&&(l.masterMeshPreviousWorldMatrix?(l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,m),l.masterMeshPreviousWorldMatrix.copyFrom(b)):(l.masterMeshPreviousWorldMatrix=b.clone(),l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,m))),b.copyToArray(l.instancesData,m),m+=16,g++),o){if(s.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&e.getMaterial()?.needAlphaBlendingForMesh(e.getRenderingMesh())){let C=this._scene.activeCamera.globalPosition;for(let R=0;R<o.length;R++){let E=o[R];E._distanceToCamera=p.Distance(E.getBoundingInfo().boundingSphere.centerWorld,C)}o.sort((R,E)=>R._distanceToCamera>E._distanceToCamera?-1:R._distanceToCamera<E._distanceToCamera?1:0)}for(let C=0;C<o.length;C++){let R=o[C],E=R.getWorldMatrix();E.copyToArray(l.instancesData,m),this._scene.needsPreviousWorldMatrices&&(R._previousWorldMatrix?(R._previousWorldMatrix.copyToArray(l.instancesPreviousData,m),R._previousWorldMatrix.copyFrom(E)):(R._previousWorldMatrix=E.clone(),R._previousWorldMatrix.copyToArray(l.instancesPreviousData,m))),m+=16,g++}}}else g=(_?1:0)+a;return x?(h&&h.dispose(),u&&u.dispose(),h=new gi(n,l.instancesData,!0,16,!1,!0),l.instancesBuffer=h,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=h.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=h.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=h.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=h.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(u=new gi(n,l.instancesPreviousData,!0,16,!1,!0),l.instancesPreviousBuffer=u,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=u.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=u.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=u.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=u.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(h.updateDirectly(l.instancesData,0,g),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&u.updateDirectly(l.instancesPreviousData,0,g)),this._processInstancedBuffers(o,_),this.getScene()._activeIndices.addCount(e.indexCount*g,!1),n._currentDrawContext&&(n._currentDrawContext.useInstancing=!0),this._bind(e,r,t),this._draw(e,t,g),this._scene.needsPreviousWorldMatrices&&!x&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&u.updateDirectly(l.instancesData,0,g),n.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,r){let n=this._thinInstanceDataStorage?.instancesCount??0;this.getScene()._activeIndices.addCount(e.indexCount*n,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,n),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,n):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),r.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,r,n,o,a,l){let c=this.getScene(),h=c.getEngine();if(r=this._getRenderingFillMode(r),o&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,r,i,h),this;if(o)this._renderWithInstances(t,r,n,i,h);else{h._currentDrawContext&&(h._currentDrawContext.useInstancing=!1);let u=0;n.renderSelf[t._id]&&(a&&a(!1,e.getWorldMatrix(),l),u++,this._draw(t,r,this._instanceDataStorage.overridenInstanceCount));let d=n.visibleInstances[t._id];if(d){let f=d.length;u+=f;for(let m=0;m<f;m++){let _=d[m].getWorldMatrix();a&&a(!0,_,l),this._draw(t,r)}}c._activeIndices.addCount(t.indexCount*u,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(let t in this._userInstancedBuffersStorage.vertexBuffers){let i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}renderWithRenderPassId(e,t,i,r,n=!0){let o=this._scene.getEngine(),a=o.currentRenderPassId;if(e!==void 0&&(o.currentRenderPassId=e),r)(!n||n&&r.isInFrustum(this._scene._frustumPlanes))&&this.render(r,!!t,i);else for(let l=0;l<this.subMeshes.length;l++){let c=this.subMeshes[l];(!n||n&&c.isInFrustum(this._scene._frustumPlanes))&&this.render(c,!!t,i)}return e!==void 0&&(o.currentRenderPassId=a),this}render(e,t,i){let r=this.getScene();this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1;let n=r.activeCameras?.length??0;if((n>1&&r.activeCamera===r.activeCameras[0]||n<=1)&&this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;let a=this._getInstancesRenderList(e._id,!!i);if(a.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;let l=r.getEngine(),c=0,h=null;this.ignoreCameraMaxZ&&r.activeCamera&&!r._isInIntermediateRendering()&&(c=r.activeCamera.maxZ,h=r.activeCamera,r.activeCamera.maxZ=0,r.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);let u=e.getRenderingMesh(),d=a.hardwareInstancedRendering[e._id]||u.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,f=this._instanceDataStorage,m=e.getMaterial();if(!m)return h&&(h.maxZ=c,r.updateTransformMatrix(!0)),this;if(!f.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==m){if(m._storeEffectOnSubMeshes){if(!m.isReadyForSubMesh(this,e,d))return h&&(h.maxZ=c,r.updateTransformMatrix(!0)),this}else if(!m.isReady(this,d))return h&&(h.maxZ=c,r.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=m}else if(m._storeEffectOnSubMeshes&&!e._drawWrapper?._wasPreviouslyReady||!m._storeEffectOnSubMeshes&&!m._getDrawWrapper()._wasPreviouslyReady)return h&&(h.maxZ=c,r.updateTransformMatrix(!0)),this;t&&l.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);let g;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?g=e._drawWrapper:g=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();let _=g?.effect??null;for(let A of r._beforeRenderingMeshStage)A.action(this,e,a,_);if(!g||!_)return h&&(h.maxZ=c,r.updateTransformMatrix(!0)),this;let x=i||this,b;if(!f.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this._internalMeshDataInfo._effectiveMaterial.sideOrientation!==null||this._internalMeshDataInfo._effectiveMaterial.twoSidedLighting)){let A=x._getWorldMatrixDeterminant();b=this._internalMeshDataInfo._effectiveMaterial._getEffectiveOrientation(this),A<0&&(b=b===se.ClockWiseSideOrientation?se.CounterClockWiseSideOrientation:se.ClockWiseSideOrientation),f.sideOrientation=b}else b=f.sideOrientation;let C=this._internalMeshDataInfo._effectiveMaterial._preBind(g,b);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&l.setDepthWrite(!0);let R=this._internalMeshDataInfo._effectiveMaterial,E=R.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),d||this._bind(e,_,E,!1);let S=x.getWorldMatrix();R._storeEffectOnSubMeshes?R.bindForSubMesh(S,this,e):R.bind(S,this),!R.backFaceCulling&&R.separateCullingPass&&(l.setState(!0,R.zOffset,!1,!C,R.cullBackFaces,R.stencil,R.zOffsetUnits),this._processRendering(this,e,_,E,a,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),l.setState(!0,R.zOffset,!1,C,R.cullBackFaces,R.stencil,R.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,_,E,a,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(let A of r._afterRenderingMeshStage)A.action(this,e,a,_);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),h&&(h.maxZ=c,r.updateTransformMatrix(!0)),r.performancePriority===Wn.Aggressive&&!f.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(y.MatricesWeightsKind)&&(this.isVerticesDataPresent(y.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){let e=this.getVerticesData(y.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){let r=e[i]+e[i+1]+e[i+2]+e[i+3];if(r===0)e[i]=1;else{let n=1/r;e[i]*=n,e[i+1]*=n,e[i+2]*=n,e[i+3]*=n}}this.setVerticesData(y.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){let e=this.getVerticesData(y.MatricesWeightsExtraKind),t=this.getVerticesData(y.MatricesWeightsKind),i=t.length;for(let r=0;r<i;r+=4){let n=t[r]+t[r+1]+t[r+2]+t[r+3];if(n+=e[r]+e[r+1]+e[r+2]+e[r+3],n===0)t[r]=1;else{let o=1/n;t[r]*=o,t[r+1]*=o,t[r+2]*=o,t[r+3]*=o,e[r]*=o,e[r+1]*=o,e[r+2]*=o,e[r+3]*=o}}this.setVerticesData(y.MatricesWeightsKind,t),this.setVerticesData(y.MatricesWeightsKind,e)}validateSkinning(){let e=this.getVerticesData(y.MatricesWeightsExtraKind),t=this.getVerticesData(y.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};let i=t.length,r=0,n=0,o=0,a=0,l=e===null?4:8,c=[];for(let _=0;_<=l;_++)c[_]=0;let h=.001;for(let _=0;_<i;_+=4){let x=t[_],b=x,C=b===0?0:1;for(let R=1;R<l;R++){let E=R<4?t[_+R]:e[_+R-4];E>x&&r++,E!==0&&C++,b+=E,x=E}if(c[C]++,C>o&&(o=C),b===0)n++;else{let R=1/b,E=0;for(let S=0;S<l;S++)S<4?E+=Math.abs(t[_+S]-t[_+S]*R):E+=Math.abs(e[_+S-4]-e[_+S-4]*R);E>h&&a++}}let u=this.skeleton.bones.length,d=this.getVerticesData(y.MatricesIndicesKind),f=this.getVerticesData(y.MatricesIndicesExtraKind),m=0;for(let _=0;_<i;_+=4)for(let x=0;x<l;x++){let b=x<4?d[_+x]:f[_+x-4];(b>=u||b<0)&&m++}let g="Number of Weights = "+i/4+`
Maximum influences = `+o+`
Missing Weights = `+n+`
Not Sorted = `+r+`
Not Normalized = `+a+`
WeightCounts = [`+c+`]
Number of bones = `+u+`
Bad Bone Indices = `+m;return{skinned:!0,valid:n===0&&a===0&&m===0,report:g}}_checkDelayState(){let e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);let t=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return H.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this),this.instances.forEach(r=>{r.refreshBoundingInfo(),r._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){let t=this.getScene().materials,i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;let r=this.getScene().multiMaterials;for(i=r.length-1;i>-1;i--)if(r[i].id===e)return this.material=r[i],this;return this}getAnimatables(){let e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(y.PositionKind))return this;let t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(y.PositionKind),r=p.Zero(),n;for(n=0;n<i.length;n+=3)p.TransformCoordinatesFromFloatsToRef(i[n],i[n+1],i[n+2],e,r).toArray(i,n);if(this.setVerticesData(y.PositionKind,i,this.getVertexBuffer(y.PositionKind).isUpdatable()),this.isVerticesDataPresent(y.NormalKind)){for(i=this.getVerticesData(y.NormalKind),n=0;n<i.length;n+=3)p.TransformNormalFromFloatsToRef(i[n],i[n+1],i[n+2],e,r).normalize().toArray(i,n);this.setVerticesData(y.NormalKind,i,this.getVertexBuffer(y.NormalKind).isUpdatable())}if(this.isVerticesDataPresent(y.TangentKind)){for(i=this.getVerticesData(y.TangentKind),n=0;n<i.length;n+=4)p.TransformNormalFromFloatsToRef(i[n],i[n+1],i[n+2],e,r).normalize().toArray(i,n);this.setVerticesData(y.TangentKind,i,this.getVertexBuffer(y.TangentKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",t=null,i,r=!0){return new s(e,this.getScene(),t,this,i,r)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);let i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(let r in i.meshMap){let n=i.meshMap[r];n&&(n._internalMeshDataInfo._source=null,i.meshMap[r]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{let r=this.getScene().meshes;for(let n of r){let o=n;o._internalMeshDataInfo&&o._internalMeshDataInfo._source&&o._internalMeshDataInfo._source===this&&(o._internalMeshDataInfo._source=null)}}i._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,r,n,o,a=!1,l){let c=this.getScene(),h=u=>{let d=u.width,f=u.height,g=this.getEngine().createCanvas(d,f).getContext("2d");g.drawImage(u,0,0);let _=g.getImageData(0,0,d,f).data;this.applyDisplacementMapFromBuffer(_,d,f,t,i,n,o,a),r&&r(this)};return H.LoadImage(e,h,l||(()=>{}),c.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,r,n,o,a,l=!1){if(!this.isVerticesDataPresent(y.PositionKind)||!this.isVerticesDataPresent(y.NormalKind)||!this.isVerticesDataPresent(y.UVKind))return F.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;let c=this.getVerticesData(y.PositionKind,!0,!0),h=this.getVerticesData(y.NormalKind),u=this.getVerticesData(y.UVKind),d=p.Zero(),f=p.Zero(),m=j.Zero();o=o||j.Zero(),a=a||new j(1,1);for(let g=0;g<c.length;g+=3){p.FromArrayToRef(c,g,d),p.FromArrayToRef(h,g,f),j.FromArrayToRef(u,g/3*2,m);let _=Math.abs(m.x*a.x+o.x%1)*(t-1)%t|0,x=Math.abs(m.y*a.y+o.y%1)*(i-1)%i|0,b=(_+x*t)*4,C=e[b]/255,R=e[b+1]/255,E=e[b+2]/255,S=C*.3+R*.59+E*.11;f.normalize(),f.scaleInPlace(r+(n-r)*S),d=d.add(f),d.toArray(c,g)}return le.ComputeNormals(c,this.getIndices(),h),l?(this.setVerticesData(y.PositionKind,c),this.setVerticesData(y.NormalKind,h),this.setVerticesData(y.UVKind,u)):(this.updateVerticesData(y.PositionKind,c),this.updateVerticesData(y.NormalKind,h)),this}_getFlattenedNormals(e,t){let i=new Float32Array(e.length*3),r=0,n=this.sideOrientation===(this._scene.useRightHandedSystem?1:0);for(let o=0;o<e.length;o+=3){let a=p.FromArray(t,e[o]*3),l=p.FromArray(t,e[o+1]*3),c=p.FromArray(t,e[o+2]*3),h=a.subtract(l),u=c.subtract(l),d=p.Normalize(p.Cross(h,u));n&&d.scaleInPlace(-1);for(let f=0;f<3;f++)i[r++]=d.x,i[r++]=d.y,i[r++]=d.z}return i}_convertToUnIndexedMesh(e=!1){let t=this.getVerticesDataKinds(),i=this.getIndices(),r={},n=(l,c)=>{let h=new Float32Array(i.length*c),u=0;for(let d=0;d<i.length;d++)for(let f=0;f<c;f++)h[u++]=l[i[d]*c+f];return h},o=this.getBoundingInfo(),a=this.geometry?this.subMeshes.slice(0):[];for(let l of t)r[l]=this.getVerticesData(l);for(let l of t){let c=this.getVertexBuffer(l),h=c.getSize();if(e&&l===y.NormalKind){let u=this._getFlattenedNormals(i,r[y.PositionKind]);this.setVerticesData(y.NormalKind,u,c.isUpdatable(),h)}else this.setVerticesData(l,n(r[l],h),c.isUpdatable(),h)}if(this.morphTargetManager){for(let l=0;l<this.morphTargetManager.numTargets;l++){let c=this.morphTargetManager.getTarget(l),h=c.getPositions();c.setPositions(n(h,3));let u=c.getNormals();u&&c.setNormals(e?this._getFlattenedNormals(i,h):n(u,3));let d=c.getTangents();d&&c.setTangents(n(d,3));let f=c.getUVs();f&&c.setUVs(n(f,2))}this.morphTargetManager.synchronize()}for(let l=0;l<i.length;l++)i[l]=l;this.setIndices(i),this._unIndexed=!0,this.releaseSubMeshes();for(let l of a){let c=l.getBoundingInfo();Wi.AddToMesh(l.materialIndex,l.indexStart,l.indexCount,l.indexStart,l.indexCount,this).setBoundingInfo(c)}return this.setBoundingInfo(o),this.synchronizeInstances(),this}convertToFlatShadedMesh(){return this._convertToUnIndexedMesh(!0)}convertToUnIndexedMesh(){return this._convertToUnIndexedMesh()}flipFaces(e=!1){let t=le.ExtractFromMesh(this),i;if(e&&this.isVerticesDataPresent(y.NormalKind)&&t.normals)for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;if(t.indices){let r;for(i=0;i<t.indices.length;i+=3)r=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=r}return t.applyToMesh(this,this.isVertexBufferUpdatable(y.PositionKind)),this}increaseVertices(e=1){let t=le.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,r=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,n=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,o=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!i||!r)F.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{t.indices=i,t.positions=r,n&&(t.uvs=n),o&&(t.normals=o);let a=e+1,l=new Array;for(let E=0;E<a+1;E++)l[E]=new Array;let c,h,u=new p(0,0,0),d=new p(0,0,0),f=new j(0,0),m=new Array,g=new Array,_=new Array,x,b=r.length,C;n&&(C=n.length);let R;o&&(R=o.length);for(let E=0;E<i.length;E+=3){g[0]=i[E],g[1]=i[E+1],g[2]=i[E+2];for(let S=0;S<3;S++)if(c=g[S],h=g[(S+1)%3],_[c]===void 0&&_[h]===void 0?(_[c]=new Array,_[h]=new Array):(_[c]===void 0&&(_[c]=new Array),_[h]===void 0&&(_[h]=new Array)),_[c][h]===void 0&&_[h][c]===void 0){_[c][h]=[],u.x=(r[3*h]-r[3*c])/a,u.y=(r[3*h+1]-r[3*c+1])/a,u.z=(r[3*h+2]-r[3*c+2])/a,o&&(d.x=(o[3*h]-o[3*c])/a,d.y=(o[3*h+1]-o[3*c+1])/a,d.z=(o[3*h+2]-o[3*c+2])/a),n&&(f.x=(n[2*h]-n[2*c])/a,f.y=(n[2*h+1]-n[2*c+1])/a),_[c][h].push(c);for(let A=1;A<a;A++)_[c][h].push(r.length/3),r[b++]=r[3*c]+A*u.x,r[b++]=r[3*c+1]+A*u.y,r[b++]=r[3*c+2]+A*u.z,o&&(o[R++]=o[3*c]+A*d.x,o[R++]=o[3*c+1]+A*d.y,o[R++]=o[3*c+2]+A*d.z),n&&(n[C++]=n[2*c]+A*f.x,n[C++]=n[2*c+1]+A*f.y);_[c][h].push(h),_[h][c]=new Array,x=_[c][h].length;for(let A=0;A<x;A++)_[h][c][A]=_[c][h][x-1-A]}l[0][0]=i[E],l[1][0]=_[i[E]][i[E+1]][1],l[1][1]=_[i[E]][i[E+2]][1];for(let S=2;S<a;S++){l[S][0]=_[i[E]][i[E+1]][S],l[S][S]=_[i[E]][i[E+2]][S],u.x=(r[3*l[S][S]]-r[3*l[S][0]])/S,u.y=(r[3*l[S][S]+1]-r[3*l[S][0]+1])/S,u.z=(r[3*l[S][S]+2]-r[3*l[S][0]+2])/S,o&&(d.x=(o[3*l[S][S]]-o[3*l[S][0]])/S,d.y=(o[3*l[S][S]+1]-o[3*l[S][0]+1])/S,d.z=(o[3*l[S][S]+2]-o[3*l[S][0]+2])/S),n&&(f.x=(n[2*l[S][S]]-n[2*l[S][0]])/S,f.y=(n[2*l[S][S]+1]-n[2*l[S][0]+1])/S);for(let A=1;A<S;A++)l[S][A]=r.length/3,r[b++]=r[3*l[S][0]]+A*u.x,r[b++]=r[3*l[S][0]+1]+A*u.y,r[b++]=r[3*l[S][0]+2]+A*u.z,o&&(o[R++]=o[3*l[S][0]]+A*d.x,o[R++]=o[3*l[S][0]+1]+A*d.y,o[R++]=o[3*l[S][0]+2]+A*d.z),n&&(n[C++]=n[2*l[S][0]]+A*f.x,n[C++]=n[2*l[S][0]+1]+A*f.y)}l[a]=_[i[E+1]][i[E+2]],m.push(l[0][0],l[1][0],l[1][1]);for(let S=1;S<a;S++){let A;for(A=0;A<S;A++)m.push(l[S][A],l[S+1][A],l[S+1][A+1]),m.push(l[S][A],l[S+1][A+1],l[S][A+1]);m.push(l[S][A],l[S+1][A],l[S+1][A+1])}}t.indices=m,t.applyToMesh(this,this.isVertexBufferUpdatable(y.PositionKind))}}forceSharedVertices(){let e=le.ExtractFromMesh(this),t=e.uvs,i=e.indices,r=e.positions,n=e.colors,o=e.matricesIndices,a=e.matricesWeights,l=e.matricesIndicesExtra,c=e.matricesWeightsExtra;if(i===void 0||r===void 0||i===null||r===null)F.Warn("VertexData contains empty entries");else{let h=new Array,u=new Array,d=new Array,f=new Array,m=new Array,g=new Array,_=new Array,x=new Array,b=new Array,C=0,R={},E,S;for(let L=0;L<i.length;L+=3){S=[i[L],i[L+1],i[L+2]],b=[];for(let G=0;G<3;G++){b[G]="";for(let W=0;W<3;W++)Math.abs(r[3*S[G]+W])<1e-8&&(r[3*S[G]+W]=0),b[G]+=r[3*S[G]+W]+"|"}if(!(b[0]==b[1]||b[0]==b[2]||b[1]==b[2]))for(let G=0;G<3;G++){if(E=R[b[G]],E===void 0){R[b[G]]=C,E=C++;for(let W=0;W<3;W++)h.push(r[3*S[G]+W]);if(n!=null)for(let W=0;W<4;W++)f.push(n[4*S[G]+W]);if(t!=null)for(let W=0;W<2;W++)d.push(t[2*S[G]+W]);if(o!=null)for(let W=0;W<4;W++)m.push(o[4*S[G]+W]);if(a!=null)for(let W=0;W<4;W++)g.push(a[4*S[G]+W]);if(l!=null)for(let W=0;W<4;W++)_.push(l[4*S[G]+W]);if(c!=null)for(let W=0;W<4;W++)x.push(c[4*S[G]+W])}u.push(E)}}let A=new Array;le.ComputeNormals(h,u,A),e.positions=h,e.indices=u,e.normals=A,t!=null&&(e.uvs=d),n!=null&&(e.colors=f),o!=null&&(e.matricesIndices=m),a!=null&&(e.matricesWeights=g),l!=null&&(e.matricesIndicesExtra=_),a!=null&&(e.matricesWeightsExtra=x),e.applyToMesh(this,this.isVertexBufferUpdatable(y.PositionKind))}}static _instancedMeshFactory(e,t){throw We("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw We("PhysicsImpostor")}createInstance(e){return s._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){let t=this.getIndices(),i=this.getVerticesData(y.PositionKind);if(!i||!t)return this;let r=[];for(let o=0;o<i.length;o=o+3)r.push(p.FromArray(i,o));let n=[];return no.SyncAsyncForLoop(r.length,40,o=>{let a=r.length-1-o,l=r[a];for(let c=0;c<a;++c){let h=r[c];if(l.equals(h)){n[a]=c;break}}},()=>{for(let a=0;a<t.length;++a)t[a]=n[t[a]]||t[a];let o=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=o,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),di&&di.HasTags(this)&&(e.tags=di.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.alwaysSelectAsActiveMesh=this.alwaysSelectAsActiveMesh,e.checkCollisions=this.checkCollisions,e.ellipsoid=this.ellipsoid.asArray(),e.ellipsoidOffset=this.ellipsoidOffset.asArray(),e.doNotSyncBoundingInfo=this.doNotSyncBoundingInfo,e.isBlocker=this.isBlocker,e.sideOrientation=this.sideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;let t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){let r=this.subMeshes[i];e.subMeshes.push({materialIndex:r.materialIndex,verticesStart:r.verticesStart,verticesCount:r.verticesCount,indexStart:r.indexStart,indexCount:r.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(ye.NAME_PHYSICSENGINE)){let i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){let r=this.instances[i];if(r.doNotSerialize)continue;let n={name:r.name,id:r.id,isEnabled:r.isEnabled(!1),isVisible:r.isVisible,isPickable:r.isPickable,checkCollisions:r.checkCollisions,position:r.position.asArray(),scaling:r.scaling.asArray()};if(r.parent&&r.parent._serializeAsParent(n),r.rotationQuaternion?n.rotationQuaternion=r.rotationQuaternion.asArray():r.rotation&&(n.rotation=r.rotation.asArray()),this.getScene()._getComponent(ye.NAME_PHYSICSENGINE)){let o=r.getPhysicsImpostor();o&&(n.physicsMass=o.getParam("mass"),n.physicsFriction=o.getParam("friction"),n.physicsRestitution=o.getParam("mass"),n.physicsImpostor=o.type)}r.metadata&&(n.metadata=r.metadata),r.actionManager&&(n.actions=r.actionManager.serialize(r.name)),e.instances.push(n),ae.AppendSerializedAnimations(r,n),n.ranges=r.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){let i={data:{},sizes:{},strides:{}};for(let r in this._userThinInstanceBuffersStorage.data)i.data[r]=Array.from(this._userThinInstanceBuffersStorage.data[r]),i.sizes[r]=this._userThinInstanceBuffersStorage.sizes[r],i.strides[r]=this._userThinInstanceBuffersStorage.strides[r];e.thinInstances.userThinInstance=i}return ae.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();let e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){F.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){let i=e.getActiveTarget(t),r=i.getPositions();if(!r){F.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(y.PositionKind+t,r,!1,3);let n=i.getNormals();n&&this.geometry.setVerticesData(y.NormalKind+t,n,!1,3);let o=i.getTangents();o&&this.geometry.setVerticesData(y.TangentKind+t,o,!1,3);let a=i.getUVs();a&&this.geometry.setVerticesData(y.UVKind+"_"+t,a,!1,2)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(y.PositionKind+t);)this.geometry.removeVerticesData(y.PositionKind+t),this.geometry.isVerticesDataPresent(y.NormalKind+t)&&this.geometry.removeVerticesData(y.NormalKind+t),this.geometry.isVerticesDataPresent(y.TangentKind+t)&&this.geometry.removeVerticesData(y.TangentKind+t),this.geometry.isVerticesDataPresent(y.UVKind+t)&&this.geometry.removeVerticesData(y.UVKind+"_"+t),t++}}static Parse(e,t,i){let r;if(e.type&&e.type==="LinesMesh"?r=s._LinesMeshParser(e,t):e.type&&e.type==="GroundMesh"?r=s._GroundMeshParser(e,t):e.type&&e.type==="GoldbergMesh"?r=s._GoldbergMeshParser(e,t):e.type&&e.type==="GreasedLineMesh"?r=s._GreasedLineMeshParser(e,t):e.type&&e.type==="TrailMesh"?r=s._TrailMeshParser(e,t):r=new s(e.name,t),r.id=e.id,r._waitingParsedUniqueId=e.uniqueId,di&&di.AddTagsTo(r,e.tags),r.position=p.FromArray(e.position),e.metadata!==void 0&&(r.metadata=e.metadata),e.rotationQuaternion?r.rotationQuaternion=q.FromArray(e.rotationQuaternion):e.rotation&&(r.rotation=p.FromArray(e.rotation)),r.scaling=p.FromArray(e.scaling),e.localMatrix?r.setPreTransformMatrix(N.FromArray(e.localMatrix)):e.pivotMatrix&&r.setPivotMatrix(N.FromArray(e.pivotMatrix)),r.setEnabled(e.isEnabled),r.isVisible=e.isVisible,r.infiniteDistance=e.infiniteDistance,r.alwaysSelectAsActiveMesh=!!e.alwaysSelectAsActiveMesh,r.showBoundingBox=e.showBoundingBox,r.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(r.applyFog=e.applyFog),e.pickable!==void 0&&(r.isPickable=e.pickable),e.alphaIndex!==void 0&&(r.alphaIndex=e.alphaIndex),r.receiveShadows=e.receiveShadows,e.billboardMode!==void 0&&(r.billboardMode=e.billboardMode),e.visibility!==void 0&&(r.visibility=e.visibility),r.checkCollisions=e.checkCollisions,r.doNotSyncBoundingInfo=!!e.doNotSyncBoundingInfo,e.ellipsoid&&(r.ellipsoid=p.FromArray(e.ellipsoid)),e.ellipsoidOffset&&(r.ellipsoidOffset=p.FromArray(e.ellipsoidOffset)),e.overrideMaterialSideOrientation!=null&&(r.sideOrientation=e.overrideMaterialSideOrientation),e.sideOrientation!==void 0&&(r.sideOrientation=e.sideOrientation),e.isBlocker!==void 0&&(r.isBlocker=e.isBlocker),r._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(r._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(r._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(r.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(r.overlayColor=X.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(r.renderOverlay=e.renderOverlay),r.isUnIndexed=!!e.isUnIndexed,r.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(r.delayLoadState=4,r.delayLoadingFile=i+e.delayLoadingFile,r.buildBoundingInfo(p.FromArray(e.boundingBoxMinimum),p.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(r._binaryInfo=e._binaryInfo),r._delayInfo=[],e.hasUVs&&r._delayInfo.push(y.UVKind),e.hasUVs2&&r._delayInfo.push(y.UV2Kind),e.hasUVs3&&r._delayInfo.push(y.UV3Kind),e.hasUVs4&&r._delayInfo.push(y.UV4Kind),e.hasUVs5&&r._delayInfo.push(y.UV5Kind),e.hasUVs6&&r._delayInfo.push(y.UV6Kind),e.hasColors&&r._delayInfo.push(y.ColorKind),e.hasMatricesIndices&&r._delayInfo.push(y.MatricesIndicesKind),e.hasMatricesWeights&&r._delayInfo.push(y.MatricesWeightsKind),r._delayLoadingFunction=nr._ImportGeometry,pn.ForceFullSceneLoadingForIncremental&&r._checkDelayState()):nr._ImportGeometry(e,r),e.materialUniqueId?r._waitingMaterialId=e.materialUniqueId:e.materialId&&(r._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(r.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),e.skeletonId!==void 0&&e.skeletonId!==null&&(r.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(r.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let n=0;n<e.animations.length;n++){let o=e.animations[n],a=Et("BABYLON.Animation");a&&r.animations.push(a.Parse(o))}Xe.ParseAnimationRanges(r,e,t)}if(e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?r.layerMask=Math.abs(parseInt(e.layerMask)):r.layerMask=268435455,e.physicsImpostor&&(r.physicsImpostor=s._PhysicsImpostorParser(t,r,e)),e.lodMeshIds&&(r._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let n=0;n<e.instances.length;n++){let o=e.instances[n],a=r.createInstance(o.name);if(o.id&&(a.id=o.id),di&&(o.tags?di.AddTagsTo(a,o.tags):di.AddTagsTo(a,e.tags)),a.position=p.FromArray(o.position),o.metadata!==void 0&&(a.metadata=o.metadata),o.parentId!==void 0&&(a._waitingParentId=o.parentId),o.parentInstanceIndex!==void 0&&(a._waitingParentInstanceIndex=o.parentInstanceIndex),o.isEnabled!==void 0&&o.isEnabled!==null&&a.setEnabled(o.isEnabled),o.isVisible!==void 0&&o.isVisible!==null&&(a.isVisible=o.isVisible),o.isPickable!==void 0&&o.isPickable!==null&&(a.isPickable=o.isPickable),o.rotationQuaternion?a.rotationQuaternion=q.FromArray(o.rotationQuaternion):o.rotation&&(a.rotation=p.FromArray(o.rotation)),a.scaling=p.FromArray(o.scaling),o.checkCollisions!=null&&o.checkCollisions!=null&&(a.checkCollisions=o.checkCollisions),o.pickable!=null&&o.pickable!=null&&(a.isPickable=o.pickable),o.showBoundingBox!=null&&o.showBoundingBox!=null&&(a.showBoundingBox=o.showBoundingBox),o.showSubMeshesBoundingBox!=null&&o.showSubMeshesBoundingBox!=null&&(a.showSubMeshesBoundingBox=o.showSubMeshesBoundingBox),o.alphaIndex!=null&&o.showSubMeshesBoundingBox!=null&&(a.alphaIndex=o.alphaIndex),o.physicsImpostor&&(a.physicsImpostor=s._PhysicsImpostorParser(t,a,o)),o.actions!==void 0&&(a._waitingData.actions=o.actions),o.animations){for(let l=0;l<o.animations.length;l++){let c=o.animations[l],h=Et("BABYLON.Animation");h&&a.animations.push(h.Parse(c))}Xe.ParseAnimationRanges(a,o,t),o.autoAnimate&&t.beginAnimation(a,o.autoAnimateFrom,o.autoAnimateTo,o.autoAnimateLoop,o.autoAnimateSpeed||1)}}if(e.thinInstances){let n=e.thinInstances;if(r.thinInstanceEnablePicking=!!n.enablePicking,n.matrixData?(r.thinInstanceSetBuffer("matrix",new Float32Array(n.matrixData),16,!1),r._thinInstanceDataStorage.matrixBufferSize=n.matrixBufferSize,r._thinInstanceDataStorage.instancesCount=n.instancesCount):r._thinInstanceDataStorage.matrixBufferSize=n.matrixBufferSize,e.thinInstances.userThinInstance){let o=e.thinInstances.userThinInstance;for(let a in o.data)r.thinInstanceSetBuffer(a,new Float32Array(o.data[a]),o.strides[a],!1),r._userThinInstanceBuffersStorage.sizes[a]=o.sizes[a]}}return r}setPositionsForCPUSkinning(){let e=this._internalMeshDataInfo;if(!e._sourcePositions){let t=this.getVerticesData(y.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(y.PositionKind)||this.setVerticesData(y.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){let e=this._internalMeshDataInfo;if(!e._sourceNormals){let t=this.getVerticesData(y.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(y.NormalKind)||this.setVerticesData(y.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(y.PositionKind))return this;if(!this.isVerticesDataPresent(y.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(y.MatricesWeightsKind))return this;let t=this.isVerticesDataPresent(y.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){let x=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=x}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let r=this.getVerticesData(y.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));let n=this.getVerticesData(y.NormalKind);if(t){if(!n)return this;n instanceof Float32Array||(n=new Float32Array(n))}let o=this.getVerticesData(y.MatricesIndicesKind),a=this.getVerticesData(y.MatricesWeightsKind);if(!a||!o)return this;let l=this.numBoneInfluencers>4,c=l?this.getVerticesData(y.MatricesIndicesExtraKind):null,h=l?this.getVerticesData(y.MatricesWeightsExtraKind):null,u=e.getTransformMatrices(this),d=p.Zero(),f=new N,m=new N,g=0,_;for(let x=0;x<r.length;x+=3,g+=4){let b;for(_=0;_<4;_++)b=a[g+_],b>0&&(N.FromFloat32ArrayToRefScaled(u,Math.floor(o[g+_]*16),b,m),f.addToSelf(m));if(l)for(_=0;_<4;_++)b=h[g+_],b>0&&(N.FromFloat32ArrayToRefScaled(u,Math.floor(c[g+_]*16),b,m),f.addToSelf(m));p.TransformCoordinatesFromFloatsToRef(i._sourcePositions[x],i._sourcePositions[x+1],i._sourcePositions[x+2],f,d),d.toArray(r,x),t&&(p.TransformNormalFromFloatsToRef(i._sourceNormals[x],i._sourceNormals[x+1],i._sourceNormals[x+2],f,d),d.toArray(n,x)),f.reset()}return this.updateVerticesData(y.PositionKind,r),t&&this.updateVerticesData(y.NormalKind,n),this}static MinMax(e){let t=null,i=null;return e.forEach(function(r){let o=r.getBoundingInfo().boundingBox;!t||!i?(t=o.minimumWorld,i=o.maximumWorld):(t.minimizeInPlace(o.minimumWorld),i.maximizeInPlace(o.maximumWorld))}),!t||!i?{min:p.Zero(),max:p.Zero()}:{min:t,max:i}}static Center(e){let t=e instanceof Array?s.MinMax(e):e;return p.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,r,n,o){return Yp(s._MergeMeshesCoroutine(e,t,i,r,n,o,!1))}static MergeMeshesAsync(e,t=!0,i,r,n,o){return wx(s._MergeMeshesCoroutine(e,t,i,r,n,o,!0),$1())}static*_MergeMeshesCoroutine(e,t=!0,i,r,n,o,a){if(e=e.filter(Boolean),e.length===0)return null;let l;if(!i){let A=0;for(l=0;l<e.length;l++)if(A+=e[l].getTotalVertices(),A>=65536)return F.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}o&&(n=!1);let c=new Array,h=new Array,u=new Array,d=e[0].sideOrientation;for(l=0;l<e.length;l++){let A=e[l];if(A.isAnInstance)return F.Warn("Cannot merge instance meshes."),null;if(d!==A.sideOrientation)return F.Warn("Cannot merge meshes with different sideOrientation values."),null;if(n&&u.push(A.getTotalIndices()),o)if(A.material){let L=A.material;if(L instanceof Hs){for(let G=0;G<L.subMaterials.length;G++)c.indexOf(L.subMaterials[G])<0&&c.push(L.subMaterials[G]);for(let G=0;G<A.subMeshes.length;G++)h.push(c.indexOf(L.subMaterials[A.subMeshes[G].materialIndex])),u.push(A.subMeshes[G].indexCount)}else{c.indexOf(L)<0&&c.push(L);for(let G=0;G<A.subMeshes.length;G++)h.push(c.indexOf(L)),u.push(A.subMeshes[G].indexCount)}}else for(let L=0;L<A.subMeshes.length;L++)h.push(0),u.push(A.subMeshes[L].indexCount)}let f=e[0],m=A=>{let L=A.computeWorldMatrix(!0);return{vertexData:le.ExtractFromMesh(A,!1,!1),transform:L}},{vertexData:g,transform:_}=m(f);a&&(yield);let x=new Array(e.length-1);for(let A=1;A<e.length;A++)x[A-1]=m(e[A]),a&&(yield);let b=g._mergeCoroutine(_,x,i,a,!t),C=b.next();for(;!C.done;)a&&(yield),C=b.next();let R=C.value;r||(r=new s(f.name+"_merged",f.getScene()));let E=R._applyToCoroutine(r,void 0,a),S=E.next();for(;!S.done;)a&&(yield),S=E.next();if(r.checkCollisions=f.checkCollisions,r.sideOrientation=f.sideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(n||o){r.releaseSubMeshes(),l=0;let A=0;for(;l<u.length;)Wi.CreateFromIndices(0,A,u[l],r,void 0,!1),A+=u[l],l++;for(let L of r.subMeshes)L.refreshBoundingInfo();r.computeWorldMatrix(!0)}if(o){let A=new Hs(f.name+"_merged",f.getScene());A.subMaterials=c;for(let L=0;L<r.subMeshes.length;L++)r.subMeshes[L].materialIndex=h[L];r.material=A}else r.material=f.material;return r}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){let t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){let i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this._scene.useRightHandedSystem&&this.sideOrientation===se.CounterClockWiseSideOrientation}_getRenderingFillMode(e){let t=this.getScene();return t.forcePointsCloud?se.PointFillMode:t.forceWireframe?se.WireFrameFillMode:this.overrideRenderingFillMode??e}setMaterialByID(e){return this.setMaterialById(e)}static CreateRibbon(e,t,i,r,n,o,a,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateDisc(e,t,i,r,n,o){throw new Error("Import MeshBuilder to populate this function")}static CreateBox(e,t,i,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateSphere(e,t,i,r,n,o){throw new Error("Import MeshBuilder to populate this function")}static CreateHemisphere(e,t,i,r){throw new Error("Import MeshBuilder to populate this function")}static CreateCylinder(e,t,i,r,n,o,a,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateTorus(e,t,i,r,n,o,a){throw new Error("Import MeshBuilder to populate this function")}static CreateTorusKnot(e,t,i,r,n,o,a,l,c,h){throw new Error("Import MeshBuilder to populate this function")}static CreateLines(e,t,i,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateDashedLines(e,t,i,r,n,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static CreatePolygon(e,t,i,r,n,o,a){throw new Error("Import MeshBuilder to populate this function")}static ExtrudePolygon(e,t,i,r,n,o,a,l){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShape(e,t,i,r,n,o,a,l,c,h){throw new Error("Import MeshBuilder to populate this function")}static ExtrudeShapeCustom(e,t,i,r,n,o,a,l,c,h,u,d){throw new Error("Import MeshBuilder to populate this function")}static CreateLathe(e,t,i,r,n,o,a){throw new Error("Import MeshBuilder to populate this function")}static CreatePlane(e,t,i,r,n){throw new Error("Import MeshBuilder to populate this function")}static CreateGround(e,t,i,r,n,o){throw new Error("Import MeshBuilder to populate this function")}static CreateTiledGround(e,t,i,r,n,o,a,l,c){throw new Error("Import MeshBuilder to populate this function")}static CreateGroundFromHeightMap(e,t,i,r,n,o,a,l,c,h,u){throw new Error("Import MeshBuilder to populate this function")}static CreateTube(e,t,i,r,n,o,a,l,c,h){throw new Error("Import MeshBuilder to populate this function")}static CreatePolyhedron(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateIcoSphere(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static CreateDecal(e,t,i,r,n,o){throw new Error("Import MeshBuilder to populate this function")}static CreateCapsule(e,t,i){throw new Error("Import MeshBuilder to populate this function")}static ExtendToGoldberg(e){throw new Error("Import MeshBuilder to populate this function")}};k.FRONTSIDE=le.FRONTSIDE;k.BACKSIDE=le.BACKSIDE;k.DOUBLESIDE=le.DOUBLESIDE;k.DEFAULTSIDE=le.DEFAULTSIDE;k.NO_CAP=0;k.CAP_START=1;k.CAP_END=2;k.CAP_ALL=3;k.NO_FLIP=0;k.FLIP_TILE=1;k.ROTATE_TILE=2;k.FLIP_ROW=3;k.ROTATE_ROW=4;k.FLIP_N_ROTATE_TILE=5;k.FLIP_N_ROTATE_ROW=6;k.CENTER=0;k.LEFT=1;k.RIGHT=2;k.TOP=3;k.BOTTOM=4;k.INSTANCEDMESH_SORT_TRANSPARENT=!1;k._GroundMeshParser=(s,e)=>{throw We("GroundMesh")};k._GoldbergMeshParser=(s,e)=>{throw We("GoldbergMesh")};k._LinesMeshParser=(s,e)=>{throw We("LinesMesh")};k._GreasedLineMeshParser=(s,e)=>{throw We("GreasedLineMesh")};k._GreasedLineRibbonMeshParser=(s,e)=>{throw We("GreasedLineRibbonMesh")};k._TrailMeshParser=(s,e)=>{throw We("TrailMesh")};P("BABYLON.Mesh",k);k._instancedMeshFactory=(s,e)=>{let t=new qa(s,e);if(e.instancedBuffers){t.instancedBuffers={};for(let i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};var qa=class extends lt{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(let i of t.getAnimationRanges())i!=null&&this.createAnimationRange(i.name,i.from,i.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){this._sourceMesh?.receiveShadows!==e&&H.Warn("Setting receiveShadows on an instanced mesh has no effect")}get material(){return this._sourceMesh.material}set material(e){this._sourceMesh?.material!==e&&H.Warn("Setting material on an instanced mesh has no effect")}get visibility(){return this._sourceMesh.visibility}set visibility(e){this._sourceMesh?.visibility!==e&&H.Warn("Setting visibility on an instanced mesh has no effect")}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){this._sourceMesh?.skeleton!==e&&H.Warn("Setting skeleton on an instanced mesh has no effect")}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||F.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,i){return this._sourceMesh.getVerticesData(e,t,i)}setVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,r),this.sourceMesh}updateVerticesData(e,t,i,r){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,r),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||F.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==Ze.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new N);let e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,O.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(O.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;let t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{let i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,r){let n=(r||this._sourceMesh).createInstance(e);if(ei.DeepCopy(this,n,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(n.parent=t),!i)for(let o=0;o<this.getScene().meshes.length;o++){let a=this.getScene().meshes[o];a.parent===this&&a.clone(a.name,n)}return n.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(n),n}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){let r=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);r&&i&&i(this,r);for(let n of this.getChildTransformNodes(!0))n.instantiateHierarchy(r,t,i);return r}};k.prototype.registerInstancedBuffer=function(s,e){if(this._userInstancedBuffersStorage?.vertexBuffers[s]?.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(let t of this.instances)t.instancedBuffers={}}this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this.instancedBuffers[s]=null,this._userInstancedBuffersStorage.strides[s]=e,this._userInstancedBuffersStorage.sizes[s]=e*32,this._userInstancedBuffersStorage.data[s]=new Float32Array(this._userInstancedBuffersStorage.sizes[s]),this._userInstancedBuffersStorage.vertexBuffers[s]=new y(this.getEngine(),this._userInstancedBuffersStorage.data[s],s,!0,!1,e,!0);for(let t of this.instances)t.instancedBuffers[s]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};k.prototype._processInstancedBuffers=function(s,e){let t=s?s.length:0;for(let i in this.instancedBuffers){let r=this._userInstancedBuffersStorage.sizes[i],n=this._userInstancedBuffersStorage.strides[i],o=(t+1)*n;for(;r<o;)r*=2;this._userInstancedBuffersStorage.data[i].length!=r&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(r),this._userInstancedBuffersStorage.sizes[i]=r,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));let a=this._userInstancedBuffersStorage.data[i],l=0;if(e){let c=this.instancedBuffers[i];c.toArray?c.toArray(a,l):c.copyToArray?c.copyToArray(a,l):a[l]=c,l+=n}for(let c=0;c<t;c++){let u=s[c].instancedBuffers[i];u.toArray?u.toArray(a,l):u.copyToArray?u.copyToArray(a,l):a[l]=u,l+=n}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(a,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new y(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,n,!0),this._invalidateInstanceVertexArrayObject())}};k.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(let s in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[s]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};k.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(let s in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[s]&&this._userInstancedBuffersStorage.vertexBuffers[s].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};P("BABYLON.InstancedMesh",qa);var tt=class s extends Xe{get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}getViewMatrix(e){return null}getProjectionMatrix(e,t){return null}constructor(e,t){super(e,t,!1),this.diffuse=new X(1,1,1),this.specular=new X(1,1,1),this.falloffType=s.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=s.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._shadowGenerators=null,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new _r(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=[],this.excludedMeshes=[],this._resyncMeshes()}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,r,n=!0){let o=e.toString(),a=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+o),this._renderId!==t.getRenderId()||this._lastUseSpecular!==r||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=r;let l=this.getScaledIntensity();this.transferToEffect(i,o),this.diffuse.scaleToRef(l,gt.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",gt.Color3[0],this.range,o),r&&(this.specular.scaleToRef(l,gt.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",gt.Color3[1],this.radius,o)),a=!0}if(this.transferTexturesToEffect(i,o),t.shadowsEnabled&&this.shadowEnabled&&n){let l=this.getShadowGenerator(t.activeCamera)??this.getShadowGenerator();l&&(l.bindShadowLight(o,i),a=!0)}a?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(e=null){return this._shadowGenerators===null?null:this._shadowGenerators.get(e)??null}getShadowGenerators(){return this._shadowGenerators}getAbsolutePosition(){return p.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&!(this.includeOnlyWithLayerMask&e.layerMask)||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,t=!1){if(this._shadowGenerators){let i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.dispose();this._shadowGenerators=null}if(this.getScene().stopAnimation(this),this._parentContainer){let i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(let i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){let i=s.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;let r=ae.Clone(i,this);return e&&(r.name=e),t&&(r.parent=t),r.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(r),r}serialize(){let e=ae.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(t=>{e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(t=>{e.includedOnlyMeshesIds.push(t.id)})),ae.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){let r=Xe.Construct("Light_Type_"+e,t,i);return r||null}static Parse(e,t){let i=s.GetConstructorFromName(e.type,e.name,t);if(!i)return null;let r=ae.Parse(i,e,t);if(e.excludedMeshesIds&&(r._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(r._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(r.falloffType=e.falloffType),e.lightmapMode!==void 0&&(r.lightmapMode=e.lightmapMode),e.animations){for(let n=0;n<e.animations.length;n++){let o=e.animations[n],a=Et("BABYLON.Animation");a&&r.animations.push(a.Parse(o))}Xe.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r}_hookArrayForExcluded(e){let t=e.push;e.push=(...r)=>{let n=t.apply(e,r);for(let o of r)o._resyncLightSource(this);return n};let i=e.splice;e.splice=(r,n)=>{let o=i.apply(e,[r,n]);for(let a of o)a._resyncLightSource(this);return o};for(let r of e)r._resyncLightSource(this)}_hookArrayForIncludedOnly(e){let t=e.push;e.push=(...r)=>{let n=t.apply(e,r);return this._resyncMeshes(),n};let i=e.splice;e.splice=(r,n)=>{let o=i.apply(e,[r,n]);return this._resyncMeshes(),o},this._resyncMeshes()}_resyncMeshes(){for(let e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(let e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0,t=this.getTypeID(),i=this.intensityMode;switch(i===s.INTENSITYMODE_AUTOMATIC&&(t===s.LIGHTTYPEID_DIRECTIONALLIGHT?i=s.INTENSITYMODE_ILLUMINANCE:i=s.INTENSITYMODE_LUMINOUSINTENSITY),t){case s.LIGHTTYPEID_POINTLIGHT:case s.LIGHTTYPEID_SPOTLIGHT:switch(i){case s.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case s.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case s.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case s.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case s.INTENSITYMODE_ILLUMINANCE:e=1;break;case s.INTENSITYMODE_LUMINANCE:{let r=this.radius;r=Math.max(r,.001),e=2*Math.PI*(1-Math.cos(r));break}}break;case s.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){let e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}};tt.FALLOFF_DEFAULT=xr.FALLOFF_DEFAULT;tt.FALLOFF_PHYSICAL=xr.FALLOFF_PHYSICAL;tt.FALLOFF_GLTF=xr.FALLOFF_GLTF;tt.FALLOFF_STANDARD=xr.FALLOFF_STANDARD;tt.LIGHTMAP_DEFAULT=xr.LIGHTMAP_DEFAULT;tt.LIGHTMAP_SPECULAR=xr.LIGHTMAP_SPECULAR;tt.LIGHTMAP_SHADOWSONLY=xr.LIGHTMAP_SHADOWSONLY;tt.INTENSITYMODE_AUTOMATIC=xr.INTENSITYMODE_AUTOMATIC;tt.INTENSITYMODE_LUMINOUSPOWER=xr.INTENSITYMODE_LUMINOUSPOWER;tt.INTENSITYMODE_LUMINOUSINTENSITY=xr.INTENSITYMODE_LUMINOUSINTENSITY;tt.INTENSITYMODE_ILLUMINANCE=xr.INTENSITYMODE_ILLUMINANCE;tt.INTENSITYMODE_LUMINANCE=xr.INTENSITYMODE_LUMINANCE;tt.LIGHTTYPEID_POINTLIGHT=xr.LIGHTTYPEID_POINTLIGHT;tt.LIGHTTYPEID_DIRECTIONALLIGHT=xr.LIGHTTYPEID_DIRECTIONALLIGHT;tt.LIGHTTYPEID_SPOTLIGHT=xr.LIGHTTYPEID_SPOTLIGHT;tt.LIGHTTYPEID_HEMISPHERICLIGHT=xr.LIGHTTYPEID_HEMISPHERICLIGHT;v([At()],tt.prototype,"diffuse",void 0);v([At()],tt.prototype,"specular",void 0);v([I()],tt.prototype,"falloffType",void 0);v([I()],tt.prototype,"intensity",void 0);v([I()],tt.prototype,"range",null);v([I()],tt.prototype,"intensityMode",null);v([I()],tt.prototype,"radius",null);v([I()],tt.prototype,"_renderPriority",void 0);v([Q("_reorderLightsInScene")],tt.prototype,"renderPriority",void 0);v([I("shadowEnabled")],tt.prototype,"_shadowEnabled",void 0);v([I("excludeWithLayerMask")],tt.prototype,"_excludeWithLayerMask",void 0);v([I("includeOnlyWithLayerMask")],tt.prototype,"_includeOnlyWithLayerMask",void 0);v([I("lightmapMode")],tt.prototype,"_lightmapMode",void 0);var bI=class extends Jt{},SI=class{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}},md=class extends Jt{constructor(e){super(),this._wasAddedToScene=!1,e=e||me.LastCreatedScene,e&&(this.scene=e,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(let t of this.geometries)t._rebuild();for(let t of this.meshes)t._rebuild();for(let t of this.particleSystems)t.rebuild();for(let t of this.textures)t._rebuild()}))}_topologicalSort(e){let t=new Map;for(let a of e)t.set(a.uniqueId,a);let i={dependsOn:new Map,dependedBy:new Map};for(let a of e){let l=a.uniqueId;i.dependsOn.set(l,new Set),i.dependedBy.set(l,new Set)}for(let a of e){let l=a.uniqueId,c=i.dependsOn.get(l);if(a instanceof qa){let u=a.sourceMesh;t.has(u.uniqueId)&&(c.add(u.uniqueId),i.dependedBy.get(u.uniqueId).add(l))}let h=i.dependedBy.get(l);for(let u of a.getDescendants()){let d=u.uniqueId;t.has(d)&&(h.add(d),i.dependsOn.get(d).add(l))}}let r=[],n=[];for(let a of e){let l=a.uniqueId;i.dependsOn.get(l).size===0&&(n.push(a),t.delete(l))}let o=n;for(;o.length>0;){let a=o.shift();r.push(a);let l=i.dependedBy.get(a.uniqueId);for(let c of Array.from(l.values())){let h=i.dependsOn.get(c);h.delete(a.uniqueId),h.size===0&&t.get(c)&&(o.push(t.get(c)),t.delete(c))}}return t.size>0&&(F.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(a=>F.Error(a.name))),r}_addNodeAndDescendantsToList(e,t,i,r){if(!(!i||r&&!r(i)||t.has(i.uniqueId))){e.push(i),t.add(i.uniqueId);for(let n of i.getDescendants(!0))this._addNodeAndDescendantsToList(e,t,n,r)}}_isNodeInContainer(e){return e instanceof lt&&this.meshes.indexOf(e)!==-1||e instanceof Ze&&this.transformNodes.indexOf(e)!==-1||e instanceof tt&&this.lights.indexOf(e)!==-1||e instanceof Ce&&this.cameras.indexOf(e)!==-1}_isValidHierarchy(){for(let e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return F.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return F.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return F.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return F.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||H.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");let r={},n={},o=new SI,a=[],l=[],c=ie({doNotInstantiate:!0},i),h=(g,_)=>{if(r[g.uniqueId]=_.uniqueId,n[_.uniqueId]=_,e&&(_.name=e(g.name)),_ instanceof k){let x=_;if(x.morphTargetManager){let b=g.morphTargetManager;x.morphTargetManager=b.clone();for(let C=0;C<b.numTargets;C++){let R=b.getTarget(C),E=x.morphTargetManager.getTarget(C);r[R.uniqueId]=E.uniqueId,n[E.uniqueId]=E}}}},u=[],d=new Set;for(let g of this.transformNodes)g.parent===null&&this._addNodeAndDescendantsToList(u,d,g,c.predicate);for(let g of this.meshes)g.parent===null&&this._addNodeAndDescendantsToList(u,d,g,c.predicate);let f=this._topologicalSort(u),m=(g,_)=>{if(h(g,_),g.parent){let x=r[g.parent.uniqueId],b=n[x];b?_.parent=b:_.parent=g.parent}if(_.position&&g.position&&_.position.copyFrom(g.position),_.rotationQuaternion&&g.rotationQuaternion&&_.rotationQuaternion.copyFrom(g.rotationQuaternion),_.rotation&&g.rotation&&_.rotation.copyFrom(g.rotation),_.scaling&&g.scaling&&_.scaling.copyFrom(g.scaling),_.material){let x=_;if(x.material)if(t){let b=g.material;if(l.indexOf(b)===-1){let C=b.clone(e?e(b.name):"Clone of "+b.name);if(l.push(b),r[b.uniqueId]=C.uniqueId,n[C.uniqueId]=C,b.getClassName()==="MultiMaterial"){let R=b;for(let E of R.subMaterials)E&&(C=E.clone(e?e(E.name):"Clone of "+E.name),l.push(E),r[E.uniqueId]=C.uniqueId,n[C.uniqueId]=C);R.subMaterials=R.subMaterials.map(E=>E&&n[r[E.uniqueId]])}}x.getClassName()!=="InstancedMesh"&&(x.material=n[r[b.uniqueId]])}else x.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(x.material)===-1&&this.scene.addMultiMaterial(x.material):this.scene.materials.indexOf(x.material)===-1&&this.scene.addMaterial(x.material)}_.parent===null&&o.rootNodes.push(_)};return f.forEach(g=>{if(g.getClassName()==="InstancedMesh"){let _=g,x=_.sourceMesh,b=r[x.uniqueId],R=(typeof b=="number"?n[b]:x).createInstance(_.name);m(_,R)}else{let _=!0;g.getClassName()==="TransformNode"||g.getClassName()==="Node"||g.skeleton||!g.getTotalVertices||g.getTotalVertices()===0?_=!1:c.doNotInstantiate&&(typeof c.doNotInstantiate=="function"?_=!c.doNotInstantiate(g):_=!c.doNotInstantiate);let x=_?g.createInstance(`instance of ${g.name}`):g.clone(`Clone of ${g.name}`,null,!0);if(!x)throw new Error(`Could not clone or instantiate node on Asset Container ${g.name}`);m(g,x)}}),this.skeletons.forEach(g=>{if(c.predicate&&!c.predicate(g))return;let _=g.clone(e?e(g.name):"Clone of "+g.name);for(let x of this.meshes)if(x.skeleton===g&&!x.isAnInstance){let b=n[r[x.uniqueId]];if(!b||b.isAnInstance||(b.skeleton=_,a.indexOf(_)!==-1))continue;a.push(_);for(let C of _.bones)C._linkedTransformNode&&(C._linkedTransformNode=n[r[C._linkedTransformNode.uniqueId]])}o.skeletons.push(_)}),this.animationGroups.forEach(g=>{if(c.predicate&&!c.predicate(g))return;let _=g.clone(e?e(g.name):"Clone of "+g.name,x=>n[r[x.uniqueId]]||x);o.animationGroups.push(_)}),o}addAllToScene(){if(!this._wasAddedToScene){this._isValidHierarchy()||H.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(let e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){let t=[];this.cameras.forEach(i=>{e&&!e(i)||(this.scene.addCamera(i),t.push(i))}),this.lights.forEach(i=>{e&&!e(i)||(this.scene.addLight(i),t.push(i))}),this.meshes.forEach(i=>{e&&!e(i)||(this.scene.addMesh(i),t.push(i))}),this.skeletons.forEach(i=>{e&&!e(i)||this.scene.addSkeleton(i)}),this.animations.forEach(i=>{e&&!e(i)||this.scene.addAnimation(i)}),this.animationGroups.forEach(i=>{e&&!e(i)||this.scene.addAnimationGroup(i)}),this.multiMaterials.forEach(i=>{e&&!e(i)||this.scene.addMultiMaterial(i)}),this.materials.forEach(i=>{e&&!e(i)||this.scene.addMaterial(i)}),this.morphTargetManagers.forEach(i=>{e&&!e(i)||this.scene.addMorphTargetManager(i)}),this.geometries.forEach(i=>{e&&!e(i)||this.scene.addGeometry(i)}),this.transformNodes.forEach(i=>{e&&!e(i)||(this.scene.addTransformNode(i),t.push(i))}),this.actionManagers.forEach(i=>{e&&!e(i)||this.scene.addActionManager(i)}),this.textures.forEach(i=>{e&&!e(i)||this.scene.addTexture(i)}),this.reflectionProbes.forEach(i=>{e&&!e(i)||this.scene.addReflectionProbe(i)});for(let i of t)i.parent&&this.scene.getNodes().indexOf(i.parent)===-1&&(i.setParent?i.setParent(null):i.parent=null)}removeAllFromScene(){this._isValidHierarchy()||H.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(let e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.removeCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.removeLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.removeMesh(t,!0)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.removeActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach(e=>{e.dispose()}),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(let e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(!(!e||!t))for(let r of e){let n=!0;if(i){for(let o of i)if(r===o){n=!1;break}}n&&(t.push(r),r._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new bI);for(let t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="_environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){let e=new k("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=me.LastCreatedScene,t,i=null){if(!e)return F.Error("No scene available to merge animations to"),[];let r=i||(a=>{let l=null,c=a.animations.length?a.animations[0].targetProperty:"",h=a.name.split(".").join("").split("_primitive")[0];switch(c){case"position":case"rotationQuaternion":l=e.getTransformNodeByName(a.name)||e.getTransformNodeByName(h);break;case"influence":l=e.getMorphTargetByName(a.name)||e.getMorphTargetByName(h);break;default:l=e.getNodeByName(a.name)||e.getNodeByName(h)}return l});this.getNodes().forEach(a=>{let l=r(a);if(l!==null){for(let c of a.animations){let h=l.animations.filter(u=>u.targetProperty===c.targetProperty);for(let u of h){let d=l.animations.indexOf(u,0);d>-1&&l.animations.splice(d,1)}}l.animations=l.animations.concat(a.animations)}});let o=[];return this.animationGroups.slice().forEach(a=>{o.push(a.clone(a.name,r)),a.animatables.forEach(l=>{l.stop()})}),t.forEach(a=>{let l=r(a.target);l&&(e.beginAnimation(l,a.fromFrame,a.toFrame,a.loopAnimation,a.speedRatio,a.onAnimationEnd?a.onAnimationEnd:void 0,void 0,!0,void 0,a.onAnimationLoop?a.onAnimationLoop:void 0),e.stopAnimation(a.target))}),o}populateRootNodes(){this.rootNodes.length=0,this.meshes.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.transformNodes.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.lights.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)}),this.cameras.forEach(e=>{!e.parent&&this.rootNodes.indexOf(e)===-1&&this.rootNodes.push(e)})}addAllAssetsToContainer(e){if(!e)return;let t=[],i=new Set;for(t.push(e);t.length>0;){let r=t.pop();if(r instanceof k?(r.geometry&&this.geometries.indexOf(r.geometry)===-1&&this.geometries.push(r.geometry),this.meshes.push(r)):r instanceof Ze?this.transformNodes.push(r):r instanceof tt?this.lights.push(r):r instanceof Ce&&this.cameras.push(r),r instanceof lt){if(r.material&&this.materials.indexOf(r.material)===-1){this.materials.push(r.material);for(let n of r.material.getActiveTextures())this.textures.indexOf(n)===-1&&this.textures.push(n)}r.skeleton&&this.skeletons.indexOf(r.skeleton)===-1&&this.skeletons.push(r.skeleton),r.morphTargetManager&&this.morphTargetManagers.indexOf(r.morphTargetManager)===-1&&this.morphTargetManagers.push(r.morphTargetManager)}for(let n of r.getChildren())i.has(n)||t.push(n);i.add(r)}this.populateRootNodes()}};var Bl=(()=>{class s{get loop(){return this._loop}set loop(t){t!==this._loop&&(this._loop=t,this.updateOptions({loop:t}))}get currentTime(){if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(K.audioEngine?.audioContext&&(this.isPlaying||this.isPaused)){let t=this.isPaused?0:K.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+t}return 0}get spatialSound(){return this._spatialSound}set spatialSound(t){if(t==this._spatialSound)return;let i=this.isPlaying;this.pause(),t?(this._spatialSound=t,this._updateSpatialParameters()):this._disableSpatialSound(),i&&this.play()}constructor(t,i,r,n=null,o){if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new U,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=p.Zero(),this._localDirection=new p(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=t,r=r||me.LastCreatedScene,!!r)if(this._scene=r,s._SceneComponentInitialization(r),this._readyToPlayCallback=n,this._customAttenuationFunction=(a,l,c,h,u)=>l<c?a*(1-l/c):0,o&&(this.autoplay=o.autoplay||!1,this._loop=o.loop||!1,o.volume!==void 0&&(this._volume=o.volume),this._spatialSound=o.spatialSound??!1,this.maxDistance=o.maxDistance??100,this.useCustomAttenuation=o.useCustomAttenuation??!1,this.rolloffFactor=o.rolloffFactor||1,this.refDistance=o.refDistance||1,this.distanceModel=o.distanceModel||"linear",this._playbackRate=o.playbackRate||1,this._streaming=o.streaming??!1,this._length=o.length,this._offset=o.offset),K.audioEngine?.canUseWebAudio&&K.audioEngine.audioContext){this._soundGain=K.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let a=!0;if(i)try{typeof i=="string"?(this._urlType="String",this._url=i):i instanceof ArrayBuffer?this._urlType="ArrayBuffer":i instanceof HTMLMediaElement?this._urlType="MediaElement":i instanceof MediaStream?this._urlType="MediaStream":i instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(i)&&(this._urlType="Array");let l=[],c=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=K.audioEngine.audioContext.createMediaElementSource(i),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=K.audioEngine.audioContext.createMediaStreamSource(i),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":i.byteLength>0&&(c=!0,this._soundLoaded(i));break;case"AudioBuffer":this._audioBufferLoaded(i);break;case"String":l.push(i);case"Array":l.length===0&&(l=i);for(let h=0;h<l.length;h++){let u=l[h];if(c=o&&o.skipCodecCheck||u.indexOf(".mp3",u.length-4)!==-1&&K.audioEngine.isMP3supported||u.indexOf(".ogg",u.length-4)!==-1&&K.audioEngine.isOGGsupported||u.indexOf(".wav",u.length-4)!==-1||u.indexOf(".m4a",u.length-4)!==-1||u.indexOf(".mp4",u.length-4)!==-1||u.indexOf("blob:")!==-1,c){this._streaming?(this._htmlAudioElement=new Audio(u),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,H.SetCorsBehavior(u,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(u,d=>{this._soundLoaded(d)},void 0,!0,!0,d=>{d&&F.Error("XHR "+d.status+" error on: "+u+"."),F.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:a=!1;break}a?c||(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):F.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{F.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),K.audioEngine&&!K.audioEngine.WarnedWebAudioUnsupported&&(F.Error("Web Audio is not supported by your browser."),K.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){K.audioEngine?.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(t){K.audioEngine?.audioContext&&(this._audioBuffer=t,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(t){K.audioEngine?.audioContext&&K.audioEngine.audioContext.decodeAudioData(t,i=>{this._audioBufferLoaded(i)},i=>{F.Error("Error while decoding audio data for: "+this.name+" / Error: "+i)})}setAudioBuffer(t){K.audioEngine?.canUseWebAudio&&(this._audioBuffer=t,this._isReadyToPlay=!0)}updateOptions(t){t&&(this.loop=t.loop??this.loop,this.maxDistance=t.maxDistance??this.maxDistance,this.useCustomAttenuation=t.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=t.rolloffFactor??this.rolloffFactor,this.refDistance=t.refDistance??this.refDistance,this.distanceModel=t.distanceModel??this.distanceModel,this._playbackRate=t.playbackRate??this._playbackRate,this._length=t.length??void 0,this.spatialSound=t.spatialSound??this._spatialSound,this._setOffset(t.offset??void 0),this.setVolume(t.volume??this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){K.audioEngine?.canUseWebAudio&&K.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=this._soundPanner??K.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){this._spatialSound&&(this._inputAudioNode=this._soundGain,this._soundPanner?.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){K.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(t){K.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(t),this._isOutputConnected=!0)}setDirectionalCone(t,i,r){if(i<t){F.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t,this._coneOuterAngle=i,this._coneOuterGain=r,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(t){if(t!=this._coneInnerAngle){if(this._coneOuterAngle<t){F.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=t,K.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(t){if(t!=this._coneOuterAngle){if(t<this._coneInnerAngle){F.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=t,K.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(t){t.equals(this._position)||(this._position.copyFrom(t),K.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(t){this._localDirection=t,K.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;let t=this._connectedTransformNode.getWorldMatrix(),i=p.TransformNormal(this._localDirection,t);i.normalize(),this._soundPanner.orientationX.value=i.x,this._soundPanner.orientationY.value=i.y,this._soundPanner.orientationZ.value=i.z}updateDistanceFromListener(){if(K.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){let t=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(t){this._customAttenuationFunction=t}play(t,i,r){if(this._isReadyToPlay&&this._scene.audioEnabled&&K.audioEngine?.audioContext)try{this._clearTimeoutsAndObservers();let n=t?K.audioEngine?.audioContext.currentTime+t:K.audioEngine?.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=K.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){let o=()=>{if(K.audioEngine?.unlocked){let a=this._htmlAudioElement.play();a!==void 0&&a.catch(()=>{K.audioEngine?.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=K.audioEngine?.onAudioUnlockedObservable.addOnce(()=>{o()}))})}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=K.audioEngine?.onAudioUnlockedObservable.addOnce(()=>{o()}))};o()}}else{let o=()=>{if(K.audioEngine?.audioContext){if(r=r||this._length,i!==void 0&&this._setOffset(i),this._soundSource){let a=this._soundSource;a.onended=()=>{a.disconnect()}}if(this._soundSource=K.audioEngine?.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,i!==void 0&&(this._soundSource.loopStart=i),r!==void 0&&(this._soundSource.loopEnd=(i|0)+r),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},n=t?K.audioEngine?.audioContext.currentTime+t:K.audioEngine.audioContext.currentTime;let a=((this.isPaused?this.currentTime:0)+(this._offset??0))%this._soundSource.buffer.duration;this._soundSource.start(n,a,this.loop?void 0:r)}}};K.audioEngine?.audioContext.state==="suspended"?this._tryToPlayTimeout=setTimeout(()=>{K.audioEngine?.audioContext.state==="suspended"?(K.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=K.audioEngine.onAudioUnlockedObservable.addOnce(()=>{o()}))):o()},500):o()}this._startTime=n,this.isPlaying=!0,this.isPaused=!1}catch(n){F.Error("Error while trying to play audio: "+this.name+", "+n.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(t){if(this.isPlaying)if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(K.audioEngine?.audioContext&&this._soundSource){let i=t?K.audioEngine.audioContext.currentTime+t:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>{}),this._onended()},this._soundSource.stop(i)}else this.isPlaying=!1;else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect(),this.isPlaying=!1,this.isPaused=!0):K.audioEngine?.audioContext&&this._soundSource&&(this._soundSource.onended=()=>{},this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=K.audioEngine.audioContext.currentTime-this._startTime))}setVolume(t,i){K.audioEngine?.canUseWebAudio&&this._soundGain&&(i&&K.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(K.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,K.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(t,K.audioEngine.audioContext.currentTime+i)):this._soundGain.gain.value=t),this._volume=t}setPlaybackRate(t){this._playbackRate=t,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(t){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=t,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=i=>this._onRegisterAfterWorldMatrixUpdate(i),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(t){if(!t.getBoundingInfo)this.setPosition(t.absolutePosition);else{let r=t.getBoundingInfo();this.setPosition(r.boundingSphere.centerWorld)}K.audioEngine?.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{let t=()=>{this._isReadyToPlay?(r._audioBuffer=this.getAudioBuffer(),r._isReadyToPlay=!0,r.autoplay&&r.play(0,this._offset,this._length)):setTimeout(t,300)},i={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},r=new s(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,i);return this.useCustomAttenuation&&r.setAttenuationFunction(this._customAttenuationFunction),r.setPosition(this._position),r.setPlaybackRate(this._playbackRate),t(),r}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){let t={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(t.connectedMeshId=this._connectedTransformNode.id),t.position=this._position.asArray(),t.refDistance=this.refDistance,t.distanceModel=this.distanceModel,t.isDirectional=this._isDirectional,t.localDirectionToMesh=this._localDirection.asArray(),t.coneInnerAngle=this._coneInnerAngle,t.coneOuterAngle=this._coneOuterAngle,t.coneOuterGain=this._coneOuterGain),t}static Parse(t,i,r,n){let o=t.name,a;t.url?a=r+t.url:a=r+o;let l={autoplay:t.autoplay,loop:t.loop,volume:t.volume,spatialSound:t.spatialSound,maxDistance:t.maxDistance,rolloffFactor:t.rolloffFactor,refDistance:t.refDistance,distanceModel:t.distanceModel,playbackRate:t.playbackRate},c;if(!n)c=new s(o,a,i,()=>{i.removePendingData(c)},l),i.addPendingData(c);else{let h=()=>{n._isReadyToPlay?(c._audioBuffer=n.getAudioBuffer(),c._isReadyToPlay=!0,c.autoplay&&c.play(0,c._offset,c._length)):setTimeout(h,300)};c=new s(o,new ArrayBuffer(0),i,null,l),h()}if(t.position){let h=p.FromArray(t.position);c.setPosition(h)}if(t.isDirectional&&(c.setDirectionalCone(t.coneInnerAngle||360,t.coneOuterAngle||360,t.coneOuterGain||0),t.localDirectionToMesh)){let h=p.FromArray(t.localDirectionToMesh);c.setLocalDirectionToMesh(h)}if(t.connectedMeshId){let h=i.getMeshById(t.connectedMeshId);h&&c.attachToMesh(h)}return t.metadata&&(c.metadata=t.metadata),c}_setOffset(t){this._offset!==t&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=t)}_clearTimeoutsAndObservers(){this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&(K.audioEngine?.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}}return s._SceneComponentInitialization=e=>{throw We("AudioSceneComponent")},s})();P("BABYLON.Sound",Bl);var Xx=class{constructor(e,t={}){this.id=-1,this._isInitialized=!1,e=e||me.LastCreatedScene,e&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){K.audioEngine?.canUseWebAudio&&K.audioEngine.audioContext&&(this._outputAudioNode=K.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(K.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(K.audioEngine&&K.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){this._isInitialized||this._initializeSoundTrackAudioGraph(),K.audioEngine?.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId!==void 0&&(e.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){let t=this.soundCollection.indexOf(e);t!==-1&&this.soundCollection.splice(t,1)}setVolume(e){K.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){if(K.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){if(K.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,K.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,K.audioEngine.masterGain))}};Jt.AddParser(ye.NAME_AUDIO,(s,e,t,i)=>{let r=[],n;if(t.sounds=t.sounds||[],s.sounds!==void 0&&s.sounds!==null)for(let o=0,a=s.sounds.length;o<a;o++){let l=s.sounds[o];K.audioEngine?.canUseWebAudio?(l.url||(l.url=l.name),r[l.url]?t.sounds.push(Bl.Parse(l,e,i,r[l.url])):(n=Bl.Parse(l,e,i),r[l.url]=n,t.sounds.push(n))):t.sounds.push(new Bl(l.name,null,e))}r=[]});Object.defineProperty(Te.prototype,"mainSoundTrack",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new Fs(this),this._addComponent(s)),this._mainSoundTrack||(this._mainSoundTrack=new Xx(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});Te.prototype.getSoundByName=function(s){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===s)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks){for(let t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===s)return this.soundTracks[t].soundCollection[e]}return null};Object.defineProperty(Te.prototype,"audioEnabled",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new Fs(this),this._addComponent(s)),s.audioEnabled},set:function(s){let e=this._getComponent(ye.NAME_AUDIO);e||(e=new Fs(this),this._addComponent(e)),s?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(Te.prototype,"headphone",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new Fs(this),this._addComponent(s)),s.headphone},set:function(s){let e=this._getComponent(ye.NAME_AUDIO);e||(e=new Fs(this),this._addComponent(e)),s?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(Te.prototype,"audioListenerPositionProvider",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new Fs(this),this._addComponent(s)),s.audioListenerPositionProvider},set:function(s){let e=this._getComponent(ye.NAME_AUDIO);if(e||(e=new Fs(this),this._addComponent(e)),s&&typeof s!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=s},enumerable:!0,configurable:!0});Object.defineProperty(Te.prototype,"audioListenerRotationProvider",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new Fs(this),this._addComponent(s)),s.audioListenerRotationProvider},set:function(s){let e=this._getComponent(ye.NAME_AUDIO);if(e||(e=new Fs(this),this._addComponent(e)),s&&typeof s!="function")throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");e.audioListenerRotationProvider=s},enumerable:!0,configurable:!0});Object.defineProperty(Te.prototype,"audioPositioningRefreshRate",{get:function(){let s=this._getComponent(ye.NAME_AUDIO);return s||(s=new Fs(this),this._addComponent(s)),s.audioPositioningRefreshRate},set:function(s){let e=this._getComponent(ye.NAME_AUDIO);e||(e=new Fs(this),this._addComponent(e)),e.audioPositioningRefreshRate=s},enumerable:!0,configurable:!0});var Fs=class s{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=ye.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new p,this._cachedCameraPosition=new p,this._lastCheck=0,this._invertMatrixTemp=new N,this._cameraDirectionTemp=new p,e=e||me.LastCreatedScene,e&&(this.scene=e,e.soundTracks=[],e.sounds=[])}register(){this.scene._afterRenderStage.registerStep(ye.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){let i=this.scene.soundTracks[t];for(let r=0;r<i.soundCollection.length;r++)e.sounds.push(i.soundCollection[r].serialize())}}addFromContainer(e){e.sounds&&e.sounds.forEach(t=>{t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)})}removeFromContainer(e,t=!1){e.sounds&&e.sounds.forEach(i=>{i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose()})}dispose(){let e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){let e=this.scene;this._audioEnabled=!1,K.audioEngine&&K.audioEngine.audioContext&&K.audioEngine.audioContext.suspend();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){let e=this.scene;this._audioEnabled=!0,K.audioEngine&&K.audioEngine.audioContext&&K.audioEngine.audioContext.resume();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){let e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){let e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){let e=Mi.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;let t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||t._mainSoundTrack.soundCollection.length===0&&t.soundTracks.length===1)return;let i=K.audioEngine;if(i&&i.audioContext){let r=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(r=t.activeCameras[0]),this.audioListenerPositionProvider){let o=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(o.x||0,o.y||0,o.z||0)}else r?this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),i.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){let o=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(o.x||0,o.y||0,o.z||0,0,1,0)}else r?(r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),p.TransformNormalToRef(s._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);let n;for(n=0;n<t.mainSoundTrack.soundCollection.length;n++){let o=t.mainSoundTrack.soundCollection[n];o.useCustomAttenuation&&o.updateDistanceFromListener()}if(t.soundTracks)for(n=0;n<t.soundTracks.length;n++)for(let o=0;o<t.soundTracks[n].soundCollection.length;o++){let a=t.soundTracks[n].soundCollection[o];a.useCustomAttenuation&&a.updateDistanceFromListener()}}}};Fs._CameraDirection=new p(0,0,-1);Bl._SceneComponentInitialization=s=>{let e=s._getComponent(ye.NAME_AUDIO);e||(e=new Fs(s),s._addComponent(e))};var Yx=class{constructor(e,t,i){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==i.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=i;let r=0;for(let o of i)r+=o;let n=r>0?1/r:0;for(let o=0;o<this._weights.length;o++)this._weights[o]*=n;this._sounds=t;for(let o of this._sounds)o.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){F.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(let t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){F.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(let t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(let t of this._sounds)t.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();let i=Math.random(),r=0;for(let n=0;n<this._weights.length;n++)if(r+=this._weights[n],i<=r){this._currentIndex=n;break}}let t=this._sounds[this._currentIndex];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}};var gd=class s{constructor(e){this._texture=null,this._isEnabled=!0,this.isEnabled=!0,this.time=0,e=e||me.LastCreatedScene,e&&(this._scene=e,this.animationParameters=new De(0,0,0,30))}_markSubMeshesAsAttributesDirty(){for(let e of this._scene.meshes)e.bakedVertexAnimationManager===this&&e._markSubMeshesAsAttributesDirty()}bind(e,t=!1){if(!this._texture||!this._isEnabled)return;let i=this._texture.getSize();e.setFloat2("bakedVertexAnimationTextureSizeInverted",1/i.width,1/i.height),e.setFloat("bakedVertexAnimationTime",this.time),t||e.setVector4("bakedVertexAnimationSettings",this.animationParameters),e.setTexture("bakedVertexAnimationTexture",this._texture)}clone(){let e=new s(this._scene);return this.copyTo(e),e}setAnimationParameters(e,t,i=0,r=30){this.animationParameters=new De(e,t,i,r)}dispose(e){e&&this._texture?.dispose()}getClassName(){return"BakedVertexAnimationManager"}copyTo(e){ae.Clone(()=>e,this)}serialize(){return ae.Serialize(this)}parse(e,t,i){ae.Parse(()=>this,e,t,i)}};v([Qe(),Q("_markSubMeshesAsAttributesDirty")],gd.prototype,"texture",void 0);v([I(),Q("_markSubMeshesAsAttributesDirty")],gd.prototype,"isEnabled",void 0);v([I()],gd.prototype,"animationParameters",void 0);v([I()],gd.prototype,"time",void 0);at.prototype.updateRawTexture=function(s,e,t,i,r=null,n=0,o=!1){if(!s)return;let a=this._getRGBABufferInternalSizedFormat(n,t,o),l=this._getInternalFormat(t),c=this._getWebGLTextureType(n);this._bindTextureDirectly(this._gl.TEXTURE_2D,s,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(s._bufferView=e,s.format=t,s.type=n,s.invertY=i,s._compression=r),s.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[r],s.width,s.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,a,s.width,s.height,0,l,c,e),s.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),s.isReady=!0};at.prototype.createRawTexture=function(s,e,t,i,r,n,o,a=null,l=0,c=0,h=!1){let u=new Je(this,ke.Raw);u.baseWidth=e,u.baseHeight=t,u.width=e,u.height=t,u.format=i,u.generateMipMaps=r,u.samplingMode=o,u.invertY=n,u._compression=a,u.type=l,u._useSRGBBuffer=this._getUseSRGBBuffer(h,!r),this._doNotHandleContextLost||(u._bufferView=s),this.updateRawTexture(u,s,i,n,a,l,u._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,u,!0);let d=this._getSamplingParameters(o,r);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),r&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(u),u};at.prototype.createRawCubeTexture=function(s,e,t,i,r,n,o,a=null){let l=this._gl,c=new Je(this,ke.CubeRaw);c.isCube=!0,c.format=t,c.type=i,this._doNotHandleContextLost||(c._bufferViewArray=s);let h=this._getWebGLTextureType(i),u=this._getInternalFormat(t);u===l.RGB&&(u=l.RGBA),h===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(r=!1,o=1,F.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):h===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,o=1,F.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):h===l.FLOAT&&!this._caps.textureFloatRender?(r=!1,F.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):h===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(r=!1,F.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));let d=e,f=d;if(c.width=d,c.height=f,c.invertY=n,c._compression=a,!this.needPOTTextures||Vf(c.width)&&Vf(c.height)||(r=!1),s)this.updateRawCubeTexture(c,s,t,i,n,a);else{let _=this._getRGBABufferInternalSizedFormat(i),x=0;this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,c,!0);for(let b=0;b<6;b++)a?l.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+b,x,this.getCaps().s3tc[a],c.width,c.height,0,void 0):l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+b,x,_,c.width,c.height,0,u,h,null);this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)}this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,c,!0),s&&r&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);let g=this._getSamplingParameters(o,r);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,g.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,g.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),c.generateMipMaps=r,c.samplingMode=o,c.isReady=!0,c};at.prototype.updateRawCubeTexture=function(s,e,t,i,r,n=null,o=0){s._bufferViewArray=e,s.format=t,s.type=i,s.invertY=r,s._compression=n;let a=this._gl,l=this._getWebGLTextureType(i),c=this._getInternalFormat(t),h=this._getRGBABufferInternalSizedFormat(i),u=!1;c===a.RGB&&(c=a.RGBA,u=!0),this._bindTextureDirectly(a.TEXTURE_CUBE_MAP,s,!0),this._unpackFlipY(r===void 0?!0:!!r),s.width%4!==0&&a.pixelStorei(a.UNPACK_ALIGNMENT,1);for(let f=0;f<6;f++){let m=e[f];n?a.compressedTexImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,o,this.getCaps().s3tc[n],s.width,s.height,0,m):(u&&(m=Z1(m,s.width,s.height,i)),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+f,o,h,s.width,s.height,0,c,l,m))}(!this.needPOTTextures||Vf(s.width)&&Vf(s.height))&&s.generateMipMaps&&o===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),s.isReady=!0};at.prototype.createRawCubeTextureFromUrl=function(s,e,t,i,r,n,o,a,l=null,c=null,h=3,u=!1){let d=this._gl,f=this.createRawCubeTexture(null,t,i,r,!n,u,h,null);e?.addPendingData(f),f.url=s,f.isReady=!1,this._internalTexturesCache.push(f);let m=(_,x)=>{e?.removePendingData(f),c&&_&&c(_.status+" "+_.statusText,x)},g=_=>{let x=f.width,b=o(_);if(b){if(a){let C=this._getWebGLTextureType(r),R=this._getInternalFormat(i),E=this._getRGBABufferInternalSizedFormat(r),S=!1;R===d.RGB&&(R=d.RGBA,S=!0),this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,f,!0),this._unpackFlipY(!1);let A=a(b);for(let L=0;L<A.length;L++){let G=x>>L;for(let W=0;W<6;W++){let $=A[L][W];S&&($=Z1($,G,G,r)),d.texImage2D(W,L,E,G,G,0,R,C,$)}}this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(f,b,i,r,u);f.isReady=!0,e?.removePendingData(f),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),l&&l()}};return this._loadFile(s,_=>{g(_)},void 0,e?.offlineProvider,!0,m),f};function Z1(s,e,t,i){let r,n=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),n=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let o=0;o<e;o++)for(let a=0;a<t;a++){let l=(a*e+o)*3,c=(a*e+o)*4;r[c+0]=s[l+0],r[c+1]=s[l+1],r[c+2]=s[l+2],r[c+3]=n}return r}function J1(s){return function(e,t,i,r,n,o,a,l,c=null,h=0){let u=s?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,d=s?ke.Raw3D:ke.Raw2DArray,f=new Je(this,d);f.baseWidth=t,f.baseHeight=i,f.baseDepth=r,f.width=t,f.height=i,f.depth=r,f.format=n,f.type=h,f.generateMipMaps=o,f.samplingMode=l,s?f.is3D=!0:f.is2DArray=!0,this._doNotHandleContextLost||(f._bufferView=e),s?this.updateRawTexture3D(f,e,n,a,c,h):this.updateRawTexture2DArray(f,e,n,a,c,h),this._bindTextureDirectly(u,f,!0);let m=this._getSamplingParameters(l,o);return this._gl.texParameteri(u,this._gl.TEXTURE_MAG_FILTER,m.mag),this._gl.texParameteri(u,this._gl.TEXTURE_MIN_FILTER,m.min),o&&this._gl.generateMipmap(u),this._bindTextureDirectly(u,null),this._internalTexturesCache.push(f),f}}at.prototype.createRawTexture2DArray=J1(!1);at.prototype.createRawTexture3D=J1(!0);function eB(s){return function(e,t,i,r,n=null,o=0){let a=s?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(o),c=this._getInternalFormat(i),h=this._getRGBABufferInternalSizedFormat(o,i);this._bindTextureDirectly(a,e,!0),this._unpackFlipY(r===void 0?!0:!!r),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=n),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),n&&t?this._gl.compressedTexImage3D(a,0,this.getCaps().s3tc[n],e.width,e.height,e.depth,0,t):this._gl.texImage3D(a,0,h,e.width,e.height,e.depth,0,c,l,t),e.generateMipMaps&&this._gl.generateMipmap(a),this._bindTextureDirectly(a,null),e.isReady=!0}}at.prototype.updateRawTexture2DArray=eB(!1);at.prototype.updateRawTexture3D=eB(!0);var xi=class s extends z{constructor(e,t,i,r,n,o=!0,a=!1,l=3,c=0,h,u){super(null,n,!o,a,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,h),this.format=r,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&c===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&c===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,r,o,a,l,null,c,h??0,u??!1),this.wrapU=z.CLAMP_ADDRESSMODE,this.wrapV=z.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,t,i,r,n=!0,o=!1,a=3){return new s(e,t,i,1,r,n,o,a)}static CreateLuminanceAlphaTexture(e,t,i,r,n=!0,o=!1,a=3){return new s(e,t,i,2,r,n,o,a)}static CreateAlphaTexture(e,t,i,r,n=!0,o=!1,a=3){return new s(e,t,i,0,r,n,o,a)}static CreateRGBTexture(e,t,i,r,n=!0,o=!1,a=3,l=0,c=0,h=!1){return new s(e,t,i,4,r,n,o,a,l,c,h)}static CreateRGBATexture(e,t,i,r,n=!0,o=!1,a=3,l=0,c=0,h=!1){return new s(e,t,i,5,r,n,o,a,l,c,h)}static CreateRGBAStorageTexture(e,t,i,r,n=!0,o=!1,a=3,l=0,c=!1){return new s(e,t,i,5,r,n,o,a,l,1,c)}static CreateRTexture(e,t,i,r,n=!0,o=!1,a=z.TRILINEAR_SAMPLINGMODE,l=1){return new s(e,t,i,6,r,n,o,a,l)}static CreateRStorageTexture(e,t,i,r,n=!0,o=!1,a=z.TRILINEAR_SAMPLINGMODE,l=1){return new s(e,t,i,6,r,n,o,a,l,1)}};var Xn=class s{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=N.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new U,this.bones=[],this._scene=i||me.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;let r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw new Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return(!this._transformMatrices||this._isDirty)&&this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(let r in this._ranges)i&&(t+=", ",i=!1),t+=r;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new Ll(e,t,i);for(let r=0,n=this.bones.length;r<n;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){let e=[],t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let r=!0,n=this._getHighestAnimationFrame()+1,o={},a=e.bones,l,c;for(c=0,l=a.length;c<l;c++)o[a[c].name]=a[c];this.bones.length!==a.length&&(F.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${a.length}`),r=!1);let h=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(c=0,l=this.bones.length;c<l;c++){let d=this.bones[c].name,f=o[d];f?r=r&&this.bones[c].copyAnimationRange(f,t,n,i,h):(F.Warn("copyAnimationRange: not same rig, missing source bone "+d),r=!1)}let u=e.getAnimationRange(t);return u&&(this._ranges[t]=new Ll(t,u.from+n,u.to+n)),r}returnToRest(){for(let e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){let r=this.bones[t].animations[0].getHighestFrame();e<r&&(e=r)}return e}beginAnimation(e,t,i,r){let n=this.getAnimationRange(e);return n?this._scene.beginAnimation(this,n.from,n.to,t,i,r):null}static MakeAnimationAdditive(e,t=0,i){let r=e.getAnimationRange(i);if(!r)return null;let n=e._scene.getAllAnimatablesByTarget(e),o=null;for(let l=0;l<n.length;l++){let c=n[l];if(c.fromFrame===r?.from&&c.toFrame===r?.to){o=c;break}}let a=e.getAnimatables();for(let l=0;l<a.length;l++){let h=a[l].animations;if(h)for(let u=0;u<h.length;u++)te.MakeAnimationAdditive(h[u],t,i)}return o&&(o.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){let t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){let r=this.bones[i];r._childUpdateId++;let n=r.getParent();if(n?r.getLocalMatrix().multiplyToRef(n.getFinalMatrix(),r.getFinalMatrix()):t?r.getLocalMatrix().multiplyToRef(t,r.getFinalMatrix()):r.getFinalMatrix().copyFrom(r.getLocalMatrix()),r._index!==-1){let o=r._index===null?i:r._index;r.getAbsoluteInverseBindMatrix().multiplyToArray(r.getFinalMatrix(),e,o*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(e=!1){if(!e){let t=this.getScene().getRenderId();if(this._currentRenderId===t)return;this._currentRenderId=t}if(this._numBonesWithLinkedTransformNode>0){for(let t of this.bones)if(t._linkedTransformNode){let i=t._linkedTransformNode;t.position=i.position,i.rotationQuaternion?t.rotationQuaternion=i.rotationQuaternion:t.rotation=i.rotation,t.scaling=i.scaling}}if(this.needInitialSkinMatrix)for(let t of this._meshesWithPoseMatrix){let i=t.getPoseMatrix(),r=this._isDirty;if((!t._bonesTransformMatrices||t._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(t._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),r=!0),!!r){if(this._synchronizedWithMesh!==t){this._synchronizedWithMesh=t;for(let n of this.bones)n.getParent()||(n.getBindMatrix().multiplyToRef(i,O.Matrix[1]),n._updateAbsoluteBindMatrices(O.Matrix[1]));if(this.isUsingTextureForMatrices){let n=(this.bones.length+1)*4;(!t._transformMatrixTexture||t._transformMatrixTexture.getSize().width!==n)&&(t._transformMatrixTexture&&t._transformMatrixTexture.dispose(),t._transformMatrixTexture=xi.CreateRGBATexture(t._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(t._bonesTransformMatrices,i),this.isUsingTextureForMatrices&&t._transformMatrixTexture&&t._transformMatrixTexture.update(t._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=xi.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){let i=new s(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let r=0;r<this.bones.length;r++){let n=this.bones[r],o=null,a=n.getParent();if(a){let c=this.bones.indexOf(a);o=i.bones[c]}let l=new ss(n.name,i,o,n.getBindMatrix().clone(),n.getRestMatrix().clone());l._index=n._index,n._linkedTransformNode&&l.linkTransformNode(n._linkedTransformNode),ei.DeepCopy(n.animations,l.animations)}if(this._ranges){i._ranges={};for(let r in this._ranges){let n=this._ranges[r];n&&(i._ranges[r]=n.clone())}}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(i=>{i.enableBlending=!0,i.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){let e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){let e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let t=0;t<this.bones.length;t++){let i=this.bones[t],r=i.getParent(),n={parentBoneIndex:r?this.bones.indexOf(r):-1,index:i.getIndex(),name:i.name,id:i.id,matrix:i.getBindMatrix().asArray(),rest:i.getRestMatrix().asArray(),linkedTransformNodeId:i.getTransformNode()?.id};e.bones.push(n),i.length&&(n.length=i.length),i.metadata&&(n.metadata=i.metadata),i.animations&&i.animations.length>0&&(n.animation=i.animations[0].serialize()),e.ranges=[];for(let o in this._ranges){let a=this._ranges[o];if(!a)continue;let l={};l.name=o,l.from=a.from,l.to=a.to,e.ranges.push(l)}}return e}static Parse(e,t){let i=new s(e.name,e.id,t);e.dimensionsAtRest&&(i.dimensionsAtRest=p.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix;let r;for(r=0;r<e.bones.length;r++){let n=e.bones[r],o=e.bones[r].index,a=null;n.parentBoneIndex>-1&&(a=i.bones[n.parentBoneIndex]);let l=n.rest?N.FromArray(n.rest):null,c=new ss(n.name,i,a,N.FromArray(n.matrix),l,null,o);n.id!==void 0&&n.id!==null&&(c.id=n.id),n.length&&(c.length=n.length),n.metadata&&(c.metadata=n.metadata),n.animation&&c.animations.push(te.Parse(n.animation)),n.linkedTransformNodeId!==void 0&&n.linkedTransformNodeId!==null&&(i._hasWaitingData=!0,c._waitingTransformNodeId=n.linkedTransformNodeId)}if(e.ranges)for(r=0;r<e.ranges.length;r++){let n=e.ranges[r];i.createAnimationRange(n.name,n.from,n.to)}return i}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){let e=[],t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;let r=this.bones[e];if(!r)return;r._index===void 0&&(r._index=e);let n=r.getParent();n&&this._sortBones(this.bones.indexOf(n),t,i),t.push(r)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}};var $x=class{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;let t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===Ae.POINTERDOWN){this._isPointerDown=!0;return}i.type===Ae.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;let i=Mi.Now,r=0;this._lastFrameTime!=null&&(r=i-this._lastFrameTime),this._lastFrameTime=i,this._applyUserInteraction();let n=i-this._lastInteractionTime-this._idleRotationWaitTime,o=Math.max(Math.min(n/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*o,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(r/1e3))})}detach(){if(!this._attachedCamera)return;let e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=e??Mi.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<je:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=Mi.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}};var _d=class s{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;let t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(i=>{if(i&&(i.computeWorldMatrix(!0),i.getBoundingInfo)){let r=i.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=r*.05,this.upperRadiusTransitionRange=r*.05}}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(s.EasingFunction.setEasingMode(s.EasingMode),this._radiusBounceTransition=te.CreateAnimation("radius",te.ANIMATIONTYPE_FLOAT,60,s.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;let t=te.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}};_d.EasingFunction=new Px(.3);_d.EasingMode=fs.EASINGMODE_EASEOUT;var Vl=class s{constructor(){this.onTargetFramingAnimationEndObservable=new U,this._mode=s.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;let t=this._attachedCamera.getScene();s.EasingFunction.setEasingMode(s.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===Ae.POINTERDOWN){this._isPointerDown=!0;return}i.type===Ae.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(i=>{i&&i.getBoundingInfo&&this.zoomOnMesh(i,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;let e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);let r=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(r.minimumWorld,r.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);let r=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(r.min,r.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){let r=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new p(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let o=0;o<e.length;o++){let a=e[o].getHierarchyBoundingVectors(!0);p.CheckExtends(a.min,r,n),p.CheckExtends(a.max,r,n)}this.zoomOnBoundingInfo(r,n,t,i)}zoomOnBoundingInfo(e,t,i=!1,r=null){let n;if(!this._attachedCamera)return!1;let o=e.y,a=t.y,l=o+(a-o)*this._positionScale,c=t.subtract(e).scale(.5);if(i)n=new p(0,l,0);else{let d=e.add(c);n=new p(d.x,l,d.z)}this._vectorTransition||(this._vectorTransition=te.CreateAnimation("target",te.ANIMATIONTYPE_VECTOR3,60,s.EasingFunction)),this._betaIsAnimating=!0;let h=te.TransitionTo("target",n,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);h&&this._animatables.push(h);let u=0;if(this._mode===s.FitFrustumSidesMode){let d=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=c.length()+this._attachedCamera.minZ),u=d}else this._mode===s.IgnoreBoundsSizeMode&&(u=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){let d=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/d,this._attachedCamera.wheelPrecision=100/u}return this._radiusTransition||(this._radiusTransition=te.CreateAnimation("radius",te.ANIMATIONTYPE_FLOAT,60,s.EasingFunction)),h=te.TransitionTo("radius",u,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),r&&r(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),h&&this._animatables.push(h),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){let i=this._attachedCamera;if(!i)return 0;let r=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===s.IgnoreBoundsSizeMode&&(r=r<i.lowerRadiusLimit?i.lowerRadiusLimit:r),i.upperRadiusLimit&&(r=r>i.upperRadiusLimit?i.upperRadiusLimit:r),r}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;let e=Mi.Now-this._lastInteractionTime,t=Math.PI*.5-this._defaultElevation,i=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=te.CreateAnimation("beta",te.ANIMATIONTYPE_FLOAT,60,s.EasingFunction));let r=te.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});r&&this._animatables.push(r)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=Mi.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}};Vl.EasingFunction=new Mx;Vl.EasingMode=fs.EASINGMODE_EASEINOUT;Vl.IgnoreBoundsSizeMode=0;Vl.FitFrustumSidesMode=1;var pt=class s{constructor(e,t,i=Number.MAX_VALUE,r=je){this.origin=e,this.direction=t,this.length=i,this.epsilon=r}clone(){return new s(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){let r=s._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),n=s._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i),o=0,a=Number.MAX_VALUE,l,c,h,u;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<r.x||this.origin.x>n.x)return!1}else if(l=1/this.direction.x,c=(r.x-this.origin.x)*l,h=(n.x-this.origin.x)*l,h===-1/0&&(h=1/0),c>h&&(u=c,c=h,h=u),o=Math.max(c,o),a=Math.min(h,a),o>a)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<r.y||this.origin.y>n.y)return!1}else if(l=1/this.direction.y,c=(r.y-this.origin.y)*l,h=(n.y-this.origin.y)*l,h===-1/0&&(h=1/0),c>h&&(u=c,c=h,h=u),o=Math.max(c,o),a=Math.min(h,a),o>a)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<r.z||this.origin.z>n.z)return!1}else if(l=1/this.direction.z,c=(r.z-this.origin.z)*l,h=(n.z-this.origin.z)*l,h===-1/0&&(h=1/0),c>h&&(u=c,c=h,h=u),o=Math.max(c,o),a=Math.min(h,a),o>a)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){let i=e.center.x-this.origin.x,r=e.center.y-this.origin.y,n=e.center.z-this.origin.z,o=i*i+r*r+n*n,a=e.radius+t,l=a*a;if(o<=l)return!0;let c=i*this.direction.x+r*this.direction.y+n*this.direction.z;return c<0?!1:o-c*c<=l}intersectsTriangle(e,t,i){let r=s._TmpVector3[0],n=s._TmpVector3[1],o=s._TmpVector3[2],a=s._TmpVector3[3],l=s._TmpVector3[4];t.subtractToRef(e,r),i.subtractToRef(e,n),p.CrossToRef(this.direction,n,o);let c=p.Dot(r,o);if(c===0)return null;let h=1/c;this.origin.subtractToRef(e,a);let u=p.Dot(a,o)*h;if(u<-this.epsilon||u>1+this.epsilon)return null;p.CrossToRef(a,r,l);let d=p.Dot(this.direction,l)*h;if(d<-this.epsilon||u+d>1+this.epsilon)return null;let f=p.Dot(n,l)*h;return f>this.length?null:new $c(1-u-d,u,f)}intersectsPlane(e){let t,i=p.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{let r=p.Dot(e.normal,this.origin);return t=(-e.d-r)/i,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{let i=(this.origin.y-t)/this.direction.y;return i>0?null:new p(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{let i=(this.origin.x-t)/this.direction.x;return i>0?null:new p(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{let i=(this.origin.z-t)/this.direction.z;return i>0?null:new p(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t,i,r=!1,n,o=!1){let a=O.Matrix[0];return e.getWorldMatrix().invertToRef(a),this._tmpRay?s.TransformToRef(this,a,this._tmpRay):this._tmpRay=s.Transform(this,a),e.intersects(this._tmpRay,t,i,r,n,o)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let r=0;r<e.length;r++){let n=this.intersectsMesh(e[r],t);n.hit&&i.push(n)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){let r=this.origin,n=O.Vector3[0],o=O.Vector3[1],a=O.Vector3[2],l=O.Vector3[3];t.subtractToRef(e,n),this.direction.scaleToRef(s._Rayl,a),r.addToRef(a,o),e.subtractToRef(r,l);let c=p.Dot(n,n),h=p.Dot(n,a),u=p.Dot(a,a),d=p.Dot(n,l),f=p.Dot(a,l),m=c*u-h*h,g,_=m,x,b=m;m<s._Smallnum?(g=0,_=1,x=f,b=u):(g=h*f-u*d,x=c*f-h*d,g<0?(g=0,x=f,b=u):g>_&&(g=_,x=f+h,b=u)),x<0?(x=0,-d<0?g=0:-d>c?g=_:(g=-d,_=c)):x>b&&(x=b,-d+h<0?g=0:-d+h>c?g=_:(g=-d+h,_=c));let C=Math.abs(g)<s._Smallnum?0:g/_,R=Math.abs(x)<s._Smallnum?0:x/b,E=O.Vector3[4];a.scaleToRef(R,E);let S=O.Vector3[5];n.scaleToRef(C,S),S.addInPlace(l);let A=O.Vector3[6];return S.subtractToRef(E,A),R>0&&R<=this.length&&A.lengthSquared()<i*i?S.length():-1}update(e,t,i,r,n,o,a,l=!1){if(l){s._RayDistant||(s._RayDistant=s.Zero()),s._RayDistant.unprojectRayToRef(e,t,i,r,N.IdentityReadOnly,o,a);let c=O.Matrix[0];n.invertToRef(c),s.TransformToRef(s._RayDistant,c,this)}else this.unprojectRayToRef(e,t,i,r,n,o,a);return this}static Zero(){return new s(p.Zero(),p.Zero())}static CreateNew(e,t,i,r,n,o,a){return s.Zero().update(e,t,i,r,n,o,a)}static CreateNewFromTo(e,t,i=N.IdentityReadOnly){let r=new s(new p(0,0,0),new p(0,0,0));return s.CreateFromToToRef(e,t,r,i)}static CreateFromToToRef(e,t,i,r=N.IdentityReadOnly){i.origin.copyFrom(e);let n=t.subtractToRef(e,i.direction),o=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);return i.length=o,i.direction.normalize(),s.TransformToRef(i,r,i)}static Transform(e,t){let i=new s(new p(0,0,0),new p(0,0,0));return s.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){p.TransformCoordinatesToRef(e.origin,t,i.origin),p.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length,i.epsilon=e.epsilon;let r=i.direction,n=r.length();if(!(n===0||n===1)){let o=1/n;r.x*=o,r.y*=o,r.z*=o,i.length*=n}return i}unprojectRayToRef(e,t,i,r,n,o,a){let l=O.Matrix[0];n.multiplyToRef(o,l),l.multiplyToRef(a,l),l.invert();let c=me.LastCreatedEngine,h=O.Vector3[0];h.x=e/i*2-1,h.y=-(t/r*2-1),h.z=c?.useReverseDepthBuffer?1:c?.isNDCHalfZRange?0:-1;let u=O.Vector3[1].copyFromFloats(h.x,h.y,1-1e-8),d=O.Vector3[2],f=O.Vector3[3];p._UnprojectFromInvertedMatrixToRef(h,l,d),p._UnprojectFromInvertedMatrixToRef(u,l,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}};pt._TmpVector3=Ir.BuildArray(6,p.Zero);pt._RayDistant=pt.Zero();pt._Smallnum=1e-8;pt._Rayl=1e9;Te.prototype.createPickingRay=function(s,e,t,i,r=!1){let n=pt.Zero();return this.createPickingRayToRef(s,e,t,n,i,r),n};Te.prototype.createPickingRayToRef=function(s,e,t,i,r,n=!1,o=!1){let a=this.getEngine();if(!r&&!(r=this.activeCamera))return this;let l=r.viewport,c=a.getRenderHeight(),{x:h,y:u,width:d,height:f}=l.toGlobal(a.getRenderWidth(),c),m=1/a.getHardwareScalingLevel();return s=s*m-h,e=e*m-(c-u-f),i.update(s,e,d,f,t||N.IdentityReadOnly,n?N.IdentityReadOnly:r.getViewMatrix(),r.getProjectionMatrix(),o),this};Te.prototype.createPickingRayInCameraSpace=function(s,e,t){let i=pt.Zero();return this.createPickingRayInCameraSpaceToRef(s,e,i,t),i};Te.prototype.createPickingRayInCameraSpaceToRef=function(s,e,t,i){if(!oi)return this;let r=this.getEngine();if(!i&&!(i=this.activeCamera))throw new Error("Active camera not set");let n=i.viewport,o=r.getRenderHeight(),{x:a,y:l,width:c,height:h}=n.toGlobal(r.getRenderWidth(),o),u=N.Identity(),d=1/r.getHardwareScalingLevel();return s=s*d-a,e=e*d-(o-l-h),t.update(s,e,c,h,u,u,i.getProjectionMatrix()),this};Te.prototype._internalPickForMesh=function(s,e,t,i,r,n,o,a){let l=e(i,t.enableDistantPicking),c=t.intersects(l,r,o,n,i,a);return!c||!c.hit||!r&&s!=null&&c.distance>=s.distance?null:c};Te.prototype._internalPick=function(s,e,t,i,r){let n=null,o=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),a=this.cameraToUseForPointers||this.activeCamera;for(let l=0;l<this.meshes.length;l++){let c=this.meshes[l];if(e){if(!e(c))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;let h=o&&c.isWorldMatrixCameraDependent(),u=c.computeWorldMatrix(h,a);if(c.hasThinInstances&&c.thinInstanceEnablePicking){let d=this._internalPickForMesh(n,s,c,u,!0,!0,r);if(d){if(i)return d;let f=O.Matrix[1],m=c.thinInstanceGetWorldMatrices();for(let g=0;g<m.length;g++){m[g].multiplyToRef(u,f);let x=this._internalPickForMesh(n,s,c,f,t,i,r,!0);if(x&&(n=x,n.thinInstanceIndex=g,t))return n}}}else{let d=this._internalPickForMesh(n,s,c,u,t,i,r);if(d&&(n=d,t))return n}}return n||new oi};Te.prototype._internalMultiPick=function(s,e,t){if(!oi)return null;let i=[],r=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),n=this.cameraToUseForPointers||this.activeCamera;for(let o=0;o<this.meshes.length;o++){let a=this.meshes[o];if(e){if(!e(a))continue}else if(!a.isEnabled()||!a.isVisible||!a.isPickable)continue;let l=r&&a.isWorldMatrixCameraDependent(),c=a.computeWorldMatrix(l,n);if(a.hasThinInstances&&a.thinInstanceEnablePicking){if(this._internalPickForMesh(null,s,a,c,!0,!0,t)){let u=O.Matrix[1],d=a.thinInstanceGetWorldMatrices();for(let f=0;f<d.length;f++){d[f].multiplyToRef(c,u);let g=this._internalPickForMesh(null,s,a,u,!1,!1,t,!0);g&&(g.thinInstanceIndex=f,i.push(g))}}}else{let h=this._internalPickForMesh(null,s,a,c,!1,!1,t);h&&i.push(h)}}return i};Te.prototype.pickWithBoundingInfo=function(s,e,t,i,r){if(!oi)return null;let n=this._internalPick(o=>(this._tempPickingRay||(this._tempPickingRay=pt.Zero()),this.createPickingRayToRef(s,e,o,this._tempPickingRay,r||null),this._tempPickingRay),t,i,!0);return n&&(n.ray=this.createPickingRay(s,e,N.Identity(),r||null)),n};Object.defineProperty(Te.prototype,"_pickingAvailable",{get:()=>!0,enumerable:!1,configurable:!1});Te.prototype.pick=function(s,e,t,i,r,n,o=!1){let a=this._internalPick((l,c)=>(this._tempPickingRay||(this._tempPickingRay=pt.Zero()),this.createPickingRayToRef(s,e,l,this._tempPickingRay,r||null,!1,c),this._tempPickingRay),t,i,!1,n);return a&&(a.ray=this.createPickingRay(s,e,N.Identity(),r||null)),a};Te.prototype.pickWithRay=function(s,e,t,i){let r=this._internalPick(n=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=N.Identity()),n.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=pt.Zero()),pt.TransformToRef(s,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t,!1,i);return r&&(r.ray=s),r};Te.prototype.multiPick=function(s,e,t,i,r){return this._internalMultiPick(n=>this.createPickingRay(s,e,n,i||null),t,r)};Te.prototype.multiPickWithRay=function(s,e,t){return this._internalMultiPick(i=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=N.Identity()),i.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=pt.Zero()),pt.TransformToRef(s,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t)};Ce.prototype.getForwardRay=function(s=100,e,t){return this.getForwardRayToRef(new pt(p.Zero(),p.Zero(),s),s,e,t)};Ce.prototype.getForwardRayToRef=function(s,e=100,t,i){t||(t=this.getWorldMatrix()),s.length=e,i?s.origin.copyFrom(i):s.origin.copyFrom(this.position);let r=O.Vector3[2];r.set(0,0,this._scene.useRightHandedSystem?-1:1);let n=O.Vector3[3];return p.TransformNormalToRef(r,t,n),p.NormalizeToRef(n,s.direction),s};var Ls=class s{static _RemoveAndStorePivotPoint(e){e&&s._PivotCached===0&&(e.getPivotPointToRef(s._OldPivotPoint),s._PivotPostMultiplyPivotMatrix=e._postMultiplyPivotMatrix,s._OldPivotPoint.equalsToFloats(0,0,0)||(e.setPivotMatrix(N.IdentityReadOnly),s._OldPivotPoint.subtractToRef(e.getPivotPoint(),s._PivotTranslation),s._PivotTmpVector.copyFromFloats(1,1,1),s._PivotTmpVector.subtractInPlace(e.scaling),s._PivotTmpVector.multiplyInPlace(s._PivotTranslation),e.position.addInPlace(s._PivotTmpVector))),s._PivotCached++}static _RestorePivotPoint(e){e&&!s._OldPivotPoint.equalsToFloats(0,0,0)&&s._PivotCached===1&&(e.setPivotPoint(s._OldPivotPoint),e._postMultiplyPivotMatrix=s._PivotPostMultiplyPivotMatrix,s._PivotTmpVector.copyFromFloats(1,1,1),s._PivotTmpVector.subtractInPlace(e.scaling),s._PivotTmpVector.multiplyInPlace(s._PivotTranslation),e.position.subtractInPlace(s._PivotTmpVector)),this._PivotCached--}};Ls._PivotCached=0;Ls._OldPivotPoint=new p;Ls._PivotTranslation=new p;Ls._PivotTmpVector=new p;Ls._PivotPostMultiplyPivotMatrix=!1;function jx(s){let e=[],t=[],i=[],r=[],n=s.width||s.size||1,o=s.height||s.size||1,a=s.sideOrientation===0?0:s.sideOrientation||le.DEFAULTSIDE,l=n/2,c=o/2;t.push(-l,-c,0),i.push(0,0,-1),r.push(0,it.UseOpenGLOrientationForUV?1:0),t.push(l,-c,0),i.push(0,0,-1),r.push(1,it.UseOpenGLOrientationForUV?1:0),t.push(l,c,0),i.push(0,0,-1),r.push(1,it.UseOpenGLOrientationForUV?0:1),t.push(-l,c,0),i.push(0,0,-1),r.push(0,it.UseOpenGLOrientationForUV?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),le._ComputeSides(a,t,e,i,r,s.frontUVs,s.backUVs);let h=new le;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function Yn(s,e={},t=null){let i=new k(s,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,jx(e).applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}le.CreatePlane=jx;k.CreatePlane=(s,e,t,i,r)=>Yn(s,{size:e,width:e,height:e,sideOrientation:r,updatable:i},t);var qc=(()=>{class s{get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(t){this.currentDraggingPointerId=t}set enabled(t){t!=this._enabled&&this.onEnabledObservable.notifyObservers(t),this._enabled=t}get enabled(){return this._enabled}get options(){return this._options}set options(t){this._options=t}constructor(t){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this._activeDragButton=-1,this.maxDragAngle=0,this.dragButtons=[0,1,2],this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerId=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new U,this.onDragStartObservable=new U,this.onDragEndObservable=new U,this.onEnabledObservable=new U,this.moveAttached=!0,this._enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=r=>!0,this._tmpVector=new p(0,0,0),this._alternatePickedPoint=new p(0,0,0),this._worldDragAxis=new p(0,0,0),this._targetPosition=new p(0,0,0),this._attachedToElement=!1,this._startDragRay=new pt(new p,new p),this._lastPointerRay={},this._dragDelta=new p,this._pointA=new p(0,0,0),this._pointC=new p(0,0,0),this._localAxis=new p(0,0,0),this._lookAt=new p(0,0,0),this._options=t||{};let i=0;if(this._options.dragAxis&&i++,this._options.dragPlaneNormal&&i++,i>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}get name(){return"PointerDrag"}init(){}attach(t,i){this._scene=t.getScene(),t.isNearGrabbable=!0,this.attachedNode=t,s._PlaneScene||(this._debugMode?s._PlaneScene=this._scene:(s._PlaneScene=new Te(this._scene.getEngine(),{virtual:!0}),s._PlaneScene.detachControl(),this._scene.onDisposeObservable.addOnce(()=>{s._PlaneScene.dispose(),s._PlaneScene=null}))),this._dragPlane=Yn("pointerDragPlane",{size:this._debugMode?1:1e4,updatable:!1,sideOrientation:k.DOUBLESIDE},s._PlaneScene),this.lastDragPosition=new p(0,0,0);let r=i||(n=>this.attachedNode==n||n.isDescendantOf(this.attachedNode));this._pointerObserver=this._scene.onPointerObservable.add(n=>{if(!this.enabled){this._attachedToElement&&this.releaseDrag();return}if(n.type==Ae.POINTERDOWN)this.startAndReleaseDragOnPointerEvents&&!this.dragging&&n.pickInfo&&n.pickInfo.hit&&n.pickInfo.pickedMesh&&n.pickInfo.pickedPoint&&n.pickInfo.ray&&r(n.pickInfo.pickedMesh)&&this._activeDragButton===-1&&this.dragButtons.indexOf(n.event.button)!==-1&&(this._activeDragButton=n.event.button,this._activePointerInfo=n,this._startDrag(n.event.pointerId,n.pickInfo.ray,n.pickInfo.pickedPoint));else if(n.type==Ae.POINTERUP)this.startAndReleaseDragOnPointerEvents&&this.currentDraggingPointerId==n.event.pointerId&&(this._activeDragButton===n.event.button||this._activeDragButton===-1)&&this.releaseDrag();else if(n.type==Ae.POINTERMOVE){let o=n.event.pointerId;if(this.currentDraggingPointerId===s._AnyMouseId&&o!==s._AnyMouseId){let a=n.event;(a.pointerType==="mouse"||!this._scene.getEngine().hostInformation.isMobile&&a instanceof MouseEvent)&&(this._lastPointerRay[this.currentDraggingPointerId]&&(this._lastPointerRay[o]=this._lastPointerRay[this.currentDraggingPointerId],delete this._lastPointerRay[this.currentDraggingPointerId]),this.currentDraggingPointerId=o)}this._lastPointerRay[o]||(this._lastPointerRay[o]=new pt(new p,new p)),n.pickInfo&&n.pickInfo.ray&&(this._lastPointerRay[o].origin.copyFrom(n.pickInfo.ray.origin),this._lastPointerRay[o].direction.copyFrom(n.pickInfo.ray.direction),this.currentDraggingPointerId==o&&this.dragging&&this._moveDrag(n.pickInfo.ray))}}),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add(()=>{if(this._moving&&this.moveAttached){let n=!1;Ls._RemoveAndStorePivotPoint(this.attachedNode),this._targetPosition.subtractToRef(this.attachedNode.absolutePosition,this._tmpVector),this._tmpVector.scaleInPlace(this.dragDeltaRatio),this.attachedNode.getAbsolutePosition().addToRef(this._tmpVector,this._tmpVector),this.validateDrag(this._tmpVector)&&(this.attachedNode.setAbsolutePosition(this._tmpVector),n=!0),Ls._RestorePivotPoint(this.attachedNode),n&&this.attachedNode.computeWorldMatrix()}})}releaseDrag(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo})),this.currentDraggingPointerId=-1,this._activeDragButton=-1,this._activePointerInfo=null,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if(this._scene.activeCamera.getClassName()==="ArcRotateCamera"){let t=this._scene.activeCamera;t.attachControl(t.inputs?t.inputs.noPreventDefault:!0,t._useCtrlForPanning,t._panningMouseButton)}else this._scene.activeCamera.attachControl(this._scene.activeCamera.inputs?this._scene.activeCamera.inputs.noPreventDefault:!0);this._attachedToElement=!1}}startDrag(t=s._AnyMouseId,i,r){this._startDrag(t,i,r);let n=this._lastPointerRay[t];t===s._AnyMouseId&&(n=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),n&&this._moveDrag(n)}_startDrag(t,i,r){if(!this._scene.activeCamera||this.dragging||!this.attachedNode)return;Ls._RemoveAndStorePivotPoint(this.attachedNode),i?(this._startDragRay.direction.copyFrom(i.direction),this._startDragRay.origin.copyFrom(i.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,r||this._tmpVector);let n=this._pickWithRayOnDragPlane(this._startDragRay);n?(this.dragging=!0,this.currentDraggingPointerId=t,this.lastDragPosition.copyFrom(n),this.onDragStartObservable.notifyObservers({dragPlanePoint:n,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)):this.releaseDrag(),Ls._RestorePivotPoint(this.attachedNode)}_moveDrag(t){this._moving=!0;let i=this._pickWithRayOnDragPlane(t);if(i){Ls._RemoveAndStorePivotPoint(this.attachedNode),this.updateDragPlane&&this._updateDragPlanePosition(t,i);let r=0;this._options.dragAxis?(this.useObjectOrientationForDragging?p.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),i.subtractToRef(this.lastDragPosition,this._tmpVector),r=p.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(r,this._dragDelta)):(r=this._dragDelta.length(),i.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:r,delta:this._dragDelta,dragPlanePoint:i,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this.lastDragPosition.copyFrom(i),Ls._RestorePivotPoint(this.attachedNode)}}_pickWithRayOnDragPlane(t){if(!t)return null;let i=Math.acos(p.Dot(this._dragPlane.forward,t.direction));if(i>Math.PI/2&&(i=Math.PI-i),this.maxDragAngle>0&&i>this.maxDragAngle)if(this._useAlternatePickedPointAboveMaxDragAngle){this._tmpVector.copyFrom(t.direction),this.attachedNode.absolutePosition.subtractToRef(t.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*p.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);let c=p.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-c,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}else return null;let r=this._dragPlane.forward,n=this._dragPlane.position,o=t.direction.dot(r);if(Math.abs(o)<je)return null;n.subtractToRef(t.origin,O.Vector3[0]);let a=O.Vector3[0].dot(r)/o;return a<0?null:(t.direction.scaleToRef(a,O.Vector3[0]),t.origin.add(O.Vector3[0]))}_updateDragPlanePosition(t,i){this._pointA.copyFrom(i),this._options.dragAxis?(this.useObjectOrientationForDragging?p.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),t.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(p.Dot(this._localAxis,this._pointC))>.999?Math.abs(p.Dot(p.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(p.Right()):this._lookAt.copyFrom(p.UpReadOnly):(p.CrossToRef(this._localAxis,this._pointC,this._lookAt),p.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?p.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(t.origin)),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)}detach(){this._lastPointerRay={},this.attachedNode&&(this.attachedNode.isNearGrabbable=!1),this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._dragPlane&&this._dragPlane.dispose(),this.releaseDrag()}}return s._AnyMouseId=-2,s})();var ct=(()=>{class s{}return s.ANCHOR_SYSTEM="xr-anchor-system",s.BACKGROUND_REMOVER="xr-background-remover",s.HIT_TEST="xr-hit-test",s.MESH_DETECTION="xr-mesh-detection",s.PHYSICS_CONTROLLERS="xr-physics-controller",s.PLANE_DETECTION="xr-plane-detection",s.POINTER_SELECTION="xr-controller-pointer-selection",s.TELEPORTATION="xr-controller-teleportation",s.FEATURE_POINTS="xr-feature-points",s.HAND_TRACKING="xr-hand-tracking",s.IMAGE_TRACKING="xr-image-tracking",s.NEAR_INTERACTION="xr-near-interaction",s.DOM_OVERLAY="xr-dom-overlay",s.MOVEMENT="xr-controller-movement",s.LIGHT_ESTIMATION="xr-light-estimation",s.EYE_TRACKING="xr-eye-tracking",s.WALKING_LOCOMOTION="xr-walking-locomotion",s.LAYERS="xr-layers",s.DEPTH_SENSING="xr-depth-sensing",s.SPACE_WARP="xr-space-warp",s.RAW_CAMERA_ACCESS="xr-raw-camera-access",s})(),mt=class s{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add(()=>{this.getEnabledFeatures().forEach(t=>{let i=this._features[t];i.enabled&&!i.featureImplementation.attached&&!i.featureImplementation.disableAutoAttach&&this.attachFeature(t)})}),this._xrSessionManager.onXRSessionEnded.add(()=>{this.getEnabledFeatures().forEach(t=>{let i=this._features[t];i.enabled&&i.featureImplementation.attached&&this.detachFeature(t)})})}static AddWebXRFeature(e,t,i=1,r=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),r&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,r){let n=this._AvailableFeatures[e][t];if(!n)throw new Error("feature not found");return n(i,r)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){let t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&(t.featureImplementation.attach()||H.Warn(`Feature ${e} failed to attach`))}detachFeature(e){let t=this._features[e];t&&t.featureImplementation.attached&&(t.featureImplementation.detach()||H.Warn(`Feature ${e} failed to detach`))}disableFeature(e){let t=typeof e=="string"?e:e.Name,i=this._features[t];return i&&i.enabled?(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],!0):!1}dispose(){this.getEnabledFeatures().forEach(e=>{this.disableFeature(e)})}enableFeature(e,t="latest",i={},r=!0,n=!0){let o=typeof e=="string"?e:e.Name,a=0;if(typeof t=="string"){if(!t)throw new Error(`Error in provided version - ${o} (${t})`);if(t==="stable"?a=s.GetStableVersionOfFeature(o):t==="latest"?a=s.GetLatestVersionOfFeature(o):a=+t,a===-1||isNaN(a))throw new Error(`feature not found - ${o} (${t})`)}else a=t;let l=s._ConflictingFeatures[o];if(l!==void 0&&this.getEnabledFeatures().indexOf(l)!==-1)throw new Error(`Feature ${o} cannot be enabled while ${l} is enabled.`);let c=this._features[o],h=s.ConstructFeature(o,a,this._xrSessionManager,i);if(!h)throw new Error(`feature not found - ${o}`);c&&this.disableFeature(o);let u=h();if(u.dependsOn&&!u.dependsOn.every(f=>!!this._features[f]))throw new Error(`Dependant features missing. Make sure the following features are enabled - ${u.dependsOn.join(", ")}`);if(u.isCompatible())return this._features[o]={featureImplementation:u,enabled:!0,version:a,required:n},r?this._xrSessionManager.session&&!this._features[o].featureImplementation.attached&&this.attachFeature(o):this._features[o].featureImplementation.disableAutoAttach=!0,this._features[o].featureImplementation;if(n)throw new Error("required feature not compatible");return H.Warn(`Feature ${o} not compatible with the current environment/browser and was not enabled.`),u}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}_extendXRSessionInitObject(e){return $e(this,null,function*(){let t=this.getEnabledFeatures();for(let i of t){let r=this._features[i],n=r.featureImplementation.xrNativeFeatureName;if(n&&(r.required?(e.requiredFeatures=e.requiredFeatures||[],e.requiredFeatures.indexOf(n)===-1&&e.requiredFeatures.push(n)):(e.optionalFeatures=e.optionalFeatures||[],e.optionalFeatures.indexOf(n)===-1&&e.optionalFeatures.push(n))),r.featureImplementation.getXRSessionInitExtension){let o=yield r.featureImplementation.getXRSessionInitExtension();e=ie(ie({},e),o)}}return e})}};mt._AvailableFeatures={};mt._ConflictingFeatures={[ct.TELEPORTATION]:ct.MOVEMENT,[ct.MOVEMENT]:ct.TELEPORTATION};var Ct=class{get xrNativeFeatureName(){return this._xrNativeFeatureName}set xrNativeFeatureName(e){!this._xrSessionManager.isNative&&e&&this._xrSessionManager.inXRSession&&this._xrSessionManager.enabledFeatures?.indexOf(e)===-1&&F.Warn(`The feature ${e} needs to be enabled before starting the XR session. Note - It is still possible it is not supported.`),this._xrNativeFeatureName=e}constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this._xrNativeFeatureName="",this.onFeatureAttachObservable=new U,this.onFeatureDetachObservable=new U}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;if(!this._xrSessionManager.enabledFeatures)F.Warn("session.enabledFeatures is not available on this device. It is possible that this feature is not supported.");else if(!this._xrSessionManager.isNative&&this.xrNativeFeatureName&&this._xrSessionManager.enabledFeatures.indexOf(this.xrNativeFeatureName)===-1)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,t=>this._onXRFrame(t)),this.onFeatureAttachObservable.notifyObservers(this),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach(e=>{e.observable.remove(e.observer)}),this.onFeatureDetachObservable.notifyObservers(this),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0,this.onFeatureAttachObservable.clear(),this.onFeatureDetachObservable.clear()}isCompatible(){return!0}_addNewAttachObserver(e,t,i){this._removeOnDetach.push({observable:e,observer:e.add(t,void 0,i)})}};var zt=class{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint,this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}};zt.DistanceJoint=0;zt.HingeJoint=1;zt.BallAndSocketJoint=2;zt.WheelJoint=3;zt.SliderJoint=4;zt.PrismaticJoint=5;zt.UniversalJoint=6;zt.Hinge2Joint=zt.WheelJoint;zt.PointToPointJoint=8;zt.SpringJoint=9;zt.LockJoint=10;k._PhysicsImpostorParser=function(s,e,t){return new He(e,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},s)};var He=class s{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},r){if(this.object=e,this.type=t,this._options=i,this._scene=r,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=p.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new q,this._tmpQuat2=new q,this.beforeStep=()=>{this._physicsEngine&&(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new q),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach(n=>{n(this)}))},this.afterStep=()=>{this._physicsEngine&&(this._onAfterPhysicsStepCallbacks.forEach(n=>{n(this)}),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,s._TmpVecs[0]),this.object.translate(s._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=n=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent||!this._physicsEngine)return;let o=this._physicsEngine.getImpostorWithPhysicsBody(n.body);o&&(this.onCollideEvent&&this.onCollideEvent(this,o),this._onPhysicsCollideCallbacks.filter(a=>a.otherImpostors.indexOf(o)!==-1).forEach(a=>{a.callback(this,o,n.point,n.distance,n.impulse,n.normal)}))},!this.object){F.Error("No object was provided. A physics object is obligatory");return}this.object.parent&&i.mass!==0&&F.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=q.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new q),this._options.mass=i.mass===void 0?0:i.mass,this._options.friction=i.friction===void 0?.2:i.friction,this._options.restitution=i.restitution===void 0?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=i.pressure===void 0?200:i.pressure,this._options.stiffness=i.stiffness===void 0?1:i.stiffness,this._options.velocityIterations=i.velocityIterations===void 0?20:i.velocityIterations,this._options.positionIterations=i.positionIterations===void 0?20:i.positionIterations,this._options.fixedPoints=i.fixedPoints===void 0?0:i.fixedPoints,this._options.margin=i.margin===void 0?0:i.margin,this._options.damping=i.damping===void 0?0:i.damping,this._options.path=i.path===void 0?null:i.path,this._options.shape=i.shape===void 0?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&F.Warn("You must affect impostors to children before affecting impostor to parent.")):F.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof lt?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){let e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=s.IDENTITY_QUATERNION;let i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);let n=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return n.x=Math.abs(n.x),n.y=Math.abs(n.y),n.z=Math.abs(n.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),n}else return s.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):p.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):p.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){let t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):F.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){let t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):F.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){let i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})}unregisterOnPhysicsCollide(e,t){let i=e instanceof Array?e:[e],r=-1;this._onPhysicsCollideCallbacks.some((o,a)=>{if(o.callback===t&&o.otherImpostors.length===i.length){let l=o.otherImpostors.every(c=>i.indexOf(c)>-1);return l&&(r=a),l}return!1})?this._onPhysicsCollideCallbacks.splice(r,1):F.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):q.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){let r=new zt(t,i);return this.addJoint(e,r),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,r,n){if(!this._physicsEngine)return this;let o=this._physicsEngine.getPhysicsPlugin();return o.appendAnchor?(this._physicsEngine&&o.appendAnchor(this,e,t,i,r,n),this):this}addHook(e,t,i,r){if(!this._physicsEngine)return this;let n=this._physicsEngine.getPhysicsPlugin();return n.appendAnchor?(this._physicsEngine&&n.appendHook(this,e,t,i,r),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new s(e,this.type,this._options,this._scene):null}dispose(){this._physicsEngine&&(this._joints.forEach(e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new q),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,r,n){let o=s._TmpVecs[0],a=this.object;if(a.rotationQuaternion)if(n){let l=s._TmpQuat;a.rotationQuaternion.multiplyToRef(n,l),e.setRotationQuaternion(l,Ke.WORLD,t)}else e.setRotationQuaternion(a.rotationQuaternion,Ke.WORLD,t);o.x=0,o.y=0,o.z=0,i&&(o.x=i.x,o.y=i.y,o.z=i.z,e.getDirectionToRef(o,t,o),r==null&&(r=i.length()),o.x*=r,o.y*=r,o.z*=r),e.getParent()?(o.addInPlace(a.getAbsolutePosition()),e.setAbsolutePosition(o,t)):(t.setAbsolutePosition(a.getAbsolutePosition()),t.position.x-=o.x,t.position.y-=o.y,t.position.z-=o.z)}syncImpostorWithBone(e,t,i,r,n,o){let a=this.object;if(a.rotationQuaternion)if(n){let h=s._TmpQuat;e.getRotationQuaternionToRef(Ke.WORLD,t,h),h.multiplyToRef(n,a.rotationQuaternion)}else e.getRotationQuaternionToRef(Ke.WORLD,t,a.rotationQuaternion);let l=s._TmpVecs[0],c=s._TmpVecs[1];o||(o=s._TmpVecs[2],o.x=0,o.y=1,o.z=0),e.getDirectionToRef(o,t,c),e.getAbsolutePositionToRef(t,l),r==null&&i&&(r=i.length()),r!=null&&(l.x+=c.x*r,l.y+=c.y*r,l.z+=c.z*r),a.setAbsolutePosition(l)}};He.DEFAULT_OBJECT_SIZE=new p(1,1,1);He.IDENTITY_QUATERNION=q.Identity();He._TmpVecs=Ir.BuildArray(3,p.Zero);He._TmpQuat=q.Identity();He.NoImpostor=0;He.SphereImpostor=1;He.BoxImpostor=2;He.PlaneImpostor=3;He.MeshImpostor=4;He.CapsuleImpostor=6;He.CylinderImpostor=7;He.ParticleImpostor=8;He.HeightmapImpostor=9;He.ConvexHullImpostor=10;He.CustomImpostor=100;He.RopeImpostor=101;He.ClothImpostor=102;He.SoftbodyImpostor=103;var Ul=function(s){return s[s.Clean=0]="Clean",s[s.Stop=1]="Stop",s[s.Sync=2]="Sync",s[s.NoSync=3]="NoSync",s}(Ul||{}),Mt=class s{static get ForceFullSceneLoadingForIncremental(){return pn.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){pn.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return pn.ShowLoadingScreen}static set ShowLoadingScreen(e){pn.ShowLoadingScreen=e}static get loggingLevel(){return pn.loggingLevel}static set loggingLevel(e){pn.loggingLevel=e}static get CleanBoneMatrixWeights(){return pn.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){pn.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return s._RegisteredPlugins[".babylon"]}static _GetPluginForExtension(e){let t=s._RegisteredPlugins[e];return t||(F.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),s.GetDefaultPlugin())}static _GetPluginForDirectLoad(e){for(let t in s._RegisteredPlugins){let i=s._RegisteredPlugins[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return s._RegisteredPlugins[t]}return s.GetDefaultPlugin()}static _GetPluginForFilename(e){let t=e.indexOf("?");t!==-1&&(e=e.substring(0,t));let i=e.lastIndexOf("."),r=e.substring(i,e.length).toLowerCase();return s._GetPluginForExtension(r)}static _GetDirectLoad(e){return e.substr(0,5)==="data:"?e.substr(5):null}static _FormatErrorMessage(e,t,i){let n="Unable to load from "+(e.rawData?"binary data":e.url);return t?n+=`: ${t}`:i&&(n+=`: ${i}`),n}static _LoadData(e,t,i,r,n,o,a,l){let c=s._GetDirectLoad(e.url);if(e.rawData&&!a)throw"When using ArrayBufferView to load data the file extension must be provided.";let h=a?s._GetPluginForExtension(a):c?s._GetPluginForDirectLoad(e.url):s._GetPluginForFilename(e.url);if(e.rawData&&!h.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";let u=h.plugin.createPlugin?.()??h.plugin;if(!u)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(s.OnPluginActivatedObservable.notifyObservers(u),c&&(u.canDirectLoad&&u.canDirectLoad(e.url)||!Eg(e.url))){if(u.directLoad){let C=u.directLoad(t,c);C instanceof Promise?C.then(R=>{i(u,R)}).catch(R=>{n("Error in directLoad of _loadData: "+R,R)}):i(u,C)}else i(u,c);return u}let d=h.isBinary,f=(C,R)=>{if(t.isDisposed){n("Scene has been disposed");return}i(u,C,R)},m=null,g=!1;u.onDisposeObservable?.add(()=>{g=!0,m&&(m.abort(),m=null),o()});let _=()=>{if(g)return;let C=(R,E)=>{n(R?.statusText,E)};if(!u.loadFile&&e.rawData)throw"Plugin does not support loading ArrayBufferView.";m=u.loadFile?u.loadFile(t,e.rawData||e.file||e.url,e.rootUrl,f,r,d,C,l):t._loadFile(e.file||e.url,f,r,!0,d,C)},x=t.getEngine(),b=x.enableOfflineSupport;if(b){let C=!1;for(let R of t.disableOfflineSupportExceptionRules)if(R.test(e.url)){C=!0;break}b=!C}return b&&K.OfflineProviderFactory?t.offlineProvider=K.OfflineProviderFactory(e.url,_,x.disableManifestCheck):_(),u}static _GetFileInfo(e,t){let i,r,n=null,o=null;if(!t)i=e,r=H.GetFilename(e),e=H.GetFolderPath(e);else if(t.name){let a=t;i=`file:${a.name}`,r=a.name,n=a}else if(ArrayBuffer.isView(t))i="",r=ts(),o=t;else if(typeof t=="string"&&t.startsWith("data:"))i=t,r="";else{let a=t;if(a.substr(0,1)==="/")return H.Error("Wrong sceneFilename parameter"),null;i=e+a,r=a}return{url:i,rootUrl:e,name:r,file:n,rawData:o}}static GetPluginForExtension(e){return s._GetPluginForExtension(e).plugin}static IsPluginForExtensionAvailable(e){return!!s._RegisteredPlugins[e]}static RegisterPlugin(e){if(typeof e.extensions=="string"){let t=e.extensions;s._RegisteredPlugins[t.toLowerCase()]={plugin:e,isBinary:!1}}else{let t=e.extensions;Object.keys(t).forEach(i=>{s._RegisteredPlugins[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary}})}}static ImportMesh(e,t,i="",r=me.LastCreatedScene,n=null,o=null,a=null,l=null,c=""){if(!r)return F.Error("No scene available to import mesh to"),null;let h=s._GetFileInfo(t,i);if(!h)return null;let u={};r.addPendingData(u);let d=()=>{r.removePendingData(u)},f=(_,x)=>{let b=s._FormatErrorMessage(h,_,x);a?a(r,b,new Wo(b,zo.SceneLoaderError,x)):F.Error(b),d()},m=o?_=>{try{o(_)}catch(x){f("Error in onProgress callback: "+x,x)}}:void 0,g=(_,x,b,C,R,E,S,A)=>{if(r.importedMeshesFiles.push(h.url),n)try{n(_,x,b,C,R,E,S,A)}catch(L){f("Error in onSuccess callback: "+L,L)}r.removePendingData(u)};return s._LoadData(h,r,(_,x,b)=>{if(_.rewriteRootURL&&(h.rootUrl=_.rewriteRootURL(h.rootUrl,b)),_.importMesh){let C=_,R=[],E=[],S=[];if(!C.importMesh(e,r,x,h.rootUrl,R,E,S,f))return;r.loadingPluginName=_.name,g(R,E,S,[],[],[],[],[])}else _.importMeshAsync(e,r,x,h.rootUrl,m,h.name).then(R=>{r.loadingPluginName=_.name,g(R.meshes,R.particleSystems,R.skeletons,R.animationGroups,R.transformNodes,R.geometries,R.lights,R.spriteManagers)}).catch(R=>{f(R.message,R)})},m,f,d,l,c)}static ImportMeshAsync(e,t,i="",r=me.LastCreatedScene,n=null,o=null,a=""){return new Promise((l,c)=>{s.ImportMesh(e,t,i,r,(h,u,d,f,m,g,_,x)=>{l({meshes:h,particleSystems:u,skeletons:d,animationGroups:f,transformNodes:m,geometries:g,lights:_,spriteManagers:x})},n,(h,u,d)=>{c(d||new Error(u))},o,a)})}static Load(e,t="",i=me.LastCreatedEngine,r=null,n=null,o=null,a=null,l=""){return i?s.Append(e,t,new Te(i),r,n,o,a,l):(H.Error("No engine available"),null)}static LoadAsync(e,t="",i=me.LastCreatedEngine,r=null,n=null,o=""){return new Promise((a,l)=>{s.Load(e,t,i,c=>{a(c)},r,(c,h,u)=>{l(u||new Error(h))},n,o)})}static Append(e,t="",i=me.LastCreatedScene,r=null,n=null,o=null,a=null,l=""){if(!i)return F.Error("No scene available to append to"),null;let c=s._GetFileInfo(e,t);if(!c)return null;let h={};i.addPendingData(h);let u=()=>{i.removePendingData(h)};s.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady(()=>{i.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1}));let d=(g,_)=>{let x=s._FormatErrorMessage(c,g,_);o?o(i,x,new Wo(x,zo.SceneLoaderError,_)):F.Error(x),u()},f=n?g=>{try{n(g)}catch(_){d("Error in onProgress callback",_)}}:void 0,m=()=>{if(r)try{r(i)}catch(g){d("Error in onSuccess callback",g)}i.removePendingData(h)};return s._LoadData(c,i,(g,_)=>{if(g.load){if(!g.load(i,_,c.rootUrl,d))return;i.loadingPluginName=g.name,m()}else g.loadAsync(i,_,c.rootUrl,f,c.name).then(()=>{i.loadingPluginName=g.name,m()}).catch(b=>{d(b.message,b)})},f,d,u,a,l)}static AppendAsync(e,t="",i=me.LastCreatedScene,r=null,n=null,o=""){return new Promise((a,l)=>{s.Append(e,t,i,c=>{a(c)},r,(c,h,u)=>{l(u||new Error(h))},n,o)})}static LoadAssetContainer(e,t="",i=me.LastCreatedScene,r=null,n=null,o=null,a=null,l=""){if(!i)return F.Error("No scene available to load asset container to"),null;let c=s._GetFileInfo(e,t);if(!c)return null;let h={};i.addPendingData(h);let u=()=>{i.removePendingData(h)},d=(g,_)=>{let x=s._FormatErrorMessage(c,g,_);o?o(i,x,new Wo(x,zo.SceneLoaderError,_)):F.Error(x),u()},f=n?g=>{try{n(g)}catch(_){d("Error in onProgress callback",_)}}:void 0,m=g=>{if(r)try{r(g)}catch(_){d("Error in onSuccess callback",_)}i.removePendingData(h)};return s._LoadData(c,i,(g,_)=>{if(g.loadAssetContainer){let b=g.loadAssetContainer(i,_,c.rootUrl,d);if(!b)return;b.populateRootNodes(),i.loadingPluginName=g.name,m(b)}else g.loadAssetContainerAsync?g.loadAssetContainerAsync(i,_,c.rootUrl,f,c.name).then(b=>{b.populateRootNodes(),i.loadingPluginName=g.name,m(b)}).catch(b=>{d(b.message,b)}):d("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},f,d,u,a,l)}static LoadAssetContainerAsync(e,t="",i=me.LastCreatedScene,r=null,n=null){return new Promise((o,a)=>{s.LoadAssetContainer(e,t,i,l=>{o(l)},r,(l,c,h)=>{a(h||new Error(c))},n)})}static ImportAnimations(e,t="",i=me.LastCreatedScene,r=!0,n=Ul.Clean,o=null,a=null,l=null,c=null,h=null){if(!i){F.Error("No scene available to load animations to");return}if(r){for(let m of i.animatables)m.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach(m=>{m.dispose()}),i.getNodes().forEach(m=>{m.animations&&(m.animations=[])})}else switch(n){case Ul.Clean:i.animationGroups.slice().forEach(f=>{f.dispose()});break;case Ul.Stop:i.animationGroups.forEach(f=>{f.stop()});break;case Ul.Sync:i.animationGroups.forEach(f=>{f.reset(),f.restart()});break;case Ul.NoSync:break;default:F.Error("Unknown animation group loading mode value '"+n+"'");return}let u=i.animatables.length,d=f=>{f.mergeAnimationsTo(i,i.animatables.slice(u),o),f.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),a&&a(i)};this.LoadAssetContainer(e,t,i,d,l,c,h)}static ImportAnimationsAsync(e,t="",i=me.LastCreatedScene,r=!0,n=Ul.Clean,o=null,a=null,l=null,c=null,h=null){return new Promise((u,d)=>{s.ImportAnimations(e,t,i,r,n,o,f=>{u(f)},l,(f,m,g)=>{d(g||new Error(m))},h)})}};Mt.NO_LOGGING=0;Mt.MINIMAL_LOGGING=1;Mt.SUMMARY_LOGGING=2;Mt.DETAILED_LOGGING=3;Mt.OnPluginActivatedObservable=new U;Mt._RegisteredPlugins={};Mt._ShowingLoadingScreen=!1;var Xs=class extends se{constructor(e,t,i=!0){super(e,t),this._normalMatrix=new N,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return e?!this._storeEffectOnSubMeshes||!e.subMeshes||e.subMeshes.length===0?!0:this.isReadyForSubMesh(e,e.subMeshes[0],t):!1}_isReadyForSubMesh(e){let t=e.materialDefines;return!!(!this.checkReadyOnEveryCall&&e.effect&&t&&t._renderId===this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){t&&this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null,i){super._afterBind(e,t,i),this.getScene()._cachedEffect=t,i?i._drawWrapper._forceRebindOnNextCall=!1:this._drawWrapper._forceRebindOnNextCall=!1}_mustRebind(e,t,i,r=1){return i._drawWrapper._forceRebindOnNextCall||e.isCachedMaterialInvalid(this,t,r)}dispose(e,t,i){this._activeEffect=void 0,super.dispose(e,t,i)}};var T=function(s){return s[s.Float=1]="Float",s[s.Int=2]="Int",s[s.Vector2=4]="Vector2",s[s.Vector3=8]="Vector3",s[s.Vector4=16]="Vector4",s[s.Color3=32]="Color3",s[s.Color4=64]="Color4",s[s.Matrix=128]="Matrix",s[s.Object=256]="Object",s[s.AutoDetect=1024]="AutoDetect",s[s.BasedOnInput=2048]="BasedOnInput",s[s.All=4095]="All",s}(T||{});var w=function(s){return s[s.Vertex=1]="Vertex",s[s.Fragment=2]="Fragment",s[s.Neutral=4]="Neutral",s[s.VertexAndFragment=3]="VertexAndFragment",s}(w||{});var jp=class{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}get shaderLanguage(){return this.sharedData.nodeMaterial.shaderLanguage}get fSuffix(){return this.shaderLanguage===pe.WGSL?"f":""}finalize(e){let t=e.sharedData.emitComments,i=this.target===w.Fragment;this.shaderLanguage===pe.WGSL?i?this.compilationString=`
${t?`//Entry point
`:""}@fragment
fn main(input: FragmentInputs) -> FragmentOutputs {
${this.compilationString}`:this.compilationString=`
${t?`//Entry point
`:""}@vertex
fn main(input: VertexInputs) -> FragmentInputs{
${this.compilationString}`:this.compilationString=`
${t?`//Entry point
`:""}void main(void) {
${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`
${t?`//Constants
`:""}${this._constantDeclaration}
${this.compilationString}`);let r="";for(let n in this.functions)r+=this.functions[n]+`
`;if(this.compilationString=`
${r}
${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`
${t?`//Varyings
`:""}${this.sharedData.varyingDeclaration}
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`
${t?`//Samplers
`:""}${this._samplerDeclaration}
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`
${t?`//Uniforms
`:""}${this._uniformDeclaration}
${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`
${t?`//Attributes
`:""}${this._attributeDeclaration}
${this.compilationString}`),this.shaderLanguage!==pe.WGSL){this.compilationString=`precision highp float;
`+this.compilationString,this.compilationString=`#if defined(WEBGL2) || defines(WEBGPU)
precision highp sampler2DArray;
#endif
`+this.compilationString,i&&(this.compilationString=`#if defined(PREPASS)\r
#extension GL_EXT_draw_buffers : require\r
layout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r
highp vec4 gl_FragColor;\r
#endif\r
`+this.compilationString);for(let n in this.extensions){let o=this.extensions[n];this.compilationString=`
${o}
${this.compilationString}`}}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),this.sharedData.variableNames[e]===void 0?(this.sharedData.variableNames[e]=0,e==="output"||e==="texture"?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return this.sharedData.defineNames[e]===void 0?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===pe.WGSL?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d<f32>;
`):this._samplerDeclaration+=`uniform sampler2D ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emitCubeSampler(e,t="",i=!1){(this.samplers.indexOf(e)<0||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),this.shaderLanguage===pe.WGSL?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_cube<f32>;
`):this._samplerDeclaration+=`uniform samplerCube ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emit2DArraySampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};
`,this.samplers.push(e))}_getGLType(e){switch(e){case T.Float:return"float";case T.Int:return"int";case T.Vector2:return"vec2";case T.Color3:case T.Vector3:return"vec3";case T.Color4:case T.Vector4:return"vec4";case T.Matrix:return"mat4"}return""}_getShaderType(e){let t=this.shaderLanguage===pe.WGSL;switch(e){case T.Float:return t?"f32":"float";case T.Int:return t?"i32":"int";case T.Vector2:return t?"vec2f":"vec2";case T.Color3:case T.Vector3:return t?"vec3f":"vec3";case T.Color4:case T.Vector4:return t?"vec4f":"vec4";case T.Matrix:return t?"mat4x4f":"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}
${t}
#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+`
`+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`;let n=D.GetIncludesShadersStore(this.shaderLanguage)[e]+`
`;if(this.sharedData.emitComments&&(n=t+`
`+n),!i)return n;if(i.replaceStrings)for(let o=0;o<i.replaceStrings.length;o++){let a=i.replaceStrings[o];n=n.replace(a.search,a.replace)}return n}_emitFunctionFromInclude(e,t,i,r=""){let n=e+r;if(this.functions[n])return;if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[n]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`:this.functions[n]=`#include<${e}>${i?.substitutionVars?"("+i?.substitutionVars+")":""}
`,this.sharedData.emitComments&&(this.functions[n]=t+`
`+this.functions[n]);return}let o=D.GetIncludesShadersStore(this.shaderLanguage);if(this.functions[n]=o[e],this.sharedData.emitComments&&(this.functions[n]=t+`
`+this.functions[n]),i.removeIfDef&&(this.functions[n]=this.functions[n].replace(/^\s*?#ifdef.+$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#endif.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#else.*$/gm,""),this.functions[n]=this.functions[n].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[n]=this.functions[n].replace(/\s*?attribute .+?;/g,`
`)),i.removeUniforms&&(this.functions[n]=this.functions[n].replace(/\s*?uniform .*?;/g,`
`)),i.removeVaryings&&(this.functions[n]=this.functions[n].replace(/\s*?(varying|in) .+?;/g,`
`)),i.replaceStrings)for(let a=0;a<i.replaceStrings.length;a++){let l=i.replaceStrings[a];this.functions[n]=this.functions[n].replace(l.search,l.replace)}}_registerTempVariable(e){return this.sharedData.temps.indexOf(e)!==-1?!1:(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",r=!1){if(this.sharedData.varyings.indexOf(e)!==-1)return!1;this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}
`:this.sharedData.varyingDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}
`);let n=this._getShaderType(t);return this.shaderLanguage===pe.WGSL?this.sharedData.varyingDeclaration+=`varying ${e}: ${n};
`:this.sharedData.varyingDeclaration+=`varying ${n} ${e};
`,i&&(this.sharedData.varyingDeclaration+=`#endif
`),!0}_getVaryingName(e){return this.shaderLanguage===pe.WGSL?(this.target!==w.Fragment?"vertexOutputs.":"fragmentInputs.")+e:e}_emitUniformFromString(e,t,i="",r=!1){if(this.uniforms.indexOf(e)!==-1)return;this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}
`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}
`);let n=this._getShaderType(t);this.shaderLanguage===pe.WGSL?this._uniformDeclaration+=`uniform ${e}: ${n};
`:this._uniformDeclaration+=`uniform ${n} ${e};
`,i&&(this._uniformDeclaration+=`#endif
`)}_generateTernary(e,t,i){return this.shaderLanguage===pe.WGSL?`select(${t}, ${e}, ${i})`:`${i} ? ${e} : ${t}`}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}_declareOutput(e,t){return this._declareLocalVar(e.associatedVariableName,e.type,t)}_declareLocalVar(e,t,i){return this.shaderLanguage===pe.WGSL?`${i?"const":"var"} ${e}: ${this._getShaderType(t)}`:`${this._getShaderType(t)} ${e}`}_samplerCubeFunc(){return this.shaderLanguage===pe.WGSL?"textureSample":"textureCube"}_samplerFunc(){return this.shaderLanguage===pe.WGSL?"textureSample":"texture2D"}_samplerLODFunc(){return this.shaderLanguage===pe.WGSL?"textureSampleLevel":"texture2DLodEXT"}_generateTextureSample(e,t){return this.shaderLanguage===pe.WGSL?`${this._samplerFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerFunc()}(${t}, ${e})`}_generateTextureSampleLOD(e,t,i){return this.shaderLanguage===pe.WGSL?`${this._samplerLODFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerLODFunc()}(${t}, ${e}, ${i})`}_generateTextureSampleCube(e,t){return this.shaderLanguage===pe.WGSL?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerCubeFunc()}(${t}, ${e})`}_generateTextureSampleCubeLOD(e,t,i){return this.shaderLanguage===pe.WGSL?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerCubeFunc()}(${t}, ${e}, ${i})`}_convertVariableDeclarationToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\s+(\\w+)`,"g"),`var $2: ${t}`)}_convertVariableConstructorsToWGSL(e,t,i){return i.replace(new RegExp(`(${e})\\(`,"g"),` ${t}(`)}_convertOutParametersToWGSL(e){return e.replace(new RegExp("out\\s+var\\s+(\\w+)\\s*:\\s*(\\w+)","g"),"$1: ptr<function, $2>")}_convertTernaryOperandsToWGSL(e){return e.replace(new RegExp("\\[(.*?)\\?(.*?):(.*)\\]","g"),(t,i,r,n)=>`select(${n}, ${r}, ${i})`)}_convertModOperatorsToWGSL(e){return e.replace(new RegExp("mod\\((.+?),\\s*(.+?)\\)","g"),(t,i,r)=>`((${i})%(${r}))`)}_convertConstToWGSL(e){return e.replace(new RegExp("const var","g"),"const")}_convertInnerFunctionsToWGSL(e){return e.replace(new RegExp("inversesqrt","g"),"inverseSqrt")}_convertFunctionsToWGSL(e){let t=/var\s+(\w+)\s*:\s*(\w+)\((.*)\)/g,i;for(;(i=t.exec(e))!==null;){let r=i[1],n=i[2],a=i[3].replace(/var\s/g,"");e=e.replace(i[0],`fn ${r}(${a}) -> ${n}`)}return e}_babylonSLtoWGSL(e){return e=this._convertVariableDeclarationToWGSL("void","voidnull",e),e=this._convertVariableDeclarationToWGSL("bool","bool",e),e=this._convertVariableDeclarationToWGSL("int","i32",e),e=this._convertVariableDeclarationToWGSL("uint","u32",e),e=this._convertVariableDeclarationToWGSL("float","f32",e),e=this._convertVariableDeclarationToWGSL("vec2","vec2f",e),e=this._convertVariableDeclarationToWGSL("vec3","vec3f",e),e=this._convertVariableDeclarationToWGSL("vec4","vec4f",e),e=this._convertVariableDeclarationToWGSL("mat2","mat2x2f",e),e=this._convertVariableDeclarationToWGSL("mat3","mat3x3f",e),e=this._convertVariableDeclarationToWGSL("mat4","mat4x4f",e),e=this._convertVariableConstructorsToWGSL("float","f32",e),e=this._convertVariableConstructorsToWGSL("vec2","vec2f",e),e=this._convertVariableConstructorsToWGSL("vec3","vec3f",e),e=this._convertVariableConstructorsToWGSL("vec4","vec4f",e),e=this._convertVariableConstructorsToWGSL("mat2","mat2x2f",e),e=this._convertVariableConstructorsToWGSL("mat3","mat3x3f",e),e=this._convertVariableConstructorsToWGSL("mat4","mat4x4f",e),e=this._convertTernaryOperandsToWGSL(e),e=this._convertModOperatorsToWGSL(e),e=this._convertConstToWGSL(e),e=this._convertInnerFunctionsToWGSL(e),e=this._convertOutParametersToWGSL(e),e=e.replace(/\[\*\]/g,"*"),e=this._convertFunctionsToWGSL(e),e=e.replace(/\s->\svoidnull/g,""),e=e.replace(/dFdx/g,"dpdx"),e=e.replace(/dFdy/g,"dpdy"),e}_convertTernaryOperandsToGLSL(e){return e.replace(new RegExp("\\[(.+?)\\?(.+?):(.+)\\]","g"),(t,i,r,n)=>`${i} ? ${r} : ${n}`)}_babylonSLtoGLSL(e){return e=e.replace(/\[\*\]/g,""),e=this._convertTernaryOperandsToGLSL(e),e}};var qx=class{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(){let e="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(e+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.
`),this.checks.emitFragment||(e+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.
`);for(let t of this.checks.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.
`;if(e)throw`Build of NodeMaterial failed:
`+e}};var Qt=class{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!1,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(let e of Object.keys(this))e[0]!=="_"&&this._keys.push(e);if(this._externalProperties)for(let e in this._externalProperties)this._keys.indexOf(e)===-1&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){let i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){let i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){let t=this._externalProperties?.[e]?.type??typeof this[e],i=this._externalProperties?.[e]?.default;switch(t){case"number":this[e]=i??0;break;case"string":this[e]=i??"";break;default:this[e]=i??!1;break}}toString(){let e="";for(let t=0;t<this._keys.length;t++){let i=this._keys[t],r=this[i];switch(typeof r){case"number":case"string":e+="#define "+i+" "+r+`
`;break;default:r&&(e+="#define "+i+`
`);break}}return e}};var mn=function(s){return s[s.Compatible=0]="Compatible",s[s.TypeIncompatible=1]="TypeIncompatible",s[s.TargetIncompatible=2]="TargetIncompatible",s[s.HierarchyIssue=3]="HierarchyIssue",s}(mn||{}),xt=function(s){return s[s.Input=0]="Input",s[s.Output=1]="Output",s}(xt||{}),Qc=class s{static AreEquivalentTypes(e,t){switch(e){case T.Vector3:{if(t===T.Color3)return!0;break}case T.Vector4:{if(t===T.Color4)return!0;break}case T.Color3:{if(t===T.Vector3)return!0;break}case T.Color4:{if(t===T.Vector4)return!0;break}}return!1}get _connectedPoint(){return this._connectedPointBackingField}set _connectedPoint(e){this._connectedPointBackingField!==e&&(this._connectedPointTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._connectedPointBackingField=e),this._connectedPointBackingField&&(this._connectedPointTypeChangedObserver=this._connectedPointBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _typeConnectionSource(){return this._typeConnectionSourceBackingField}set _typeConnectionSource(e){this._typeConnectionSourceBackingField!==e&&(this._typeConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._typeConnectionSourceBackingField=e),this._typeConnectionSourceBackingField&&(this._typeConnectionSourceTypeChangedObserver=this._typeConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _defaultConnectionPointType(){return this._defaultConnectionPointTypeBackingField}set _defaultConnectionPointType(e){this._updateTypeDependentState(()=>this._defaultConnectionPointTypeBackingField=e)}get _linkedConnectionSource(){return this._linkedConnectionSourceBackingField}set _linkedConnectionSource(e){this._linkedConnectionSourceBackingField!==e&&(this._linkedConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._linkedConnectionSourceBackingField=e),this._linkedConnectionSourceBackingField&&(this._linkedConnectionSourceTypeChangedObserver=this._linkedConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get direction(){return this._direction}get declarationVariableName(){return this._ownerBlock.isInput?this._ownerBlock.declarationVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.declarationVariableName:this._associatedVariableName}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===T.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===T.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._updateTypeDependentState(()=>this._type=e)}get target(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==w.VertexAndFragment?this._target:this._ownerBlock.target===w.Fragment?w.Fragment:w.Vertex}set target(e){this._target=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get isConnectedToInputBlock(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===w.Vertex||(e.ownerBlock.target===w.Neutral||e.ownerBlock.target===w.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===w.Vertex)return!0;if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===w.Vertex||e.target===w.Vertex||(e.ownerBlock.target===w.Neutral||e.ownerBlock.target===w.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===w.Fragment)return!0;if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===w.Fragment||(e.ownerBlock.target===w.Neutral||e.ownerBlock.target===w.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0;return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._connectedPointBackingField=null,this._endpoints=new Array,this._typeConnectionSourceBackingField=null,this._defaultConnectionPointTypeBackingField=null,this._linkedConnectionSourceBackingField=null,this._acceptedConnectionPointType=null,this._type=T.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new U,this.onDisconnectionObservable=new U,this.onTypeChangedObservable=new U,this._isTypeChangeObservableNotifying=!1,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=w.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===mn.Compatible}checkCompatibilityState(e){let t=this._ownerBlock,i=e.ownerBlock;if(t.target===w.Fragment){if(i.target===w.Vertex)return mn.TargetIncompatible;for(let o of i.outputs)if(o.ownerBlock.target!=w.Neutral&&o.isConnectedInVertexShader)return mn.TargetIncompatible}if(this.type!==e.type&&e.innerType!==T.AutoDetect)return s.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1||e._acceptedConnectionPointType&&s.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?mn.Compatible:mn.TypeIncompatible;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return mn.TypeIncompatible;let r=i,n=t;return this.direction===xt.Input&&(r=t,n=i),r.isAnAncestorOf(n)?mn.HierarchyIssue:mn.Compatible}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){let t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this),this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<T.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){let t={};return t.name=this.name,t.displayName=this.displayName,e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear(),this.onTypeChangedObservable.clear(),this._connectedPoint=null,this._typeConnectionSource=null,this._linkedConnectionSource=null}_updateTypeDependentState(e){let t=this.type;e(),this.type!==t&&this._notifyTypeChanged()}_notifyTypeChanged(){this._isTypeChangeObservableNotifying||(this._isTypeChangeObservableNotifying=!0,this.onTypeChangedObservable.notifyObservers(this.type),this._isTypeChangeObservableNotifying=!1)}};var Z=class{get name(){return this._name}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){this._target&e||(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){let t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){let t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}constructor(e,t=w.Vertex,i=!1){this._isFinalMerger=!1,this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===w.Neutral,this._isFinalMerger=i,this._isInput=this.getClassName()==="InputBlock",this._isTeleportOut=this.getClassName()==="NodeMaterialTeleportOutBlock",this._isTeleportIn=this.getClassName()==="NodeMaterialTeleportInBlock",this._name=e,this.uniqueId=xu.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===w.Neutral}initialize(e){}bind(e,t,i,r){}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return t.indexOf(".")===-1&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some(e=>e.isConnectedInFragmentShader)}registerInput(e,t,i=!1,r,n){return n=n??new Qc(e,this,xt.Input),n.type=t,n.isOptional=i,r&&(n.target=r),this._inputs.push(n),this}registerOutput(e,t,i,r){return r=r??new Qc(e,this,xt.Output),r.type=t,i&&(r.target=i),this._outputs.push(r),this}getFirstAvailableInput(e=null){for(let t of this._inputs)if(!t.connectedPoint&&(!e||e.type===t.type||t.type===T.AutoDetect))return t;return null}getFirstAvailableOutput(e=null){for(let t of this._outputs)if(!e||!e.target||e.target===w.Neutral||e.target&t.target)return t;return null}getSiblingOutput(e){let t=this._outputs.indexOf(e);return t===-1||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(let t of this._outputs)if(t.hasEndpoints){for(let i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(this._outputs.length===0)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),r=!0;for(;r;){let n=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&n&&i.canConnectTo(n))i.connectTo(n),r=!1;else if(i)i=this.getSiblingOutput(i);else throw"Unable to find a compatible match"}return this}_buildBlock(e){}updateUniformsAndSamples(e,t,i,r){}provideFallbacks(e,t){}initializeDefines(e,t,i,r=!1){}prepareDefines(e,t,i,r=!1,n){}autoConfigure(e,t=()=>!0){}replaceRepeatableContent(e,t,i,r){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===w.Vertex?!1:!!((this.target===w.VertexAndFragment||this.target===w.Neutral)&&this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,i,r=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,r){e.build(t,r);let n=t._vertexState!=null,o=e._buildTarget===w.Vertex&&e.target!==w.VertexAndFragment;if(n&&(!(e.target&e._buildTarget)||!(e.target&i.target)||this.target!==w.VertexAndFragment&&o)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){let a=i.connectedPoint;if(t._vertexState._emitVaryingFromString("v_"+a.declarationVariableName,a.type)){let c=t.shaderLanguage===pe.WGSL?"vertexOutputs.":"";t._vertexState.compilationString+=`${c}${"v_"+a.declarationVariableName} = ${a.associatedVariableName};
`}let l=t.shaderLanguage===pe.WGSL?"fragmentInputs.":"";i.associatedVariableName=l+"v_"+a.declarationVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){let t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(let i of t)if(e===i)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(let i of this._outputs)i.associatedVariableName||(i.associatedVariableName=e._getFreeVariableName(i.name));for(let i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==w.Neutral&&(!(i.target&this.target)||!(i.target&e.target)))continue;let r=i.connectedPoint.ownerBlock;r&&r!==this&&this._processBuild(r,e,i,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&F.Log(`${e.target===w.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case w.Vertex:e.sharedData.checks.emitVertex=!0;break;case w.Fragment:e.sharedData.checks.emitFragment=!0;break}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`
//${this.name}
`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(let i of this._outputs)if(i.target&e.target)for(let r of i.endpoints){let n=r.ownerBlock;n&&n.target&e.target&&t.indexOf(n)!==-1&&this._processBuild(n,e,r,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){let e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};
${e}.visibleOnFrame = ${this.visibleOnFrame};
${e}.target = ${this.target};
`}_dumpCode(e,t){t.push(this);let i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let n=0;do n++,this._codeVariableName=i+n;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;this.comments&&(r+=`// ${this.comments}
`),r+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");
`,r+=this._dumpPropertiesCode();for(let n of this.inputs){if(!n.isConnected)continue;let a=n.connectedPoint.ownerBlock;t.indexOf(a)===-1&&(r+=a._dumpCode(e,t))}for(let n of this.outputs)if(n.hasEndpoints)for(let o of n.endpoints){let a=o.ownerBlock;a&&t.indexOf(a)===-1&&(r+=a._dumpCode(e,t))}return r}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(let i of this.inputs){if(!i.isConnected)continue;let r=i.connectedPoint,n=r.ownerBlock;t+=n._dumpCodeForOutputConnections(e),t+=`${n._codeVariableName}.${n._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});
`}return t}clone(e,t=""){let i=this.serialize(),r=Et(i.customType);if(r){let n=new r;return n._deserialize(i,e,t),n}return null}serialize(){let e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(let t of this.inputs)e.inputs.push(t.serialize());for(let t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i,r){this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=e.target??this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){let t=e.inputs,i=e.outputs;t&&t.forEach((r,n)=>{r.displayName&&(this.inputs[n].displayName=r.displayName),r.isExposedOnFrame&&(this.inputs[n].isExposedOnFrame=r.isExposedOnFrame,this.inputs[n].exposedPortPosition=r.exposedPortPosition)}),i&&i.forEach((r,n)=>{r.displayName&&(this.outputs[n].displayName=r.displayName),r.isExposedOnFrame&&(this.outputs[n].isExposedOnFrame=r.isExposedOnFrame,this.outputs[n].exposedPortPosition=r.exposedPortPosition)})}dispose(){for(let e of this.inputs)e.dispose();for(let e of this.outputs)e.dispose()}};var xd=class extends Z{constructor(e){super(e,w.Neutral),this.complementW=1,this.complementZ=0,this.target=w.Vertex,this.registerInput("vector",T.AutoDetect),this.registerInput("transform",T.Matrix),this.registerOutput("output",T.Vector4),this.registerOutput("xyz",T.Vector3),this._inputs[0].onConnectionObservable.add(t=>{if(t.ownerBlock.isInput){let i=t.ownerBlock;(i.name==="normal"||i.name==="tangent")&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);let t=this.vector,i=this.transform,r=e._getShaderType(T.Vector4),n=e._getShaderType(T.Vector3);if(t.connectedPoint){if(this.complementW===0){let o=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",o),e.sharedData.blocksWithDefines.push(this);let a=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.shaderLanguage===pe.WGSL?e.compilationString+=`var ${a}: mat3x3f = mat3x3f(${i.associatedVariableName}[0].xyz, ${i.associatedVariableName}[1].xyz, ${i.associatedVariableName}[2].xyz);
`:e.compilationString+=`mat3 ${a} = mat3(${i.associatedVariableName});
`,e.compilationString+=`#ifdef NONUNIFORMSCALING
`,e.compilationString+=`${a} = transposeMat3(inverseMat3(${a}));
`,e.compilationString+=`#endif
`,t.connectedPoint.type){case T.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${n}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});
`;break;case T.Vector3:case T.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});
`;break}}else{let o=i.associatedVariableName;switch(t.connectedPoint.type){case T.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${o} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});
`;break;case T.Vector3:case T.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${o} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${o} * ${t.associatedVariableName};
`;break}}this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;
`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){let e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};
`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};
`,e}};P("BABYLON.TransformBlock",xd);var Kc=class extends Z{constructor(e){super(e,w.Vertex,!0),this.registerInput("vector",T.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(let i of e)if(i.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);let t=this.vector;return e.shaderLanguage===pe.WGSL?e.compilationString+=`vertexOutputs.position = ${t.associatedVariableName};
`:e.compilationString+=`gl_Position = ${t.associatedVariableName};
`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant",T.Float),e._emitVaryingFromString("vFragmentDepth",T.Float),e.compilationString+=`vFragmentDepth = 1.0 + gl_Position.w;
`,e.compilationString+=`gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;
`),this}};P("BABYLON.VertexOutputBlock",Kc);var ue=function(s){return s[s.Boolean=0]="Boolean",s[s.Float=1]="Float",s[s.Int=2]="Int",s[s.Vector2=3]="Vector2",s[s.List=4]="List",s}(ue||{});function de(s,e=ue.Boolean,t="PROPERTIES",i){return(r,n)=>{let o=r._propStore;o||(o=[],r._propStore=o),o.push({propertyName:n,displayName:s,type:e,groupName:t,options:i??{}})}}var bo=class extends Z{constructor(e){super(e,w.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",T.Color4,!0),this.registerInput("rgb",T.AutoDetect,!0),this.registerInput("a",T.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Vector3|T.Float)}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&i&&Br(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);let t=this.rgba,i=this.rgb,r=this.a;e.sharedData.hints.needAlphaBlending=t.isConnected||r.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant",T.Float),e._emitVaryingFromString("vFragmentDepth",T.Float),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");let n=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",n);let o="gl_FragColor";e.shaderLanguage===pe.WGSL&&(o="fragmentOutputs.color");let a=e._getShaderType(T.Vector4);if(t.connectedPoint)r.isConnected?e.compilationString+=`${o} = ${a}(${t.associatedVariableName}.rgb, ${r.associatedVariableName});
`:e.compilationString+=`${o}  = ${t.associatedVariableName};
`;else if(i.connectedPoint){let l="1.0";r.connectedPoint&&(l=r.associatedVariableName),i.connectedPoint.type===T.Float?e.compilationString+=`${o}  = ${a}(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${l});
`:e.compilationString+=`${o}  = ${a}(${i.associatedVariableName}, ${l});
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);return e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${o}  = toLinearSpace(${o});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${o}  = toGammaSpace(${o});
`,e.compilationString+=`#endif
`,(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e.compilationString+=`gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;
`),e.compilationString+=`#if defined(PREPASS)\r
`,e.compilationString+=`gl_FragData[0] = gl_FragColor;\r
`,e.compilationString+=`#endif\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};
`,e}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.useLogarithmicDepth=e.useLogarithmicDepth??!1}};v([de("Convert to gamma space",ue.Boolean,"PROPERTIES",{notifiers:{update:!0}})],bo.prototype,"convertToGammaSpace",void 0);v([de("Convert to linear space",ue.Boolean,"PROPERTIES",{notifiers:{update:!0}})],bo.prototype,"convertToLinearSpace",void 0);v([de("Use logarithmic depth",ue.Boolean,"PROPERTIES")],bo.prototype,"useLogarithmicDepth",void 0);P("BABYLON.FragmentOutputBlock",bo);var zr=function(s){return s[s.Uniform=0]="Uniform",s[s.Attribute=1]="Attribute",s[s.Varying=2]="Varying",s[s.Undefined=3]="Undefined",s}(zr||{});var qe=function(s){return s[s.World=1]="World",s[s.View=2]="View",s[s.Projection=3]="Projection",s[s.ViewProjection=4]="ViewProjection",s[s.WorldView=5]="WorldView",s[s.WorldViewProjection=6]="WorldViewProjection",s[s.CameraPosition=7]="CameraPosition",s[s.FogColor=8]="FogColor",s[s.DeltaTime=9]="DeltaTime",s[s.CameraParameters=10]="CameraParameters",s[s.MaterialAlpha=11]="MaterialAlpha",s}(qe||{});var ia=function(s){return s[s.None=0]="None",s[s.Time=1]="Time",s[s.RealTime=2]="RealTime",s[s.MouseInfo=3]="MouseInfo",s}(ia||{});var gH={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},yI={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},tB={particle_texturemask:!0},Be=class extends Z{get type(){if(this._type===T.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=T.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=T.Vector2,this._type;case"Vector3":return this._type=T.Vector3,this._type;case"Vector4":return this._type=T.Vector4,this._type;case"Color3":return this._type=T.Color3,this._type;case"Color4":return this._type=T.Color4,this._type;case"Matrix":return this._type=T.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=T.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=T.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=T.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=T.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case qe.World:case qe.WorldView:case qe.WorldViewProjection:case qe.View:case qe.ViewProjection:case qe.Projection:return this._type=T.Matrix,this._type;case qe.CameraPosition:return this._type=T.Vector3,this._type;case qe.FogColor:return this._type=T.Color3,this._type;case qe.DeltaTime:case qe.MaterialAlpha:return this._type=T.Float,this._type;case qe.CameraParameters:return this._type=T.Vector4,this._type}}return this._type}constructor(e,t=w.Vertex,i=T.AutoDetect){super(e,t,!1),this._mode=zr.Undefined,this._animationType=ia.None,this._prefix="",this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new U,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return this.isAttribute?!0:super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=zr.Attribute,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===T.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=zr.Uniform,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=zr.Uniform}get declarationVariableName(){return this._associatedVariableName}get associatedVariableName(){return this._prefix+this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===zr.Undefined}get isUniform(){return this._mode===zr.Uniform}set isUniform(e){this._mode=e?zr.Uniform:zr.Undefined,this.associatedVariableName=""}get isAttribute(){return this._mode===zr.Attribute}set isAttribute(e){this._mode=e?zr.Attribute:zr.Undefined,this.associatedVariableName=""}get isVarying(){return this._mode===zr.Varying}set isVarying(e){this._mode=e?zr.Varying:zr.Undefined,this.associatedVariableName=""}get isSystemValue(){return this._systemValue!=null}get systemValue(){return this._systemValue}set systemValue(e){this._mode=zr.Uniform,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case ia.Time:{this.type===T.Float&&(this.value+=e.getAnimationRatio()*.01);break}case ia.RealTime:{this.type===T.Float&&(this.value=(Mi.Now-e.getEngine().startTime)/1e3);break}case ia.MouseInfo:{if(this.type===T.Vector4){let t=e._inputManager._originMouseEvent;if(t){let i=t.offsetX,r=t.offsetY,n=t.buttons&1?1:0,o=t.buttons&2?1:0;this.value=new De(i,r,n,o)}else this.value=new De(0,0,0,0)}break}}}_emitDefine(e){return e[0]==="!"?`#ifndef ${e.substring(1)}
`:`#ifdef ${e}
`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case T.Float:this.value=0;break;case T.Vector2:this.value=j.Zero();break;case T.Vector3:this.value=p.Zero();break;case T.Vector4:this.value=De.Zero();break;case T.Color3:this.value=X.White();break;case T.Color4:this.value=new oe(1,1,1,1);break;case T.Matrix:this.value=N.Identity();break}}_emitConstant(e){switch(this.type){case T.Float:return`${e._emitFloat(this.value)}`;case T.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case T.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case T.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case T.Color3:return gt.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&gt.Color3[0].toGammaSpaceToRef(gt.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&gt.Color3[0].toLinearSpaceToRef(gt.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${gt.Color3[0].r}, ${gt.Color3[0].g}, ${gt.Color3[0].b})`;case T.Color4:return gt.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&gt.Color4[0].toGammaSpaceToRef(gt.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&gt.Color4[0].toLinearSpaceToRef(gt.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${gt.Color4[0].r}, ${gt.Color4[0].g}, ${gt.Color4[0].b}, ${gt.Color4[0].a})`}return""}get _noContextSwitch(){return yI[this.name]}_emit(e,t){if(this.isUniform){if(this._associatedVariableName||(this._associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=e._declareOutput(this.output,!0)+` = ${this._emitConstant(e)};
`;return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t));let i=e._getShaderType(this.type);e.shaderLanguage===pe.WGSL?(e._uniformDeclaration+=`uniform ${this._associatedVariableName}: ${i};
`,this._prefix="uniforms."):e._uniformDeclaration+=`uniform ${i} ${this.associatedVariableName};
`,t&&(e._uniformDeclaration+=`#endif
`);let r=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case qe.WorldView:r.needWorldViewMatrix=!0;break;case qe.WorldViewProjection:r.needWorldViewProjectionMatrix=!0;break}else this._animationType!==ia.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=gH[this.name]??this.name,this.target===w.Vertex&&e._vertexState){yI[this.name]?tB[this.name]?(e._emitUniformFromString(this.associatedVariableName,this.type,t),e.shaderLanguage===pe.WGSL&&(this._prefix="vertexInputs.")):e._emitVaryingFromString(this.associatedVariableName,this.type,t):this._emit(e._vertexState,t);return}if(e.attributes.indexOf(this.associatedVariableName)!==-1)return;e.attributes.push(this.associatedVariableName),yI[this.name]?tB[this.name]?(this._prefix="",e._emitUniformFromString(this.associatedVariableName,this.type,t),e.shaderLanguage===pe.WGSL&&(this._prefix="uniforms.")):(this._prefix="",e._emitVaryingFromString(this.associatedVariableName,this.type,t),e.shaderLanguage===pe.WGSL&&(this._prefix="fragmentInputs.")):(t&&(e._attributeDeclaration+=this._emitDefine(t)),e.shaderLanguage===pe.WGSL?(this._prefix="",e._attributeDeclaration+=`attribute ${this.associatedVariableName}: ${e._getShaderType(this.type)};
`,this._prefix="vertexInputs."):e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.associatedVariableName};
`,t&&(e._attributeDeclaration+=`#endif
`))}}_transmitWorld(e,t,i,r){if(!this._systemValue)return;let n=this._associatedVariableName;switch(this._systemValue){case qe.World:e.setMatrix(n,t);break;case qe.WorldView:e.setMatrix(n,i);break;case qe.WorldViewProjection:e.setMatrix(n,r);break}}_transmit(e,t,i){if(this.isAttribute)return;let r=this._associatedVariableName;if(this._systemValue){switch(this._systemValue){case qe.World:case qe.WorldView:case qe.WorldViewProjection:return;case qe.View:e.setMatrix(r,t.getViewMatrix());break;case qe.Projection:e.setMatrix(r,t.getProjectionMatrix());break;case qe.ViewProjection:e.setMatrix(r,t.getTransformMatrix());break;case qe.CameraPosition:t.bindEyePosition(e,r,!0);break;case qe.FogColor:e.setColor3(r,t.fogColor);break;case qe.DeltaTime:e.setFloat(r,t.deltaTime/1e3);break;case qe.CameraParameters:t.activeCamera&&e.setFloat4(r,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case qe.MaterialAlpha:e.setFloat(r,i.alpha);break}return}let n=this._valueCallback?this._valueCallback():this._storedValue;if(n!==null)switch(this.type){case T.Float:e.setFloat(r,n);break;case T.Int:e.setInt(r,n);break;case T.Color3:gt.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&gt.Color3[0].toGammaSpaceToRef(gt.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&gt.Color3[0].toLinearSpaceToRef(gt.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(r,gt.Color3[0]);break;case T.Color4:gt.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&gt.Color4[0].toGammaSpaceToRef(gt.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&gt.Color4[0].toLinearSpaceToRef(gt.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(r,gt.Color4[0]);break;case T.Vector2:e.setVector2(r,n);break;case T.Vector3:e.setVector3(r,n);break;case T.Vector4:e.setVector4(r,n);break;case T.Matrix:e.setMatrix(r,n);break}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){let e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");
`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${qe[this._systemValue]});
`;if(this.isUniform){let t=[],i="";switch(this.type){case T.Float:i=`${this.value}`;break;case T.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case T.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case T.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case T.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case T.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case T.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`;break}return t.push(`${e}.value = ${i}`),this.type===T.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${ia[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(`;
`)}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){let e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===zr.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.name==="tangent"&&e.mode===zr.Attribute&&e.type===T.Vector3&&(this._type=T.Vector4),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{let r=Et(e.valueType);r&&(this._storedValue=r.FromArray(e.value))}}};P("BABYLON.InputBlock",Be);var qp=class extends Z{constructor(e){super(e,w.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",T.AutoDetect,!1,w.VertexAndFragment),this.registerOutput("rgba",T.Color4,w.Neutral),this.registerOutput("rgb",T.Color3,w.Neutral),this.registerOutput("r",T.Float,w.Neutral),this.registerOutput("g",T.Float,w.Neutral),this.registerOutput("b",T.Float,w.Neutral),this.registerOutput("a",T.Float,w.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Vector2|T.Vector3|T.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName(this._samplerName)}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?w.VertexAndFragment:w.Fragment:w.VertexAndFragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){let t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,T.Vector2)),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,T.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(let i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name,!0)}}_writeTextureRead(e,t=!1){let i=this.uv;if(t){if(e.target===w.Fragment)return;let n=e.shaderLanguage===pe.GLSL?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,o=e.shaderLanguage===pe.GLSL?"":", 0";e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,T.Vector4)} = ${n} ${i.associatedVariableName}${o});
`;return}let r=e.shaderLanguage===pe.GLSL?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;if(this.uv.ownerBlock.target===w.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,T.Vector4)} = ${r} ${i.associatedVariableName});
`;return}e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,T.Vector4)} = ${r} ${this._mainUVName});
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===w.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}if(this.uv.ownerBlock.target===w.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==w.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!this._outputs.some(i=>i.isConnectedInFragmentShader))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");let t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(let i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=z.Parse(e.texture,t,i))}};P("BABYLON.CurrentScreenBlock",qp);var Qp=class extends Z{constructor(e){super(e,w.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",T.AutoDetect,!1,w.VertexAndFragment),this.registerOutput("rgba",T.Color4,w.Neutral),this.registerOutput("rgb",T.Color3,w.Neutral),this.registerOutput("r",T.Float,w.Neutral),this.registerOutput("g",T.Float,w.Neutral),this.registerOutput("b",T.Float,w.Neutral),this.registerOutput("a",T.Float,w.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Vector2|T.Vector3|T.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="particle_uv"&&t(r));i||(i=new Be("uv"),i.setAsAttribute("particle_uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_buildBlock(e){if(super._buildBlock(e),e.target===w.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");let t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,T.Vector4)} = ${e._generateTextureSample(this.uv.associatedVariableName,this._samplerName)};
`;for(let i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=z.Parse(e.texture,t,i))}};P("BABYLON.ParticleTextureBlock",Qp);var Kp=class extends Z{constructor(e){super(e,w.Fragment),this._isUnique=!0,this.registerInput("color",T.Color4,!1,w.Fragment),this.registerOutput("rampColor",T.Color4,w.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor")}_buildBlock(e){if(super._buildBlock(e),e.target!==w.Vertex)return e._emit2DSampler("rampSampler","RAMPGRADIENT"),e._emitVaryingFromString("remapRanges",T.Vector4,"RAMPGRADIENT"),e.compilationString+=`
            #ifdef RAMPGRADIENT
                ${e._declareLocalVar("baseColor",T.Vector4)} = ${this.color.associatedVariableName};
                ${e._declareLocalVar("alpha",T.Float)} = ${this.color.associatedVariableName}.a;

                ${e._declareLocalVar("remappedColorIndex",T.Float)} = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);

                ${e._declareLocalVar("rampColor",T.Vector4)} = ${e._generateTextureSample("vec2(1.0 - remappedColorIndex, 0.)","rampSampler")};

                // Remapped alpha
                ${e._declareOutput(this.rampColor)} = vec4${e.fSuffix}(baseColor.rgb * rampColor.rgb, clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0));
            #else
                ${e._declareOutput(this.rampColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}};P("BABYLON.ParticleRampGradientBlock",Kp);var Zp=class extends Z{constructor(e){super(e,w.Fragment),this._isUnique=!0,this.registerInput("color",T.Color4,!1,w.Fragment),this.registerInput("alphaTexture",T.Float,!1,w.Fragment),this.registerInput("alphaColor",T.Float,!1,w.Fragment),this.registerOutput("blendColor",T.Color4,w.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==w.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                ${e._declareOutput(this.blendColor)};
                ${e._declareLocalVar("sourceAlpha",T.Float)}  = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};
                ${this.blendColor.associatedVariableName} = vec4${e.fSuffix}(${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha), ${this.color.associatedVariableName}.a);
            #else
                ${e._declareOutput(this.blendColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}};P("BABYLON.ParticleBlendMultiplyBlock",Zp);var ps=class{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;let i=this._mesh.getScene();for(let r=0;r<i.meshes.length;r++){let n=i.meshes[r];if(!n.material){!this._mesh.material&&n.computeBonesUsingShaders&&n.numBoneInfluencers>0&&(n.computeBonesUsingShaders=!1);continue}if(!(!n.computeBonesUsingShaders||n.numBoneInfluencers===0)){if(n.material.getEffect()===t)n.computeBonesUsingShaders=!1;else if(n.subMeshes){for(let o of n.subMeshes)if(o.effect===t){n.computeBonesUsingShaders=!1;break}}}}}else{let i=this._defines[this._currentRank];if(i)for(let r=0;r<i.length;r++)e=e.replace("#define "+i[r],"");this._currentRank++}return e}};var _H="postprocessVertexShader",xH=`attribute vec2 position;uniform vec2 scale;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[_H]=xH;var Qa=class{get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get is3D(){return this.depth>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get depth(){return this._size.depth||0}get texture(){return this._textures?.[0]??null}get textures(){return this._textures}get faceIndices(){return this._faceIndices}get layerIndices(){return this._layerIndices}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;let r=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,r}constructor(e,t,i,r,n){this._textures=null,this._faceIndices=null,this._layerIndices=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=r,this._depthStencilTexture=null,this.label=n}setTextures(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]!==e&&(this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e)}setLayerAndFaceIndices(e,t){this._layerIndices=e,this._faceIndices=t}setLayerAndFaceIndex(e=0,t,i){this._layerIndices||(this._layerIndices=[]),this._faceIndices||(this._faceIndices=[]),t!==void 0&&t>=0&&(this._layerIndices[e]=t),i!==void 0&&i>=0&&(this._faceIndices[e]=i)}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,n=14,o){return this._depthStencilTexture?.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTextureLabel=o,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:r,depthTextureFormat:n,label:o},this),this._depthStencilTexture}_shareDepth(e){this.shareDepth(e)}shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,e._depthStencilTextureWithStencil=this._depthStencilTextureWithStencil,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){let e=null;if(this._isMulti){let t=this.textures;if(t&&t.length>0){let i=!1,r=t.length,n=-1,o=t[t.length-1]._source;(o===ke.Depth||o===ke.DepthStencil)&&(i=!0,n=t[t.length-1].format,r--);let a=[],l=[],c=[],h=[],u=[],d=[],f=[],m={};for(let x=0;x<r;++x){let b=t[x];a.push(b.samplingMode),l.push(b.type),c.push(b.format),m[b.uniqueId]!==void 0?(h.push(-1),f.push(0)):(m[b.uniqueId]=x,b.is2DArray?(h.push(35866),f.push(b.depth)):b.isCube?(h.push(34067),f.push(0)):b.is3D?(h.push(32879),f.push(b.depth)):(h.push(3553),f.push(0))),this._faceIndices&&u.push(this._faceIndices[x]??0),this._layerIndices&&d.push(this._layerIndices[x]??0)}let g={samplingModes:a,generateMipMaps:t[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:i,depthTextureFormat:n,types:l,formats:c,textureCount:r,targetTypes:h,faceIndex:u,layerIndex:d,layerCounts:f,label:this.label},_={width:this.width,height:this.height,depth:this.depth};e=this._engine.createMultipleRenderTarget(_,g);for(let x=0;x<r;++x){if(h[x]!==-1)continue;let b=m[t[x].uniqueId];e.setTexture(e.textures[b],x)}}}else{let t={};if(t.generateDepthBuffer=this._generateDepthBuffer,t.generateMipMaps=this.texture?.generateMipMaps??!1,t.generateStencilBuffer=this._generateStencilBuffer,t.samplingMode=this.texture?.samplingMode,t.type=this.texture?.type,t.format=this.texture?.format,t.noColorAttachment=!this._textures,t.label=this.label,this.isCube)e=this._engine.createRenderTargetCubeTexture(this.width,t);else{let i={width:this.width,height:this.height,layers:this.is2DArray||this.is3D?this.texture?.depth:void 0};e=this._engine.createRenderTargetTexture(i,t)}e.texture&&(e.texture.isReady=!0)}return e}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){let e=this._cloneRenderTargetWrapper();if(e){if(this._depthStencilTexture){let t=this._depthStencilTexture.samplingMode,i=this._depthStencilTexture.format,r=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,r,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples,i,this._depthStencilTextureLabel)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){if(this._textures)for(let e=0;e<this._textures?.length;++e)this._textures[e].dispose();this._textures=null}dispose(e=!1){e||(this._depthStencilTexture?.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}};var Qx=class extends Qa{constructor(e,t,i,r,n){super(e,t,i,r),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._disposeOnlyFramebuffers=!1,this._currentLOD=0,this._context=n}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}createDepthStencilTexture(e=0,t=!0,i=!1,r=1,n=14,o){if(this._depthStencilBuffer){let a=this._engine,l=a._currentFramebuffer,c=this._context;a._bindUnboundFramebuffer(this._framebuffer),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_STENCIL_ATTACHMENT,c.RENDERBUFFER,null),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,null),c.framebufferRenderbuffer(c.FRAMEBUFFER,c.STENCIL_ATTACHMENT,c.RENDERBUFFER,null),a._bindUnboundFramebuffer(l),c.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null}return super.createDepthStencilTexture(e,t,i,r,n,o)}shareDepth(e){super.shareDepth(e);let t=this._context,i=this._depthStencilBuffer,r=e._MSAAFramebuffer||e._framebuffer,n=this._engine;e._depthStencilBuffer&&e._depthStencilBuffer!==i&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=i;let o=e._generateStencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;n._bindUnboundFramebuffer(r),t.framebufferRenderbuffer(t.FRAMEBUFFER,o,t.RENDERBUFFER,i),n._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i,r=0){if(!e._hardwareTexture)return;let n=this._framebuffer,o=this._engine,a=o._currentFramebuffer;if(o._bindUnboundFramebuffer(n),o.webGLVersion>1){let l=this._context,c=l["COLOR_ATTACHMENT"+t];e.is2DArray||e.is3D?(i=i??this.layerIndices?.[t]??0,l.framebufferTextureLayer(l.FRAMEBUFFER,c,e._hardwareTexture.underlyingResource,r,i)):e.isCube?(i=i??this.faceIndices?.[t]??0,l.framebufferTexture2D(l.FRAMEBUFFER,c,l.TEXTURE_CUBE_MAP_POSITIVE_X+i,e._hardwareTexture.underlyingResource,r)):l.framebufferTexture2D(l.FRAMEBUFFER,c,l.TEXTURE_2D,e._hardwareTexture.underlyingResource,r)}else{let l=this._context,c=l["COLOR_ATTACHMENT"+t+"_WEBGL"],h=i!==void 0?l.TEXTURE_CUBE_MAP_POSITIVE_X+i:l.TEXTURE_2D;l.framebufferTexture2D(l.FRAMEBUFFER,c,h,e._hardwareTexture.underlyingResource,r)}o._bindUnboundFramebuffer(a)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}setLayerAndFaceIndices(e,t){if(super.setLayerAndFaceIndices(e,t),!this.textures||!this.layerIndices||!this.faceIndices)return;let i=this._attachments?.length??this.textures.length;for(let r=0;r<i;r++){let n=this.textures[r];n&&(n.is2DArray||n.is3D?this._bindTextureRenderTarget(n,r,this.layerIndices[r]):n.isCube?this._bindTextureRenderTarget(n,r,this.faceIndices[r]):this._bindTextureRenderTarget(n,r))}}setLayerAndFaceIndex(e=0,t,i){if(super.setLayerAndFaceIndex(e,t,i),!this.textures||!this.layerIndices||!this.faceIndices)return;let r=this.textures[e];r.is2DArray||r.is3D?this._bindTextureRenderTarget(this.textures[e],e,this.layerIndices[e]):r.isCube&&this._bindTextureRenderTarget(this.textures[e],e,this.faceIndices[e])}dispose(e=this._disposeOnlyFramebuffers){let t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}};at.prototype._createHardwareRenderTargetWrapper=function(s,e,t){let i=new Qx(s,e,t,this,this._gl);return this._renderTargetWrapperCache.push(i),i};at.prototype.createRenderTargetTexture=function(s,e){let t=this._createHardwareRenderTargetWrapper(!1,!1,s),i=!0,r=!1,n=!1,o,a=1,l;e!==void 0&&typeof e=="object"&&(i=e.generateDepthBuffer??!0,r=!!e.generateStencilBuffer,n=!!e.noColorAttachment,o=e.colorAttachment,a=e.samples??1,l=e.label);let c=o||(n?null:this._createInternalTexture(s,e,!0,ke.RenderTarget)),h=s.width||s,u=s.height||s,d=this._currentFramebuffer,f=this._gl,m=f.createFramebuffer();return this._bindUnboundFramebuffer(m),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(r,i,h,u),c&&!c.is2DArray&&!c.is3D&&f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,c._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(d),t.label=l??"RenderTargetWrapper",t._framebuffer=m,t._generateDepthBuffer=i,t._generateStencilBuffer=r,t.setTextures(c),this.updateRenderTargetTextureSampleCount(t,a),t};at.prototype._createDepthStencilTexture=function(s,e){let t=this._gl,i=s.layers||0,r=s.depth||0,n=t.TEXTURE_2D;i!==0?n=t.TEXTURE_2D_ARRAY:r!==0&&(n=t.TEXTURE_3D);let o=new Je(this,ke.DepthStencil);if(o.label=e.label,!this._caps.depthTextureExtension)return F.Error("Depth texture is not supported by your browser or hardware."),o;let a=ie({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e);if(this._bindTextureDirectly(n,o,!0),this._setupDepthStencilTexture(o,s,a.generateStencil,a.comparisonFunction===0?!1:a.bilinearFiltering,a.comparisonFunction,a.samples),a.depthTextureFormat!==void 0){if(a.depthTextureFormat!==15&&a.depthTextureFormat!==16&&a.depthTextureFormat!==17&&a.depthTextureFormat!==13&&a.depthTextureFormat!==14&&a.depthTextureFormat!==18)return F.Error("Depth texture format is not supported."),o;o.format=a.depthTextureFormat}else o.format=a.generateStencil?13:16;let l=o.format===17||o.format===13||o.format===18,c=t.UNSIGNED_INT;o.format===15?c=t.UNSIGNED_SHORT:o.format===17||o.format===13?c=t.UNSIGNED_INT_24_8:o.format===14?c=t.FLOAT:o.format===18&&(c=t.FLOAT_32_UNSIGNED_INT_24_8_REV);let h=l?t.DEPTH_STENCIL:t.DEPTH_COMPONENT,u=h;return this.webGLVersion>1&&(o.format===15?u=t.DEPTH_COMPONENT16:o.format===16?u=t.DEPTH_COMPONENT24:o.format===17||o.format===13?u=t.DEPTH24_STENCIL8:o.format===14?u=t.DEPTH_COMPONENT32F:o.format===18&&(u=t.DEPTH32F_STENCIL8)),o.is2DArray?t.texImage3D(n,0,u,o.width,o.height,i,0,h,c,null):o.is3D?t.texImage3D(n,0,u,o.width,o.height,r,0,h,c,null):t.texImage2D(n,0,u,o.width,o.height,0,h,c,null),this._bindTextureDirectly(n,null),this._internalTexturesCache.push(o),o};at.prototype.updateRenderTargetTextureSampleCount=function(s,e){if(this.webGLVersion<2||!s||!s.texture)return 1;if(s.samples===e)return e;let t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),s._depthStencilBuffer&&(t.deleteRenderbuffer(s._depthStencilBuffer),s._depthStencilBuffer=null),s._MSAAFramebuffer&&(t.deleteFramebuffer(s._MSAAFramebuffer),s._MSAAFramebuffer=null);let i=s.texture._hardwareTexture;if(i.releaseMSAARenderBuffers(),e>1&&typeof t.renderbufferStorageMultisample=="function"){let r=t.createFramebuffer();if(!r)throw new Error("Unable to create multi sampled framebuffer");s._MSAAFramebuffer=r,this._bindUnboundFramebuffer(s._MSAAFramebuffer);let n=this._createRenderBuffer(s.texture.width,s.texture.height,e,-1,this._getRGBABufferInternalSizedFormat(s.texture.type,s.texture.format,s.texture._useSRGBBuffer),t.COLOR_ATTACHMENT0,!1);if(!n)throw new Error("Unable to create multi sampled framebuffer");i.addMSAARenderBuffer(n)}else this._bindUnboundFramebuffer(s._framebuffer);return s.texture.samples=e,s._samples=e,s._depthStencilBuffer=this._setupFramebufferDepthAttachments(s._generateStencilBuffer,s._generateDepthBuffer,s.texture.width,s.texture.height,e),this._bindUnboundFramebuffer(null),e};at.prototype._setupDepthStencilTexture=function(s,e,t,i,r,n=1){let o=e.width||e,a=e.height||e,l=e.layers||0,c=e.depth||0;s.baseWidth=o,s.baseHeight=a,s.width=o,s.height=a,s.is2DArray=l>0,s.depth=l||c,s.isReady=!0,s.samples=n,s.generateMipMaps=!1,s.samplingMode=i?2:1,s.type=0,s._comparisonFunction=r;let h=this._gl,u=this._getTextureTarget(s),d=this._getSamplingParameters(s.samplingMode,!1);h.texParameteri(u,h.TEXTURE_MAG_FILTER,d.mag),h.texParameteri(u,h.TEXTURE_MIN_FILTER,d.min),h.texParameteri(u,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(u,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),this.webGLVersion>1&&(r===0?(h.texParameteri(u,h.TEXTURE_COMPARE_FUNC,515),h.texParameteri(u,h.TEXTURE_COMPARE_MODE,h.NONE)):(h.texParameteri(u,h.TEXTURE_COMPARE_FUNC,r),h.texParameteri(u,h.TEXTURE_COMPARE_MODE,h.COMPARE_REF_TO_TEXTURE)))};Se.prototype.setTextureFromPostProcess=function(s,e,t){let i=null;e&&(e._forcedOutputTexture?i=e._forcedOutputTexture:e._textures.data[e._currentRenderTextureInd]&&(i=e._textures.data[e._currentRenderTextureInd])),this._bindTexture(s,i?.texture??null,t)};Se.prototype.setTextureFromPostProcessOutput=function(s,e,t){this._bindTexture(s,e?._outputTexture?.texture??null,t)};$t.prototype.setTextureFromPostProcess=function(s,e){this._engine.setTextureFromPostProcess(this._samplers[s],e,s)};$t.prototype.setTextureFromPostProcessOutput=function(s,e){this._engine.setTextureFromPostProcessOutput(this._samplers[s],e,s)};var ve=class s{static RegisterShaderCodeProcessing(e,t){if(!t){delete s._CustomShaderCodeProcessing[e??""];return}s._CustomShaderCodeProcessing[e??""]=t}static _GetShaderCodeProcessing(e){return s._CustomShaderCodeProcessing[e]??s._CustomShaderCodeProcessing[""]}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.setSamples(this._samples)})}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}constructor(e,t,i,r,n,o,a=1,l,c,h=null,u=0,d="postprocess",f,m=!1,g=5,_=pe.GLSL){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.forceAutoClearInAlphaMode=!1,this.alphaMode=0,this.animations=[],this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new _i(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new j(1,1),this._texelSize=j.Zero(),this.onActivateObservable=new U,this.onSizeChangedObservable=new U,this.onApplyObservable=new U,this.onBeforeRenderObservable=new U,this.onAfterRenderObservable=new U,this.name=e;let x=1,b=null;if(i&&!Array.isArray(i)){let C=i;i=C.uniforms??null,r=C.samplers??null,x=C.size??1,o=C.camera??null,a=C.samplingMode??1,l=C.engine,c=C.reusable,h=C.defines??null,u=C.textureType??0,d=C.vertexUrl??"postprocess",f=C.indexParameters,m=C.blockCompilation??!1,g=C.textureFormat??5,_=C.shaderLanguage??pe.GLSL,b=C.uniformBuffers??null}else n&&(typeof n=="number"?x=n:x={width:n.width,height:n.height});o!=null?(this._camera=o,this._scene=o.getScene(),o.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=x,this.renderTargetSamplingMode=a||1,this._reusable=c||!1,this._textureType=u,this._textureFormat=g,this._shaderLanguage=_,this._samplers=r||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=d,this._parameters=i||[],this._parameters.push("scale"),this._uniformBuffers=b||[],this._indexParameters=f,this._drawWrapper=new Xt(this._engine),m||this.updateEffect(h)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new _i(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,r,n,o,a,l){let c=s._GetShaderCodeProcessing(this.name);if(c?.defineCustomBindings){let h=t?.slice()??[];h.push(...this._parameters);let u=i?.slice()??[];u.push(...this._samplers),e=c.defineCustomBindings(this.name,e,h,u),t=h,i=u}this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:a??this._vertexUrl,fragment:l??this._fragmentUrl},{attributes:["position"],uniformsNames:t||this._parameters,uniformBuffersNames:this._uniformBuffers,samplers:i||this._samplers,defines:e!==null?e:"",fallbacks:null,onCompiled:n??null,onError:o??null,indexParameters:r||this._indexParameters,processCodeAfterIncludes:c?.processCodeAfterIncludes?(h,u)=>c.processCodeAfterIncludes(this.name,h,u):null,processFinalCode:c?.processFinalCode?(h,u)=>c.processFinalCode(this.name,h,u):null,shaderLanguage:this._shaderLanguage},this._engine)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let n=0;n<this._textureCache.length;n++)if(this._textureCache[n].texture.width===e.width&&this._textureCache[n].texture.height===e.height&&this._textureCache[n].postProcessChannel===i&&this._textureCache[n].texture._generateDepthBuffer===t.generateDepthBuffer&&this._textureCache[n].texture.samples===t.samples)return this._textureCache[n].texture;let r=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:r,postProcessChannel:i,lastUsedRenderId:-1}),r}_flushTextureCache(){let e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let i=!1;for(let r=0;r<this._textures.length;r++)if(this._textures.data[r]===this._textureCache[t].texture){i=!0;break}i||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}resize(e,t,i=null,r=!1,n=!1){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let o=null;if(i){for(let c=0;c<i._postProcesses.length;c++)if(i._postProcesses[c]!==null){o=i._postProcesses[c];break}}let a={width:this.width,height:this.height},l={generateMipMaps:r,generateDepthBuffer:n||o===this,generateStencilBuffer:(n||o===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat,samples:this._samples,label:"PostProcessRTT-"+this.name};this._textures.push(this._createRenderTargetTexture(a,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(a,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}_getTarget(){let e;if(this._shareOutputWithPostProcess)e=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)e=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{e=this.inputTexture;let t;for(let i=0;i<this._textureCache.length;i++)if(this._textureCache[i].texture===e){t=this._textureCache[i];break}t&&(t.lastUsedRenderId=this._renderId)}return e}activate(e,t=null,i){e=e||this._camera;let r=e.getScene(),n=r.getEngine(),o=n.getCaps().maxTextureSize,a=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0,l=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,c=this._options.width||a,h=this._options.height||l,u=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2,d=null;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){let f=n.currentViewport;f&&(c*=f.width,h*=f.height)}(u||this.alwaysForcePOT)&&(this._options.width||(c=n.needPOTTextures?Rr(c,o,this.scaleMode):c),this._options.height||(h=n.needPOTTextures?Rr(h,o,this.scaleMode):h)),(this.width!==c||this.height!==h||!(d=this._getTarget()))&&this.resize(c,h,e,u,i),this._textures.forEach(f=>{f.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(f,this.samples)}),this._flushTextureCache(),this._renderId++}return d||(d=this._getTarget()),this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(a/c,l/h),this._engine.bindFramebuffer(d,0,a,l,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(d,0,void 0,void 0,this.forceFullscreenViewport)),this._engine._debugInsertMarker?.(`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&(this.alphaMode===0||this.forceAutoClearInAlphaMode)&&this._engine.clear(this.clearColor?this.clearColor:r.clearColor,r._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),d}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){return this._drawWrapper.effect?.isReady()??!1}apply(){if(!this._drawWrapper.effect?.isReady())return null;this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);let e;return this._shareOutputWithPostProcess?e=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?e=this._forcedOutputTexture:e=this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",e?.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),s._GetShaderCodeProcessing(this.name)?.bindCustomBindings?.(this.name,this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._disposeTextures();let t;if(this._scene&&(t=this._scene.postProcesses.indexOf(this),t!==-1&&this._scene.postProcesses.splice(t,1)),this._parentContainer){let i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){let i=this._camera._getFirstPostProcess();i&&i.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){let e=ae.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){let e=this.serialize();e._engine=this._engine,e.cameraId=null;let t=s.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){let r=Et(e.customType);if(!r||!r._Parse)return null;let n=t?t.getCameraById(e.cameraId):null;return r._Parse(e,n,t,i)}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,i,r)}};ve._CustomShaderCodeProcessing={};v([I()],ve.prototype,"uniqueId",void 0);v([I()],ve.prototype,"name",void 0);v([I()],ve.prototype,"width",void 0);v([I()],ve.prototype,"height",void 0);v([I()],ve.prototype,"renderTargetSamplingMode",void 0);v([_u()],ve.prototype,"clearColor",void 0);v([I()],ve.prototype,"autoClear",void 0);v([I()],ve.prototype,"forceAutoClearInAlphaMode",void 0);v([I()],ve.prototype,"alphaMode",void 0);v([I()],ve.prototype,"alphaConstants",void 0);v([I()],ve.prototype,"enablePixelPerfectMode",void 0);v([I()],ve.prototype,"forceFullscreenViewport",void 0);v([I()],ve.prototype,"scaleMode",void 0);v([I()],ve.prototype,"alwaysForcePOT",void 0);v([I("samples")],ve.prototype,"_samples",void 0);v([I()],ve.prototype,"adaptScaleToCurrentViewport",void 0);P("BABYLON.PostProcess",ve);var Zc=class extends Z{constructor(e){super(e,w.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",T.Vector4,!0),this.registerInput("xyz ",T.Vector3,!0),this.registerInput("xy ",T.Vector2,!0),this.registerInput("zw ",T.Vector2,!0),this.registerInput("x",T.Float,!0),this.registerInput("y",T.Float,!0),this.registerInput("z",T.Float,!0),this.registerInput("w",T.Float,!0),this.registerOutput("xyzw",T.Vector4),this.registerOutput("xyz",T.Vector3),this.registerOutput("xy",T.Vector2),this.registerOutput("zw",T.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);let t=this.x,i=this.y,r=this.z,n=this.w,o=this.xyIn,a=this.zwIn,l=this.xyzIn,c=this.xyzwIn,h=this._outputs[0],u=this._outputs[1],d=this._outputs[2],f=this._outputs[3],m=e._getShaderType(T.Vector4),g=e._getShaderType(T.Vector3),_=e._getShaderType(T.Vector2);return c.isConnected?(h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${c.associatedVariableName}${this._buildSwizzle(4)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${c.associatedVariableName}${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${c.associatedVariableName}${this._buildSwizzle(2)};
`)):l.isConnected?(h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${m}(${l.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};
`)):o.isConnected?(h.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(h)+` = ${m}(${o.associatedVariableName}, ${a.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(h)+` = ${m}(${o.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${g}(${o.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};
`),f.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(f)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(f)+` = ${_}(${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(2)};
`)):(h.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(h)+` = ${m}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${a.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(h)+` = ${m}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${g}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),d.hasEndpoints&&(e.compilationString+=e._declareOutput(d)+` = ${_}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};
`),f.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(f)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(f)+` = ${_}(${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(2)};
`)),this}serialize(){let e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.xSwizzle=e.xSwizzle??"x",this.ySwizzle=e.ySwizzle??"y",this.zSwizzle=e.zSwizzle??"z",this.wSwizzle=e.wSwizzle??"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";
`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";
`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";
`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";
`,e}};P("BABYLON.VectorMergerBlock",Zc);var Jc=class extends Z{constructor(e){super(e,w.Neutral),this.sourceRange=new j(-1,1),this.targetRange=new j(0,1),this.registerInput("input",T.AutoDetect),this.registerInput("sourceMin",T.Float,!0),this.registerInput("sourceMax",T.Float,!0),this.registerInput("targetMin",T.Float,!0),this.registerInput("targetMax",T.Float,!0),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),n=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),o=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=e._declareOutput(t)+` = ${n} + (${this._inputs[0].associatedVariableName} - ${i}) * (${o} - ${n}) / (${r} - ${i});
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});
`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});
`,e}serialize(){let e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=j.FromArray(e.sourceRange),this.targetRange=j.FromArray(e.targetRange)}};v([de("From",ue.Vector2)],Jc.prototype,"sourceRange",void 0);v([de("To",ue.Vector2)],Jc.prototype,"targetRange",void 0);P("BABYLON.RemapBlock",Jc);var ra=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("left",T.AutoDetect),this.registerInput("right",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this.output._typeConnectionSource=this.left,this._linkConnectionTypes(0,1,!0),this.left.acceptedConnectionPointTypes.push(T.Float),this.right.acceptedConnectionPointTypes.push(T.Float),this._connectionObservers=[this.left.onTypeChangedObservable.add(()=>this._updateInputOutputTypes()),this.right.onTypeChangedObservable.add(()=>this._updateInputOutputTypes())]}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===T.Int||this.left.type===T.Float&&this.right.type!==T.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(let[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[T.Int,T.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===T.Int||t.type===T.Float)&&e.acceptedConnectionPointTypes.push(T.Vector2,T.Vector3,T.Vector4,T.Color3,T.Color4,T.Matrix))}dispose(){super.dispose(),this._connectionObservers.forEach(e=>e.remove()),this._connectionObservers.length=0}};var vd=class extends ra{constructor(e){super(e)}getClassName(){return"MultiplyBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};
`,this}};P("BABYLON.MultiplyBlock",vd);var ns=function(s){return s[s.Material=0]="Material",s[s.PostProcess=1]="PostProcess",s[s.Particle=2]="Particle",s[s.ProceduralTexture=3]="ProceduralTexture",s}(ns||{});var Kx=class extends Qt{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}};var Wr=(()=>{class s{get noiseTexture(){return this._noiseTexture}set noiseTexture(t){this._noiseTexture!==t&&(this._noiseTexture=t,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(t){this._isAnimationSheetEnabled!=t&&(this._isAnimationSheetEnabled=t,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(t){this._useLogarithmicDepth=t&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:p.Zero()}set direction1(t){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=t)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:p.Zero()}set direction2(t){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=t)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:p.Zero()}set minEmitBox(t){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=t)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:p.Zero()}set maxEmitBox(t){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=t)}get billboardMode(){return this._billboardMode}set billboardMode(t){this._billboardMode!==t&&(this._billboardMode=t,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(t){this._isBillboardBased!==t&&(this._isBillboardBased=t,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(t){this._attachImageProcessingConfiguration(t)}_attachImageProcessingConfiguration(t){t!==this._imageProcessingConfiguration&&(!t&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=t)}_reset(){}_removeGradientAndTexture(t,i,r){if(!i)return this;let n=0;for(let o of i){if(o.gradient===t){i.splice(n,1);break}n++}return r&&r.dispose(),this}constructor(t){this.animations=[],this.renderingGroupId=0,this.emitter=p.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this.applyFog=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new p(10,10,10),this.onAnimationEnd=null,this.blendMode=s.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new j(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new p(0,0,0),this._useLogarithmicDepth=!1,this.gravity=p.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new oe(1,1,1,1),this.color2=new oe(1,1,1,1),this.colorDead=new oe(0,0,0,1),this.textureMask=new oe(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new Kx,this.id=t,this.name=t}createPointEmitter(t,i){throw new Error("Method not implemented.")}createHemisphericEmitter(t=1,i=1){throw new Error("Method not implemented.")}createSphereEmitter(t=1,i=1){throw new Error("Method not implemented.")}createDirectedSphereEmitter(t=1,i=new p(0,1,0),r=new p(0,1,0)){throw new Error("Method not implemented.")}createCylinderEmitter(t=1,i=1,r=1,n=0){throw new Error("Method not implemented.")}createDirectedCylinderEmitter(t=1,i=1,r=1,n=new p(0,1,0),o=new p(0,1,0)){throw new Error("Method not implemented.")}createConeEmitter(t=1,i=Math.PI/4){throw new Error("Method not implemented.")}createDirectedConeEmitter(t=1,i=Math.PI/4,r=new p(0,1,0),n=new p(0,1,0)){throw new Error("Method not implemented.")}createBoxEmitter(t,i,r,n){throw new Error("Method not implemented.")}}return s.BLENDMODE_ONEONE=0,s.BLENDMODE_STANDARD=1,s.BLENDMODE_ADD=2,s.BLENDMODE_MULTIPLY=3,s.BLENDMODE_MULTIPLYADD=4,s})();P("BABYLON.BaseParticleSystem",Wr);var Jp=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("rgba",T.Color4,!0),this.registerInput("rgb ",T.Color3,!0),this.registerOutput("rgb",T.Color3),this.registerOutput("r",T.Float),this.registerOutput("g",T.Float),this.registerOutput("b",T.Float),this.registerOutput("a",T.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return e==="rgb "?"rgbIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e}_buildBlock(e){super._buildBlock(e);let t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;let i=this._outputs[0],r=this._outputs[1],n=this._outputs[2],o=this._outputs[3],a=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.rgb;
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.r;
`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t.associatedVariableName}.g;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.b;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.a;
`),this}};P("BABYLON.ColorSplitterBlock",Jp);at.prototype.createRenderTargetCubeTexture=function(s,e){let t=this._createHardwareRenderTargetWrapper(!1,!0,s),i=ie({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5},e);i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(i.type===1&&!this._caps.textureFloatLinearFiltering||i.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);let r=this._gl,n=new Je(this,ke.RenderTarget);this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,n,!0);let o=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);i.type===1&&!this._caps.textureFloat&&(i.type=0,F.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MAG_FILTER,o.mag),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_MIN_FILTER,o.min),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_CUBE_MAP,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE);for(let l=0;l<6;l++)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),s,s,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);let a=r.createFramebuffer();return this._bindUnboundFramebuffer(a),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,s,s),i.generateMipMaps&&r.generateMipmap(r.TEXTURE_CUBE_MAP),this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=a,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer,n.width=s,n.height=s,n.isReady=!0,n.isCube=!0,n.samples=1,n.generateMipMaps=i.generateMipMaps,n.samplingMode=i.samplingMode,n.type=i.type,n.format=i.format,this._internalTexturesCache.push(n),t.setTextures(n),t};at.prototype.setDepthStencilTexture=function(s,e,t,i){s!==void 0&&(e&&(this._boundUniforms[s]=e),!t||!t.depthStencilTexture?this._setTexture(s,null,void 0,void 0,i):this._setTexture(s,t,!1,!0,i))};var EI={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]},sa=class{constructor(e,t=EI){this._fullscreenViewport=new Dr(0,0,1,1);let i=t.positions??EI.positions,r=t.indices??EI.indices;this.engine=e,this._vertexBuffers={[y.PositionKind]:new y(e,i,y.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(r),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(r);for(let n in this._vertexBuffers)this._vertexBuffers[n]._rebuild()})}setViewport(e=this._fullscreenViewport){this.engine.setViewport(e)}bindBuffers(e){this.engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this.engine.setState(!0),this.engine.depthCullingState.depthTest=!1,this.engine.stencilState.stencilTest=!1,this.engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}saveStates(){this._savedStateDepthTest=this.engine.depthCullingState.depthTest,this._savedStateStencilTest=this.engine.stencilState.stencilTest}restoreStates(){this.engine.depthCullingState.depthTest=this._savedStateDepthTest,this.engine.stencilState.stencilTest=this._savedStateStencilTest}draw(){this.engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,t=null){if(!e.effect.isReady())return;this.saveStates(),this.setViewport();let i=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this.engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this.engine.unBindFramebuffer(i),this.restoreStates()}dispose(){let e=this._vertexBuffers[y.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[y.PositionKind]),this._indexBuffer&&this.engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this.engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}},os=class{get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}constructor(e){this.onApplyObservable=new U;let t,i=e.uniformNames||[];e.vertexShader?t={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(i.push("scale"),t={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)}));let r=e.defines?e.defines.join(`
`):"";this._drawWrapper=new Xt(e.engine),e.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=e.engine.createEffect(t,e.attributeNames||["position"],i,e.samplerNames,r,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage)):(this.effect=new $t(t,e.attributeNames||["position"],i,e.samplerNames,e.engine,r,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._prepareEffect()}))}dispose(e=!0){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),e&&this.effect.dispose()}};var iB="passPixelShader",rB=`varying vec2 vUV;uniform sampler2D textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=texture2D(textureSampler,vUV);}`;D.ShadersStore[iB]=rB;var AI={name:iB,shader:rB};var $n=class s{static _CreateDumpRenderer(){if(!s._DumpToolsEngine){let e,t=null,i={preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1};try{e=new OffscreenCanvas(100,100),t=new at(e,!1,i)}catch{e=document.createElement("canvas"),t=new at(e,!1,i)}me.Instances.pop(),me.OnEnginesDisposedObservable.add(o=>{t&&o!==t&&!t.isDisposed&&me.Instances.length===0&&s.Dispose()}),t.getCaps().parallelShaderCompile=void 0;let r=new sa(t),n=new os({engine:t,name:AI.name,fragmentShader:AI.shader,samplerNames:["textureSampler"]});s._DumpToolsEngine={canvas:e,engine:t,renderer:r,wrapper:n}}return s._DumpToolsEngine}static DumpFramebuffer(e,t,i,r,n="image/png",o,a){return $e(this,null,function*(){let l=yield i.readPixels(0,0,e,t),c=new Uint8Array(l.buffer);s.DumpData(e,t,c,r,n,o,!0,void 0,a)})}static DumpDataAsync(e,t,i,r="image/png",n,o=!1,a=!1,l){return new Promise(c=>{s.DumpData(e,t,i,h=>c(h),r,n,o,a,l)})}static DumpData(e,t,i,r,n="image/png",o,a=!1,l=!1,c){let h=s._CreateDumpRenderer();if(h.engine.setSize(e,t,!0),i instanceof Float32Array){let d=new Uint8Array(i.length),f=i.length;for(;f--;){let m=i[f];d[f]=Math.round(xe.Clamp(m)*255)}i=d}let u=h.engine.createRawTexture(i,e,t,5,!1,!a,1);h.renderer.setViewport(),h.renderer.applyEffectWrapper(h.wrapper),h.wrapper.effect._bindTexture("textureSampler",u),h.renderer.draw(),l?H.ToBlob(h.canvas,d=>{let f=new FileReader;f.onload=m=>{let g=m.target.result;r&&r(g)},f.readAsArrayBuffer(d)},n,c):H.EncodeScreenshotCanvasData(h.canvas,r,n,o,c),u.dispose()}static Dispose(){s._DumpToolsEngine&&(s._DumpToolsEngine.wrapper.dispose(),s._DumpToolsEngine.renderer.dispose(),s._DumpToolsEngine.engine.dispose()),s._DumpToolsEngine=null}},vH=()=>{H.DumpData=$n.DumpData,H.DumpDataAsync=$n.DumpDataAsync,H.DumpFramebuffer=$n.DumpFramebuffer};vH();$t.prototype.setDepthStencilTexture=function(s,e){this._engine.setDepthStencilTexture(this._samplers[s],this._uniforms[s],e,s)};var vt=(()=>{class s extends z{get renderList(){return this._renderList}set renderList(t){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),t&&(this._unObserveRenderList=bg(t,this._renderListHasChanged)),this._renderList=t}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(t){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(t)}set onBeforeRender(t){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(t)}set onAfterRender(t){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(t)}set onClear(t){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(t)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(t,i){let r;Array.isArray(t)?r=t:r=[t];for(let n=0;n<r.length;++n)for(let o=0;o<this._renderPassIds.length;++o)r[n].setMaterialForRenderPass(this._renderPassIds[o],i!==void 0?Array.isArray(i)?i[o]:i:void 0)}get isMulti(){return this._renderTarget?.isMulti??!1}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t))return;this._boundingBoxSize=t;let i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){return this._renderTarget?._depthStencilTexture??null}constructor(t,i,r,n=!1,o=!0,a=0,l=!1,c=z.TRILINEAR_SAMPLINGMODE,h=!0,u=!1,d=!1,f=5,m=!1,g,_,x=!1,b=!1){let C,R=!0;if(typeof n=="object"){let S=n;n=!!S.generateMipMaps,o=S.doNotChangeAspectRatio??!0,a=S.type??0,l=!!S.isCube,c=S.samplingMode??z.TRILINEAR_SAMPLINGMODE,h=S.generateDepthBuffer??!0,u=!!S.generateStencilBuffer,d=!!S.isMulti,f=S.format??5,m=!!S.delayAllocation,g=S.samples,_=S.creationFlags,x=!!S.noColorAttachment,b=!!S.useSRGBBuffer,C=S.colorAttachment,R=S.gammaSpace??R}if(super(null,r,!n,void 0,c,void 0,void 0,void 0,void 0,f),this._unObserveRenderList=null,this._renderListHasChanged=(S,A)=>{let L=this._renderList?this._renderList.length:0;(A===0&&L>0||L===0)&&this.getScene()?.meshes.forEach(G=>{G._markSubMeshesAsLightDirty()})},this.renderParticles=!0,this.renderSprites=!1,this.forceLayerMaskCheck=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new U,this.onAfterUnbindObservable=new U,this.onBeforeRenderObservable=new U,this.onAfterRenderObservable=new U,this.onClearObservable=new U,this.onResizeObservable=new U,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=p.Zero(),r=this.getScene(),!r)return;let E=this.getScene().getEngine();this._gammaSpace=R,this._coordinatesMode=z.PROJECTION_MODE,this.renderList=[],this.name=t,this.isRenderTarget=!0,this._initialSizeParameter=i,this._renderPassIds=[],this._isCubeData=l,this._processSizeParameter(i),this.renderPassId=this._renderPassIds[0],this._resizeObserver=E.onResizeObservable.add(()=>{}),this._generateMipMaps=!!n,this._doNotChangeAspectRatio=o,this._renderingManager=new Hc(r),this._renderingManager._useSceneAutoClearSetup=!0,!d&&(this._renderTargetOptions={generateMipMaps:n,type:a,format:this._format??void 0,samplingMode:this.samplingMode,generateDepthBuffer:h,generateStencilBuffer:u,samples:g,creationFlags:_,noColorAttachment:x,useSRGBBuffer:b,colorAttachment:C,label:this.name},this.samplingMode===z.NEAREST_SAMPLINGMODE&&(this.wrapU=z.CLAMP_ADDRESSMODE,this.wrapV=z.CLAMP_ADDRESSMODE),m||(l?(this._renderTarget=r.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=z.INVCUBIC_MODE,this._textureMatrix=N.Identity()):this._renderTarget=r.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,g!==void 0&&(this.samples=g)))}createDepthStencilTexture(t=0,i=!0,r=!1,n=1,o=14,a){this._renderTarget?.createDepthStencilTexture(t,i,r,n,o,a)}_releaseRenderPassId(){if(this._scene){let t=this._scene.getEngine();for(let i=0;i<this._renderPassIds.length;++i)t.releaseRenderPassId(this._renderPassIds[i])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();let t=this._scene.getEngine(),i=this._isCubeData?6:this.getRenderLayers()||1;for(let r=0;r<i;++r)this._renderPassIds[r]=t.createRenderPassId(`RenderTargetTexture - ${this.name}#${r}`)}_processSizeParameter(t,i=!0){if(t.ratio){this._sizeRatio=t.ratio;let r=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(r.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(r.getRenderHeight(),this._sizeRatio)}}else this._size=t;i&&this._createRenderPassId()}get samples(){return this._renderTarget?.samples??this._samples}set samples(t){this._renderTarget&&(this._samples=this._renderTarget.setSamples(t))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(t){this._refreshRate=t,this.resetRefreshCounter()}addPostProcess(t){if(!this._postProcessManager){let i=this.getScene();if(!i)return;this._postProcessManager=new $a(i),this._postProcesses=new Array}this._postProcesses.push(t),this._postProcesses[0].autoClear=!1}clearPostProcesses(t=!1){if(this._postProcesses){if(t)for(let i of this._postProcesses)i.dispose();this._postProcesses=[]}}removePostProcess(t){if(!this._postProcesses)return;let i=this._postProcesses.indexOf(t);i!==-1&&(this._postProcesses.splice(i,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){let t=this._size.layers;if(t)return t;let i=this._size.depth;return i||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(t){let i=Math.max(1,this.getRenderSize()*t);this.resize(i)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(t){let i=this.isCube;this._renderTarget?.dispose(),this._renderTarget=null;let r=this.getScene();r&&(this._processSizeParameter(t,!1),i?this._renderTarget=r.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=r.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(t=!1,i=!1){this._render(t,i)}isReadyForRendering(){return this._render(!1,!1,!0)}_render(t=!1,i=!1,r=!1){let n=this.getScene();if(!n)return r;let o=n.getEngine();if(this.useCameraPostProcesses!==void 0&&(t=this.useCameraPostProcesses),this._waitingRenderList){if(!this.renderListPredicate){this.renderList=[];for(let u=0;u<this._waitingRenderList.length;u++){let d=this._waitingRenderList[u],f=n.getMeshById(d);f&&this.renderList.push(f)}}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];let u=this.getScene();if(!u)return r;let d=u.meshes;for(let f=0;f<d.length;f++){let m=d[f];this.renderListPredicate(m)&&this.renderList.push(m)}}let a=o.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);let l=this.activeCamera??n.activeCamera,c=n.activeCamera;l&&(l!==n.activeCamera&&(n.setTransformMatrix(l.getViewMatrix(),l.getProjectionMatrix(!0)),n.activeCamera=l),o.setViewport(l.rigParent?l.rigParent.viewport:l.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let h=r;if(r){n.getViewMatrix()||n.updateTransformMatrix();let u=this.is2DArray||this.is3D?this.getRenderLayers():this.isCube?6:1;for(let d=0;d<u&&h;d++){let f=null,m=this.renderList?this.renderList:n.getActiveMeshes().data,g=this.renderList?this.renderList.length:n.getActiveMeshes().length;o.currentRenderPassId=this._renderPassIds[d],this.onBeforeRenderObservable.notifyObservers(d),this.getCustomRenderList&&(f=this.getCustomRenderList(d,m,g)),f||(f=m),this._doNotChangeAspectRatio||n.updateTransformMatrix(!0);for(let _=0;_<f.length&&h;++_){let x=f[_];if(!(!x.isEnabled()||x.isBlocked||!x.isVisible||!x.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(x,this.refreshRate,r)){h=!1;continue}}else if(!x.isReady(!0)){h=!1;continue}}}this.onAfterRenderObservable.notifyObservers(d),(this.is2DArray||this.is3D||this.isCube)&&(n.incrementRenderId(),n.resetCachedMaterial())}}else if((this.is2DArray||this.is3D)&&!this.isMulti)for(let u=0;u<this.getRenderLayers();u++)this._renderToTarget(0,t,i,u,l),n.incrementRenderId(),n.resetCachedMaterial();else if(this.isCube&&!this.isMulti)for(let u=0;u<6;u++)this._renderToTarget(u,t,i,void 0,l),n.incrementRenderId(),n.resetCachedMaterial();else this._renderToTarget(0,t,i,void 0,l);return this.onAfterUnbindObservable.notifyObservers(this),o.currentRenderPassId=a,c&&(n.activeCamera=c,this.activeCamera&&this.activeCamera!==n.activeCamera&&n.setTransformMatrix(n.activeCamera.getViewMatrix(),n.activeCamera.getProjectionMatrix(!0)),o.setViewport(n.activeCamera.viewport)),n.resetCachedMaterial(),h}_bestReflectionRenderTargetDimension(t,i){let n=t*i,o=GO(n+128*128/(128+n));return Math.min(zO(t),o)}_prepareRenderingManager(t,i,r,n){let o=this.getScene();if(!o)return;this._renderingManager.reset();let a=o.getRenderId();for(let l=0;l<i;l++){let c=t[l];if(c&&!c.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(c,this.refreshRate,!1)){this.resetRefreshCounter();continue}}else if(!c.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!c._internalAbstractMeshDataInfo._currentLODIsUpToDate&&o.activeCamera&&(c._internalAbstractMeshDataInfo._currentLOD=o.customLODSelector?o.customLODSelector(c,this.activeCamera||o.activeCamera):c.getLOD(this.activeCamera||o.activeCamera),c._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!c._internalAbstractMeshDataInfo._currentLOD)continue;let h=c._internalAbstractMeshDataInfo._currentLOD;h._preActivateForIntermediateRendering(a);let u;if(n&&r?u=(c.layerMask&r.layerMask)===0:u=!1,c.isEnabled()&&c.isVisible&&c.subMeshes&&!u&&(h!==c&&h._activate(a,!0),c._activate(a,!0)&&c.subMeshes.length)){c.isAnInstance?c._internalAbstractMeshDataInfo._actAsRegularMesh&&(h=c):h._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,h._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let d=0;d<h.subMeshes.length;d++){let f=h.subMeshes[d];this._renderingManager.dispatch(f,h)}}}}for(let l=0;l<o.particleSystems.length;l++){let c=o.particleSystems[l],h=c.emitter;!c.isStarted()||!h||h.position&&!h.isEnabled()||this._renderingManager.dispatchParticles(c)}}_bindFrameBuffer(t=0,i=0){let r=this.getScene();if(!r)return;let n=r.getEngine();this._renderTarget&&n.bindFramebuffer(this._renderTarget,this.isCube?t:void 0,void 0,void 0,this.ignoreCameraViewport,0,i)}_unbindFrameBuffer(t,i){this._renderTarget&&t.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(i)})}_prepareFrame(t,i,r,n){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!n||!t.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(i,r)}_renderToTarget(t,i,r,n=0,o=null){let a=this.getScene();if(!a)return;let l=a.getEngine();if(l._debugPushGroup?.(`render to face #${t} layer #${n}`,1),this._prepareFrame(a,t,n,i),this.is2DArray||this.is3D?(l.currentRenderPassId=this._renderPassIds[n],this.onBeforeRenderObservable.notifyObservers(n)):(l.currentRenderPassId=this._renderPassIds[t],this.onBeforeRenderObservable.notifyObservers(t)),l.snapshotRendering&&l.snapshotRenderingMode===1)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(l):this.skipInitialClear||l.clear(this.clearColor||a.clearColor,!0,!0,!0);else{let h=null,u=this.renderList?this.renderList:a.getActiveMeshes().data,d=this.renderList?this.renderList.length:a.getActiveMeshes().length;this.getCustomRenderList&&(h=this.getCustomRenderList(this.is2DArray||this.is3D?n:t,u,d)),h?this._prepareRenderingManager(h,h.length,o,this.forceLayerMaskCheck):(this._defaultRenderListPrepared||(this._prepareRenderingManager(u,d,o,!this.renderList||this.forceLayerMaskCheck),this._defaultRenderListPrepared=!0),h=u);for(let m of a._beforeRenderTargetClearStage)m.action(this,t,n);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(l):this.skipInitialClear||l.clear(this.clearColor||a.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||a.updateTransformMatrix(!0);for(let m of a._beforeRenderTargetDrawStage)m.action(this,t,n);this._renderingManager.render(this.customRenderFunction,h,this.renderParticles,this.renderSprites);for(let m of a._afterRenderTargetDrawStage)m.action(this,t,n);let f=this._texture?.generateMipMaps??!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,t,this._postProcesses,this.ignoreCameraViewport):i&&a.postProcessManager._finalizeFrame(!1,this._renderTarget??void 0,t);for(let m of a._afterRenderTargetPostProcessStage)m.action(this,t,n);this._texture&&(this._texture.generateMipMaps=f),this._doNotChangeAspectRatio||a.updateTransformMatrix(!0),r&&$n.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),l)}this._unbindFrameBuffer(l,t),this._texture&&this.isCube&&t===5&&l.generateMipMapsForCubemap(this._texture,!0),l._debugPopGroup?.(1)}setRenderingOrder(t,i=null,r=null,n=null){this._renderingManager.setRenderingOrder(t,i,r,n)}setRenderingAutoClearDepthStencil(t,i){this._renderingManager.setRenderingAutoClearDepthStencil(t,i),this._renderingManager._useSceneAutoClearSetup=!1}clone(){let t=this.getSize(),i=new s(this.name,t,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.coordinatesMode=this.coordinatesMode,this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;let t=super.serialize();if(t.renderTargetSize=this.getRenderSize(),t.renderList=[],this.renderList)for(let i=0;i<this.renderList.length;i++)t.renderList.push(this.renderList[i].id);return t}disposeFramebufferObjects(){this._renderTarget?.dispose(!0)}releaseInternalTexture(){this._renderTarget?.releaseTextures(),this._texture=null}dispose(){this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;let t=this.getScene();if(!t)return;let i=t.customRenderTargets.indexOf(this);i>=0&&t.customRenderTargets.splice(i,1);for(let r of t.cameras)i=r.customRenderTargets.indexOf(this),i>=0&&r.customRenderTargets.splice(i,1);this._renderTarget?.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===s.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=s.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}return s.REFRESHRATE_RENDER_ONCE=0,s.REFRESHRATE_RENDER_ONEVERYFRAME=1,s.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2,s})();z._CreateRenderTargetTexture=(s,e,t,i,r)=>new vt(s,e,t,i);var Zx=class{constructor(e){this.name=ye.NAME_PROCEDURALTEXTURE,this.scene=e,this.scene.proceduralTextures=[]}register(){this.scene._beforeClearStage.registerStep(ye.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){H.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){let t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}H.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}};var TH="proceduralVertexShader",CH=`attribute vec2 position;varying vec2 vPosition;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vPosition=position;vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[TH]=CH;var gn=class s extends z{constructor(e,t,i,r,n=null,o=!0,a=!1,l=0){super(null,r,!o),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new U,this.onBeforeGenerationObservable=new U,this.nodeMaterialSource=null,this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._vectors4={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,n!==null&&!(n instanceof z)?(this._options=n,this._fallbackTexture=n.fallbackTexture??null):(this._options={},this._fallbackTexture=n),r=this.getScene()||me.LastCreatedScene;let c=r._getComponent(ye.NAME_PROCEDURALTEXTURE);c||(c=new Zx(r),r._addComponent(c)),r.proceduralTextures.push(this),this._fullEngine=r.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=o,this._drawWrapper=new Xt(this._fullEngine),this.setFragment(i);let h=this._createRtWrapper(a,t,o,l);this._texture=h.texture;let u=[];u.push(1,1),u.push(-1,1),u.push(-1,-1),u.push(1,-1),this._vertexBuffers[y.PositionKind]=new y(this._fullEngine,u,y.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,r){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,ie({generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r},this._options)),this.setFloat("face",0)):this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,ie({generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:r},this._options)),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)}_createIndexBuffer(){let e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){let e=this._vertexBuffers[y.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===vt.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=vt.REFRESHRATE_RENDER_ONCE)}reset(){this._drawWrapper.effect?.dispose(),this._drawWrapper.effect=null,this._cachedDefines=null}_getDefines(){return""}executeWhenReady(e){if(this.isReady()){e(this);return}let t=this.getEffect();t&&t.executeWhenCompiled(()=>{e(this)})}isReady(){let e=this._fullEngine;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;let t=this._getDefines();if(this._drawWrapper.effect&&t===this._cachedDefines&&this._drawWrapper.effect.isReady())return!0;let i={vertex:"procedural",fragmentElement:this._fragment.fragmentElement,fragmentSource:this._fragment.fragmentSource,fragment:typeof this._fragment=="string"?this._fragment:void 0};return this._cachedDefines!==t&&(this._cachedDefines=t,this._drawWrapper.effect=e.createEffect(i,[y.PositionKind],this._uniforms,this._samplers,t,void 0,void 0,()=>{this._rtWrapper?.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0})),this._drawWrapper.effect.isReady()}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;let i=this._texture.isCube;this._rtWrapper.dispose();let r=this._createRtWrapper(i,e,t,this._textureType);this._texture=r.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)}setTexture(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){let t=this.getScene();if(!t)return;let i=this._fullEngine;if(i.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),i.setState(!1),!this.nodeMaterialSource){for(let n in this._textures)this._drawWrapper.effect.setTexture(n,this._textures[n]);for(let n in this._ints)this._drawWrapper.effect.setInt(n,this._ints[n]);for(let n in this._floats)this._drawWrapper.effect.setFloat(n,this._floats[n]);for(let n in this._floatsArrays)this._drawWrapper.effect.setArray(n,this._floatsArrays[n]);for(let n in this._colors3)this._drawWrapper.effect.setColor3(n,this._colors3[n]);for(let n in this._colors4){let o=this._colors4[n];this._drawWrapper.effect.setFloat4(n,o.r,o.g,o.b,o.a)}for(let n in this._vectors2)this._drawWrapper.effect.setVector2(n,this._vectors2[n]);for(let n in this._vectors3)this._drawWrapper.effect.setVector3(n,this._vectors3[n]);for(let n in this._vectors4)this._drawWrapper.effect.setVector4(n,this._vectors4[n]);for(let n in this._matrices)this._drawWrapper.effect.setMatrix(n,this._matrices[n])}if(!this._texture||!this._rtWrapper)return;i._debugPushGroup?.(`procedural texture generation for ${this.name}`,1);let r=i.currentViewport;if(this.isCube)for(let n=0;n<6;n++)i.bindFramebuffer(this._rtWrapper,n,void 0,void 0,!0),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",n),this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(se.TriangleFillMode,0,6);else{let n=1;this._rtWrapper.is3D?n=this._rtWrapper.depth:this._rtWrapper.is2DArray&&(n=this._rtWrapper.layers);for(let o=0;o<n;o++)i.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0,0,o),(this._rtWrapper.is3D||this._rtWrapper.is2DArray)&&this._drawWrapper.effect?.setFloat("layer",n!==1?o/(n-1):0),i.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this.autoClear&&i.clear(t.clearColor,!0,!1,!1),i.drawElementsType(se.TriangleFillMode,0,6)}i.unBindFramebuffer(this._rtWrapper,this.isCube),r&&i.setViewport(r),this.isCube&&i.generateMipMapsForCubemap(this._texture,!0),i._debugPopGroup?.(1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){let e=this.getSize(),t=new s(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){let e=this.getScene();if(!e)return;let t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);let i=this._vertexBuffers[y.PositionKind];i&&(i.dispose(),this._vertexBuffers[y.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}};v([I()],gn.prototype,"isEnabled",void 0);v([I()],gn.prototype,"autoClear",void 0);v([I()],gn.prototype,"_generateMipMaps",void 0);v([I()],gn.prototype,"_size",void 0);v([I()],gn.prototype,"refreshRate",null);P("BABYLON.ProceduralTexture",gn);var tr=function(s){return s[s.Cos=0]="Cos",s[s.Sin=1]="Sin",s[s.Abs=2]="Abs",s[s.Exp=3]="Exp",s[s.Exp2=4]="Exp2",s[s.Round=5]="Round",s[s.Floor=6]="Floor",s[s.Ceiling=7]="Ceiling",s[s.Sqrt=8]="Sqrt",s[s.Log=9]="Log",s[s.Tan=10]="Tan",s[s.ArcTan=11]="ArcTan",s[s.ArcCos=12]="ArcCos",s[s.ArcSin=13]="ArcSin",s[s.Fract=14]="Fract",s[s.Sign=15]="Sign",s[s.Radians=16]="Radians",s[s.Degrees=17]="Degrees",s[s.Set=18]="Set",s}(tr||{}),em=class extends Z{constructor(e){super(e,w.Neutral),this.operation=tr.Cos,this.registerInput("input",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i="";switch(this.operation){case tr.Cos:{i="cos";break}case tr.Sin:{i="sin";break}case tr.Abs:{i="abs";break}case tr.Exp:{i="exp";break}case tr.Exp2:{i="exp2";break}case tr.Round:{i="round";break}case tr.Floor:{i="floor";break}case tr.Ceiling:{i="ceil";break}case tr.Sqrt:{i="sqrt";break}case tr.Log:{i="log";break}case tr.Tan:{i="tan";break}case tr.ArcTan:{i="atan";break}case tr.ArcCos:{i="acos";break}case tr.ArcSin:{i="asin";break}case tr.Fract:{i="fract";break}case tr.Sign:{i="sign";break}case tr.Radians:{i="radians";break}case tr.Degrees:{i="degrees";break}case tr.Set:{i="";break}}return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.input.associatedVariableName});
`,this}serialize(){let e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${tr[this.operation]};
`}};P("BABYLON.TrigonometryBlock",em);var II={effect:null,subMesh:null},Td=class extends Qt{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){this[e]===void 0&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}},$i=class s extends Xs{static _BlockIsTextureBlock(e){return e.getClassName()==="TextureBlock"||e.getClassName()==="ReflectionTextureBaseBlock"||e.getClassName()==="ReflectionTextureBlock"||e.getClassName()==="ReflectionBlock"||e.getClassName()==="RefractionBlock"||e.getClassName()==="CurrentScreenBlock"||e.getClassName()==="ParticleTextureBlock"||e.getClassName()==="ImageSourceBlock"||e.getClassName()==="TriPlanarBlock"||e.getClassName()==="BiPlanarBlock"||e.getClassName()==="PrePassTextureBlock"}_getGlobalNodeMaterialEditor(){if(typeof NODEEDITOR<"u")return NODEEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeEditor<"u")return BABYLON}get shaderLanguage(){return this._options.shaderLanguage}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){if(super(e,t||me.LastCreatedScene),this._buildId=s._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new N,this._cachedWorldViewProjectionMatrix=new N,this._optimizers=new Array,this._animationFrame=-1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new U,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=[],this._mode=ns.Material,this.forceAlphaBlending=!1,i&&i.shaderLanguage===pe.WGSL&&!this.getScene().getEngine().isWebGPU)throw new Error("WebGPU shader language is only supported with WebGPU engine");this._options=ie({emitComments:!1,shaderLanguage:s.DefaultShaderLanguage},i),this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}getBlockByName(e){let t=null;for(let i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return H.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(let t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(let t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){let e=[];for(let t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){let t=this._optimizers.indexOf(e);if(t!==-1)return this._optimizers.splice(t,1),this}addOutputNode(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return e.target&w.Vertex&&this._addVertexOutputNode(e),e.target&w.Fragment&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return e.target===null?this:(e.target&w.Vertex&&this._removeVertexOutputNode(e),e.target&w.Fragment&&this._removeFragmentOutputNode(e),this)}_addVertexOutputNode(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=w.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){let t=this._vertexOutputNodes.indexOf(e);if(t!==-1)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=w.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){let t=this._fragmentOutputNodes.indexOf(e);if(t!==-1)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,r=!0){(e.target===w.VertexAndFragment||t.target===w.Fragment&&e.target===w.Vertex&&e._preparationId!==this._buildId)&&i.push(e),this._initializeBlock(e,t,i,r)}_initializeBlock(e,t,i,r=!0){if(e.initialize(t),r&&e.autoConfigure(this),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1){if(e.isUnique){let n=e.getClassName();for(let o of this.attachedBlocks)if(o.getClassName()===n)throw`Cannot have multiple blocks of type ${n} in the same NodeMaterial`}this.attachedBlocks.push(e)}for(let n of e.inputs){n.associatedVariableName="";let o=n.connectedPoint;if(o){let a=o.ownerBlock;a!==e&&this._processInitializeOnLink(a,t,i,r)}}if(e.isTeleportOut){let n=e;n.entryPoint&&this._processInitializeOnLink(n.entryPoint,t,i,r)}for(let n of e.outputs)n.associatedVariableName=""}_resetDualBlocks(e,t){e.target===w.VertexAndFragment&&(e.buildId=t);for(let i of e.inputs){let r=i.connectedPoint;if(r){let n=r.ownerBlock;n!==e&&this._resetDualBlocks(n,t)}}if(e.isTeleportOut){let i=e;i.entryPoint&&this._resetDualBlocks(i.entryPoint,t)}}removeBlock(e){let t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){!this._vertexCompilationState&&!i&&(i=!0),this._buildWasSuccessful=!1;let r=this.getScene().getEngine(),n=this._mode===ns.Particle;if(this._vertexOutputNodes.length===0&&!n)throw"You must define at least one vertexOutputNode";if(this._fragmentOutputNodes.length===0)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new jp,this._vertexCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._vertexCompilationState.target=w.Vertex,this._fragmentCompilationState=new jp,this._fragmentCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._fragmentCompilationState.target=w.Fragment,this._sharedData=new qx,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=n;let o=[],a=[];for(let h of this._vertexOutputNodes)o.push(h),this._initializeBlock(h,this._vertexCompilationState,a,i);for(let h of this._fragmentOutputNodes)a.push(h),this._initializeBlock(h,this._fragmentCompilationState,o,i);this.optimize();for(let h of o)h.build(this._vertexCompilationState,o);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(let h of a)this._resetDualBlocks(h,this._buildId-1);for(let h of a)h.build(this._fragmentCompilationState,a);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=s._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(F.Log("Vertex shader:"),F.Log(this._vertexCompilationState.compilationString),F.Log("Fragment shader:"),F.Log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);let l=this.getScene().meshes;for(let h of l)if(h.subMeshes)for(let u of h.subMeshes){if(u.getMaterial()!==this||!u.materialDefines)continue;let d=u.materialDefines;d.markAllAsDirty(),d.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();let c=this.getScene().prePassRenderer;c&&c.markAsDirty()}optimize(){for(let e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){let i=t.NORMAL,r=t.TANGENT,n=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(y.NormalKind),t.TANGENT=e.isVerticesDataPresent(y.TangentKind);let o=e.useVertexColors&&e.isVerticesDataPresent(y.ColorKind);t.VERTEXCOLOR_NME=o;let a=!1;for(let c=1;c<=6;++c){let h=t["UV"+c];t["UV"+c]=e.isVerticesDataPresent(`uv${c===1?"":c}`),a=a||t["UV"+c]!==h}let l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;Sc(this.getScene(),t,!l),(i!==t.NORMAL||r!==t.TANGENT||n!==t.VERTEXCOLOR_NME||a)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){let e=this.getBlockByPredicate(i=>i.getClassName()==="PrePassOutputBlock"),t=[4];return!e||this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.viewNormal.isConnected&&t.push(6),e.worldPosition.isConnected&&t.push(1)),t}get prePassTextureInputs(){let e=this.getAllTextureBlocks().filter(i=>i.getClassName()==="PrePassTextureBlock"),t=[];for(let i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.normal.isConnected&&!t.includes(6)&&t.push(6);return t}setPrePassRenderer(e){let t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]}));for(let r of t)i.texturesRequired.includes(r)||i.texturesRequired.push(r);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,r,n,o=0,a=5){return this.mode!==ns.PostProcess?(F.Log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,r,n,o,a)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,r=1,n,o,a=0,l=5){let c=this.name+this._buildId,h=new Td,u=new k(c+"PostProcess",this.getScene()),d=this._buildId;return this._processDefines(u,h),$t.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),e?e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c):e=new ve(this.name+"PostProcess",c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,r,n,o,h.toString(),a,c,{maxSimultaneousLights:this.maxSimultaneousLights},!1,l,this.shaderLanguage),e.nodeMaterialSource=this,e.onApplyObservable.add(f=>{d!==this._buildId&&(delete $t.ShadersStore[c+"VertexShader"],delete $t.ShadersStore[c+"PixelShader"],c=this.name+this._buildId,h.markAllAsDirty(),d=this._buildId),this._processDefines(u,h)&&($t.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),GS.SetImmediate(()=>e.updateEffect(h.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,c,c))),this._checkInternals(f)}),e}createProceduralTexture(e,t){if(this.mode!==ns.ProceduralTexture)return F.Log("Incompatible material mode"),null;let i=this.name+this._buildId,r=new gn(i,e,null,t),n=new k(i+"Procedural",this.getScene());n.reservedDataStore={hidden:!0};let o=new Td,a=this._processDefines(n,o);$t.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage);let l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[y.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString(),a?.fallbacks,void 0,void 0,void 0,this.shaderLanguage);r.nodeMaterialSource=this,r._setEffect(l);let c=this._buildId;return r.onBeforeGenerationObservable.add(()=>{c!==this._buildId&&(delete $t.ShadersStore[i+"VertexShader"],delete $t.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,o.markAllAsDirty(),c=this._buildId);let h=this._processDefines(n,o);h&&($t.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),GS.SetImmediate(()=>{l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[y.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString(),h?.fallbacks,void 0),r._setEffect(l)})),this._checkInternals(l)}),r}_createEffectForParticles(e,t,i,r,n,o,a,l=""){let c=this.name+this._buildId+"_"+t;o||(o=new Td),a||(a=this.getScene().getMeshByName(this.name+"Particle"),a||(a=new k(this.name+"Particle",this.getScene()),a.reservedDataStore={hidden:!0}));let h=this._buildId,u=[],d=l;if(!n){let f=this._processDefines(a,o);$t.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),e.fillDefines(u,t,!1),d=u.join(`
`),n=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString()+`
`+d,f?.fallbacks,i,r,e,this.shaderLanguage),e.setCustomEffect(n,t)}n.onBindObservable.add(f=>{h!==this._buildId&&(delete $t.ShadersStore[c+"PixelShader"],c=this.name+this._buildId+"_"+t,o.markAllAsDirty(),h=this._buildId),u.length=0,e.fillDefines(u,t,!1);let m=u.join(`
`);m!==d&&(o.markAllAsDirty(),d=m);let g=this._processDefines(a,o);if(g){$t.RegisterShader(c,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),f=this.getScene().getEngine().createEffectForParticles(c,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,o.toString()+`
`+d,g?.fallbacks,i,r,e),e.setCustomEffect(f,t),this._createEffectForParticles(e,t,i,r,f,o,a,l);return}this._checkInternals(f)})}_checkInternals(e){if(this._sharedData.animatedInputs){let t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(let r of this._sharedData.animatedInputs)r.animate(t);this._animationFrame=i}}for(let t of this._sharedData.bindableBlocks)t.bind(e,this);for(let t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){if(this.mode!==ns.Particle){F.Log("Incompatible material mode");return}this._createEffectForParticles(e,Wr.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,Wr.BLENDMODE_MULTIPLY,t,i)}createAsShadowDepthWrapper(e){if(this.mode!==ns.Material){F.Log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())}_processDefines(e,t,i=!1,r){let n=null,o=this.getScene();if(qS(o,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach(a=>{a.initializeDefines(e,this,t,i)}),this._sharedData.blocksWithDefines.forEach(a=>{a.prepareDefines(e,this,t,i,r)}),t.isDirty){let a=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(d=>{d.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)});let l=[];this._sharedData.dynamicUniformBlocks.forEach(d=>{d.updateUniformsAndSamples(this._vertexCompilationState,this,t,l)});let c=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(d=>{c.indexOf(d)===-1&&c.push(d)});let h=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(d=>{h.indexOf(d)===-1&&h.push(d)});let u=new ps;this._sharedData.blocksWithFallbacks.forEach(d=>{d.provideFallbacks(e,u)}),n={lightDisposed:a,uniformBuffers:l,mergedUniforms:c,mergedSamplers:h,fallbacks:u}}return n}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;let r=this.getScene();if(this._sharedData.animatedInputs){let c=r.getFrameId();if(this._animationFrame!==c){for(let h of this._sharedData.animatedInputs)h.animate(r);this._animationFrame=c}}let n=t._drawWrapper;if(n.effect&&this.isFrozen&&n._wasPreviouslyReady&&n._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new Td);let o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=r.getEngine();if(this._prepareDefinesForAttributes(e,o),this._sharedData.blockingBlocks.some(c=>!c.isReady(e,this,o,i)))return!1;let l=this._processDefines(e,o,i,t);if(l){let c=t.effect,h=o.toString(),u=a.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:l.mergedUniforms,uniformBuffersNames:l.uniformBuffers,samplers:l.mergedSamplers,defines:h,fallbacks:l.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:o.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:o.NUM_MORPH_INFLUENCERS},shaderLanguage:this.shaderLanguage},a);if(u)if(this._onEffectCreatedObservable&&(II.effect=u,II.subMesh=t,this._onEffectCreatedObservable.notifyObservers(II)),this.allowShaderHotSwapping&&c&&!u.isReady()){if(u=c,o.markAsUnprocessed(),l.lightDisposed)return o._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(u,o,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(o._renderId=r.getRenderId(),n._wasPreviouslyReady=!0,n._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}get compiledShaders(){return`// Vertex shader
${this._vertexCompilationState.compilationString}

// Fragment shader
${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){let t=this.getScene();if(!this._activeEffect)return;let i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(let r of this._sharedData.inputBlocks)r._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){let r=this.getScene(),n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e);let o=this._mustRebind(r,n,i,t.visibility),a=this._sharedData;if(o){for(let l of a.bindableBlocks)l.bind(n,this,t,i);for(let l of a.forcedBindableBlocks)l.bind(n,this,t,i);for(let l of a.inputBlocks)l._transmit(n,r,this)}else if(!this.isFrozen)for(let l of a.forcedBindableBlocks)l.bind(n,this,t,i);this._afterBind(t,this._activeEffect,i)}getActiveTextures(){let e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(t=>t.texture).map(t=>t.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){let e=[];for(let t of this.attachedBlocks)s._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(let t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(let r of this.getTextureBlocks().filter(n=>n.texture).map(n=>n.texture))r.dispose();for(let r of this.attachedBlocks)r.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){let t=ie({nodeMaterial:this},e);this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return new Promise(t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),typeof this.BJSNODEMATERIALEDITOR>"u"){let i=e&&e.editorURL?e.editorURL:s.EditorURL;H.LoadBabylonScript(i,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(e?.nodeEditorConfig),t()})}else this._createNodeEditor(e?.nodeEditorConfig),t()})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;let e=new Be("Position");e.setAsAttribute("position");let t=new Be("World");t.setAsSystemValue(qe.World);let i=new xd("WorldPos");e.connectTo(i),t.connectTo(i);let r=new Be("ViewProjection");r.setAsSystemValue(qe.ViewProjection);let n=new xd("WorldPos * ViewProjectionTransform");i.connectTo(n),r.connectTo(n);let o=new Kc("VertexOutput");n.connectTo(o);let a=new Be("color");a.value=new oe(.8,.8,.8,1);let l=new bo("FragmentOutput");a.connectTo(l),this.addOutputNode(o),this.addOutputNode(l),this._mode=ns.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;let e=new Be("Position");e.setAsAttribute("position2d");let t=new Be("Constant1");t.isConstant=!0,t.value=1;let i=new Zc("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});let r=new Kc("VertexOutput");i.connectTo(r);let n=new Be("Scale");n.visibleInInspector=!0,n.value=new j(1,1);let o=new Jc("uv0");e.connectTo(o);let a=new vd("UV scale");o.connectTo(a),n.connectTo(a);let l=new qp("CurrentScreen");a.connectTo(l),l.texture=new z("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());let c=new bo("FragmentOutput");l.connectTo(c,{output:"rgba"}),this.addOutputNode(r),this.addOutputNode(c),this._mode=ns.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;let e=new Be("Position");e.setAsAttribute("position2d");let t=new Be("Constant1");t.isConstant=!0,t.value=1;let i=new Zc("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});let r=new Kc("VertexOutput");i.connectTo(r);let n=new Be("Time");n.value=0,n.min=0,n.max=0,n.isBoolean=!1,n.matrixMode=0,n.animationType=ia.Time,n.isConstant=!1;let o=new Be("Color3");o.value=new X(1,1,1),o.isConstant=!1;let a=new bo("FragmentOutput"),l=new Zc("VectorMerger");l.visibleInInspector=!1;let c=new em("Cos");c.operation=tr.Cos,e.connectTo(l),n.output.connectTo(c.input),c.output.connectTo(l.z),l.xyzOut.connectTo(a.rgb),this.addOutputNode(r),this.addOutputNode(a),this._mode=ns.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;let e=new Be("uv");e.setAsAttribute("particle_uv");let t=new Qp("ParticleTexture");e.connectTo(t);let i=new Be("Color");i.setAsAttribute("particle_color");let r=new vd("Texture * Color");t.connectTo(r),i.connectTo(r);let n=new Kp("ParticleRampGradient");r.connectTo(n);let o=new Jp("ColorSplitter");i.connectTo(o);let a=new Zp("ParticleBlendMultiply");n.connectTo(a),t.connectTo(a,{output:"a"}),o.connectTo(a,{output:"a"});let l=new bo("FragmentOutput");a.connectTo(l),this.addOutputNode(l),this._mode=ns.Particle}loadAsync(e,t=""){return $e(this,null,function*(){return s.ParseFromFileAsync("",e,this.getScene(),t,!0,this)})}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(let i of e.inputs){let r=i.connectedPoint;if(r){let n=r.ownerBlock;n!==e&&this._gatherBlocks(n,t)}}if(e.isTeleportOut){let i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}generateCode(){let e=[],t=[],i=["const","var","let"];for(let o of this._vertexOutputNodes)this._gatherBlocks(o,t);let r=[];for(let o of this._fragmentOutputNodes)this._gatherBlocks(o,r);let n=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");
`;n+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${ns[this.mode]};
`;for(let o of t)o.isInput&&e.indexOf(o)===-1&&(n+=o._dumpCode(i,e));for(let o of r)o.isInput&&e.indexOf(o)===-1&&(n+=o._dumpCode(i,e));e=[],n+=`
// Connections
`;for(let o of this._vertexOutputNodes)n+=o._dumpCodeForOutputConnections(e);for(let o of this._fragmentOutputNodes)n+=o._dumpCodeForOutputConnections(e);n+=`
// Output nodes
`;for(let o of this._vertexOutputNodes)n+=`nodeMaterial.addOutputNode(${o._codeVariableName});
`;for(let o of this._fragmentOutputNodes)n+=`nodeMaterial.addOutputNode(${o._codeVariableName});
`;return n+=`nodeMaterial.build();
`,n}serialize(e){let t=e?{}:ae.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(let r of this._vertexOutputNodes)this._gatherBlocks(r,i),t.outputNodes.push(r.uniqueId);for(let r of this._fragmentOutputNodes)this._gatherBlocks(r,i),t.outputNodes.indexOf(r.uniqueId)===-1&&t.outputNodes.push(r.uniqueId)}t.blocks=[];for(let r of i)t.blocks.push(r.serialize());if(!e)for(let r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t}_restoreConnections(e,t,i){for(let r of e.outputs)for(let n of t.blocks){let o=i[n.id];if(o){for(let a of n.inputs)if(i[a.targetBlockId]===e&&a.targetConnectionName===r.name){let l=o.getInputByName(a.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(o,t,i);continue}}}}parseSerializedObject(e,t="",i=!1,r){i||this.clear();let n={};for(let o of e.blocks){let a=Et(o.customType);if(a){let l=new a;l._deserialize(o,this.getScene(),t,r),n[o.id]=l,this.attachedBlocks.push(l)}}for(let o of this.attachedBlocks)if(o.isTeleportOut){let a=o,l=a._tempEntryPointUniqueId;l&&n[l].attachToEndpoint(a)}for(let o=0;o<e.blocks.length;o++){let a=e.blocks[o],l=n[a.id];l&&(l.inputs.length&&!i||this._restoreConnections(l,e,n))}if(e.outputNodes)for(let o of e.outputNodes)this.addOutputNode(n[o]);if(e.locations||e.editorData&&e.editorData.locations){let o=e.locations||e.editorData.locations;for(let l of o)n[l.blockId]&&(l.blockId=n[l.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&o.concat(this.editorData.locations),e.locations?this.editorData={locations:o}:(this.editorData=e.editorData,this.editorData.locations=o);let a=[];for(let l in n)a[l]=n[l].uniqueId;this.editorData.map=a}this.comment=e.comment,e.forceAlphaBlending!==void 0&&(this.forceAlphaBlending=e.forceAlphaBlending),e.alphaMode!==void 0&&(this.alphaMode=e.alphaMode),i||(this._mode=e.mode??ns.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){let i=this.serialize(),r=ae.Clone(()=>new s(e,this.getScene(),this.options),this);return r.id=e,r.name=e,r.parseSerializedObject(i),r._buildId=this._buildId,r.build(!1,!t),r}whenTexturesReadyAsync(){let e=[];return this.getActiveTextures().forEach(t=>{let i=t.getInternalTexture();i&&!i.isReady&&e.push(new Promise((r,n)=>{i.onLoadedObservable.addOnce(()=>{r()}),i.onErrorObservable.addOnce(o=>{n(o)})}))}),Promise.all(e)}static Parse(e,t,i="",r=pe.GLSL){let n=ae.Parse(()=>new s(e.name,t,{shaderLanguage:r}),e,t,i);return n.parseSerializedObject(e,i),n.build(),n}static ParseFromFileAsync(e,t,i,r="",n=!1,o,a){return $e(this,null,function*(){let l=o??new s(e,i),c=yield i._loadFileAsync(t),h=JSON.parse(c);return l.parseSerializedObject(h,r,void 0,a),n||l.build(),l})}static ParseFromSnippetAsync(e,t=me.LastCreatedScene,i="",r,n=!1,o=!1,a){return e==="_BLANK"?Promise.resolve(s.CreateDefault("blank",t)):new Promise((l,c)=>{let h=new gr;h.addEventListener("readystatechange",()=>{if(h.readyState==4)if(h.status==200){let u=JSON.parse(JSON.parse(h.responseText).jsonPayload),d=JSON.parse(u.nodeMaterial);r||(r=ae.Parse(()=>new s(e,t),d,t,i),r.uniqueId=t.getUniqueId()),r.parseSerializedObject(d,void 0,void 0,a),r.snippetId=e,r.sideOrientation=null;try{n||r.build()}catch(f){c(f)}o?r.whenTexturesReadyAsync().then(()=>{l(r)}).catch(f=>{c(f)}):l(r)}else c("Unable to load the snippet "+e)}),h.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),h.send()})}static CreateDefault(e,t){let i=new s(e,t);return i.setToDefault(),i.build(),i}};$i._BuildIdGenerator=0;$i.EditorURL=`${H._DefaultCdnUrl}/v${Se.Version}/nodeEditor/babylon.nodeEditor.js`;$i.SnippetUrl="https://snippet.babylonjs.com";$i.IgnoreTexturesAtLoadTime=!1;$i.DefaultShaderLanguage=pe.GLSL;v([I()],$i.prototype,"ignoreAlpha",void 0);v([I()],$i.prototype,"maxSimultaneousLights",void 0);v([I("mode")],$i.prototype,"_mode",void 0);v([I("comment")],$i.prototype,"comment",void 0);v([I()],$i.prototype,"forceAlphaBlending",void 0);P("BABYLON.NodeMaterial",$i);function Jx(s){let e=s.sideOrientation||le.DEFAULTSIDE,t=s.radius||1,i=s.flat===void 0?!0:s.flat,r=(s.subdivisions||4)|0,n=s.radiusX||t,o=s.radiusY||t,a=s.radiusZ||t,l=(1+Math.sqrt(5))/2,c=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],h=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],u=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],d=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],f=138/1024,m=239/1024,g=60/1024,_=26/1024,x=-40/1024,b=20/1024,C=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],R=[],E=[],S=[],A=[],L=0,G=new Array(3),W=new Array(3),$;for($=0;$<3;$++)G[$]=p.Zero(),W[$]=j.Zero();for(let we=0;we<20;we++){for($=0;$<3;$++){let ce=h[3*we+$];G[$].copyFromFloats(c[3*u[ce]],c[3*u[ce]+1],c[3*u[ce]+2]),G[$].normalize(),W[$].copyFromFloats(d[2*ce]*f+g+C[we]*x,d[2*ce+1]*m+_+C[we]*b)}let _e=(ce,ne,Fe,Oe)=>{let he=p.Lerp(G[0],G[2],ne/r),ee=p.Lerp(G[1],G[2],ne/r),V=r===ne?G[2]:p.Lerp(he,ee,ce/(r-ne));V.normalize();let Y;if(i){let et=p.Lerp(G[0],G[2],Oe/r),Tt=p.Lerp(G[1],G[2],Oe/r);Y=p.Lerp(et,Tt,Fe/(r-Oe))}else Y=new p(V.x,V.y,V.z);Y.x/=n,Y.y/=o,Y.z/=a,Y.normalize();let J=j.Lerp(W[0],W[2],ne/r),Me=j.Lerp(W[1],W[2],ne/r),Re=r===ne?W[2]:j.Lerp(J,Me,ce/(r-ne));E.push(V.x*n,V.y*o,V.z*a),S.push(Y.x,Y.y,Y.z),A.push(Re.x,it.UseOpenGLOrientationForUV?1-Re.y:Re.y),R.push(L),L++};for(let ce=0;ce<r;ce++)for(let ne=0;ne+ce<r;ne++)_e(ne,ce,ne+1/3,ce+1/3),_e(ne+1,ce,ne+1/3,ce+1/3),_e(ne,ce+1,ne+1/3,ce+1/3),ne+ce+1<r&&(_e(ne+1,ce,ne+2/3,ce+2/3),_e(ne+1,ce+1,ne+2/3,ce+2/3),_e(ne,ce+1,ne+2/3,ce+2/3))}le._ComputeSides(e,E,R,S,A,s.frontUVs,s.backUVs);let re=new le;return re.indices=R,re.positions=E,re.normals=S,re.uvs=A,re}function ev(s,e={},t=null){let i=new k(s,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Jx(e).applyToMesh(i,e.updatable),i}le.CreateIcoSphere=Jx;k.CreateIcoSphere=(s,e,t)=>ev(s,e,t);var eh=function(s){return s.WRIST="wrist",s.THUMB="thumb",s.INDEX="index",s.MIDDLE="middle",s.RING="ring",s.LITTLE="little",s}(eh||{}),ze=function(s){return s.WRIST="wrist",s.THUMB_METACARPAL="thumb-metacarpal",s.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",s.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",s.THUMB_TIP="thumb-tip",s.INDEX_FINGER_METACARPAL="index-finger-metacarpal",s.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",s.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",s.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",s.INDEX_FINGER_TIP="index-finger-tip",s.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",s.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",s.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",s.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",s.MIDDLE_FINGER_TIP="middle-finger-tip",s.RING_FINGER_METACARPAL="ring-finger-metacarpal",s.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",s.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",s.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",s.RING_FINGER_TIP="ring-finger-tip",s.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",s.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",s.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",s.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",s.PINKY_FINGER_TIP="pinky-finger-tip",s}(ze||{}),So=[ze.WRIST,ze.THUMB_METACARPAL,ze.THUMB_PHALANX_PROXIMAL,ze.THUMB_PHALANX_DISTAL,ze.THUMB_TIP,ze.INDEX_FINGER_METACARPAL,ze.INDEX_FINGER_PHALANX_PROXIMAL,ze.INDEX_FINGER_PHALANX_INTERMEDIATE,ze.INDEX_FINGER_PHALANX_DISTAL,ze.INDEX_FINGER_TIP,ze.MIDDLE_FINGER_METACARPAL,ze.MIDDLE_FINGER_PHALANX_PROXIMAL,ze.MIDDLE_FINGER_PHALANX_INTERMEDIATE,ze.MIDDLE_FINGER_PHALANX_DISTAL,ze.MIDDLE_FINGER_TIP,ze.RING_FINGER_METACARPAL,ze.RING_FINGER_PHALANX_PROXIMAL,ze.RING_FINGER_PHALANX_INTERMEDIATE,ze.RING_FINGER_PHALANX_DISTAL,ze.RING_FINGER_TIP,ze.PINKY_FINGER_METACARPAL,ze.PINKY_FINGER_PHALANX_PROXIMAL,ze.PINKY_FINGER_PHALANX_INTERMEDIATE,ze.PINKY_FINGER_PHALANX_DISTAL,ze.PINKY_FINGER_TIP],bH={[eh.WRIST]:[ze.WRIST],[eh.THUMB]:[ze.THUMB_METACARPAL,ze.THUMB_PHALANX_PROXIMAL,ze.THUMB_PHALANX_DISTAL,ze.THUMB_TIP],[eh.INDEX]:[ze.INDEX_FINGER_METACARPAL,ze.INDEX_FINGER_PHALANX_PROXIMAL,ze.INDEX_FINGER_PHALANX_INTERMEDIATE,ze.INDEX_FINGER_PHALANX_DISTAL,ze.INDEX_FINGER_TIP],[eh.MIDDLE]:[ze.MIDDLE_FINGER_METACARPAL,ze.MIDDLE_FINGER_PHALANX_PROXIMAL,ze.MIDDLE_FINGER_PHALANX_INTERMEDIATE,ze.MIDDLE_FINGER_PHALANX_DISTAL,ze.MIDDLE_FINGER_TIP],[eh.RING]:[ze.RING_FINGER_METACARPAL,ze.RING_FINGER_PHALANX_PROXIMAL,ze.RING_FINGER_PHALANX_INTERMEDIATE,ze.RING_FINGER_PHALANX_DISTAL,ze.RING_FINGER_TIP],[eh.LITTLE]:[ze.PINKY_FINGER_METACARPAL,ze.PINKY_FINGER_PHALANX_PROXIMAL,ze.PINKY_FINGER_PHALANX_INTERMEDIATE,ze.PINKY_FINGER_PHALANX_DISTAL,ze.PINKY_FINGER_TIP]},RI=class{get handMesh(){return this._handMesh}getHandPartMeshes(e){return bH[e].map(t=>this._jointMeshes[So.indexOf(t)])}getJointMesh(e){return this._jointMeshes[So.indexOf(e)]}constructor(e,t,i,r,n=!1,o=!1,a=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=r,this._leftHandedMeshes=n,this._jointsInvisible=o,this._jointScaleFactor=a,this.onHandMeshSetObservable=new U,this._jointTransforms=new Array(So.length),this._jointTransformMatrices=new Float32Array(So.length*16),this._tempJointMatrix=new N,this._jointRadii=new Float32Array(So.length),this._scene=t[0].getScene();for(let l=0;l<this._jointTransforms.length;l++){let c=this._jointTransforms[l]=new Ze(So[l],this._scene);c.rotationQuaternion=new q,t[l].rotationQuaternion=new q}i&&this.setHandMesh(i,r),this.xrController.motionController&&this.xrController.motionController.rootMesh&&this.xrController.motionController.rootMesh.dispose(!1,!0),this.xrController.onMotionControllerInitObservable.add(l=>{l._doNotLoadControllerMesh=!0})}setHandMesh(e,t,i){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach(r=>{r.alwaysSelectAsActiveMesh=!0}),this._handMesh.skeleton){let r=this._handMesh.skeleton;So.forEach((n,o)=>{let a=r.getBoneIndexByName(t?t[n]:n);a!==-1&&r.bones[a].linkTransformNode(this._jointTransforms[o])})}this.onHandMeshSetObservable.notifyObservers(this)}updateFromXRFrame(e,t){let i=this.xrController.inputSource.hand;if(!i)return;let r=i,n=So.map(a=>r[a]||i.get(a)),o=!1;if(e.fillPoses&&e.fillJointRadii)o=e.fillPoses(n,t,this._jointTransformMatrices)&&e.fillJointRadii(n,this._jointRadii);else if(e.getJointPose){o=!0;for(let a=0;a<n.length;a++){let l=e.getJointPose(n[a],t);if(l)this._jointTransformMatrices.set(l.transform.matrix,a*16),this._jointRadii[a]=l.radius||.008;else{o=!1;break}}}o&&(So.forEach((a,l)=>{let c=this._jointTransforms[l];N.FromArrayToRef(this._jointTransformMatrices,l*16,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,c.rotationQuaternion,c.position);let h=this._jointRadii[l]*this._jointScaleFactor,u=this._jointMeshes[l];u.isVisible=!this._handMesh&&!this._jointsInvisible,u.position.copyFrom(c.position),u.rotationQuaternion.copyFrom(c.rotationQuaternion),u.scaling.setAll(h),this._scene.useRightHandedSystem||(u.position.z*=-1,u.rotationQuaternion.z*=-1,u.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(c.position.z*=-1,c.rotationQuaternion.z*=-1,c.rotationQuaternion.w*=-1))}),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(e=!1){this._handMesh&&(e?(this._handMesh.skeleton?.dispose(),this._handMesh.dispose(!1,!0)):this._handMesh.isVisible=!1)}},ms=class s extends Ct{static _GenerateTrackedJointMeshes(e){let t={};return["left","right"].map(i=>{let r=[],n=e.jointMeshes?.sourceMesh||ev("jointParent",s._ICOSPHERE_PARAMS);n.isVisible=!!e.jointMeshes?.keepOriginalVisible;for(let o=0;o<So.length;++o){let a=n.createInstance(`${i}-handJoint-${o}`);if(e.jointMeshes?.onHandJointMeshGenerated){let l=e.jointMeshes.onHandJointMeshGenerated(a,o,i);l&&l!==a&&(a.dispose(),a=l)}if(a.isPickable=!1,e.jointMeshes?.enablePhysics){let l=e.jointMeshes?.physicsProps||{};a.scaling.setAll(.02);let c=l.impostorType!==void 0?l.impostorType:He.SphereImpostor;a.physicsImpostor=new He(a,c,ie({mass:0},l))}a.rotationQuaternion=new q,a.isVisible=!1,r.push(a)}t[i]=r}),{left:t.left,right:t.right}}static _GenerateDefaultHandMeshesAsync(e,t,i){return new Promise(r=>$e(this,null,function*(){let n={};s._RightHandGLB?.meshes[1]?.isDisposed()&&(s._RightHandGLB=null),s._LeftHandGLB?.meshes[1]?.isDisposed()&&(s._LeftHandGLB=null);let o=!!(s._RightHandGLB&&s._LeftHandGLB),a=yield Promise.all([s._RightHandGLB||Mt.ImportMeshAsync("",s.DEFAULT_HAND_MODEL_BASE_URL,s.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),s._LeftHandGLB||Mt.ImportMeshAsync("",s.DEFAULT_HAND_MODEL_BASE_URL,s.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);s._RightHandGLB=a[0],s._LeftHandGLB=a[1];let l=yield $i.ParseFromFileAsync("handShader",s.DEFAULT_HAND_MODEL_SHADER_URL,e);l.needDepthPrePass=!0,l.transparencyMode=se.MATERIAL_ALPHABLEND,l.alphaMode=2,l.build(!1);let c=ie({base:X.FromInts(116,63,203),fresnel:X.FromInts(149,102,229),fingerColor:X.FromInts(177,130,255),tipFresnel:X.FromInts(220,200,255)},i?.handMeshes?.customColors),h={base:l.getBlockByName("baseColor"),fresnel:l.getBlockByName("fresnelColor"),fingerColor:l.getBlockByName("fingerColor"),tipFresnel:l.getBlockByName("tipFresnelColor")};h.base.value=c.base,h.fresnel.value=c.fresnel,h.fingerColor.value=c.fingerColor,h.tipFresnel.value=c.tipFresnel;let u=t._getBaseLayerWrapper()?.isMultiview;["left","right"].forEach(d=>{let f=d=="left"?s._LeftHandGLB:s._RightHandGLB;if(!f)throw new Error("Could not load hand model");let m=f.meshes[1];m._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,u||(m.material=l.clone(`${d}HandShaderClone`,!0)),m.isVisible=!1,n[d]=m,!o&&!e.useRightHandedSystem&&f.meshes[1].rotate(qt.Y,Math.PI)}),l.dispose(),r({left:n.left,right:n.right})}))}static _GenerateDefaultHandMeshRigMapping(e){let t=e=="right"?"R":"L";return{[ze.WRIST]:`wrist_${t}`,[ze.THUMB_METACARPAL]:`thumb_metacarpal_${t}`,[ze.THUMB_PHALANX_PROXIMAL]:`thumb_proxPhalanx_${t}`,[ze.THUMB_PHALANX_DISTAL]:`thumb_distPhalanx_${t}`,[ze.THUMB_TIP]:`thumb_tip_${t}`,[ze.INDEX_FINGER_METACARPAL]:`index_metacarpal_${t}`,[ze.INDEX_FINGER_PHALANX_PROXIMAL]:`index_proxPhalanx_${t}`,[ze.INDEX_FINGER_PHALANX_INTERMEDIATE]:`index_intPhalanx_${t}`,[ze.INDEX_FINGER_PHALANX_DISTAL]:`index_distPhalanx_${t}`,[ze.INDEX_FINGER_TIP]:`index_tip_${t}`,[ze.MIDDLE_FINGER_METACARPAL]:`middle_metacarpal_${t}`,[ze.MIDDLE_FINGER_PHALANX_PROXIMAL]:`middle_proxPhalanx_${t}`,[ze.MIDDLE_FINGER_PHALANX_INTERMEDIATE]:`middle_intPhalanx_${t}`,[ze.MIDDLE_FINGER_PHALANX_DISTAL]:`middle_distPhalanx_${t}`,[ze.MIDDLE_FINGER_TIP]:`middle_tip_${t}`,[ze.RING_FINGER_METACARPAL]:`ring_metacarpal_${t}`,[ze.RING_FINGER_PHALANX_PROXIMAL]:`ring_proxPhalanx_${t}`,[ze.RING_FINGER_PHALANX_INTERMEDIATE]:`ring_intPhalanx_${t}`,[ze.RING_FINGER_PHALANX_DISTAL]:`ring_distPhalanx_${t}`,[ze.RING_FINGER_TIP]:`ring_tip_${t}`,[ze.PINKY_FINGER_METACARPAL]:`little_metacarpal_${t}`,[ze.PINKY_FINGER_PHALANX_PROXIMAL]:`little_proxPhalanx_${t}`,[ze.PINKY_FINGER_PHALANX_INTERMEDIATE]:`little_intPhalanx_${t}`,[ze.PINKY_FINGER_PHALANX_DISTAL]:`little_distPhalanx_${t}`,[ze.PINKY_FINGER_TIP]:`little_tip_${t}`}}isCompatible(){return typeof XRHand<"u"}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return e=="none"?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this._worldScaleObserver=null,this.onHandAddedObservable=new U,this.onHandRemovedObservable=new U,this._attachHand=n=>{if(!n.inputSource.hand||n.inputSource.handedness=="none"||!this._handResources.jointMeshes)return;let o=n.inputSource.handedness,a=new RI(n,this._handResources.jointMeshes[o],this._handResources.handMeshes&&this._handResources.handMeshes[o],this._handResources.rigMappings&&this._handResources.rigMappings[o],this.options.handMeshes?.meshesUseLeftHandedCoordinates,this.options.jointMeshes?.invisible,this.options.jointMeshes?.scaleFactor);this._attachedHands[n.uniqueId]=a,this._trackingHands[o]=a,this.onHandAddedObservable.notifyObservers(a)},this._detachHand=n=>{this._detachHandById(n.uniqueId)},this.xrNativeFeatureName="hand-tracking";let r=t.jointMeshes;if(r&&(typeof r.disableDefaultHandMesh<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=r.disableDefaultHandMesh),typeof r.handMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=r.handMeshes),typeof r.leftHandedSystemMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=r.leftHandedSystemMeshes),typeof r.rigMapping<"u")){t.handMeshes=t.handMeshes||{};let n={},o={};[[r.rigMapping.left,n],[r.rigMapping.right,o]].forEach(a=>{let l=a[0],c=a[1];l.forEach((h,u)=>{c[So[u]]=h})}),t.handMeshes.customRigMappings={left:n,right:o}}}attach(){return super.attach()?(this._handResources={jointMeshes:s._GenerateTrackedJointMeshes(this.options),handMeshes:this.options.handMeshes?.customMeshes||null,rigMappings:this.options.handMeshes?.customRigMappings||null},!this.options.handMeshes?.customMeshes&&!this.options.handMeshes?.disableDefaultMeshes&&(s._GenerateDefaultHandMeshesAsync(me.LastCreatedScene,this._xrSessionManager,this.options).then(e=>{this._handResources.handMeshes=e,this._handResources.rigMappings={left:s._GenerateDefaultHandMeshRigMapping("left"),right:s._GenerateDefaultHandMeshRigMapping("right")},this._trackingHands.left?.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left,this._xrSessionManager),this._trackingHands.right?.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right,this._xrSessionManager),this._handResources.handMeshes.left.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._handResources.handMeshes.right.scaling.setAll(this._xrSessionManager.worldScalingFactor)}),this._worldScaleObserver=this._xrSessionManager.onWorldScaleFactorChangedObservable.add(e=>{this._handResources.handMeshes&&(this._handResources.handMeshes.left.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor),this._handResources.handMeshes.right.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor))})),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0):!1}_onXRFrame(e){this._trackingHands.left?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),this._trackingHands.right?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e,t){let i=this.getHandByControllerId(e);if(i){let r=i.xrController.inputSource.handedness=="left"?"left":"right";this._trackingHands[r]?.xrController.uniqueId===e&&(this._trackingHands[r]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(t),delete this._attachedHands[e]}}detach(){return super.detach()?(Object.keys(this._attachedHands).forEach(e=>this._detachHandById(e,this.options.handMeshes?.disposeOnSessionEnd)),this.options.handMeshes?.disposeOnSessionEnd&&this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach(e=>e.dispose()),this._handResources.jointMeshes.right.forEach(e=>e.dispose())),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),!0):!1}dispose(){super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!this.options.handMeshes?.customMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),s._RightHandGLB=null,s._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach(e=>e.dispose()),this._handResources.jointMeshes.right.forEach(e=>e.dispose()))}};ms.Name=ct.HAND_TRACKING;ms.Version=1;ms.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/meshes/HandMeshes/";ms.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb";ms.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb";ms.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json";ms._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2};ms._RightHandGLB=null;ms._LeftHandGLB=null;mt.AddWebXRFeature(ms.Name,(s,e)=>()=>new ms(s,e),ms.Version,!1);var tm=class s{get maxAngle(){return this._maxAngle}set maxAngle(e){this._setMaxAngle(e)}constructor(e,t,i){this.targetPosition=p.Zero(),this.poleTargetPosition=p.Zero(),this.poleTargetLocalOffset=p.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=q.Identity(),this._bone1Mat=N.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._rightHandedSystem=!1,this._bendAxis=p.Right(),this._slerping=!1,this._adjustRoll=0,this._notEnoughInformation=!1,this._bone2=t;let r=t.getParent();if(!r){this._notEnoughInformation=!0,F.Error("BoneIKController: bone must have a parent for IK to work.");return}if(this._bone1=r,this._bone2.children.length===0&&!this._bone2.length){this._notEnoughInformation=!0,F.Error("BoneIKController: bone must not be a leaf or it should have a length for IK to work.");return}this.mesh=e,t.getSkeleton().computeAbsoluteMatrices();let n=t.getPosition();if(t.getAbsoluteMatrix().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=-1,n.x>n.y&&n.x>n.z&&(this._adjustRoll=Math.PI*.5,this._bendAxis.z=1)),this._bone1.length&&this._bone2.length){let o=this._bone1.getScale(),a=this._bone2.getScale();this._bone1Length=this._bone1.length*o.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*a.y*this.mesh.scaling.y}else if(this._bone2.children[0]){e.computeWorldMatrix(!0);let o=this._bone2.children[0].getAbsolutePosition(e),a=this._bone2.getAbsolutePosition(e),l=this._bone1.getAbsolutePosition(e);this._bone2Length=p.Distance(o,a),this._bone1Length=p.Distance(a,l)}else{e.computeWorldMatrix(!0);let o=this._bone2.getScale();this._bone2Length=this._bone2.length*o.y*this.mesh.scaling.y;let a=this._bone2.getAbsolutePosition(e),l=this._bone1.getAbsolutePosition(e);this._bone1Length=p.Distance(a,l)}this._bone1.getRotationMatrixToRef(Ke.WORLD,e,this._bone1Mat),this.maxAngle=Math.PI,i&&(i.targetMesh&&(this.targetMesh=i.targetMesh,this.targetMesh.computeWorldMatrix(!0)),i.poleTargetMesh?(this.poleTargetMesh=i.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):i.poleTargetBone?this.poleTargetBone=i.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),i.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(i.poleTargetLocalOffset),i.poleAngle&&(this.poleAngle=i.poleAngle),i.bendAxis&&this._bendAxis.copyFrom(i.bendAxis),i.maxAngle&&(this.maxAngle=i.maxAngle),i.slerpAmount&&(this.slerpAmount=i.slerpAmount))}_setMaxAngle(e){e<0&&(e=0),(e>Math.PI||e==null)&&(e=Math.PI),this._maxAngle=e;let t=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(t*t+i*i-2*t*i*Math.cos(e))}update(){if(this._notEnoughInformation)return;let e=this.targetPosition,t=this.poleTargetPosition,i=s._TmpMats[0],r=s._TmpMats[1];this.targetMesh&&e.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,t):this.poleTargetMesh&&p.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),t);let n=s._TmpVecs[0],o=s._TmpVecs[1],a=s._TmpVecs[2],l=s._TmpVecs[3],c=s._TmpVecs[4],h=s._TmpQuat;this._bone1.getAbsolutePositionToRef(this.mesh,n),t.subtractToRef(n,c),c.x==0&&c.y==0&&c.z==0?c.y=1:c.normalize(),e.subtractToRef(n,l),l.normalize(),p.CrossToRef(l,c,o),o.normalize(),p.CrossToRef(l,o,a),a.normalize(),N.FromXYZAxesToRef(a,l,o,i);let u=this._bone1Length,d=this._bone2Length,f=p.Distance(n,e);this._maxReach>0&&(f=Math.min(this._maxReach,f));let m=(d*d+f*f-u*u)/(2*d*f),g=(f*f+u*u-d*d)/(2*f*u);m>1&&(m=1),g>1&&(g=1),m<-1&&(m=-1),g<-1&&(g=-1);let _=Math.acos(m),x=Math.acos(g),b=-_-x;if(this._rightHandedSystem)N.RotationYawPitchRollToRef(0,0,this._adjustRoll,r),r.multiplyToRef(i,i),N.RotationAxisToRef(this._bendAxis,x,r),r.multiplyToRef(i,i);else{let C=s._TmpVecs[5];C.copyFrom(this._bendAxis),C.x*=-1,N.RotationAxisToRef(C,-x,r),r.multiplyToRef(i,i)}this.poleAngle&&(N.RotationAxisToRef(l,this.poleAngle,r),i.multiplyToRef(r,i)),this._bone1&&(this.slerpAmount<1?(this._slerping||q.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),q.FromRotationMatrixToRef(i,h),q.SlerpToRef(this._bone1Quat,h,this.slerpAmount,this._bone1Quat),b=this._bone2Ang*(1-this.slerpAmount)+b*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,Ke.WORLD,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(i,Ke.WORLD,this.mesh),this._bone1Mat.copyFrom(i),this._slerping=!1),this._updateLinkedTransformRotation(this._bone1)),this._bone2.setAxisAngle(this._bendAxis,b,Ke.LOCAL),this._updateLinkedTransformRotation(this._bone2),this._bone2Ang=b}_updateLinkedTransformRotation(e){e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new q),e.getRotationQuaternionToRef(Ke.LOCAL,null,e._linkedTransformNode.rotationQuaternion))}};tm._TmpVecs=[p.Zero(),p.Zero(),p.Zero(),p.Zero(),p.Zero(),p.Zero()];tm._TmpQuat=q.Identity();tm._TmpMats=[N.Identity(),N.Identity()];var im=class s{get minYaw(){return this._minYaw}set minYaw(e){this._minYaw=e,this._minYawSin=Math.sin(e),this._minYawCos=Math.cos(e),this._maxYaw!=null&&(this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get maxYaw(){return this._maxYaw}set maxYaw(e){this._maxYaw=e,this._maxYawSin=Math.sin(e),this._maxYawCos=Math.cos(e),this._minYaw!=null&&(this._midYawConstraint=this._getAngleDiff(this._minYaw,this._maxYaw)*.5+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch=e,this._minPitchTan=Math.tan(e)}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch=e,this._maxPitchTan=Math.tan(e)}constructor(e,t,i,r){if(this.upAxis=p.Up(),this.upAxisSpace=Ke.LOCAL,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this._boneQuat=q.Identity(),this._slerping=!1,this._firstFrameSkipped=!1,this._fowardAxis=p.Forward(),this.useAbsoluteValueForYaw=!1,this.mesh=e,this.bone=t,this.target=i,r){if(r.adjustYaw&&(this.adjustYaw=r.adjustYaw),r.adjustPitch&&(this.adjustPitch=r.adjustPitch),r.adjustRoll&&(this.adjustRoll=r.adjustRoll),r.maxYaw!=null?this.maxYaw=r.maxYaw:this.maxYaw=Math.PI,r.minYaw!=null?this.minYaw=r.minYaw:this.minYaw=-Math.PI,r.maxPitch!=null?this.maxPitch=r.maxPitch:this.maxPitch=Math.PI,r.minPitch!=null?this.minPitch=r.minPitch:this.minPitch=-Math.PI,r.slerpAmount!=null&&(this.slerpAmount=r.slerpAmount),r.upAxis!=null&&(this.upAxis=r.upAxis),r.upAxisSpace!=null&&(this.upAxisSpace=r.upAxisSpace),r.yawAxis!=null||r.pitchAxis!=null){let n=qt.Y,o=qt.X;r.yawAxis!=null&&(n=r.yawAxis.clone(),n.normalize()),r.pitchAxis!=null&&(o=r.pitchAxis.clone(),o.normalize());let a=p.Cross(o,n);this._transformYawPitch=N.Identity(),N.FromXYZAxesToRef(o,n,a,this._transformYawPitch),this._transformYawPitchInv=this._transformYawPitch.clone(),this._transformYawPitch.invert()}r.useAbsoluteValueForYaw!==void 0&&(this.useAbsoluteValueForYaw=r.useAbsoluteValueForYaw)}!t.getParent()&&this.upAxisSpace==Ke.BONE&&(this.upAxisSpace=Ke.LOCAL)}update(){if(this.slerpAmount<1&&!this._firstFrameSkipped){this._firstFrameSkipped=!0;return}let e=this.bone,t=s._TmpVecs[0];e.getAbsolutePositionToRef(this.mesh,t);let i=this.target,r=s._TmpMats[0],n=s._TmpMats[1],o=this.mesh,a=e.getParent(),l=s._TmpVecs[1];l.copyFrom(this.upAxis),this.upAxisSpace==Ke.BONE&&a?(this._transformYawPitch&&p.TransformCoordinatesToRef(l,this._transformYawPitchInv,l),a.getDirectionToRef(l,this.mesh,l)):this.upAxisSpace==Ke.LOCAL&&(o.getDirectionToRef(l,l),(o.scaling.x!=1||o.scaling.y!=1||o.scaling.z!=1)&&l.normalize());let c=!1,h=!1;if((this._maxYaw!=Math.PI||this._minYaw!=-Math.PI)&&(c=!0),(this._maxPitch!=Math.PI||this._minPitch!=-Math.PI)&&(h=!0),c||h){let _=s._TmpMats[2],x=s._TmpMats[3];if(this.upAxisSpace==Ke.BONE&&l.y==1&&a)a.getRotationMatrixToRef(Ke.WORLD,this.mesh,_);else if(this.upAxisSpace==Ke.LOCAL&&l.y==1&&!a)_.copyFrom(o.getWorldMatrix());else{let C=s._TmpVecs[2];C.copyFrom(this._fowardAxis),this._transformYawPitch&&p.TransformCoordinatesToRef(C,this._transformYawPitchInv,C),a?a.getDirectionToRef(C,this.mesh,C):o.getDirectionToRef(C,C);let R=p.Cross(l,C);R.normalize(),C=p.Cross(R,l),N.FromXYZAxesToRef(R,l,C,_)}_.invertToRef(x);let b=null;if(h){let C=s._TmpVecs[3];i.subtractToRef(t,C),p.TransformCoordinatesToRef(C,x,C),b=Math.sqrt(C.x*C.x+C.z*C.z);let R=Math.atan2(C.y,b),E=R;R>this._maxPitch?(C.y=this._maxPitchTan*b,E=this._maxPitch):R<this._minPitch&&(C.y=this._minPitchTan*b,E=this._minPitch),R!=E&&(p.TransformCoordinatesToRef(C,_,C),C.addInPlace(t),i=C)}if(c){let C=s._TmpVecs[4];i.subtractToRef(t,C),p.TransformCoordinatesToRef(C,x,C);let R=Math.atan2(C.x,C.z),E=this.useAbsoluteValueForYaw?Math.abs(R):R,S=R;if((E>this._maxYaw||E<this._minYaw)&&(b==null&&(b=Math.sqrt(C.x*C.x+C.z*C.z)),this._yawRange>Math.PI?this._isAngleBetween(R,this._maxYaw,this._midYawConstraint)?(C.z=this._maxYawCos*b,C.x=this._maxYawSin*b,S=this._maxYaw):this._isAngleBetween(R,this._midYawConstraint,this._minYaw)&&(C.z=this._minYawCos*b,C.x=this._minYawSin*b,S=this._minYaw):E>this._maxYaw?(C.z=this._maxYawCos*b,C.x=this._maxYawSin*b,R<0&&this.useAbsoluteValueForYaw&&(C.x*=-1),S=this._maxYaw):E<this._minYaw&&(C.z=this._minYawCos*b,C.x=this._minYawSin*b,R<0&&this.useAbsoluteValueForYaw&&(C.x*=-1),S=this._minYaw)),this._slerping&&this._yawRange>Math.PI){let A=s._TmpVecs[8];A.copyFrom(qt.Z),this._transformYawPitch&&p.TransformCoordinatesToRef(A,this._transformYawPitchInv,A);let L=s._TmpMats[4];this._boneQuat.toRotationMatrix(L),this.mesh.getWorldMatrix().multiplyToRef(L,L),p.TransformCoordinatesToRef(A,L,A),p.TransformCoordinatesToRef(A,x,A);let G=Math.atan2(A.x,A.z),W=this._getAngleBetween(G,R),$=this._getAngleBetween(G,this._midYawConstraint);if(W>$){b==null&&(b=Math.sqrt(C.x*C.x+C.z*C.z));let re=this._getAngleBetween(G,this._maxYaw);this._getAngleBetween(G,this._minYaw)<re?(S=G+Math.PI*.75,C.z=Math.cos(S)*b,C.x=Math.sin(S)*b):(S=G-Math.PI*.75,C.z=Math.cos(S)*b,C.x=Math.sin(S)*b)}}R!=S&&(p.TransformCoordinatesToRef(C,_,C),C.addInPlace(t),i=C)}}let u=s._TmpVecs[5],d=s._TmpVecs[6],f=s._TmpVecs[7],m=s._TmpQuat,g=s._TmpVecs[9];i.subtractToRef(t,u),u.normalize(),p.CrossToRef(l,u,d),d.normalize(),p.CrossToRef(u,d,f),f.normalize(),N.FromXYZAxesToRef(d,f,u,r),!(d.x===0&&d.y===0&&d.z===0)&&(f.x===0&&f.y===0&&f.z===0||u.x===0&&u.y===0&&u.z===0||((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(N.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,n),n.multiplyToRef(r,r)),g.copyFrom(this.bone.getScale()),this.slerpAmount<1?(this._slerping||this.bone.getRotationQuaternionToRef(Ke.WORLD,this.mesh,this._boneQuat),this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),q.FromRotationMatrixToRef(r,m),q.SlerpToRef(this._boneQuat,m,this.slerpAmount,this._boneQuat),this.bone.setRotationQuaternion(this._boneQuat,Ke.WORLD,this.mesh),this._slerping=!0):(this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),this.bone.setRotationMatrix(r,Ke.WORLD,this.mesh),this._slerping=!1),this.bone.setScale(g),this._updateLinkedTransformRotation()))}_getAngleDiff(e,t){let i=t-e;return i%=Math.PI*2,i>Math.PI?i-=Math.PI*2:i<-Math.PI&&(i+=Math.PI*2),i}_getAngleBetween(e,t){e%=2*Math.PI,e=e<0?e+2*Math.PI:e,t%=2*Math.PI,t=t<0?t+2*Math.PI:t;let i=0;return e<t?i=t-e:i=e-t,i>Math.PI&&(i=Math.PI*2-i),i}_isAngleBetween(e,t,i){if(e%=2*Math.PI,e=e<0?e+2*Math.PI:e,t%=2*Math.PI,t=t<0?t+2*Math.PI:t,i%=2*Math.PI,i=i<0?i+2*Math.PI:i,t<i){if(e>t&&e<i)return!0}else if(e>i&&e<t)return!0;return!1}_updateLinkedTransformRotation(){let e=this.bone;e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new q),e.getRotationQuaternionToRef(Ke.LOCAL,null,e._linkedTransformNode.rotationQuaternion))}};im._TmpVecs=Ir.BuildArray(10,p.Zero);im._TmpQuat=q.Identity();im._TmpMats=Ir.BuildArray(5,N.Identity);var rm=(()=>{let s=new Uint8Array(4),e=new Uint32Array(s.buffer);return!!((e[0]=1)&s[0])})();Object.defineProperty(y.prototype,"effectiveByteStride",{get:function(){return this._alignedBuffer&&this._alignedBuffer.byteStride||this.byteStride},enumerable:!0,configurable:!0});Object.defineProperty(y.prototype,"effectiveByteOffset",{get:function(){return this._alignedBuffer?0:this.byteOffset},enumerable:!0,configurable:!0});Object.defineProperty(y.prototype,"effectiveBuffer",{get:function(){return this._alignedBuffer&&this._alignedBuffer.getBuffer()||this._buffer.getBuffer()},enumerable:!0,configurable:!0});y.prototype._rebuild=function(){this._buffer?._rebuild(),this._alignedBuffer?._rebuild()};y.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose(),this._alignedBuffer?.dispose(),this._alignedBuffer=void 0,this._isDisposed=!0};y.prototype.getWrapperBuffer=function(){return this._alignedBuffer||this._buffer};y.prototype._alignBuffer=function(){let s=this._buffer.getData();if(!this.engine._features.forceVertexBufferStrideAndOffsetMultiple4Bytes||this.byteStride%4===0&&this.byteOffset%4===0||!s)return;let e=y.GetTypeByteLength(this.type),t=this.byteStride+3&-4,i=t/e,r=this._maxVerticesCount,o=r*t/e,a;if(Array.isArray(s)){let u=new Float32Array(s);a=new DataView(u.buffer,u.byteOffset,u.byteLength)}else s instanceof ArrayBuffer?a=new DataView(s,0,s.byteLength):a=new DataView(s.buffer,s.byteOffset,s.byteLength);let l;this.type===y.BYTE?l=new Int8Array(o):this.type===y.UNSIGNED_BYTE?l=new Uint8Array(o):this.type===y.SHORT?l=new Int16Array(o):this.type===y.UNSIGNED_SHORT?l=new Uint16Array(o):this.type===y.INT?l=new Int32Array(o):this.type===y.UNSIGNED_INT?l=new Uint32Array(o):l=new Float32Array(o);let c=this.getSize(),h=this.byteOffset;for(let u=0;u<r;++u){for(let d=0;d<c;++d)switch(this.type){case y.BYTE:l[u*i+d]=a.getInt8(h+d);break;case y.UNSIGNED_BYTE:l[u*i+d]=a.getUint8(h+d);break;case y.SHORT:l[u*i+d]=a.getInt16(h+d*2,rm);break;case y.UNSIGNED_SHORT:l[u*i+d]=a.getUint16(h+d*2,rm);break;case y.INT:l[u*i+d]=a.getInt32(h+d*4,rm);break;case y.UNSIGNED_INT:l[u*i+d]=a.getUint32(h+d*4,rm);break;case y.FLOAT:l[u*i+d]=a.getFloat32(h+d*4,rm);break}h+=this.byteStride}this._alignedBuffer?.dispose(),this._alignedBuffer=new gi(this.engine,l,!1,t,!1,this.getIsInstanced(),!0,this.instanceDivisor,(this._label??"VertexBuffer")+"_aligned")};var th=class{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new U,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ae.POINTERWHEEL)return;let i=t.event,r=i.deltaMode===od.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*r*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*r*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*r*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ae.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}};v([I()],th.prototype,"wheelPrecisionX",void 0);v([I()],th.prototype,"wheelPrecisionY",void 0);v([I()],th.prototype,"wheelPrecisionZ",void 0);var ih=class{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments);let t=this.camera.getEngine(),i=t.getInputElement(),r=0,n=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=a=>{let l=a.event,c=l.pointerType==="touch";if(a.type!==Ae.POINTERMOVE&&this.buttons.indexOf(l.button)===-1)return;let h=l.target;if(this._altKey=l.altKey,this._ctrlKey=l.ctrlKey,this._metaKey=l.metaKey,this._shiftKey=l.shiftKey,this._buttonsPressed=l.buttons,t.isPointerLock){let u=l.movementX,d=l.movementY;this.onTouch(null,u,d),this._pointA=null,this._pointB=null}else{if(a.type!==Ae.POINTERDOWN&&a.type!==Ae.POINTERDOUBLETAP&&c&&this._pointA?.pointerId!==l.pointerId&&this._pointB?.pointerId!==l.pointerId)return;if(a.type===Ae.POINTERDOWN&&(this._currentActiveButton===-1||c)){try{h?.setPointerCapture(l.pointerId)}catch{}if(this._pointA===null)this._pointA={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType};else if(this._pointB===null)this._pointB={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType};else return;this._currentActiveButton===-1&&!c&&(this._currentActiveButton=l.button),this.onButtonDown(l),e||(l.preventDefault(),i&&i.focus())}else if(a.type===Ae.POINTERDOUBLETAP)this.onDoubleTap(l.pointerType);else if(a.type===Ae.POINTERUP&&(this._currentActiveButton===l.button||c)){try{h?.releasePointerCapture(l.pointerId)}catch{}c||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==l.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==l.pointerId?this._pointB=null:this._pointA=this._pointB=null,(r!==0||n)&&(this.onMultiTouch(this._pointA,this._pointB,r,0,n,null),r=0,n=null),this._currentActiveButton=-1,this.onButtonUp(l),e||l.preventDefault()}else if(a.type===Ae.POINTERMOVE){if(e||l.preventDefault(),this._pointA&&this._pointB===null){let u=l.clientX-this._pointA.x,d=l.clientY-this._pointA.y;this.onTouch(this._pointA,u,d),this._pointA.x=l.clientX,this._pointA.y=l.clientY}else if(this._pointA&&this._pointB){let u=this._pointA.pointerId===l.pointerId?this._pointA:this._pointB;u.x=l.clientX,u.y=l.clientY;let d=this._pointA.x-this._pointB.x,f=this._pointA.y-this._pointB.y,m=d*d+f*f,g={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:l.pointerId,type:a.type};this.onMultiTouch(this._pointA,this._pointB,r,m,n,g),n=g,r=m}}}},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ae.POINTERDOWN|Ae.POINTERUP|Ae.POINTERMOVE|Ae.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,r=0,n=null,this.onLostFocus()},this._contextMenuBind=a=>this.onContextMenu(a),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);let o=this.camera.getScene().getEngine().getHostWindow();o&&H.RegisterTopRootEvents(o,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){let e=this.camera.getScene().getEngine().getHostWindow();e&&H.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._contextMenuBind){let e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,r,n,o){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}};v([I()],ih.prototype,"buttons",void 0);var ii={},na=class{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){let t=e.getSimpleName();if(this.attached[t]){F.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(let t in this.attached){let i=this.attached[t];if(i===e){i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck();return}}}removeByType(e){for(let t in this.attached){let i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){let t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=Ce.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(let t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(let t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(let e in this.attached){let t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){let t={};for(let i in this.attached){let r=this.attached[i],n=ae.Serialize(r);t[r.getClassName()]=n}e.inputsmgr=t}parse(e){let t=e.inputsmgr;if(t){this.clear();for(let i in t){let r=ii[i];if(r){let n=t[i],o=ae.Parse(()=>new r,n,null);this.add(o)}}}else for(let i in this.attached){let r=ii[this.attached[i].getClassName()];if(r){let n=ae.Parse(()=>new r,e,null);this.remove(this.attached[i]),this.add(n)}}}};var Tr=(()=>{class s{get isConnected(){return this._isConnected}constructor(t,i,r,n=0,o=1,a=2,l=3){this.id=t,this.index=i,this.browserGamepad=r,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=s.GAMEPAD,this._leftStickAxisX=n,this._leftStickAxisY=o,this._rightStickAxisX=a,this._rightStickAxisY=l,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}onleftstickchanged(t){this._onleftstickchanged=t}onrightstickchanged(t){this._onrightstickchanged=t}get leftStick(){return this._leftStick}set leftStick(t){this._onleftstickchanged&&(this._leftStick.x!==t.x||this._leftStick.y!==t.y)&&this._onleftstickchanged(t),this._leftStick=t}get rightStick(){return this._rightStick}set rightStick(t){this._onrightstickchanged&&(this._rightStick.x!==t.x||this._rightStick.y!==t.y)&&this._onrightstickchanged(t),this._rightStick=t}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}return s.GAMEPAD=0,s.GENERIC=1,s.XBOX=2,s.POSE_ENABLED=3,s.DUALSHOCK=4,s})(),tv=class extends Tr{onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new U,this.onButtonUpObservable=new U,this.type=Tr.GENERIC,this._buttons=new Array(i.buttons.length)}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}};var rh=class{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){let e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==Tr.POSE_ENABLED&&(!this.gamepad||t.type===Tr.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(Tr.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){let e=this.camera,t=this.gamepad.rightStick;if(t){if(t.x!=0){let r=t.x/this.gamepadRotationSensibility;r!=0&&Math.abs(r)>.005&&(e.inertialAlphaOffset+=r)}if(t.y!=0){let r=t.y/this.gamepadRotationSensibility*this._yAxisScale;r!=0&&Math.abs(r)>.005&&(e.inertialBetaOffset+=r)}}let i=this.gamepad.leftStick;if(i&&i.y!=0){let r=i.y/this.gamepadMoveSensibility;r!=0&&Math.abs(r)>.005&&(this.camera.inertialRadiusOffset-=r)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}};v([I()],rh.prototype,"gamepadRotationSensibility",void 0);v([I()],rh.prototype,"gamepadMoveSensibility",void 0);ii.ArcRotateCameraGamepadInput=rh;var Ys=class{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let i=t.event;if(!i.metaKey){if(t.type===vo.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1){let r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){let e=this.camera;for(let t=0;t<this._keys.length;t++){let i=this._keys[t];this.keysLeft.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(i)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}};v([I()],Ys.prototype,"keysUp",void 0);v([I()],Ys.prototype,"keysDown",void 0);v([I()],Ys.prototype,"keysLeft",void 0);v([I()],Ys.prototype,"keysRight",void 0);v([I()],Ys.prototype,"keysReset",void 0);v([I()],Ys.prototype,"panningSensibility",void 0);v([I()],Ys.prototype,"zoomingSensibility",void 0);v([I()],Ys.prototype,"useAltToZoom",void 0);v([I()],Ys.prototype,"angularSpeed",void 0);ii.ArcRotateCameraKeyboardMoveInput=Ys;var SH=40,kl=class{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._viewOffset=new p(0,0,0),this._globalOffset=new p(0,0,0),this._inertialPanning=p.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0,r=e*.01*this.wheelDeltaPercentage*t;return e>0?i=r/(1+this.wheelDeltaPercentage):i=r*(1+this.wheelDeltaPercentage),i}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ae.POINTERWHEEL)return;let i=t.event,r=0,n=i.deltaMode===od.DOM_DELTA_LINE?SH:1,o=-(i.deltaY*n);if(this.customComputeDeltaFromMouseWheel)r=this.customComputeDeltaFromMouseWheel(o,this,i);else if(this.wheelDeltaPercentage){if(r=this._computeDeltaFromMouseWheelLegacyEvent(o,this.camera.radius),r>0){let a=this.camera.radius,l=this.camera.inertialRadiusOffset+r;for(let c=0;c<20&&Math.abs(l)>.001;c++)a-=l,l*=this.camera.inertia;a=xe.Clamp(a,0,Number.MAX_VALUE),r=this._computeDeltaFromMouseWheelLegacyEvent(o,a)}}else r=o/(this.wheelPrecision*40);r&&(this.zoomToMouseLocation?(this._hitPlane||this._updateHitPlane(),this._zoomToMouse(r)):this.camera.inertialRadiusOffset+=r),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ae.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;let e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){let e=this.camera,t=e.target.subtract(e.position);this._hitPlane=zs.FromPositionAndNormal(e.target,t)}_getPosition(){let e=this.camera,t=e.getScene(),i=t.createPickingRay(t.pointerX,t.pointerY,N.Identity(),e,!1);(e.targetScreenOffset.x!==0||e.targetScreenOffset.y!==0)&&(this._viewOffset.set(e.targetScreenOffset.x,e.targetScreenOffset.y,0),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),this._globalOffset=p.TransformNormal(this._viewOffset,e._cameraTransformMatrix),i.origin.addInPlace(this._globalOffset));let r=0;return this._hitPlane&&(r=i.intersectsPlane(this._hitPlane)??0),i.origin.addInPlace(i.direction.scaleInPlace(r))}_zoomToMouse(e){let t=this.camera,i=1-t.inertia;if(t.lowerRadiusLimit){let l=t.lowerRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i<l&&(e=(t.radius-l)*i-t.inertialRadiusOffset)}if(t.upperRadiusLimit){let l=t.upperRadiusLimit??0;t.radius-(t.inertialRadiusOffset+e)/i>l&&(e=(t.radius-l)*i-t.inertialRadiusOffset)}let n=e/i/t.radius,o=this._getPosition(),a=O.Vector3[6];o.subtractToRef(t.target,a),a.scaleInPlace(n),a.scaleInPlace(i),this._inertialPanning.addInPlace(a),t.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<je&&(e.x=0),Math.abs(e.y)<je&&(e.y=0),Math.abs(e.z)<je&&(e.z=0)}};v([I()],kl.prototype,"wheelPrecision",void 0);v([I()],kl.prototype,"zoomToMouseLocation",void 0);v([I()],kl.prototype,"wheelDeltaPercentage",void 0);ii.ArcRotateCameraMouseWheelInput=kl;var gs=class s extends ih{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(this.panningSensibility!==0&&e&&t){let i=t.x-e.x,r=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=r/this.panningSensibility}}_computePinchZoom(e,t){let i=this.camera.radius||s.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(t-e)*.001*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,r,n,o){i===0&&n===null||r===0&&o===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,r),this._computeMultiTouchPanning(n,o)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(r)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,r),this._isPinching=!0):this._computeMultiTouchPanning(n,o)):this.multiTouchPanning?this._computeMultiTouchPanning(n,o):this.pinchZoom&&this._computePinchZoom(i,r))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(e){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}};gs.MinimumRadiusForPinch=.001;v([I()],gs.prototype,"buttons",void 0);v([I()],gs.prototype,"angularSensibilityX",void 0);v([I()],gs.prototype,"angularSensibilityY",void 0);v([I()],gs.prototype,"pinchPrecision",void 0);v([I()],gs.prototype,"pinchDeltaPercentage",void 0);v([I()],gs.prototype,"useNaturalPinchZoom",void 0);v([I()],gs.prototype,"pinchZoom",void 0);v([I()],gs.prototype,"panningSensibility",void 0);v([I()],gs.prototype,"multiTouchPanning",void 0);v([I()],gs.prototype,"multiTouchPanAndZoom",void 0);ii.ArcRotateCameraPointersInput=gs;var Gl=class extends na{constructor(e){super(e)}addMouseWheel(){return this.add(new kl),this}addPointers(){return this.add(new gs),this}addKeyboard(){return this.add(new Ys),this}};Gl.prototype.addVRDeviceOrientation=function(){return this.add(new iv),this};var iv=class{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=e=>this._onOrientationEvent(e)}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);let t=this.camera.getScene().getEngine().getHostWindow();t&&(typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t.addEventListener("deviceorientation",this._deviceOrientationHandler):H.Warn("Permission not granted.")}).catch(i=>{H.Error(i)}):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){e.alpha!==null&&(this._alpha=(+e.alpha|0)*this.alphaCorrection),e.gamma!==null&&(this._gamma=(+e.gamma|0)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}};ii.ArcRotateCameraVRDeviceOrientationInput=iv;var yo=class{constructor(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=new Array}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let i=t.event;if(t.type===vo.KEYDOWN)(this.keysForward.indexOf(i.keyCode)!==-1||this.keysBackward.indexOf(i.keyCode)!==-1||this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysForward.indexOf(i.keyCode)!==-1||this.keysBackward.indexOf(i.keyCode)!==-1||this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1){let r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),e||i.preventDefault()}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}getClassName(){return"FlyCameraKeyboardInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}checkInputs(){if(this._onKeyboardObserver){let e=this.camera;for(let t=0;t<this._keys.length;t++){let i=this._keys[t],r=e._computeLocalCameraSpeed();this.keysForward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysBackward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysLeft.indexOf(i)!==-1&&e._localDirection.copyFromFloats(-r,0,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),p.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}};v([I()],yo.prototype,"keysForward",void 0);v([I()],yo.prototype,"keysBackward",void 0);v([I()],yo.prototype,"keysUp",void 0);v([I()],yo.prototype,"keysDown",void 0);v([I()],yo.prototype,"keysRight",void 0);v([I()],yo.prototype,"keysLeft",void 0);ii.FlyCameraKeyboardInput=yo;var sh=class{constructor(){this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this._previousPosition=null}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments),this._noPreventDefault=e,this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(t=>{this._pointerInput(t)},Ae.POINTERDOWN|Ae.POINTERUP|Ae.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add(()=>{this.camera.rollCorrect&&this.camera.restoreRoll(this.camera.rollCorrect)})}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this._previousPosition=null,this._noPreventDefault=void 0)}getClassName(){return"FlyCameraMouseInput"}getSimpleName(){return"mouse"}_pointerInput(e){let t=e.event,r=this.camera.getEngine();if(!this.touchEnabled&&t.pointerType==="touch"||e.type!==Ae.POINTERMOVE&&this.buttons.indexOf(t.button)===-1)return;let n=t.target;if(e.type===Ae.POINTERDOWN){try{n?.setPointerCapture(t.pointerId)}catch{}this._previousPosition={x:t.clientX,y:t.clientY},this.activeButton=t.button,this._noPreventDefault||(t.preventDefault(),this._element.focus()),r.isPointerLock&&this._onMouseMove(e.event)}else if(e.type===Ae.POINTERUP){try{n?.releasePointerCapture(t.pointerId)}catch{}this.activeButton=-1,this._previousPosition=null,this._noPreventDefault||t.preventDefault()}else if(e.type===Ae.POINTERMOVE){if(!this._previousPosition){r.isPointerLock&&this._onMouseMove(e.event);return}let o=t.clientX-this._previousPosition.x,a=t.clientY-this._previousPosition.y;this._rotateCamera(o,a),this._previousPosition={x:t.clientX,y:t.clientY},this._noPreventDefault||t.preventDefault()}}_onMouseMove(e){if(!this.camera.getEngine().isPointerLock)return;let r=e.movementX,n=e.movementY;this._rotateCamera(r,n),this._previousPosition=null,this._noPreventDefault||e.preventDefault()}_rotateCamera(e,t){let i=this.camera,r=i._calculateHandednessMultiplier();e*=r;let n=e/this.angularSensibility,o=t/this.angularSensibility,a=q.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z),l;if(this.buttonsPitch.some(c=>c===this.activeButton)&&(l=q.RotationAxis(qt.X,o),a.multiplyInPlace(l)),this.buttonsYaw.some(c=>c===this.activeButton)){l=q.RotationAxis(qt.Y,n),a.multiplyInPlace(l);let c=i.bankedTurnLimit+i._trackRoll;if(i.bankedTurn&&-c<i.rotation.z&&i.rotation.z<c){let h=i.bankedTurnMultiplier*-n;l=q.RotationAxis(qt.Z,h),a.multiplyInPlace(l)}}this.buttonsRoll.some(c=>c===this.activeButton)&&(l=q.RotationAxis(qt.Z,-n),i._trackRoll-=n,a.multiplyInPlace(l)),a.toEulerAnglesToRef(i.rotation)}};v([I()],sh.prototype,"buttons",void 0);v([I()],sh.prototype,"angularSensibility",void 0);ii.FlyCameraMouseInput=sh;var ar=class{constructor(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this._keys=new Array}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let i=t.event;if(!i.metaKey){if(t.type===vo.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,this._shiftPressed=i.shiftKey,(this.keysHeightOffsetIncr.indexOf(i.keyCode)!==-1||this.keysHeightOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetIncr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRadiusIncr.indexOf(i.keyCode)!==-1||this.keysRadiusDecr.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysHeightOffsetIncr.indexOf(i.keyCode)!==-1||this.keysHeightOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetIncr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRadiusIncr.indexOf(i.keyCode)!==-1||this.keysRadiusDecr.indexOf(i.keyCode)!==-1){let r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){this._onKeyboardObserver&&this._keys.forEach(e=>{this.keysHeightOffsetIncr.indexOf(e)!==-1&&this._modifierHeightOffset()?this.camera.heightOffset+=this.heightSensibility:this.keysHeightOffsetDecr.indexOf(e)!==-1&&this._modifierHeightOffset()?this.camera.heightOffset-=this.heightSensibility:this.keysRotationOffsetIncr.indexOf(e)!==-1&&this._modifierRotationOffset()?(this.camera.rotationOffset+=this.rotationSensibility,this.camera.rotationOffset%=360):this.keysRotationOffsetDecr.indexOf(e)!==-1&&this._modifierRotationOffset()?(this.camera.rotationOffset-=this.rotationSensibility,this.camera.rotationOffset%=360):this.keysRadiusIncr.indexOf(e)!==-1&&this._modifierRadius()?this.camera.radius+=this.radiusSensibility:this.keysRadiusDecr.indexOf(e)!==-1&&this._modifierRadius()&&(this.camera.radius-=this.radiusSensibility)})}getClassName(){return"FollowCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}_modifierHeightOffset(){return this.keysHeightOffsetModifierAlt===this._altPressed&&this.keysHeightOffsetModifierCtrl===this._ctrlPressed&&this.keysHeightOffsetModifierShift===this._shiftPressed}_modifierRotationOffset(){return this.keysRotationOffsetModifierAlt===this._altPressed&&this.keysRotationOffsetModifierCtrl===this._ctrlPressed&&this.keysRotationOffsetModifierShift===this._shiftPressed}_modifierRadius(){return this.keysRadiusModifierAlt===this._altPressed&&this.keysRadiusModifierCtrl===this._ctrlPressed&&this.keysRadiusModifierShift===this._shiftPressed}};v([I()],ar.prototype,"keysHeightOffsetIncr",void 0);v([I()],ar.prototype,"keysHeightOffsetDecr",void 0);v([I()],ar.prototype,"keysHeightOffsetModifierAlt",void 0);v([I()],ar.prototype,"keysHeightOffsetModifierCtrl",void 0);v([I()],ar.prototype,"keysHeightOffsetModifierShift",void 0);v([I()],ar.prototype,"keysRotationOffsetIncr",void 0);v([I()],ar.prototype,"keysRotationOffsetDecr",void 0);v([I()],ar.prototype,"keysRotationOffsetModifierAlt",void 0);v([I()],ar.prototype,"keysRotationOffsetModifierCtrl",void 0);v([I()],ar.prototype,"keysRotationOffsetModifierShift",void 0);v([I()],ar.prototype,"keysRadiusIncr",void 0);v([I()],ar.prototype,"keysRadiusDecr",void 0);v([I()],ar.prototype,"keysRadiusModifierAlt",void 0);v([I()],ar.prototype,"keysRadiusModifierCtrl",void 0);v([I()],ar.prototype,"keysRadiusModifierShift",void 0);v([I()],ar.prototype,"heightSensibility",void 0);v([I()],ar.prototype,"rotationSensibility",void 0);v([I()],ar.prototype,"radiusSensibility",void 0);ii.FollowCameraKeyboardMoveInput=ar;var oa=class{constructor(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ae.POINTERWHEEL)return;let i=t.event,r=0,n=Math.max(-1,Math.min(1,i.deltaY));this.wheelDeltaPercentage?(+this.axisControlRadius+ +this.axisControlHeight+ +this.axisControlRotation&&F.Warn("wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+this.axisControlRadius+", axisControlHeightOffset: "+this.axisControlHeight+", axisControlRotationOffset: "+this.axisControlRotation),this.axisControlRadius?r=n*.01*this.wheelDeltaPercentage*this.camera.radius:this.axisControlHeight?r=n*.01*this.wheelDeltaPercentage*this.camera.heightOffset:this.axisControlRotation&&(r=n*.01*this.wheelDeltaPercentage*this.camera.rotationOffset)):r=n*this.wheelPrecision,r&&(this.axisControlRadius?this.camera.radius+=r:this.axisControlHeight?this.camera.heightOffset-=r:this.axisControlRotation&&(this.camera.rotationOffset-=r)),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,Ae.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}};v([I()],oa.prototype,"axisControlRadius",void 0);v([I()],oa.prototype,"axisControlHeight",void 0);v([I()],oa.prototype,"axisControlRotation",void 0);v([I()],oa.prototype,"wheelPrecision",void 0);v([I()],oa.prototype,"wheelDeltaPercentage",void 0);ii.FollowCameraMouseWheelInput=oa;var jr=class extends ih{constructor(){super(...arguments),this.angularSensibilityX=1,this.angularSensibilityY=1,this.pinchPrecision=1e4,this.pinchDeltaPercentage=0,this.axisXControlRadius=!1,this.axisXControlHeight=!1,this.axisXControlRotation=!0,this.axisYControlRadius=!1,this.axisYControlHeight=!0,this.axisYControlRotation=!1,this.axisPinchControlRadius=!0,this.axisPinchControlHeight=!1,this.axisPinchControlRotation=!1,this.warningEnable=!0,this._warningCounter=0}getClassName(){return"FollowCameraPointersInput"}onTouch(e,t,i){this._warning(),this.axisXControlRotation?this.camera.rotationOffset+=t/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=i/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=t/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=i/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=t/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=i/this.angularSensibilityY)}onMultiTouch(e,t,i,r,n,o){if(i===0&&n===null||r===0&&o===null)return;let a=(r-i)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(a*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=a*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=a*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=a*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=a),this.axisPinchControlHeight&&(this.camera.heightOffset+=a),this.axisPinchControlRadius&&(this.camera.radius-=a))}_warning(){if(!this.warningEnable||this._warningCounter++%100!==0)return;let e="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";+this.axisXControlRotation+ +this.axisXControlHeight+ +this.axisXControlRadius<=1&&F.Warn(e+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),+this.axisYControlRotation+ +this.axisYControlHeight+ +this.axisYControlRadius<=1&&F.Warn(e+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),+this.axisPinchControlRotation+ +this.axisPinchControlHeight+ +this.axisPinchControlRadius<=1&&F.Warn(e+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}};v([I()],jr.prototype,"angularSensibilityX",void 0);v([I()],jr.prototype,"angularSensibilityY",void 0);v([I()],jr.prototype,"pinchPrecision",void 0);v([I()],jr.prototype,"pinchDeltaPercentage",void 0);v([I()],jr.prototype,"axisXControlRadius",void 0);v([I()],jr.prototype,"axisXControlHeight",void 0);v([I()],jr.prototype,"axisXControlRotation",void 0);v([I()],jr.prototype,"axisYControlRadius",void 0);v([I()],jr.prototype,"axisYControlHeight",void 0);v([I()],jr.prototype,"axisYControlRotation",void 0);v([I()],jr.prototype,"axisPinchControlRadius",void 0);v([I()],jr.prototype,"axisPinchControlHeight",void 0);v([I()],jr.prototype,"axisPinchControlRotation",void 0);ii.FollowCameraPointersInput=jr;var _s=class{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this.keysRotateUp=[],this.keysRotateDown=[],this._keys=new Array}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let i=t.event;if(!i.metaKey){if(t.type===vo.KEYDOWN)(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1||this.keysRotateUp.indexOf(i.keyCode)!==-1||this.keysRotateDown.indexOf(i.keyCode)!==-1){let r=this._keys.indexOf(i.keyCode);r>=0&&this._keys.splice(r,1),e||i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){let e=this.camera;for(let t=0;t<this._keys.length;t++){let i=this._keys[t],r=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-r,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,r):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(r,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-r):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,r,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-r,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()):this.keysRotateUp.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x-=this._getLocalRotation()):this.keysRotateDown.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.x+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),p.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){let e=this.camera._calculateHandednessMultiplier();return this.rotationSpeed*this._engine.getDeltaTime()/1e3*e}};v([I()],_s.prototype,"keysUp",void 0);v([I()],_s.prototype,"keysUpward",void 0);v([I()],_s.prototype,"keysDown",void 0);v([I()],_s.prototype,"keysDownward",void 0);v([I()],_s.prototype,"keysLeft",void 0);v([I()],_s.prototype,"keysRight",void 0);v([I()],_s.prototype,"rotationSpeed",void 0);v([I()],_s.prototype,"keysRotateLeft",void 0);v([I()],_s.prototype,"keysRotateRight",void 0);v([I()],_s.prototype,"keysRotateUp",void 0);v([I()],_s.prototype,"keysRotateDown",void 0);ii.FreeCameraKeyboardMoveInput=_s;var nh=class{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new U,this._allowCameraRotation=!0,this._currentActiveButton=-1,this._activePointerId=-1}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments);let t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=r=>{let n=r.event,o=n.pointerType==="touch";if(!this.touchEnabled&&o||r.type!==Ae.POINTERMOVE&&this.buttons.indexOf(n.button)===-1)return;let a=n.target;if(r.type===Ae.POINTERDOWN){if(o&&this._activePointerId!==-1||!o&&this._currentActiveButton!==-1)return;this._activePointerId=n.pointerId;try{a?.setPointerCapture(n.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=n.button),this._previousPosition={x:n.clientX,y:n.clientY},e||(n.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(r.event)}else if(r.type===Ae.POINTERUP){if(o&&this._activePointerId!==n.pointerId||!o&&this._currentActiveButton!==n.button)return;try{a?.releasePointerCapture(n.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||n.preventDefault(),this._activePointerId=-1}else if(r.type===Ae.POINTERMOVE&&(this._activePointerId===n.pointerId||!o)){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(r.event);else if(this._previousPosition){let l=this.camera._calculateHandednessMultiplier(),c=(n.clientX-this._previousPosition.x)*l,h=n.clientY-this._previousPosition.y;this._allowCameraRotation&&(this.camera.cameraRotation.y+=c/this.angularSensibility,this.camera.cameraRotation.x+=h/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:c,offsetY:h}),this._previousPosition={x:n.clientX,y:n.clientY},e||n.preventDefault()}}}),this._onMouseMove=r=>{if(!t.isPointerLock)return;let n=this.camera._calculateHandednessMultiplier(),o=r.movementX*n;this.camera.cameraRotation.y+=o/this.angularSensibility;let a=r.movementY;this.camera.cameraRotation.x+=a/this.angularSensibility,this._previousPosition=null,e||r.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ae.POINTERDOWN|Ae.POINTERUP|Ae.POINTERMOVE),i&&(this._contextMenuBind=r=>this.onContextMenu(r),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._contextMenuBind){let t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._activePointerId=-1,this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}};v([I()],nh.prototype,"buttons",void 0);v([I()],nh.prototype,"angularSensibility",void 0);ii.FreeCameraMouseInput=nh;var fi=function(s){return s[s.MoveRelative=0]="MoveRelative",s[s.RotateRelative=1]="RotateRelative",s[s.MoveScene=2]="MoveScene",s}(fi||{}),$s=class extends th{constructor(){super(...arguments),this._moveRelative=p.Zero(),this._rotateRelative=p.Zero(),this._moveScene=p.Zero(),this._wheelXAction=fi.MoveRelative,this._wheelXActionCoordinate=Xc.X,this._wheelYAction=fi.MoveRelative,this._wheelYActionCoordinate=Xc.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==fi.MoveRelative||(this._wheelXAction=fi.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==fi.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==fi.MoveRelative||(this._wheelYAction=fi.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==fi.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==fi.MoveRelative||(this._wheelZAction=fi.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==fi.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==fi.RotateRelative||(this._wheelXAction=fi.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==fi.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==fi.RotateRelative||(this._wheelYAction=fi.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==fi.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==fi.RotateRelative||(this._wheelZAction=fi.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==fi.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==fi.MoveScene||(this._wheelXAction=fi.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==fi.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==fi.MoveScene||(this._wheelYAction=fi.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==fi.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==fi.MoveScene||(this._wheelZAction=fi.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==fi.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);let e=N.Zero();this.camera.getViewMatrix().invertToRef(e);let t=p.Zero();p.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(e===0||t===null||i===null)return;let r=null;switch(t){case fi.MoveRelative:r=this._moveRelative;break;case fi.RotateRelative:r=this._rotateRelative;break;case fi.MoveScene:r=this._moveScene;break}switch(i){case Xc.X:r.set(e,0,0);break;case Xc.Y:r.set(0,e,0);break;case Xc.Z:r.set(0,0,e);break}}};v([I()],$s.prototype,"wheelXMoveRelative",null);v([I()],$s.prototype,"wheelYMoveRelative",null);v([I()],$s.prototype,"wheelZMoveRelative",null);v([I()],$s.prototype,"wheelXRotateRelative",null);v([I()],$s.prototype,"wheelYRotateRelative",null);v([I()],$s.prototype,"wheelZRotateRelative",null);v([I()],$s.prototype,"wheelXMoveScene",null);v([I()],$s.prototype,"wheelYMoveScene",null);v([I()],$s.prototype,"wheelZMoveScene",null);ii.FreeCameraMouseWheelInput=$s;var oh=class{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=H.IsSafari()}attachControl(e){e=H.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{let r=i.event,n=r.pointerType==="mouse"||this._isSafari&&typeof r.pointerType>"u";if(!(!this.allowMouse&&n)){if(i.type===Ae.POINTERDOWN){if(e||r.preventDefault(),this._pointerPressed.push(r.pointerId),this._pointerPressed.length!==1)return;t={x:r.clientX,y:r.clientY}}else if(i.type===Ae.POINTERUP){e||r.preventDefault();let o=this._pointerPressed.indexOf(r.pointerId);if(o===-1||(this._pointerPressed.splice(o,1),o!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===Ae.POINTERMOVE){if(e||r.preventDefault(),!t||this._pointerPressed.indexOf(r.pointerId)!=0)return;this._offsetX=r.clientX-t.x,this._offsetY=-(r.clientY-t.y)}}}),this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._pointerInput,Ae.POINTERDOWN|Ae.POINTERUP|Ae.POINTERMOVE),this._onLostFocus){let r=this.camera.getEngine().getInputElement();r&&r.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null),this._onLostFocus){let t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;let e=this.camera,t=e._calculateHandednessMultiplier();if(e.cameraRotation.y=t*this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{let r=e._computeLocalCameraSpeed(),n=new p(0,0,this.touchMoveSensibility!==0?r*this._offsetY/this.touchMoveSensibility:0);N.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(p.TransformCoordinates(n,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}};v([I()],oh.prototype,"touchAngularSensibility",void 0);v([I()],oh.prototype,"touchMoveSensibility",void 0);ii.FreeCameraTouchInput=oh;var aa=class extends na{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new _s),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new nh(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new $s,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new oh),this}clear(){super.clear(),this._mouseInput=null}};aa.prototype.addDeviceOrientation=function(s){return this._deviceOrientationInput||(this._deviceOrientationInput=new rv,s&&(this._deviceOrientationInput.smoothFactor=s),this.add(this._deviceOrientationInput)),this};var rv=class{static WaitForOrientationChangeAsync(e){return new Promise((t,i)=>{let r=!1,n=()=>{window.removeEventListener("deviceorientation",n),r=!0,t()};e&&setTimeout(()=>{r||(window.removeEventListener("deviceorientation",n),i("WaitForOrientationChangeAsync timed out"))},e),typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(o=>{o=="granted"?window.addEventListener("deviceorientation",n):H.Warn("Permission not granted.")}).catch(o=>{H.Error(o)}):window.addEventListener("deviceorientation",n)})}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new q,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new U,this._orientationChanged=()=>{this._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-H.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=e.alpha!==null?H.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=e.beta!==null?H.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=e.gamma!==null?H.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=e.alpha!==null?e.alpha:0,this._beta=e.beta!==null?e.beta:0,this._gamma=e.gamma!==null?e.gamma:0),e.alpha!==null&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTranform=new q(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new q),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){let e=this.camera.getScene().getEngine().getHostWindow();if(e){let t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t():H.Warn("Permission not granted.")}).catch(i=>{H.Error(i)}):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(q.RotationYawPitchRollToRef(H.ToRadians(this._alpha),H.ToRadians(this._beta),-H.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}};ii.FreeCameraDeviceOrientationInput=rv;var ah=class{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=N.Identity(),this._deltaTransform=p.Zero(),this._vector3=p.Zero(),this._vector2=j.Zero()}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){let e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==Tr.POSE_ENABLED&&(!this.gamepad||t.type===Tr.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(Tr.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){let e=this.camera,t=this.gamepad.leftStick;this.gamepadMoveSensibility!==0&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&this.gamepadAngularSensibility!==0?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):N.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);let r=e._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(t.x*r,0,-t.y*r),p.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}};v([I()],ah.prototype,"gamepadAngularSensibility",void 0);v([I()],ah.prototype,"gamepadMoveSensibility",void 0);ii.FreeCameraGamepadInput=ah;var fr=function(s){return s[s.X=0]="X",s[s.Y=1]="Y",s[s.Z=2]="Z",s}(fr||{}),PI=(()=>{class s{static _GetDefaultOptions(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}}constructor(t,i){this._released=!1;let r=ie(ie({},s._GetDefaultOptions()),i);if(t?this._leftJoystick=!0:this._leftJoystick=!1,s._GlobalJoystickIndex++,this._axisTargetedByLeftAndRight=fr.X,this._axisTargetedByUpAndDown=fr.Y,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new Wc,this.deltaPosition=p.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=()=>{s._VJCanvasWidth=window.innerWidth,s._VJCanvasHeight=window.innerHeight,s.Canvas&&(s.Canvas.width=s._VJCanvasWidth,s.Canvas.height=s._VJCanvasHeight),s._HalfWidth=s._VJCanvasWidth/2},!s.Canvas){window.addEventListener("resize",this._onResize,!1),s.Canvas=document.createElement("canvas"),s._VJCanvasWidth=window.innerWidth,s._VJCanvasHeight=window.innerHeight,s.Canvas.width=window.innerWidth,s.Canvas.height=window.innerHeight,s.Canvas.style.width="100%",s.Canvas.style.height="100%",s.Canvas.style.position="absolute",s.Canvas.style.backgroundColor="transparent",s.Canvas.style.top="0px",s.Canvas.style.left="0px",s.Canvas.style.zIndex="5",s.Canvas.style.touchAction="none",s.Canvas.setAttribute("touch-action","none");let n=s.Canvas.getContext("2d");if(!n)throw new Error("Unable to create canvas for virtual joystick");s._VJCanvasContext=n,s._VJCanvasContext.strokeStyle="#ffffff",s._VJCanvasContext.lineWidth=2,document.body.appendChild(s.Canvas)}s._HalfWidth=s.Canvas.width/2,this.pressed=!1,this.limitToContainer=r.limitToContainer,this._joystickColor=r.color,this.containerSize=r.containerSize,this.puckSize=r.puckSize,r.position&&this.setPosition(r.position.x,r.position.y),r.puckImage&&this.setPuckImage(r.puckImage),r.containerImage&&this.setContainerImage(r.containerImage),r.alwaysVisible&&s._AlwaysVisibleSticks++,this.alwaysVisible=r.alwaysVisible,this._joystickPointerId=-1,this._joystickPointerPos=new j(0,0),this._joystickPreviousPointerPos=new j(0,0),this._joystickPointerStartPos=new j(0,0),this._deltaJoystickVector=new j(0,0),this._onPointerDownHandlerRef=n=>{this._onPointerDown(n)},this._onPointerMoveHandlerRef=n=>{this._onPointerMove(n)},this._onPointerUpHandlerRef=n=>{this._onPointerUp(n)},s.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),s.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),s.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),s.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),s.Canvas.addEventListener("contextmenu",n=>{n.preventDefault()},!1),requestAnimationFrame(()=>{this._drawVirtualJoystick()})}setJoystickSensibility(t){this._joystickSensibility=t,this._inversedSensibility=1/(this._joystickSensibility/1e3)}_onPointerDown(t){let i;t.preventDefault(),this._leftJoystick===!0?i=t.clientX<s._HalfWidth:i=t.clientX>s._HalfWidth,i&&this._joystickPointerId<0?(this._joystickPointerId=t.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(t)):(this._joystickPointerStartPos.x=t.clientX,this._joystickPointerStartPos.y=t.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(t.pointerId.toString(),t)):s._GlobalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(t.pointerId.toString(),{x:t.clientX,y:t.clientY,prevX:t.clientX,prevY:t.clientY}))}_onPointerMove(t){if(this._joystickPointerId==t.pointerId){if(this.limitToContainer){let a=new j(t.clientX-this._joystickPointerStartPos.x,t.clientY-this._joystickPointerStartPos.y),l=a.length();l>this.containerSize&&a.scaleInPlace(this.containerSize/l),this._joystickPointerPos.x=this._joystickPointerStartPos.x+a.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+a.y}else this._joystickPointerPos.x=t.clientX,this._joystickPointerPos.y=t.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<s._AlwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(s._HalfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(s._HalfWidth,this._joystickPointerPos.x));let r=(this.reverseLeftRight?-1:1)*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case fr.X:this.deltaPosition.x=Math.min(1,Math.max(-1,r));break;case fr.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,r));break;case fr.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,r));break}let o=(this.reverseUpDown?1:-1)*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case fr.X:this.deltaPosition.x=Math.min(1,Math.max(-1,o));break;case fr.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,o));break;case fr.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,o));break}}else{let i=this._touches.get(t.pointerId.toString());i&&(i.x=t.clientX,i.y=t.clientY)}}_onPointerUp(t){if(this._joystickPointerId==t.pointerId)this._clearPreviousDraw(),this._joystickPointerId=-1,this.pressed=!1;else{let i=this._touches.get(t.pointerId.toString());i&&s._VJCanvasContext.clearRect(i.prevX-44,i.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(t.pointerId.toString())}setJoystickColor(t){this._joystickColor=t}set containerSize(t){this._joystickContainerSize=t,this._clearContainerSize=~~(this._joystickContainerSize*2.1),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)}get containerSize(){return this._joystickContainerSize}set puckSize(t){this._joystickPuckSize=t,this._clearPuckSize=~~(this._joystickPuckSize*2.1),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)}get puckSize(){return this._joystickPuckSize}clearPosition(){this.alwaysVisible=!1,this._joystickPosition=null}set alwaysVisible(t){this._alwaysVisible!==t&&(t&&this._joystickPosition?(s._AlwaysVisibleSticks++,this._alwaysVisible=!0):(s._AlwaysVisibleSticks--,this._alwaysVisible=!1))}get alwaysVisible(){return this._alwaysVisible}setPosition(t,i){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new j(t,i)}setActionOnTouch(t){this._action=t}setAxisForLeftRight(t){switch(t){case fr.X:case fr.Y:case fr.Z:this._axisTargetedByLeftAndRight=t;break;default:this._axisTargetedByLeftAndRight=fr.X;break}}setAxisForUpDown(t){switch(t){case fr.X:case fr.Y:case fr.Z:this._axisTargetedByUpAndDown=t;break;default:this._axisTargetedByUpAndDown=fr.Y;break}}_clearPreviousDraw(){let t=this._joystickPosition||this._joystickPointerStartPos;s._VJCanvasContext.clearRect(t.x-this._clearContainerSizeOffset,t.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),s._VJCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset-1,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset-1,this._clearPuckSize+2,this._clearPuckSize+2)}setContainerImage(t){let i=new Image;i.src=t,i.onload=()=>this._containerImage=i}setPuckImage(t){let i=new Image;i.src=t,i.onload=()=>this._puckImage=i}_drawContainer(){let t=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?s._VJCanvasContext.drawImage(this._containerImage,t.x-this.containerSize,t.y-this.containerSize,this.containerSize*2,this.containerSize*2):(s._VJCanvasContext.beginPath(),s._VJCanvasContext.strokeStyle=this._joystickColor,s._VJCanvasContext.lineWidth=2,s._VJCanvasContext.arc(t.x,t.y,this.containerSize,0,Math.PI*2,!0),s._VJCanvasContext.stroke(),s._VJCanvasContext.closePath(),s._VJCanvasContext.beginPath(),s._VJCanvasContext.lineWidth=6,s._VJCanvasContext.strokeStyle=this._joystickColor,s._VJCanvasContext.arc(t.x,t.y,this.puckSize,0,Math.PI*2,!0),s._VJCanvasContext.stroke(),s._VJCanvasContext.closePath())}_drawPuck(){this._puckImage?s._VJCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,this.puckSize*2,this.puckSize*2):(s._VJCanvasContext.beginPath(),s._VJCanvasContext.strokeStyle=this._joystickColor,s._VJCanvasContext.lineWidth=2,s._VJCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,Math.PI*2,!0),s._VJCanvasContext.stroke(),s._VJCanvasContext.closePath())}_drawVirtualJoystick(){this._released||(this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach((t,i)=>{i.pointerId===this._joystickPointerId?(this.alwaysVisible||this._drawContainer(),this._drawPuck(),this._joystickPreviousPointerPos=this._joystickPointerPos.clone()):(s._VJCanvasContext.clearRect(i.prevX-44,i.prevY-44,88,88),s._VJCanvasContext.beginPath(),s._VJCanvasContext.fillStyle="white",s._VJCanvasContext.beginPath(),s._VJCanvasContext.strokeStyle="red",s._VJCanvasContext.lineWidth=6,s._VJCanvasContext.arc(i.x,i.y,40,0,Math.PI*2,!0),s._VJCanvasContext.stroke(),s._VJCanvasContext.closePath(),i.prevX=i.x,i.prevY=i.y)}),requestAnimationFrame(()=>{this._drawVirtualJoystick()}))}releaseCanvas(){s.Canvas&&(s.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),s.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),s.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),s.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(s.Canvas),s.Canvas=null),this._released=!0}}return s._GlobalJoystickIndex=0,s._AlwaysVisibleSticks=0,s})();aa.prototype.addVirtualJoystick=function(){return this.add(new sv),this};var sv=class{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){let e=this.camera,t=e._computeLocalCameraSpeed()*50,i=N.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),r=p.TransformCoordinates(new p(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(r),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new PI(!0),this._leftjoystick.setAxisForUpDown(fr.Z),this._leftjoystick.setAxisForLeftRight(fr.X),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new PI(!1),this._rightjoystick.setAxisForUpDown(fr.X),this._rightjoystick.setAxisForLeftRight(fr.Y),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}};ii.FreeCameraVirtualJoystickInput=sv;Xe.AddNodeConstructor("TargetCamera",(s,e)=>()=>new lr(s,p.Zero(),e));var lr=class s extends Ce{constructor(e,t,i,r=!0){super(e,t,i,r),this._tmpUpVector=p.Zero(),this._tmpTargetVector=p.Zero(),this.cameraDirection=new p(0,0,0),this.cameraRotation=new j(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new q,this.rotation=new p(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=p.Zero(),this._initialFocalDistance=1,this._viewMatrix=N.Zero(),this._camMatrix=N.Zero(),this._cameraTransformMatrix=N.Zero(),this._cameraRotationMatrix=N.Zero(),this._referencePoint=new p(0,0,1),this._transformedReferencePoint=p.Zero(),this._deferredPositionUpdate=new p,this._deferredRotationQuaternionUpdate=new q,this._deferredRotationUpdate=new p,this._deferredUpdated=!1,this._deferOnly=!1,this._defaultUp=p.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();let t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){if(!this.lockedTarget)return null;if(this.lockedTarget.absolutePosition){let e=this.lockedTarget;e.computeWorldMatrix().getTranslationToRef(e.absolutePosition)}return this.lockedTarget.absolutePosition||this.lockedTarget}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new q(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();let t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;let e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){let e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=je),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),N.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);let t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&q.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(O.Matrix[0]),p.TransformNormalToRef(this.cameraDirection,O.Matrix[0],O.Vector3[0]),this._deferredPositionUpdate.addInPlace(O.Vector3[0]),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate);return}this._deferredPositionUpdate.addInPlace(this.cameraDirection),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate)}_checkInputs(){let e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=this.cameraRotation.x||this.cameraRotation.y;this._deferredUpdated=!1,this._deferredRotationUpdate.copyFrom(this.rotation),this._deferredPositionUpdate.copyFrom(this.position),this.rotationQuaternion&&this._deferredRotationQuaternionUpdate.copyFrom(this.rotationQuaternion),t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this._deferredRotationUpdate),this._deferredRotationUpdate.x+=this.cameraRotation.x*e,this._deferredRotationUpdate.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this._deferredRotationUpdate.x>1.570796&&(this._deferredRotationUpdate.x=1.570796),this._deferredRotationUpdate.x<-1.570796&&(this._deferredRotationUpdate.x=-1.570796)),this._deferOnly?this._deferredUpdated=!0:this.rotation.copyFrom(this._deferredRotationUpdate),this.rotationQuaternion&&this._deferredRotationUpdate.lengthSquared()&&(q.RotationYawPitchRollToRef(this._deferredRotationUpdate.y,this._deferredRotationUpdate.x,this._deferredRotationUpdate.z,this._deferredRotationQuaternionUpdate),this._deferOnly?this._deferredUpdated=!0:this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate))),t&&(Math.abs(this.cameraDirection.x)<this.speed*je&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*je&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*je&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*je&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*je&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):N.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return p.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),p.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?qt.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(q.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),qt.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){let r=this.parent.getWorldMatrix();p.TransformCoordinatesToRef(e,r,this._globalPosition),p.TransformCoordinatesToRef(t,r,this._tmpTargetVector),p.TransformNormalToRef(i,r,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?N.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):N.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?N.LookAtRHToRef(e,t,i,this._viewMatrix):N.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){let r=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(r,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==Ce.RIG_MODE_NONE){let i=new s(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,this.cameraRigMode===Ce.RIG_MODE_VR&&(this.rotationQuaternion||(this.rotationQuaternion=new q),i._cameraRigParams={},i.rotationQuaternion=new q),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){let e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ce.RIG_MODE_STEREOSCOPIC_INTERLACED:{let i=this.cameraRigMode===Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,r=this.cameraRigMode===Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*r,t);break}case Ce.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,s._TargetFocalPoint),s._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);let r=s._TargetFocalPoint.addInPlace(this.position);N.TranslationToRef(-r.x,-r.y,-r.z,s._TargetTransformMatrix),s._TargetTransformMatrix.multiplyToRef(N.RotationAxis(t.upVector,e),s._RigCamTransformMatrix),N.TranslationToRef(r.x,r.y,r.z,s._TargetTransformMatrix),s._RigCamTransformMatrix.multiplyToRef(s._TargetTransformMatrix,s._RigCamTransformMatrix),p.TransformCoordinatesToRef(this.position,s._RigCamTransformMatrix,t.position),t.setTarget(r)}getClassName(){return"TargetCamera"}};lr._RigCamTransformMatrix=new N;lr._TargetTransformMatrix=new N;lr._TargetFocalPoint=new p;v([mi()],lr.prototype,"rotation",void 0);v([I()],lr.prototype,"speed",void 0);v([Go("lockedTargetId")],lr.prototype,"lockedTarget",void 0);var wi=class extends lr{get angularSensibility(){let e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){let t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){let e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){let e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){let t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){let e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){let e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){let t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){let e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){let e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){let e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){let e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}get keysRotateUp(){let e=this.inputs.attached.keyboard;return e?e.keysRotateUp:[]}set keysRotateUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateUp=e)}get keysRotateDown(){let e=this.inputs.attached.keyboard;return e?e.keysRotateDown:[]}set keysRotateDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysRotateDown=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new p(.5,1,.5),this.ellipsoidOffset=new p(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=p.Zero(),this._diffPosition=p.Zero(),this._newPosition=p.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(n,o,a=null)=>{this._newPosition.copyFrom(o),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>K.CollisionsEpsilon&&(this.position.addToRef(this._diffPosition,this._deferredPositionUpdate),this._deferOnly?this._deferredUpdated=!0:this.position.copyFrom(this._deferredPositionUpdate),this.onCollide&&a&&this.onCollide(a))},this.inputs=new aa(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=H.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new p(0,0,0),this.cameraRotation=new j(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=p.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);let i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=p.Zero(),this._transformedDirection=p.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}};v([mi()],wi.prototype,"ellipsoid",void 0);v([mi()],wi.prototype,"ellipsoidOffset",void 0);v([I()],wi.prototype,"checkCollisions",void 0);v([I()],wi.prototype,"applyGravity",void 0);P("BABYLON.FreeCamera",wi);Xe.AddNodeConstructor("TouchCamera",(s,e)=>()=>new sm(s,p.Zero(),e));var sm=class extends wi{get touchAngularSensibility(){let e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){let t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){let e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){let t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){let e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!e:e.allowMouse=!t}};Xe.AddNodeConstructor("ArcRotateCamera",(s,e)=>()=>new Bt(s,0,0,1,p.Zero(),e));var Bt=class s extends lr{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new N,this._upToYMatrix=new N,this._upVector=p.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){N.RotationAlignToRef(p.UpReadOnly,this._upVector,this._yToUpMatrix),N.RotationAlignToRef(this._upVector,p.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){let e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){let t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){let e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){let t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){let e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){let t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){let e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){let t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){let e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){let t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){let e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){let t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){let e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){let e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){let e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){let e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){let e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){let t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){let e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){let t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){let e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){let t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new _d,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new Vl,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new $x,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,r,n,o,a=!0){super(e,p.Zero(),o,a),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=p.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=j.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this._viewMatrix=new N,this.panningAxis=new p(1,1,0),this._transformedDirection=new p,this.mapPanning=!1,this.onMeshTargetChangedObservable=new U,this.checkCollisions=!1,this.collisionRadius=new p(.5,.5,.5),this._previousPosition=p.Zero(),this._collisionVelocity=p.Zero(),this._newPosition=p.Zero(),this._computationVector=p.Zero(),this._onCollisionPositionChange=(l,c,h=null)=>{h?(this.setPosition(c),this.onCollide&&this.onCollide(h)):this._previousPosition.copyFrom(this._position);let u=Math.cos(this.alpha),d=Math.sin(this.alpha),f=Math.cos(this.beta),m=Math.sin(this.beta);m===0&&(m=1e-4);let g=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*u*m,this.radius*f,this.radius*d*m),g.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let _=this.upVector;this.allowUpsideDown&&this.beta<0&&(_=_.clone(),_=_.negate()),this._computeViewMatrix(this._position,g,_),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=p.Zero(),n&&this.setTarget(n),this.alpha=t,this.beta=i,this.radius=r,this.getViewMatrix(),this.inputs=new Gl(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=j.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){let t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}let e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,t,i=!0,r=2){let n=arguments;t=H.BackCompatCameraNoPreventDefault(n),this._useCtrlForPanning=i,this._panningMouseButton=r,typeof n[0]=="boolean"&&(n.length>1&&(this._useCtrlForPanning=n[1]),n.length>2&&(this._panningMouseButton=n[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){let e=this.invertRotation?-1:1,t=this._calculateHandednessMultiplier(),i=this.inertialAlphaOffset*t;this.beta<0&&(i*=-1),this.alpha+=i*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<je&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<je&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*je&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){let e=new p(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),p.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){let t=this.upVector,i=p.CrossToRef(this._transformedDirection,t,this._transformedDirection);p.CrossToRef(t,i,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);if(!this._targetHost)if(this.panningDistanceLimit)this._transformedDirection.addInPlace(this._target),p.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection);else{if(this.parent){let t=O.Matrix[0];this.parent.getWorldMatrix().getRotationMatrixToRef(t),t.transposeToRef(t),p.TransformCoordinatesToRef(this._transformedDirection,t,this._transformedDirection)}this._target.addInPlace(this._transformedDirection)}this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*je&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*je&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&p.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);let e=this.alpha;this._computationVector.x===0&&this._computationVector.z===0?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);let t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=t*2*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,r=!1){if(r=this.overrideCloneAlphaBetaRadius??r,e.computeWorldMatrix)t&&e.getBoundingInfo?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{let n=e,o=this._getTargetPosition();if(o&&!i&&o.equals(n))return;this._targetHost=null,this._target=n,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}r||this.rebuildAnglesAndRadius()}_getViewMatrix(){let e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta),r=Math.sin(this.beta);r===0&&(r=1e-4),this.radius===0&&(this.radius=1e-4);let n=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*r,this.radius*i,this.radius*t*r),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&p.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),n.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){let o=this.getScene().collisionCoordinator;this._collider||(this._collider=o.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,o.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let o=this.upVector;this.allowUpsideDown&&r<0&&(o=o.negate()),this._computeViewMatrix(this._position,n,o),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=n,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;let i=k.MinMax(e),r=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);r=Math.max(Math.min(r,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=r*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:r},t)}focusOn(e,t=!1){let i,r;if(e.min===void 0){let n=e||this.getScene().meshes;i=k.MinMax(n),r=p.Distance(i.min,i.max)}else{let n=e;i=n,r=n.distance}this._target=k.Center(i),t||(this.maxZ=r*2)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ce.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ce.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(t===0?1:-1);break;case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(t===0?-1:1);break}let r=new s(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return r._cameraRigParams={},r.isRigCamera=!0,r.rigParent=this,r.upVector=this.upVector,r.mode=this.mode,r.orthoLeft=this.orthoLeft,r.orthoRight=this.orthoRight,r.orthoBottom=this.orthoBottom,r.orthoTop=this.orthoTop,r}_updateRigCameras(){let e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER:case Ce.RIG_MODE_STEREOSCOPIC_INTERLACED:case Ce.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){let r=p.Distance(e,t),o=this.getScene().getEngine().getAspectRatio(this),a=Math.tan(this.fov/2),l=a*o,h=r*.5*i,u=h*Math.sqrt(1+1/(l*l)),d=h*Math.sqrt(1+1/(a*a));return Math.max(u,d)}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}};v([I()],Bt.prototype,"alpha",void 0);v([I()],Bt.prototype,"beta",void 0);v([I()],Bt.prototype,"radius",void 0);v([I()],Bt.prototype,"overrideCloneAlphaBetaRadius",void 0);v([mi("target")],Bt.prototype,"_target",void 0);v([Go("targetHost")],Bt.prototype,"_targetHost",void 0);v([I()],Bt.prototype,"inertialAlphaOffset",void 0);v([I()],Bt.prototype,"inertialBetaOffset",void 0);v([I()],Bt.prototype,"inertialRadiusOffset",void 0);v([I()],Bt.prototype,"lowerAlphaLimit",void 0);v([I()],Bt.prototype,"upperAlphaLimit",void 0);v([I()],Bt.prototype,"lowerBetaLimit",void 0);v([I()],Bt.prototype,"upperBetaLimit",void 0);v([I()],Bt.prototype,"lowerRadiusLimit",void 0);v([I()],Bt.prototype,"upperRadiusLimit",void 0);v([I()],Bt.prototype,"inertialPanningX",void 0);v([I()],Bt.prototype,"inertialPanningY",void 0);v([I()],Bt.prototype,"pinchToPanMaxDistance",void 0);v([I()],Bt.prototype,"panningDistanceLimit",void 0);v([mi()],Bt.prototype,"panningOriginTarget",void 0);v([I()],Bt.prototype,"panningInertia",void 0);v([I()],Bt.prototype,"zoomToMouseLocation",null);v([I()],Bt.prototype,"zoomOnFactor",void 0);v([gu()],Bt.prototype,"targetScreenOffset",void 0);v([I()],Bt.prototype,"allowUpsideDown",void 0);v([I()],Bt.prototype,"useInputToRestoreState",void 0);P("BABYLON.ArcRotateCamera",Bt);Xe.AddNodeConstructor("DeviceOrientationCamera",(s,e)=>()=>new lh(s,p.Zero(),e));var lh=class extends wi{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new q,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new q,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(r=>{this._dragFactor!=0&&(this._initialQuaternion||(this._initialQuaternion=new q),q.FromEulerAnglesToRef(0,r.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=qt.Y){this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new q),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}};var nv=class extends na{constructor(e){super(e)}addKeyboard(){return this.add(new yo),this}addMouse(){return this.add(new sh),this}};var ch=class extends lr{get angularSensibility(){let e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){let t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysForward(){let e=this.inputs.attached.keyboard;return e?e.keysForward:[]}set keysForward(e){let t=this.inputs.attached.keyboard;t&&(t.keysForward=e)}get keysBackward(){let e=this.inputs.attached.keyboard;return e?e.keysBackward:[]}set keysBackward(e){let t=this.inputs.attached.keyboard;t&&(t.keysBackward=e)}get keysUp(){let e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){let e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){let e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){let e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new p(1,1,1),this.ellipsoidOffset=new p(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=p.Zero(),this._trackRoll=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this._needMoveForGravity=!1,this._oldPosition=p.Zero(),this._diffPosition=p.Zero(),this._newPosition=p.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(n,o,a=null)=>{(c=>{this._newPosition.copyFrom(c),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>K.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&a&&this.onCollide(a))})(o)},this.inputs=new nv(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=H.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new p(0,0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=p.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);let i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let r=e;this.applyGravity&&(r=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,r,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=p.Zero(),this._transformedDirection=p.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}restoreRoll(e){let t=this._trackRoll,i=this.rotation.z,r=t-i,n=.001;Math.abs(r)>=n&&(this.rotation.z+=r/e,Math.abs(t-this.rotation.z)<=n&&(this.rotation.z=t))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}};v([mi()],ch.prototype,"ellipsoid",void 0);v([mi()],ch.prototype,"ellipsoidOffset",void 0);v([I()],ch.prototype,"checkCollisions",void 0);v([I()],ch.prototype,"applyGravity",void 0);P("BABYLON.FlyCamera",ch);var ov=class extends na{constructor(e){super(e)}addKeyboard(){return this.add(new ar),this}addMouseWheel(){return this.add(new oa),this}addPointers(){return this.add(new jr),this}addVRDeviceOrientation(){return F.Warn("DeviceOrientation support not yet implemented for FollowCamera."),this}};Xe.AddNodeConstructor("FollowCamera",(s,e)=>()=>new xs(s,p.Zero(),e));Xe.AddNodeConstructor("ArcFollowCamera",(s,e)=>()=>new av(s,0,0,1,null,e));var xs=class extends lr{constructor(e,t,i,r=null){super(e,t,i),this.radius=12,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.rotationOffset=0,this.lowerRotationOffsetLimit=null,this.upperRotationOffsetLimit=null,this.heightOffset=4,this.lowerHeightOffsetLimit=null,this.upperHeightOffsetLimit=null,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=r,this.inputs=new ov(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_follow(e){if(!e)return;let t=O.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(t);let i=Math.atan2(t.m[8],t.m[10]),r=H.ToRadians(this.rotationOffset)+i,n=e.getAbsolutePosition(),o=n.x+Math.sin(r)*this.radius,a=n.z+Math.cos(r)*this.radius,l=o-this.position.x,c=n.y+this.heightOffset-this.position.y,h=a-this.position.z,u=l*this.cameraAcceleration*2,d=c*this.cameraAcceleration,f=h*this.cameraAcceleration*2;(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=u<1?-this.maxCameraSpeed:this.maxCameraSpeed),(d>this.maxCameraSpeed||d<-this.maxCameraSpeed)&&(d=d<1?-this.maxCameraSpeed:this.maxCameraSpeed),(f>this.maxCameraSpeed||f<-this.maxCameraSpeed)&&(f=f<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new p(this.position.x+u,this.position.y+d,this.position.z+f),this.setTarget(n)}attachControl(e,t){t=H.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t),this._reset=()=>{}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){this.inputs.checkInputs(),this._checkLimits(),super._checkInputs(),this.lockedTarget&&this._follow(this.lockedTarget)}_checkLimits(){this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),this.lowerHeightOffsetLimit!==null&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),this.upperHeightOffsetLimit!==null&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),this.lowerRotationOffsetLimit!==null&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),this.upperRotationOffsetLimit!==null&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)}getClassName(){return"FollowCamera"}};v([I()],xs.prototype,"radius",void 0);v([I()],xs.prototype,"lowerRadiusLimit",void 0);v([I()],xs.prototype,"upperRadiusLimit",void 0);v([I()],xs.prototype,"rotationOffset",void 0);v([I()],xs.prototype,"lowerRotationOffsetLimit",void 0);v([I()],xs.prototype,"upperRotationOffsetLimit",void 0);v([I()],xs.prototype,"heightOffset",void 0);v([I()],xs.prototype,"lowerHeightOffsetLimit",void 0);v([I()],xs.prototype,"upperHeightOffsetLimit",void 0);v([I()],xs.prototype,"cameraAcceleration",void 0);v([I()],xs.prototype,"maxCameraSpeed",void 0);v([Go("lockedTargetId")],xs.prototype,"lockedTarget",void 0);var av=class extends lr{constructor(e,t,i,r,n,o){super(e,p.Zero(),o),this.alpha=t,this.beta=i,this.radius=r,this._cartesianCoordinates=p.Zero(),this.setMeshTarget(n)}setMeshTarget(e){this._meshTarget=e,this._follow()}_follow(){if(!this._meshTarget)return;this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);let e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}_checkInputs(){super._checkInputs(),this._follow()}getClassName(){return"ArcFollowCamera"}};P("BABYLON.FollowCamera",xs);P("BABYLON.ArcFollowCamera",av);var js=function(s){return s[s.A=0]="A",s[s.B=1]="B",s[s.X=2]="X",s[s.Y=3]="Y",s[s.LB=4]="LB",s[s.RB=5]="RB",s[s.Back=8]="Back",s[s.Start=9]="Start",s[s.LeftStick=10]="LeftStick",s[s.RightStick=11]="RightStick",s}(js||{}),nm=function(s){return s[s.Up=12]="Up",s[s.Down=13]="Down",s[s.Left=14]="Left",s[s.Right=15]="Right",s}(nm||{}),lv=class extends Tr{constructor(e,t,i,r=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new U,this.onButtonUpObservable=new U,this.onPadDownObservable=new U,this.onPadUpObservable=new U,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=Tr.XBOX,this._isXboxOnePad=r}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,js.A)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,js.B)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,js.X)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,js.Y)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,js.Start)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,js.Back)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,js.LB)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,js.RB)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,js.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,js.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,nm.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,nm.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,nm.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,nm.Right)}update(){super.update(),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}};var Eo=function(s){return s[s.Cross=0]="Cross",s[s.Circle=1]="Circle",s[s.Square=2]="Square",s[s.Triangle=3]="Triangle",s[s.L1=4]="L1",s[s.R1=5]="R1",s[s.Share=8]="Share",s[s.Options=9]="Options",s[s.LeftStick=10]="LeftStick",s[s.RightStick=11]="RightStick",s}(Eo||{}),om=function(s){return s[s.Up=12]="Up",s[s.Down=13]="Down",s[s.Left=14]="Left",s[s.Right=15]="Right",s}(om||{}),cv=class extends Tr{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new U,this.onButtonUpObservable=new U,this.onPadDownObservable=new U,this.onPadUpObservable=new U,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=Tr.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,Eo.Cross)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,Eo.Circle)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,Eo.Square)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,Eo.Triangle)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,Eo.Options)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,Eo.Share)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,Eo.L1)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,Eo.R1)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,Eo.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,Eo.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,om.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,om.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,om.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,om.Right)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}};var hv=class{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new U,so()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new U(t=>{for(let i in this._babylonGamepads){let r=this._babylonGamepads[i];r&&r._isConnected&&this.onGamepadConnectedObservable.notifyObserver(t,r)}}),this._onGamepadConnectedEvent=t=>{let i=t.gamepad;if(i.index in this._babylonGamepads&&this._babylonGamepads[i.index].isConnected)return;let r;this._babylonGamepads[i.index]?(r=this._babylonGamepads[i.index],r.browserGamepad=i,r._isConnected=!0):r=this._addNewGamepad(i),this.onGamepadConnectedObservable.notifyObservers(r),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=t=>{let i=t.gamepad;for(let r in this._babylonGamepads)if(this._babylonGamepads[r].index===i.index){let n=this._babylonGamepads[r];n._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(n),n.dispose&&n.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){let t=this._scene?this._scene.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),t.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=Tr.XBOX){for(let t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(e=>{e.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){this._oneGamepadConnected||(this._oneGamepadConnected=!0);let t,i=e.id.search("054c")!==-1&&e.id.search("0ce6")===-1,r=e.id.search("Xbox One")!==-1;return r||e.id.search("Xbox 360")!==-1||e.id.search("xinput")!==-1||e.id.search("045e")!==-1&&e.id.search("Surface Dock")===-1?t=new lv(e.id,e.index,e,r):i?t=new cv(e.id,e.index,e):t=new tv(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(let e in this._babylonGamepads){let t=this._babylonGamepads[e];if(!(!t||!t.isConnected))try{t.update()}catch{this._loggedErrors.indexOf(t.index)===-1&&(H.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&K.QueueNewFrame(()=>{this._checkGamepadsStatus()})}_updateGamepadObjects(){let e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){let i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{let r=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(r)}}}};Object.defineProperty(Te.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new hv(this);let s=this._getComponent(ye.NAME_GAMEPAD);s||(s=new MI(this),this._addComponent(s))}return this._gamepadManager},enumerable:!0,configurable:!0});aa.prototype.addGamepad=function(){return this.add(new ah),this};Gl.prototype.addGamepad=function(){return this.add(new rh),this};var MI=class{constructor(e){this.name=ye.NAME_GAMEPAD,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(ye.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)}rebuild(){}dispose(){let e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}_beforeCameraUpdate(){let e=this.scene._gamepadManager;e&&e._isMonitoring&&e._checkGamepadsStatus()}};Xe.AddNodeConstructor("FreeCamera",(s,e)=>()=>new _n(s,p.Zero(),e));var _n=class extends sm{get gamepadAngularSensibility(){let e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){let t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){let e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){let t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}};Ce._CreateDefaultParsedCamera=(s,e)=>new _n(s,p.Zero(),e);Xe.AddNodeConstructor("GamepadCamera",(s,e)=>()=>new hh(s,p.Zero(),e));var hh=class extends _n{constructor(e,t,i){super(e,t,i)}getClassName(){return"GamepadCamera"}};var yH="passCubePixelShader",EH=`varying vec2 vUV;uniform samplerCube textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;D.ShadersStore[yH]=EH;var qr=class s extends ve{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,r,n,o,a=0,l=!1){super(e,"pass",null,null,t,i,r,n,o,void 0,a,void 0,null,l)}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,r)}};P("BABYLON.PassPostProcess",qr);Se._RescalePostProcessFactory=s=>new qr("rescale",1,null,2,s,!1,0);var AH="anaglyphPixelShader",IH=`varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D leftSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 leftFrag=texture2D(leftSampler,vUV);leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);vec4 rightFrag=texture2D(textureSampler,vUV);rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);}`;D.ShadersStore[AH]=IH;var am=class extends ve{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,i,r,n,o){super(e,"anaglyph",null,["leftSampler"],t,i[1],r,n,o),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add(a=>{a.setTextureFromPostProcess("leftSampler",this._passedProcess)})}};P("BABYLON.AnaglyphPostProcess",am);function zl(s){s._rigCameras[0]._rigPostProcess=new qr(s.name+"_passthru",1,s._rigCameras[0]),s._rigCameras[1]._rigPostProcess=new am(s.name+"_anaglyph",1,s._rigCameras)}Xe.AddNodeConstructor("AnaglyphArcRotateCamera",(s,e,t)=>()=>new DI(s,0,0,1,p.Zero(),t.interaxial_distance,e));var DI=class extends Bt{constructor(e,t,i,r,n,o,a){super(e,t,i,r,n,a),this._setRigMode=()=>zl(this),this.interaxialDistance=o,this.setCameraRigMode(Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:o})}getClassName(){return"AnaglyphArcRotateCamera"}};Xe.AddNodeConstructor("AnaglyphFreeCamera",(s,e,t)=>()=>new OI(s,p.Zero(),t.interaxial_distance,e));var OI=class extends wi{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>zl(this),this.interaxialDistance=i,this.setCameraRigMode(Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphFreeCamera"}};Xe.AddNodeConstructor("AnaglyphGamepadCamera",(s,e,t)=>()=>new wI(s,p.Zero(),t.interaxial_distance,e));var wI=class extends hh{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>zl(this),this.interaxialDistance=i,this.setCameraRigMode(Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphGamepadCamera"}};Xe.AddNodeConstructor("AnaglyphUniversalCamera",(s,e,t)=>()=>new NI(s,p.Zero(),t.interaxial_distance,e));var NI=class extends _n{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>zl(this),this.interaxialDistance=i,this.setCameraRigMode(Ce.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphUniversalCamera"}};var RH="stereoscopicInterlacePixelShader",PH=`const vec3 TWO=vec3(2.0,2.0,2.0);varying vec2 vUV;uniform sampler2D camASampler;uniform sampler2D textureSampler;uniform vec2 stepSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{bool useCamA;bool useCamB;vec2 texCoord1;vec2 texCoord2;vec3 frag1;vec3 frag2;
#ifdef IS_STEREOSCOPIC_HORIZ
useCamB=vUV.x>0.5;useCamA=!useCamB;texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);
#else
#ifdef IS_STEREOSCOPIC_INTERLACED
float rowNum=floor(vUV.y/stepSize.y);useCamA=mod(rowNum,2.0)==1.0;useCamB=mod(rowNum,2.0)==0.0;texCoord1=vec2(vUV.x,vUV.y);texCoord2=vec2(vUV.x,vUV.y);
#else
useCamB=vUV.y>0.5;useCamA=!useCamB;texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);
#endif
#endif
if (useCamB){frag1=texture2D(textureSampler,texCoord1).rgb;frag2=texture2D(textureSampler,texCoord2).rgb;}else if (useCamA){frag1=texture2D(camASampler ,texCoord1).rgb;frag2=texture2D(camASampler ,texCoord2).rgb;}else {discard;}
gl_FragColor=vec4((frag1+frag2)/TWO,1.0);}
`;D.ShadersStore[RH]=PH;var uv=class extends ve{getClassName(){return"StereoscopicInterlacePostProcessI"}constructor(e,t,i,r,n,o,a){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],n,o,a,r?"#define IS_STEREOSCOPIC_INTERLACED 1":i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new j(1/this.width,1/this.height),this.onSizeChangedObservable.add(()=>{this._stepSize=new j(1/this.width,1/this.height)}),this.onApplyObservable.add(l=>{l.setTextureFromPostProcess("camASampler",this._passedProcess),l.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)})}};function Wl(s){let e=s.cameraRigMode===Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||s.cameraRigMode===Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,t=s.cameraRigMode===Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;s.cameraRigMode===Ce.RIG_MODE_STEREOSCOPIC_INTERLACED?(s._rigCameras[0]._rigPostProcess=new qr(s.name+"_passthru",1,s._rigCameras[0]),s._rigCameras[1]._rigPostProcess=new uv(s.name+"_stereoInterlace",s._rigCameras,!1,!0)):(s._rigCameras[t?1:0].viewport=new Dr(0,0,e?.5:1,e?1:.5),s._rigCameras[t?0:1].viewport=new Dr(e?.5:0,e?0:.5,e?.5:1,e?1:.5))}Xe.AddNodeConstructor("StereoscopicArcRotateCamera",(s,e,t)=>()=>new FI(s,0,0,1,p.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));var FI=class extends Bt{constructor(e,t,i,r,n,o,a,l){super(e,t,i,r,n,l),this._setRigMode=()=>Wl(this),this.interaxialDistance=o,this.isStereoscopicSideBySide=a,this.setCameraRigMode(a?Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:o})}getClassName(){return"StereoscopicArcRotateCamera"}};Xe.AddNodeConstructor("StereoscopicFreeCamera",(s,e,t)=>()=>new LI(s,p.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));var LI=class extends wi{constructor(e,t,i,r,n){super(e,t,n),this._setRigMode=()=>Wl(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicFreeCamera"}};Xe.AddNodeConstructor("StereoscopicGamepadCamera",(s,e,t)=>()=>new BI(s,p.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));var BI=class extends hh{constructor(e,t,i,r,n){super(e,t,n),this._setRigMode=()=>Wl(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicGamepadCamera"}};Xe.AddNodeConstructor("StereoscopicFreeCamera",(s,e,t)=>()=>new VI(s,p.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));var VI=class extends _n{constructor(e,t,i,r,n){super(e,t,n),this._setRigMode=()=>Wl(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?Ce.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:Ce.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicUniversalCamera"}};Xe.AddNodeConstructor("VirtualJoysticksCamera",(s,e)=>()=>new UI(s,p.Zero(),e));var UI=class extends wi{constructor(e,t,i){super(e,t,i),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}};var la=class s{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){let t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return N.Translation(t,0,0)}get rightHMatrix(){let t=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return N.Translation(-t,0,0)}get leftPreViewMatrix(){return N.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return N.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){let e=new s;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}};var MH="vrDistortionCorrectionPixelShader",DH=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 LensCenter;uniform vec2 Scale;uniform vec2 ScaleIn;uniform vec4 HmdWarpParam;vec2 HmdWarp(vec2 in01) {vec2 theta=(in01-LensCenter)*ScaleIn; 
float rSq=theta.x*theta.x+theta.y*theta.y;vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);return LensCenter+Scale*rvector;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 tc=HmdWarp(vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)
gl_FragColor=vec4(0.0,0.0,0.0,0.0);else{gl_FragColor=texture2D(textureSampler,tc);}}`;D.ShadersStore[MH]=DH;var lm=class extends ve{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,r){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,r.postProcessScaleFactor,t,z.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=r.distortionK,this._postProcessScaleFactor=r.postProcessScaleFactor,this._lensCenterOffset=r.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add(()=>{this._scaleIn=new j(2,2/this.aspectRatio),this._scaleFactor=new j(.5*(1/this._postProcessScaleFactor),.5*(1/this._postProcessScaleFactor)*this.aspectRatio),this._lensCenter=new j(this._isRightEye?.5-this._lensCenterOffset*.5:.5+this._lensCenterOffset*.5,.5)}),this.onApplyObservable.add(n=>{n.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),n.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),n.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),n.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])})}};var OH="vrMultiviewToSingleviewPixelShader",wH=`precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}`;D.ShadersStore[OH]=wH;var uh=class extends vt{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}};K.prototype.createMultiviewRenderTargetTexture=function(s,e,t,i){let r=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";let n=this._createHardwareRenderTargetWrapper(!1,!1,{width:s,height:e});n._framebuffer=r.createFramebuffer();let o=new Je(this,ke.Unknown,!0);return o.width=s,o.height=e,o.isMultiview=!0,t||(t=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,t),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.RGBA8,s,e,2)),n._colorTextureArray=t,i||(i=r.createTexture(),r.bindTexture(r.TEXTURE_2D_ARRAY,i),r.texStorage3D(r.TEXTURE_2D_ARRAY,1,r.DEPTH24_STENCIL8,s,e,2)),n._depthStencilTextureArray=i,o.isReady=!0,n.setTextures(o),n._depthStencilTexture=o,n};K.prototype.bindMultiviewFramebuffer=function(s){let e=s,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"};K.prototype.bindSpaceWarpFramebuffer=function(s){let e=s,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,e._depthStencilTextureArray,0,0,2);else throw new Error("Invalid Space Warp framebuffer")};Ce.prototype._useMultiviewToSingleView=!1;Ce.prototype._multiviewTexture=null;Ce.prototype._resizeOrCreateMultiviewTexture=function(s,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=s||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new uh(this.getScene(),{width:s,height:e})):this._multiviewTexture=new uh(this.getScene(),{width:s,height:e})};function sB(s,e){let t=new _r(s,void 0,!0,e);return t.addUniform("viewProjection",16),t.addUniform("viewProjectionR",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}var NH=Te.prototype.createSceneUniformBuffer;Te.prototype._transformMatrixR=N.Zero();Te.prototype._multiviewSceneUbo=null;Te.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=sB(this.getEngine(),"scene_multiview")};Te.prototype.createSceneUniformBuffer=function(s){return this._multiviewSceneUbo?sB(this.getEngine(),s):NH.bind(this)(s)};Te.prototype._updateMultiviewUbo=function(s,e){s&&e&&s.multiplyToRef(e,this._transformMatrixR),s&&e&&(s.multiplyToRef(e,O.Matrix[0]),ea.GetRightPlaneToRef(O.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))};Te.prototype._renderMultiviewToSingleView=function(s){s._resizeOrCreateMultiviewTexture(s._rigPostProcess&&s._rigPostProcess&&s._rigPostProcess.width>0?s._rigPostProcess.width:this.getEngine().getRenderWidth(!0),s._rigPostProcess&&s._rigPostProcess&&s._rigPostProcess.height>0?s._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),s.outputRenderTarget=s._multiviewTexture,this._renderForCamera(s),s.outputRenderTarget=null;for(let e=0;e<s._rigCameras.length;e++){let t=this.getEngine();this._activeCamera=s._rigCameras[e],t.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};var dv=class extends ve{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,z.BILINEAR_SAMPLINGMODE);let r=t??this.getCamera();this.onSizeChangedObservable.add(()=>{}),this.onApplyObservable.add(n=>{r._scene.activeCamera&&r._scene.activeCamera.isLeftCamera?n.setInt("imageIndex",0):n.setInt("imageIndex",1),n.setTexture("multiviewSampler",r._multiviewTexture)})}};function Cd(s,e){let t=e.vrCameraMetrics||la.GetDefault();s._rigCameras[0]._cameraRigParams.vrMetrics=t,s._rigCameras[0].viewport=new Dr(0,0,.5,1),s._rigCameras[0]._cameraRigParams.vrWorkMatrix=new N,s._rigCameras[0]._cameraRigParams.vrHMatrix=t.leftHMatrix,s._rigCameras[0]._cameraRigParams.vrPreViewMatrix=t.leftPreViewMatrix,s._rigCameras[0].getProjectionMatrix=s._rigCameras[0]._getVRProjectionMatrix,s._rigCameras[1]._cameraRigParams.vrMetrics=t,s._rigCameras[1].viewport=new Dr(.5,0,.5,1),s._rigCameras[1]._cameraRigParams.vrWorkMatrix=new N,s._rigCameras[1]._cameraRigParams.vrHMatrix=t.rightHMatrix,s._rigCameras[1]._cameraRigParams.vrPreViewMatrix=t.rightPreViewMatrix,s._rigCameras[1].getProjectionMatrix=s._rigCameras[1]._getVRProjectionMatrix,t.multiviewEnabled&&(s.getScene().getEngine().getCaps().multiview?(s._useMultiviewToSingleView=!0,s._rigPostProcess=new dv("VRMultiviewToSingleview",s,t.postProcessScaleFactor)):(F.Warn("Multiview is not supported, falling back to standard rendering"),t.multiviewEnabled=!1)),t.compensateDistortion&&(s._rigCameras[0]._rigPostProcess=new lm("VR_Distort_Compensation_Left",s._rigCameras[0],!1,t),s._rigCameras[1]._rigPostProcess=new lm("VR_Distort_Compensation_Right",s._rigCameras[1],!0,t))}Xe.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",(s,e)=>()=>new kI(s,0,0,1,p.Zero(),e));var kI=class extends Bt{constructor(e,t,i,r,n,o,a=!0,l=la.GetDefault()){super(e,t,i,r,n,o),this._setRigMode=c=>Cd(this,c),l.compensateDistortion=a,this.setCameraRigMode(Ce.RIG_MODE_VR,{vrCameraMetrics:l}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}};Xe.AddNodeConstructor("VRDeviceOrientationFreeCamera",(s,e)=>()=>new dh(s,p.Zero(),e));var dh=class extends lh{constructor(e,t,i,r=!0,n=la.GetDefault()){super(e,t,i),this._setRigMode=o=>Cd(this,o),n.compensateDistortion=r,this.setCameraRigMode(Ce.RIG_MODE_VR,{vrCameraMetrics:n})}getClassName(){return"VRDeviceOrientationFreeCamera"}};Xe.AddNodeConstructor("VRDeviceOrientationGamepadCamera",(s,e)=>()=>new GI(s,p.Zero(),e));var GI=class extends dh{constructor(e,t,i,r=!0,n=la.GetDefault()){super(e,t,i,r,n),this._setRigMode=o=>Cd(this,o),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}};var ca=class{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,r,n){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&t.prePassRenderer.getIndex(2)!==-1){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=r.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());let o=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=o.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==o.frameId&&(this._lastUpdateFrameId=o.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=r.clone()}}};var ge=(()=>{class s{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(t){this._DiffuseTextureEnabled!==t&&(this._DiffuseTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(t){this._DetailTextureEnabled!==t&&(this._DetailTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get DecalMapEnabled(){return this._DecalMapEnabled}static set DecalMapEnabled(t){this._DecalMapEnabled!==t&&(this._DecalMapEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(t){this._AmbientTextureEnabled!==t&&(this._AmbientTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(t){this._OpacityTextureEnabled!==t&&(this._OpacityTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(t){this._ReflectionTextureEnabled!==t&&(this._ReflectionTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(t){this._EmissiveTextureEnabled!==t&&(this._EmissiveTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(t){this._SpecularTextureEnabled!==t&&(this._SpecularTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(t){this._BumpTextureEnabled!==t&&(this._BumpTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(t){this._LightmapTextureEnabled!==t&&(this._LightmapTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(t){this._RefractionTextureEnabled!==t&&(this._RefractionTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(t){this._ColorGradingTextureEnabled!==t&&(this._ColorGradingTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(t){this._FresnelEnabled!==t&&(this._FresnelEnabled=t,K.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(t){this._ClearCoatTextureEnabled!==t&&(this._ClearCoatTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(t){this._ClearCoatBumpTextureEnabled!==t&&(this._ClearCoatBumpTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(t){this._ClearCoatTintTextureEnabled!==t&&(this._ClearCoatTintTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(t){this._SheenTextureEnabled!==t&&(this._SheenTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(t){this._AnisotropicTextureEnabled!==t&&(this._AnisotropicTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(t){this._ThicknessTextureEnabled!==t&&(this._ThicknessTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(t){this._RefractionIntensityTextureEnabled!==t&&(this._RefractionIntensityTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._TranslucencyIntensityTextureEnabled}static set TranslucencyIntensityTextureEnabled(t){this._TranslucencyIntensityTextureEnabled!==t&&(this._TranslucencyIntensityTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get TranslucencyColorTextureEnabled(){return this._TranslucencyColorTextureEnabled}static set TranslucencyColorTextureEnabled(t){this._TranslucencyColorTextureEnabled!==t&&(this._TranslucencyColorTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(t){this._IridescenceTextureEnabled!==t&&(this._IridescenceTextureEnabled=t,K.MarkAllMaterialsAsDirty(1))}}return s._DiffuseTextureEnabled=!0,s._DetailTextureEnabled=!0,s._DecalMapEnabled=!0,s._AmbientTextureEnabled=!0,s._OpacityTextureEnabled=!0,s._ReflectionTextureEnabled=!0,s._EmissiveTextureEnabled=!0,s._SpecularTextureEnabled=!0,s._BumpTextureEnabled=!0,s._LightmapTextureEnabled=!0,s._RefractionTextureEnabled=!0,s._ColorGradingTextureEnabled=!0,s._FresnelEnabled=!0,s._ClearCoatTextureEnabled=!0,s._ClearCoatBumpTextureEnabled=!0,s._ClearCoatTintTextureEnabled=!0,s._SheenTextureEnabled=!0,s._AnisotropicTextureEnabled=!0,s._ThicknessTextureEnabled=!0,s._RefractionIntensityTextureEnabled=!0,s._TranslucencyIntensityTextureEnabled=!0,s._TranslucencyColorTextureEnabled=!0,s._IridescenceTextureEnabled=!0,s})();var FH="decalFragmentDeclaration",LH=`#ifdef DECAL
uniform vec4 vDecalInfos;
#endif
`;D.IncludesShadersStore[FH]=LH;var BH="defaultFragmentDeclaration",VH=`uniform vec4 vEyePosition;uniform vec4 vDiffuseColor;
#ifdef SPECULARTERM
uniform vec4 vSpecularColor;
#endif
uniform vec3 vEmissiveColor;uniform vec3 vAmbientColor;uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;uniform vec4 emissiveRightColor;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#define ADDITIONAL_FRAGMENT_DECLARATION
`;D.IncludesShadersStore[BH]=VH;var UH="sceneUboDeclaration",kH=`layout(std140,column_major) uniform;uniform Scene {mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;mat4 projection;vec4 vEyePosition;};
`;D.IncludesShadersStore[UH]=kH;var GH="meshUboDeclaration",zH=`#ifdef WEBGL2
uniform mat4 world;uniform float visibility;
#else
layout(std140,column_major) uniform;uniform Mesh
{mat4 world;float visibility;};
#endif
#define WORLD_UBO
`;D.IncludesShadersStore[GH]=zH;var WH="defaultUboDeclaration",HH=`layout(std140,column_major) uniform;uniform Material
{vec4 diffuseLeftColor;vec4 diffuseRightColor;vec4 opacityParts;vec4 reflectionLeftColor;vec4 reflectionRightColor;vec4 refractionLeftColor;vec4 refractionRightColor;vec4 emissiveLeftColor;vec4 emissiveRightColor;vec2 vDiffuseInfos;vec2 vAmbientInfos;vec2 vOpacityInfos;vec2 vReflectionInfos;vec3 vReflectionPosition;vec3 vReflectionSize;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec2 vSpecularInfos;vec3 vBumpInfos;mat4 diffuseMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 reflectionMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 specularMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;float pointSize;float alphaCutOff;mat4 refractionMatrix;vec4 vRefractionInfos;vec3 vRefractionPosition;vec3 vRefractionSize;vec4 vSpecularColor;vec3 vEmissiveColor;vec4 vDiffuseColor;vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;D.IncludesShadersStore[WH]=HH;var XH="prePassDeclaration",YH=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;D.IncludesShadersStore[XH]=YH;var $H="oitDeclaration",jH=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;uniform sampler2D oitDepthSampler;uniform sampler2D oitFrontColorSampler;
#endif
`;D.IncludesShadersStore[$H]=jH;var qH="mainUVVaryingDeclaration",QH=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;D.IncludesShadersStore[qH]=QH;var KH="helperFunctions",ZH=`const float PI=3.1415926535897932384626433832795;const float RECIPROCAL_PI=0.3183098861837907;const float RECIPROCAL_PI2=0.15915494309189535;const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {vec3 i0=inMatrix[0];vec3 i1=inMatrix[1];vec3 i2=inMatrix[2];mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);return outMatrix;}
mat3 inverseMat3(mat3 inMatrix) {float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{vec3 nearZeroSection=0.0773993808*color;vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{vec3 nearZeroSection=12.92*color;vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;float remainingSection=pow(0.947867299*(color+0.055),2.4);return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;float remainingSection=1.055*pow(color,0.41666)-0.055;return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{return value*value;}
vec3 square(vec3 value)
{return value*value;}
float pow5(float value) {float sq=value*value;return sq*sq*value;}
float getLuminance(vec3 color)
{return clamp(dot(color,LuminanceEncodeApprox),0.,1.);}
float getRand(vec2 seed) {return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);}
float dither(vec2 seed,float varianceAmount) {float rand=getRand(seed);float normVariance=varianceAmount/255.0;float dither=mix(-normVariance,normVariance,rand);return dither;}
const float rgbdMaxRange=255.0;vec4 toRGBD(vec3 color) {float maxRGB=maxEps(max(color.r,max(color.g,color.b)));float D =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);vec3 rgb=color.rgb*D;rgb=toGammaSpace(rgb);return vec4(clamp(rgb,0.,1.),D); }
vec3 fromRGBD(vec4 rgbd) {rgbd.rgb=toLinearSpace(rgbd.rgb);return rgbd.rgb/rgbd.a;}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;vec3 halfSize=cubeSize*0.5;vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);vec3 intersectPositionWS=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}
`;D.IncludesShadersStore[KH]=ZH;var JH="lightFragmentDeclaration",eX=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowTexture{X};
#else
uniform highp sampler2DArray shadowTexture{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowTexture{X};
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowTexture{X};
#else
uniform sampler2D shadowTexture{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};
#endif
#endif
`;D.IncludesShadersStore[JH]=eX;var tX="lightUboDeclaration",iX=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};uniform sampler2D projectionLightTexture{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];uniform float cascadeBlendFactor{X};varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowTexture{X};uniform highp sampler2DArray depthTexture{X};uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowTexture{X};
#else
uniform highp sampler2DArray shadowTexture{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowTexture{X}; 
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowTexture{X};uniform highp sampler2D depthTexture{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowTexture{X};
#else
uniform sampler2D shadowTexture{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;D.IncludesShadersStore[tX]=iX;var rX="lightsFragmentFunctions",sX=`struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 lightVectorW;float attenuation=1.0;if (lightData.w==0.)
{vec3 direction=lightData.xyz-vPositionW;attenuation=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {lightingInfo result;vec3 direction=lightData.xyz-vPositionW;vec3 lightVectorW=normalize(direction);float attenuation=max(0.,1.0-length(direction)/range);float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{cosAngle=max(0.,pow(cosAngle,lightData.w));attenuation*=cosAngle;float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {lightingInfo result;float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);float specComp=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return textureColor;}`;D.IncludesShadersStore[rX]=sX;var nX="shadowsFragmentFunctions",oX=`#ifdef SHADOWS
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
#define inline
float computeShadowCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;float visibility=1.;vec3 poissonDisk[4];poissonDisk[0]=vec3(-1.0,1.0,-1.0);poissonDisk[1]=vec3(1.0,-1.0,-1.0);poissonDisk[2]=vec3(-1.0,-1.0,-1.0);poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);}
#define inline
float computeShadowWithESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}
#define inline
float computeShadowWithCloseESMCube(vec3 worldPos,vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{vec3 directionToLight=worldPos-lightPosition;float depth=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);vec3 uvLayer=vec3(uv.x,uv.y,layer);float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadow=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;}}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);float visibility=1.;vec2 poissonDisk[4];poissonDisk[0]=vec2(-0.94201624,-0.39906216);poissonDisk[1]=vec2(0.94558609,-0.76890725);poissonDisk[2]=vec2(-0.094184101,-0.92938870);poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;if (unpack(TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) visibility-=0.25;
#else
if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;if (TEXTUREFUNC(shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec2 uv=0.5*clipSpace.xy+vec2(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(TEXTUREFUNC(shadowSampler,uv,0.));
#else
float shadowMapSample=TEXTUREFUNC(shadowSampler,uv,0.).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define DISABLE_UNIFORMITY_ANALYSIS
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float shadow=texture2D(shadowSampler,uvDepthLayer);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float shadow=TEXTUREFUNC(shadowSampler,uvDepth,0.);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;vec2 uvw1=1.+2.*st;vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;vec2 uvw1=vec2(7.);vec2 uvw2=1.+3.*st;vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;float shadow=0.;shadow+=uvw0.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z),0.);shadow+=uvw1.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z),0.);shadow+=uvw2.x*uvw0.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z),0.);shadow+=uvw0.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z),0.);shadow+=uvw1.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z),0.);shadow+=uvw2.x*uvw1.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z),0.);shadow+=uvw0.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z),0.);shadow+=uvw1.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z),0.);shadow+=uvw2.x*uvw2.y*TEXTUREFUNC(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z),0.);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.),
vec3(0.)
);const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec4 offset=vec4(poissonSamplers[i],0.);offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);if (numBlocker<1.0) {return 1.0;}
else
{return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));uvDepth.z=ZINCLIP;float blockerDepth=0.0;float sumBlockerDepth=0.0;float numBlocker=0.0;for (int i=0; i<searchTapCount; i ++) {blockerDepth=TEXTUREFUNC(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0.).r;if (blockerDepth<depthMetric) {sumBlockerDepth+=blockerDepth;numBlocker++;}}
if (numBlocker<1.0) {return 1.0;}
else
{float avgBlockerDepth=sumBlockerDepth/numBlocker;float AAOffset=shadowMapSizeInverse*10.;float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;float random=getRand(vPositionFromLight.xy);float rotationAngle=random*3.1415926;vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));float shadow=0.;for (int i=0; i<pcfTapCount; i++) {vec3 offset=poissonSamplers[i];offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);shadow+=TEXTUREFUNC(shadowSampler,uvDepth+offset*filterRadius,0.);}
shadow/=float(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
#endif
`;D.IncludesShadersStore[nX]=oX;var aX="samplerFragmentDeclaration",lX=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;D.IncludesShadersStore[aX]=lX;var cX="fresnelFunction",hX=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;D.IncludesShadersStore[cX]=hX;var uX="reflectionFunction",dX=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0); }
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{float lon=atan(direction.z,direction.x);float lat=acos(direction.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(1.0-s,t,0); }
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);vec3 r=normalize(reflect(cameraToVertex,worldNormal));r=vec3(reflectionMatrix*vec4(r,0));float lon=atan(r.z,r.x);float lat=acos(r.y);vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;float s=sphereCoords.x*0.5+0.5;float t=sphereCoords.y;return vec3(s,t,0);}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{vec3 viewDir=normalize(vec3(view*worldPos));vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));vec3 r=reflect(viewDir,viewNormal);r=vec3(reflectionMatrix*vec4(r,0));r.z=r.z-1.0;float m=2.0*length(r);return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=worldPos.xyz-eyePosition;vec3 coords=normalize(reflect(viewDir,worldNormal));return vec3(reflectionMatrix*vec4(coords,1));}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{vec3 viewDir=normalize(worldPos.xyz-eyePosition);vec3 coords=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*(view*worldPos));}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{return vec3(reflectionMatrix*vec4(positionW,1.));}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;D.IncludesShadersStore[uX]=dX;var fX="imageProcessingDeclaration",pX=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;uniform vec4 vCameraColorCurveNeutral;uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;D.IncludesShadersStore[fX]=pX;var mX="imageProcessingFunctions",gX=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;sliceUV.x+=sliceInteger*sliceSize;sliceUV=saturate(sliceUV);vec4 slice0Color=texture2D(colorTransform,sliceUV);sliceUV.x+=sliceSize;sliceUV=saturate(sliceUV);vec4 slice1Color=texture2D(colorTransform,sliceUV);vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;}
#endif
#if TONEMAPPING==3
const float PBRNeutralStartCompression=0.8-0.04;const float PBRNeutralDesaturation=0.15;vec3 PBRNeutralToneMapping( vec3 color ) {float x=min(color.r,min(color.g,color.b));float offset=x<0.08 ? x-6.25*x*x : 0.04;color-=offset;float peak=max(color.r,max(color.g,color.b));if (peak<PBRNeutralStartCompression) return color;float d=1.-PBRNeutralStartCompression;float newPeak=1.-d*d/(peak+d-PBRNeutralStartCompression);color*=newPeak/peak;float g=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(color,newPeak*vec3(1,1,1),g);}
#endif
#if TONEMAPPING==2
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);vec3 RRTAndODTFit(vec3 v)
{vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
vec3 ACESFitted(vec3 color)
{color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;color=saturate(color);return color;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
vec4 applyImageProcessing(vec4 result) {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);float vignetteTerm=dot(vignetteXY1,vignetteXY1);float vignette=pow(vignetteTerm,vignetteSettings2.w);vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#if TONEMAPPING==3
result.rgb=PBRNeutralToneMapping(result.rgb);
#elif TONEMAPPING==2
result.rgb=ACESFitted(result.rgb);
#elif TONEMAPPING==1
const float tonemappingCalibration=1.590579;result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
result.rgb=toGammaSpace(result.rgb);result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);if (contrast<1.0) {result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);} else {result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;result.rgb*=colorCurve.rgb;result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);float dither=mix(-ditherIntensity,ditherIntensity,rand);result.rgb=saturate(result.rgb+vec3(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return result;}`;D.IncludesShadersStore[mX]=gX;var _X="bumpFragmentMainFunctions",xX=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#if defined(WEBGL2) || defined(WEBGPU)
mat4 toNormalMatrix(mat4 wMatrix)
{mat4 ret=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]=vec4(0.,0.,0.,1.);return ret;}
#else
mat4 toNormalMatrix(mat4 m)
{float
a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;mat4 mi=mat4(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;return mat4(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{vec3 dp1=dFdx(p);vec3 dp2=dFdy(p);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;float det=max(dot(tangent,tangent),dot(bitangent,bitangent));float invmax=det==0.0 ? 0.0 : inversesqrt(det);return mat3(tangent*invmax,bitangent*invmax,normal);}
#endif
`;D.IncludesShadersStore[_X]=xX;var vX="bumpFragmentFunctions",TX=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;const float maxSamples=15.;const int iMaxSamples=15;vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;vec2 vOffsetDir=normalize(vViewDirCoT.xy);vec2 vMaxOffset=vOffsetDir*parallaxLimit;float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));float stepSize=1.0/numSamples;float currRayHeight=1.0;vec2 vCurrOffset=vec2(0,0);vec2 vLastOffset=vec2(0,0);float lastSampledHeight=1.0;float currSampledHeight=1.0;bool keepWorking=true;for (int i=0; i<iMaxSamples; i++)
{currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{float delta1=currSampledHeight-currRayHeight;float delta2=(currRayHeight+stepSize)-lastSampledHeight;float ratio=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{float height=texture2D(bumpSampler,vBumpUV).w;vec2 texCoordOffset=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;D.IncludesShadersStore[vX]=TX;var CX="clipPlaneFragmentDeclaration",bX=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;D.IncludesShadersStore[CX]=bX;var SX="logDepthDeclaration",yX=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;varying float vFragmentDepth;
#endif
`;D.IncludesShadersStore[SX]=yX;var EX="fogFragmentDeclaration",AX=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;uniform vec3 vFogColor;varying vec3 vFogDistance;float CalcFogFactor()
{float fogCoeff=1.0;float fogStart=vFogInfos.y;float fogEnd=vFogInfos.z;float fogDensity=vFogInfos.w;float fogDistance=length(vFogDistance);if (FOGMODE_LINEAR==vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;D.IncludesShadersStore[EX]=AX;var IX="clipPlaneFragment",RX=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{discard;}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{discard;}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{discard;}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{discard;}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{discard;}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{discard;}
#endif
`;D.IncludesShadersStore[IX]=RX;var PX="bumpFragment",MX=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);vec2 detailNormalRG=detailColor.wy*2.0-1.0;float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;bumpNormal+=vec3(0.0,0.0,1.0);detailNormal*=vec3(-1.0,-1.0,1.0);vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;D.IncludesShadersStore[PX]=MX;var DX="decalFragment",OX=`#ifdef DECAL
#ifdef GAMMADECAL
decalColor.rgb=toLinearSpace(decalColor.rgb);
#endif
#ifdef DECAL_SMOOTHALPHA
decalColor.a*=decalColor.a;
#endif
surfaceAlbedo.rgb=mix(surfaceAlbedo.rgb,decalColor.rgb,decalColor.a);
#endif
`;D.IncludesShadersStore[DX]=OX;var wX="depthPrePass",NX=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);return;
#endif
`;D.IncludesShadersStore[wX]=NX;var FX="lightFragment",LX=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},textureProjectionMatrix{X});
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthTexture{X},shadowTexture{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowTexture{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
aggShadow+=shadow;numLights+=1.0;
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;D.IncludesShadersStore[FX]=LX;var BX="logDepthFragment",VX=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;D.IncludesShadersStore[BX]=VX;var UX="fogFragment",kX=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;D.IncludesShadersStore[UX]=kX;var GX="oitFragment",zX=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));vec2 full=unpackHalf2x16(halfFloat);fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);depth.rg=vec2(-MAX_DEPTH);frontColor=lastFrontColor;backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);return;}
#endif
`;D.IncludesShadersStore[GX]=zX;var WX="defaultPixelShader",HX=`#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);vec4 baseColor=vec4(1.,1.,1.,1.);vec3 diffuseColor=vDiffuseColor.rgb;float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#if defined(DECAL) && !defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#if defined(DECAL) && defined(DECAL_AFTER_DETAIL)
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#include<decalFragment>(surfaceAlbedo,baseColor,GAMMADECAL,_GAMMADECAL_NOTUSED_)
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
#ifdef SPECULARTERM
float glossiness=vSpecularColor.a;vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#else
float glossiness=0.;
#endif
vec3 diffuseBase=vec3(0.,0.,0.);lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;float aggShadow=0.;float numLights=0.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
aggShadow=aggShadow/numLights;vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec4 refractionLookup=textureCube(refractionCubeSampler,refractionVector);if (dot(refractionVector,viewDirectionW)<1.0) {refractionColor=refractionLookup;}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;gl_FragData[0]=color; 
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo); 
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); 
#endif
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULARTERM)
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularMapColor))*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toLinearSpace(specularColor),1.0)*writeGeometryInfo;
#endif
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=color.rgb*color.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-color.a);} else {backColor+=color;}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;D.ShadersStore[WX]=HX;var XX="decalVertexDeclaration",YX=`#ifdef DECAL
uniform vec4 vDecalInfos;uniform mat4 decalMatrix;
#endif
`;D.IncludesShadersStore[XX]=YX;var $X="defaultVertexDeclaration",jX=`uniform mat4 viewProjection;uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;D.IncludesShadersStore[$X]=jX;var qX="uvAttributeDeclaration",QX=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;D.IncludesShadersStore[qX]=QX;var KX="instancesDeclaration",ZX=`#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute vec4 previousWorld0;attribute vec4 previousWorld1;attribute vec4 previousWorld2;attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform mat4 previousWorld;
#endif
#endif
`;D.IncludesShadersStore[KX]=ZX;var JX="prePassVertexDeclaration",e5=`#ifdef PREPASS
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#endif
`;D.IncludesShadersStore[JX]=e5;var t5="samplerVertexDeclaration",i5=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;D.IncludesShadersStore[t5]=i5;var r5="bumpVertexDeclaration",s5=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;D.IncludesShadersStore[r5]=s5;var n5="clipPlaneVertexDeclaration",o5=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;varying float fClipDistance6;
#endif
`;D.IncludesShadersStore[n5]=o5;var a5="fogVertexDeclaration",l5=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;D.IncludesShadersStore[a5]=l5;var c5="lightVxFragmentDeclaration",h5=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#endif
`;D.IncludesShadersStore[c5]=h5;var u5="lightVxUboDeclaration",d5=`#ifdef LIGHT{X}
uniform Light{X}
{vec4 vLightData;vec4 vLightDiffuse;vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;vec2 depthValues;} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};varying float vDepthMetric{X};uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;D.IncludesShadersStore[u5]=d5;var f5="instancesVertex",p5=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;D.IncludesShadersStore[f5]=p5;var m5="prePassVertex",g5=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;D.IncludesShadersStore[m5]=g5;var _5="uvVariableDeclaration",x5=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;D.IncludesShadersStore[_5]=x5;var v5="samplerVertexImplementation",T5=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));}
#ifdef UV2
else if (v_INFONAME_==1.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));}
#endif
#endif
`;D.IncludesShadersStore[v5]=T5;var C5="bumpVertex",b5=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);vec3 tbnTangent=normalize(tangentUpdated.xyz);vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;D.IncludesShadersStore[C5]=b5;var S5="clipPlaneVertex",y5=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;D.IncludesShadersStore[S5]=y5;var E5="fogVertex",A5=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;D.IncludesShadersStore[E5]=A5;var I5="shadowsVertex",R5=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;D.IncludesShadersStore[I5]=R5;var P5="vertexColorMixing",M5=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=color;
#else
vColor.rgb*=color.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;D.IncludesShadersStore[P5]=M5;var D5="pointCloudVertex",O5=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;D.IncludesShadersStore[D5]=O5;var w5="logDepthVertex",N5=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;D.IncludesShadersStore[w5]=N5;var F5="defaultVertexShader",L5=`#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#include<prePassVertex>
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;D.ShadersStore[F5]=L5;var B5=new RegExp("^([gimus]+)!"),oB=(()=>{class s{constructor(t){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=t,this._scene=t.getScene(),this._engine=this._scene.getEngine()}_addPlugin(t){for(let n=0;n<this._plugins.length;++n)if(this._plugins[n].name===t.name)return!1;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${t.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;let i=t.getClassName();s._MaterialPluginClassToMainDefine[i]||(s._MaterialPluginClassToMainDefine[i]="MATERIALPLUGIN_"+ ++s._MaterialPluginCounter),this._material._callbackPluginEventGeneric=(n,o)=>this._handlePluginEvent(n,o),this._plugins.push(t),this._plugins.sort((n,o)=>n.priority-o.priority),this._codeInjectionPoints={};let r={};r[s._MaterialPluginClassToMainDefine[i]]={type:"boolean",default:!0};for(let n of this._plugins)n.collectDefines(r),this._collectPointNames("vertex",n.getCustomCode("vertex")),this._collectPointNames("fragment",n.getCustomCode("fragment"));return this._defineNamesFromPlugins=r,!0}_activatePlugin(t){this._activePlugins.indexOf(t)===-1&&(this._activePlugins.push(t),this._activePlugins.sort((i,r)=>i.priority-r.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),t.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(t),this._activePluginsForExtraEvents.sort((i,r)=>i.priority-r.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(t){for(let i=0;i<this._plugins.length;++i)if(this._plugins[i].name===t)return this._plugins[i];return null}_handlePluginEventIsReadyForSubMesh(t){let i=!0;for(let r of this._activePlugins)i=i&&r.isReadyForSubMesh(t.defines,this._scene,this._engine,t.subMesh);t.isReadyForSubMesh=i}_handlePluginEventPrepareDefinesBeforeAttributes(t){for(let i of this._activePlugins)i.prepareDefinesBeforeAttributes(t.defines,this._scene,t.mesh)}_handlePluginEventPrepareDefines(t){for(let i of this._activePlugins)i.prepareDefines(t.defines,this._scene,t.mesh)}_handlePluginEventHardBindForSubMesh(t){for(let i of this._activePluginsForExtraEvents)i.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,t.subMesh)}_handlePluginEventBindForSubMesh(t){for(let i of this._activePlugins)i.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,t.subMesh)}_handlePluginEventHasRenderTargetTextures(t){let i=!1;for(let r of this._activePluginsForExtraEvents)if(i=r.hasRenderTargetTextures(),i)break;t.hasRenderTargetTextures=i}_handlePluginEventFillRenderTargetTextures(t){for(let i of this._activePluginsForExtraEvents)i.fillRenderTargetTextures(t.renderTargets)}_handlePluginEvent(t,i){switch(t){case or.GetActiveTextures:{let r=i;for(let n of this._activePlugins)n.getActiveTextures(r.activeTextures);break}case or.GetAnimatables:{let r=i;for(let n of this._activePlugins)n.getAnimatables(r.animatables);break}case or.HasTexture:{let r=i,n=!1;for(let o of this._activePlugins)if(n=o.hasTexture(r.texture),n)break;r.hasTexture=n;break}case or.Disposed:{let r=i;for(let n of this._plugins)n.dispose(r.forceDisposeTextures);break}case or.GetDefineNames:{let r=i;r.defineNames=this._defineNamesFromPlugins;break}case or.PrepareEffect:{let r=i;for(let n of this._activePlugins)r.fallbackRank=n.addFallbacks(r.defines,r.fallbacks,r.fallbackRank),n.getAttributes(r.attributes,this._scene,r.mesh);this._uniformList.length>0&&r.uniforms.push(...this._uniformList),this._samplerList.length>0&&r.samplers.push(...this._samplerList),this._uboList.length>0&&r.uniformBuffersNames.push(...this._uboList),r.customCode=this._injectCustomCode(r,r.customCode);break}case or.PrepareUniformBuffer:{let r=i;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(let n of this._plugins){let o=n.getUniforms();if(o){if(o.ubo)for(let a of o.ubo){if(a.size&&a.type){let l=a.arraySize??0;r.ubo.addUniform(a.name,a.size,l),this._uboDeclaration+=`${a.type} ${a.name}${l>0?`[${l}]`:""};
`}this._uniformList.push(a.name)}o.vertex&&(this._vertexDeclaration+=o.vertex+`
`),o.fragment&&(this._fragmentDeclaration+=o.fragment+`
`)}n.getSamplers(this._samplerList),n.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(t,i){if(i)for(let r in i)this._codeInjectionPoints[t]||(this._codeInjectionPoints[t]={}),this._codeInjectionPoints[t][r]=!0}_injectCustomCode(t,i){return(r,n)=>{i&&(n=i(r,n)),this._uboDeclaration&&(n=n.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(n=n.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(n=n.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));let o=this._codeInjectionPoints?.[r];if(!o)return n;let a=null;for(let l in o){let c="";for(let h of this._activePlugins){let u=h.getCustomCode(r)?.[l];if(u){if(h.resolveIncludes){if(a===null){let d=pe.GLSL;a={defines:[],indexParameters:t.indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:void 0,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:D.GetShadersRepository(d),includesShadersStore:D.GetIncludesShadersStore(d),version:void 0,platformName:this._engine.shaderPlatformName,processingContext:void 0,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:void 0}}a.isFragment=r==="fragment",wO(u,a,d=>u=d)}c+=u+`
`}}if(c.length>0)if(l.charAt(0)==="!"){l=l.substring(1);let h="g";if(l.charAt(0)==="!")h="",l=l.substring(1);else{let m=B5.exec(l);m&&m.length>=2&&(h=m[1],l=l.substring(h.length+1))}h.indexOf("g")<0&&(h+="g");let u=n,d=new RegExp(l,h),f=d.exec(u);for(;f!==null;){let m=c;for(let g=0;g<f.length;++g)m=m.replace("$"+g,f[g]);n=n.replace(f[0],m),f=d.exec(u)}}else{let h="#define "+l;n=n.replace(h,`
`+c+`
`+h)}}return n}}}return s._MaterialPluginClassToMainDefine={},s._MaterialPluginCounter=0,s})();me.OnEnginesDisposedObservable.add(()=>{k5()});var V5=[],U5=!1,nB=null;function k5(){V5.length=0,U5=!1,se.OnEventObservable.remove(nB),nB=null}var Ti=class{_enable(e){e&&this._pluginManager._activatePlugin(this)}constructor(e,t,i,r,n=!0,o=!1,a=!1){this.priority=500,this.resolveIncludes=!1,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,this.resolveIncludes=a,e.pluginManager||(e.pluginManager=new oB(e),e.onDisposeObservable.add(()=>{e.pluginManager=void 0})),this._pluginDefineNames=r,this._pluginManager=e.pluginManager,n&&this._pluginManager._addPlugin(this),o&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,r){return!0}hardBindForSubMesh(e,t,i,r){}bindForSubMesh(e,t,i,r){}dispose(e){}getCustomCode(e){return null}collectDefines(e){if(this._pluginDefineNames)for(let t of Object.keys(this._pluginDefineNames)){if(t[0]==="_")continue;let i=typeof this._pluginDefineNames[t];e[t]={type:i==="number"?"number":i==="string"?"string":i==="boolean"?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(){return{}}copyTo(e){ae.Clone(()=>e,this)}serialize(){return ae.Serialize(this)}parse(e,t,i){ae.Parse(()=>this,e,t,i)}};v([I()],Ti.prototype,"name",void 0);v([I()],Ti.prototype,"priority",void 0);v([I()],Ti.prototype,"resolveIncludes",void 0);v([I()],Ti.prototype,"registerForExtraEvents",void 0);P("BABYLON.MaterialPluginBase",Ti);var zI=class extends Qt{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}},xn=class extends Ti{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DetailMap",140,new zI,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=se.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&ge.DetailTextureEnabled&&!this._texture.isReady()):!0}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;let i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&ge.DetailTextureEnabled&&this._isEnabled?(bt(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;let i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&this._texture&&ge.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),It(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&ge.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture?.dispose()}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}};v([Qe("detailTexture"),Q("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"texture",void 0);v([I()],xn.prototype,"diffuseBlendLevel",void 0);v([I()],xn.prototype,"roughnessBlendLevel",void 0);v([I()],xn.prototype,"bumpLevel",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"normalBlendMethod",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"isEnabled",void 0);var WI={effect:null,subMesh:null},HI=class extends Qt{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.DECAL_AFTER_DETAIL=!1,this.rebuild()}setReflectionMode(e){let t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(let i of t)this[i]=i===e}},Ee=class s extends Xs{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}constructor(e,t){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new X(0,0,0),this.diffuseColor=new X(1,1,1),this.specularColor=new X(1,1,1),this.emissiveColor=new X(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._applyDecalMapAfterDetailMap=!1,this._renderTargets=new _i(16),this._worldViewProjectionMatrix=N.Zero(),this._globalAmbientColor=new X(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new xn(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new ca,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),s.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),s.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get hasRenderTargetTextures(){return s.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||s.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===se.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==se.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){this._uniformBufferLayoutBuilt||this.buildUniformLayout();let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(or.GetDefineNames,this._eventInfo),t.materialDefines=new HI(this._eventInfo.defineNames));let n=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=n.getEngine();o._needNormals=co(n,e,o,!0,this._maxSimultaneousLights,this._disableLighting),Na(n,o);let l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Sc(n,o,this.canRenderToMRT&&!l),Wf(n,o,l),o._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,o._needUVs=!1;for(let h=1;h<=6;++h)o["MAINUV"+h]=!1;if(n.texturesEnabled){if(o.DIFFUSEDIRECTUV=0,o.BUMPDIRECTUV=0,o.AMBIENTDIRECTUV=0,o.OPACITYDIRECTUV=0,o.EMISSIVEDIRECTUV=0,o.SPECULARDIRECTUV=0,o.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&s.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())bt(this._diffuseTexture,o,"DIFFUSE");else return!1;else o.DIFFUSE=!1;if(this._ambientTexture&&s.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())bt(this._ambientTexture,o,"AMBIENT");else return!1;else o.AMBIENT=!1;if(this._opacityTexture&&s.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())bt(this._opacityTexture,o,"OPACITY"),o.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else o.OPACITY=!1;if(this._reflectionTexture&&s.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(o._needNormals=!0,o.REFLECTION=!0,o.ROUGHNESS=this._roughness>0,o.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,o.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===z.INVCUBIC_MODE,o.REFLECTIONMAP_3D=this._reflectionTexture.isCube,o.REFLECTIONMAP_OPPOSITEZ=o.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,o.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case z.EXPLICIT_MODE:o.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case z.PLANAR_MODE:o.setReflectionMode("REFLECTIONMAP_PLANAR");break;case z.PROJECTION_MODE:o.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case z.SKYBOX_MODE:o.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case z.SPHERICAL_MODE:o.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case z.EQUIRECTANGULAR_MODE:o.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case z.FIXED_EQUIRECTANGULAR_MODE:o.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:o.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case z.CUBIC_MODE:case z.INVCUBIC_MODE:default:o.setReflectionMode("REFLECTIONMAP_CUBIC");break}o.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else o.REFLECTION=!1,o.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&s.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())bt(this._emissiveTexture,o,"EMISSIVE");else return!1;else o.EMISSIVE=!1;if(this._lightmapTexture&&s.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())bt(this._lightmapTexture,o,"LIGHTMAP"),o.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,o.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else o.LIGHTMAP=!1;if(this._specularTexture&&s.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())bt(this._specularTexture,o,"SPECULAR"),o.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else o.SPECULAR=!1;if(n.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&s.BumpTextureEnabled){if(this._bumpTexture.isReady())bt(this._bumpTexture,o,"BUMP"),o.PARALLAX=this._useParallax,o.PARALLAX_RHS=n.useRightHandedSystem,o.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;o.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else o.BUMP=!1,o.PARALLAX=!1,o.PARALLAX_RHS=!1,o.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&s.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())o._needUVs=!0,o.REFRACTION=!0,o.REFRACTIONMAP_3D=this._refractionTexture.isCube,o.RGBDREFRACTION=this._refractionTexture.isRGBD,o.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else o.REFRACTION=!1;o.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else o.DIFFUSE=!1,o.AMBIENT=!1,o.OPACITY=!1,o.REFLECTION=!1,o.EMISSIVE=!1,o.LIGHTMAP=!1,o.BUMP=!1,o.REFRACTION=!1;o.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),o.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,o.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,o.SPECULAROVERALPHA=this._useSpecularOverAlpha,o.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,o.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,o.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=o,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(o._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(o),o.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,o.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}o._areFresnelDirty&&(s.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(o.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,o.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,o.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,o.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,o.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,o.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,o._needNormals=!0,o.FRESNEL=!0):o.FRESNEL=!1),Da(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,o,this._applyDecalMapAfterDetailMap),Oa(n,a,this,o,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=o,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),wa(e,o,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo);let c=!1;if(o.isDirty){let h=o._areLightsDisposed;o.markAsProcessed();let u=new ps;o.REFLECTION&&u.addFallback(0,"REFLECTION"),o.SPECULAR&&u.addFallback(0,"SPECULAR"),o.BUMP&&u.addFallback(0,"BUMP"),o.PARALLAX&&u.addFallback(1,"PARALLAX"),o.PARALLAX_RHS&&u.addFallback(1,"PARALLAX_RHS"),o.PARALLAXOCCLUSION&&u.addFallback(0,"PARALLAXOCCLUSION"),o.SPECULAROVERALPHA&&u.addFallback(0,"SPECULAROVERALPHA"),o.FOG&&u.addFallback(1,"FOG"),o.POINTSIZE&&u.addFallback(0,"POINTSIZE"),o.LOGARITHMICDEPTH&&u.addFallback(0,"LOGARITHMICDEPTH"),bc(o,u,this._maxSimultaneousLights),o.SPECULARTERM&&u.addFallback(0,"SPECULARTERM"),o.DIFFUSEFRESNEL&&u.addFallback(1,"DIFFUSEFRESNEL"),o.OPACITYFRESNEL&&u.addFallback(2,"OPACITYFRESNEL"),o.REFLECTIONFRESNEL&&u.addFallback(3,"REFLECTIONFRESNEL"),o.EMISSIVEFRESNEL&&u.addFallback(4,"EMISSIVEFRESNEL"),o.FRESNEL&&u.addFallback(4,"FRESNEL"),o.MULTIVIEW&&u.addFallback(0,"MULTIVIEW");let d=[y.PositionKind];o.NORMAL&&d.push(y.NormalKind),o.TANGENT&&d.push(y.TangentKind);for(let S=1;S<=6;++S)o["UV"+S]&&d.push(`uv${S===1?"":S}`);o.VERTEXCOLOR&&d.push(y.ColorKind),Cc(d,e,o,u),Ma(d,o),kf(d,e,o),Tc(d,e,o);let f="default",m=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],g=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],_=["Material","Scene","Mesh"],x={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:o.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=u,this._eventInfo.fallbackRank=0,this._eventInfo.defines=o,this._eventInfo.uniforms=m,this._eventInfo.attributes=d,this._eventInfo.samplers=g,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=x,this._callbackPluginEventGeneric(or.PrepareEffect,this._eventInfo),ca.AddUniforms(m),ca.AddSamplers(g),rt&&(rt.PrepareUniforms(m,o),rt.PrepareSamplers(g,o)),Fa({uniformsNames:m,uniformBuffersNames:_,samplers:g,defines:o,maxSimultaneousLights:this._maxSimultaneousLights}),er(m);let b={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,m,_,g,o,d,b));let C=o.toString(),R=t.effect,E=n.getEngine().createEffect(f,{attributes:d,uniformsNames:m,uniformBuffersNames:_,samplers:g,defines:C,fallbacks:u,onCompiled:this.onCompiled,onError:this.onError,indexParameters:x,processFinalCode:b.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:o.PREPASS},a);if(this._eventInfo.customCode=void 0,E)if(this._onEffectCreatedObservable&&(WI.effect=E,WI.subMesh=t,this._onEffectCreatedObservable.notifyObservers(WI)),this.allowShaderHotSwapping&&R&&!E.isReady()){if(E=R,o.markAsUnprocessed(),c=this.isFrozen,h)return o._areLightsDisposed=!0,!1}else n.resetCachedMaterial(),t.setEffect(E,o,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(o._renderId=n.getRenderId(),r._wasPreviouslyReady=!c,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}buildUniformLayout(){let e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){let r=this.getScene(),n=i.materialDefines;if(!n)return;let o=i.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));let a=this._mustRebind(r,o,i,t.visibility);ao(t,o);let l=this._uniformBuffer;if(a){if(this.bindViewProjection(o),!l.useUbo||!this.isFrozen||!l.isSync||i._drawWrapper._forceRebindOnNextCall){if(s.FresnelEnabled&&n.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(l.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),l.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&l.updateColor4("opacityParts",new X(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(l.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),l.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(l.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),l.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(l.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),l.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled){if(this._diffuseTexture&&s.DiffuseTextureEnabled&&(l.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),It(this._diffuseTexture,l,"diffuse")),this._ambientTexture&&s.AmbientTextureEnabled&&(l.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),It(this._ambientTexture,l,"ambient")),this._opacityTexture&&s.OpacityTextureEnabled&&(l.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),It(this._opacityTexture,l,"opacity")),this._hasAlphaChannel()&&l.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&s.ReflectionTextureEnabled&&(l.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),l.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){let c=this._reflectionTexture;l.updateVector3("vReflectionPosition",c.boundingBoxPosition),l.updateVector3("vReflectionSize",c.boundingBoxSize)}if(this._emissiveTexture&&s.EmissiveTextureEnabled&&(l.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),It(this._emissiveTexture,l,"emissive")),this._lightmapTexture&&s.LightmapTextureEnabled&&(l.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),It(this._lightmapTexture,l,"lightmap")),this._specularTexture&&s.SpecularTextureEnabled&&(l.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),It(this._specularTexture,l,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&s.BumpTextureEnabled&&(l.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),It(this._bumpTexture,l,"bump"),r._mirroredCameraPosition?l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):l.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&s.RefractionTextureEnabled){let c=1;if(this._refractionTexture.isCube||(l.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(c=this._refractionTexture.depth)),l.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,c,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){let h=this._refractionTexture;l.updateVector3("vRefractionPosition",h.boundingBoxPosition),l.updateVector3("vRefractionSize",h.boundingBoxSize)}}}this.pointsCloud&&l.updateFloat("pointSize",this.pointSize),n.SPECULARTERM&&l.updateColor4("vSpecularColor",this.specularColor,this.specularPower),l.updateColor3("vEmissiveColor",s.EmissiveTextureEnabled?this.emissiveColor:X.BlackReadOnly),l.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),l.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&s.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&s.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&s.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&s.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?o.setTexture("reflectionCubeSampler",this._reflectionTexture):o.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&s.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&s.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&s.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&s.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&s.RefractionTextureEnabled&&(this._refractionTexture.isCube?o.setTexture("refractionCubeSampler",this._refractionTexture):o.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Yi(o,this,r),this.bindEyePosition(o)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(a||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&lo(r,t,o,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==Te.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||n.PREPASS)&&this.bindView(o),Ms(r,t,o),n.NUM_MORPH_INFLUENCERS&&Vr(t,o),n.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(o,n.INSTANCES),this.useLogarithmicDepth&&Br(n,o,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),l.update()}getAnimatables(){let e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){let e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,t){t&&(this._diffuseTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._specularTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._refractionTexture?.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e,t=!0,i=""){let r=ae.Clone(()=>new s(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.name=e,r.id=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}static Parse(e,t,i){let r=ae.Parse(()=>new s(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),se._ParsePlugins(e,r,t,i),r}static get DiffuseTextureEnabled(){return ge.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){ge.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return ge.DetailTextureEnabled}static set DetailTextureEnabled(e){ge.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return ge.AmbientTextureEnabled}static set AmbientTextureEnabled(e){ge.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return ge.OpacityTextureEnabled}static set OpacityTextureEnabled(e){ge.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return ge.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){ge.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return ge.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){ge.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return ge.SpecularTextureEnabled}static set SpecularTextureEnabled(e){ge.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return ge.BumpTextureEnabled}static set BumpTextureEnabled(e){ge.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return ge.LightmapTextureEnabled}static set LightmapTextureEnabled(e){ge.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return ge.RefractionTextureEnabled}static set RefractionTextureEnabled(e){ge.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return ge.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){ge.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return ge.FresnelEnabled}static set FresnelEnabled(e){ge.FresnelEnabled=e}};v([Qe("diffuseTexture")],Ee.prototype,"_diffuseTexture",void 0);v([Q("_markAllSubMeshesAsTexturesAndMiscDirty")],Ee.prototype,"diffuseTexture",void 0);v([Qe("ambientTexture")],Ee.prototype,"_ambientTexture",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"ambientTexture",void 0);v([Qe("opacityTexture")],Ee.prototype,"_opacityTexture",void 0);v([Q("_markAllSubMeshesAsTexturesAndMiscDirty")],Ee.prototype,"opacityTexture",void 0);v([Qe("reflectionTexture")],Ee.prototype,"_reflectionTexture",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"reflectionTexture",void 0);v([Qe("emissiveTexture")],Ee.prototype,"_emissiveTexture",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"emissiveTexture",void 0);v([Qe("specularTexture")],Ee.prototype,"_specularTexture",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"specularTexture",void 0);v([Qe("bumpTexture")],Ee.prototype,"_bumpTexture",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"bumpTexture",void 0);v([Qe("lightmapTexture")],Ee.prototype,"_lightmapTexture",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"lightmapTexture",void 0);v([Qe("refractionTexture")],Ee.prototype,"_refractionTexture",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"refractionTexture",void 0);v([At("ambient")],Ee.prototype,"ambientColor",void 0);v([At("diffuse")],Ee.prototype,"diffuseColor",void 0);v([At("specular")],Ee.prototype,"specularColor",void 0);v([At("emissive")],Ee.prototype,"emissiveColor",void 0);v([I()],Ee.prototype,"specularPower",void 0);v([I("useAlphaFromDiffuseTexture")],Ee.prototype,"_useAlphaFromDiffuseTexture",void 0);v([Q("_markAllSubMeshesAsTexturesAndMiscDirty")],Ee.prototype,"useAlphaFromDiffuseTexture",void 0);v([I("useEmissiveAsIllumination")],Ee.prototype,"_useEmissiveAsIllumination",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useEmissiveAsIllumination",void 0);v([I("linkEmissiveWithDiffuse")],Ee.prototype,"_linkEmissiveWithDiffuse",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"linkEmissiveWithDiffuse",void 0);v([I("useSpecularOverAlpha")],Ee.prototype,"_useSpecularOverAlpha",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useSpecularOverAlpha",void 0);v([I("useReflectionOverAlpha")],Ee.prototype,"_useReflectionOverAlpha",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useReflectionOverAlpha",void 0);v([I("disableLighting")],Ee.prototype,"_disableLighting",void 0);v([Q("_markAllSubMeshesAsLightsDirty")],Ee.prototype,"disableLighting",void 0);v([I("useObjectSpaceNormalMap")],Ee.prototype,"_useObjectSpaceNormalMap",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useObjectSpaceNormalMap",void 0);v([I("useParallax")],Ee.prototype,"_useParallax",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useParallax",void 0);v([I("useParallaxOcclusion")],Ee.prototype,"_useParallaxOcclusion",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useParallaxOcclusion",void 0);v([I()],Ee.prototype,"parallaxScaleBias",void 0);v([I("roughness")],Ee.prototype,"_roughness",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"roughness",void 0);v([I()],Ee.prototype,"indexOfRefraction",void 0);v([I()],Ee.prototype,"invertRefractionY",void 0);v([I()],Ee.prototype,"alphaCutOff",void 0);v([I("useLightmapAsShadowmap")],Ee.prototype,"_useLightmapAsShadowmap",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useLightmapAsShadowmap",void 0);v([mu("diffuseFresnelParameters")],Ee.prototype,"_diffuseFresnelParameters",void 0);v([Q("_markAllSubMeshesAsFresnelDirty")],Ee.prototype,"diffuseFresnelParameters",void 0);v([mu("opacityFresnelParameters")],Ee.prototype,"_opacityFresnelParameters",void 0);v([Q("_markAllSubMeshesAsFresnelAndMiscDirty")],Ee.prototype,"opacityFresnelParameters",void 0);v([mu("reflectionFresnelParameters")],Ee.prototype,"_reflectionFresnelParameters",void 0);v([Q("_markAllSubMeshesAsFresnelDirty")],Ee.prototype,"reflectionFresnelParameters",void 0);v([mu("refractionFresnelParameters")],Ee.prototype,"_refractionFresnelParameters",void 0);v([Q("_markAllSubMeshesAsFresnelDirty")],Ee.prototype,"refractionFresnelParameters",void 0);v([mu("emissiveFresnelParameters")],Ee.prototype,"_emissiveFresnelParameters",void 0);v([Q("_markAllSubMeshesAsFresnelDirty")],Ee.prototype,"emissiveFresnelParameters",void 0);v([I("useReflectionFresnelFromSpecular")],Ee.prototype,"_useReflectionFresnelFromSpecular",void 0);v([Q("_markAllSubMeshesAsFresnelDirty")],Ee.prototype,"useReflectionFresnelFromSpecular",void 0);v([I("useGlossinessFromSpecularMapAlpha")],Ee.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"useGlossinessFromSpecularMapAlpha",void 0);v([I("maxSimultaneousLights")],Ee.prototype,"_maxSimultaneousLights",void 0);v([Q("_markAllSubMeshesAsLightsDirty")],Ee.prototype,"maxSimultaneousLights",void 0);v([I("invertNormalMapX")],Ee.prototype,"_invertNormalMapX",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"invertNormalMapX",void 0);v([I("invertNormalMapY")],Ee.prototype,"_invertNormalMapY",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"invertNormalMapY",void 0);v([I("twoSidedLighting")],Ee.prototype,"_twoSidedLighting",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Ee.prototype,"twoSidedLighting",void 0);v([I("applyDecalMapAfterDetailMap")],Ee.prototype,"_applyDecalMapAfterDetailMap",void 0);v([Q("_markAllSubMeshesAsMiscDirty")],Ee.prototype,"applyDecalMapAfterDetailMap",void 0);P("BABYLON.StandardMaterial",Ee);Te.DefaultMaterialFactory=s=>new Ee("default material",s);at.prototype.createDynamicTexture=function(s,e,t,i){let r=new Je(this,ke.Dynamic);return r.baseWidth=s,r.baseHeight=e,t&&(s=this.needPOTTextures?Rr(s,this._caps.maxTextureSize):s,e=this.needPOTTextures?Rr(e,this._caps.maxTextureSize):e),r.width=s,r.height=e,r.isReady=!1,r.generateMipMaps=t,r.samplingMode=i,this.updateTextureSamplingMode(i,r),this._internalTexturesCache.push(r),r};at.prototype.updateDynamicTexture=function(s,e,t,i=!1,r,n=!1,o=!1){if(!s)return;let a=this._gl,l=a.TEXTURE_2D,c=this._bindTextureDirectly(l,s,!0,n);this._unpackFlipY(t===void 0?s.invertY:t),i&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);let h=this._getWebGLTextureType(s.type),u=this._getInternalFormat(r||s.format),d=this._getRGBABufferInternalSizedFormat(s.type,u);a.texImage2D(l,0,d,u,h,e),s.generateMipMaps&&a.generateMipmap(l),c||this._bindTextureDirectly(l,null),i&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),r&&(s.format=r),s._dynamicTextureSource=e,s._premulAlpha=i,s.invertY=t||!1,s.isReady=!0};var Hl=class s extends z{constructor(e,t,i=null,r=!1,n=3,o=5,a){super(null,i,!r,a,n,void 0,void 0,void 0,void 0,o),this.name=e,this.wrapU=z.CLAMP_ADDRESSMODE,this.wrapV=z.CLAMP_ADDRESSMODE,this._generateMipMaps=r;let l=this._getEngine();if(!l)return;t.getContext?(this._canvas=t,this._ownCanvas=!1,this._texture=l.createDynamicTexture(t.width,t.height,r,n)):(this._canvas=l.createCanvas(1,1),this._ownCanvas=!0,t.width||t.width===0?this._texture=l.createDynamicTexture(t.width,t.height,r,n):this._texture=l.createDynamicTexture(t,t,r,n));let c=this.getSize();this._canvas.width!==c.width&&(this._canvas.width=c.width),this._canvas.height!==c.height&&(this._canvas.height=c.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){let t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){let i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(e){let t=this.getSize();e&&(this._context.fillStyle=e),this._context.clearRect(0,0,t.width,t.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,e===void 0?!0:e,t,this._format||void 0,void 0,i)}drawText(e,t,i,r,n,o,a,l=!0){let c=this.getSize();if(o&&(this._context.fillStyle=o,this._context.fillRect(0,0,c.width,c.height)),this._context.font=r,t==null){let h=this._context.measureText(e);t=(c.width-h.width)/2}if(i==null){let h=parseInt(r.replace(/\D/g,""));i=c.height/2+h/3.65}this._context.fillStyle=n||"",this._context.fillText(e,t,i),l&&this.update(a)}dispose(){super.dispose(),this._ownCanvas&&this._canvas?.remove?.(),this._canvas=null,this._context=null}clone(){let e=this.getScene();if(!e)return this;let t=this.getSize(),i=new s(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){let e=this.getScene();e&&!e.isReady()&&F.Warn("The scene must be ready before serializing the dynamic texture");let t=super.serialize();return s._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return e.toDataURL!==void 0}_rebuild(){this.update()}};var Xl=class{get isFixedFoveationSupported(){return this.layerType=="XRWebGLLayer"&&typeof this.layer.fixedFoveation=="number"}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){let t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}createRenderTargetTextureProvider(e){return this._rttWrapper=this._createRenderTargetTextureProvider(e),this._rttWrapper}dispose(){this._rttWrapper&&(this._rttWrapper.dispose(),this._rttWrapper=null)}constructor(e,t,i,r,n){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this._createRenderTargetTextureProvider=n,this._rttWrapper=null}};var Yl=class{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){let i=new Je(this._engine,ke.Unknown,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new Ho(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,r,n,o){if(!this._engine)throw new Error("Engine is disposed");let a={width:e,height:t},l=o?new uh(this._scene,a):new vt("XR renderTargetTexture",a,this._scene),c=l.renderTarget;if(c._samples=l.samples,(i||!r)&&(c._framebuffer=i),r)if(o)c._colorTextureArray=r;else{let h=this._createInternalTexture(a,r);c.setTexture(h,0),l._texture=h}return n&&(o?c._depthStencilTextureArray=n:c._depthStencilTexture=this._createInternalTexture(a,n)),l.disableRescaling(),this._renderTargetTextures.push(l),l}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach(e=>e.dispose()),this._renderTargetTextures.length=0}};var $l=class extends Xl{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new XI(t.scene,this)),this.layer=e}},XI=class extends Yl{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){let i=this._layer.getViewport(t);if(!i)return!1;let r=this._framebufferDimensions.framebufferWidth,n=this._framebufferDimensions.framebufferHeight;return e.x=i.x/r,e.y=i.y/n,e.width=i.width/r,e.height=i.height/n,!0}getRenderTargetTextureForEye(e){let t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,r=this._layer.framebuffer;return(!this._rtt||t!==this._framebufferDimensions.framebufferWidth||i!==this._framebufferDimensions.framebufferHeight||r!==this._framebuffer)&&(this._rtt=this._createRenderTargetTexture(t,i,r),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=r),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}};var cm=class s{static GetDefaults(e){let t=new s;return t.canvasOptions={antialias:!0,depth:!0,stencil:e?e.isStencilEnable:!0,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}},fv=class{constructor(e,t=cm.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new U,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{let i=document.createElement("canvas");i.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(i)}e.onXRSessionInit.add(()=>{this._addCanvas()}),e.onXRSessionEnded.add(()=>{this._removeCanvas()}),this._makeCanvasCompatibleAsync()}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null)}_makeCanvasCompatibleAsync(){this._canvasCompatiblePromise=new Promise(e=>{this.canvasContext&&this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then(()=>{e()}):e()})}initializeXRLayerAsync(e){return $e(this,null,function*(){let t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new $l(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this._canvasCompatiblePromise.then(()=>{},()=>{H.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly.")}).then(()=>t())})}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(()=>{this._setCanvasSize(!0)})}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){!this._canvas||!this._engine||(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}};var pv=class extends Xl{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new YI(t,this)),this.layer=e}},YI=class extends Yl{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}},mv=class{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}initializeXRLayerAsync(e){return $e(this,null,function*(){return yield this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer})}dispose(){}};var bd=class s{get worldScalingFactor(){return this._worldScalingFactor}set worldScalingFactor(e){let t=this._worldScalingFactor;this._worldScalingFactor=e,this.onWorldScaleFactorChangedObservable.notifyObservers({previousScaleFactor:t,newScaleFactor:e})}constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new U,this.onXRReferenceSpaceChanged=new U,this.onXRSessionEnded=new U,this.onXRSessionInit=new U,this.onXRReferenceSpaceInitialized=new U,this.onXRReady=new U,this.inXRFrameLoop=!1,this.inXRSession=!1,this._worldScalingFactor=1,this.onWorldScaleFactorChangedObservable=new U(void 0,!0),this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),e.onDisposeObservable.addOnce(()=>{this.dispose()})}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){this.inXRSession&&this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),this.onWorldScaleFactorChangedObservable.clear(),this._engine?.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}exitXRAsync(){return $e(this,null,function*(){if(this.session&&this.inXRSession){this.inXRSession=!1;try{return yield this.session.end()}catch{F.Warn("Could not end XR session.")}}return Promise.resolve()})}trySetViewportForView(e,t){return this._baseLayerRTTProvider?.trySetViewportForView(e,t)||!1}getRenderTargetTextureForEye(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForEye(e)||null}getRenderTargetTextureForView(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForView(e)||null}getWebXRRenderTarget(e){let t=this.scene.getEngine();return this._xrNavigator.xr.native?new mv(this):(e=e||cm.GetDefaults(t),e.canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new fv(this,e))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession(e,t).then(i=>(this.session=i,this._sessionMode=e,this.inXRSession=!0,this.onXRSessionInit.notifyObservers(i),this.session.addEventListener("end",()=>{this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null},{once:!0}),this.session))}isSessionSupportedAsync(e){return s.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){!this.inXRSession||!this._engine||(this._engine.customAnimationFrameRequester={requestAnimationFrame:e=>this.session.requestAnimationFrame(e),renderFunction:(e,t)=>{if(!(!this.inXRSession||!this._engine)&&(this.currentFrame=t,this.currentTimestamp=e,t)){this.inXRFrameLoop=!0;let i=this._baseLayerRTTProvider?.getFramebufferDimensions()||null;this._engine.framebufferDimensionsObject!==i&&(this._engine.framebufferDimensionsObject=i),this.onXRFrameObservable.notifyObservers(t),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1}}},this._engine.framebufferDimensionsObject=this._baseLayerRTTProvider?.getFramebufferDimensions()||null,this.onXRFrameObservable.addOnce(()=>{this.onXRReady.notifyObservers(this)}),typeof window<"u"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then(t=>t,t=>(F.Error("XR.requestReferenceSpace failed for the following reason: "),F.Error(t),F.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then(i=>{let r=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return i.getOffsetReferenceSpace(r)},i=>{throw F.Error(i),'XR initialization failed: required "viewer" reference space type not supported.'}))).then(t=>this.session.requestReferenceSpace("viewer").then(i=>(this.viewerReferenceSpace=i,t))).then(t=>(this.referenceSpace=this.baseReferenceSpace=t,this.onXRReferenceSpaceInitialized.notifyObservers(t),this.referenceSpace))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerWrapper=e,this._baseLayerRTTProvider=this._baseLayerWrapper?.createRenderTargetTextureProvider(this)||null}_getBaseLayerWrapper(){return this._baseLayerWrapper}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new pv(e.baseLayer):new $l(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);let t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return t?t.call(navigator.xr,e).then(i=>{let r=typeof i>"u"?!0:i;return Promise.resolve(r)}).catch(i=>(F.Warn(i),Promise.resolve(!1))):Promise.resolve(!1)}get isNative(){return this._xrNavigator.xr.native??!1}get currentFrameRate(){return this.session?.frameRate}get supportedFrameRates(){return this.session?.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():(this.inXRSession||!t)&&this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){return this._baseLayerWrapper?.isFixedFoveationSupported||!1}get fixedFoveation(){return this._baseLayerWrapper?.fixedFoveation||null}set fixedFoveation(e){let t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}get enabledFeatures(){return this.session?.enabledFeatures??null}};var Ki=function(s){return s[s.ENTERING_XR=0]="ENTERING_XR",s[s.EXITING_XR=1]="EXITING_XR",s[s.IN_XR=2]="IN_XR",s[s.NOT_IN_XR=3]="NOT_IN_XR",s}(Ki||{}),Sd=function(s){return s[s.NOT_TRACKING=0]="NOT_TRACKING",s[s.TRACKING_LOST=1]="TRACKING_LOST",s[s.TRACKING=2]="TRACKING",s}(Sd||{});k._GroundMeshParser=(s,e)=>yd.Parse(s,e);var yd=class s extends k{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);let i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){let i=this.getWorldMatrix(),r=O.Matrix[5];i.invertToRef(r);let n=O.Vector3[8];if(p.TransformCoordinatesFromFloatsToRef(e,0,t,r,n),e=n.x,t=n.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());let o=this._getFacetAt(e,t),a=-(o.x*e+o.z*t+o.w)/o.y;return p.TransformCoordinatesFromFloatsToRef(0,a,0,i,n),n.y}getNormalAtCoordinates(e,t){let i=new p(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){let r=this.getWorldMatrix(),n=O.Matrix[5];r.invertToRef(n);let o=O.Vector3[8];if(p.TransformCoordinatesFromFloatsToRef(e,0,t,n,o),e=o.x,t=o.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());let a=this._getFacetAt(e,t);return p.TransformNormalFromFloatsToRef(a.x,a.y,a.z,r,i),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){let i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),r=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),n=this._heightQuads[r*this._subdivisionsX+i],o;return t<n.slope.x*e+n.slope.y?o=n.facet1:o=n.facet2,o}_initHeightQuads(){let e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let r=0;r<e;r++){let n={slope:j.Zero(),facet1:new De(0,0,0,0),facet2:new De(0,0,0,0)};this._heightQuads[i*e+r]=n}return this}_computeHeightQuads(){let e=this.getVerticesData(y.PositionKind);if(!e)return this;let t=O.Vector3[3],i=O.Vector3[2],r=O.Vector3[1],n=O.Vector3[0],o=O.Vector3[4],a=O.Vector3[5],l=O.Vector3[6],c=O.Vector3[7],h=O.Vector3[8],u=0,d=0,f=0,m=0,g=0,_=0,x=0,b=this._subdivisionsX,C=this._subdivisionsY;for(let R=0;R<C;R++)for(let E=0;E<b;E++){u=E*3,d=R*(b+1)*3,f=(R+1)*(b+1)*3,t.x=e[d+u],t.y=e[d+u+1],t.z=e[d+u+2],i.x=e[d+u+3],i.y=e[d+u+4],i.z=e[d+u+5],r.x=e[f+u],r.y=e[f+u+1],r.z=e[f+u+2],n.x=e[f+u+3],n.y=e[f+u+4],n.z=e[f+u+5],m=(n.z-t.z)/(n.x-t.x),g=t.z-m*t.x,i.subtractToRef(t,o),r.subtractToRef(t,a),n.subtractToRef(t,l),p.CrossToRef(l,a,c),p.CrossToRef(o,l,h),c.normalize(),h.normalize(),_=-(c.x*t.x+c.y*t.y+c.z*t.z),x=-(h.x*i.x+h.y*i.y+h.z*i.z);let S=this._heightQuads[R*b+E];S.slope.copyFromFloats(m,g),S.facet1.copyFromFloats(c.x,c.y,c.z,_),S.facet2.copyFromFloats(h.x,h.y,h.z,x)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){let i=new s(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}};function Ao(s){let e=[],t=[],i=[],r=[],n,o,a=s.width||1,l=s.height||1,c=(s.subdivisionsX||s.subdivisions||1)|0,h=(s.subdivisionsY||s.subdivisions||1)|0;for(n=0;n<=h;n++)for(o=0;o<=c;o++){let d=new p(o*a/c-a/2,0,(h-n)*l/h-l/2),f=new p(0,1,0);t.push(d.x,d.y,d.z),i.push(f.x,f.y,f.z),r.push(o/c,it.UseOpenGLOrientationForUV?n/h:1-n/h)}for(n=0;n<h;n++)for(o=0;o<c;o++)e.push(o+1+(n+1)*(c+1)),e.push(o+1+n*(c+1)),e.push(o+n*(c+1)),e.push(o+(n+1)*(c+1)),e.push(o+1+(n+1)*(c+1)),e.push(o+n*(c+1));let u=new le;return u.indices=e,u.positions=t,u.normals=i,u.uvs=r,u}function aB(s){let e=s.xmin!==void 0&&s.xmin!==null?s.xmin:-1,t=s.zmin!==void 0&&s.zmin!==null?s.zmin:-1,i=s.xmax!==void 0&&s.xmax!==null?s.xmax:1,r=s.zmax!==void 0&&s.zmax!==null?s.zmax:1,n=s.subdivisions||{w:1,h:1},o=s.precision||{w:1,h:1},a=[],l=[],c=[],h=[],u,d,f,m;n.h=n.h<1?1:n.h,n.w=n.w<1?1:n.w,o.w=o.w<1?1:o.w,o.h=o.h<1?1:o.h;let g={w:(i-e)/n.w,h:(r-t)/n.h};function _(b,C,R,E){let S=l.length/3,A=o.w+1;for(u=0;u<o.h;u++)for(d=0;d<o.w;d++){let W=[S+d+u*A,S+(d+1)+u*A,S+(d+1)+(u+1)*A,S+d+(u+1)*A];a.push(W[1]),a.push(W[2]),a.push(W[3]),a.push(W[0]),a.push(W[1]),a.push(W[3])}let L=p.Zero(),G=new p(0,1,0);for(u=0;u<=o.h;u++)for(L.z=u*(E-C)/o.h+C,d=0;d<=o.w;d++)L.x=d*(R-b)/o.w+b,L.y=0,l.push(L.x,L.y,L.z),c.push(G.x,G.y,G.z),h.push(d/o.w,u/o.h)}for(f=0;f<n.h;f++)for(m=0;m<n.w;m++)_(e+m*g.w,t+f*g.h,e+(m+1)*g.w,t+(f+1)*g.h);let x=new le;return x.indices=a,x.positions=l,x.normals=c,x.uvs=h,x}function lB(s){let e=[],t=[],i=[],r=[],n,o,a=s.colorFilter||new X(.3,.59,.11),l=s.alphaFilter||0,c=!1;if(s.minHeight>s.maxHeight){c=!0;let u=s.maxHeight;s.maxHeight=s.minHeight,s.minHeight=u}for(n=0;n<=s.subdivisions;n++)for(o=0;o<=s.subdivisions;o++){let u=new p(o*s.width/s.subdivisions-s.width/2,0,(s.subdivisions-n)*s.height/s.subdivisions-s.height/2),d=(u.x+s.width/2)/s.width*(s.bufferWidth-1)|0,f=(1-(u.z+s.height/2)/s.height)*(s.bufferHeight-1)|0,m=(d+f*s.bufferWidth)*4,g=s.buffer[m]/255,_=s.buffer[m+1]/255,x=s.buffer[m+2]/255,b=s.buffer[m+3]/255;c&&(g=1-g,_=1-_,x=1-x);let C=g*a.r+_*a.g+x*a.b;b>=l?u.y=s.minHeight+(s.maxHeight-s.minHeight)*C:u.y=s.minHeight-je,s.heightBuffer&&(s.heightBuffer[n*(s.subdivisions+1)+o]=u.y),t.push(u.x,u.y,u.z),i.push(0,0,0),r.push(o/s.subdivisions,1-n/s.subdivisions)}for(n=0;n<s.subdivisions;n++)for(o=0;o<s.subdivisions;o++){let u=o+1+(n+1)*(s.subdivisions+1),d=o+1+n*(s.subdivisions+1),f=o+n*(s.subdivisions+1),m=o+(n+1)*(s.subdivisions+1),g=t[u*3+1]>=s.minHeight,_=t[d*3+1]>=s.minHeight,x=t[f*3+1]>=s.minHeight;g&&_&&x&&(e.push(u),e.push(d),e.push(f)),t[m*3+1]>=s.minHeight&&g&&x&&(e.push(m),e.push(u),e.push(f))}le.ComputeNormals(t,e,i);let h=new le;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function Ed(s,e={},t){let i=new yd(s,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,Ao(e).applyToMesh(i,e.updatable),i._setReady(!0),i}function cB(s,e,t=null){let i=new k(s,t);return aB(e).applyToMesh(i,e.updatable),i}function hB(s,e,t={},i=null){let r=t.width||10,n=t.height||10,o=t.subdivisions||1,a=t.minHeight||0,l=t.maxHeight||1,c=t.colorFilter||new X(.3,.59,.11),h=t.alphaFilter||0,u=t.updatable,d=t.onReady;i=i||me.LastCreatedScene;let f=new yd(s,i);f._subdivisionsX=o,f._subdivisionsY=o,f._width=r,f._height=n,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1);let m;t.passHeightBufferInCallback&&(m=new Float32Array((o+1)*(o+1)));let g=(_,x,b)=>{lB({width:r,height:n,subdivisions:o,minHeight:a,maxHeight:l,colorFilter:c,buffer:_,bufferWidth:x,bufferHeight:b,alphaFilter:h,heightBuffer:m}).applyToMesh(f,u),d&&d(f,m),f._setReady(!0)};if(typeof e=="string"){let _=x=>{let b=x.width,C=x.height;if(i.isDisposed)return;let R=i?.getEngine().resizeImageBitmap(x,b,C);g(R,b,C)};H.LoadImage(e,_,t.onError?t.onError:()=>{},i.offlineProvider)}else g(e.data,e.width,e.height);return f}le.CreateGround=Ao;le.CreateTiledGround=aB;le.CreateGroundFromHeightMap=lB;k.CreateGround=(s,e,t,i,r,n)=>Ed(s,{width:e,height:t,subdivisions:i,updatable:n},r);k.CreateTiledGround=(s,e,t,i,r,n,o,a,l)=>cB(s,{xmin:e,zmin:t,xmax:i,zmax:r,subdivisions:n,precision:o,updatable:l},a);k.CreateGroundFromHeightMap=(s,e,t,i,r,n,o,a,l,c,h)=>hB(s,e,{width:t,height:i,subdivisions:r,minHeight:n,maxHeight:o,updatable:l,onReady:c,alphaFilter:h},a);function gv(s){let e=[],t=[],i=[],r=[],n=s.diameter||1,o=s.thickness||.5,a=(s.tessellation||16)|0,l=s.sideOrientation===0?0:s.sideOrientation||le.DEFAULTSIDE,c=a+1;for(let u=0;u<=a;u++){let d=u/a,f=u*Math.PI*2/a-Math.PI/2,m=N.Translation(n/2,0,0).multiply(N.RotationY(f));for(let g=0;g<=a;g++){let _=1-g/a,x=g*Math.PI*2/a+Math.PI,b=Math.cos(x),C=Math.sin(x),R=new p(b,C,0),E=R.scale(o/2),S=new j(d,_);E=p.TransformCoordinates(E,m),R=p.TransformNormal(R,m),t.push(E.x,E.y,E.z),i.push(R.x,R.y,R.z),r.push(S.x,it.UseOpenGLOrientationForUV?1-S.y:S.y);let A=(u+1)%c,L=(g+1)%c;e.push(u*c+g),e.push(u*c+L),e.push(A*c+g),e.push(u*c+L),e.push(A*c+L),e.push(A*c+g)}}le._ComputeSides(l,t,e,i,r,s.frontUVs,s.backUVs);let h=new le;return h.indices=e,h.positions=t,h.normals=i,h.uvs=r,h}function vn(s,e={},t){let i=new k(s,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,gv(e).applyToMesh(i,e.updatable),i}le.CreateTorus=gv;k.CreateTorus=(s,e,t,i,r,n,o)=>vn(s,{diameter:e,thickness:t,tessellation:i,sideOrientation:o,updatable:n},r);var G5=(()=>{class s{constructor(t,i=null){if(this.scene=t,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=s._IdCounter++,i)this._gazeTracker=i.clone("gazeTracker");else{this._gazeTracker=vn("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},t),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;let r=new Ee("targetMat",t);r.specularColor=X.Black(),r.emissiveColor=new X(.7,.7,.7),r.backFaceCulling=!1,this._gazeTracker.material=r}}_getForwardRay(t){return new pt(p.Zero(),new p(0,0,t))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(t=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}return s._IdCounter=0,s})(),_v=class extends G5{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){let t=this._getCamera();return t?t.getForwardRay(e):new pt(p.Zero(),p.Forward())}};var uB=(()=>{class s{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(t){t&&(t.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=t)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(t){t&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._cameraGazer._gazeTracker=t,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker")}get displayGaze(){return this._displayGaze}set displayGaze(t){this._displayGaze=t,t||(this._cameraGazer._gazeTracker.isVisible=!1)}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(t){this._displayLaserPointer=t}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._scene.activeCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated}constructor(t,i={}){if(this.webVROptions=i,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new U,this.onAfterEnteringVRObservable=new U,this.onExitingVRObservable=new U,this._useCustomVRButton=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=s.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new p(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new p(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._pickedLaserColor=new X(.2,.2,1),this._pickedGazeColor=new X(0,0,1),this.onNewMeshSelected=new U,this.onNewMeshPicked=new U,this.onBeforeCameraTeleport=new U,this.onAfterCameraTeleport=new U,this.onSelectedMeshUnselected=new U,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock||(this._cameraGazer._gazeTracker.isVisible=!1)},this._onNewGamepadConnected=n=>{n.type!==Tr.POSE_ENABLED&&(n.leftStick&&n.onleftstickchanged(o=>{this._teleportationInitialized&&this.teleportationEnabled&&(this._checkTeleportWithRay(o,this._cameraGazer),this._checkTeleportBackwards(o,this._cameraGazer))}),n.rightStick&&n.onrightstickchanged(o=>{this._teleportationInitialized&&this._checkRotate(o,this._cameraGazer)}),n.type===Tr.XBOX&&(n.onbuttondown(o=>{this._interactionsEnabled&&o===js.A&&this._cameraGazer._selectionPointerDown()}),n.onbuttonup(o=>{this._interactionsEnabled&&o===js.A&&this._cameraGazer._selectionPointerUp()})))},this._workingVector=p.Zero(),this._workingQuaternion=q.Identity(),this._workingMatrix=N.Identity(),F.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=t,this._inputElement=t.getEngine().getInputElement(),!("getVRDisplays"in navigator)&&i.useXR===void 0&&(i.useXR=!0),i.createFallbackVRDeviceOrientationFreeCamera===void 0&&(i.createFallbackVRDeviceOrientationFreeCamera=!0),i.createDeviceOrientationCamera===void 0&&(i.createDeviceOrientationCamera=!0),i.laserToggle===void 0&&(i.laserToggle=!0),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new p(0,this._defaultHeight,0),i.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new lh("deviceOrientationVRHelper",this._position.clone(),t),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof lr&&this._scene.activeCamera.rotation)){let n=this._scene.activeCamera;n.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(n.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(q.RotationYawPitchRoll(n.rotation.y,n.rotation.x,n.rotation.z)),this._deviceOrientationCamera.rotation=n.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?bd.IsSessionSupportedAsync("immersive-vr").then(n=>{n?(F.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),t.createDefaultXRExperienceAsync({floorMeshes:i.floorMeshes||[]}).then(o=>{this.xr=o,this.xrTestDone=!0,this._cameraGazer=new _v(()=>this.xr.baseExperience.camera,t),this.xr.baseExperience.onStateChangedObservable.add(a=>{switch(a){case Ki.ENTERING_XR:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case Ki.EXITING_XR:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case Ki.IN_XR:this._hasEnteredVR=!0;break;case Ki.NOT_IN_XR:this._hasEnteredVR=!1;break}})})):this._completeVRInit(t,i)}):this._completeVRInit(t,i)}_completeVRInit(t,i){if(this.xrTestDone=!0,i.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new dh("VRDeviceOrientationVRHelper",this._position,this._scene,!0,i.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._cameraGazer=new _v(()=>this.currentVRCamera,t),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let o=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";o+=".babylonVRicon.vrdisplaypresenting { display: none; }";let a=document.createElement("style");a.appendChild(document.createTextNode(o)),document.getElementsByTagName("head")[0].appendChild(a),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",()=>{this.isInVRMode||this.enterVR()});let r=this._scene.getEngine().getHostWindow();r&&(r.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),i.createFallbackVRDeviceOrientationFreeCamera&&this._displayVRButton(),this._onKeyDown=n=>{n.keyCode===27&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())},Ae.POINTERDOUBLETAP,!1),t.onDisposeObservable.add(()=>{this.dispose()}),this._updateButtonVisibility(),this._circleEase=new Rx,this._circleEase.setEasingMode(fs.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,t.onPointerObservable.add(n=>{this._interactionsEnabled&&t.activeCamera===this.vrDeviceOrientationCamera&&n.event.pointerType==="mouse"&&(n.type===Ae.POINTERDOWN?this._cameraGazer._selectionPointerDown():n.type===Ae.POINTERUP&&this._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===Ki.IN_XR||this._fullscreenVRpresenting}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){let t=this._inputElement.getBoundingClientRect();this._btnVR.style.top=t.top+t.height-70+"px",this._btnVR.style.left=t.left+t.width-100+"px"}}_displayVRButton(){!this._useCustomVRButton&&!this._btnVRDisplayed&&this._btnVR&&(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){!this._btnVR||this._useCustomVRButton||(this._btnVR.className="babylonVRicon",this.isInVRMode&&(this._btnVR.className+=" vrdisplaypresenting"))}enterVR(){if(this.xr){this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);return}if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(t){F.Warn("Error in your custom logic onEnteringVR: "+t)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=q.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)),this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._hasEnteredVR=!0}exitVR(){if(this.xr){this.xr.baseExperience.exitXRAsync();return}if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(t){F.Warn("Error in your custom logic onExitingVR: "+t)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1),this._scene.getEngine().resize(),this._hasEnteredVR=!1}}get position(){return this._position}set position(t){this._position=t,this._scene.activeCamera&&(this._scene.activeCamera.position=t)}enableInteractions(){if(!this._interactionsEnabled){if(this.xr){this.xr.baseExperience.state===Ki.IN_XR&&this.xr.pointerSelection.attach();return}this.raySelectionPredicate=t=>t.isVisible&&(t.isPickable||t.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=t=>this._isTeleportationFloor(t)||t.name.indexOf("gazeTracker")===-1&&t.name.indexOf("teleportationTarget")===-1&&t.name.indexOf("torusTeleportation")===-1?this.raySelectionPredicate(t):!1,this._interactionsEnabled=!0}}_isTeleportationFloor(t){for(let i=0;i<this._floorMeshesCollection.length;i++)if(this._floorMeshesCollection[i].id===t.id)return!0;return!!(this._floorMeshName&&t.name===this._floorMeshName)}addFloorMesh(t){this._floorMeshesCollection&&(this._floorMeshesCollection.indexOf(t)>-1||this._floorMeshesCollection.push(t))}removeFloorMesh(t){if(!this._floorMeshesCollection)return;let i=this._floorMeshesCollection.indexOf(t);i!==-1&&this._floorMeshesCollection.splice(i,1)}enableTeleportation(t={}){if(!this._teleportationInitialized){if(this.enableInteractions(),this.webVROptions.useXR&&(t.floorMeshes||t.floorMeshName)){let r=t.floorMeshes||[];if(!r.length){let n=this._scene.getMeshByName(t.floorMeshName);n&&r.push(n)}if(this.xr){r.forEach(n=>{this.xr.teleportation.addFloorMesh(n)}),this.xr.teleportation.attached||this.xr.teleportation.attach();return}else if(!this.xrTestDone){let n=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(n),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(t))};this._scene.registerBeforeRender(n);return}}t.floorMeshName&&(this._floorMeshName=t.floorMeshName),t.floorMeshes&&(this._floorMeshesCollection=t.floorMeshes),t.teleportationMode&&(this._teleportationMode=t.teleportationMode),t.teleportationTime&&t.teleportationTime>0&&(this._teleportationTime=t.teleportationTime),t.teleportationSpeed&&t.teleportationSpeed>0&&(this._teleportationSpeed=t.teleportationSpeed),t.easingFunction!==void 0&&(this._teleportationEasing=t.easingFunction);let i=new rt;i.vignetteColor=new oe(0,0,0,0),i.vignetteEnabled=!0,this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&this._createTeleportationCircles()}}_checkTeleportWithRay(t,i){this._teleportationRequestInitiated&&!i._teleportationRequestInitiated||(i._teleportationRequestInitiated?Math.sqrt(t.y*t.y+t.x*t.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),i._teleportationRequestInitiated=!1):t.y<-this._padSensibilityUp&&i._dpadPressed&&(i._activatePointer(),i._teleportationRequestInitiated=!0))}_checkRotate(t,i){i._teleportationRequestInitiated||(i._rotationLeftAsked?t.x>-this._padSensibilityDown&&(i._rotationLeftAsked=!1):t.x<-this._padSensibilityUp&&i._dpadPressed&&(i._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),i._rotationRightAsked?t.x<this._padSensibilityDown&&(i._rotationRightAsked=!1):t.x>this._padSensibilityUp&&i._dpadPressed&&(i._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(t,i){if(!i._teleportationRequestInitiated)if(t.y>this._padSensibilityUp&&i._dpadPressed){if(!i._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;let r=q.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),n=this.currentVRCamera.position;r.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,q.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),p.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);let o=new pt(n,this._workingVector),a=this._scene.pickWithRay(o,this._raySelectionPredicate);a&&a.pickedPoint&&a.pickedMesh&&this._isTeleportationFloor(a.pickedMesh)&&a.distance<5&&this.teleportCamera(a.pickedPoint),i._teleportationBackRequestInitiated=!0}}else i._teleportationBackRequestInitiated=!1}_createTeleportationCircles(){this._teleportationTarget=Ed("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;let t=512,i=new Hl("DynamicTexture",t,this._scene,!0);i.hasAlpha=!0;let r=i.getContext(),n=t/2,o=t/2,a=200;r.beginPath(),r.arc(n,o,a,0,2*Math.PI,!1),r.fillStyle=this._teleportationFillColor,r.fill(),r.lineWidth=10,r.strokeStyle=this._teleportationBorderColor,r.stroke(),r.closePath(),i.update();let l=new Ee("TextPlaneMaterial",this._scene);l.diffuseTexture=i,this._teleportationTarget.material=l;let c=vn("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);c.isPickable=!1,c.parent=this._teleportationTarget;let h=new te("animationInnerCircle","position.y",30,te.ANIMATIONTYPE_FLOAT,te.ANIMATIONLOOPMODE_CYCLE),u=[];u.push({frame:0,value:0}),u.push({frame:30,value:.4}),u.push({frame:60,value:0}),h.setKeys(u);let d=new hd;d.setEasingMode(fs.EASINGMODE_EASEINOUT),h.setEasingFunction(d),c.animations=[],c.animations.push(h),this._scene.beginAnimation(c,0,60,!0),this._hideTeleportationTarget()}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(t){if(!(this.currentVRCamera instanceof wi))return;t?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];let i=q.FromRotationMatrix(N.RotationY(Math.PI/4*this._rotationAngle)),r=new te("animationRotation","rotationQuaternion",90,te.ANIMATIONTYPE_QUATERNION,te.ANIMATIONLOOPMODE_CONSTANT),n=[];n.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),n.push({frame:6,value:i}),r.setKeys(n),r.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(r),this._postProcessMove.animations=[];let o=new te("animationPP","vignetteWeight",90,te.ANIMATIONTYPE_FLOAT,te.ANIMATIONLOOPMODE_CONSTANT),a=[];a.push({frame:0,value:0}),a.push({frame:3,value:4}),a.push({frame:6,value:0}),o.setKeys(a),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o);let l=new te("animationPP2","vignetteStretch",90,te.ANIMATIONTYPE_FLOAT,te.ANIMATIONLOOPMODE_CONSTANT),c=[];c.push({frame:0,value:0}),c.push({frame:3,value:10}),c.push({frame:6,value:0}),l.setKeys(c),l.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(l),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}teleportCamera(t){if(!(this.currentVRCamera instanceof wi))return;this._workingVector.copyFrom(t),this.isInVRMode||(this._workingVector.y+=this._defaultHeight),this.onBeforeCameraTeleport.notifyObservers(this._workingVector);let i=90,r,n;if(this._teleportationMode==s.TELEPORTATIONMODE_CONSTANTSPEED){n=i;let f=p.Distance(this.currentVRCamera.position,this._workingVector);r=this._teleportationSpeed/f}else n=Math.round(this._teleportationTime*i/1e3),r=1;this.currentVRCamera.animations=[];let o=new te("animationCameraTeleportation","position",i,te.ANIMATIONTYPE_VECTOR3,te.ANIMATIONLOOPMODE_CONSTANT),a=[{frame:0,value:this.currentVRCamera.position},{frame:n,value:this._workingVector}];o.setKeys(a),o.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(o),this._postProcessMove.animations=[];let l=Math.round(n/2),c=new te("animationPP","vignetteWeight",i,te.ANIMATIONTYPE_FLOAT,te.ANIMATIONLOOPMODE_CONSTANT),h=[];h.push({frame:0,value:0}),h.push({frame:l,value:8}),h.push({frame:n,value:0}),c.setKeys(h),this._postProcessMove.animations.push(c);let u=new te("animationPP2","vignetteStretch",i,te.ANIMATIONTYPE_FLOAT,te.ANIMATIONLOOPMODE_CONSTANT),d=[];d.push({frame:0,value:0}),d.push({frame:l,value:10}),d.push({frame:n,value:0}),u.setKeys(d),this._postProcessMove.animations.push(u),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._scene.beginAnimation(this.currentVRCamera,0,n,!1,r,()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)}),this._hideTeleportationTarget()}setLaserColor(t,i=this._pickedLaserColor){this._pickedLaserColor=i}setLaserLightingState(t=!0){}setGazeColor(t,i=this._pickedGazeColor){this._pickedGazeColor=i}changeLaserColor(t){this.updateControllerLaserColor}changeGazeColor(t){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=t)}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}return s.TELEPORTATIONMODE_CONSTANTTIME=0,s.TELEPORTATIONMODE_CONSTANTSPEED=1,s})();var z5=(s,e,t,i)=>!(s.x>t.x+i||t.x-i>e.x||s.y>t.y+i||t.y-i>e.y||s.z>t.z+i||t.z-i>e.z),Ad=function(){let s={root:0,found:!1};return function(e,t,i,r){s.root=0,s.found=!1;let n=t*t-4*e*i;if(n<0)return s;let o=Math.sqrt(n),a=(-t-o)/(2*e),l=(-t+o)/(2*e);if(a>l){let c=l;l=a,a=c}return a>0&&a<r?(s.root=a,s.found=!0,s):(l>0&&l<r&&(s.root=l,s.found=!0),s)}}(),dB=(()=>{class s{constructor(){this._collisionPoint=p.Zero(),this._planeIntersectionPoint=p.Zero(),this._tempVector=p.Zero(),this._tempVector2=p.Zero(),this._tempVector3=p.Zero(),this._tempVector4=p.Zero(),this._edge=p.Zero(),this._baseToVertex=p.Zero(),this._destinationPoint=p.Zero(),this._slidePlaneNormal=p.Zero(),this._displacementVector=p.Zero(),this._radius=p.One(),this._retry=0,this._basePointWorld=p.Zero(),this._velocityWorld=p.Zero(),this._normalizedVelocity=p.Zero(),this._collisionMask=-1}get collisionMask(){return this._collisionMask}set collisionMask(t){this._collisionMask=isNaN(t)?-1:t}get slidePlaneNormal(){return this._slidePlaneNormal}_initialize(t,i,r){this._velocity=i,this._velocitySquaredLength=this._velocity.lengthSquared();let n=Math.sqrt(this._velocitySquaredLength);n===0||n===1?this._normalizedVelocity.copyFromFloats(i._x,i._y,i._z):i.scaleToRef(1/n,this._normalizedVelocity),this._basePoint=t,t.multiplyToRef(this._radius,this._basePointWorld),i.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=r,this.collisionFound=!1}_checkPointInTriangle(t,i,r,n,o){i.subtractToRef(t,this._tempVector),r.subtractToRef(t,this._tempVector2),p.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);let a=p.Dot(this._tempVector4,o);return a<0||(n.subtractToRef(t,this._tempVector3),p.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),a=p.Dot(this._tempVector4,o),a<0)?!1:(p.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),a=p.Dot(this._tempVector4,o),a>=0)}_canDoCollision(t,i,r,n){let o=p.Distance(this._basePointWorld,t),a=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(o>this._velocityWorldLength+a+i||!z5(r,n,this._basePointWorld,this._velocityWorldLength+a))}_testTriangle(t,i,r,n,o,a,l){let c,h=!1;i||(i=[]),i[t]||(i[t]=new zs(0,0,0,0),i[t].copyFromPoints(r,n,o));let u=i[t];if(!a&&!u.isFrontFacingTo(this._normalizedVelocity,0))return;let d=u.signedDistanceTo(this._basePoint),f=p.Dot(u.normal,this._velocity);if(s.DoubleSidedCheck&&f>1e-4)return;if(f==0){if(Math.abs(d)>=1)return;h=!0,c=0}else{c=(-1-d)/f;let _=(1-d)/f;if(c>_){let x=_;_=c,c=x}if(c>1||_<0)return;c<0&&(c=0),c>1&&(c=1)}this._collisionPoint.copyFromFloats(0,0,0);let m=!1,g=1;if(h||(this._basePoint.subtractToRef(u.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(c,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,r,n,o,u.normal)&&(m=!0,g=c,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!m){let _=this._velocitySquaredLength;this._basePoint.subtractToRef(r,this._tempVector);let x=2*p.Dot(this._velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,C=Ad(_,x,b,g);C.found&&(g=C.root,m=!0,this._collisionPoint.copyFrom(r)),this._basePoint.subtractToRef(n,this._tempVector),x=2*p.Dot(this._velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,C=Ad(_,x,b,g),C.found&&(g=C.root,m=!0,this._collisionPoint.copyFrom(n)),this._basePoint.subtractToRef(o,this._tempVector),x=2*p.Dot(this._velocity,this._tempVector),b=this._tempVector.lengthSquared()-1,C=Ad(_,x,b,g),C.found&&(g=C.root,m=!0,this._collisionPoint.copyFrom(o)),n.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex);let R=this._edge.lengthSquared(),E=p.Dot(this._edge,this._velocity),S=p.Dot(this._edge,this._baseToVertex);if(_=R*-this._velocitySquaredLength+E*E,x=2*(R*p.Dot(this._velocity,this._baseToVertex)-E*S),b=R*(1-this._baseToVertex.lengthSquared())+S*S,C=Ad(_,x,b,g),C.found){let A=(E*C.root-S)/R;A>=0&&A<=1&&(g=C.root,m=!0,this._edge.scaleInPlace(A),r.addToRef(this._edge,this._collisionPoint))}if(o.subtractToRef(n,this._edge),n.subtractToRef(this._basePoint,this._baseToVertex),R=this._edge.lengthSquared(),E=p.Dot(this._edge,this._velocity),S=p.Dot(this._edge,this._baseToVertex),_=R*-this._velocitySquaredLength+E*E,x=2*(R*p.Dot(this._velocity,this._baseToVertex)-E*S),b=R*(1-this._baseToVertex.lengthSquared())+S*S,C=Ad(_,x,b,g),C.found){let A=(E*C.root-S)/R;A>=0&&A<=1&&(g=C.root,m=!0,this._edge.scaleInPlace(A),n.addToRef(this._edge,this._collisionPoint))}if(r.subtractToRef(o,this._edge),o.subtractToRef(this._basePoint,this._baseToVertex),R=this._edge.lengthSquared(),E=p.Dot(this._edge,this._velocity),S=p.Dot(this._edge,this._baseToVertex),_=R*-this._velocitySquaredLength+E*E,x=2*(R*p.Dot(this._velocity,this._baseToVertex)-E*S),b=R*(1-this._baseToVertex.lengthSquared())+S*S,C=Ad(_,x,b,g),C.found){let A=(E*C.root-S)/R;A>=0&&A<=1&&(g=C.root,m=!0,this._edge.scaleInPlace(A),o.addToRef(this._edge,this._collisionPoint))}}if(m){let _=g*g*this._velocitySquaredLength;(!this.collisionFound||_<this._nearestDistanceSquared)&&(l.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=_,this._nearestDistance=Math.sqrt(_),this.collisionFound=!0),this.collidedMesh=l)}}_collide(t,i,r,n,o,a,l,c,h,u=!1){if(u)if(!r||r.length===0)for(let d=0;d<i.length-2;d+=1){let f=i[d],m=i[d+1],g=i[d+2];!f||!m||!g||((h?1:0)^d%2?this._testTriangle(d,t,f,m,g,l,c):this._testTriangle(d,t,m,f,g,l,c))}else for(let d=n;d<o-2;d+=1){let f=r[d],m=r[d+1],g=r[d+2];if(g===4294967295){d+=2;continue}let _=i[f],x=i[m],b=i[g];!_||!x||!b||((h?1:0)^d%2?this._testTriangle(d,t,_,x,b,l,c):this._testTriangle(d,t,x,_,b,l,c))}else if(!r||r.length===0)for(let d=0;d<i.length;d+=3){let f=i[d],m=i[d+1],g=i[d+2];h?this._testTriangle(d,t,f,m,g,l,c):this._testTriangle(d,t,g,m,f,l,c)}else for(let d=n;d<o;d+=3){let f=i[r[d]-a],m=i[r[d+1]-a],g=i[r[d+2]-a];h?this._testTriangle(d,t,f,m,g,l,c):this._testTriangle(d,t,g,m,f,l,c)}}_getResponse(t,i){t.addToRef(i,this._destinationPoint),i.scaleInPlace(this._nearestDistance/i.length()),this._basePoint.addToRef(i,t),t.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),t.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(zs.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,i)}}return s.DoubleSidedCheck=!1,s})();var $I=class{constructor(){this._scaledPosition=p.Zero(),this._scaledVelocity=p.Zero(),this._finalPosition=p.Zero()}getNewPosition(e,t,i,r,n,o,a){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,n),this._finalPosition.multiplyInPlace(i._radius),o(a,this._finalPosition,i.collidedMesh)}createCollider(){return new dB}init(e){this._scene=e}_collideWithWorld(e,t,i,r,n,o=null){let a=K.CollisionsEpsilon*10;if(i._retry>=r){n.copyFrom(e);return}let l=o?o.collisionMask:i.collisionMask;i._initialize(e,t,a);let c=o&&o.surroundingMeshes||this._scene.meshes;for(let h=0;h<c.length;h++){let u=c[h];u.isEnabled()&&u.checkCollisions&&u.subMeshes&&u!==o&&l&u.collisionGroup&&u._checkCollision(i)}if(!i.collisionFound){e.addToRef(t,n);return}if((t.x!==0||t.y!==0||t.z!==0)&&i._getResponse(e,t),t.length()<=a){n.copyFrom(e);return}i._retry++,this._collideWithWorld(e,t,i,r,n,o)}};Te.CollisionCoordinatorFactory=()=>new $I;var jI={effect:null,subMesh:null},Fi=class s extends Xs{constructor(e,t,i,r={},n=!0){super(e,t,n),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._uints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new N,this._cachedWorldViewProjectionMatrix=new N,this._multiview=!1,this._materialHelperNeedsPreviousMatrices=!1,this._shaderPath=i,this._options=ie({needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1},r)}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}get isMultiview(){return this._multiview}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)}setTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=t,this}setTextureArray(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setUInt(e,t){return this._checkUniform(e),this._uints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((i,r)=>(r.toArray(i,i.length),i),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);let i=new Float32Array(t.length*16);for(let r=0;r<t.length;r++)t[r].copyToArray(i,r*16);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}setDefine(e,t){let i=e.trimEnd()+" ",r=this.options.defines.findIndex(n=>n===e||n.startsWith(i));return r>=0&&this.options.defines.splice(r,1),(typeof t!="boolean"||t)&&this.options.defines.push(i+t),this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){let r=i&&this._storeEffectOnSubMeshes;if(this.isFrozen){let E=r?i._drawWrapper:this._drawWrapper;if(E.effect&&E._wasPreviouslyReady&&E._wasPreviouslyUsingInstances===t)return!0}let n=this.getScene(),o=n.getEngine(),a=[],l=[],c=new ps,h=this._shaderPath,u=this._options.uniforms,d=this._options.uniformBuffers,f=this._options.samplers;o.getCaps().multiview&&n.activeCamera&&n.activeCamera.outputRenderTarget&&n.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,a.push("#define MULTIVIEW"),u.indexOf("viewProjection")!==-1&&u.indexOf("viewProjectionR")===-1&&u.push("viewProjectionR"));for(let E=0;E<this._options.defines.length;E++){let S=this._options.defines[E].indexOf("#define")===0?this._options.defines[E]:`#define ${this._options.defines[E]}`;a.push(S)}for(let E=0;E<this._options.attributes.length;E++)l.push(this._options.attributes[E]);if(e&&e.isVerticesDataPresent(y.ColorKind)&&(l.indexOf(y.ColorKind)===-1&&l.push(y.ColorKind),a.push("#define VERTEXCOLOR")),t&&(a.push("#define INSTANCES"),Ds(l,this._materialHelperNeedsPreviousMatrices),e?.hasThinInstances&&(a.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(y.ColorInstanceKind)&&(l.push(y.ColorInstanceKind),a.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){l.push(y.MatricesIndicesKind),l.push(y.MatricesWeightsKind),e.numBoneInfluencers>4&&(l.push(y.MatricesIndicesExtraKind),l.push(y.MatricesWeightsExtraKind));let E=e.skeleton;a.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),c.addCPUSkinningFallback(0,e),E.isUsingTextureForMatrices?(a.push("#define BONETEXTURE"),u.indexOf("boneTextureWidth")===-1&&u.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(a.push("#define BonesPerMesh "+(E.bones.length+1)),u.indexOf("mBones")===-1&&u.push("mBones"))}else a.push("#define NUM_BONE_INFLUENCERS 0");let m=0,g=e?e.morphTargetManager:null;if(g){let E=g.supportsUVs&&a.indexOf("#define UV1")!==-1,S=g.supportsTangents&&a.indexOf("#define TANGENT")!==-1,A=g.supportsNormals&&a.indexOf("#define NORMAL")!==-1;m=g.numMaxInfluencers||g.numInfluencers,E&&a.push("#define MORPHTARGETS_UV"),S&&a.push("#define MORPHTARGETS_TANGENT"),A&&a.push("#define MORPHTARGETS_NORMAL"),m>0&&a.push("#define MORPHTARGETS"),g.isUsingTextureForTargets&&(a.push("#define MORPHTARGETS_TEXTURE"),u.indexOf("morphTargetTextureIndices")===-1&&u.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),a.push("#define NUM_MORPH_INFLUENCERS "+m);for(let L=0;L<m;L++)l.push(y.PositionKind+L),A&&l.push(y.NormalKind+L),S&&l.push(y.TangentKind+L),E&&l.push(y.UVKind+"_"+L);m>0&&(u=u.slice(),u.push("morphTargetInfluences"),u.push("morphTargetCount"),u.push("morphTargetTextureInfo"),u.push("morphTargetTextureIndices"))}else a.push("#define NUM_MORPH_INFLUENCERS 0");if(e){let E=e.bakedVertexAnimationManager;E&&E.isEnabled&&(a.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),u.indexOf("bakedVertexAnimationSettings")===-1&&u.push("bakedVertexAnimationSettings"),u.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&u.push("bakedVertexAnimationTextureSizeInverted"),u.indexOf("bakedVertexAnimationTime")===-1&&u.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),Tc(l,e,a)}for(let E in this._textures)if(!this._textures[E].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&a.push("#define ALPHATEST"),this._options.useClipPlane!==!1&&(er(u),cs(this,n,a)),n.fogEnabled&&e?.applyFog&&n.fogMode!==Te.FOGMODE_NONE&&(a.push("#define FOG"),u.indexOf("view")===-1&&u.push("view"),u.indexOf("vFogInfos")===-1&&u.push("vFogInfos"),u.indexOf("vFogColor")===-1&&u.push("vFogColor")),this._useLogarithmicDepth&&(a.push("#define LOGARITHMICDEPTH"),u.indexOf("logarithmicDepthConstant")===-1&&u.push("logarithmicDepthConstant")),this.customShaderNameResolve&&(u=u.slice(),d=d.slice(),f=f.slice(),h=this.customShaderNameResolve(this.name,u,d,f,a,l));let _=r?i._getDrawWrapper(void 0,!0):this._drawWrapper,x=_?.effect??null,b=_?.defines??null,C=a.join(`
`),R=x;return b!==C&&(R=o.createEffect(h,{attributes:l,uniformsNames:u,uniformBuffersNames:d,samplers:f,defines:C,fallbacks:c,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:m},shaderLanguage:this._options.shaderLanguage},o),r?i.setEffect(R,C,this._materialContext):_&&_.setEffect(R,C),this._onEffectCreatedObservable&&(jI.effect=R,jI.subMesh=i??e?.subMeshes[0]??null,this._onEffectCreatedObservable.notifyObservers(jI))),_._wasPreviouslyUsingInstances=!!t,R?.isReady()?(x!==R&&n.resetCachedMaterial(),_._wasPreviouslyReady=!0,!0):!1}bindOnlyWorldMatrix(e,t){let i=this.getScene(),r=t??this.getEffect();r&&(this._options.uniforms.indexOf("world")!==-1&&r.setMatrix("world",e),this._options.uniforms.indexOf("worldView")!==-1&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),r.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),r.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)),this._options.uniforms.indexOf("view")!==-1&&r.setMatrix("view",i.getViewMatrix()))}bindForSubMesh(e,t,i){this.bind(e,t,i._drawWrapperOverride?.effect,i)}bind(e,t,i,r){let n=r&&this._storeEffectOnSubMeshes,o=i??(n?r.effect:this.getEffect());if(!o)return;let a=this.getScene();this._activeEffect=o,this.bindOnlyWorldMatrix(e,i);let l=this._options.uniformBuffers,c=!1;if(o&&l&&l.length>0&&a.getEngine().supportsUniformBuffers)for(let u=0;u<l.length;++u)switch(l[u]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e));break;case"Scene":Pa(o,a.getSceneUniformBuffer()),a.finalizeSceneUbo(),c=!0;break}let h=t&&n?this._mustRebind(a,o,r,t.visibility):a.getCachedMaterial()!==this;if(o&&h){!c&&this._options.uniforms.indexOf("view")!==-1&&o.setMatrix("view",a.getViewMatrix()),!c&&this._options.uniforms.indexOf("projection")!==-1&&o.setMatrix("projection",a.getProjectionMatrix()),!c&&this._options.uniforms.indexOf("viewProjection")!==-1&&(o.setMatrix("viewProjection",a.getTransformMatrix()),this._multiview&&o.setMatrix("viewProjectionR",a._transformMatrixR)),a.activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&o.setVector3("cameraPosition",a.activeCamera.globalPosition),ao(t,o),Yi(o,this,a),this._useLogarithmicDepth&&Br(n?r.materialDefines:o.defines,o,a),t&&Ms(a,t,o);let u;for(u in this._textures)o.setTexture(u,this._textures[u]);for(u in this._textureArrays)o.setTextureArray(u,this._textureArrays[u]);for(u in this._ints)o.setInt(u,this._ints[u]);for(u in this._uints)o.setUInt(u,this._uints[u]);for(u in this._floats)o.setFloat(u,this._floats[u]);for(u in this._floatsArrays)o.setArray(u,this._floatsArrays[u]);for(u in this._colors3)o.setColor3(u,this._colors3[u]);for(u in this._colors3Arrays)o.setArray3(u,this._colors3Arrays[u]);for(u in this._colors4){let _=this._colors4[u];o.setFloat4(u,_.r,_.g,_.b,_.a)}for(u in this._colors4Arrays)o.setArray4(u,this._colors4Arrays[u]);for(u in this._vectors2)o.setVector2(u,this._vectors2[u]);for(u in this._vectors3)o.setVector3(u,this._vectors3[u]);for(u in this._vectors4)o.setVector4(u,this._vectors4[u]);for(u in this._quaternions)o.setQuaternion(u,this._quaternions[u]);for(u in this._matrices)o.setMatrix(u,this._matrices[u]);for(u in this._matrixArrays)o.setMatrices(u,this._matrixArrays[u]);for(u in this._matrices3x3)o.setMatrix3x3(u,this._matrices3x3[u]);for(u in this._matrices2x2)o.setMatrix2x2(u,this._matrices2x2[u]);for(u in this._vectors2Arrays)o.setArray2(u,this._vectors2Arrays[u]);for(u in this._vectors3Arrays)o.setArray3(u,this._vectors3Arrays[u]);for(u in this._vectors4Arrays)o.setArray4(u,this._vectors4Arrays[u]);for(u in this._quaternionsArrays)o.setArray4(u,this._quaternionsArrays[u]);for(u in this._uniformBuffers){let _=this._uniformBuffers[u].getBuffer();_&&o.bindUniformBuffer(_,u)}let d=a.getEngine(),f=d.setExternalTexture;if(f)for(u in this._externalTextures)f.call(d,u,this._externalTextures[u]);let m=d.setTextureSampler;if(m)for(u in this._textureSamplers)m.call(d,u,this._textureSamplers[u]);let g=d.setStorageBuffer;if(g)for(u in this._storageBuffers)g.call(d,u,this._storageBuffers[u])}if(o&&t&&(h||!this.isFrozen)){let u=t.morphTargetManager;u&&u.numInfluencers>0&&Vr(t,o);let d=t.bakedVertexAnimationManager;if(d&&d.isEnabled){let f=n?r._drawWrapper:this._drawWrapper;t.bakedVertexAnimationManager?.bind(o,!!f._wasPreviouslyUsingInstances)}}this._afterBind(t,o,r)}getActiveTextures(){let e=super.getActiveTextures();for(let t in this._textures)e.push(this._textures[t]);for(let t in this._textureArrays){let i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.push(i[r])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(let t in this._textures)if(this._textures[t]===e)return!0;for(let t in this._textureArrays){let i=this._textureArrays[t];for(let r=0;r<i.length;r++)if(i[r]===e)return!0}return!1}clone(e){let t=ae.Clone(()=>new s(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,typeof t._shaderPath=="object"&&(t._shaderPath=ie({},t._shaderPath)),this._options=ie({},this._options),Object.keys(this._options).forEach(i=>{let r=this._options[i];Array.isArray(r)&&(this._options[i]=r.slice(0))}),this.stencil.copyTo(t.stencil);for(let i in this._textures)t.setTexture(i,this._textures[i]);for(let i in this._textureArrays)t.setTextureArray(i,this._textureArrays[i]);for(let i in this._externalTextures)t.setExternalTexture(i,this._externalTextures[i]);for(let i in this._ints)t.setInt(i,this._ints[i]);for(let i in this._uints)t.setUInt(i,this._uints[i]);for(let i in this._floats)t.setFloat(i,this._floats[i]);for(let i in this._floatsArrays)t.setFloats(i,this._floatsArrays[i]);for(let i in this._colors3)t.setColor3(i,this._colors3[i]);for(let i in this._colors3Arrays)t._colors3Arrays[i]=this._colors3Arrays[i];for(let i in this._colors4)t.setColor4(i,this._colors4[i]);for(let i in this._colors4Arrays)t._colors4Arrays[i]=this._colors4Arrays[i];for(let i in this._vectors2)t.setVector2(i,this._vectors2[i]);for(let i in this._vectors3)t.setVector3(i,this._vectors3[i]);for(let i in this._vectors4)t.setVector4(i,this._vectors4[i]);for(let i in this._quaternions)t.setQuaternion(i,this._quaternions[i]);for(let i in this._quaternionsArrays)t._quaternionsArrays[i]=this._quaternionsArrays[i];for(let i in this._matrices)t.setMatrix(i,this._matrices[i]);for(let i in this._matrixArrays)t._matrixArrays[i]=this._matrixArrays[i].slice();for(let i in this._matrices3x3)t.setMatrix3x3(i,this._matrices3x3[i]);for(let i in this._matrices2x2)t.setMatrix2x2(i,this._matrices2x2[i]);for(let i in this._vectors2Arrays)t.setArray2(i,this._vectors2Arrays[i]);for(let i in this._vectors3Arrays)t.setArray3(i,this._vectors3Arrays[i]);for(let i in this._vectors4Arrays)t.setArray4(i,this._vectors4Arrays[i]);for(let i in this._uniformBuffers)t.setUniformBuffer(i,this._uniformBuffers[i]);for(let i in this._textureSamplers)t.setTextureSampler(i,this._textureSamplers[i]);for(let i in this._storageBuffers)t.setStorageBuffer(i,this._storageBuffers[i]);return t}dispose(e,t,i){if(t){let r;for(r in this._textures)this._textures[r].dispose();for(r in this._textureArrays){let n=this._textureArrays[r];for(let o=0;o<n.length;o++)n[o].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){let e=ae.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;let t;e.stencil=this.stencil.serialize(),e.textures={};for(t in this._textures)e.textures[t]=this._textures[t].serialize();e.textureArrays={};for(t in this._textureArrays){e.textureArrays[t]=[];let i=this._textureArrays[t];for(let r=0;r<i.length;r++)e.textureArrays[t].push(i[r].serialize())}e.ints={};for(t in this._ints)e.ints[t]=this._ints[t];e.uints={};for(t in this._uints)e.uints[t]=this._uints[t];e.floats={};for(t in this._floats)e.floats[t]=this._floats[t];e.floatsArrays={};for(t in this._floatsArrays)e.floatsArrays[t]=this._floatsArrays[t];e.colors3={};for(t in this._colors3)e.colors3[t]=this._colors3[t].asArray();e.colors3Arrays={};for(t in this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];e.colors4={};for(t in this._colors4)e.colors4[t]=this._colors4[t].asArray();e.colors4Arrays={};for(t in this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];e.vectors2={};for(t in this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();e.vectors3={};for(t in this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();e.vectors4={};for(t in this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();e.quaternions={};for(t in this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();e.matrices={};for(t in this._matrices)e.matrices[t]=this._matrices[t].asArray();e.matrixArray={};for(t in this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];e.matrices3x3={};for(t in this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];e.matrices2x2={};for(t in this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];e.vectors2Arrays={};for(t in this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];e.vectors3Arrays={};for(t in this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];e.vectors4Arrays={};for(t in this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];e.quaternionsArrays={};for(t in this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){let r=ae.Parse(()=>new s(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,i),n;e.stencil&&r.stencil.parse(e.stencil,t,i);for(n in e.textures)r.setTexture(n,z.Parse(e.textures[n],t,i));for(n in e.textureArrays){let o=e.textureArrays[n],a=[];for(let l=0;l<o.length;l++)a.push(z.Parse(o[l],t,i));r.setTextureArray(n,a)}for(n in e.ints)r.setInt(n,e.ints[n]);for(n in e.uints)r.setUInt(n,e.uints[n]);for(n in e.floats)r.setFloat(n,e.floats[n]);for(n in e.floatsArrays)r.setFloats(n,e.floatsArrays[n]);for(n in e.colors3)r.setColor3(n,X.FromArray(e.colors3[n]));for(n in e.colors3Arrays){let o=e.colors3Arrays[n].reduce((a,l,c)=>(c%3===0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>X.FromArray(a));r.setColor3Array(n,o)}for(n in e.colors4)r.setColor4(n,oe.FromArray(e.colors4[n]));for(n in e.colors4Arrays){let o=e.colors4Arrays[n].reduce((a,l,c)=>(c%4===0?a.push([l]):a[a.length-1].push(l),a),[]).map(a=>oe.FromArray(a));r.setColor4Array(n,o)}for(n in e.vectors2)r.setVector2(n,j.FromArray(e.vectors2[n]));for(n in e.vectors3)r.setVector3(n,p.FromArray(e.vectors3[n]));for(n in e.vectors4)r.setVector4(n,De.FromArray(e.vectors4[n]));for(n in e.quaternions)r.setQuaternion(n,q.FromArray(e.quaternions[n]));for(n in e.matrices)r.setMatrix(n,N.FromArray(e.matrices[n]));for(n in e.matrixArray)r._matrixArrays[n]=new Float32Array(e.matrixArray[n]);for(n in e.matrices3x3)r.setMatrix3x3(n,e.matrices3x3[n]);for(n in e.matrices2x2)r.setMatrix2x2(n,e.matrices2x2[n]);for(n in e.vectors2Arrays)r.setArray2(n,e.vectors2Arrays[n]);for(n in e.vectors3Arrays)r.setArray3(n,e.vectors3Arrays[n]);for(n in e.vectors4Arrays)r.setArray4(n,e.vectors4Arrays[n]);for(n in e.quaternionsArrays)r.setArray4(n,e.quaternionsArrays[n]);return r}static ParseFromFileAsync(e,t,i,r=""){return new Promise((n,o)=>{let a=new gr;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){let l=JSON.parse(a.responseText),c=this.Parse(l,i||me.LastCreatedScene,r);e&&(c.name=e),n(c)}else o("Unable to load the ShaderMaterial")}),a.open("GET",t),a.send()})}static ParseFromSnippetAsync(e,t,i=""){return new Promise((r,n)=>{let o=new gr;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){let a=JSON.parse(JSON.parse(o.responseText).jsonPayload),l=JSON.parse(a.shaderMaterial),c=this.Parse(l,t||me.LastCreatedScene,i);c.snippetId=e,r(c)}else n("Unable to load the snippet "+e)}),o.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),o.send()})}};Fi.SnippetUrl="https://snippet.babylonjs.com";Fi.CreateFromSnippetAsync=Fi.ParseFromSnippetAsync;P("BABYLON.ShaderMaterial",Fi);var W5="pickingPixelShader",H5=`#if defined(INSTANCES)
varying vec4 vMeshID;
#else
uniform vec4 meshID;
#endif
void main(void) {
#if defined(INSTANCES)
gl_FragColor=vMeshID;
#else
gl_FragColor=meshID;
#endif
}`;D.ShadersStore[W5]=H5;var X5="pickingVertexShader",Y5=`attribute vec3 position;
#if defined(INSTANCES)
attribute vec4 instanceMeshID;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform mat4 viewProjection;
#if defined(INSTANCES)
varying vec4 vMeshID;
#endif
void main(void) {
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);gl_Position=viewProjection*worldPos;
#if defined(INSTANCES)
vMeshID=instanceMeshID;
#endif
}`;D.ShadersStore[X5]=Y5;var fB=(()=>{class s{constructor(t,i,r,n=""){this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new U,this.onErrorObservable=new U,this.onBindObservable=new U,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=pe.WGSL,this.name=t,this._key=n,this._engine=r,this.uniqueId=s._UniqueIdSeed++,this.defines=i.defines??"",this.onError=i.onError,this.onCompiled=i.onCompiled,this._entryPoint=i.entryPoint??"main",this._shaderStore=D.GetShadersStore(this._shaderLanguage),this._shaderRepository=D.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=D.GetIncludesShadersStore(this._shaderLanguage);let o,a=so()?this._engine.getHostDocument():null;typeof t=="string"?o=t:t.computeSource?o="source:"+t.computeSource:t.computeElement?o=a?.getElementById(t.computeElement)||t.computeElement:o=t.compute||t;let l={defines:this.defines.split(`
`),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:(c,h,u)=>{if(!u)return h;for(let d of u){let m=d.replace("#define","").replace(";","").trim().split(" ");if(m.length===2){let g=m[0],_=m[1];(!isNaN(parseInt(_))||!isNaN(parseFloat(_)))&&(h=`const ${g} = ${_};
`+h)}}return h}};this._loadShader(o,"Compute","",c=>{MO(l),DO(c,l,h=>{this._rawComputeSourceCode=c,i.processFinalCode&&(h=i.processFinalCode(h));let u=OO(h,"",l);this._useFinalCode(u.vertexCode,t)},this._engine)})}_useFinalCode(t,i){if(i){let r=i.computeElement||i.compute||i.spectorName||i;this._computeSourceCode="//#define SHADER_NAME compute:"+r+`
`+t}else this._computeSourceCode=t;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(t){if(this.isReady()){t(this);return}this.onCompileObservable.add(i=>{t(i)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(t){try{if(this._isReadyInternal())return}catch(i){this._processCompilationErrors(i,t);return}setTimeout(()=>{this._checkIsReady(t)},16)}_loadShader(t,i,r,n){if(typeof HTMLElement<"u"&&t instanceof HTMLElement){let a=RO(t);n(a);return}if(t.substr(0,7)==="source:"){n(t.substr(7));return}if(t.substr(0,7)==="base64:"){let a=window.atob(t.substr(7));n(a);return}if(this._shaderStore[t+i+"Shader"]){n(this._shaderStore[t+i+"Shader"]);return}if(r&&this._shaderStore[t+r+"Shader"]){n(this._shaderStore[t+r+"Shader"]);return}let o;t[0]==="."||t[0]==="/"||t.indexOf("http")>-1?o=t:o=this._shaderRepository+t,this._engine._loadFile(o+"."+i.toLowerCase()+".fx",n)}get computeSourceCode(){return this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._pipelineContext?._getComputeShaderCode()??this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){let t=this.defines,i=this._pipelineContext;this._isReady=!1;try{let r=this._engine;this._pipelineContext=r.createComputePipelineContext(),this._pipelineContext._name=this._key,r._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:t,this._entryPoint),r._executeWhenComputeStateIsCompiled(this._pipelineContext,n=>{if(n&&n.numErrors>0){this._processCompilationErrors(n,i);return}this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),i&&this.getEngine()._deleteComputePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(r){this._processCompilationErrors(r,i)}}_processCompilationErrors(t,i=null){if(this._compilationError="",F.Error("Unable to compile compute effect:"),this.defines&&F.Error(`Defines:
`+this.defines),s.LogShaderCodeOnCompilationError){let r=this._pipelineContext?._getComputeShaderCode();r&&(F.Error("Compute code:"),F.Error(r))}if(typeof t=="string")this._compilationError=t,F.Error("Error: "+this._compilationError);else for(let r of t.messages){let n="";r.line!==void 0&&(n+="Line "+r.line+", "),r.offset!==void 0&&(n+="Offset "+r.offset+", "),r.length!==void 0&&(n+="Length "+r.length+", "),n+=r.type+": "+r.text,this._compilationError&&(this._compilationError+=`
`),this._compilationError+=n,F.Error(n)}i&&(this._pipelineContext=i,this._isReady=!0),this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(t,i){D.GetShadersStore(pe.WGSL)[`${t}ComputeShader`]=i}}return s._UniqueIdSeed=0,s.LogShaderCodeOnCompilationError=!0,s})();var xv=class s{constructor(e,t,i,r,n,o){this.entries=[],this._boundingVectors=new Array,this._capacity=i,this._depth=r,this._maxDepth=n,this._creationFunc=o,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}get capacity(){return this._capacity}get minPoint(){return this._minPoint}get maxPoint(){return this._maxPoint}addEntry(e){if(this.blocks){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e);return}this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()}removeEntry(e){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].removeEntry(e);return}let t=this.entries.indexOf(e);t>-1&&this.entries.splice(t,1)}addEntries(e){for(let t=0;t<e.length;t++){let i=e[t];this.addEntry(i)}}select(e,t,i){if(Co.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(let r=0;r<this.blocks.length;r++)this.blocks[r].select(e,t,i);return}i?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}}intersects(e,t,i,r){if(Co.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(let n=0;n<this.blocks.length;n++)this.blocks[n].intersects(e,t,i,r);return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}}intersectsRay(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].intersectsRay(e,t);return}t.concatWithNoDuplicate(this.entries)}}createInnerBlocks(){s._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc),this.entries.splice(0)}static _CreateBlocks(e,t,i,r,n,o,a,l){a.blocks=new Array;let c=new p((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2);for(let h=0;h<2;h++)for(let u=0;u<2;u++)for(let d=0;d<2;d++){let f=e.add(c.multiplyByFloats(h,u,d)),m=e.add(c.multiplyByFloats(h+1,u+1,d+1)),g=new s(f,m,r,n+1,o,l);g.addEntries(i),a.blocks.push(g)}}};var hm=(()=>{class s{constructor(t,i,r=2){this.maxDepth=r,this.dynamicContent=[],this._maxBlockCapacity=i||64,this._selectionContent=new fn(1024),this._creationFunc=t}update(t,i,r){xv._CreateBlocks(t,i,r,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)}addMesh(t){for(let i=0;i<this.blocks.length;i++)this.blocks[i].addEntry(t)}removeMesh(t){for(let i=0;i<this.blocks.length;i++)this.blocks[i].removeEntry(t)}select(t,i){this._selectionContent.reset();for(let r=0;r<this.blocks.length;r++)this.blocks[r].select(t,this._selectionContent,i);return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersects(t,i,r){this._selectionContent.reset();for(let n=0;n<this.blocks.length;n++)this.blocks[n].intersects(t,i,this._selectionContent,r);return r?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersectsRay(t){this._selectionContent.reset();for(let i=0;i<this.blocks.length;i++)this.blocks[i].intersectsRay(t,this._selectionContent);return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}}return s.CreationFuncForMeshes=(e,t)=>{let i=e.getBoundingInfo();!e.isBlocked&&i.boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},s.CreationFuncForSubMeshes=(e,t)=>{e.getBoundingInfo().boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},s})();Te.prototype.createOrUpdateSelectionOctree=function(s=64,e=2){let t=this._getComponent(ye.NAME_OCTREE);t||(t=new vv(this),this._addComponent(t)),this._selectionOctree||(this._selectionOctree=new hm(hm.CreationFuncForMeshes,s,e));let i=this.getWorldExtends();return this._selectionOctree.update(i.min,i.max,this.meshes),this._selectionOctree};Object.defineProperty(Te.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0});lt.prototype.createOrUpdateSubmeshesOctree=function(s=64,e=2){let t=this.getScene(),i=t._getComponent(ye.NAME_OCTREE);i||(i=new vv(t),t._addComponent(i)),this._submeshesOctree||(this._submeshesOctree=new hm(hm.CreationFuncForSubMeshes,s,e)),this.computeWorldMatrix(!0);let n=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(n.minimumWorld,n.maximumWorld,this.subMeshes),this._submeshesOctree};var vv=class{constructor(e){this.name=ye.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new pt(p.Zero(),new p(1,1,1)),e=e||me.LastCreatedScene,e&&(this.scene=e,this.scene.getActiveMeshCandidates=()=>this.getActiveMeshCandidates(),this.scene.getActiveSubMeshCandidates=t=>this.getActiveSubMeshCandidates(t),this.scene.getCollidingSubMeshCandidates=(t,i)=>this.getCollidingSubMeshCandidates(t,i),this.scene.getIntersectingSubMeshCandidates=(t,i)=>this.getIntersectingSubMeshCandidates(t,i))}register(){this.scene.onMeshRemovedObservable.add(e=>{let t=this.scene.selectionOctree;if(t!=null){let i=t.dynamicContent.indexOf(e);i!==-1&&t.dynamicContent.splice(i,1)}}),this.scene.onMeshImportedObservable.add(e=>{let t=this.scene.selectionOctree;t?.addMesh(e)})}getActiveMeshCandidates(){return this.scene._selectionOctree?.select(this.scene.frustumPlanes)||this.scene._getDefaultMeshCandidates()}getActiveSubMeshCandidates(e){return e._submeshesOctree&&e.useOctreeForRenderingSelection?e._submeshesOctree.select(this.scene.frustumPlanes):this.scene._getDefaultSubMeshCandidates(e)}getIntersectingSubMeshCandidates(e,t){return e._submeshesOctree&&e.useOctreeForPicking?(pt.TransformToRef(t,e.getWorldMatrix(),this._tempRay),e._submeshesOctree.intersectsRay(this._tempRay)):this.scene._getDefaultSubMeshCandidates(e)}getCollidingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){let i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z);return e._submeshesOctree.intersects(t._basePointWorld,i)}return this.scene._getDefaultSubMeshCandidates(e)}rebuild(){}dispose(){}};function Tv(s){let e=s.height||2,t=s.diameterTop===0?0:s.diameterTop||s.diameter||1,i=s.diameterBottom===0?0:s.diameterBottom||s.diameter||1;t=t||1e-5,i=i||1e-5;let r=(s.tessellation||24)|0,n=(s.subdivisions||1)|0,o=!!s.hasRings,a=!!s.enclose,l=s.cap===0?0:s.cap||k.CAP_ALL,c=s.arc&&(s.arc<=0||s.arc>1)?1:s.arc||1,h=s.sideOrientation===0?0:s.sideOrientation||le.DEFAULTSIDE,u=s.faceUV||new Array(3),d=s.faceColors,f=c!==1&&a?2:0,m=o?n:1,g=2+(1+f)*m,_;for(_=0;_<g;_++)d&&d[_]===void 0&&(d[_]=new oe(1,1,1,1));for(_=0;_<g;_++)u&&u[_]===void 0&&(u[_]=new De(0,0,1,1));let x=[],b=[],C=[],R=[],E=[],S=Math.PI*2*c/r,A,L,G,W=(i-t)/2/e,$=p.Zero(),re=p.Zero(),we=p.Zero(),_e=p.Zero(),ce=p.Zero(),ne=qt.Y,Fe,Oe,he,ee=1,V=1,Y=0,J=0;for(Fe=0;Fe<=n;Fe++)for(L=Fe/n,G=(L*(t-i)+i)/2,ee=o&&Fe!==0&&Fe!==n?2:1,he=0;he<ee;he++){for(o&&(V+=he),a&&(V+=2*he),Oe=0;Oe<=r;Oe++)A=Oe*S,$.x=Math.cos(-A)*G,$.y=-e/2+L*e,$.z=Math.sin(-A)*G,t===0&&Fe===n?(re.x=C[C.length-(r+1)*3],re.y=C[C.length-(r+1)*3+1],re.z=C[C.length-(r+1)*3+2]):(re.x=$.x,re.z=$.z,re.y=Math.sqrt(re.x*re.x+re.z*re.z)*W,re.normalize()),Oe===0&&(we.copyFrom($),_e.copyFrom(re)),b.push($.x,$.y,$.z),C.push(re.x,re.y,re.z),o?J=Y!==V?u[V].y:u[V].w:J=u[V].y+(u[V].w-u[V].y)*L,R.push(u[V].x+(u[V].z-u[V].x)*Oe/r,it.UseOpenGLOrientationForUV?1-J:J),d&&E.push(d[V].r,d[V].g,d[V].b,d[V].a);c!==1&&a&&(b.push($.x,$.y,$.z),b.push(0,$.y,0),b.push(0,$.y,0),b.push(we.x,we.y,we.z),p.CrossToRef(ne,re,ce),ce.normalize(),C.push(ce.x,ce.y,ce.z,ce.x,ce.y,ce.z),p.CrossToRef(_e,ne,ce),ce.normalize(),C.push(ce.x,ce.y,ce.z,ce.x,ce.y,ce.z),o?J=Y!==V?u[V+1].y:u[V+1].w:J=u[V+1].y+(u[V+1].w-u[V+1].y)*L,R.push(u[V+1].x,it.UseOpenGLOrientationForUV?1-J:J),R.push(u[V+1].z,it.UseOpenGLOrientationForUV?1-J:J),o?J=Y!==V?u[V+2].y:u[V+2].w:J=u[V+2].y+(u[V+2].w-u[V+2].y)*L,R.push(u[V+2].x,it.UseOpenGLOrientationForUV?1-J:J),R.push(u[V+2].z,it.UseOpenGLOrientationForUV?1-J:J),d&&(E.push(d[V+1].r,d[V+1].g,d[V+1].b,d[V+1].a),E.push(d[V+1].r,d[V+1].g,d[V+1].b,d[V+1].a),E.push(d[V+2].r,d[V+2].g,d[V+2].b,d[V+2].a),E.push(d[V+2].r,d[V+2].g,d[V+2].b,d[V+2].a))),Y!==V&&(Y=V)}let Me=c!==1&&a?r+4:r;for(Fe=0,V=0;V<n;V++){let Tt=0,Yt=0,si=0,Er=0;for(Oe=0;Oe<r;Oe++)Tt=Fe*(Me+1)+Oe,Yt=(Fe+1)*(Me+1)+Oe,si=Fe*(Me+1)+(Oe+1),Er=(Fe+1)*(Me+1)+(Oe+1),x.push(Tt,Yt,si),x.push(Er,si,Yt);c!==1&&a&&(x.push(Tt+2,Yt+2,si+2),x.push(Er+2,si+2,Yt+2),x.push(Tt+4,Yt+4,si+4),x.push(Er+4,si+4,Yt+4)),Fe=o?Fe+2:Fe+1}let Re=Tt=>{let Yt=Tt?t/2:i/2;if(Yt===0)return;let si,Er,Xi,Ie=Tt?u[g-1]:u[0],st=null;d&&(st=Tt?d[g-1]:d[0]);let vi=b.length/3,sr=Tt?e/2:-e/2,Ar=new p(0,sr,0);b.push(Ar.x,Ar.y,Ar.z),C.push(0,Tt?1:-1,0);let cu=Ie.y+(Ie.w-Ie.y)*.5;R.push(Ie.x+(Ie.z-Ie.x)*.5,it.UseOpenGLOrientationForUV?1-cu:cu),st&&E.push(st.r,st.g,st.b,st.a);let Cl=new j(.5,.5);for(Xi=0;Xi<=r;Xi++){si=Math.PI*2*Xi*c/r;let hu=Math.cos(-si),uu=Math.sin(-si);Er=new p(hu*Yt,sr,uu*Yt);let du=new j(hu*Cl.x+.5,uu*Cl.y+.5);b.push(Er.x,Er.y,Er.z),C.push(0,Tt?1:-1,0);let fu=Ie.y+(Ie.w-Ie.y)*du.y;R.push(Ie.x+(Ie.z-Ie.x)*du.x,it.UseOpenGLOrientationForUV?1-fu:fu),st&&E.push(st.r,st.g,st.b,st.a)}for(Xi=0;Xi<r;Xi++)Tt?(x.push(vi),x.push(vi+(Xi+2)),x.push(vi+(Xi+1))):(x.push(vi),x.push(vi+(Xi+1)),x.push(vi+(Xi+2)))};(l===k.CAP_START||l===k.CAP_ALL)&&Re(!1),(l===k.CAP_END||l===k.CAP_ALL)&&Re(!0),le._ComputeSides(h,b,x,C,R,s.frontUVs,s.backUVs);let et=new le;return et.indices=x,et.positions=b,et.normals=C,et.uvs=R,d&&(et.colors=E),et}function qs(s,e={},t){let i=new k(s,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Tv(e).applyToMesh(i,e.updatable),i}le.CreateCylinder=Tv;k.CreateCylinder=(s,e,t,i,r,n,o,a,l)=>((o===void 0||!(o instanceof Te))&&(o!==void 0&&(l=a||k.DEFAULTSIDE,a=o),o=n,n=1),qs(s,{height:e,diameterTop:t,diameterBottom:i,tessellation:r,subdivisions:n,sideOrientation:l,updatable:a},o));Xe.AddNodeConstructor("Light_Type_3",(s,e)=>()=>new as(s,p.Zero(),e));var as=class extends tt{constructor(e,t,i){super(e,i),this.groundColor=new X(0,0,0),this.direction=t||p.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=p.Normalize(e.subtract(p.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){let i=p.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){let i=p.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=N.Identity()),this._worldMatrix}getTypeID(){return tt.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}};v([At()],as.prototype,"groundColor",void 0);v([mi()],as.prototype,"direction",void 0);P("BABYLON.HemisphericLight",as);var ji=(()=>{class s{getRenderCamera(t){if(this._renderCamera)return this._renderCamera;{let i;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?i=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:i=this.originalScene.activeCamera,t&&i&&i.isRigCamera?i.rigParent:i}}setRenderCamera(t){this._renderCamera=t}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new as("shared gizmo light",new p(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=X.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return s._DefaultUtilityLayer==null?s._CreateDefaultUtilityLayerFromScene(me.LastCreatedScene):s._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(t){return s._DefaultUtilityLayer=new s(t),s._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{s._DefaultUtilityLayer=null}),s._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return s._DefaultKeepDepthUtilityLayer==null&&(s._DefaultKeepDepthUtilityLayer=new s(me.LastCreatedScene),s._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,s._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{s._DefaultKeepDepthUtilityLayer=null})),s._DefaultKeepDepthUtilityLayer}constructor(t,i=!0){this.originalScene=t,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new U,this.utilityLayerScene=new Te(t.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=t.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),i&&(this._originalPointerObserver=t.onPrePointerObservable.add(r=>{if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&r.type!==Ae.POINTERMOVE&&r.type!==Ae.POINTERUP&&r.type!==Ae.POINTERDOWN&&r.type!==Ae.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=t.pointerX,this.utilityLayerScene.pointerY=t.pointerY;let n=r.event;if(t.isPointerCaptured(n.pointerId)){this._pointerCaptures[n.pointerId]=!1;return}let o=l=>{let c=null;if(r.nearInteractionPickingInfo)r.nearInteractionPickingInfo.pickedMesh.getScene()==l?c=r.nearInteractionPickingInfo:c=new oi;else if(l!==this.utilityLayerScene&&r.originalPickingInfo)c=r.originalPickingInfo;else{let h=null;this._renderCamera&&(h=l._activeCamera,l._activeCamera=this._renderCamera,r.ray=null),c=r.ray?l.pickWithRay(r.ray):l.pick(t.pointerX,t.pointerY),h&&(l._activeCamera=h)}return c},a=o(this.utilityLayerScene);if(!r.ray&&a&&(r.ray=a.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(r),this.onlyCheckPointerDownEvents&&r.type!=Ae.POINTERDOWN){r.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new ds(r.type,r.event,a),r.type),r.type===Ae.POINTERUP&&this._pointerCaptures[n.pointerId]&&(this._pointerCaptures[n.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)a&&a.hit&&(r.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new ds(r.type,r.event,a),r.type),r.skipOnPointerObservable=!0);else{let l=o(t),c=r.event;l&&a&&(a.distance===0&&l.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(l.pickedMesh)?(this._notifyObservers(r,l,c),r.skipOnPointerObservable=!0):r.type===Ae.POINTERDOWN?this._pointerCaptures[c.pointerId]=!0:(r.type===Ae.POINTERMOVE||r.type===Ae.POINTERUP)&&(this._lastPointerEvents[c.pointerId]&&(this.onPointerOutObservable.notifyObservers(c.pointerId),delete this._lastPointerEvents[c.pointerId]),this._notifyObservers(r,l,c)):!this._pointerCaptures[c.pointerId]&&(a.distance<l.distance||l.distance===0)?(this._notifyObservers(r,a,c),r.skipOnPointerObservable||(r.skipOnPointerObservable=a.distance>0)):!this._pointerCaptures[c.pointerId]&&a.distance>=l.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(l.pickedMesh)?(this._notifyObservers(r,l,c),r.skipOnPointerObservable=!0):((r.type===Ae.POINTERMOVE||r.type===Ae.POINTERUP)&&this._lastPointerEvents[c.pointerId]&&(this.onPointerOutObservable.notifyObservers(c.pointerId),delete this._lastPointerEvents[c.pointerId]),this._notifyObservers(r,a,c))),r.type===Ae.POINTERUP&&this._pointerCaptures[c.pointerId]&&(this._pointerCaptures[c.pointerId]=!1))}}),this._originalPointerObserver&&t.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(r=>{this.shouldRender&&r==this.getRenderCamera()&&this.render()}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(t,i,r){t.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new ds(t.type,t.event,i),t.type),this._lastPointerEvents[r.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){let t=this.utilityLayerScene.activeCamera.getScene(),i=this.utilityLayerScene.activeCamera;i._scene=this.utilityLayerScene,i.leftCamera&&(i.leftCamera._scene=this.utilityLayerScene),i.rightCamera&&(i.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),i._scene=t,i.leftCamera&&(i.leftCamera._scene=t),i.rightCamera&&(i.rightCamera._scene=t)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}return s._DefaultUtilityLayer=null,s._DefaultKeepDepthUtilityLayer=null,s})();var qI=function(s){return s[s.Origin=0]="Origin",s[s.Pivot=1]="Pivot",s}(qI||{}),um=function(s){return s[s.World=0]="World",s[s.Local=1]="Local",s}(um||{}),Bs=(()=>{class s{set scaleRatio(t){this._scaleRatio=t}get scaleRatio(){return this._scaleRatio}get isHovered(){return this._isHovered}get attachedMesh(){return this._attachedMesh}set attachedMesh(t){this._attachedMesh=t,t&&(this._attachedNode=t),this._rootMesh.setEnabled(!!t),this._attachedNodeChanged(t)}get attachedNode(){return this._attachedNode}set attachedNode(t){this._attachedNode=t,this._attachedMesh=null,this._rootMesh.setEnabled(!!t),this._attachedNodeChanged(t)}setCustomMesh(t){if(t.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach(i=>{i.dispose()}),t.parent=this._rootMesh,this._customMeshSet=!0}get additionalTransformNode(){return this._additionalTransformNode}set additionalTransformNode(t){this._additionalTransformNode=t}set updateGizmoRotationToMatchAttachedMesh(t){this._updateGizmoRotationToMatchAttachedMesh=t}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(t){this._updateGizmoPositionToMatchAttachedMesh=t}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(t){this._anchorPoint=t}get anchorPoint(){return this._anchorPoint}set coordinatesMode(t){this._coordinatesMode=t;let i=t==um.Local;this.updateGizmoRotationToMatchAttachedMesh=i,this.updateGizmoPositionToMatchAttachedMesh=!0}get coordinatesMode(){return this._coordinatesMode}set updateScale(t){this._updateScale=t}get updateScale(){return this._updateScale}_attachedNodeChanged(t){}constructor(t=ji.DefaultUtilityLayer){this.gizmoLayer=t,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this._updateGizmoPositionToMatchAttachedMesh=!0,this._anchorPoint=qI.Origin,this._updateScale=!0,this._coordinatesMode=um.Local,this._interactionsEnabled=!0,this._rightHandtoLeftHandMatrix=N.RotationY(Math.PI),this._rootMesh=new k("gizmoRootNode",t.utilityLayerScene),this._rootMesh.rotationQuaternion=q.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add(()=>{this._update()})}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(t){this._customRotationQuaternion=t}_update(){if(this.attachedNode){let t=this.attachedNode;if(this.attachedMesh&&(t=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh)if(this.anchorPoint==qI.Pivot&&t.getAbsolutePivotPoint){let i=t.getAbsolutePivotPoint();this._rootMesh.position.copyFrom(i)}else{let i=t.getWorldMatrix().getRow(3),r=i?i.toVector3():new p(0,0,0);this._rootMesh.position.copyFrom(r)}if(this.updateGizmoRotationToMatchAttachedMesh){let r=t._isMesh||t.getClassName()==="AbstractMesh"||t.getClassName()==="TransformNode"||t.getClassName()==="InstancedMesh"?t:void 0;t.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion,void 0,s.PreserveScaling?r:void 0),this._rootMesh.rotationQuaternion.normalize()}else this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1);if(this.updateScale){let i=this.gizmoLayer.utilityLayerScene.activeCamera,r=i.globalPosition;this._rootMesh.position.subtractToRef(r,O.Vector3[0]);let n=this.scaleRatio;if(i.mode==Ce.ORTHOGRAPHIC_CAMERA){if(i.orthoTop&&i.orthoBottom){let o=i.orthoTop-i.orthoBottom;n*=o}}else{let o=i.getScene().useRightHandedSystem?p.RightHandedForwardReadOnly:p.LeftHandedForwardReadOnly,a=i.getDirection(o);n*=p.Dot(O.Vector3[0],a)}this._rootMesh.scaling.setAll(n),t._getWorldMatrixDeterminant()<0&&!s.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}this.additionalTransformNode&&(this._rootMesh.computeWorldMatrix(!0),this._rootMesh.getWorldMatrix().multiplyToRef(this.additionalTransformNode.getWorldMatrix(),O.Matrix[0]),O.Matrix[0].decompose(this._rootMesh.scaling,this._rootMesh.rotationQuaternion,this._rootMesh.position))}_handlePivotMatrixInverse(t,i,r){if(t.isUsingPivotMatrix()&&!t.isUsingPostMultiplyPivotMatrix()){t.getPivotMatrix().invertToRef(O.Matrix[5]),O.Matrix[5].multiplyToRef(i,r);return}r.copyFrom(i)}_matrixChanged(){if(this._attachedNode)if(this._attachedNode._isCamera){let t=this._attachedNode,i,r;if(t.parent){let o=O.Matrix[1];t.parent._worldMatrix.invertToRef(o),this._attachedNode._worldMatrix.multiplyToRef(o,O.Matrix[0]),i=O.Matrix[0]}else i=this._attachedNode._worldMatrix;if(t.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(i,O.Matrix[1]),r=O.Matrix[1]):r=i,r.decompose(O.Vector3[1],O.Quaternion[0],O.Vector3[0]),this._attachedNode.getClassName()==="FreeCamera"||this._attachedNode.getClassName()==="FlyCamera"||this._attachedNode.getClassName()==="ArcFollowCamera"||this._attachedNode.getClassName()==="TargetCamera"||this._attachedNode.getClassName()==="TouchCamera"||this._attachedNode.getClassName()==="UniversalCamera"){let o=this._attachedNode;o.rotation=O.Quaternion[0].toEulerAngles(),o.rotationQuaternion&&(o.rotationQuaternion.copyFrom(O.Quaternion[0]),o.rotationQuaternion.normalize())}t.position.copyFrom(O.Vector3[0])}else if(this._attachedNode._isMesh||this._attachedNode.getClassName()==="AbstractMesh"||this._attachedNode.getClassName()==="TransformNode"||this._attachedNode.getClassName()==="InstancedMesh"){let t=this._attachedNode;if(t.parent){let i=O.Matrix[0],r=O.Matrix[1];t.parent.getWorldMatrix().invertToRef(i),this._attachedNode.getWorldMatrix().multiplyToRef(i,r);let n=O.Matrix[4];if(this._handlePivotMatrixInverse(t,r,n),n.decompose(O.Vector3[0],O.Quaternion[0],t.position,s.PreserveScaling?t:void 0,s.UseAbsoluteScaling),O.Quaternion[0].normalize(),t.isUsingPivotMatrix()){let o=O.Quaternion[1];q.RotationYawPitchRollToRef(t.rotation.y,t.rotation.x,t.rotation.z,o);let a=O.Matrix[2];N.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,a);let l=O.Matrix[2];o.toRotationMatrix(l);let c=t.getPivotMatrix(),h=O.Matrix[3];c.invertToRef(h),c.multiplyToRef(a,O.Matrix[4]),O.Matrix[4].multiplyToRef(l,O.Matrix[5]),O.Matrix[5].multiplyToRef(h,O.Matrix[6]),O.Matrix[6].getTranslationToRef(O.Vector3[1]),t.position.subtractInPlace(O.Vector3[1])}}else{let i=O.Matrix[4];this._handlePivotMatrixInverse(t,this._attachedNode._worldMatrix,i),i.decompose(O.Vector3[0],O.Quaternion[0],t.position,s.PreserveScaling?t:void 0,s.UseAbsoluteScaling)}O.Vector3[0].scaleInPlace(1/t.scalingDeterminant),t.scaling.copyFrom(O.Vector3[0]),t.billboardMode||(t.rotationQuaternion?(t.rotationQuaternion.copyFrom(O.Quaternion[0]),t.rotationQuaternion.normalize()):t.rotation=O.Quaternion[0].toEulerAngles())}else if(this._attachedNode.getClassName()==="Bone"){let t=this._attachedNode,i=t.getParent();if(i){let r=O.Matrix[0],n=O.Matrix[1];i.getFinalMatrix().invertToRef(r),t.getFinalMatrix().multiplyToRef(r,n),t.getLocalMatrix().copyFrom(n)}else t.getLocalMatrix().copyFrom(t.getFinalMatrix());t.markAsDirty()}else{let t=this._attachedNode;if(t.getTypeID){let i=t.getTypeID();if(i===tt.LIGHTTYPEID_DIRECTIONALLIGHT||i===tt.LIGHTTYPEID_SPOTLIGHT||i===tt.LIGHTTYPEID_POINTLIGHT){let r=t.parent;if(r){let n=O.Matrix[0],o=O.Matrix[1];r.getWorldMatrix().invertToRef(n),t.getWorldMatrix().multiplyToRef(n,o),o.decompose(void 0,O.Quaternion[0],O.Vector3[0])}else this._attachedNode._worldMatrix.decompose(void 0,O.Quaternion[0],O.Vector3[0]);t.position=new p(O.Vector3[0].x,O.Vector3[0].y,O.Vector3[0].z),t.direction&&(t.direction=new p(t.direction.x,t.direction.y,t.direction.z))}}}}_setGizmoMeshMaterial(t,i){t&&t.forEach(r=>{r.material=i,r.color&&(r.color=i.diffuseColor)})}static GizmoAxisPointerObserver(t,i){let r=!1;return t.utilityLayerScene.onPointerObservable.add(o=>{if(o.pickInfo){if(o.type===Ae.POINTERMOVE){if(r)return;i.forEach(a=>{if(a.colliderMeshes&&a.gizmoMeshes){let l=a.colliderMeshes?.indexOf(o?.pickInfo?.pickedMesh)!=-1,c=a.dragBehavior.enabled?l||a.active?a.hoverMaterial:a.material:a.disableMaterial;a.gizmoMeshes.forEach(h=>{h.material=c,h.color&&(h.color=c.diffuseColor)})}})}if(o.type===Ae.POINTERDOWN&&i.has(o.pickInfo.pickedMesh?.parent)){r=!0;let a=i.get(o.pickInfo.pickedMesh?.parent);a.active=!0,i.forEach(l=>{let h=(l.colliderMeshes?.indexOf(o?.pickInfo?.pickedMesh)!=-1||l.active)&&l.dragBehavior.enabled?l.hoverMaterial:l.disableMaterial;l.gizmoMeshes.forEach(u=>{u.material=h,u.color&&(u.color=h.diffuseColor)})})}o.type===Ae.POINTERUP&&i.forEach(a=>{a.active=!1,r=!1,a.gizmoMeshes.forEach(l=>{l.material=a.dragBehavior.enabled?a.material:a.disableMaterial,l.color&&(l.color=a.material.diffuseColor)})})}})}dispose(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)}}return s.PreserveScaling=!1,s.UseAbsoluteScaling=!0,s})();Object.defineProperty(Te.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new dm(this)),this._debugLayer},enumerable:!0,configurable:!0});var dm=class s{get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new U),this._onPropertyChangedObservable)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new U),this._onSelectionChangedObservable)}constructor(e){this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||me.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add(()=>{this._scene._debugLayer&&this._scene._debugLayer.hide()})}_createInspector(e){if(this.isVisible())return;if(this._onPropertyChangedObservable){for(let i of this._onPropertyChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(i);this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(let i of this._onSelectionChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(i);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}let t=ie(ie({},s.Config),e);this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,t)}select(e,t){this.BJSINSPECTOR&&(t&&(Object.prototype.toString.call(t)=="[object String]"?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))}_getGlobalInspector(){if(typeof INSPECTOR<"u")return INSPECTOR;if(typeof BABYLON<"u"&&typeof BABYLON.Inspector<"u")return BABYLON}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)}show(e){return new Promise(t=>{if(typeof this.BJSINSPECTOR>"u"){let i=e&&e.inspectorURL?e.inspectorURL:s.InspectorURL;H.LoadBabylonScript(i,()=>{this._createInspector(e),t(this)})}else this._createInspector(e),t(this)})}};dm.InspectorURL=`${H._DefaultCdnUrl}/v${K.Version}/inspector/babylon.inspector.bundle.js`;dm.Config={overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0};function Cv(s){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],r=[],n=[],o=s.width||s.size||1,a=s.height||s.size||1,l=s.depth||s.size||1,c=s.wrap||!1,h=s.topBaseAt===void 0?1:s.topBaseAt,u=s.bottomBaseAt===void 0?0:s.bottomBaseAt;h=(h+4)%4,u=(u+4)%4;let d=[2,0,3,1],f=[2,0,1,3],m=d[h],g=f[u],_=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(c){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],_=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let A=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],L=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]],G=[17,18,19,16],W=[22,23,20,21];for(;m>0;)A.unshift(A.pop()),G.unshift(G.pop()),m--;for(;g>0;)L.unshift(L.pop()),W.unshift(W.pop()),g--;A=A.flat(),L=L.flat(),_=_.concat(A).concat(L),t.push(G[0],G[2],G[3],G[0],G[1],G[2]),t.push(W[0],W[2],W[3],W[0],W[1],W[2])}let x=[o/2,a/2,l/2];n=_.reduce((A,L,G)=>A.concat(L*x[G%3]),[]);let b=s.sideOrientation===0?0:s.sideOrientation||le.DEFAULTSIDE,C=s.faceUV||new Array(6),R=s.faceColors,E=[];for(let A=0;A<6;A++)C[A]===void 0&&(C[A]=new De(0,0,1,1)),R&&R[A]===void 0&&(R[A]=new oe(1,1,1,1));for(let A=0;A<6;A++)if(r.push(C[A].z,it.UseOpenGLOrientationForUV?1-C[A].w:C[A].w),r.push(C[A].x,it.UseOpenGLOrientationForUV?1-C[A].w:C[A].w),r.push(C[A].x,it.UseOpenGLOrientationForUV?1-C[A].y:C[A].y),r.push(C[A].z,it.UseOpenGLOrientationForUV?1-C[A].y:C[A].y),R)for(let L=0;L<4;L++)E.push(R[A].r,R[A].g,R[A].b,R[A].a);le._ComputeSides(b,n,t,i,r,s.frontUVs,s.backUVs);let S=new le;if(S.indices=t,S.positions=n,S.normals=i,S.uvs=r,R){let A=b===le.DOUBLESIDE?E.concat(E):E;S.colors=A}return S}function pB(s){let e=s.width||s.size||1,t=s.height||s.size||1,i=s.depth||s.size||1,r=(s.widthSegments||s.segments||1)|0,n=(s.heightSegments||s.segments||1)|0,o=(s.depthSegments||s.segments||1)|0,a=new N,l=new N,c=new N,h=Ao({width:e,height:i,subdivisionsX:r,subdivisionsY:o});N.TranslationToRef(0,-t/2,0,l),N.RotationZToRef(Math.PI,a),a.multiplyToRef(l,c),h.transform(c);let u=Ao({width:e,height:i,subdivisionsX:r,subdivisionsY:o});N.TranslationToRef(0,t/2,0,c),u.transform(c);let d=Ao({width:t,height:i,subdivisionsX:n,subdivisionsY:o});N.TranslationToRef(-e/2,0,0,l),N.RotationZToRef(Math.PI/2,a),a.multiplyToRef(l,c),d.transform(c);let f=Ao({width:t,height:i,subdivisionsX:n,subdivisionsY:o});N.TranslationToRef(e/2,0,0,l),N.RotationZToRef(-Math.PI/2,a),a.multiplyToRef(l,c),f.transform(c);let m=Ao({width:e,height:t,subdivisionsX:r,subdivisionsY:n});N.TranslationToRef(0,0,-i/2,l),N.RotationXToRef(-Math.PI/2,a),a.multiplyToRef(l,c),m.transform(c);let g=Ao({width:e,height:t,subdivisionsX:r,subdivisionsY:n});return N.TranslationToRef(0,0,i/2,l),N.RotationXToRef(Math.PI/2,a),a.multiplyToRef(l,c),g.transform(c),h.merge([u,f,d,m,g],!0),h}function ha(s,e={},t=null){let i=new k(s,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Cv(e).applyToMesh(i,e.updatable),i}le.CreateBox=Cv;k.CreateBox=(s,e,t=null,i,r)=>ha(s,{size:e,sideOrientation:r,updatable:i},t);function bv(s){let e=(s.segments||32)|0,t=s.diameterX||s.diameter||1,i=s.diameterY||s.diameter||1,r=s.diameterZ||s.diameter||1,n=s.arc&&(s.arc<=0||s.arc>1)?1:s.arc||1,o=s.slice&&s.slice<=0?1:s.slice||1,a=s.sideOrientation===0?0:s.sideOrientation||le.DEFAULTSIDE,l=!!s.dedupTopBottomIndices,c=new p(t/2,i/2,r/2),h=2+e,u=2*h,d=[],f=[],m=[],g=[];for(let x=0;x<=h;x++){let b=x/h,C=b*Math.PI*o;for(let R=0;R<=u;R++){let E=R/u,S=E*Math.PI*2*n,A=N.RotationZ(-C),L=N.RotationY(S),G=p.TransformCoordinates(p.Up(),A),W=p.TransformCoordinates(G,L),$=W.multiply(c),re=W.divide(c).normalize();f.push($.x,$.y,$.z),m.push(re.x,re.y,re.z),g.push(E,it.UseOpenGLOrientationForUV?1-b:b)}if(x>0){let R=f.length/3;for(let E=R-2*(u+1);E+u+2<R;E++)l?(x>1&&(d.push(E),d.push(E+1),d.push(E+u+1)),(x<h||o<1)&&(d.push(E+u+1),d.push(E+1),d.push(E+u+2))):(d.push(E),d.push(E+1),d.push(E+u+1),d.push(E+u+1),d.push(E+1),d.push(E+u+2))}}le._ComputeSides(a,f,d,m,g,s.frontUVs,s.backUVs);let _=new le;return _.indices=d,_.positions=f,_.normals=m,_.uvs=g,_}function pr(s,e={},t=null){let i=new k(s,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,bv(e).applyToMesh(i,e.updatable),i}le.CreateSphere=bv;k.CreateSphere=(s,e,t,i,r,n)=>pr(s,{segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:n,updatable:r},i);function Sv(s={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){let e=Math.max(s.subdivisions?s.subdivisions:2,1)|0,t=Math.max(s.tessellation?s.tessellation:16,3)|0,i=Math.max(s.height?s.height:1,0),r=Math.max(s.radius?s.radius:.25,0),n=Math.max(s.capSubdivisions?s.capSubdivisions:6,1)|0,o=t,a=e,l=Math.max(s.radiusTop?s.radiusTop:r,0),c=Math.max(s.radiusBottom?s.radiusBottom:r,0),h=i-(l+c),u=0,d=2*Math.PI,f=Math.max(s.topCapSubdivisions?s.topCapSubdivisions:n,1),m=Math.max(s.bottomCapSubdivisions?s.bottomCapSubdivisions:n,1),g=Math.acos((c-l)/i),_=[],x=[],b=[],C=[],R=0,E=[],S=h*.5,A=Math.PI*.5,L,G,W=p.Zero(),$=p.Zero(),re=Math.cos(g),we=Math.sin(g),_e=new j(l*we,S+l*re).subtract(new j(c*we,-S+c*re)).length(),ce=l*g+_e+c*(A-g),ne=0;for(G=0;G<=f;G++){let ee=[],V=A-g*(G/f);ne+=l*g/f;let Y=Math.cos(V),J=Math.sin(V),Me=Y*l;for(L=0;L<=o;L++){let Re=L/o,et=Re*d+u,Tt=Math.sin(et),Yt=Math.cos(et);$.x=Me*Tt,$.y=S+J*l,$.z=Me*Yt,x.push($.x,$.y,$.z),W.set(Y*Tt,J,Y*Yt),b.push(W.x,W.y,W.z),C.push(Re,it.UseOpenGLOrientationForUV?ne/ce:1-ne/ce),ee.push(R),R++}E.push(ee)}let Fe=i-l-c+re*l-re*c,Oe=we*(c-l)/Fe;for(G=1;G<=a;G++){let ee=[];ne+=_e/a;let V=we*(G*(c-l)/a+l);for(L=0;L<=o;L++){let Y=L/o,J=Y*d+u,Me=Math.sin(J),Re=Math.cos(J);$.x=V*Me,$.y=S+re*l-G*Fe/a,$.z=V*Re,x.push($.x,$.y,$.z),W.set(Me,Oe,Re).normalize(),b.push(W.x,W.y,W.z),C.push(Y,it.UseOpenGLOrientationForUV?ne/ce:1-ne/ce),ee.push(R),R++}E.push(ee)}for(G=1;G<=m;G++){let ee=[],V=A-g-(Math.PI-g)*(G/m);ne+=c*g/m;let Y=Math.cos(V),J=Math.sin(V),Me=Y*c;for(L=0;L<=o;L++){let Re=L/o,et=Re*d+u,Tt=Math.sin(et),Yt=Math.cos(et);$.x=Me*Tt,$.y=-S+J*c,$.z=Me*Yt,x.push($.x,$.y,$.z),W.set(Y*Tt,J,Y*Yt),b.push(W.x,W.y,W.z),C.push(Re,it.UseOpenGLOrientationForUV?ne/ce:1-ne/ce),ee.push(R),R++}E.push(ee)}for(L=0;L<o;L++)for(G=0;G<f+a+m;G++){let ee=E[G][L],V=E[G+1][L],Y=E[G+1][L+1],J=E[G][L+1];_.push(ee),_.push(V),_.push(J),_.push(V),_.push(Y),_.push(J)}if(_=_.reverse(),s.orientation&&!s.orientation.equals(p.Up())){let ee=new N;s.orientation.clone().scale(Math.PI*.5).cross(p.Up()).toQuaternion().toRotationMatrix(ee);let V=p.Zero();for(let Y=0;Y<x.length;Y+=3)V.set(x[Y],x[Y+1],x[Y+2]),p.TransformCoordinatesToRef(V.clone(),ee,V),x[Y]=V.x,x[Y+1]=V.y,x[Y+2]=V.z}let he=new le;return he.positions=x,he.normals=b,he.uvs=C,he.indices=_,he}function QI(s,e={orientation:p.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},t=null){let i=new k(s,t);return Sv(e).applyToMesh(i,e.updatable),i}k.CreateCapsule=(s,e,t)=>QI(s,e,t);le.CreateCapsule=Sv;function mB(s){let e=s.pathArray,t=s.closeArray||!1,i=s.closePath||!1,r=s.invertUV||!1,n=Math.floor(e[0].length/2),o=s.offset||n;o=o>n?n:Math.floor(o);let a=s.sideOrientation===0?0:s.sideOrientation||le.DEFAULTSIDE,l=s.uvs,c=s.colors,h=[],u=[],d=[],f=[],m=[],g=[],_=[],x=[],b,C=[],R=[],E,S,A;if(e.length<2){let Ie=[],st=[];for(S=0;S<e[0].length-o;S++)Ie.push(e[0][S]),st.push(e[0][S+o]);e=[Ie,st]}let L=0,G=i?1:0,W=t?1:0,$,re;b=e[0].length;let we,_e;for(E=0;E<e.length+W;E++){for(_[E]=0,m[E]=[0],$=E===e.length?e[0]:e[E],re=$.length,b=b<re?b:re,A=0;A<re;)h.push($[A].x,$[A].y,$[A].z),A>0&&(we=$[A].subtract($[A-1]).length(),_e=we+_[E],m[E].push(_e),_[E]=_e),A++;i&&(A--,h.push($[0].x,$[0].y,$[0].z),we=$[A].subtract($[0]).length(),_e=we+_[E],m[E].push(_e),_[E]=_e),C[E]=re+G,R[E]=L,L+=re+G}let ce,ne,Fe=null,Oe=null;for(S=0;S<b+G;S++)for(x[S]=0,g[S]=[0],E=0;E<e.length-1+W;E++)ce=e[E],ne=E===e.length-1?e[0]:e[E+1],S===b?(Fe=ce[0],Oe=ne[0]):(Fe=ce[S],Oe=ne[S]),we=Oe.subtract(Fe).length(),_e=we+x[S],g[S].push(_e),x[S]=_e;let he,ee;if(l)for(E=0;E<l.length;E++)f.push(l[E].x,it.UseOpenGLOrientationForUV?1-l[E].y:l[E].y);else for(E=0;E<e.length+W;E++)for(S=0;S<b+G;S++)he=_[E]!=0?m[E][S]/_[E]:0,ee=x[S]!=0?g[S][E]/x[S]:0,r?f.push(ee,he):f.push(he,it.UseOpenGLOrientationForUV?1-ee:ee);E=0;let V=0,Y=C[E]-1,J=C[E+1]-1,Me=Y<J?Y:J,Re=R[1]-R[0],et=C.length-1;for(;V<=Me&&E<et;)u.push(V,V+Re,V+1),u.push(V+Re+1,V+1,V+Re),V+=1,V===Me&&(E++,Re=R[E+1]-R[E],Y=C[E]-1,J=C[E+1]-1,V=R[E],Me=Y<J?Y+V:J+V);if(le.ComputeNormals(h,u,d),i){let Ie=0,st=0;for(E=0;E<e.length;E++){Ie=R[E]*3,E+1<e.length?st=(R[E+1]-1)*3:st=d.length-3,d[Ie]=(d[Ie]+d[st])*.5,d[Ie+1]=(d[Ie+1]+d[st+1])*.5,d[Ie+2]=(d[Ie+2]+d[st+2])*.5;let vi=Math.sqrt(d[Ie]*d[Ie]+d[Ie+1]*d[Ie+1]+d[Ie+2]*d[Ie+2]);d[Ie]/=vi,d[Ie+1]/=vi,d[Ie+2]/=vi,d[st]=d[Ie],d[st+1]=d[Ie+1],d[st+2]=d[Ie+2]}}if(t){let Ie=R[0]*3,st=R[e.length]*3;for(S=0;S<b+G;S++){d[Ie]=(d[Ie]+d[st])*.5,d[Ie+1]=(d[Ie+1]+d[st+1])*.5,d[Ie+2]=(d[Ie+2]+d[st+2])*.5;let vi=Math.sqrt(d[Ie]*d[Ie]+d[Ie+1]*d[Ie+1]+d[Ie+2]*d[Ie+2]);d[Ie]/=vi,d[Ie+1]/=vi,d[Ie+2]/=vi,d[st]=d[Ie],d[st+1]=d[Ie+1],d[st+2]=d[Ie+2],Ie+=3,st+=3}}le._ComputeSides(a,h,u,d,f,s.frontUVs,s.backUVs);let Tt=null;if(c){Tt=new Float32Array(c.length*4);for(let Ie=0;Ie<c.length;Ie++)Tt[Ie*4]=c[Ie].r,Tt[Ie*4+1]=c[Ie].g,Tt[Ie*4+2]=c[Ie].b,Tt[Ie*4+3]=c[Ie].a}let Yt=new le,si=new Float32Array(h),Er=new Float32Array(d),Xi=new Float32Array(f);return Yt.indices=u,Yt.positions=si,Yt.normals=Er,Yt.uvs=Xi,Tt&&Yt.set(Tt,y.ColorKind),i&&(Yt._idx=R),Yt}function ua(s,e,t=null){let i=e.pathArray,r=e.closeArray,n=e.closePath,o=k._GetDefaultSideOrientation(e.sideOrientation),a=e.instance,l=e.updatable;if(a){let c=O.Vector3[0].setAll(Number.MAX_VALUE),h=O.Vector3[1].setAll(-Number.MAX_VALUE),u=f=>{let m=i[0].length,g=a,_=0,x=g._originalBuilderSideOrientation===k.DOUBLESIDE?2:1;for(let b=1;b<=x;++b)for(let C=0;C<i.length;++C){let R=i[C],E=R.length;m=m<E?m:E;for(let S=0;S<m;++S){let A=R[S];f[_]=A.x,f[_+1]=A.y,f[_+2]=A.z,c.minimizeInPlaceFromFloats(A.x,A.y,A.z),h.maximizeInPlaceFromFloats(A.x,A.y,A.z),_+=3}if(g._creationDataStorage&&g._creationDataStorage.closePath){let S=R[0];f[_]=S.x,f[_+1]=S.y,f[_+2]=S.z,_+=3}}},d=a.getVerticesData(y.PositionKind);if(u(d),a.hasBoundingInfo?a.getBoundingInfo().reConstruct(c,h,a._worldMatrix):a.buildBoundingInfo(c,h,a._worldMatrix),a.updateVerticesData(y.PositionKind,d,!1,!1),e.colors){let f=a.getVerticesData(y.ColorKind);for(let m=0,g=0;m<e.colors.length;m++,g+=4){let _=e.colors[m];f[g]=_.r,f[g+1]=_.g,f[g+2]=_.b,f[g+3]=_.a}a.updateVerticesData(y.ColorKind,f,!1,!1)}if(e.uvs){let f=a.getVerticesData(y.UVKind);for(let m=0;m<e.uvs.length;m++)f[m*2]=e.uvs[m].x,f[m*2+1]=it.UseOpenGLOrientationForUV?1-e.uvs[m].y:e.uvs[m].y;a.updateVerticesData(y.UVKind,f,!1,!1)}if(!a.areNormalsFrozen||a.isFacetDataEnabled){let f=a.getIndices(),m=a.getVerticesData(y.NormalKind),g=a.isFacetDataEnabled?a.getFacetDataParameters():null;if(le.ComputeNormals(d,f,m,g),a._creationDataStorage&&a._creationDataStorage.closePath){let _=0,x=0;for(let b=0;b<i.length;b++)_=a._creationDataStorage.idx[b]*3,b+1<i.length?x=(a._creationDataStorage.idx[b+1]-1)*3:x=m.length-3,m[_]=(m[_]+m[x])*.5,m[_+1]=(m[_+1]+m[x+1])*.5,m[_+2]=(m[_+2]+m[x+2])*.5,m[x]=m[_],m[x+1]=m[_+1],m[x+2]=m[_+2]}a.areNormalsFrozen||a.updateVerticesData(y.NormalKind,m,!1,!1)}return a}else{let c=new k(s,t);c._originalBuilderSideOrientation=o,c._creationDataStorage=new pd;let h=mB(e);return n&&(c._creationDataStorage.idx=h._idx),c._creationDataStorage.closePath=n,c._creationDataStorage.closeArray=r,h.applyToMesh(c,l),c}}le.CreateRibbon=mB;k.CreateRibbon=(s,e,t=!1,i,r,n,o=!1,a,l)=>ua(s,{pathArray:e,closeArray:t,closePath:i,offset:r,updatable:o,sideOrientation:a,instance:l},n);function yv(s){let e=[],t=[],i=[],r=[],n=s.radius||.5,o=s.tessellation||64,a=s.arc&&(s.arc<=0||s.arc>1)?1:s.arc||1,l=s.sideOrientation===0?0:s.sideOrientation||le.DEFAULTSIDE;e.push(0,0,0),r.push(.5,.5);let c=Math.PI*2*a,h=a===1?c/o:c/(o-1),u=0;for(let m=0;m<o;m++){let g=Math.cos(u),_=Math.sin(u),x=(g+1)/2,b=(1-_)/2;e.push(n*g,n*_,0),r.push(x,it.UseOpenGLOrientationForUV?1-b:b),u+=h}a===1&&(e.push(e[3],e[4],e[5]),r.push(r[2],it.UseOpenGLOrientationForUV?1-r[3]:r[3]));let d=e.length/3;for(let m=1;m<d-1;m++)t.push(m+1,0,m);le.ComputeNormals(e,t,i),le._ComputeSides(l,e,t,i,r,s.frontUVs,s.backUVs);let f=new le;return f.indices=t,f.positions=e,f.normals=i,f.uvs=r,f}function fm(s,e={},t=null){let i=new k(s,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,yv(e).applyToMesh(i,e.updatable),i}le.CreateDisc=yv;k.CreateDisc=(s,e,t,i=null,r,n)=>fm(s,{radius:e,tessellation:t,sideOrientation:n,updatable:r},i);function pm(s){let e=s.pattern||k.NO_FLIP,t=s.tileWidth||s.tileSize||1,i=s.tileHeight||s.tileSize||1,r=s.alignHorizontal||0,n=s.alignVertical||0,o=s.width||s.size||1,a=Math.floor(o/t),l=o-a*t,c=s.height||s.size||1,h=Math.floor(c/i),u=c-h*i,d=t*a/2,f=i*h/2,m=0,g=0,_=0,x=0,b=0,C=0;if(l>0||u>0){switch(_=-d,x=-f,b=d,C=f,r){case k.CENTER:l/=2,_-=l,b+=l;break;case k.LEFT:b+=l,m=-l/2;break;case k.RIGHT:_-=l,m=l/2;break}switch(n){case k.CENTER:u/=2,x-=u,C+=u;break;case k.BOTTOM:C+=u,g=-u/2;break;case k.TOP:x-=u,g=u/2;break}}let R=[],E=[],S=[];S[0]=[0,0,1,0,1,1,0,1],S[1]=[0,0,1,0,1,1,0,1],(e===k.ROTATE_TILE||e===k.ROTATE_ROW)&&(S[1]=[1,1,0,1,0,0,1,0]),(e===k.FLIP_TILE||e===k.FLIP_ROW)&&(S[1]=[1,0,0,0,0,1,1,1]),(e===k.FLIP_N_ROTATE_TILE||e===k.FLIP_N_ROTATE_ROW)&&(S[1]=[0,1,1,1,1,0,0,0]);let A=[],L=[],G=[],W=0;for(let _e=0;_e<h;_e++)for(let ce=0;ce<a;ce++)R.push(-d+ce*t+m,-f+_e*i+g,0),R.push(-d+(ce+1)*t+m,-f+_e*i+g,0),R.push(-d+(ce+1)*t+m,-f+(_e+1)*i+g,0),R.push(-d+ce*t+m,-f+(_e+1)*i+g,0),G.push(W,W+1,W+3,W+1,W+2,W+3),e===k.FLIP_TILE||e===k.ROTATE_TILE||e===k.FLIP_N_ROTATE_TILE?A=A.concat(S[(ce%2+_e%2)%2]):e===k.FLIP_ROW||e===k.ROTATE_ROW||e===k.FLIP_N_ROTATE_ROW?A=A.concat(S[_e%2]):A=A.concat(S[0]),L.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),W+=4;if(l>0||u>0){let _e=u>0&&(n===k.CENTER||n===k.TOP),ce=u>0&&(n===k.CENTER||n===k.BOTTOM),ne=l>0&&(r===k.CENTER||r===k.RIGHT),Fe=l>0&&(r===k.CENTER||r===k.LEFT),Oe=[],he,ee,V,Y;if(_e&&ne&&(R.push(_+m,x+g,0),R.push(-d+m,x+g,0),R.push(-d+m,x+u+g,0),R.push(_+m,x+u+g,0),G.push(W,W+1,W+3,W+1,W+2,W+3),W+=4,he=1-l/t,ee=1-u/i,V=1,Y=1,Oe=[he,ee,V,ee,V,Y,he,Y],e===k.ROTATE_ROW&&(Oe=[1-he,1-ee,1-V,1-ee,1-V,1-Y,1-he,1-Y]),e===k.FLIP_ROW&&(Oe=[1-he,ee,1-V,ee,1-V,Y,1-he,Y]),e===k.FLIP_N_ROTATE_ROW&&(Oe=[he,1-ee,V,1-ee,V,1-Y,he,1-Y]),A=A.concat(Oe),L.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),_e&&Fe&&(R.push(d+m,x+g,0),R.push(b+m,x+g,0),R.push(b+m,x+u+g,0),R.push(d+m,x+u+g,0),G.push(W,W+1,W+3,W+1,W+2,W+3),W+=4,he=0,ee=1-u/i,V=l/t,Y=1,Oe=[he,ee,V,ee,V,Y,he,Y],(e===k.ROTATE_ROW||e===k.ROTATE_TILE&&a%2===0)&&(Oe=[1-he,1-ee,1-V,1-ee,1-V,1-Y,1-he,1-Y]),(e===k.FLIP_ROW||e===k.FLIP_TILE&&a%2===0)&&(Oe=[1-he,ee,1-V,ee,1-V,Y,1-he,Y]),(e===k.FLIP_N_ROTATE_ROW||e===k.FLIP_N_ROTATE_TILE&&a%2===0)&&(Oe=[he,1-ee,V,1-ee,V,1-Y,he,1-Y]),A=A.concat(Oe),L.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),ce&&ne&&(R.push(_+m,f+g,0),R.push(-d+m,f+g,0),R.push(-d+m,C+g,0),R.push(_+m,C+g,0),G.push(W,W+1,W+3,W+1,W+2,W+3),W+=4,he=1-l/t,ee=0,V=1,Y=u/i,Oe=[he,ee,V,ee,V,Y,he,Y],(e===k.ROTATE_ROW&&h%2===1||e===k.ROTATE_TILE&&h%1===0)&&(Oe=[1-he,1-ee,1-V,1-ee,1-V,1-Y,1-he,1-Y]),(e===k.FLIP_ROW&&h%2===1||e===k.FLIP_TILE&&h%2===0)&&(Oe=[1-he,ee,1-V,ee,1-V,Y,1-he,Y]),(e===k.FLIP_N_ROTATE_ROW&&h%2===1||e===k.FLIP_N_ROTATE_TILE&&h%2===0)&&(Oe=[he,1-ee,V,1-ee,V,1-Y,he,1-Y]),A=A.concat(Oe),L.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),ce&&Fe&&(R.push(d+m,f+g,0),R.push(b+m,f+g,0),R.push(b+m,C+g,0),R.push(d+m,C+g,0),G.push(W,W+1,W+3,W+1,W+2,W+3),W+=4,he=0,ee=0,V=l/t,Y=u/i,Oe=[he,ee,V,ee,V,Y,he,Y],(e===k.ROTATE_ROW&&h%2===1||e===k.ROTATE_TILE&&(h+a)%2===1)&&(Oe=[1-he,1-ee,1-V,1-ee,1-V,1-Y,1-he,1-Y]),(e===k.FLIP_ROW&&h%2===1||e===k.FLIP_TILE&&(h+a)%2===1)&&(Oe=[1-he,ee,1-V,ee,1-V,Y,1-he,Y]),(e===k.FLIP_N_ROTATE_ROW&&h%2===1||e===k.FLIP_N_ROTATE_TILE&&(h+a)%2===1)&&(Oe=[he,1-ee,V,1-ee,V,1-Y,he,1-Y]),A=A.concat(Oe),L.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),_e){let J=[];he=0,ee=1-u/i,V=1,Y=1,J[0]=[he,ee,V,ee,V,Y,he,Y],J[1]=[he,ee,V,ee,V,Y,he,Y],(e===k.ROTATE_TILE||e===k.ROTATE_ROW)&&(J[1]=[1-he,1-ee,1-V,1-ee,1-V,1-Y,1-he,1-Y]),(e===k.FLIP_TILE||e===k.FLIP_ROW)&&(J[1]=[1-he,ee,1-V,ee,1-V,Y,1-he,Y]),(e===k.FLIP_N_ROTATE_TILE||e===k.FLIP_N_ROTATE_ROW)&&(J[1]=[he,1-ee,V,1-ee,V,1-Y,he,1-Y]);for(let Me=0;Me<a;Me++)R.push(-d+Me*t+m,x+g,0),R.push(-d+(Me+1)*t+m,x+g,0),R.push(-d+(Me+1)*t+m,x+u+g,0),R.push(-d+Me*t+m,x+u+g,0),G.push(W,W+1,W+3,W+1,W+2,W+3),W+=4,e===k.FLIP_TILE||e===k.ROTATE_TILE||e===k.FLIP_N_ROTATE_TILE?A=A.concat(J[(Me+1)%2]):e===k.FLIP_ROW||e===k.ROTATE_ROW||e===k.FLIP_N_ROTATE_ROW?A=A.concat(J[1]):A=A.concat(J[0]),L.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(ce){let J=[];he=0,ee=0,V=1,Y=u/i,J[0]=[he,ee,V,ee,V,Y,he,Y],J[1]=[he,ee,V,ee,V,Y,he,Y],(e===k.ROTATE_TILE||e===k.ROTATE_ROW)&&(J[1]=[1-he,1-ee,1-V,1-ee,1-V,1-Y,1-he,1-Y]),(e===k.FLIP_TILE||e===k.FLIP_ROW)&&(J[1]=[1-he,ee,1-V,ee,1-V,Y,1-he,Y]),(e===k.FLIP_N_ROTATE_TILE||e===k.FLIP_N_ROTATE_ROW)&&(J[1]=[he,1-ee,V,1-ee,V,1-Y,he,1-Y]);for(let Me=0;Me<a;Me++)R.push(-d+Me*t+m,C-u+g,0),R.push(-d+(Me+1)*t+m,C-u+g,0),R.push(-d+(Me+1)*t+m,C+g,0),R.push(-d+Me*t+m,C+g,0),G.push(W,W+1,W+3,W+1,W+2,W+3),W+=4,e===k.FLIP_TILE||e===k.ROTATE_TILE||e===k.FLIP_N_ROTATE_TILE?A=A.concat(J[(Me+h)%2]):e===k.FLIP_ROW||e===k.ROTATE_ROW||e===k.FLIP_N_ROTATE_ROW?A=A.concat(J[h%2]):A=A.concat(J[0]),L.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(ne){let J=[];he=1-l/t,ee=0,V=1,Y=1,J[0]=[he,ee,V,ee,V,Y,he,Y],J[1]=[he,ee,V,ee,V,Y,he,Y],(e===k.ROTATE_TILE||e===k.ROTATE_ROW)&&(J[1]=[1-he,1-ee,1-V,1-ee,1-V,1-Y,1-he,1-Y]),(e===k.FLIP_TILE||e===k.FLIP_ROW)&&(J[1]=[1-he,ee,1-V,ee,1-V,Y,1-he,Y]),(e===k.FLIP_N_ROTATE_TILE||e===k.FLIP_N_ROTATE_ROW)&&(J[1]=[he,1-ee,V,1-ee,V,1-Y,he,1-Y]);for(let Me=0;Me<h;Me++)R.push(_+m,-f+Me*i+g,0),R.push(_+l+m,-f+Me*i+g,0),R.push(_+l+m,-f+(Me+1)*i+g,0),R.push(_+m,-f+(Me+1)*i+g,0),G.push(W,W+1,W+3,W+1,W+2,W+3),W+=4,e===k.FLIP_TILE||e===k.ROTATE_TILE||e===k.FLIP_N_ROTATE_TILE?A=A.concat(J[(Me+1)%2]):e===k.FLIP_ROW||e===k.ROTATE_ROW||e===k.FLIP_N_ROTATE_ROW?A=A.concat(J[Me%2]):A=A.concat(J[0]),L.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(Fe){let J=[];he=0,ee=0,V=l/i,Y=1,J[0]=[he,ee,V,ee,V,Y,he,Y],J[1]=[he,ee,V,ee,V,Y,he,Y],(e===k.ROTATE_TILE||e===k.ROTATE_ROW)&&(J[1]=[1-he,1-ee,1-V,1-ee,1-V,1-Y,1-he,1-Y]),(e===k.FLIP_TILE||e===k.FLIP_ROW)&&(J[1]=[1-he,ee,1-V,ee,1-V,Y,1-he,Y]),(e===k.FLIP_N_ROTATE_TILE||e===k.FLIP_N_ROTATE_ROW)&&(J[1]=[he,1-ee,V,1-ee,V,1-Y,he,1-Y]);for(let Me=0;Me<h;Me++)R.push(b-l+m,-f+Me*i+g,0),R.push(b+m,-f+Me*i+g,0),R.push(b+m,-f+(Me+1)*i+g,0),R.push(b-l+m,-f+(Me+1)*i+g,0),G.push(W,W+1,W+3,W+1,W+2,W+3),W+=4,e===k.FLIP_TILE||e===k.ROTATE_TILE||e===k.FLIP_N_ROTATE_TILE?A=A.concat(J[(Me+a)%2]):e===k.FLIP_ROW||e===k.ROTATE_ROW||e===k.FLIP_N_ROTATE_ROW?A=A.concat(J[Me%2]):A=A.concat(J[0]),L.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),E.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}let $=s.sideOrientation===0?0:s.sideOrientation||le.DEFAULTSIDE;le._ComputeSides($,R,G,E,A,s.frontUVs,s.backUVs);let re=new le;re.indices=G,re.positions=R,re.normals=E,re.uvs=A;let we=$===le.DOUBLESIDE?L.concat(L):L;return re.colors=we,re}le.CreateTiledPlane=pm;function q5(s){let t=s.faceUV||new Array(6),i=s.faceColors,r=s.pattern||k.NO_FLIP,n=s.width||s.size||1,o=s.height||s.size||1,a=s.depth||s.size||1,l=s.tileWidth||s.tileSize||1,c=s.tileHeight||s.tileSize||1,h=s.alignHorizontal||0,u=s.alignVertical||0,d=s.sideOrientation===0?0:s.sideOrientation||le.DEFAULTSIDE;for(let V=0;V<6;V++)t[V]===void 0&&(t[V]=new De(0,0,1,1)),i&&i[V]===void 0&&(i[V]=new oe(1,1,1,1));let f=n/2,m=o/2,g=a/2,_=[];for(let V=0;V<2;V++)_[V]=pm({pattern:r,tileWidth:l,tileHeight:c,width:n,height:o,alignVertical:u,alignHorizontal:h,sideOrientation:d});for(let V=2;V<4;V++)_[V]=pm({pattern:r,tileWidth:l,tileHeight:c,width:a,height:o,alignVertical:u,alignHorizontal:h,sideOrientation:d});let x=u;u===k.BOTTOM?x=k.TOP:u===k.TOP&&(x=k.BOTTOM);for(let V=4;V<6;V++)_[V]=pm({pattern:r,tileWidth:l,tileHeight:c,width:n,height:a,alignVertical:x,alignHorizontal:h,sideOrientation:d});let b=[],C=[],R=[],E=[],S=[],A=[],L=[],G=[],W=0,$=0;for(let V=0;V<6;V++){let Y=_[V].positions.length;A[V]=[],L[V]=[];for(let J=0;J<Y/3;J++)A[V].push(new p(_[V].positions[3*J],_[V].positions[3*J+1],_[V].positions[3*J+2])),L[V].push(new p(_[V].normals[3*J],_[V].normals[3*J+1],_[V].normals[3*J+2]));W=_[V].uvs.length,G[V]=[];for(let J=0;J<W;J+=2)G[V][J]=t[V].x+(t[V].z-t[V].x)*_[V].uvs[J],G[V][J+1]=t[V].y+(t[V].w-t[V].y)*_[V].uvs[J+1],it.UseOpenGLOrientationForUV&&(G[V][J+1]=1-G[V][J+1]);if(R=R.concat(G[V]),E=E.concat(_[V].indices.map(J=>J+$)),$+=A[V].length,i)for(let J=0;J<4;J++)S.push(i[V].r,i[V].g,i[V].b,i[V].a)}let re=new p(0,0,g),we=N.RotationY(Math.PI);b=A[0].map(V=>p.TransformNormal(V,we).add(re)).map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[]),C=L[0].map(V=>p.TransformNormal(V,we)).map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[]),b=b.concat(A[1].map(V=>V.subtract(re)).map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[])),C=C.concat(L[1].map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[]));let _e=new p(f,0,0),ce=N.RotationY(-Math.PI/2);b=b.concat(A[2].map(V=>p.TransformNormal(V,ce).add(_e)).map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[])),C=C.concat(L[2].map(V=>p.TransformNormal(V,ce)).map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[]));let ne=N.RotationY(Math.PI/2);b=b.concat(A[3].map(V=>p.TransformNormal(V,ne).subtract(_e)).map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[])),C=C.concat(L[3].map(V=>p.TransformNormal(V,ne)).map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[]));let Fe=new p(0,m,0),Oe=N.RotationX(Math.PI/2);b=b.concat(A[4].map(V=>p.TransformNormal(V,Oe).add(Fe)).map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[])),C=C.concat(L[4].map(V=>p.TransformNormal(V,Oe)).map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[]));let he=N.RotationX(-Math.PI/2);b=b.concat(A[5].map(V=>p.TransformNormal(V,he).subtract(Fe)).map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[])),C=C.concat(L[5].map(V=>p.TransformNormal(V,he)).map(V=>[V.x,V.y,V.z]).reduce((V,Y)=>V.concat(Y),[])),le._ComputeSides(d,b,E,C,R);let ee=new le;if(ee.indices=E,ee.positions=b,ee.normals=C,ee.uvs=R,i){let V=d===le.DOUBLESIDE?S.concat(S):S;ee.colors=V}return ee}le.CreateTiledBox=q5;function gB(s){let e=[],t=[],i=[],r=[],n=s.radius||2,o=s.tube||.5,a=s.radialSegments||32,l=s.tubularSegments||32,c=s.p||2,h=s.q||3,u=s.sideOrientation===0?0:s.sideOrientation||le.DEFAULTSIDE,d=_=>{let x=Math.cos(_),b=Math.sin(_),C=h/c*_,R=Math.cos(C),E=n*(2+R)*.5*x,S=n*(2+R)*b*.5,A=n*Math.sin(C)*.5;return new p(E,S,A)},f,m;for(f=0;f<=a;f++){let x=f%a/a*2*c*Math.PI,b=d(x),C=d(x+.01),R=C.subtract(b),E=C.add(b),S=p.Cross(R,E);for(E=p.Cross(S,R),S.normalize(),E.normalize(),m=0;m<l;m++){let L=m%l/l*2*Math.PI,G=-o*Math.cos(L),W=o*Math.sin(L);t.push(b.x+G*E.x+W*S.x),t.push(b.y+G*E.y+W*S.y),t.push(b.z+G*E.z+W*S.z),r.push(f/a),r.push(it.UseOpenGLOrientationForUV?1-m/l:m/l)}}for(f=0;f<a;f++)for(m=0;m<l;m++){let _=(m+1)%l,x=f*l+m,b=(f+1)*l+m,C=(f+1)*l+_,R=f*l+_;e.push(R),e.push(b),e.push(x),e.push(R),e.push(C),e.push(b)}le.ComputeNormals(t,e,i),le._ComputeSides(u,t,e,i,r,s.frontUVs,s.backUVs);let g=new le;return g.indices=e,g.positions=t,g.normals=i,g.uvs=r,g}function _B(s,e={},t){let i=new k(s,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,gB(e).applyToMesh(i,e.updatable),i}le.CreateTorusKnot=gB;k.CreateTorusKnot=(s,e,t,i,r,n,o,a,l,c)=>_B(s,{radius:e,tube:t,radialSegments:i,tubularSegments:r,p:n,q:o,sideOrientation:c,updatable:l},a);var Q5="colorPixelShader",K5=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#include<fogFragment>(color,gl_FragColor)
#define CUSTOM_FRAGMENT_MAIN_END
}`;D.ShadersStore[Q5]=K5;var Z5="colorVertexShader",J5=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#ifdef FOG
uniform mat4 view;
#endif
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[Z5]=J5;k._LinesMeshParser=(s,e)=>Ka.Parse(s,e);var Ka=class s extends k{_isShaderMaterial(e){return e.getClassName()==="ShaderMaterial"}constructor(e,t=null,i=null,r=null,n,o,a,l){super(e,t,i,r,n),this.useVertexColor=o,this.useVertexAlpha=a,this.color=new X(1,1,1),this.alpha=1,r&&(this.color=r.color.clone(),this.alpha=r.alpha,this.useVertexColor=r.useVertexColor,this.useVertexAlpha=r.useVertexAlpha),this.intersectionThreshold=.1;let c=[],h={attributes:[y.PositionKind],uniforms:["world","viewProjection"],needAlphaBlending:!0,defines:c,useClipPlane:null};a===!1?h.needAlphaBlending=!1:h.defines.push("#define VERTEXALPHA"),o?(h.defines.push("#define VERTEXCOLOR"),h.attributes.push(y.ColorKind)):(h.uniforms.push("color"),this._color4=new oe),l?this.material=l:(this.material=new Fi("colorShader",this.getScene(),"color",h,!1),this.material.doNotSerialize=!0)}isReady(){return this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage||this.hasThinInstances)?super.isReady():!1}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=se.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(e,t){if(!this._geometry)return this;let i=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,i):this._geometry._bind(t,i,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){let{r,g:n,b:o}=this.color;this._color4.set(r,n,o,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;let r=this.getScene().getEngine();return this._unIndexed?r.drawArraysType(se.LineListDrawMode,e.verticesStart,e.verticesCount,i):r.drawElementsType(se.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e,t=!1,i){i||this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new s(e,this.getScene(),t,this,i)}createInstance(e){let t=new mm(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(let i in this.instancedBuffers)t.instancedBuffers[i]=this.instancedBuffers[i]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){let i=new s(e.name,t);return i.color=X.FromArray(e.color),i.alpha=e.alpha,i}},mm=class extends qa{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}};function xB(s){let e=[],t=[],i=s.lines,r=s.colors,n=[],o=0;for(let l=0;l<i.length;l++){let c=i[l];for(let h=0;h<c.length;h++){let{x:u,y:d,z:f}=c[h];if(t.push(u,d,f),r){let m=r[l],{r:g,g:_,b:x,a:b}=m[h];n.push(g,_,x,b)}h>0&&(e.push(o-1),e.push(o)),o++}}let a=new le;return a.indices=e,a.positions=t,r&&(a.colors=n),a}function vB(s){let e=s.dashSize||3,t=s.gapSize||1,i=s.dashNb||200,r=s.points,n=[],o=[],a=p.Zero(),l=0,c=0,h=0,u=0,d=0,f=0,m=0;for(m=0;m<r.length-1;m++)r[m+1].subtractToRef(r[m],a),l+=a.length();for(h=l/i,u=e*h/(e+t),m=0;m<r.length-1;m++){r[m+1].subtractToRef(r[m],a),c=Math.floor(a.length()/h),a.normalize();for(let _=0;_<c;_++)d=h*_,n.push(r[m].x+d*a.x,r[m].y+d*a.y,r[m].z+d*a.z),n.push(r[m].x+(d+u)*a.x,r[m].y+(d+u)*a.y,r[m].z+(d+u)*a.z),o.push(f,f+1),f+=2}let g=new le;return g.positions=n,g.indices=o,g}function KI(s,e,t=null){let i=e.instance,r=e.lines,n=e.colors;if(i){let c=i.getVerticesData(y.PositionKind),h,u;n&&(h=i.getVerticesData(y.ColorKind));let d=0,f=0;for(let m=0;m<r.length;m++){let g=r[m];for(let _=0;_<g.length;_++)c[d]=g[_].x,c[d+1]=g[_].y,c[d+2]=g[_].z,n&&h&&(u=n[m],h[f]=u[_].r,h[f+1]=u[_].g,h[f+2]=u[_].b,h[f+3]=u[_].a,f+=4),d+=3}return i.updateVerticesData(y.PositionKind,c,!1,!1),n&&h&&i.updateVerticesData(y.ColorKind,h,!1,!1),i}let o=!!n,a=new Ka(s,t,null,void 0,void 0,o,e.useVertexAlpha,e.material);return xB(e).applyToMesh(a,e.updatable),a}function da(s,e,t=null){let i=e.colors?[e.colors]:null;return KI(s,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:i,useVertexAlpha:e.useVertexAlpha,material:e.material},t)}function TB(s,e,t=null){let i=e.points,r=e.instance,n=e.gapSize||1,o=e.dashSize||3;if(r){let c=h=>{let u=p.Zero(),d=h.length/6,f=0,m=0,g=0,_=0,x=0,b=0,C=0,R=0;for(C=0;C<i.length-1;C++)i[C+1].subtractToRef(i[C],u),f+=u.length();g=f/d;let E=r._creationDataStorage.dashSize,S=r._creationDataStorage.gapSize;for(_=E*g/(E+S),C=0;C<i.length-1;C++)for(i[C+1].subtractToRef(i[C],u),m=Math.floor(u.length()/g),u.normalize(),R=0;R<m&&b<h.length;)x=g*R,h[b]=i[C].x+x*u.x,h[b+1]=i[C].y+x*u.y,h[b+2]=i[C].z+x*u.z,h[b+3]=i[C].x+(x+_)*u.x,h[b+4]=i[C].y+(x+_)*u.y,h[b+5]=i[C].z+(x+_)*u.z,b+=6,R++;for(;b<h.length;)h[b]=i[C].x,h[b+1]=i[C].y,h[b+2]=i[C].z,b+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&F.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),r.updateMeshPositions(c,!1),r}let a=new Ka(s,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return vB(e).applyToMesh(a,e.updatable),a._creationDataStorage=new pd,a._creationDataStorage.dashSize=o,a._creationDataStorage.gapSize=n,a}le.CreateLineSystem=xB;le.CreateDashedLines=vB;k.CreateLines=(s,e,t=null,i=!1,r=null)=>da(s,{points:e,updatable:i,instance:r},t);k.CreateDashedLines=(s,e,t,i,r,n=null,o,a)=>TB(s,{points:e,dashSize:t,gapSize:i,dashNb:r,updatable:o,instance:a},n);var ZI=class extends j{constructor(e,t){super(e.x,e.y),this.index=t}},gm=class{constructor(){this.elements=[]}add(e){let t=[];return e.forEach(i=>{let r=new ZI(i,this.elements.length);t.push(r),this.elements.push(r)}),t}computeBounds(){let e=new j(this.elements[0].x,this.elements[0].y),t=new j(this.elements[0].x,this.elements[0].y);return this.elements.forEach(i=>{i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y)}),{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}};var Ev=class{_addToepoint(e){for(let t of e)this._epoints.push(t.x,t.y)}constructor(e,t,i,r=earcut){this._points=new gm,this._outlinepoints=new gm,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=r,this._name=e,this._scene=i||me.LastCreatedScene;let n;t instanceof ld?n=t.getPoints():n=t,this._addToepoint(n),this._points.add(n),this._outlinepoints.add(n),typeof this.bjsEarcut>"u"&&F.Warn("Earcut was not found, the polygon will not be built.")}addHole(e){this._points.add(e);let t=new gm;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,i=2){let r=new k(this._name,this._scene),n=this.buildVertexData(t,i);return r.setVerticesData(y.PositionKind,n.positions,e),r.setVerticesData(y.NormalKind,n.normals,e),r.setVerticesData(y.UVKind,n.uvs,e),r.setIndices(n.indices),r}buildVertexData(e=0,t=2){let i=new le,r=[],n=[],o=[],a=this._points.computeBounds();this._points.elements.forEach(h=>{r.push(0,1,0),n.push(h.x,0,h.y),o.push((h.x-a.min.x)/a.width,(h.y-a.min.y)/a.height)});let l=[],c=this.bjsEarcut(this._epoints,this._eholes,2);for(let h=0;h<c.length;h++)l.push(c[h]);if(e>0){let h=n.length/3;this._points.elements.forEach(d=>{r.push(0,-1,0),n.push(d.x,-e,d.y),o.push(1-(d.x-a.min.x)/a.width,1-(d.y-a.min.y)/a.height)});let u=l.length;for(let d=0;d<u;d+=3){let f=l[d+0],m=l[d+1],g=l[d+2];l.push(g+h),l.push(m+h),l.push(f+h)}this._addSide(n,r,o,l,a,this._outlinepoints,e,!1,t),this._holes.forEach(d=>{this._addSide(n,r,o,l,a,d,e,!0,t)})}return i.indices=l,i.positions=n,i.normals=r,i.uvs=o,i}_addSide(e,t,i,r,n,o,a,l,c){let h=e.length/3,u=0;for(let d=0;d<o.elements.length;d++){let f=o.elements[d],m=o.elements[(d+1)%o.elements.length];e.push(f.x,0,f.y),e.push(f.x,-a,f.y),e.push(m.x,0,m.y),e.push(m.x,-a,m.y);let g=o.elements[(d+o.elements.length-1)%o.elements.length],_=o.elements[(d+2)%o.elements.length],x=new p(-(m.y-f.y),0,m.x-f.x),b=new p(-(f.y-g.y),0,f.x-g.x),C=new p(-(_.y-m.y),0,_.x-m.x);l||(x=x.scale(-1),b=b.scale(-1),C=C.scale(-1));let R=x.normalizeToNew(),E=b.normalizeToNew(),S=C.normalizeToNew(),A=p.Dot(E,R);A>c?A<je-1?E=new p(f.x,0,f.y).subtract(new p(m.x,0,m.y)).normalize():E=b.add(x).normalize():E=R;let L=p.Dot(C,x);L>c?L<je-1?S=new p(m.x,0,m.y).subtract(new p(f.x,0,f.y)).normalize():S=C.add(x).normalize():S=R,i.push(u/n.width,0),i.push(u/n.width,1),u+=x.length(),i.push(u/n.width,0),i.push(u/n.width,1),t.push(E.x,E.y,E.z),t.push(E.x,E.y,E.z),t.push(S.x,S.y,S.z),t.push(S.x,S.y,S.z),l?(r.push(h),r.push(h+2),r.push(h+1),r.push(h+1),r.push(h+2),r.push(h+3)):(r.push(h),r.push(h+1),r.push(h+2),r.push(h+1),r.push(h+3),r.push(h+2)),h+=4}}};function CB(s,e,t,i,r,n,o){let a=t||new Array(3),l=i,c=[],h=o||!1;for(let G=0;G<3;G++)a[G]===void 0&&(a[G]=new De(0,0,1,1)),l&&l[G]===void 0&&(l[G]=new oe(1,1,1,1));let u=s.getVerticesData(y.PositionKind),d=s.getVerticesData(y.NormalKind),f=s.getVerticesData(y.UVKind),m=s.getIndices(),g=u.length/9,_=0,x=0,b=0,C=0,R=0,E=[0];if(h)for(let G=g;G<u.length/3;G+=4)x=u[3*(G+2)]-u[3*G],b=u[3*(G+2)+2]-u[3*G+2],C=Math.sqrt(x*x+b*b),R+=C,E.push(R);let S=0,A=0;for(let G=0;G<d.length;G+=3)Math.abs(d[G+1])<.001&&(A=1),Math.abs(d[G+1]-1)<.001&&(A=0),Math.abs(d[G+1]+1)<.001&&(A=2),S=G/3,A===1?(_=S-g,_%4<1.5?h?f[2*S]=a[A].x+(a[A].z-a[A].x)*E[Math.floor(_/4)]/R:f[2*S]=a[A].x:h?f[2*S]=a[A].x+(a[A].z-a[A].x)*E[Math.floor(_/4)+1]/R:f[2*S]=a[A].z,_%2===0?f[2*S+1]=it.UseOpenGLOrientationForUV?1-a[A].w:a[A].w:f[2*S+1]=it.UseOpenGLOrientationForUV?1-a[A].y:a[A].y):(f[2*S]=(1-f[2*S])*a[A].x+f[2*S]*a[A].z,f[2*S+1]=(1-f[2*S+1])*a[A].y+f[2*S+1]*a[A].w,it.UseOpenGLOrientationForUV&&(f[2*S+1]=1-f[2*S+1])),l&&c.push(l[A].r,l[A].g,l[A].b,l[A].a);le._ComputeSides(e,u,m,d,f,r,n);let L=new le;if(L.indices=m,L.positions=u,L.normals=d,L.uvs=f,l){let G=e===le.DOUBLESIDE?c.concat(c):c;L.colors=G}return L}function JI(s,e,t=null,i=earcut){e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation);let r=e.shape,n=e.holes||[],o=e.depth||0,a=e.smoothingThreshold||2,l=[],c=[];for(let m=0;m<r.length;m++)l[m]=new j(r[m].x,r[m].z);l[0].equalsWithEpsilon(l[l.length-1],1e-8)&&l.pop();let u=new Ev(s,l,t||me.LastCreatedScene,i);for(let m=0;m<n.length;m++){c=[];for(let g=0;g<n[m].length;g++)c.push(new j(n[m][g].x,n[m][g].z));u.addHole(c)}let d=u.build(!1,o,a);return d._originalBuilderSideOrientation=e.sideOrientation,CB(d,e.sideOrientation,e.faceUV,e.faceColors,e.frontUVs,e.backUVs,e.wrap).applyToMesh(d,e.updatable),d}function e0(s,e,t=null,i=earcut){return JI(s,e,t,i)}le.CreatePolygon=CB;k.CreatePolygon=(s,e,t,i,r,n,o=earcut)=>JI(s,{shape:e,holes:i,updatable:r,sideOrientation:n},t,o);k.ExtrudePolygon=(s,e,t,i,r,n,o,a=earcut)=>e0(s,{shape:e,holes:r,depth:t,updatable:n,sideOrientation:o},i,a);function Av(s,e,t=null){let i=e.path,r=e.shape,n=e.scale||1,o=e.rotation||0,a=e.cap===0?0:e.cap||k.NO_CAP,l=e.updatable,c=k._GetDefaultSideOrientation(e.sideOrientation),h=e.instance||null,u=e.invertUV||!1,d=e.closeShape||!1,f=e.closePath||!1;return bB(s,r,i,n,o,null,null,f,d,a,!1,t,!!l,c,h,u,e.frontUVs||null,e.backUVs||null,e.firstNormal||null,!!e.adjustFrame)}function t0(s,e,t=null){let i=e.path,r=e.shape,n=e.scaleFunction||(()=>1),o=e.rotationFunction||(()=>0),a=e.closePath||e.ribbonCloseArray||!1,l=e.closeShape||e.ribbonClosePath||!1,c=e.cap===0?0:e.cap||k.NO_CAP,h=e.updatable,u=e.firstNormal||null,d=e.adjustFrame||!1,f=k._GetDefaultSideOrientation(e.sideOrientation),m=e.instance,g=e.invertUV||!1;return bB(s,r,i,null,null,n,o,a,l,c,!0,t,!!h,f,m||null,g,e.frontUVs||null,e.backUVs||null,u,d)}function bB(s,e,t,i,r,n,o,a,l,c,h,u,d,f,m,g,_,x,b,C){let R=(G,W,$,re,we,_e,ce,ne,Fe,Oe,he)=>{let ee=$.getTangents(),V=$.getNormals(),Y=$.getBinormals(),J=$.getDistances();if(he){for(let Ie=0;Ie<ee.length;Ie++)if(ee[Ie].x==0&&ee[Ie].y==0&&ee[Ie].z==0&&ee[Ie].copyFrom(ee[Ie-1]),V[Ie].x==0&&V[Ie].y==0&&V[Ie].z==0&&V[Ie].copyFrom(V[Ie-1]),Y[Ie].x==0&&Y[Ie].y==0&&Y[Ie].z==0&&Y[Ie].copyFrom(Y[Ie-1]),Ie>0){let st=ee[Ie-1];p.Dot(st,ee[Ie])<0&&ee[Ie].scaleInPlace(-1),st=V[Ie-1],p.Dot(st,V[Ie])<0&&V[Ie].scaleInPlace(-1),st=Y[Ie-1],p.Dot(st,Y[Ie])<0&&Y[Ie].scaleInPlace(-1)}}let Me=0,Re=()=>we!==null?we:1,Tt=Oe&&ne?ne:()=>_e!==null?_e:0,Yt=Oe&&ce?ce:Re,si=Fe===k.NO_CAP||Fe===k.CAP_END?0:2,Er=O.Matrix[0];for(let Ie=0;Ie<W.length;Ie++){let st=[],vi=Tt(Ie,J[Ie]),sr=Yt(Ie,J[Ie]);N.RotationAxisToRef(ee[Ie],Me,Er);for(let Ar=0;Ar<G.length;Ar++){let cu=ee[Ie].scale(G[Ar].z).add(V[Ie].scale(G[Ar].x)).add(Y[Ie].scale(G[Ar].y)),Cl=p.Zero();p.TransformCoordinatesToRef(cu,Er,Cl),Cl.scaleInPlace(sr).addInPlace(W[Ie]),st[Ar]=Cl}re[si]=st,Me+=vi,si++}let Xi=Ie=>{let st=Array(),vi=p.Zero(),sr;for(sr=0;sr<Ie.length;sr++)vi.addInPlace(Ie[sr]);for(vi.scaleInPlace(1/Ie.length),sr=0;sr<Ie.length;sr++)st.push(vi);return st};switch(Fe){case k.NO_CAP:break;case k.CAP_START:re[0]=Xi(re[2]),re[1]=re[2];break;case k.CAP_END:re[si]=re[si-1],re[si+1]=Xi(re[si-1]);break;case k.CAP_ALL:re[0]=Xi(re[2]),re[1]=re[2],re[si]=re[si-1],re[si+1]=Xi(re[si-1]);break;default:break}return re},E,S;if(m){let G=m._creationDataStorage;return E=b?G.path3D.update(t,b):G.path3D.update(t),S=R(e,t,G.path3D,G.pathArray,i,r,n,o,G.cap,h,C),m=ua("",{pathArray:S,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:m},u||void 0),m}E=b?new Yc(t,b):new Yc(t);let A=new Array;c=c<0||c>3?0:c,S=R(e,t,E,A,i,r,n,o,c,h,C);let L=ua(s,{pathArray:S,closeArray:a,closePath:l,updatable:d,sideOrientation:f,invertUV:g,frontUVs:_||void 0,backUVs:x||void 0},u);return L._creationDataStorage.pathArray=S,L._creationDataStorage.path3D=E,L._creationDataStorage.cap=c,L}k.ExtrudeShape=(s,e,t,i,r,n,o=null,a,l,c)=>{let h={shape:e,path:t,scale:i,rotation:r,cap:n===0?0:n||k.NO_CAP,sideOrientation:l,instance:c,updatable:a};return Av(s,h,o)};k.ExtrudeShapeCustom=(s,e,t,i,r,n,o,a,l,c,h,u)=>{let d={shape:e,path:t,scaleFunction:i,rotationFunction:r,ribbonCloseArray:n,ribbonClosePath:o,cap:a===0?0:a||k.NO_CAP,sideOrientation:h,instance:u,updatable:c};return t0(s,d,l)};function SB(s,e,t=null){let i=e.arc?e.arc<=0||e.arc>1?1:e.arc:1,r=e.closed===void 0?!0:e.closed,n=e.shape,o=e.radius||1,a=e.tessellation||64,l=e.clip||0,c=e.updatable,h=k._GetDefaultSideOrientation(e.sideOrientation),u=e.cap||k.NO_CAP,d=Math.PI*2,f=[],m=e.invertUV||!1,g=0,_=0,x=d/a*i,b,C;for(g=0;g<=a-l;g++){for(C=[],(u==k.CAP_START||u==k.CAP_ALL)&&(C.push(new p(0,n[0].y,0)),C.push(new p(Math.cos(g*x)*n[0].x*o,n[0].y,Math.sin(g*x)*n[0].x*o))),_=0;_<n.length;_++)b=new p(Math.cos(g*x)*n[_].x*o,n[_].y,Math.sin(g*x)*n[_].x*o),C.push(b);(u==k.CAP_END||u==k.CAP_ALL)&&(C.push(new p(Math.cos(g*x)*n[n.length-1].x*o,n[n.length-1].y,Math.sin(g*x)*n[n.length-1].x*o)),C.push(new p(0,n[n.length-1].y,0))),f.push(C)}return ua(s,{pathArray:f,closeArray:r,sideOrientation:h,updatable:c,invertUV:m,frontUVs:e.frontUVs,backUVs:e.backUVs},t)}k.CreateLathe=(s,e,t,i,r,n,o)=>SB(s,{shape:e,radius:t,tessellation:i,sideOrientation:o,updatable:n},r);function yB(s,e,t=null){let i=e.path,r=e.instance,n=1;e.radius!==void 0?n=e.radius:r&&(n=r._creationDataStorage.radius);let o=e.tessellation||64,a=e.radiusFunction||null,l=e.cap||k.NO_CAP,c=e.invertUV||!1,h=e.updatable,u=k._GetDefaultSideOrientation(e.sideOrientation);e.arc=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1;let d=(x,b,C,R,E,S,A,L)=>{let G=b.getTangents(),W=b.getNormals(),$=b.getDistances(),we=Math.PI*2/E*L,ce=S||(()=>R),ne,Fe,Oe,he,ee=O.Matrix[0],V=A===k.NO_CAP||A===k.CAP_END?0:2;for(let J=0;J<x.length;J++){Fe=ce(J,$[J]),ne=Array(),Oe=W[J];for(let Me=0;Me<E;Me++)N.RotationAxisToRef(G[J],we*Me,ee),he=ne[Me]?ne[Me]:p.Zero(),p.TransformCoordinatesToRef(Oe,ee,he),he.scaleInPlace(Fe).addInPlace(x[J]),ne[Me]=he;C[V]=ne,V++}let Y=(J,Me)=>{let Re=Array();for(let et=0;et<J;et++)Re.push(x[Me]);return Re};switch(A){case k.NO_CAP:break;case k.CAP_START:C[0]=Y(E,0),C[1]=C[2].slice(0);break;case k.CAP_END:C[V]=C[V-1].slice(0),C[V+1]=Y(E,x.length-1);break;case k.CAP_ALL:C[0]=Y(E,0),C[1]=C[2].slice(0),C[V]=C[V-1].slice(0),C[V+1]=Y(E,x.length-1);break;default:break}return C},f,m;if(r){let x=r._creationDataStorage,b=e.arc||x.arc;return f=x.path3D.update(i),m=d(i,f,x.pathArray,n,x.tessellation,a,x.cap,b),r=ua("",{pathArray:m,instance:r}),x.path3D=f,x.pathArray=m,x.arc=b,x.radius=n,r}f=new Yc(i);let g=new Array;l=l<0||l>3?0:l,m=d(i,f,g,n,o,a,l,e.arc);let _=ua(s,{pathArray:m,closePath:!0,closeArray:!1,updatable:h,sideOrientation:u,invertUV:c,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return _._creationDataStorage.pathArray=m,_._creationDataStorage.path3D=f,_._creationDataStorage.tessellation=o,_._creationDataStorage.cap=l,_._creationDataStorage.arc=e.arc,_._creationDataStorage.radius=n,_}k.CreateTube=(s,e,t,i,r,n,o,a,l,c)=>yB(s,{path:e,radius:t,tessellation:i,radiusFunction:r,arc:1,cap:n,updatable:a,sideOrientation:l,instance:c},o);function EB(s){let e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};let t=s.type&&(s.type<0||s.type>=e.length)?0:s.type||0,i=s.size,r=s.sizeX||i||1,n=s.sizeY||i||1,o=s.sizeZ||i||1,a=s.custom||e[t],l=a.face.length,c=s.faceUV||new Array(l),h=s.faceColors,u=s.flat===void 0?!0:s.flat,d=s.sideOrientation===0?0:s.sideOrientation||le.DEFAULTSIDE,f=[],m=[],g=[],_=[],x=[],b=0,C=0,R=[],E=0,S=0,A,L,G,W,$,re;if(u)for(S=0;S<l;S++)h&&h[S]===void 0&&(h[S]=new oe(1,1,1,1)),c&&c[S]===void 0&&(c[S]=new De(0,0,1,1));if(u)for(S=0;S<l;S++){let _e=a.face[S].length;for(G=2*Math.PI/_e,W=.5*Math.tan(G/2),$=.5,E=0;E<_e;E++)f.push(a.vertex[a.face[S][E]][0]*r,a.vertex[a.face[S][E]][1]*n,a.vertex[a.face[S][E]][2]*o),R.push(b),b++,A=c[S].x+(c[S].z-c[S].x)*(.5+W),L=c[S].y+(c[S].w-c[S].y)*($-.5),_.push(A,it.UseOpenGLOrientationForUV?1-L:L),re=W*Math.cos(G)-$*Math.sin(G),$=W*Math.sin(G)+$*Math.cos(G),W=re,h&&x.push(h[S].r,h[S].g,h[S].b,h[S].a);for(E=0;E<_e-2;E++)m.push(R[0+C],R[E+2+C],R[E+1+C]);C+=_e}else{for(E=0;E<a.vertex.length;E++)f.push(a.vertex[E][0]*r,a.vertex[E][1]*n,a.vertex[E][2]*o),_.push(0,it.UseOpenGLOrientationForUV?1:0);for(S=0;S<l;S++)for(E=0;E<a.face[S].length-2;E++)m.push(a.face[S][0],a.face[S][E+2],a.face[S][E+1])}le.ComputeNormals(f,m,g),le._ComputeSides(d,f,m,g,_,s.frontUVs,s.backUVs);let we=new le;return we.positions=f,we.indices=m,we.normals=g,we.uvs=_,h&&u&&(we.colors=x),we}function Iv(s,e={},t=null){let i=new k(s,t);return e.sideOrientation=k._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,EB(e).applyToMesh(i,e.updatable),i}le.CreatePolyhedron=EB;k.CreatePolyhedron=(s,e,t)=>Iv(s,e,t);var eY=new p(1,0,0),tY=new p(-1,0,0),iY=new p(0,1,0),rY=new p(0,-1,0),sY=new p(0,0,1),nY=new p(0,0,-1),Rv=class s{constructor(e=p.Zero(),t=p.Up(),i=j.Zero(),r=0,n=0,o=null,a=null,l=null,c=null){this.position=e,this.normal=t,this.uv=i,this.vertexIdx=r,this.vertexIdxForBones=n,this.localPositionOverride=o,this.localNormalOverride=a,this.matrixIndicesOverride=l,this.matrixWeightsOverride=c}clone(){return new s(this.position.clone(),this.normal.clone(),this.uv.clone(),this.vertexIdx,this.vertexIdxForBones,this.localPositionOverride?.slice(),this.localNormalOverride?.slice(),this.matrixIndicesOverride?.slice(),this.matrixWeightsOverride?.slice())}};function AB(s,e,t){let i=!!e.skeleton,r=t.localMode||i,n=e.getIndices(),o=i?e.getPositionData(!0,!0):e.getVerticesData(y.PositionKind),a=i?e.getNormalsData(!0,!0):e.getVerticesData(y.NormalKind),l=r?i?e.getVerticesData(y.PositionKind):o:null,c=r?i?e.getVerticesData(y.NormalKind):a:null,h=e.getVerticesData(y.UVKind),u=i?e.getVerticesData(y.MatricesIndicesKind):null,d=i?e.getVerticesData(y.MatricesWeightsKind):null,f=i?e.getVerticesData(y.MatricesIndicesExtraKind):null,m=i?e.getVerticesData(y.MatricesWeightsExtraKind):null,g=t.position||p.Zero(),_=t.normal||p.Up(),x=t.size||p.One(),b=t.angle||0;if(!_){let ne=new p(0,0,1),Fe=e.getScene().activeCamera,Oe=p.TransformCoordinates(ne,Fe.getWorldMatrix());_=Fe.globalPosition.subtract(Oe)}let C=-Math.atan2(_.z,_.x)-Math.PI/2,R=Math.sqrt(_.x*_.x+_.z*_.z),E=Math.atan2(_.y,R),S=new le;S.indices=[],S.positions=[],S.normals=[],S.uvs=[],S.matricesIndices=i?[]:null,S.matricesWeights=i?[]:null,S.matricesIndicesExtra=f?[]:null,S.matricesWeightsExtra=m?[]:null;let A=0,L=(ne,Fe)=>{let Oe=new Rv;if(!n||!o||!a)return Oe;let he=n[ne];if(Oe.vertexIdx=he*3,Oe.vertexIdxForBones=he*4,Oe.position=new p(o[he*3],o[he*3+1],o[he*3+2]),p.TransformCoordinatesToRef(Oe.position,Fe,Oe.position),Oe.normal=new p(a[he*3],a[he*3+1],a[he*3+2]),p.TransformNormalToRef(Oe.normal,Fe,Oe.normal),t.captureUVS&&h){let ee=h[he*2+1];Oe.uv=new j(h[he*2],it.UseOpenGLOrientationForUV?1-ee:ee)}return Oe},G=[0,0,0,0],W=(ne,Fe)=>{if(ne.length===0)return ne;let Oe=.5*Math.abs(p.Dot(x,Fe)),he=(Y,J,Me,Re)=>{for(let et=0;et<Re;++et)if(Y[Me+et]===J)return Me+et;return-1},ee=(Y,J)=>{let Me=p.GetClipFactor(Y.position,J.position,Fe,Oe),Re=G,et=G;if(u&&d){let wf=Y.matrixIndicesOverride?0:Y.vertexIdxForBones,VS=Y.matrixIndicesOverride??u,TO=Y.matrixWeightsOverride??d,US=J.matrixIndicesOverride?0:J.vertexIdxForBones,CO=J.matrixIndicesOverride??u,bO=J.matrixWeightsOverride??d;Re=[0,0,0,0],et=[0,0,0,0];let vc=0;for(let ro=0;ro<4;++ro)if(TO[wf+ro]>0){let Nf=he(CO,VS[wf+ro],US,4);Re[vc]=VS[wf+ro],et[vc]=xe.Lerp(TO[wf+ro],Nf>=0?bO[Nf]:0,Me),vc++}for(let ro=0;ro<4&&vc<4;++ro){let Nf=CO[US+ro];he(VS,Nf,wf,4)===-1&&(Re[vc]=Nf,et[vc]=xe.Lerp(0,bO[US+ro],Me),vc++)}let Tg=et[0]+et[1]+et[2]+et[3];et[0]/=Tg,et[1]/=Tg,et[2]/=Tg,et[3]/=Tg}let Tt=Y.localPositionOverride?Y.localPositionOverride[0]:l?.[Y.vertexIdx]??0,Yt=Y.localPositionOverride?Y.localPositionOverride[1]:l?.[Y.vertexIdx+1]??0,si=Y.localPositionOverride?Y.localPositionOverride[2]:l?.[Y.vertexIdx+2]??0,Er=J.localPositionOverride?J.localPositionOverride[0]:l?.[J.vertexIdx]??0,Xi=J.localPositionOverride?J.localPositionOverride[1]:l?.[J.vertexIdx+1]??0,Ie=J.localPositionOverride?J.localPositionOverride[2]:l?.[J.vertexIdx+2]??0,st=Y.localNormalOverride?Y.localNormalOverride[0]:c?.[Y.vertexIdx]??0,vi=Y.localNormalOverride?Y.localNormalOverride[1]:c?.[Y.vertexIdx+1]??0,sr=Y.localNormalOverride?Y.localNormalOverride[2]:c?.[Y.vertexIdx+2]??0,Ar=J.localNormalOverride?J.localNormalOverride[0]:c?.[J.vertexIdx]??0,cu=J.localNormalOverride?J.localNormalOverride[1]:c?.[J.vertexIdx+1]??0,Cl=J.localNormalOverride?J.localNormalOverride[2]:c?.[J.vertexIdx+2]??0,hu=st+(Ar-st)*Me,uu=vi+(cu-vi)*Me,du=sr+(Cl-sr)*Me,fu=Math.sqrt(hu*hu+uu*uu+du*du);return new Rv(p.Lerp(Y.position,J.position,Me),p.Lerp(Y.normal,J.normal,Me).normalize(),j.Lerp(Y.uv,J.uv,Me),-1,-1,l?[Tt+(Er-Tt)*Me,Yt+(Xi-Yt)*Me,si+(Ie-si)*Me]:null,c?[hu/fu,uu/fu,du/fu]:null,Re,et)},V=null;ne.length>3&&(V=[]);for(let Y=0;Y<ne.length;Y+=3){let J=0,Me=null,Re=null,et=null,Tt=null,Yt=p.Dot(ne[Y].position,Fe)-Oe,si=p.Dot(ne[Y+1].position,Fe)-Oe,Er=p.Dot(ne[Y+2].position,Fe)-Oe,Xi=Yt>0,Ie=si>0,st=Er>0;switch(J=(Xi?1:0)+(Ie?1:0)+(st?1:0),J){case 0:ne.length>3?(V.push(ne[Y]),V.push(ne[Y+1]),V.push(ne[Y+2])):V=ne;break;case 1:if(V=V??new Array,Xi&&(Me=ne[Y+1],Re=ne[Y+2],et=ee(ne[Y],Me),Tt=ee(ne[Y],Re)),Ie){Me=ne[Y],Re=ne[Y+2],et=ee(ne[Y+1],Me),Tt=ee(ne[Y+1],Re),V.push(et),V.push(Re.clone()),V.push(Me.clone()),V.push(Re.clone()),V.push(et.clone()),V.push(Tt);break}st&&(Me=ne[Y],Re=ne[Y+1],et=ee(ne[Y+2],Me),Tt=ee(ne[Y+2],Re)),Me&&Re&&et&&Tt&&(V.push(Me.clone()),V.push(Re.clone()),V.push(et),V.push(Tt),V.push(et.clone()),V.push(Re.clone()));break;case 2:V=V??new Array,Xi||(Me=ne[Y].clone(),Re=ee(Me,ne[Y+1]),et=ee(Me,ne[Y+2]),V.push(Me),V.push(Re),V.push(et)),Ie||(Me=ne[Y+1].clone(),Re=ee(Me,ne[Y+2]),et=ee(Me,ne[Y]),V.push(Me),V.push(Re),V.push(et)),st||(Me=ne[Y+2].clone(),Re=ee(Me,ne[Y]),et=ee(Me,ne[Y+1]),V.push(Me),V.push(Re),V.push(et));break;case 3:break}}return V},$=e instanceof k?e:null,re=$?._thinInstanceDataStorage.matrixData,we=$?.thinInstanceCount||1,_e=O.Matrix[0];_e.copyFrom(N.IdentityReadOnly);for(let ne=0;ne<we;++ne){if($?.hasThinInstances&&re){let Y=ne*16;_e.setRowFromFloats(0,re[Y+0],re[Y+1],re[Y+2],re[Y+3]),_e.setRowFromFloats(1,re[Y+4],re[Y+5],re[Y+6],re[Y+7]),_e.setRowFromFloats(2,re[Y+8],re[Y+9],re[Y+10],re[Y+11]),_e.setRowFromFloats(3,re[Y+12],re[Y+13],re[Y+14],re[Y+15])}let Fe=N.RotationYawPitchRoll(C,E,b).multiply(N.Translation(g.x,g.y,g.z)),Oe=N.Invert(Fe),he=e.getWorldMatrix(),ee=_e.multiply(he).multiply(Oe),V=new Array(3);for(let Y=0;Y<n.length;Y+=3){let J=V;if(J[0]=L(Y,ee),r?(J[1]=L(Y+2,ee),J[2]=L(Y+1,ee)):(J[1]=L(Y+1,ee),J[2]=L(Y+2,ee)),!(t.cullBackFaces&&-J[0].normal.z<=0&&-J[1].normal.z<=0&&-J[2].normal.z<=0)&&(J=W(J,eY),!!J&&(J=W(J,tY),!!J&&(J=W(J,iY),!!J&&(J=W(J,rY),!!J&&(J=W(J,sY),!!J&&(J=W(J,nY),!!J)))))))for(let Me=0;Me<J.length;Me++){let Re=J[Me];if(S.indices.push(A),r?(Re.localPositionOverride?(S.positions[A*3]=Re.localPositionOverride[0],S.positions[A*3+1]=Re.localPositionOverride[1],S.positions[A*3+2]=Re.localPositionOverride[2]):l&&(S.positions[A*3]=l[Re.vertexIdx],S.positions[A*3+1]=l[Re.vertexIdx+1],S.positions[A*3+2]=l[Re.vertexIdx+2]),Re.localNormalOverride?(S.normals[A*3]=Re.localNormalOverride[0],S.normals[A*3+1]=Re.localNormalOverride[1],S.normals[A*3+2]=Re.localNormalOverride[2]):c&&(S.normals[A*3]=c[Re.vertexIdx],S.normals[A*3+1]=c[Re.vertexIdx+1],S.normals[A*3+2]=c[Re.vertexIdx+2])):(Re.position.toArray(S.positions,A*3),Re.normal.toArray(S.normals,A*3)),S.matricesIndices&&S.matricesWeights&&(Re.matrixIndicesOverride?(S.matricesIndices[A*4]=Re.matrixIndicesOverride[0],S.matricesIndices[A*4+1]=Re.matrixIndicesOverride[1],S.matricesIndices[A*4+2]=Re.matrixIndicesOverride[2],S.matricesIndices[A*4+3]=Re.matrixIndicesOverride[3]):(u&&(S.matricesIndices[A*4]=u[Re.vertexIdxForBones],S.matricesIndices[A*4+1]=u[Re.vertexIdxForBones+1],S.matricesIndices[A*4+2]=u[Re.vertexIdxForBones+2],S.matricesIndices[A*4+3]=u[Re.vertexIdxForBones+3]),f&&S.matricesIndicesExtra&&(S.matricesIndicesExtra[A*4]=f[Re.vertexIdxForBones],S.matricesIndicesExtra[A*4+1]=f[Re.vertexIdxForBones+1],S.matricesIndicesExtra[A*4+2]=f[Re.vertexIdxForBones+2],S.matricesIndicesExtra[A*4+3]=f[Re.vertexIdxForBones+3])),Re.matrixWeightsOverride?(S.matricesWeights[A*4]=Re.matrixWeightsOverride[0],S.matricesWeights[A*4+1]=Re.matrixWeightsOverride[1],S.matricesWeights[A*4+2]=Re.matrixWeightsOverride[2],S.matricesWeights[A*4+3]=Re.matrixWeightsOverride[3]):(d&&(S.matricesWeights[A*4]=d[Re.vertexIdxForBones],S.matricesWeights[A*4+1]=d[Re.vertexIdxForBones+1],S.matricesWeights[A*4+2]=d[Re.vertexIdxForBones+2],S.matricesWeights[A*4+3]=d[Re.vertexIdxForBones+3]),m&&S.matricesWeightsExtra&&(S.matricesWeightsExtra[A*4]=m[Re.vertexIdxForBones],S.matricesWeightsExtra[A*4+1]=m[Re.vertexIdxForBones+1],S.matricesWeightsExtra[A*4+2]=m[Re.vertexIdxForBones+2],S.matricesWeightsExtra[A*4+3]=m[Re.vertexIdxForBones+3]))),t.captureUVS)Re.uv.toArray(S.uvs,A*2);else{S.uvs.push(.5+Re.position.x/x.x);let et=.5+Re.position.y/x.y;S.uvs.push(it.UseOpenGLOrientationForUV?1-et:et)}A++}}}S.indices.length===0&&(S.indices=null),S.positions.length===0&&(S.positions=null),S.normals.length===0&&(S.normals=null),S.uvs.length===0&&(S.uvs=null),S.matricesIndices?.length===0&&(S.matricesIndices=null),S.matricesWeights?.length===0&&(S.matricesWeights=null),S.matricesIndicesExtra?.length===0&&(S.matricesIndicesExtra=null),S.matricesWeightsExtra?.length===0&&(S.matricesWeightsExtra=null);let ce=new k(s,e.getScene());return S.applyToMesh(ce),r?(ce.skeleton=e.skeleton,ce.parent=e):(ce.position=g.clone(),ce.rotation=new p(E,C,b)),ce.computeWorldMatrix(!0),ce.refreshBoundingInfo(!0,!0),ce}k.CreateDecal=(s,e,t,i,r,n)=>AB(s,e,{position:t,normal:i,size:r,angle:n});k._GoldbergMeshParser=(s,e)=>Pv.Parse(s,e);var Pv=class s extends k{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return t===void 0?(e>this.goldbergData.nbUnsharedFaces-1&&(F.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(F.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(F.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let i=0;i<e.length;i++){let r=e[i][0],n=e[i][1],o=e[i][2];for(let a=r;a<n+1;a++)this.goldbergData.faceColors[a]=o}let t=[];for(let i=0;i<12;i++)for(let r=0;r<5;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);for(let i=12;i<this.goldbergData.faceColors.length;i++)for(let r=0;r<6;r++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);return t}setGoldbergFaceColors(e){let t=this._changeGoldbergFaceColors(e);this.setVerticesData(y.ColorKind,t)}updateGoldbergFaceColors(e){let t=this._changeGoldbergFaceColors(e);this.updateVerticesData(y.ColorKind,t)}_changeGoldbergFaceUVs(e){let t=this.getVerticesData(y.UVKind);for(let i=0;i<e.length;i++){let r=e[i][0],n=e[i][1],o=e[i][2],a=e[i][3],l=e[i][4],c=[],h=[],u,d;for(let f=0;f<5;f++)u=o.x+a*Math.cos(l+f*Math.PI/2.5),d=o.y+a*Math.sin(l+f*Math.PI/2.5),u<0&&(u=0),u>1&&(u=1),c.push(u,d);for(let f=0;f<6;f++)u=o.x+a*Math.cos(l+f*Math.PI/3),d=o.y+a*Math.sin(l+f*Math.PI/3),u<0&&(u=0),u>1&&(u=1),h.push(u,d);for(let f=r;f<Math.min(12,n+1);f++)for(let m=0;m<5;m++)t[10*f+2*m]=c[2*m],t[10*f+2*m+1]=c[2*m+1];for(let f=Math.max(12,r);f<n+1;f++)for(let m=0;m<6;m++)t[12*f-24+2*m]=h[2*m],t[12*f-23+2*m]=h[2*m+1]}return t}setGoldbergFaceUVs(e){let t=this._changeGoldbergFaceUVs(e);this.setVerticesData(y.UVKind,t)}updateGoldbergFaceUVs(e){let t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(y.UVKind,t)}placeOnGoldbergFaceAt(e,t,i){let r=p.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=r,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(i.x)).add(this.goldbergData.faceYaxis[t].scale(i.y)).add(this.goldbergData.faceZaxis[t].scale(i.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";let t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(let i of this.goldbergData.faceColors)t.faceColors.push(i.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(let i of this.goldbergData.faceCenters)t.faceCenters.push(i.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(let i of this.goldbergData.faceZaxis)t.faceZaxis.push(i.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(let i of this.goldbergData.faceYaxis)t.faceYaxis.push(i.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(let i of this.goldbergData.faceXaxis)t.faceXaxis.push(i.asArray())}e.goldbergData=t}static Parse(e,t){let i=e.goldbergData;i.faceColors=i.faceColors.map(n=>oe.FromArray(n)),i.faceCenters=i.faceCenters.map(n=>p.FromArray(n)),i.faceZaxis=i.faceZaxis.map(n=>p.FromArray(n)),i.faceXaxis=i.faceXaxis.map(n=>p.FromArray(n)),i.faceYaxis=i.faceYaxis.map(n=>p.FromArray(n));let r=new s(e.name,t);return r.goldbergData=i,r}};var i0=class{constructor(e){this._paths=[],this._tempPaths=[],this._holes=[],this._resolution=e}moveTo(e,t){this._currentPath=new ld(e,t),this._tempPaths.push(this._currentPath)}lineTo(e,t){this._currentPath.addLineTo(e,t)}quadraticCurveTo(e,t,i,r){this._currentPath.addQuadraticCurveTo(e,t,i,r,this._resolution)}bezierCurveTo(e,t,i,r,n,o){this._currentPath.addBezierCurveTo(e,t,i,r,n,o,this._resolution)}extractHoles(){for(let e of this._tempPaths)e.area()>0?this._holes.push(e):this._paths.push(e);if(!this._paths.length&&this._holes.length){let e=this._holes;this._holes=this._paths,this._paths=e}this._tempPaths.length=0}get paths(){return this._paths}get holes(){return this._holes}};function lY(s,e,t,i,r,n){let o=n.glyphs[s]||n.glyphs["?"];if(!o)return null;let a=new i0(r);if(o.o){let l=o.o.split(" ");for(let c=0,h=l.length;c<h;)switch(l[c++]){case"m":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+i;a.moveTo(d,f);break}case"l":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+i;a.lineTo(d,f);break}case"q":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+i,m=parseInt(l[c++])*e+t,g=parseInt(l[c++])*e+i;a.quadraticCurveTo(m,g,d,f);break}case"b":{let d=parseInt(l[c++])*e+t,f=parseInt(l[c++])*e+i,m=parseInt(l[c++])*e+t,g=parseInt(l[c++])*e+i,_=parseInt(l[c++])*e+t,x=parseInt(l[c++])*e+i;a.bezierCurveTo(m,g,_,x,d,f);break}}}return a.extractHoles(),{offsetX:o.ha*e,shapePath:a}}function IB(s,e,t,i){let r=Array.from(s),n=e/i.resolution,o=(i.boundingBox.yMax-i.boundingBox.yMin+i.underlineThickness)*n,a=[],l=0,c=0;for(let h=0;h<r.length;h++){let u=r[h];if(u===`
`)l=0,c-=o;else{let d=lY(u,n,l,c,t,i);d&&(l+=d.offsetX,a.push(d.shapePath))}}return a}var Za=(()=>{class s{}return s.AUTOSAMPLERSUFFIX="Sampler",s.DISABLEUA="#define DISABLE_UNIFORMITY_ANALYSIS",s.ALPHA_DISABLE=0,s.ALPHA_ADD=1,s.ALPHA_COMBINE=2,s.ALPHA_SUBTRACT=3,s.ALPHA_MULTIPLY=4,s.ALPHA_MAXIMIZED=5,s.ALPHA_ONEONE=6,s.ALPHA_PREMULTIPLIED=7,s.ALPHA_PREMULTIPLIED_PORTERDUFF=8,s.ALPHA_INTERPOLATE=9,s.ALPHA_SCREENMODE=10,s.ALPHA_ONEONE_ONEONE=11,s.ALPHA_ALPHATOCOLOR=12,s.ALPHA_REVERSEONEMINUS=13,s.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,s.ALPHA_ONEONE_ONEZERO=15,s.ALPHA_EXCLUSION=16,s.ALPHA_LAYER_ACCUMULATE=17,s.ALPHA_EQUATION_ADD=0,s.ALPHA_EQUATION_SUBSTRACT=1,s.ALPHA_EQUATION_REVERSE_SUBTRACT=2,s.ALPHA_EQUATION_MAX=3,s.ALPHA_EQUATION_MIN=4,s.ALPHA_EQUATION_DARKEN=5,s.DELAYLOADSTATE_NONE=0,s.DELAYLOADSTATE_LOADED=1,s.DELAYLOADSTATE_LOADING=2,s.DELAYLOADSTATE_NOTLOADED=4,s.NEVER=512,s.ALWAYS=519,s.LESS=513,s.EQUAL=514,s.LEQUAL=515,s.GREATER=516,s.GEQUAL=518,s.NOTEQUAL=517,s.KEEP=7680,s.ZERO=0,s.REPLACE=7681,s.INCR=7682,s.DECR=7683,s.INVERT=5386,s.INCR_WRAP=34055,s.DECR_WRAP=34056,s.TEXTURE_CLAMP_ADDRESSMODE=0,s.TEXTURE_WRAP_ADDRESSMODE=1,s.TEXTURE_MIRROR_ADDRESSMODE=2,s.TEXTURE_CREATIONFLAG_STORAGE=1,s.TEXTUREFORMAT_ALPHA=0,s.TEXTUREFORMAT_LUMINANCE=1,s.TEXTUREFORMAT_LUMINANCE_ALPHA=2,s.TEXTUREFORMAT_RGB=4,s.TEXTUREFORMAT_RGBA=5,s.TEXTUREFORMAT_RED=6,s.TEXTUREFORMAT_R=6,s.TEXTUREFORMAT_RG=7,s.TEXTUREFORMAT_RED_INTEGER=8,s.TEXTUREFORMAT_R_INTEGER=8,s.TEXTUREFORMAT_RG_INTEGER=9,s.TEXTUREFORMAT_RGB_INTEGER=10,s.TEXTUREFORMAT_RGBA_INTEGER=11,s.TEXTUREFORMAT_BGRA=12,s.TEXTUREFORMAT_DEPTH24_STENCIL8=13,s.TEXTUREFORMAT_DEPTH32_FLOAT=14,s.TEXTUREFORMAT_DEPTH16=15,s.TEXTUREFORMAT_DEPTH24=16,s.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,s.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,s.TEXTUREFORMAT_STENCIL8=19,s.TEXTUREFORMAT_UNDEFINED=4294967295,s.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,s.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,s.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,s.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,s.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,s.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,s.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,s.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,s.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,s.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,s.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,s.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,s.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,s.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,s.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,s.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,s.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,s.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,s.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,s.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,s.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,s.TEXTURETYPE_UNSIGNED_BYTE=0,s.TEXTURETYPE_UNSIGNED_INT=0,s.TEXTURETYPE_FLOAT=1,s.TEXTURETYPE_HALF_FLOAT=2,s.TEXTURETYPE_BYTE=3,s.TEXTURETYPE_SHORT=4,s.TEXTURETYPE_UNSIGNED_SHORT=5,s.TEXTURETYPE_INT=6,s.TEXTURETYPE_UNSIGNED_INTEGER=7,s.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,s.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,s.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,s.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,s.TEXTURETYPE_UNSIGNED_INT_24_8=12,s.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,s.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,s.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,s.TEXTURETYPE_UNDEFINED=16,s.TEXTURE_2D=3553,s.TEXTURE_2D_ARRAY=35866,s.TEXTURE_CUBE_MAP=34067,s.TEXTURE_CUBE_MAP_ARRAY=3735928559,s.TEXTURE_3D=32879,s.TEXTURE_NEAREST_SAMPLINGMODE=1,s.TEXTURE_NEAREST_NEAREST=1,s.TEXTURE_BILINEAR_SAMPLINGMODE=2,s.TEXTURE_LINEAR_LINEAR=2,s.TEXTURE_TRILINEAR_SAMPLINGMODE=3,s.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,s.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,s.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,s.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,s.TEXTURE_NEAREST_LINEAR=7,s.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,s.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,s.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,s.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,s.TEXTURE_LINEAR_NEAREST=12,s.TEXTURE_EXPLICIT_MODE=0,s.TEXTURE_SPHERICAL_MODE=1,s.TEXTURE_PLANAR_MODE=2,s.TEXTURE_CUBIC_MODE=3,s.TEXTURE_PROJECTION_MODE=4,s.TEXTURE_SKYBOX_MODE=5,s.TEXTURE_INVCUBIC_MODE=6,s.TEXTURE_EQUIRECTANGULAR_MODE=7,s.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,s.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,s.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,s.TEXTURE_FILTERING_QUALITY_HIGH=64,s.TEXTURE_FILTERING_QUALITY_MEDIUM=16,s.TEXTURE_FILTERING_QUALITY_LOW=8,s.SCALEMODE_FLOOR=1,s.SCALEMODE_NEAREST=2,s.SCALEMODE_CEILING=3,s.MATERIAL_TextureDirtyFlag=1,s.MATERIAL_LightDirtyFlag=2,s.MATERIAL_FresnelDirtyFlag=4,s.MATERIAL_AttributesDirtyFlag=8,s.MATERIAL_MiscDirtyFlag=16,s.MATERIAL_PrePassDirtyFlag=32,s.MATERIAL_AllDirtyFlag=63,s.MATERIAL_TriangleFillMode=0,s.MATERIAL_WireFrameFillMode=1,s.MATERIAL_PointFillMode=2,s.MATERIAL_PointListDrawMode=3,s.MATERIAL_LineListDrawMode=4,s.MATERIAL_LineLoopDrawMode=5,s.MATERIAL_LineStripDrawMode=6,s.MATERIAL_TriangleStripDrawMode=7,s.MATERIAL_TriangleFanDrawMode=8,s.MATERIAL_ClockWiseSideOrientation=0,s.MATERIAL_CounterClockWiseSideOrientation=1,s.ACTION_NothingTrigger=0,s.ACTION_OnPickTrigger=1,s.ACTION_OnLeftPickTrigger=2,s.ACTION_OnRightPickTrigger=3,s.ACTION_OnCenterPickTrigger=4,s.ACTION_OnPickDownTrigger=5,s.ACTION_OnDoublePickTrigger=6,s.ACTION_OnPickUpTrigger=7,s.ACTION_OnPickOutTrigger=16,s.ACTION_OnLongPressTrigger=8,s.ACTION_OnPointerOverTrigger=9,s.ACTION_OnPointerOutTrigger=10,s.ACTION_OnEveryFrameTrigger=11,s.ACTION_OnIntersectionEnterTrigger=12,s.ACTION_OnIntersectionExitTrigger=13,s.ACTION_OnKeyDownTrigger=14,s.ACTION_OnKeyUpTrigger=15,s.PARTICLES_BILLBOARDMODE_Y=2,s.PARTICLES_BILLBOARDMODE_ALL=7,s.PARTICLES_BILLBOARDMODE_STRETCHED=8,s.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,s.MESHES_CULLINGSTRATEGY_STANDARD=0,s.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,s.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,s.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,s.SCENELOADER_NO_LOGGING=0,s.SCENELOADER_MINIMAL_LOGGING=1,s.SCENELOADER_SUMMARY_LOGGING=2,s.SCENELOADER_DETAILED_LOGGING=3,s.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,s.PREPASS_POSITION_TEXTURE_TYPE=1,s.PREPASS_VELOCITY_TEXTURE_TYPE=2,s.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,s.PREPASS_COLOR_TEXTURE_TYPE=4,s.PREPASS_DEPTH_TEXTURE_TYPE=5,s.PREPASS_NORMAL_TEXTURE_TYPE=6,s.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,s.BUFFER_CREATIONFLAG_READ=1,s.BUFFER_CREATIONFLAG_WRITE=2,s.BUFFER_CREATIONFLAG_READWRITE=3,s.BUFFER_CREATIONFLAG_UNIFORM=4,s.BUFFER_CREATIONFLAG_VERTEX=8,s.BUFFER_CREATIONFLAG_INDEX=16,s.BUFFER_CREATIONFLAG_STORAGE=32,s.BUFFER_CREATIONFLAG_INDIRECT=64,s.RENDERPASS_MAIN=0,s.INPUT_ALT_KEY=18,s.INPUT_CTRL_KEY=17,s.INPUT_META_KEY1=91,s.INPUT_META_KEY2=92,s.INPUT_META_KEY3=93,s.INPUT_SHIFT_KEY=16,s.SNAPSHOTRENDERING_STANDARD=0,s.SNAPSHOTRENDERING_FAST=1,s.PERSPECTIVE_CAMERA=0,s.ORTHOGRAPHIC_CAMERA=1,s.FOVMODE_VERTICAL_FIXED=0,s.FOVMODE_HORIZONTAL_FIXED=1,s.RIG_MODE_NONE=0,s.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,s.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,s.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,s.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,s.RIG_MODE_STEREOSCOPIC_INTERLACED=14,s.RIG_MODE_VR=20,s.RIG_MODE_CUSTOM=22,s.MAX_SUPPORTED_UV_SETS=6,s.GL_ALPHA_EQUATION_ADD=32774,s.GL_ALPHA_EQUATION_MIN=32775,s.GL_ALPHA_EQUATION_MAX=32776,s.GL_ALPHA_EQUATION_SUBTRACT=32778,s.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,s.GL_ALPHA_FUNCTION_SRC=768,s.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,s.GL_ALPHA_FUNCTION_SRC_ALPHA=770,s.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,s.GL_ALPHA_FUNCTION_DST_ALPHA=772,s.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,s.GL_ALPHA_FUNCTION_DST_COLOR=774,s.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,s.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,s.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,s.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,s.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,s.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,s.SnippetUrl="https://snippet.babylonjs.com",s.FOGMODE_NONE=0,s.FOGMODE_EXP=1,s.FOGMODE_EXP2=2,s.FOGMODE_LINEAR=3,s.BYTE=5120,s.UNSIGNED_BYTE=5121,s.SHORT=5122,s.UNSIGNED_SHORT=5123,s.INT=5124,s.UNSIGNED_INT=5125,s.FLOAT=5126,s.PositionKind="position",s.NormalKind="normal",s.TangentKind="tangent",s.UVKind="uv",s.UV2Kind="uv2",s.UV3Kind="uv3",s.UV4Kind="uv4",s.UV5Kind="uv5",s.UV6Kind="uv6",s.ColorKind="color",s.ColorInstanceKind="instanceColor",s.MatricesIndicesKind="matricesIndices",s.MatricesWeightsKind="matricesWeights",s.MatricesIndicesExtraKind="matricesIndicesExtra",s.MatricesWeightsExtraKind="matricesWeightsExtra",s})();Se.prototype._partialLoadFile=function(s,e,t,i,r=null){let n=a=>{t[e]=a,t._internalCount++,t._internalCount===6&&i(t)},o=(a,l)=>{r&&a&&r(a.status+" "+a.statusText,l)};this._loadFile(s,n,void 0,void 0,!0,o)};Se.prototype._cascadeLoadFiles=function(s,e,t,i=null){let r=[];r._internalCount=0;for(let n=0;n<6;n++)this._partialLoadFile(t[n],n,r,e,i)};Se.prototype._cascadeLoadImgs=function(s,e,t,i,r=null,n){let o=[];o._internalCount=0;for(let a=0;a<6;a++)this._partialLoadImg(i[a],a,o,s,e,t,r,n)};Se.prototype._partialLoadImg=function(s,e,t,i,r,n,o=null,a){let l=ts();zS(s,u=>{t[e]=u,t._internalCount++,i&&i.removePendingData(l),t._internalCount===6&&n&&n(r,t)},(u,d)=>{i&&i.removePendingData(l),o&&o(u,d)},i?i.offlineProvider:null,a),i&&i.addPendingData(l)};Se.prototype.createCubeTextureBase=function(s,e,t,i,r=null,n=null,o,a=null,l=!1,c=0,h=0,u=null,d=null,f=null,m=!1,g=null){let _=u||new Je(this,ke.Cube);_.isCube=!0,_.url=s,_.generateMipMaps=!i,_._lodGenerationScale=c,_._lodGenerationOffset=h,_._useSRGBBuffer=!!m&&this._caps.supportSRGBBuffers&&(this.version>1||this.isWebGPU||!!i),_!==u&&(_.label=s.substring(0,60)),this._doNotHandleContextLost||(_._extension=a,_._files=t,_._buffer=g);let x=s;this._transformTextureUrl&&!u&&(s=this._transformTextureUrl(s));let b=s.split("?")[0],C=b.lastIndexOf("."),R=a||(C>-1?b.substring(C).toLowerCase():""),E=null;for(let A of Se._TextureLoaders)if(A.canLoad(R)){E=A;break}let S=(A,L)=>{s===x?n&&A&&n(A.status+" "+A.statusText,L):(F.Warn(`Failed to load ${s}, falling back to the ${x}`),this.createCubeTextureBase(x,e,t,!!i,r,n,o,a,l,c,h,_,d,f,m,g))};if(E){let A=L=>{d&&d(_,L),E.loadCubeData(L,_,l,r,n)};g?A(g):t&&t.length===6?E.supportCascades?this._cascadeLoadFiles(e,L=>A(L.map(G=>new Uint8Array(G))),t,n):n?n("Textures type does not support cascades."):F.Warn("Texture loader does not support cascades."):this._loadFile(s,L=>A(new Uint8Array(L)),void 0,void 0,!0,S)}else{if(!t||t.length===0)throw new Error("Cannot load cubemap because files were not defined, or the correct loader was not found.");this._cascadeLoadImgs(e,_,(A,L)=>{f&&f(A,L)},t,n)}return this._internalTexturesCache.push(_),_};var r0=class{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=lt.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=lt.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}};Se.prototype.getGPUFrameTimeCounter=function(){return null};Se.prototype.captureGPUFrameTime=function(s){};Se.prototype.createQuery=function(){return null};Se.prototype.deleteQuery=function(s){return this};Se.prototype.isQueryResultAvailable=function(s){return!1};Se.prototype.getQueryResult=function(s){return 0};Se.prototype.beginOcclusionQuery=function(s,e){return!1};Se.prototype.endOcclusionQuery=function(s){return this};Object.defineProperty(lt.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(s){this._occlusionDataStorage.isOcclusionQueryInProgress=s},enumerable:!1,configurable:!0});Object.defineProperty(lt.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new r0),this.__occlusionDataStorage},enumerable:!1,configurable:!0});Object.defineProperty(lt.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(s){this._occlusionDataStorage.isOccluded=s},enumerable:!0,configurable:!0});Object.defineProperty(lt.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(s){this._occlusionDataStorage.occlusionQueryAlgorithmType=s},enumerable:!0,configurable:!0});Object.defineProperty(lt.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(s){this._occlusionDataStorage.occlusionType=s},enumerable:!0,configurable:!0});Object.defineProperty(lt.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(s){this._occlusionDataStorage.occlusionRetryCount=s},enumerable:!0,configurable:!0});Object.defineProperty(lt.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(s){this._occlusionDataStorage.forceRenderingWhenOccluded=s},enumerable:!0,configurable:!0});lt.prototype._checkOcclusionQuery=function(){let s=this._occlusionDataStorage;if(s.occlusionType===lt.OCCLUSION_TYPE_NONE)return s.isOccluded=!1,!1;let e=this.getEngine();if(!e.getCaps().supportOcclusionQuery||!e.isQueryResultAvailable)return s.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery!==null&&this._occlusionQuery!==void 0)if(e.isQueryResultAvailable(this._occlusionQuery)){let r=e.getQueryResult(this._occlusionQuery);s.isOcclusionQueryInProgress=!1,s.occlusionInternalRetryCounter=0,s.isOccluded=!(r>0)}else if(s.occlusionInternalRetryCounter++,s.occlusionRetryCount!==-1&&s.occlusionInternalRetryCounter>s.occlusionRetryCount)s.isOcclusionQueryInProgress=!1,s.occlusionInternalRetryCounter=0,s.isOccluded=s.occlusionType===lt.OCCLUSION_TYPE_OPTIMISTIC?!1:s.isOccluded;else return s.occlusionType===lt.OCCLUSION_TYPE_OPTIMISTIC?!1:s.isOccluded;let t=this.getScene();if(t.getBoundingBoxRenderer){let i=t.getBoundingBoxRenderer();this._occlusionQuery===null&&(this._occlusionQuery=e.createQuery()),this._occlusionQuery&&e.beginOcclusionQuery(s.occlusionQueryAlgorithmType,this._occlusionQuery)&&(i.renderOcclusionBoundingBox(this),e.endOcclusionQuery(s.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return s.isOccluded};var RB=new U,PB=new U;Object.defineProperty(Se.prototype,"onBeforeViewRenderObservable",{get:function(){return RB}});Object.defineProperty(Se.prototype,"onAfterViewRenderObservable",{get:function(){return PB}});Object.defineProperty(Se.prototype,"inputElement",{get:function(){return this._inputElement},set:function(s){this._inputElement!==s&&(this._inputElement=s,this._onEngineViewChanged?.())}});Se.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()};Se.prototype.registerView=function(s,e,t){this.views||(this.views=[]);for(let n of this.views)if(n.target===s)return n;let i=this.getRenderingCanvas();i&&(s.width=i.width,s.height=i.height);let r={target:s,camera:e,clearBeforeCopy:t,enabled:!0,id:(Math.random()*1e5).toFixed()};return this.views.push(r),e&&!Array.isArray(e)&&e.onDisposeObservable.add(()=>{this.unRegisterView(s)}),r};Se.prototype.unRegisterView=function(s){if(!this.views||this.views.length===0)return this;for(let e of this.views)if(e.target===s){let t=this.views.indexOf(e);t!==-1&&this.views.splice(t,1);break}return this};Se.prototype._renderViewStep=function(s){let e=s.target,t=e.getContext("2d");if(!t)return!0;let i=this.getRenderingCanvas();RB.notifyObservers(s);let r=s.camera,n=null,o=null,a=null;if(r&&(a=Array.isArray(r)?r[0].getScene():r.getScene(),n=a.activeCamera,o=a.activeCameras,this.activeView=s,Array.isArray(r)?a.activeCameras=r:(a.activeCamera=r,a.activeCameras=null)),s.customResize)s.customResize(e);else{let l=Math.floor(e.clientWidth/this._hardwareScalingLevel),c=Math.floor(e.clientHeight/this._hardwareScalingLevel),h=l!==e.width||i.width!==e.width||c!==e.height||i.height!==e.height;e.clientWidth&&e.clientHeight&&h&&(e.width=l,e.height=c,this.setSize(l,c))}return!i.width||!i.height?!1:(this._renderFrame(),this.flushFramebuffer(),s.clearBeforeCopy&&t.clearRect(0,0,i.width,i.height),t.drawImage(i,0,0),a&&(a.activeCameras=o,a.activeCamera=n),PB.notifyObservers(s),!0)};Se.prototype._renderViews=function(){if(!this.views||this.views.length===0||!this.getRenderingCanvas())return!1;let e;for(let t of this.views){if(!t.enabled)continue;if(t.target===this.inputElement){e=t;continue}if(!this._renderViewStep(t))return!1}return e&&!this._renderViewStep(e)?!1:(this.activeView=null,!0)};Se.prototype._debugPushGroup=function(s,e){};Se.prototype._debugPopGroup=function(s){};Se.prototype._debugInsertMarker=function(s,e){};Se.prototype._debugFlushPendingCommands=function(){};var Mv=class{constructor(){this._timeElapsedQueryEnded=!1}};K.prototype.createQuery=function(){let s=this._gl.createQuery();if(!s)throw new Error("Unable to create Occlusion Query");return s};K.prototype.deleteQuery=function(s){return this._gl.deleteQuery(s),this};K.prototype.isQueryResultAvailable=function(s){return this._gl.getQueryParameter(s,this._gl.QUERY_RESULT_AVAILABLE)};K.prototype.getQueryResult=function(s){return this._gl.getQueryParameter(s,this._gl.QUERY_RESULT)};K.prototype.beginOcclusionQuery=function(s,e){let t=this._getGlAlgorithmType(s);return this._gl.beginQuery(t,e),!0};K.prototype.endOcclusionQuery=function(s){let e=this._getGlAlgorithmType(s);return this._gl.endQuery(e),this};K.prototype._createTimeQuery=function(){let s=this.getCaps().timerQuery;return s.createQueryEXT?s.createQueryEXT():this.createQuery()};K.prototype._deleteTimeQuery=function(s){let e=this.getCaps().timerQuery;if(e.deleteQueryEXT){e.deleteQueryEXT(s);return}this.deleteQuery(s)};K.prototype._getTimeQueryResult=function(s){let e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(s,e.QUERY_RESULT_EXT):this.getQueryResult(s)};K.prototype._getTimeQueryAvailability=function(s){let e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(s,e.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(s)};K.prototype.startTimeQuery=function(){let s=this.getCaps(),e=s.timerQuery;if(!e)return null;let t=new Mv;if(this._gl.getParameter(e.GPU_DISJOINT_EXT),s.canUseTimestampForTimerQuery)t._startTimeQuery=this._createTimeQuery(),t._startTimeQuery&&e.queryCounterEXT(t._startTimeQuery,e.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;t._timeElapsedQuery=this._createTimeQuery(),t._timeElapsedQuery&&(e.beginQueryEXT?e.beginQueryEXT(e.TIME_ELAPSED_EXT,t._timeElapsedQuery):this._gl.beginQuery(e.TIME_ELAPSED_EXT,t._timeElapsedQuery)),this._currentNonTimestampToken=t}return t};K.prototype.endTimeQuery=function(s){let e=this.getCaps(),t=e.timerQuery;if(!t||!s)return-1;if(e.canUseTimestampForTimerQuery){if(!s._startTimeQuery)return-1;s._endTimeQuery||(s._endTimeQuery=this._createTimeQuery(),s._endTimeQuery&&t.queryCounterEXT(s._endTimeQuery,t.TIMESTAMP_EXT))}else if(!s._timeElapsedQueryEnded){if(!s._timeElapsedQuery)return-1;t.endQueryEXT?t.endQueryEXT(t.TIME_ELAPSED_EXT):(this._gl.endQuery(t.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),s._timeElapsedQueryEnded=!0}let i=this._gl.getParameter(t.GPU_DISJOINT_EXT),r=!1;if(s._endTimeQuery?r=this._getTimeQueryAvailability(s._endTimeQuery):s._timeElapsedQuery&&(r=this._getTimeQueryAvailability(s._timeElapsedQuery)),r&&!i){let n=0;if(e.canUseTimestampForTimerQuery){if(!s._startTimeQuery||!s._endTimeQuery)return-1;let o=this._getTimeQueryResult(s._startTimeQuery);n=this._getTimeQueryResult(s._endTimeQuery)-o,this._deleteTimeQuery(s._startTimeQuery),this._deleteTimeQuery(s._endTimeQuery),s._startTimeQuery=null,s._endTimeQuery=null}else{if(!s._timeElapsedQuery)return-1;n=this._getTimeQueryResult(s._timeElapsedQuery),this._deleteTimeQuery(s._timeElapsedQuery),s._timeElapsedQuery=null,s._timeElapsedQueryEnded=!1}return n}return-1};K.prototype._captureGPUFrameTime=!1;K.prototype._gpuFrameTime=new Ps;K.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime};K.prototype.captureGPUFrameTime=function(s){s!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=s,s?(this._onBeginFrameObserver=this.onBeginFrameObservable.add(()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())}),this._onEndFrameObserver=this.onEndFrameObservable.add(()=>{if(!this._gpuFrameTimeToken)return;let e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,this._gpuFrameTime.fetchNewFrame(),this._gpuFrameTime.addCount(e,!0))})):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))};K.prototype._getGlAlgorithmType=function(s){return s===lt.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED};K.prototype.createTransformFeedback=function(){let s=this._gl.createTransformFeedback();if(!s)throw new Error("Unable to create Transform Feedback");return s};K.prototype.deleteTransformFeedback=function(s){this._gl.deleteTransformFeedback(s)};K.prototype.bindTransformFeedback=function(s){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,s)};K.prototype.beginTransformFeedback=function(s=!0){this._gl.beginTransformFeedback(s?this._gl.POINTS:this._gl.TRIANGLES)};K.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()};K.prototype.setTranformFeedbackVaryings=function(s,e){this._gl.transformFeedbackVaryings(s,e,this._gl.INTERLEAVED_ATTRIBS)};K.prototype.bindTransformFeedbackBuffer=function(s){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,s?s.underlyingResource:null)};K.prototype.readTransformFeedbackBuffer=function(s){this._gl.getBufferSubData(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,s)};at.prototype.updateVideoTexture=function(s,e,t){if(!s||s._isDisabled)return;let i=this._getInternalFormat(s.format),r=this._getRGBABufferInternalSizedFormat(0,s.format),n=this._bindTextureDirectly(this._gl.TEXTURE_2D,s,!0);this._unpackFlipY(!t);try{if(this._videoTextureSupported===void 0&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,e),this._gl.getError()!==0?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,e);else{if(!s._workingCanvas){s._workingCanvas=this.createCanvas(s.width,s.height);let o=s._workingCanvas.getContext("2d");if(!o)throw new Error("Unable to get 2d context");s._workingContext=o,s._workingCanvas.width=s.width,s._workingCanvas.height=s.height}s._workingContext.clearRect(0,0,s.width,s.height),s._workingContext.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,s.width,s.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,r,i,this._gl.UNSIGNED_BYTE,s._workingCanvas)}s.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),n||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),s.isReady=!0}catch{s._isDisabled=!0}};at.prototype.restoreSingleAttachment=function(){let s=this._gl;this.bindAttachments([s.BACK])};at.prototype.restoreSingleAttachmentForRenderTarget=function(){let s=this._gl;this.bindAttachments([s.COLOR_ATTACHMENT0])};at.prototype.buildTextureLayout=function(s){let e=this._gl,t=[];for(let i=0;i<s.length;i++)s[i]?t.push(e["COLOR_ATTACHMENT"+i]):t.push(e.NONE);return t};at.prototype.bindAttachments=function(s){this._gl.drawBuffers(s)};at.prototype.unBindMultiColorAttachmentFramebuffer=function(s,e=!1,t){this._currentRenderTarget=null;let i=this._gl,r=s._attachments,n=r.length;if(s._MSAAFramebuffer){i.bindFramebuffer(i.READ_FRAMEBUFFER,s._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,s._framebuffer);for(let o=0;o<n;o++){let a=s.textures[o];for(let l=0;l<n;l++)r[l]=i.NONE;r[o]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+o:"COLOR_ATTACHMENT"+o+"_WEBGL"],i.readBuffer(r[o]),i.drawBuffers(r),i.blitFramebuffer(0,0,a.width,a.height,0,0,a.width,a.height,i.COLOR_BUFFER_BIT,i.NEAREST)}for(let o=0;o<n;o++)r[o]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+o:"COLOR_ATTACHMENT"+o+"_WEBGL"];i.drawBuffers(r)}for(let o=0;o<n;o++){let a=s.textures[o];a?.generateMipMaps&&!e&&!a?.isCube&&!a?.is3D&&(this._bindTextureDirectly(i.TEXTURE_2D,a,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null))}t&&(s._MSAAFramebuffer&&this._bindUnboundFramebuffer(s._framebuffer),t()),this._bindUnboundFramebuffer(null)};at.prototype.createMultipleRenderTarget=function(s,e,t=!0){let i=!1,r=!0,n=!1,o=!1,a=15,l=1,c=0,h=3,u=!1,d=5,f=3553,m=[],g=[],_=[],x=[],b=[],C=[],R=[],E=[],S=this._createHardwareRenderTargetWrapper(!0,!1,s);e!==void 0&&(i=e.generateMipMaps===void 0?!1:e.generateMipMaps,r=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,n=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,o=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,l=e.textureCount||1,e.types&&(m=e.types),e.samplingModes&&(g=e.samplingModes),e.useSRGBBuffers&&(_=e.useSRGBBuffers),e.formats&&(x=e.formats),e.targetTypes&&(b=e.targetTypes),e.faceIndex&&(C=e.faceIndex),e.layerIndex&&(R=e.layerIndex),e.layerCounts&&(E=e.layerCounts),this.webGLVersion>1&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===16||e.depthTextureFormat===14||e.depthTextureFormat===18)&&(a=e.depthTextureFormat)),S.label=e?.label??"MultiRenderTargetWrapper";let A=this._gl,L=A.createFramebuffer();this._bindUnboundFramebuffer(L);let G=s.width||s,W=s.height||s,$=[],re=[],we=this.webGLVersion>1&&o&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===18),_e=this._setupFramebufferDepthAttachments(!we&&n,!o&&r,G,W);S._framebuffer=L,S._depthStencilBuffer=_e,S._generateDepthBuffer=!o&&r,S._generateStencilBuffer=!we&&n,S._attachments=re;for(let ce=0;ce<l;ce++){let ne=g[ce]||h,Fe=m[ce]||c,Oe=_[ce]||u,he=x[ce]||d,ee=b[ce]||f,V=E[ce]??1;(Fe===1&&!this._caps.textureFloatLinearFiltering||Fe===2&&!this._caps.textureHalfFloatLinearFiltering)&&(ne=1);let Y=this._getSamplingParameters(ne,i);Fe===1&&!this._caps.textureFloat&&(Fe=0,F.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),Oe=Oe&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);let J=this.webGLVersion>1,Me=A[J?"COLOR_ATTACHMENT"+ce:"COLOR_ATTACHMENT"+ce+"_WEBGL"];if(re.push(Me),ee===-1)continue;let Re=new Je(this,ke.MultiRenderTarget);$[ce]=Re,A.activeTexture(A["TEXTURE"+ce]),A.bindTexture(ee,Re._hardwareTexture.underlyingResource),A.texParameteri(ee,A.TEXTURE_MAG_FILTER,Y.mag),A.texParameteri(ee,A.TEXTURE_MIN_FILTER,Y.min),A.texParameteri(ee,A.TEXTURE_WRAP_S,A.CLAMP_TO_EDGE),A.texParameteri(ee,A.TEXTURE_WRAP_T,A.CLAMP_TO_EDGE);let et=this._getRGBABufferInternalSizedFormat(Fe,he,Oe),Tt=this._getInternalFormat(he),Yt=this._getWebGLTextureType(Fe);if(J&&(ee===35866||ee===32879))ee===35866?Re.is2DArray=!0:Re.is3D=!0,Re.baseDepth=Re.depth=V,A.texImage3D(ee,0,et,G,W,V,0,Tt,Yt,null);else if(ee===34067){for(let si=0;si<6;si++)A.texImage2D(A.TEXTURE_CUBE_MAP_POSITIVE_X+si,0,et,G,W,0,Tt,Yt,null);Re.isCube=!0}else A.texImage2D(A.TEXTURE_2D,0,et,G,W,0,Tt,Yt,null);i&&A.generateMipmap(ee),this._bindTextureDirectly(ee,null),Re.baseWidth=G,Re.baseHeight=W,Re.width=G,Re.height=W,Re.isReady=!0,Re.samples=1,Re.generateMipMaps=i,Re.samplingMode=ne,Re.type=Fe,Re._useSRGBBuffer=Oe,Re.format=he,this._internalTexturesCache.push(Re)}if(o&&this._caps.depthTextureExtension){let ce=new Je(this,ke.Depth),ne=5,Fe=A.DEPTH_COMPONENT16,Oe=A.DEPTH_COMPONENT,he=A.UNSIGNED_SHORT,ee=A.DEPTH_ATTACHMENT;this.webGLVersion<2?Fe=A.DEPTH_COMPONENT:a===14?(ne=1,he=A.FLOAT,Fe=A.DEPTH_COMPONENT32F):a===18?(ne=0,he=A.FLOAT_32_UNSIGNED_INT_24_8_REV,Fe=A.DEPTH32F_STENCIL8,Oe=A.DEPTH_STENCIL,ee=A.DEPTH_STENCIL_ATTACHMENT):a===16?(ne=0,he=A.UNSIGNED_INT,Fe=A.DEPTH_COMPONENT24,ee=A.DEPTH_ATTACHMENT):(a===13||a===17)&&(ne=12,he=A.UNSIGNED_INT_24_8,Fe=A.DEPTH24_STENCIL8,Oe=A.DEPTH_STENCIL,ee=A.DEPTH_STENCIL_ATTACHMENT),A.activeTexture(A.TEXTURE0),A.bindTexture(A.TEXTURE_2D,ce._hardwareTexture.underlyingResource),A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MAG_FILTER,A.NEAREST),A.texParameteri(A.TEXTURE_2D,A.TEXTURE_MIN_FILTER,A.NEAREST),A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_S,A.CLAMP_TO_EDGE),A.texParameteri(A.TEXTURE_2D,A.TEXTURE_WRAP_T,A.CLAMP_TO_EDGE),A.texImage2D(A.TEXTURE_2D,0,Fe,G,W,0,Oe,he,null),A.framebufferTexture2D(A.FRAMEBUFFER,ee,A.TEXTURE_2D,ce._hardwareTexture.underlyingResource,0),ce.baseWidth=G,ce.baseHeight=W,ce.width=G,ce.height=W,ce.isReady=!0,ce.samples=1,ce.generateMipMaps=i,ce.samplingMode=1,ce.format=a,ce.type=ne,$[l]=ce,this._internalTexturesCache.push(ce)}return S.setTextures($),t&&A.drawBuffers(re),this._bindUnboundFramebuffer(null),S.setLayerAndFaceIndices(R,C),this.resetTextureCache(),S};at.prototype.updateMultipleRenderTargetTextureSampleCount=function(s,e,t=!0){if(this.webGLVersion<2||!s||!s.texture)return 1;if(s.samples===e)return e;let i=s._attachments.length;if(i===0)return 1;let r=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples);let n=!!s._depthStencilBuffer;if(n&&(r.deleteRenderbuffer(s._depthStencilBuffer),s._depthStencilBuffer=null),s._MSAAFramebuffer&&(r.deleteFramebuffer(s._MSAAFramebuffer),s._MSAAFramebuffer=null),e>1&&typeof r.renderbufferStorageMultisample=="function"){let o=r.createFramebuffer();if(!o)throw new Error("Unable to create multi sampled framebuffer");s._MSAAFramebuffer=o,this._bindUnboundFramebuffer(o);let a=[];for(let l=0;l<i;l++)s.textures[l]._hardwareTexture.releaseMSAARenderBuffers();for(let l=0;l<i;l++){let c=s.textures[l],h=c._hardwareTexture,u=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+l:"COLOR_ATTACHMENT"+l+"_WEBGL"],d=this._createRenderBuffer(c.width,c.height,e,-1,this._getRGBABufferInternalSizedFormat(c.type,c.format,c._useSRGBBuffer),u);if(!d)throw new Error("Unable to create multi sampled framebuffer");h.addMSAARenderBuffer(d),c.samples=e,a.push(u)}t&&r.drawBuffers(a)}else this._bindUnboundFramebuffer(s._framebuffer);return n&&(s._depthStencilBuffer=this._setupFramebufferDepthAttachments(s._generateStencilBuffer,s._generateDepthBuffer,s.texture.width,s.texture.height,e)),this._bindUnboundFramebuffer(null),e};at.prototype._createDepthStencilCubeTexture=function(s,e){let t=new Je(this,ke.DepthStencil);if(t.isCube=!0,this.webGLVersion===1)return F.Error("Depth cube texture is not supported by WebGL 1."),t;let i=ie({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1},e),r=this._gl;this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,t,!0),this._setupDepthStencilTexture(t,s,i.generateStencil,i.bilinearFiltering,i.comparisonFunction);for(let n=0;n<6;n++)i.generateStencil?r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,r.DEPTH24_STENCIL8,s,s,0,r.DEPTH_STENCIL,r.UNSIGNED_INT_24_8,null):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,r.DEPTH_COMPONENT24,s,s,0,r.DEPTH_COMPONENT,r.UNSIGNED_INT,null);return this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(t),t};at.prototype._setCubeMapTextureParams=function(s,e,t){let i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),s.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),s._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)};at.prototype.createCubeTexture=function(s,e,t,i,r=null,n=null,o,a=null,l=!1,c=0,h=0,u=null,d,f=!1,m=null){let g=this._gl;return this.createCubeTextureBase(s,e,t,!!i,r,n,o,a,l,c,h,u,_=>this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,_,!0),(_,x)=>{let b=this.needPOTTextures?Rr(x[0].width,this._caps.maxCubemapTextureSize):x[0].width,C=b,R=[g.TEXTURE_CUBE_MAP_POSITIVE_X,g.TEXTURE_CUBE_MAP_POSITIVE_Y,g.TEXTURE_CUBE_MAP_POSITIVE_Z,g.TEXTURE_CUBE_MAP_NEGATIVE_X,g.TEXTURE_CUBE_MAP_NEGATIVE_Y,g.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(g.TEXTURE_CUBE_MAP,_,!0),this._unpackFlipY(!1);let E=o?this._getInternalFormat(o,_._useSRGBBuffer):_._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:g.RGBA,S=o?this._getInternalFormat(o):g.RGBA;_._useSRGBBuffer&&this.webGLVersion===1&&(S=E);for(let A=0;A<R.length;A++)if(x[A].width!==b||x[A].height!==C){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext){F.Warn("Cannot create canvas to resize texture.");return}this._workingCanvas.width=b,this._workingCanvas.height=C,this._workingContext.drawImage(x[A],0,0,x[A].width,x[A].height,0,0,b,C),g.texImage2D(R[A],0,E,S,g.UNSIGNED_BYTE,this._workingCanvas)}else g.texImage2D(R[A],0,E,S,g.UNSIGNED_BYTE,x[A]);i||g.generateMipmap(g.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(_,!i),_.width=b,_.height=C,_.isReady=!0,o&&(_.format=o),_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear(),r&&r()},!!f,m)};at.prototype.generateMipMapsForCubemap=function(s,e=!0){if(s.generateMipMaps){let t=this._gl;this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,s,!0),t.generateMipmap(t.TEXTURE_CUBE_MAP),e&&this._bindTextureDirectly(t.TEXTURE_CUBE_MAP,null)}};var fa=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],cY=[()=>1,s=>s.y,s=>s.z,s=>s.x,s=>s.x*s.y,s=>s.y*s.z,s=>3*s.z*s.z-1,s=>s.x*s.z,s=>s.x*s.x-s.y*s.y],Ja=(s,e)=>fa[s]*cY[s](e),el=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4],tl=class s{constructor(){this.preScaled=!1,this.l00=p.Zero(),this.l1_1=p.Zero(),this.l10=p.Zero(),this.l11=p.Zero(),this.l2_2=p.Zero(),this.l2_1=p.Zero(),this.l20=p.Zero(),this.l21=p.Zero(),this.l22=p.Zero()}addLight(e,t,i){O.Vector3[0].set(t.r,t.g,t.b);let r=O.Vector3[0],n=O.Vector3[1];r.scaleToRef(i,n),n.scaleToRef(Ja(0,e),O.Vector3[2]),this.l00.addInPlace(O.Vector3[2]),n.scaleToRef(Ja(1,e),O.Vector3[2]),this.l1_1.addInPlace(O.Vector3[2]),n.scaleToRef(Ja(2,e),O.Vector3[2]),this.l10.addInPlace(O.Vector3[2]),n.scaleToRef(Ja(3,e),O.Vector3[2]),this.l11.addInPlace(O.Vector3[2]),n.scaleToRef(Ja(4,e),O.Vector3[2]),this.l2_2.addInPlace(O.Vector3[2]),n.scaleToRef(Ja(5,e),O.Vector3[2]),this.l2_1.addInPlace(O.Vector3[2]),n.scaleToRef(Ja(6,e),O.Vector3[2]),this.l20.addInPlace(O.Vector3[2]),n.scaleToRef(Ja(7,e),O.Vector3[2]),this.l21.addInPlace(O.Vector3[2]),n.scaleToRef(Ja(8,e),O.Vector3[2]),this.l22.addInPlace(O.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(el[0]),this.l1_1.scaleInPlace(el[1]),this.l10.scaleInPlace(el[2]),this.l11.scaleInPlace(el[3]),this.l2_2.scaleInPlace(el[4]),this.l2_1.scaleInPlace(el[5]),this.l20.scaleInPlace(el[6]),this.l21.scaleInPlace(el[7]),this.l22.scaleInPlace(el[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(fa[0]),this.l1_1.scaleInPlace(fa[1]),this.l10.scaleInPlace(fa[2]),this.l11.scaleInPlace(fa[3]),this.l2_2.scaleInPlace(fa[4]),this.l2_1.scaleInPlace(fa[5]),this.l20.scaleInPlace(fa[6]),this.l21.scaleInPlace(fa[7]),this.l22.scaleInPlace(fa[8])}updateFromArray(e){return p.FromArrayToRef(e[0],0,this.l00),p.FromArrayToRef(e[1],0,this.l1_1),p.FromArrayToRef(e[2],0,this.l10),p.FromArrayToRef(e[3],0,this.l11),p.FromArrayToRef(e[4],0,this.l2_2),p.FromArrayToRef(e[5],0,this.l2_1),p.FromArrayToRef(e[6],0,this.l20),p.FromArrayToRef(e[7],0,this.l21),p.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return p.FromFloatsToRef(e[0],e[1],e[2],this.l00),p.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),p.FromFloatsToRef(e[6],e[7],e[8],this.l10),p.FromFloatsToRef(e[9],e[10],e[11],this.l11),p.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),p.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),p.FromFloatsToRef(e[18],e[19],e[20],this.l20),p.FromFloatsToRef(e[21],e[22],e[23],this.l21),p.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return new s().updateFromArray(e)}static FromPolynomial(e){let t=new s;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}},vs=class s{constructor(){this.x=p.Zero(),this.y=p.Zero(),this.z=p.Zero(),this.xx=p.Zero(),this.yy=p.Zero(),this.zz=p.Zero(),this.xy=p.Zero(),this.yz=p.Zero(),this.zx=p.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=tl.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){O.Vector3[0].copyFromFloats(e.r,e.g,e.b);let t=O.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),O.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),O.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(O.Vector3[0]).addInPlace(O.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(O.Vector3[0]).subtractInPlace(O.Vector3[1]),this.zz.copyFrom(e.l00),O.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(O.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return new s().updateFromHarmonics(e)}static FromArray(e){let t=new s;return p.FromArrayToRef(e[0],0,t.x),p.FromArrayToRef(e[1],0,t.y),p.FromArrayToRef(e[2],0,t.z),p.FromArrayToRef(e[3],0,t.xx),p.FromArrayToRef(e[4],0,t.yy),p.FromArrayToRef(e[5],0,t.zz),p.FromArrayToRef(e[6],0,t.yz),p.FromArrayToRef(e[7],0,t.zx),p.FromArrayToRef(e[8],0,t.xy),t}};var jl=class{constructor(e,t,i,r){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=r}},Io=class{static ConvertCubeMapTextureToSphericalPolynomial(e){if(!e.isCube)return null;e.getScene()?.getEngine().flushFramebuffer();let t=e.getSize().width,i=e.readPixels(0,void 0,void 0,!1),r=e.readPixels(1,void 0,void 0,!1),n,o;e.isRenderTarget?(n=e.readPixels(3,void 0,void 0,!1),o=e.readPixels(2,void 0,void 0,!1)):(n=e.readPixels(2,void 0,void 0,!1),o=e.readPixels(3,void 0,void 0,!1));let a=e.readPixels(4,void 0,void 0,!1),l=e.readPixels(5,void 0,void 0,!1),c=e.gammaSpace,h=5,u=0;return(e.textureType==1||e.textureType==2)&&(u=1),new Promise(d=>{Promise.all([r,i,n,o,a,l]).then(([f,m,g,_,x,b])=>{let C={size:t,right:m,left:f,up:g,down:_,front:x,back:b,format:h,type:u,gammaSpace:c};d(this.ConvertCubeMapToSphericalPolynomial(C))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){let t=new tl,i=0,r=2/e.size,n=r,o=.5*r,a=o-1;for(let d=0;d<6;d++){let f=this._FileFaces[d],m=e[f.name],g=a,_=e.format===5?4:3;for(let x=0;x<e.size;x++){let b=a;for(let C=0;C<e.size;C++){let R=f.worldAxisForFileX.scale(b).add(f.worldAxisForFileY.scale(g)).add(f.worldAxisForNormal);R.normalize();let E=this._AreaElement(b-o,g-o)-this._AreaElement(b-o,g+o)-this._AreaElement(b+o,g-o)+this._AreaElement(b+o,g+o),S=m[x*e.size*_+C*_+0],A=m[x*e.size*_+C*_+1],L=m[x*e.size*_+C*_+2];isNaN(S)&&(S=0),isNaN(A)&&(A=0),isNaN(L)&&(L=0),e.type===0&&(S/=255,A/=255,L/=255),e.gammaSpace&&(S=Math.pow(xe.Clamp(S),Cg),A=Math.pow(xe.Clamp(A),Cg),L=Math.pow(xe.Clamp(L),Cg));let G=this.MAX_HDRI_VALUE;if(this.PRESERVE_CLAMPED_COLORS){let $=Math.max(S,A,L);if($>G){let re=G/$;S*=re,A*=re,L*=re}}else S=xe.Clamp(S,0,G),A=xe.Clamp(A,0,G),L=xe.Clamp(L,0,G);let W=new X(S,A,L);t.addLight(R,W,E),i+=E,b+=r}g+=n}}let u=4*Math.PI*6/6/i;return t.scaleInPlace(u),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),vs.FromHarmonics(t)}};Io._FileFaces=[new jl("right",new p(1,0,0),new p(0,0,-1),new p(0,-1,0)),new jl("left",new p(-1,0,0),new p(0,0,1),new p(0,-1,0)),new jl("up",new p(0,1,0),new p(1,0,0),new p(0,0,1)),new jl("down",new p(0,-1,0),new p(1,0,0),new p(0,0,-1)),new jl("front",new p(0,0,1),new p(1,0,0),new p(0,-1,0)),new jl("back",new p(0,0,-1),new p(-1,0,0),new p(0,-1,0))];Io.MAX_HDRI_VALUE=4096;Io.PRESERVE_CLAMPED_COLORS=!1;var hY="lodPixelShader",uY=`#extension GL_EXT_shader_texture_lod : enable
precision highp float;const float GammaEncodePowerApprox=1.0/2.2;varying vec2 vUV;uniform sampler2D textureSampler;uniform float lod;uniform vec2 texSize;uniform bool gamma;void main(void)
{gl_FragColor=textureLod(textureSampler,vUV,lod);if (!gamma) {gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(GammaEncodePowerApprox));}}
`;D.ShadersStore[hY]=uY;var dY="lodCubePixelShader",fY=`precision highp float;const float GammaEncodePowerApprox=1.0/2.2;varying vec2 vUV;uniform samplerCube textureSampler;uniform float lod;uniform bool gamma;void main(void)
{vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x),lod);
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x),lod);
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x),lod);
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x),lod);
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001),lod);
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001),lod);
#endif
if (!gamma) {gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(GammaEncodePowerApprox));}}
`;D.ShadersStore[dY]=fY;function pY(s,e,t,i=!0){let r=s.getScene(),n=r.getEngine(),o=new vt("resized"+s.name,{width:e,height:t},r,!s.noMipmap,!0,s._texture.type,!1,s.samplingMode,!1);o.wrapU=s.wrapU,o.wrapV=s.wrapV,o.uOffset=s.uOffset,o.vOffset=s.vOffset,o.uScale=s.uScale,o.vScale=s.vScale,o.uAng=s.uAng,o.vAng=s.vAng,o.wAng=s.wAng,o.coordinatesIndex=s.coordinatesIndex,o.level=s.level,o.anisotropicFilteringLevel=s.anisotropicFilteringLevel,o._texture.isReady=!1,s.wrapU=z.CLAMP_ADDRESSMODE,s.wrapV=z.CLAMP_ADDRESSMODE;let a=new qr("pass",1,null,i?z.BILINEAR_SAMPLINGMODE:z.NEAREST_SAMPLINGMODE,n,!1,0);return a.externalTextureSamplerBinding=!0,a.getEffect().executeWhenCompiled(()=>{a.onApply=function(c){c.setTexture("textureSampler",s)};let l=o.renderTarget;l&&(r.postProcessManager.directRender([a],l),n.unBindFramebuffer(l),o.disposeFramebufferObjects(),a.dispose(),o.getInternalTexture().isReady=!0)}),o}function _m(s,e,t,i,r,n,o,a){let l=e.getEngine();return e.isReady=!1,r=r??e.samplingMode,i=i??e.type,n=n??e.format,o=o??e.width,a=a??e.height,i===-1&&(i=0),new Promise(c=>{let h=new ve("postprocess",s,null,null,1,null,r,l,!1,void 0,i,void 0,null,!1,n);h.externalTextureSamplerBinding=!0;let u=l.createRenderTargetTexture({width:o,height:a},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:r,type:i,format:n});h.getEffect().executeWhenCompiled(()=>{h.onApply=d=>{d._bindTexture("textureSampler",e),d.setFloat2("scale",1,1)},t.postProcessManager.directRender([h],u,!0),l.restoreDefaultFramebuffer(),l._releaseTexture(e),h&&h.dispose(),u._swapAndDie(e),e.type=i,e.format=5,e.isReady=!0,c(e)})})}var Dv,MB;function jn(s){Dv||(Dv=new Float32Array(1),MB=new Int32Array(Dv.buffer)),Dv[0]=s;let e=MB[0],t=e>>16&32768,i=e>>12&2047,r=e>>23&255;return r<103?t:r>142?(t|=31744,t|=(r==255?0:1)&&e&8388607,t):r<113?(i|=2048,t|=(i>>114-r)+(i>>113-r&1),t):(t|=r-112<<10|i>>1,t+=i&1,t)}function qn(s){let e=(s&32768)>>15,t=(s&31744)>>10,i=s&1023;return t===0?(e?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):t==31?i?NaN:(e?-1:1)*(1/0):(e?-1:1)*Math.pow(2,t-15)*(1+i/Math.pow(2,10))}var mY=(s,e,t,i,r)=>$e(void 0,null,function*(){let n=s.getScene(),o=n.getEngine(),a;if(!s.isCube)a=new ve("lod","lod",["lod","gamma"],null,1,null,z.NEAREST_NEAREST_MIPNEAREST,o);else{let h=["#define POSITIVEX","#define NEGATIVEX","#define POSITIVEY","#define NEGATIVEY","#define POSITIVEZ","#define NEGATIVEZ"];a=new ve("lodCube","lodCube",["lod","gamma"],null,1,null,z.NEAREST_NEAREST_MIPNEAREST,o,!1,h[i])}yield new Promise(h=>{a.getEffect().executeWhenCompiled(()=>{h(0)})});let l=new vt("temp",{width:e,height:t},n,!1);a.onApply=function(h){h.setTexture("textureSampler",s),h.setFloat("lod",r),h.setBool("gamma",s.gammaSpace)};let c=s.getInternalTexture();try{if(l.renderTarget&&c){let h=c.samplingMode;r!==0?s.updateSamplingMode(z.NEAREST_NEAREST_MIPNEAREST):s.updateSamplingMode(z.NEAREST_NEAREST),n.postProcessManager.directRender([a],l.renderTarget,!0),s.updateSamplingMode(h);let u=yield o.readPixels(0,0,e,t),d=new Uint8Array(u.buffer,0,u.byteLength);return o.unBindFramebuffer(l.renderTarget),d}else throw Error("Render to texture failed.")}finally{l.dispose(),a.dispose()}});function gY(s,e,t,i=0,r=0){return $e(this,null,function*(){return!s.isReady()&&s._texture&&(yield new Promise((n,o)=>{if(s._texture===null){o(0);return}s._texture.onLoadedObservable.addOnce(()=>{n(0)})})),yield mY(s,e,t,i,r)})}var DB={CreateResizedCopy:pY,ApplyPostProcess:_m,ToHalfFloat:jn,FromHalfFloat:qn,GetTextureDataAsync:gY};var _Y=542327876,OB=131072,wB=512,NB=4,FB=64,LB=131072;function Ov(s){return s.charCodeAt(0)+(s.charCodeAt(1)<<8)+(s.charCodeAt(2)<<16)+(s.charCodeAt(3)<<24)}function xY(s){return String.fromCharCode(s&255,s>>8&255,s>>16&255,s>>24&255)}var BB=Ov("DXT1"),VB=Ov("DXT3"),UB=Ov("DXT5"),s0=Ov("DX10"),kB=113,GB=116,zB=2,WB=10,vY=88,n0=31,TY=0,CY=1,HB=2,XB=3,o0=4,YB=7,a0=20,$B=21,bY=22,SY=23,yY=24,EY=25,AY=26,IY=28,RY=32,il=(()=>{class s{static GetDDSInfo(t){let i=new Int32Array(t.buffer,t.byteOffset,n0),r=new Int32Array(t.buffer,t.byteOffset,n0+4),n=1;i[HB]&OB&&(n=Math.max(1,i[YB]));let o=i[$B],a=o===s0?r[RY]:0,l=0;switch(o){case kB:l=2;break;case GB:l=1;break;case s0:if(a===WB){l=2;break}if(a===zB){l=1;break}}return{width:i[o0],height:i[XB],mipmapCount:n,isFourCC:(i[a0]&NB)===NB,isRGB:(i[a0]&FB)===FB,isLuminance:(i[a0]&LB)===LB,isCube:(i[IY]&wB)===wB,isCompressed:o===BB||o===VB||o===UB,dxgiFormat:a,textureType:l}}static _GetHalfFloatAsFloatRGBAArrayBuffer(t,i,r,n,o,a){let l=new Float32Array(n),c=new Uint16Array(o,r),h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++){let f=(d+u*t)*4;l[h]=qn(c[f]),l[h+1]=qn(c[f+1]),l[h+2]=qn(c[f+2]),s.StoreLODInAlphaChannel?l[h+3]=a:l[h+3]=qn(c[f+3]),h+=4}return l}static _GetHalfFloatRGBAArrayBuffer(t,i,r,n,o,a){if(s.StoreLODInAlphaChannel){let l=new Uint16Array(n),c=new Uint16Array(o,r),h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++){let f=(d+u*t)*4;l[h]=c[f],l[h+1]=c[f+1],l[h+2]=c[f+2],l[h+3]=jn(a),h+=4}return l}return new Uint16Array(o,r,n)}static _GetFloatRGBAArrayBuffer(t,i,r,n,o,a){if(s.StoreLODInAlphaChannel){let l=new Float32Array(n),c=new Float32Array(o,r),h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++){let f=(d+u*t)*4;l[h]=c[f],l[h+1]=c[f+1],l[h+2]=c[f+2],l[h+3]=a,h+=4}return l}return new Float32Array(o,r,n)}static _GetFloatAsHalfFloatRGBAArrayBuffer(t,i,r,n,o,a){let l=new Uint16Array(n),c=new Float32Array(o,r),h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++)l[h]=jn(c[h]),l[h+1]=jn(c[h+1]),l[h+2]=jn(c[h+2]),s.StoreLODInAlphaChannel?l[h+3]=jn(a):l[h+3]=jn(c[h+3]),h+=4;return l}static _GetFloatAsUIntRGBAArrayBuffer(t,i,r,n,o,a){let l=new Uint8Array(n),c=new Float32Array(o,r),h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++){let f=(d+u*t)*4;l[h]=xe.Clamp(c[f])*255,l[h+1]=xe.Clamp(c[f+1])*255,l[h+2]=xe.Clamp(c[f+2])*255,s.StoreLODInAlphaChannel?l[h+3]=a:l[h+3]=xe.Clamp(c[f+3])*255,h+=4}return l}static _GetHalfFloatAsUIntRGBAArrayBuffer(t,i,r,n,o,a){let l=new Uint8Array(n),c=new Uint16Array(o,r),h=0;for(let u=0;u<i;u++)for(let d=0;d<t;d++){let f=(d+u*t)*4;l[h]=xe.Clamp(qn(c[f]))*255,l[h+1]=xe.Clamp(qn(c[f+1]))*255,l[h+2]=xe.Clamp(qn(c[f+2]))*255,s.StoreLODInAlphaChannel?l[h+3]=a:l[h+3]=xe.Clamp(qn(c[f+3]))*255,h+=4}return l}static _GetRGBAArrayBuffer(t,i,r,n,o,a,l,c,h){let u=new Uint8Array(n),d=new Uint8Array(o,r),f=0;for(let m=0;m<i;m++)for(let g=0;g<t;g++){let _=(g+m*t)*4;u[f]=d[_+a],u[f+1]=d[_+l],u[f+2]=d[_+c],u[f+3]=d[_+h],f+=4}return u}static _ExtractLongWordOrder(t){return t===0||t===255||t===-16777216?0:1+s._ExtractLongWordOrder(t>>8)}static _GetRGBArrayBuffer(t,i,r,n,o,a,l,c){let h=new Uint8Array(n),u=new Uint8Array(o,r),d=0;for(let f=0;f<i;f++)for(let m=0;m<t;m++){let g=(m+f*t)*3;h[d]=u[g+a],h[d+1]=u[g+l],h[d+2]=u[g+c],d+=3}return h}static _GetLuminanceArrayBuffer(t,i,r,n,o){let a=new Uint8Array(n),l=new Uint8Array(o,r),c=0;for(let h=0;h<i;h++)for(let u=0;u<t;u++){let d=u+h*t;a[c]=l[d],c++}return a}static UploadDDSLevels(t,i,r,n,o,a,l=-1,c,h=!0){let u=null;n.sphericalPolynomial&&(u=[]);let d=!!t.getCaps().s3tc;i.generateMipMaps=o;let f=new Int32Array(r.buffer,r.byteOffset,n0),m,g,_,x=0,b,C,R,E,S=0,A=1;if(f[TY]!==_Y){F.Error("Invalid magic number in DDS header");return}if(!n.isFourCC&&!n.isRGB&&!n.isLuminance){F.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(n.isCompressed&&!d){F.Error("Compressed textures are not supported on this platform.");return}let L=f[bY];b=f[CY]+4;let G=!1;if(n.isFourCC)switch(m=f[$B],m){case BB:A=8,S=33777;break;case VB:A=16,S=33778;break;case UB:A=16,S=33779;break;case kB:G=!0,L=64;break;case GB:G=!0,L=128;break;case s0:{b+=5*4;let ne=!1;switch(n.dxgiFormat){case WB:G=!0,L=64,ne=!0;break;case zB:G=!0,L=128,ne=!0;break;case vY:n.isRGB=!0,n.isFourCC=!1,L=32,ne=!0;break}if(ne)break}default:F.Error(["Unsupported FourCC code:",xY(m)]);return}let W=s._ExtractLongWordOrder(f[SY]),$=s._ExtractLongWordOrder(f[yY]),re=s._ExtractLongWordOrder(f[EY]),we=s._ExtractLongWordOrder(f[AY]);G&&(S=t._getRGBABufferInternalSizedFormat(n.textureType)),R=1,f[HB]&OB&&o!==!1&&(R=Math.max(1,f[YB]));let _e=c||0,ce=t.getCaps();for(let ne=_e;ne<a;ne++){for(g=f[o0],_=f[XB],E=0;E<R;++E){if(l===-1||l===E){let Fe=l===-1?E:0;if(!n.isCompressed&&n.isFourCC){i.format=5,x=g*_*4;let Oe=null;if(t._badOS||t._badDesktopOS||!ce.textureHalfFloat&&!ce.textureFloat)L===128?(Oe=s._GetFloatAsUIntRGBAArrayBuffer(g,_,r.byteOffset+b,x,r.buffer,Fe),u&&Fe==0&&u.push(s._GetFloatRGBAArrayBuffer(g,_,r.byteOffset+b,x,r.buffer,Fe))):L===64&&(Oe=s._GetHalfFloatAsUIntRGBAArrayBuffer(g,_,r.byteOffset+b,x,r.buffer,Fe),u&&Fe==0&&u.push(s._GetHalfFloatAsFloatRGBAArrayBuffer(g,_,r.byteOffset+b,x,r.buffer,Fe))),i.type=0;else{let he=ce.textureFloat&&(h&&ce.textureFloatLinearFiltering||!h),ee=ce.textureHalfFloat&&(h&&ce.textureHalfFloatLinearFiltering||!h),V=(L===128||L===64&&!ee)&&he?1:(L===64||L===128&&!he)&&ee?2:0,Y,J=null;switch(L){case 128:{switch(V){case 1:Y=s._GetFloatRGBAArrayBuffer,J=null;break;case 2:Y=s._GetFloatAsHalfFloatRGBAArrayBuffer,J=s._GetFloatRGBAArrayBuffer;break;case 0:Y=s._GetFloatAsUIntRGBAArrayBuffer,J=s._GetFloatRGBAArrayBuffer;break}break}default:{switch(V){case 1:Y=s._GetHalfFloatAsFloatRGBAArrayBuffer,J=null;break;case 2:Y=s._GetHalfFloatRGBAArrayBuffer,J=s._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:Y=s._GetHalfFloatAsUIntRGBAArrayBuffer,J=s._GetHalfFloatAsFloatRGBAArrayBuffer;break}break}}i.type=V,Oe=Y(g,_,r.byteOffset+b,x,r.buffer,Fe),u&&Fe==0&&u.push(J?J(g,_,r.byteOffset+b,x,r.buffer,Fe):Oe)}Oe&&t._uploadDataToTextureDirectly(i,Oe,ne,Fe)}else if(n.isRGB)i.type=0,L===24?(i.format=4,x=g*_*3,C=s._GetRGBArrayBuffer(g,_,r.byteOffset+b,x,r.buffer,W,$,re),t._uploadDataToTextureDirectly(i,C,ne,Fe)):(i.format=5,x=g*_*4,C=s._GetRGBAArrayBuffer(g,_,r.byteOffset+b,x,r.buffer,W,$,re,we),t._uploadDataToTextureDirectly(i,C,ne,Fe));else if(n.isLuminance){let Oe=t._getUnpackAlignement(),he=g;x=Math.floor((g+Oe-1)/Oe)*Oe*(_-1)+he,C=s._GetLuminanceArrayBuffer(g,_,r.byteOffset+b,x,r.buffer),i.format=1,i.type=0,t._uploadDataToTextureDirectly(i,C,ne,Fe)}else x=Math.max(4,g)/4*Math.max(4,_)/4*A,C=new Uint8Array(r.buffer,r.byteOffset+b,x),i.type=0,t._uploadCompressedDataToTextureDirectly(i,S,g,_,C,ne,Fe)}b+=L?g*_*(L/8):x,g*=.5,_*=.5,g=Math.max(1,g),_=Math.max(1,_)}if(c!==void 0)break}u&&u.length>0?n.sphericalPolynomial=Io.ConvertCubeMapToSphericalPolynomial({size:f[o0],right:u[0],left:u[1],up:u[2],down:u[3],front:u[4],back:u[5],format:5,type:1,gammaSpace:!1}):n.sphericalPolynomial=void 0}}return s.StoreLODInAlphaChannel=!1,s})();at.prototype.createPrefilteredCubeTexture=function(s,e,t,i,r=null,n=null,o,a=null,l=!0){let c=h=>{if(!h){r&&r(null);return}let u=h.texture;if(l?h.info.sphericalPolynomial&&(u._sphericalPolynomial=h.info.sphericalPolynomial):u._sphericalPolynomial=new vs,u._source=ke.CubePrefiltered,this.getCaps().textureLOD){r&&r(u);return}let d=3,f=this._gl,m=h.width;if(!m)return;let g=[];for(let _=0;_<d;_++){let b=1-_/(d-1),C=i,R=xe.Log2(m)*t+i,E=C+(R-C)*b,S=Math.round(Math.min(Math.max(E,0),R)),A=new Je(this,ke.Temp);if(A.type=u.type,A.format=u.format,A.width=Math.pow(2,Math.max(xe.Log2(m)-S,0)),A.height=A.width,A.isCube=!0,A._cachedWrapU=0,A._cachedWrapV=0,this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,A,!0),A.samplingMode=2,f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MIN_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),h.isDDS){let G=h.info,W=h.data;this._unpackFlipY(G.isCompressed),il.UploadDDSLevels(this,A,W,G,!0,6,S)}else F.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null);let L=new Qi(e);L._isCube=!0,L._texture=A,A.isReady=!0,g.push(L)}u._lodTextureHigh=g[2],u._lodTextureMid=g[1],u._lodTextureLow=g[0],r&&r(u)};return this.createCubeTexture(s,e,null,!1,c,n,o,a,l,t,i)};function PY(s){let e=n=>{let o="\\b"+n+"\\b";return s&&(s===n||s.match(new RegExp(o,"g")))};if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(e))return s;let t=s.lastIndexOf("."),i=s.lastIndexOf("?"),r=i>-1?s.substring(i,s.length):"";return(t>-1?s.substring(0,t):s)+this._textureFormatInUse+r}Object.defineProperty(K.prototype,"texturesSupported",{get:function(){let s=[];return this._caps.astc&&s.push("-astc.ktx"),this._caps.s3tc&&s.push("-dxt.ktx"),this._caps.pvrtc&&s.push("-pvrtc.ktx"),this._caps.etc2&&s.push("-etc2.ktx"),this._caps.etc1&&s.push("-etc1.ktx"),s},enumerable:!0,configurable:!0});Object.defineProperty(K.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0});K.prototype.setCompressedTextureExclusions=function(s){this._excludedCompressedTextures=s};K.prototype.setTextureFormatToUse=function(s){let e=this.texturesSupported;for(let t=0,i=e.length;t<i;t++)for(let r=0,n=s.length;r<n;r++)if(e[t]===s[r].toLowerCase())return this._transformTextureUrl=PY.bind(this),this._textureFormatInUse=e[t];return this._textureFormatInUse="",this._transformTextureUrl=null,null};var xm=(()=>{class s{constructor(){let t=new ArrayBuffer(s.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(t),this._int32s=new Int32Array(t),this._float32s=new Float32Array(t),this._length=s.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream(()=>{this._flush()})}writeUint32(t){this._flushIfNecessary(1),this._uint32s[this._position++]=t}writeInt32(t){this._flushIfNecessary(1),this._int32s[this._position++]=t}writeFloat32(t){this._flushIfNecessary(1),this._float32s[this._position++]=t}writeUint32Array(t){this._flushIfNecessary(1+t.length),this._uint32s[this._position++]=t.length,this._uint32s.set(t,this._position),this._position+=t.length}writeInt32Array(t){this._flushIfNecessary(1+t.length),this._uint32s[this._position++]=t.length,this._int32s.set(t,this._position),this._position+=t.length}writeFloat32Array(t){this._flushIfNecessary(1+t.length),this._uint32s[this._position++]=t.length,this._float32s.set(t,this._position),this._position+=t.length}writeNativeData(t){this._flushIfNecessary(t.length),this._uint32s.set(t,this._position),this._position+=t.length}writeBoolean(t){this.writeUint32(t?1:0)}_flushIfNecessary(t){this._position+t>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}return s.DEFAULT_BUFFER_SIZE=65536,s})();var MY="rgbdDecodePixelShader",DY=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}`;D.ShadersStore[MY]=DY;var Id=class{static ExpandRGBDTexture(e){let t=e._texture;if(!t||!e.isRGBD)return;let i=t.getEngine(),r=i.getCaps(),n=t.isReady,o=!1;r.textureHalfFloatRender&&r.textureHalfFloatLinearFiltering?(o=!0,t.type=2):r.textureFloatRender&&r.textureFloatLinearFiltering&&(o=!0,t.type=1),o&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);let a=()=>{let l=new ve("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1);l.externalTextureSamplerBinding=!0;let c=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});l.getEffect().executeWhenCompiled(()=>{l.onApply=h=>{h._bindTexture("textureSampler",t),h.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([l],c,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),l&&l.dispose(),c._swapAndDie(t),t.isReady=!0})};o&&(n?a():e.onLoadObservable.addOnce(a))}static EncodeTextureToRGBD(e,t,i=0){return _m("rgbdEncode",e,t,i,1,5)}};Qi.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(Qi.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=Io.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(s=>{this._texture._sphericalPolynomial=s,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(s){this._texture&&(this._texture._sphericalPolynomial=s)},enumerable:!0,configurable:!0});var OY="rgbdEncodePixelShader",wY=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}`;D.ShadersStore[OY]=wY;var KB="image/png",jB=2,qB=[134,22,135,150,246,214,150,54];function wv(s){let e=new DataView(s.buffer,s.byteOffset,s.byteLength),t=0;for(let o=0;o<qB.length;o++)if(e.getUint8(t++)!==qB[o])return F.Error("Not a babylon environment map"),null;let i="",r=0;for(;r=e.getUint8(t++);)i+=String.fromCharCode(r);let n=JSON.parse(i);return n=Nv(n),n.specular&&(n.specular.specularDataPosition=t,n.specular.lodGenerationScale=n.specular.lodGenerationScale||.8),n}function Nv(s){if(s.version>jB)throw new Error(`Unsupported babylon environment map version "${s.version}". Latest supported version is "${jB}".`);return s.version===2||(s=Kt(ie({},s),{version:2,imageType:KB})),s}function c0(s,e){e=Nv(e);let t=e.specular,i=xe.Log2(e.width);if(i=Math.round(i)+1,t.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);let r=new Array(i);for(let n=0;n<i;n++){r[n]=new Array(6);for(let o=0;o<6;o++){let a=t.mipmaps[n*6+o];r[n][o]=new Uint8Array(s.buffer,s.byteOffset+t.specularDataPosition+a.position,a.length)}}return r}function ZB(s,e,t){t=Nv(t);let i=t.specular;if(!i)return Promise.resolve();s._lodGenerationScale=i.lodGenerationScale;let r=c0(e,t);return l0(s,r,t.imageType)}function QB(s,e,t,i,r,n,o,a,l,c,h){return new Promise((u,d)=>{if(t){let f=e.createTexture(null,!0,!0,null,1,null,m=>{d(m)},s);i.getEffect().executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=m=>{m._bindTexture("textureSampler",f),m.setFloat2("scale",1,e._features.needsInvertingBitmap&&s instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([i],c,!0,n,o),e.restoreDefaultFramebuffer(),f.dispose(),URL.revokeObjectURL(r),u())})}else{if(e._uploadImageToTexture(h,s,n,o),a){let f=l[o];f&&e._uploadImageToTexture(f._texture,s,n,0)}u()}})}function l0(s,e,t=KB){if(!H.IsExponentOfTwo(s.width))throw new Error("Texture size must be a power of two");let i=xe.ILog2(s.width)+1,r=s.getEngine(),n=!1,o=!1,a=null,l=null,c=null,h=r.getCaps();if(s.format=5,s.type=0,s.generateMipMaps=!0,s._cachedAnisotropicFilteringLevel=null,r.updateTextureSamplingMode(3,s),h.textureLOD?r._features.supportRenderAndCopyToLodForFloatTextures?h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering?(n=!0,s.type=2):h.textureFloatRender&&h.textureFloatLinearFiltering&&(n=!0,s.type=1):n=!1:(n=!1,o=!0,c={}),n)a=new ve("rgbdDecode","rgbdDecode",null,null,1,null,3,r,!1,void 0,s.type,void 0,null,!1),s._isRGBD=!1,s.invertY=!1,l=r.createRenderTargetCubeTexture(s.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:s.type,format:5});else if(s._isRGBD=!0,s.invertY=!0,o){let f=s._lodGenerationScale,m=s._lodGenerationOffset;for(let g=0;g<3;g++){let x=1-g/2,b=m,C=(i-1)*f+m,R=b+(C-b)*x,E=Math.round(Math.min(Math.max(R,0),C)),S=new Je(r,ke.Temp);S.isCube=!0,S.invertY=!0,S.generateMipMaps=!1,r.updateTextureSamplingMode(2,S);let A=new Qi(null);switch(A._isCube=!0,A._texture=S,c[E]=A,g){case 0:s._lodTextureLow=A;break;case 1:s._lodTextureMid=A;break;case 2:s._lodTextureHigh=A;break}}}let u=[];for(let d=0;d<e.length;d++)for(let f=0;f<6;f++){let m=e[d][f],g=new Blob([m],{type:t}),_=URL.createObjectURL(g),x;if(r._features.forceBitmapOverHTMLImageElement)x=r.createImageBitmap(g,{premultiplyAlpha:"none"}).then(b=>QB(b,r,n,a,_,f,d,o,c,l,s));else{let b=new Image;b.src=_,x=new Promise((C,R)=>{b.onload=()=>{QB(b,r,n,a,_,f,d,o,c,l,s).then(()=>C()).catch(E=>{R(E)})},b.onerror=E=>{R(E)}})}u.push(x)}if(e.length<i){let d,f=Math.pow(2,i-1-e.length),m=f*f*4;switch(s.type){case 0:{d=new Uint8Array(m);break}case 2:{d=new Uint16Array(m);break}case 1:{d=new Float32Array(m);break}}for(let g=e.length;g<i;g++)for(let _=0;_<6;_++)r._uploadArrayBufferViewToTexture(s,d,_,g)}return Promise.all(u).then(()=>{l&&(r._releaseTexture(s),l._swapAndDie(s)),a&&a.dispose(),o&&(s._lodTextureHigh&&s._lodTextureHigh._texture&&(s._lodTextureHigh._texture.isReady=!0),s._lodTextureMid&&s._lodTextureMid._texture&&(s._lodTextureMid._texture.isReady=!0),s._lodTextureLow&&s._lodTextureLow._texture&&(s._lodTextureLow._texture.isReady=!0))})}function Fv(s,e){e=Nv(e);let t=e.irradiance;if(!t)return;let i=new vs;p.FromArrayToRef(t.x,0,i.x),p.FromArrayToRef(t.y,0,i.y),p.FromArrayToRef(t.z,0,i.z),p.FromArrayToRef(t.xx,0,i.xx),p.FromArrayToRef(t.yy,0,i.yy),p.FromArrayToRef(t.zz,0,i.zz),p.FromArrayToRef(t.yz,0,i.yz),p.FromArrayToRef(t.zx,0,i.zx),p.FromArrayToRef(t.xy,0,i.xy),s._sphericalPolynomial=i}function JB(s,e,t,i,r){let n=s.getEngine().createRawCubeTexture(null,s.width,s.format,s.type,s.generateMipMaps,s.invertY,s.samplingMode,s._compression),o=l0(n,e).then(()=>s);return s.onRebuildCallback=a=>({proxy:o,isReady:!0,isAsync:!0}),s._source=ke.CubeRawRGBD,s._bufferViewArrayArray=e,s._lodGenerationScale=i,s._lodGenerationOffset=r,s._sphericalPolynomial=t,l0(s,e).then(()=>(s.isReady=!0,s))}function vm(s,e,t,i){let r=i,n=0,o="";for(;r<t.length;){let a=t.charAt(r);if(o)a===o?o==='"'||o==="'"?t.charAt(r-1)!=="\\"&&(o=""):o="":o==="*/"&&a==="*"&&r+1<t.length&&(t.charAt(r+1)==="/"&&(o=""),o===""&&r++);else switch(a){case s:n++;break;case e:n--;break;case'"':case"'":case"`":o=a;break;case"/":if(r+1<t.length){let l=t.charAt(r+1);l==="/"?o=`
`:l==="*"&&(o="*/")}break}if(r++,n===0)break}return n===0?r-1:-1}function h0(s,e){for(;e<s.length;){let t=s[e];if(t!==" "&&t!==`
`&&t!=="\r"&&t!=="	"&&t!==`
`&&t!=="\xA0")break;e++}return e}function Lv(s){let e=s.charCodeAt(0);return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||e==95}function Tm(s){let e=0,t="",i=!1,r=[];for(;e<s.length;){let n=s.charAt(e);if(t)n===t?t==='"'||t==="'"?(s.charAt(e-1)!=="\\"&&(t=""),r.push(n)):(t="",i=!1):t==="*/"&&n==="*"&&e+1<s.length?(s.charAt(e+1)==="/"&&(t=""),t===""&&(i=!1,e++)):i||r.push(n);else{switch(n){case'"':case"'":case"`":t=n;break;case"/":if(e+1<s.length){let o=s.charAt(e+1);o==="/"?(t=`
`,i=!0):o==="*"&&(t="*/",i=!0)}break}i||r.push(n)}e++}return r.join("")}function eV(s,e,t,i){for(;e>=0&&s.charAt(e)!==t&&(!i||s.charAt(e)!==i);)e--;return e}function tV(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function fh(s,e,t,i){let r=s.indexOf(e);if(r<0)return s;if(t){for(;r++<s.length&&s.charAt(r)!="{";);if(r<s.length){let n=s.substring(0,r+1),o=s.substring(r+1);s=n+t+o}}if(i){let n=s.lastIndexOf("}");s=s.substring(0,n),s+=i+`
}`}return s}var Rd=(()=>{class s{get code(){return this._sourceCode}constructor(t,i=20){this.debug=!1,this._sourceCode=t,this._numMaxIterations=i,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&F.Log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&F.Log("End of inlining process.")}_collectFunctions(){let t=0;for(;t<this._sourceCode.length;){let i=this._sourceCode.indexOf(this.inlineToken,t);if(i<0)break;let r=this._sourceCode.indexOf("(",i+this.inlineToken.length);if(r<0){this.debug&&F.Warn(`Could not find the opening parenthesis after the token. startIndex=${t}`),t=i+this.inlineToken.length;continue}let n=s._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(i+this.inlineToken.length,r));if(!n){this.debug&&F.Warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(i+this.inlineToken.length,r)}`),t=i+this.inlineToken.length;continue}let[o,a]=[n[3],n[4]],l=vm("(",")",this._sourceCode,r);if(l<0){this.debug&&F.Warn(`Could not extract the parameters the function '${a}' (type=${o}). funcParamsStartIndex=${r}`),t=i+this.inlineToken.length;continue}let c=this._sourceCode.substring(r+1,l),h=h0(this._sourceCode,l+1);if(h===this._sourceCode.length){this.debug&&F.Warn(`Could not extract the body of the function '${a}' (type=${o}). funcParamsEndIndex=${l}`),t=i+this.inlineToken.length;continue}let u=vm("{","}",this._sourceCode,h);if(u<0){this.debug&&F.Warn(`Could not extract the body of the function '${a}' (type=${o}). funcBodyStartIndex=${h}`),t=i+this.inlineToken.length;continue}let d=this._sourceCode.substring(h,u+1),f=Tm(c).split(","),m=[];for(let x=0;x<f.length;++x){let b=f[x].trim(),C=b.lastIndexOf(" ");C>=0&&m.push(b.substring(C+1))}o!=="void"&&m.push("return"),this._functionDescr.push({name:a,type:o,parameters:m,body:d,callIndex:0}),t=u+1;let g=i>0?this._sourceCode.substring(0,i):"",_=u+1<this._sourceCode.length-1?this._sourceCode.substring(u+1):"";this._sourceCode=g+_,t-=u+1-i}this.debug&&F.Log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=${this._functionDescr}`)}_processInlining(t=20){for(;t-->=0&&this._replaceFunctionCallsByCode(););return this.debug&&F.Log(`numMaxIterations is ${t} after inlining process`),t>=0}_replaceFunctionCallsByCode(){let t=!1;for(let i of this._functionDescr){let{name:r,type:n,parameters:o,body:a}=i,l=0;for(;l<this._sourceCode.length;){let c=this._sourceCode.indexOf(r,l);if(c<0)break;if(c===0||Lv(this._sourceCode.charAt(c-1))){l=c+r.length;continue}let h=h0(this._sourceCode,c+r.length);if(h===this._sourceCode.length||this._sourceCode.charAt(h)!=="("){l=c+r.length;continue}let u=vm("(",")",this._sourceCode,h);if(u<0){this.debug&&F.Warn(`Could not extract the parameters of the function call. Function '${r}' (type=${n}). callParamsStartIndex=${h}`),l=c+r.length;continue}let d=this._sourceCode.substring(h+1,u),m=(R=>{let E=[],S=0,A=0;for(;S<R.length;){if(R.charAt(S)==="("){let L=vm("(",")",R,S);if(L<0)return null;S=L}else R.charAt(S)===","&&(E.push(R.substring(A,S)),A=S+1);S++}return A<S&&E.push(R.substring(A,S)),E})(Tm(d));if(m===null){this.debug&&F.Warn(`Invalid function call: can't extract the parameters of the function call. Function '${r}' (type=${n}). callParamsStartIndex=${h}, callParams=`+d),l=c+r.length;continue}let g=[];for(let R=0;R<m.length;++R){let E=m[R].trim();g.push(E)}let _=n!=="void"?r+"_"+i.callIndex++:null;if(_&&g.push(_+" ="),g.length!==o.length){this.debug&&F.Warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${r}' (type=${n}). function parameters=${o}, call parameters=${g}`),l=c+r.length;continue}l=u+1;let x=this._replaceNames(a,o,g),b=c>0?this._sourceCode.substring(0,c):"",C=u+1<this._sourceCode.length-1?this._sourceCode.substring(u+1):"";if(_){let R=eV(this._sourceCode,c-1,`
`,"{");b=this._sourceCode.substring(0,R+1);let E=this._sourceCode.substring(R+1,c);this._sourceCode=b+n+" "+_+`;
`+x+`
`+E+_+C,this.debug&&F.Log(`Replace function call by code. Function '${r}' (type=${n}). injectDeclarationIndex=${R}, call parameters=${g}`)}else this._sourceCode=b+x+C,l+=x.length-(u+1-c),this.debug&&F.Log(`Replace function call by code. Function '${r}' (type=${n}). functionCallIndex=${c}, call parameters=${g}`);t=!0}}return t}_replaceNames(t,i,r){for(let n=0;n<i.length;++n){let o=new RegExp(tV(i[n]),"g"),a=i[n].length,l=r[n];t=t.replace(o,(c,...h)=>{let u=h[0];return Lv(t.charAt(u-1))||Lv(t.charAt(u+a))?i[n]:l})}return t}}return s._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/,s})();var NY=/(flat\s)?\s*varying\s*.*/,Bv=class{constructor(){this.shaderLanguage=pe.GLSL}initializeShaders(e){this._nativeProcessingContext=e,this._nativeProcessingContext&&(this._nativeProcessingContext.remappedAttributeNames={},this._nativeProcessingContext.injectInVertexMain="")}attributeProcessor(e){if(!this._nativeProcessingContext)return e.replace("attribute","in");let i=/\s*(?:attribute|in)\s+(\S+)\s+(\S+)\s*;/gm.exec(e);if(i!==null){let r=i[1],n=i[2],o=this._nativeProcessingContext.vertexBufferKindToNumberOfComponents[n];if(o!==void 0){let a=o<0?o===-1?"int":"ivec"+-o:o===1?"uint":"uvec"+o,l=`_int_${n}_`;e=e.replace(i[0],`in ${a} ${l}; ${r} ${n};`),this._nativeProcessingContext.injectInVertexMain+=`${n} = ${r}(${l});
`,this._nativeProcessingContext.remappedAttributeNames[n]=l}else e=e.replace(i[0],`in ${r} ${n};`)}return e}varyingCheck(e,t){return NY.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){let r=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,n=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(n,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){let o=e.search(/layout *\(location *= *0\) *out/g)!==-1;e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(r||o?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(")}else if(this._nativeProcessingContext?.injectInVertexMain&&(e=fh(e,"void main",this._nativeProcessingContext.injectInVertexMain)),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}};var Vv=class{get isReady(){if(this.compilationError){let e=this.compilationError.message;throw new Error("SHADER ERROR"+(typeof e=="string"?`
`+e:""))}return this.isCompiled}_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}constructor(e,t,i){this.isCompiled=!1,this.vertexBufferKindToType={},this._valueCache={},this._engine=e,this.isAsync=t,this.shaderProcessingContext=i}_fillEffectInformation(e,t,i,r,n,o,a,l){let c=this._engine;if(c.supportsUniformBuffers)for(let d in t)e.bindUniformBlock(d,t[d]);this._engine.getUniforms(this,i).forEach((d,f)=>{r[i[f]]=d}),this._uniforms=r;let u;for(u=0;u<n.length;u++)e.getUniform(n[u])==null&&(n.splice(u,1),u--);n.forEach((d,f)=>{o[d]=f}),l.push(...c.getAttributes(this,a))}setEngine(e){this._engine=e}dispose(){this._uniforms={}}_cacheMatrix(e,t){let i=this._valueCache[e],r=t.updateFlag;return i!==void 0&&i===r?!1:(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r)return r=[t,i],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),n}_cacheFloat3(e,t,i,r){let n=this._valueCache[e];if(!n)return n=[t,i,r],this._valueCache[e]=n,!0;let o=!1;return n[0]!==t&&(n[0]=t,o=!0),n[1]!==i&&(n[1]=i,o=!0),n[2]!==r&&(n[2]=r,o=!0),o}_cacheFloat4(e,t,i,r,n){let o=this._valueCache[e];if(!o)return o=[t,i,r,n],this._valueCache[e]=o,!0;let a=!1;return o[0]!==t&&(o[0]=t,a=!0),o[1]!==i&&(o[1]=i,a=!0),o[2]!==r&&(o[2]=r,a=!0),o[3]!==n&&(o[3]=n,a=!0),a}setInt(e,t){let i=this._valueCache[e];i!==void 0&&i===t||this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setInt4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){let i=this._valueCache[e];i!==void 0&&i===t||this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setUInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setUInt3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setUInt4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setUInt4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this._engine.setMatrices(this._uniforms[e],t.asArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){let i=this._valueCache[e];i!==void 0&&i===t||this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){let i=this._valueCache[e];i!==void 0&&i===t||this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this._engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this._engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&(this._engine.setFloat3(this._uniforms[e],t,i,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,r,n){this._cacheFloat4(e,t,i,r,n)&&(this._engine.setFloat4(this._uniforms[e],t,i,r,n)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}};var Uv=class extends Qa{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,r){super(e,t,i,r),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=r}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}};var Cm=class{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}};function kv(s,e){switch(s){case 15:return _native.Engine.TEXTURE_FORMAT_D16;case 16:return _native.Engine.TEXTURE_FORMAT_D24;case 13:return _native.Engine.TEXTURE_FORMAT_D24S8;case 14:return _native.Engine.TEXTURE_FORMAT_D32F;case 36492:return _native.Engine.TEXTURE_FORMAT_BC7;case 36494:return _native.Engine.TEXTURE_FORMAT_BC6H;case 33779:return _native.Engine.TEXTURE_FORMAT_BC3;case 33778:return _native.Engine.TEXTURE_FORMAT_BC2;case 33777:return _native.Engine.TEXTURE_FORMAT_BC1;case 33776:return _native.Engine.TEXTURE_FORMAT_BC1;case 37808:return _native.Engine.TEXTURE_FORMAT_ASTC4x4;case 36196:return _native.Engine.TEXTURE_FORMAT_ETC1;case 37492:return _native.Engine.TEXTURE_FORMAT_ETC2;case 37496:return _native.Engine.TEXTURE_FORMAT_ETC2A;case 4:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_RGB8;case 3:return _native.Engine.TEXTURE_FORMAT_RGB8S;case 6:return _native.Engine.TEXTURE_FORMAT_RGB8I;case 7:return _native.Engine.TEXTURE_FORMAT_RGB8U}break}case 5:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_RGBA8;case 1:return _native.Engine.TEXTURE_FORMAT_RGBA32F;case 2:return _native.Engine.TEXTURE_FORMAT_RGBA16F;case 3:return _native.Engine.TEXTURE_FORMAT_RGBA8S;case 4:return _native.Engine.TEXTURE_FORMAT_RGBA16I;case 5:return _native.Engine.TEXTURE_FORMAT_RGBA16U;case 6:return _native.Engine.TEXTURE_FORMAT_RGBA32I;case 7:return _native.Engine.TEXTURE_FORMAT_RGBA32U}break}case 6:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_R8;case 1:return _native.Engine.TEXTURE_FORMAT_R32F;case 2:return _native.Engine.TEXTURE_FORMAT_R16F;case 3:return _native.Engine.TEXTURE_FORMAT_R8S;case 4:return _native.Engine.TEXTURE_FORMAT_R16S;case 5:return _native.Engine.TEXTURE_FORMAT_R16U;case 6:return _native.Engine.TEXTURE_FORMAT_R32I;case 7:return _native.Engine.TEXTURE_FORMAT_R32U}break}case 7:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_RG8;case 1:return _native.Engine.TEXTURE_FORMAT_RG32F;case 2:return _native.Engine.TEXTURE_FORMAT_RG16F;case 3:return _native.Engine.TEXTURE_FORMAT_RG8S;case 4:return _native.Engine.TEXTURE_FORMAT_RG16S;case 5:return _native.Engine.TEXTURE_FORMAT_RG16U;case 6:return _native.Engine.TEXTURE_FORMAT_RG32I;case 7:return _native.Engine.TEXTURE_FORMAT_RG32U}break}case 12:{switch(e){case 0:return _native.Engine.TEXTURE_FORMAT_BGRA8}break}}throw new Wo(`Unsupported texture format or type: format ${s}, type ${e}.`,zo.UnsupportedTextureError)}function Pd(s){switch(s){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${s}.`)}}function Gv(s){switch(s){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+s+".")}}function iV(s){switch(s){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${s}.`)}}function rV(s){switch(s){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${s}.`)}}function sV(s){switch(s){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${s}.`)}}function nV(s){switch(s){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${s}.`)}}function oV(s){switch(s){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${s}.`)}}function aV(s){switch(s){case y.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case y.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case y.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case y.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case y.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${s}.`)}}var FY={[y.PositionKind]:!0,[y.NormalKind]:!0,[y.TangentKind]:!0,[y.UVKind]:!0,[y.UV2Kind]:!0,[y.UV3Kind]:!0,[y.UV4Kind]:!0,[y.UV5Kind]:!0,[y.UV6Kind]:!0,[y.ColorKind]:!0,[y.ColorInstanceKind]:!0,[y.MatricesIndicesKind]:!0,[y.MatricesWeightsKind]:!0,[y.MatricesIndicesExtraKind]:!0,[y.MatricesWeightsExtraKind]:!0};function LY(s){switch(s){case y.BYTE:case y.SHORT:case y.INT:case y.FLOAT:return!0;case y.UNSIGNED_BYTE:case y.UNSIGNED_SHORT:case y.UNSIGNED_INT:return!1;default:throw new Error(`Invalid type '${s}'`)}}function zv(s,e){let t=e.getEngine(),i=e._pipelineContext;if(!i?.vertexBufferKindToType)return;let r=null;for(let n in s){let o=s[n];if(!o||!FY[n])continue;let a=o.normalized?y.FLOAT:o.type,l=i.vertexBufferKindToType[n];(a!==y.FLOAT&&l===void 0||l!==void 0&&l!==a)&&(r||(r=t._getShaderProcessingContext(e.shaderLanguage)),i.vertexBufferKindToType[n]=a,a!==y.FLOAT&&(r.vertexBufferKindToNumberOfComponents[n]=y.DeduceStride(n),LY(a)&&(r.vertexBufferKindToNumberOfComponents[n]*=-1)))}if(r){let n=t._caps.parallelShaderCompile;t._caps.parallelShaderCompile=void 0,e._processShaderCode(null,t._features._checkNonFloatVertexBuffersDontRecreatePipelineContext,r),t._caps.parallelShaderCompile=n}}var Wv=class{constructor(){this.vertexBufferKindToNumberOfComponents={},this.remappedAttributeNames={},this.injectInVertexMain=""}};var lV=new U;if(typeof self<"u"&&!Object.prototype.hasOwnProperty.call(self,"_native")){let s;Object.defineProperty(self,"_native",{get:()=>s,set:e=>{s=e,s&&lV.notifyObservers(s)}})}function BY(){return new Promise(s=>{typeof _native>"u"?lV.addOnce(e=>s(e)):s(_native)})}function cV(s,e){return $e(this,null,function*(){(yield BY())[s]=e})}var Hv=class extends Uf{},d0=class{constructor(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=f0._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}},u0=[],f0=(()=>{class s extends K{setHardwareScalingLevel(t){super.setHardwareScalingLevel(t),this._engine.setHardwareScalingLevel(t)}constructor(t={}){if(super(null,!1,void 0,t.adaptToDeviceRatio),this._engine=new _native.Engine({version:K.Version,nonFloatVertexBuffers:!0}),this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new d0(this._engine),this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,_native.Engine.PROTOCOL_VERSION!==s.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${s.PROTOCOL_VERSION} (JS)`);this._engine.setDeviceLostCallback&&this._engine.setDeviceLostCallback(()=>{this.onContextLostObservable.notifyObservers(this),this._contextWasLost=!0,this._restoreEngineAfterContextLost()}),this._webGLVersion=2,this.disableUniformBuffers=!0,this._shaderPlatformName="NATIVE",this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,textureFloat:!0,textureFloatLinearFiltering:!0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:16,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS,disableMorphTargetTexture:!1,parallelShaderCompile:{COMPLETION_STATUS_KHR:0}},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!0,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1},H.Log("Babylon Native (v"+K.Version+") launched"),H.LoadScript=function(n,o,a,l){H.LoadFile(n,c=>{Function(c).apply(null),o&&o()},void 0,void 0,!1,(c,h)=>{a&&a("LoadScript Error",h)})},typeof URL>"u"&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob>"u"&&(window.Blob=function(n){return n}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function n(){let o=isNaN(arguments[0])?1:Number(arguments[0]);return o?Array.prototype.reduce.call(this,function(a,l){return Array.isArray(l)?a.push.apply(a,n.call(l,o-1)):a.push(l),a},[]):Array.prototype.slice.call(this)},writable:!0});let i=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=t.adaptToDeviceRatio?1/i:1,this._engine.setHardwareScalingLevel(this._hardwareScalingLevel),this._lastDevicePixelRatio=i,this.resize();let r=this.getDepthFunction();r&&this.setDepthFunction(r),this._shaderProcessor=new Bv,this.onNewSceneAddedObservable.add(n=>{let o=n.render;n.render=(...a)=>{this._commandBufferEncoder.beginCommandScope(),o.apply(n,a),this._commandBufferEncoder.endCommandScope()}})}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new xm}_queueNewFrame(t,i){return i.requestAnimationFrame&&i!==window?i.requestAnimationFrame(t):this._engine.requestAnimationFrame(t),0}_restoreEngineAfterContextLost(){this._clearEmptyResources();let t=this._depthCullingState.depthTest,i=this._depthCullingState.depthFunc,r=this._depthCullingState.depthMask,n=this._stencilState.stencilTest;this._rebuildGraphicsResources(),this._depthCullingState.depthTest=t,this._depthCullingState.depthFunc=i,this._depthCullingState.depthMask=r,this._stencilState.stencilTest=n,this._flagContextRestored()}_bindUnboundFramebuffer(t){this._currentFramebuffer!==t&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=t)}getHostDocument(){return null}clear(t,i,r,n=!1){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(i&&t?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t?t.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(n?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(t,i,r){let n=this._normalizeIndexData(t),o=new Hv;return o.references=1,o.is32Bits=n.BYTES_PER_ELEMENT===4,n.byteLength&&(o.nativeIndexBuffer=this._engine.createIndexBuffer(n.buffer,n.byteOffset,n.byteLength,o.is32Bits,i??!1)),o}createVertexBuffer(t,i,r){let n=ArrayBuffer.isView(t)?t:new Float32Array(t),o=new Hv;return o.references=1,n.byteLength&&(o.nativeVertexBuffer=this._engine.createVertexBuffer(n.buffer,n.byteOffset,n.byteLength,i??!1)),o}_recordVertexArrayObject(t,i,r,n,o){n._checkedNonFloatVertexBuffers||(zv(i,n),n._checkedNonFloatVertexBuffers=!0),r&&this._engine.recordIndexBuffer(t,r.nativeIndexBuffer);let a=n.getAttributesNames();for(let l=0;l<a.length;l++){let c=n.getAttributeLocation(l);if(c>=0){let h=a[l],u=null;if(o&&(u=o[h]),u||(u=i[h]),u){let d=u.effectiveBuffer;d&&d.nativeVertexBuffer&&this._engine.recordVertexBuffer(t,d.nativeVertexBuffer,c,u.effectiveByteOffset,u.effectiveByteStride,u.getSize(),aV(u.type),u.normalized,u.getInstanceDivisor())}}}}bindBuffers(t,i,r){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,t,i,r),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(t,i,r,n){let o=this._engine.createVertexArray();return this._recordVertexArrayObject(o,t,i,r,n),o}_deleteVertexArray(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(t){this._deleteVertexArray(t)}getAttributes(t,i){let r=t,n=r.shaderProcessingContext;u0.length=0;for(let o=0;o<i.length;o++){let a=i[o],l=n.remappedAttributeNames[a]??a;u0[o]=l}return this._engine.getAttributes(r.program,u0)}drawElementsType(t,i,r,n){this._drawCalls.addCount(1,!1),n&&_native.Engine.COMMAND_DRAWINDEXEDINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXEDINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(n)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)),this._commandBufferEncoder.finishEncodingCommand()}drawArraysType(t,i,r,n){this._drawCalls.addCount(1,!1),n&&_native.Engine.COMMAND_DRAWINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(n)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)),this._commandBufferEncoder.finishEncodingCommand()}createPipelineContext(t){let i=!!(this._caps.parallelShaderCompile&&this._engine.createProgramAsync);return new Vv(this,i,t)}createMaterialContext(){}createDrawContext(){}_preparePipelineContext(t,i,r,n,o,a,l,c){n?this.createRawShaderProgram():this.createShaderProgram(t,i,r,c)}_getShaderProcessingContext(t){return new Wv}_executeWhenRenderingStateIsCompiled(t,i){let r=t;if(r.isAsync)if(r.onCompiled){let n=r.onCompiled;r.onCompiled=()=>{n(),i()}}else r.onCompiled=i;else i()}createRawShaderProgram(){throw new Error("Not Supported")}createShaderProgram(t,i,r,n){let o=t;this.onBeforeShaderCompilationObservable.notifyObservers(this);let a=new Rd(i);a.processCode(),i=a.code;let l=new Rd(r);l.processCode(),r=l.code,i=at._ConcatenateShader(i,n),r=at._ConcatenateShader(r,n);let c=()=>{o.isCompiled=!0,o.onCompiled?.(),this.onAfterShaderCompilationObservable.notifyObservers(this)};if(t.isAsync)o.program=this._engine.createProgramAsync(i,r,c,h=>{o.compilationError=h});else try{o.program=this._engine.createProgram(i,r),c()}catch(h){let u=h?.message;throw new Error("SHADER ERROR"+(typeof u=="string"?`
`+u:""))}return o.program}inlineShaderCode(t){let i=new Rd(t);return i.debug=!1,i.processCode(),i.code}_setProgram(t){this._currentProgram!==t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=t)}_deletePipelineContext(t){let i=t;i&&i.program&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(i.program),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(t,i){let r=t;return this._engine.getUniforms(r.program,i)}bindUniformBlock(t,i,r){throw new Error("Not Implemented")}bindSamplers(t){let i=t.getPipelineContext();this._setProgram(i.program);let r=t.getSamplers();for(let n=0;n<r.length;n++){let o=t.getUniform(r[n]);o&&(this._boundUniforms[n]=o)}this._currentEffect=null}getRenderWidth(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(t=!1){return!t&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(t,i,r){this._cachedViewport=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.x),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.y),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.width),this._commandBufferEncoder.encodeCommandArgAsFloat32(t.height),this._commandBufferEncoder.finishEncodingCommand()}enableScissor(t,i,r,n){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.finishEncodingCommand()}disableScissor(){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.finishEncodingCommand()}setState(t,i=0,r,n=!1,o,a,l=0){this._zOffset=i,this._zOffsetUnits=l,this._zOffset!==0&&H.Warn("zOffset is not supported in Native engine."),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(t?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(l),this._commandBufferEncoder.encodeCommandArgAsUInt32(this.cullBackFaces??o??!0?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(n?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(t){t!==this._zOffset&&(this._zOffset=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-t:t),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(t){t!==this._zOffsetUnits&&(this._zOffsetUnits=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-t:t),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(t?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(t){let i=0;switch(t){case 512:i=_native.Engine.DEPTH_TEST_NEVER;break;case 519:i=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:i=_native.Engine.DEPTH_TEST_GREATER;break;case 518:i=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:i=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:i=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:i=_native.Engine.DEPTH_TEST_LESS;break;case 515:i=_native.Engine.DEPTH_TEST_LEQUAL;break}this._currentDepthTest=i,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(t){this._depthWrite=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(t)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(t){this._colorWrite=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(t)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,rV(this._stencilOpStencilFail),sV(this._stencilOpDepthFail),nV(this._stencilOpStencilDepthPass),iV(this._stencilFunc),this._stencilFuncRef)}_setStencil(t,i,r,n,o,a){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.encodeCommandArgAsUInt32(o),this._commandBufferEncoder.encodeCommandArgAsUInt32(a),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(t){this._stencilTest=t,t?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(t){this._stencilOpStencilDepthPass=t,this.applyStencil()}setStencilMask(t){this._stencilMask=t,this.applyStencil()}setStencilFunction(t){this._stencilFunc=t,this.applyStencil()}setStencilFunctionReference(t){this._stencilFuncRef=t,this.applyStencil()}setStencilFunctionMask(t){this._stencilFuncMask=t}setStencilOperationFail(t){this._stencilOpStencilFail=t,this.applyStencil()}setStencilOperationDepthFail(t){this._stencilOpDepthFail=t,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(t,i,r,n){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(t,i=!1){if(this._alphaMode===t)return;let r=oV(t);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.finishEncodingCommand(),i||this.setDepthWrite(t===0),this._alphaMode=t}setInt(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray2(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray3(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray4(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsInt32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray2(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray3(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray4(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setArray(t,i){return t?this.setFloatArray(t,new Float32Array(i)):!1}setArray2(t,i){return t?this.setFloatArray2(t,new Float32Array(i)):!1}setArray3(t,i){return t?this.setFloatArray3(t,new Float32Array(i)):!1}setArray4(t,i){return t?this.setFloatArray4(t,new Float32Array(i)):!1}setMatrices(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setMatrix3x3(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setMatrix2x2(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat(t,i){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat2(t,i,r){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat3(t,i,r,n){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat4(t,i,r,n,o){return t?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.encodeCommandArgAsFloat32(n),this._commandBufferEncoder.encodeCommandArgAsFloat32(o),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setColor3(t,i){return t?(this.setFloat3(t,i.r,i.g,i.b),!0):!1}setColor4(t,i,r){return t?(this.setFloat4(t,i.r,i.g,i.b,r),!0):!1}wipeCaches(t){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,t&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(t){t&&this._engine.deleteTexture(t.underlyingResource)}updateDynamicTexture(t,i,r,n=!1,o){if(n===void 0&&(n=!1),t&&t._hardwareTexture){let a=i.getCanvasTexture(),l=t._hardwareTexture.underlyingResource;this._engine.copyTexture(l,a),t.isReady=!0}}createDynamicTexture(t,i,r,n){return t=Math.max(t,1),i=Math.max(i,1),this.createRawTexture(new Uint8Array(t*i*4),t,i,5,!1,!1,n)}createVideoElement(t){return this._camera?this._camera.createVideo(t):null}updateVideoTexture(t,i,r){if(t&&t._hardwareTexture&&this._camera){let n=t._hardwareTexture.underlyingResource;this._camera.updateVideoTexture(n,i,r)}}createRawTexture(t,i,r,n,o,a,l,c=null,h=0,u=0,d=!1){let f=new Je(this,ke.Raw);if(f.format=n,f.generateMipMaps=o,f.samplingMode=l,f.invertY=a,f.baseWidth=i,f.baseHeight=r,f.width=f.baseWidth,f.height=f.baseHeight,f._compression=c,f.type=h,f._useSRGBBuffer=this._getUseSRGBBuffer(d,!o),this.updateRawTexture(f,t,n,a,c,h,f._useSRGBBuffer),f._hardwareTexture){let m=f._hardwareTexture.underlyingResource,g=Pd(l);this._setTextureSampling(m,g)}return this._internalTexturesCache.push(f),f}createRawTexture2DArray(t,i,r,n,o,a,l,c,h=null,u=0){let d=new Je(this,ke.Raw2DArray);if(d.baseWidth=i,d.baseHeight=r,d.baseDepth=n,d.width=i,d.height=r,d.depth=n,d.format=o,d.type=u,d.generateMipMaps=a,d.samplingMode=c,d.is2DArray=!0,d._hardwareTexture){let f=d._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(f,t,i,r,n,kv(o,u),a,l);let m=Pd(c);this._setTextureSampling(f,m)}return d.isReady=!0,this._internalTexturesCache.push(d),d}updateRawTexture(t,i,r,n,o=null,a=0,l=!1){if(t){if(i&&t._hardwareTexture){let c=t._hardwareTexture.underlyingResource;this._engine.loadRawTexture(c,i,t.width,t.height,kv(r,a),t.generateMipMaps,t.invertY)}t.isReady=!0}}createTexture(t,i,r,n,o=3,a=null,l=null,c=null,h=null,u=null,d=null,f,m,g,_=!1){t=t||"";let x=t.substr(0,5)==="data:",b=x&&t.indexOf(";base64,")!==-1,C=h||new Je(this,ke.Url),R=t;this._transformTextureUrl&&!b&&!h&&!c&&(t=this._transformTextureUrl(t));let E=t.lastIndexOf("."),S=d||(E>-1?t.substring(E).toLowerCase():""),A=null;for(let W of Se._TextureLoaders)if(W.canLoad(S)){A=W;break}n&&n.addPendingData(C),C.url=t,C.generateMipMaps=!i,C.samplingMode=o,C.invertY=r,C._useSRGBBuffer=this._getUseSRGBBuffer(_,i),this.doNotHandleContextLost||(C._buffer=c);let L=null;a&&!h&&(L=C.onLoadedObservable.add(a)),h||this._internalTexturesCache.push(C);let G=(W,$)=>{n&&n.removePendingData(C),t===R?(L&&C.onLoadedObservable.remove(L),me.UseFallbackTexture&&this.createTexture(me.FallbackTexture,i,C.invertY,n,o,null,l,c,C),l&&l((W||"Unknown error")+(me.UseFallbackTexture?" - Fallback texture was used":""),$)):(F.Warn(`Failed to load ${t}, falling back to ${R}`),this.createTexture(R,i,C.invertY,n,o,a,l,c,C,u,d,f,m))};if(A)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{let W=$=>{if(!C._hardwareTexture){n&&n.removePendingData(C);return}let re=C._hardwareTexture.underlyingResource;this._engine.loadTexture(re,$,!i,r,C._useSRGBBuffer,()=>{C.baseWidth=this._engine.getTextureWidth(re),C.baseHeight=this._engine.getTextureHeight(re),C.width=C.baseWidth,C.height=C.baseHeight,C.isReady=!0;let we=Pd(o);this._setTextureSampling(re,we),n&&n.removePendingData(C),C.onLoadedObservable.notifyObservers(C),C.onLoadedObservable.clear()},()=>{throw new Error("Could not load a native texture.")})};if(x&&c)if(c instanceof ArrayBuffer)W(new Uint8Array(c));else if(ArrayBuffer.isView(c))W(c);else if(typeof c=="string")W(new Uint8Array(H.DecodeBase64(c)));else throw new Error("Unsupported buffer type");else b?W(new Uint8Array(H.DecodeBase64(t))):this._loadFile(t,$=>W(new Uint8Array($)),void 0,void 0,!0,($,re)=>{G("Unable to load "+($&&$.responseURL,re))})}return C}wrapNativeTexture(t,i=!1,r=3){let n=new Cm(t,this._engine),o=new Je(this,ke.Unknown,!0);return o._hardwareTexture=n,o.baseWidth=this._engine.getTextureWidth(t),o.baseHeight=this._engine.getTextureHeight(t),o.width=o.baseWidth,o.height=o.baseHeight,o.isReady=!0,o.useMipMaps=i,this.updateTextureSamplingMode(r,o),o}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(t,i,r){let n=i.generateStencil||!1,o=i.samples||1,a=r,l=new Je(this,ke.DepthStencil),c=t.width??t,h=t.height??t,u=this._engine.createFrameBuffer(l._hardwareTexture.underlyingResource,c,h,n,!0,o);return a._framebufferDepthStencil=u,l}_releaseFramebufferObjects(t){t&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand())}_createImageBitmapFromSource(t,i){return new Promise((n,o)=>{let a=this.createCanvasImage();a.onload=()=>{try{let l=this._engine.createImageBitmap(a);n(l)}catch(l){o(`Error loading image ${a.src} with exception: ${l}`)}},a.onerror=l=>{o(`Error loading image ${a.src} with exception: ${l}`)},a.src=t})}createImageBitmap(t,i){return new Promise((r,n)=>{if(Array.isArray(t)){let o=t;if(o.length){let a=this._engine.createImageBitmap(o[0]);if(a){r(a);return}}}n("Unsupported data for createImageBitmap.")})}resizeImageBitmap(t,i,r){return this._engine.resizeImageBitmap(t,i,r)}createCubeTexture(t,i,r,n,o=null,a=null,l,c=null,h=!1,u=0,d=0,f=null,m,g=!1,_=null){let x=f||new Je(this,ke.Cube);x.isCube=!0,x.url=t,x.generateMipMaps=!n,x._lodGenerationScale=u,x._lodGenerationOffset=d,x._useSRGBBuffer=this._getUseSRGBBuffer(g,!!n),this._doNotHandleContextLost||(x._extension=c,x._files=r,x._buffer=_);let b=t.lastIndexOf(".");if((c||(b>-1?t.substring(b).toLowerCase():""))===".env"){let R=E=>{let S=wv(E);x.width=S.width,x.height=S.width,Fv(x,S);let A=S.specular;if(!A)throw new Error("Nothing else parsed so far");x._lodGenerationScale=A.lodGenerationScale;let L=c0(E,S);x.format=5,x.type=0,x.generateMipMaps=!0,x.getEngine().updateTextureSamplingMode(z.TRILINEAR_SAMPLINGMODE,x),x._isRGBD=!0,x.invertY=!0,this._engine.loadCubeTextureWithMips(x._hardwareTexture.underlyingResource,L,!1,x._useSRGBBuffer,()=>{x.isReady=!0,o&&o()},()=>{throw new Error("Could not load a native cube texture.")})};if(_)R(_);else{if(r&&r.length===6)throw new Error("Multi-file loading not allowed on env files.");{let E=(S,A)=>{a&&S&&a(S.status+" "+S.statusText,A)};this._loadFile(t,S=>{R(new Uint8Array(S,0,S.byteLength))},void 0,void 0,!0,E)}}}else{if(!r||r.length!==6)throw new Error("Cannot load cubemap because 6 files were not defined");let R=[r[0],r[3],r[1],r[4],r[2],r[5]];Promise.all(R.map(E=>this._loadFileAsync(E,void 0,!0).then(S=>new Uint8Array(S,0,S.byteLength)))).then(E=>new Promise((S,A)=>{this._engine.loadCubeTexture(x._hardwareTexture.underlyingResource,E,!n,!0,x._useSRGBBuffer,S,A)})).then(()=>{x.isReady=!0,o&&o()},E=>{a&&a(`Failed to load cubemap: ${E.message}`,E)})}return this._internalTexturesCache.push(x),x}_createHardwareTexture(){return new Cm(this._createTexture(),this._engine)}_createHardwareRenderTargetWrapper(t,i,r){let n=new Uv(t,i,r,this);return this._renderTargetWrapperCache.push(n),n}_createInternalTexture(t,i,r=!0,n=ke.Unknown){let o=!1,a=0,l=3,c=5,h=!1,u=1,d;i!==void 0&&typeof i=="object"?(o=!!i.generateMipMaps,a=i.type===void 0?0:i.type,l=i.samplingMode===void 0?3:i.samplingMode,c=i.format===void 0?5:i.format,h=i.useSRGBBuffer===void 0?!1:i.useSRGBBuffer,u=i.samples??1,d=i.label):o=!!i,h=this._getUseSRGBBuffer(h,!o),(a===1&&!this._caps.textureFloatLinearFiltering||a===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l=1),a===1&&!this._caps.textureFloat&&(a=0,F.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));let f=new Je(this,n),m=t.width??t,g=t.height??t,_=t.layers||0;if(_!==0)throw new Error("Texture layers are not supported in Babylon Native");let x=f._hardwareTexture.underlyingResource,b=kv(c,a);return this._engine.initializeTexture(x,m,g,o,b,!0,h,u),this._setTextureSampling(x,Pd(l)),f._useSRGBBuffer=h,f.baseWidth=m,f.baseHeight=g,f.width=m,f.height=g,f.depth=_,f.isReady=!0,f.samples=u,f.generateMipMaps=o,f.samplingMode=l,f.type=a,f.format=c,f.label=d,this._internalTexturesCache.push(f),f}createRenderTargetTexture(t,i){let r=this._createHardwareRenderTargetWrapper(!1,!1,t),n=!0,o=!1,a=!1,l,c=1;i!==void 0&&typeof i=="object"&&(n=i.generateDepthBuffer??!0,o=!!i.generateStencilBuffer,a=!!i.noColorAttachment,l=i.colorAttachment,c=i.samples??1);let h=l||(a?null:this._createInternalTexture(t,i,!0,ke.RenderTarget)),u=t.width??t,d=t.height??t,f=this._engine.createFrameBuffer(h?h._hardwareTexture.underlyingResource:null,u,d,o,n,c);return r._framebuffer=f,r._generateDepthBuffer=n,r._generateStencilBuffer=o,r._samples=c,r.setTextures(h),r}updateRenderTargetTextureSampleCount(t,i){return F.Warn("Updating render target sample count is not currently supported"),t.samples}updateTextureSamplingMode(t,i){if(i._hardwareTexture){let r=Pd(t);this._setTextureSampling(i._hardwareTexture.underlyingResource,r)}i.samplingMode=t}bindFramebuffer(t,i,r,n,o){let a=t;if(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=t,i)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(r||n)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");a._framebufferDepthStencil?this._bindUnboundFramebuffer(a._framebufferDepthStencil):this._bindUnboundFramebuffer(a._framebuffer)}unBindFramebuffer(t,i=!1,r){this._currentRenderTarget=null,r&&r(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(t){return this.createVertexBuffer(t,!0)}updateDynamicIndexBuffer(t,i,r=0){let n=t,o=this._normalizeIndexData(i);n.is32Bits=o.BYTES_PER_ELEMENT===4,this._engine.updateDynamicIndexBuffer(n.nativeIndexBuffer,o.buffer,o.byteOffset,o.byteLength,r)}updateDynamicVertexBuffer(t,i,r=0,n){let o=t,a=i instanceof Array?new Float32Array(i):i instanceof ArrayBuffer?new Uint8Array(i):i,l=new Uint8Array(a.buffer,a.byteOffset,n??a.byteLength);this._engine.updateDynamicVertexBuffer(o.nativeVertexBuffer,l.buffer,l.byteOffset,l.byteLength,r)}_setTexture(t,i,r=!1,n=!1){let o=this._boundUniforms[t];if(!o)return!1;if(!i)return this._boundTexturesCache[t]!=null&&(this._activeChannel=t,this._boundTexturesCache[t]=null,this._unsetNativeTexture(o)),!1;if(i.video)this._activeChannel=t,i.update();else if(i.delayLoadState===4)return i.delayLoad(),!1;let a;return n?a=i.depthStencilTexture:i.isReady()?a=i.getInternalTexture():i.isCube?a=this.emptyCubeTexture:i.is3D?a=this.emptyTexture3D:i.is2DArray?a=this.emptyTexture2DArray:a=this.emptyTexture,this._activeChannel=t,!a||!a._hardwareTexture?!1:(this._setTextureWrapMode(a._hardwareTexture.underlyingResource,Gv(i.wrapU),Gv(i.wrapV),Gv(i.wrapR)),this._updateAnisotropicLevel(i),this._setNativeTexture(o,a._hardwareTexture.underlyingResource),!0)}_setTextureSampling(t,i){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(t,i,r,n){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()}_setNativeTexture(t,i){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.encodeCommandArgAsNativeData(i),this._commandBufferEncoder.finishEncodingCommand()}_unsetNativeTexture(t){_native.Engine.COMMAND_UNSETTEXTURE&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNSETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand())}_updateAnisotropicLevel(t){let i=t.getInternalTexture(),r=t.anisotropicFilteringLevel;!i||!i._hardwareTexture||i._cachedAnisotropicFilteringLevel!==r&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(i._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.finishEncodingCommand(),i._cachedAnisotropicFilteringLevel=r)}_bindTexture(t,i){let r=this._boundUniforms[t];if(r)if(i&&i._hardwareTexture){let n=i._hardwareTexture.underlyingResource;this._setNativeTexture(r,n)}else this._unsetNativeTexture(r)}unbindAllTextures(){_native.Engine.COMMAND_DISCARDALLTEXTURES&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DISCARDALLTEXTURES),this._commandBufferEncoder.finishEncodingCommand())}_deleteBuffer(t){t.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete t.nativeIndexBuffer),t.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete t.nativeVertexBuffer)}createCanvas(t,i){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");let r=new _native.Canvas;return r.width=t,r.height=i,r}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}updateTextureData(t,i,r,n,o,a,l=0,c=0,h=!1){throw new Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(t,i,r,n,o,a=0,l=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(t,i,r=0,n=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(t,i,r=0,n=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(t,i,r=0,n=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}getFontOffset(t){return{ascent:0,height:0,descent:0}}flushFramebuffer(){}_readTexturePixels(t,i,r,n,o,a,l,c,h,u){if(n!==void 0&&n!==-1)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${n}.`);return this._engine.readTexture(t._hardwareTexture?.underlyingResource,o??0,h??0,u??0,i,r,a?.buffer??null,a?.byteOffset??0,a?.byteLength??0).then(d=>(a||(a=new Uint8Array(d)),a))}}return s.PROTOCOL_VERSION=8,s})();f0._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new p0:new xm};var p0=class extends xm{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}};var Ro=function(s){return s.DepthClipControl="depth-clip-control",s.Depth32FloatStencil8="depth32float-stencil8",s.TextureCompressionBC="texture-compression-bc",s.TextureCompressionETC2="texture-compression-etc2",s.TextureCompressionASTC="texture-compression-astc",s.TimestampQuery="timestamp-query",s.IndirectFirstInstance="indirect-first-instance",s.ShaderF16="shader-f16",s.RG11B10UFloatRenderable="rg11b10ufloat-renderable",s.BGRA8UnormStorage="bgra8unorm-storage",s.Float32Filterable="float32-filterable",s}(Ro||{});var kt=function(s){return s[s.MapRead=1]="MapRead",s[s.MapWrite=2]="MapWrite",s[s.CopySrc=4]="CopySrc",s[s.CopyDst=8]="CopyDst",s[s.Index=16]="Index",s[s.Vertex=32]="Vertex",s[s.Uniform=64]="Uniform",s[s.Storage=128]="Storage",s[s.Indirect=256]="Indirect",s[s.QueryResolve=512]="QueryResolve",s}(kt||{}),rl=function(s){return s[s.Read=1]="Read",s[s.Write=2]="Write",s}(rl||{}),Tn=function(s){return s.E1d="1d",s.E2d="2d",s.E3d="3d",s}(Tn||{}),pi=function(s){return s[s.CopySrc=1]="CopySrc",s[s.CopyDst=2]="CopyDst",s[s.TextureBinding=4]="TextureBinding",s[s.StorageBinding=8]="StorageBinding",s[s.RenderAttachment=16]="RenderAttachment",s}(pi||{}),dt=function(s){return s.E1d="1d",s.E2d="2d",s.E2dArray="2d-array",s.Cube="cube",s.CubeArray="cube-array",s.E3d="3d",s}(dt||{}),Cn=function(s){return s.All="all",s.StencilOnly="stencil-only",s.DepthOnly="depth-only",s}(Cn||{}),B=function(s){return s.R8Unorm="r8unorm",s.R8Snorm="r8snorm",s.R8Uint="r8uint",s.R8Sint="r8sint",s.R16Uint="r16uint",s.R16Sint="r16sint",s.R16Float="r16float",s.RG8Unorm="rg8unorm",s.RG8Snorm="rg8snorm",s.RG8Uint="rg8uint",s.RG8Sint="rg8sint",s.R32Uint="r32uint",s.R32Sint="r32sint",s.R32Float="r32float",s.RG16Uint="rg16uint",s.RG16Sint="rg16sint",s.RG16Float="rg16float",s.RGBA8Unorm="rgba8unorm",s.RGBA8UnormSRGB="rgba8unorm-srgb",s.RGBA8Snorm="rgba8snorm",s.RGBA8Uint="rgba8uint",s.RGBA8Sint="rgba8sint",s.BGRA8Unorm="bgra8unorm",s.BGRA8UnormSRGB="bgra8unorm-srgb",s.RGB9E5UFloat="rgb9e5ufloat",s.RGB10A2UINT="rgb10a2uint",s.RGB10A2Unorm="rgb10a2unorm",s.RG11B10UFloat="rg11b10ufloat",s.RG32Uint="rg32uint",s.RG32Sint="rg32sint",s.RG32Float="rg32float",s.RGBA16Uint="rgba16uint",s.RGBA16Sint="rgba16sint",s.RGBA16Float="rgba16float",s.RGBA32Uint="rgba32uint",s.RGBA32Sint="rgba32sint",s.RGBA32Float="rgba32float",s.Stencil8="stencil8",s.Depth16Unorm="depth16unorm",s.Depth24Plus="depth24plus",s.Depth24PlusStencil8="depth24plus-stencil8",s.Depth32Float="depth32float",s.BC1RGBAUnorm="bc1-rgba-unorm",s.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",s.BC2RGBAUnorm="bc2-rgba-unorm",s.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",s.BC3RGBAUnorm="bc3-rgba-unorm",s.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",s.BC4RUnorm="bc4-r-unorm",s.BC4RSnorm="bc4-r-snorm",s.BC5RGUnorm="bc5-rg-unorm",s.BC5RGSnorm="bc5-rg-snorm",s.BC6HRGBUFloat="bc6h-rgb-ufloat",s.BC6HRGBFloat="bc6h-rgb-float",s.BC7RGBAUnorm="bc7-rgba-unorm",s.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",s.ETC2RGB8Unorm="etc2-rgb8unorm",s.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",s.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",s.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",s.ETC2RGBA8Unorm="etc2-rgba8unorm",s.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",s.EACR11Unorm="eac-r11unorm",s.EACR11Snorm="eac-r11snorm",s.EACRG11Unorm="eac-rg11unorm",s.EACRG11Snorm="eac-rg11snorm",s.ASTC4x4Unorm="astc-4x4-unorm",s.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",s.ASTC5x4Unorm="astc-5x4-unorm",s.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",s.ASTC5x5Unorm="astc-5x5-unorm",s.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",s.ASTC6x5Unorm="astc-6x5-unorm",s.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",s.ASTC6x6Unorm="astc-6x6-unorm",s.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",s.ASTC8x5Unorm="astc-8x5-unorm",s.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",s.ASTC8x6Unorm="astc-8x6-unorm",s.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",s.ASTC8x8Unorm="astc-8x8-unorm",s.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",s.ASTC10x5Unorm="astc-10x5-unorm",s.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",s.ASTC10x6Unorm="astc-10x6-unorm",s.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",s.ASTC10x8Unorm="astc-10x8-unorm",s.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",s.ASTC10x10Unorm="astc-10x10-unorm",s.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",s.ASTC12x10Unorm="astc-12x10-unorm",s.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",s.ASTC12x12Unorm="astc-12x12-unorm",s.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",s.Depth32FloatStencil8="depth32float-stencil8",s}(B||{}),Md=function(s){return s.ClampToEdge="clamp-to-edge",s.Repeat="repeat",s.MirrorRepeat="mirror-repeat",s}(Md||{}),ht=function(s){return s.Nearest="nearest",s.Linear="linear",s}(ht||{});var mr=function(s){return s.Never="never",s.Less="less",s.Equal="equal",s.LessEqual="less-equal",s.Greater="greater",s.NotEqual="not-equal",s.GreaterEqual="greater-equal",s.Always="always",s}(mr||{}),ql=function(s){return s[s.Vertex=1]="Vertex",s[s.Fragment=2]="Fragment",s[s.Compute=4]="Compute",s}(ql||{}),pa=function(s){return s.Uniform="uniform",s.Storage="storage",s.ReadOnlyStorage="read-only-storage",s}(pa||{}),ma=function(s){return s.Filtering="filtering",s.NonFiltering="non-filtering",s.Comparison="comparison",s}(ma||{}),Ts=function(s){return s.Float="float",s.UnfilterableFloat="unfilterable-float",s.Depth="depth",s.Sint="sint",s.Uint="uint",s}(Ts||{}),m0=function(s){return s.WriteOnly="write-only",s.ReadOnly="read-only",s.ReadWrite="read-write",s}(m0||{});var Dd=function(s){return s.Auto="auto",s}(Dd||{}),Vs=function(s){return s.PointList="point-list",s.LineList="line-list",s.LineStrip="line-strip",s.TriangleList="triangle-list",s.TriangleStrip="triangle-strip",s}(Vs||{}),Xv=function(s){return s.CCW="ccw",s.CW="cw",s}(Xv||{}),bm=function(s){return s.None="none",s.Front="front",s.Back="back",s}(bm||{});var Qr=function(s){return s.Zero="zero",s.One="one",s.Src="src",s.OneMinusSrc="one-minus-src",s.SrcAlpha="src-alpha",s.OneMinusSrcAlpha="one-minus-src-alpha",s.Dst="dst",s.OneMinusDst="one-minus-dst",s.DstAlpha="dst-alpha",s.OneMinusDstAlpha="one-minus-dst-alpha",s.SrcAlphaSaturated="src-alpha-saturated",s.Constant="constant",s.OneMinusConstant="one-minus-constant",s}(Qr||{}),Ql=function(s){return s.Add="add",s.Subtract="subtract",s.ReverseSubtract="reverse-subtract",s.Min="min",s.Max="max",s}(Ql||{}),Po=function(s){return s.Keep="keep",s.Zero="zero",s.Replace="replace",s.Invert="invert",s.IncrementClamp="increment-clamp",s.DecrementClamp="decrement-clamp",s.IncrementWrap="increment-wrap",s.DecrementWrap="decrement-wrap",s}(Po||{}),ga=function(s){return s.Uint16="uint16",s.Uint32="uint32",s}(ga||{}),Ri=function(s){return s.Uint8x2="uint8x2",s.Uint8x4="uint8x4",s.Sint8x2="sint8x2",s.Sint8x4="sint8x4",s.Unorm8x2="unorm8x2",s.Unorm8x4="unorm8x4",s.Snorm8x2="snorm8x2",s.Snorm8x4="snorm8x4",s.Uint16x2="uint16x2",s.Uint16x4="uint16x4",s.Sint16x2="sint16x2",s.Sint16x4="sint16x4",s.Unorm16x2="unorm16x2",s.Unorm16x4="unorm16x4",s.Snorm16x2="snorm16x2",s.Snorm16x4="snorm16x4",s.Float16x2="float16x2",s.Float16x4="float16x4",s.Float32="float32",s.Float32x2="float32x2",s.Float32x3="float32x3",s.Float32x4="float32x4",s.Uint32="uint32",s.Uint32x2="uint32x2",s.Uint32x3="uint32x3",s.Uint32x4="uint32x4",s.Sint32="sint32",s.Sint32x2="sint32x2",s.Sint32x3="sint32x3",s.Sint32x4="sint32x4",s.UNORM10x10x10x2="unorm10-10-10-2",s}(Ri||{}),Yv=function(s){return s.Vertex="vertex",s.Instance="instance",s}(Yv||{});var ir=function(s){return s.Load="load",s.Clear="clear",s}(ir||{}),Qs=function(s){return s.Store="store",s.Discard="discard",s}(Qs||{}),Sm=function(s){return s.Occlusion="occlusion",s.Timestamp="timestamp",s}(Sm||{}),$v=function(s){return s.Opaque="opaque",s.Premultiplied="premultiplied",s}($v||{});var Li=class s{constructor(){this.shaderLanguage=pe.GLSL}_addUniformToLeftOverUBO(e,t,i){let r=0;[e,t,r]=this._getArraySize(e,t,i);for(let n=0;n<this._webgpuProcessingContext.leftOverUniforms.length;n++)if(this._webgpuProcessingContext.leftOverUniforms[n].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:r})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";let e=s.LeftOvertUBOName,t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,pa.Uniform,!0),this._addBufferBindingDescription(e,t,pa.Uniform,!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){let t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(t===void 0){this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[];continue}for(let i=0;i<t.length;i++){let r=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][r.binding].name,o=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][r.binding].nameInArrayOfTexture;r&&(r.texture||r.externalTexture||r.storageTexture?this._webgpuProcessingContext.textureNames.push(o):r.sampler?this._webgpuProcessingContext.samplerNames.push(n):r.buffer&&this._webgpuProcessingContext.bufferNames.push(n))}}}_preCreateBindGroupEntries(){let e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){let i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],r=[];for(let n=0;n<i.length;n++){let o=this._webgpuProcessingContext.bindGroupLayoutEntries[t][n];o.sampler||o.texture||o.storageTexture||o.externalTexture?r.push({binding:o.binding,resource:void 0}):o.buffer&&r.push({binding:o.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=r}}_addTextureBindingDescription(e,t,i,r,n,o){let{groupIndex:a,bindingIndex:l}=t.textures[i];if(this._webgpuProcessingContext.bindGroupLayoutEntries[a]||(this._webgpuProcessingContext.bindGroupLayoutEntries[a]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][l]){let c;r===null?c=this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:l,visibility:0,externalTexture:{}}):n?c=this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:l,visibility:0,storageTexture:{access:m0.WriteOnly,format:n,viewDimension:r}}):c=this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:l,visibility:0,texture:{sampleType:t.sampleType,viewDimension:r,multisampled:!1}});let h=t.isTextureArray?e+i:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][l]={name:e,index:c-1,nameInArrayOfTexture:h}}l=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][l].index,o?this._webgpuProcessingContext.bindGroupLayoutEntries[a][l].visibility|=ql.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[a][l].visibility|=ql.Fragment}_addSamplerBindingDescription(e,t,i){let{groupIndex:r,bindingIndex:n}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[r]||(this._webgpuProcessingContext.bindGroupLayoutEntries[r]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n]){let o=this._webgpuProcessingContext.bindGroupLayoutEntries[r].push({binding:n,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n]={name:e,index:o-1}}n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n].index,i?this._webgpuProcessingContext.bindGroupLayoutEntries[r][n].visibility|=ql.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[r][n].visibility|=ql.Fragment}_addBufferBindingDescription(e,t,i,r){let{groupIndex:n,bindingIndex:o}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[n]||(this._webgpuProcessingContext.bindGroupLayoutEntries[n]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][o]){let a=this._webgpuProcessingContext.bindGroupLayoutEntries[n].push({binding:o,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][o]={name:e,index:a-1}}o=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[n][o].index,r?this._webgpuProcessingContext.bindGroupLayoutEntries[n][o].visibility|=ql.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[n][o].visibility|=ql.Fragment}};Li.LeftOvertUBOName="LeftOver";Li.InternalsUBOName="Internals";Li.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,uvec2:2,vec3:3,ivec3:3,uvec3:3,vec4:4,ivec4:4,uvec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16,mat2x2f:4,mat3x3f:12,mat4x4f:16,vec2i:2,vec3i:3,vec4i:4,vec2u:2,vec3u:3,vec4u:4,vec2f:2,vec3f:3,vec4f:4,vec2h:1,vec3h:2,vec4h:2};Li._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"};Li._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"};Li._GpuTextureViewDimensionByWebGPUTextureType={textureCube:dt.Cube,textureCubeArray:dt.CubeArray,texture2D:dt.E2d,texture2DArray:dt.E2dArray,texture3D:dt.E3d};Li._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"};Li._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1};var jv=class{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this.bindGroupLayouts={},this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t,this.vertexBufferKindToType={}}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,r,n,o,a,l){let c=this.engine;c._doNotHandleContextLost&&(e._fragmentSourceCode="",e._vertexSourceCode="");let h=this.shaderProcessingContext.availableTextures,u;for(u=0;u<n.length;u++){let m=n[u],g=h[n[u]];g==null||g==null?(n.splice(u,1),u--):o[m]=u}for(let m of c.getAttributes(this,a))l.push(m);this.buildUniformLayout();let d=[],f=[];for(u=0;u<a.length;u++){let m=l[u];m>=0&&(d.push(a[u]),f.push(m))}this.shaderProcessingContext.attributeNamesFromEffect=d,this.shaderProcessingContext.attributeLocationsFromEffect=f}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new _r(this.engine,void 0,void 0,"leftOver-"+this._name);for(let e of this.shaderProcessingContext.leftOverUniforms){let t=e.type.replace(/^(.*?)(<.*>)?$/,"$1"),i=Li.UniformSizes[t];this.uniformBuffer.addUniform(e.name,i,e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}setEngine(e){this.engine=e}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt3(e,t,i,r)}setInt4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt4(e,t,i,r,n)}setIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt2(e,t,i)}setUInt3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt3(e,t,i,r)}setUInt4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUInt4(e,t,i,r,n)}setUIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat3(e,t,i,r)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,r,n){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat4(e,t,i,r,n)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){return this.sources?.vertex}_getFragmentShaderCode(){return this.sources?.fragment}};var hV={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4},_a=(()=>{class s{static get KnownUBOs(){return s._SimplifiedKnownBindings?s._SimplifiedKnownUBOs:s._KnownUBOs}constructor(t){this.vertexBufferKindToNumberOfComponents={},this.shaderLanguage=t,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],this._findStartingGroupBinding()}_findStartingGroupBinding(){let t=s.KnownUBOs,i=[];for(let r in t){let n=t[r].binding;n.groupIndex!==-1&&(i[n.groupIndex]===void 0?i[n.groupIndex]=n.bindingIndex:i[n.groupIndex]=Math.max(i[n.groupIndex],n.bindingIndex))}this.freeGroupIndex=i.length-1,this.freeGroupIndex===0?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=i[i.length-1]+1}getAttributeNextLocation(t,i=0){let r=this._attributeNextLocation;return this._attributeNextLocation+=(hV[t]??1)*(i||1),r}getVaryingNextLocation(t,i=0){let r=this._varyingNextLocation;return this._varyingNextLocation+=(hV[t]??1)*(i||1),r}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(t){if(this.freeBindingIndex>65536-t&&(this.freeGroupIndex++,this.freeBindingIndex=0),this.freeGroupIndex===4)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";let i={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=t,i}}return s._SimplifiedKnownBindings=!0,s._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},s._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}},s})();var qv=class extends Li{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=pe.GLSL,this.parseGLES3=!0}_getArraySize(e,t,i){let r=0,n=e.indexOf("["),o=e.indexOf("]");if(n>0&&o>0){let a=e.substring(n+1,o);r=+a,isNaN(r)&&(r=+i[a.trim()]),e=e.substr(0,n)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){let i=`// Internals UBO
uniform ${Li.InternalsUBOName} {
float yFactor_;
float textureOutputHeight_;
};
`,r=e.indexOf("// Internals UBO")!==-1;return t?(this._fragmentIsGLES3=e.indexOf("#version 3")!==-1,this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),r?e:i+`##INJECTCODE##
`+e):(this._vertexIsGLES3=e.indexOf("#version 3")!==-1,this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),r?e:i+e)}varyingCheck(e,t){let i=/(flat\s)?\s*\bout\b/,r=/(flat\s)?\s*\bin\b/,n=/(flat\s)?\s*\bvarying\b/;return(t&&this._fragmentIsGLES3?r:!t&&this._vertexIsGLES3?i:n).test(e)}varyingProcessor(e,t,i){this._preProcessors=i;let r=/\s*(flat)?\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,n=/\s*(flat)?\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,o=/\s*(flat)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm,l=(t&&this._fragmentIsGLES3?n:!t&&this._vertexIsGLES3?r:o).exec(e);if(l!==null){let c=l[1]??"",h=l[2],u=l[3],d;t?(d=this._webgpuProcessingContext.availableVaryings[u],this._missingVaryings[d]="",d===void 0&&F.Warn(`Invalid fragment shader: The varying named "${u}" is not declared in the vertex shader! This declaration will be ignored.`)):(d=this._webgpuProcessingContext.getVaryingNextLocation(h,this._getArraySize(u,h,i)[2]),this._webgpuProcessingContext.availableVaryings[u]=d,this._missingVaryings[d]=`layout(location = ${d}) ${c} in ${h} ${u};`),e=e.replace(l[0],d===void 0?"":`layout(location = ${d}) ${c} ${t?"in":"out"} ${h} ${u};`)}return e}attributeProcessor(e,t){this._preProcessors=t;let i=/\s*in\s+(\S+)\s+(\S+)\s*;/gm,r=/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm,o=(this._vertexIsGLES3?i:r).exec(e);if(o!==null){let a=o[1],l=o[2],c=this._webgpuProcessingContext.getAttributeNextLocation(a,this._getArraySize(l,a,t)[2]);this._webgpuProcessingContext.availableAttributes[l]=c,this._webgpuProcessingContext.orderedAttributes[c]=l;let h=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[l];if(h!==void 0){let u=h<0?h===-1?"int":"ivec"+-h:h===1?"uint":"uvec"+h,d=`_int_${l}_`;e=e.replace(o[0],`layout(location = ${c}) in ${u} ${d}; ${a} ${l} = ${a}(${d});`)}else e=e.replace(o[0],`layout(location = ${c}) in ${a} ${l};`)}return e}uniformProcessor(e,t,i){this._preProcessors=i;let n=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(n!==null){let o=n[1],a=n[2];if(o.indexOf("sampler")===0||o.indexOf("sampler")===1){let l=0;[a,o,l]=this._getArraySize(a,o,i);let c=this._webgpuProcessingContext.availableTextures[a];if(!c){c={autoBindSampler:!0,isTextureArray:l>0,isStorageTexture:!1,textures:[],sampleType:Ts.Float};for(let A=0;A<(l||1);++A)c.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}let h=Li._SamplerTypeByWebGLSamplerType[o]??"sampler",u=!!Li._IsComparisonSamplerByWebGPUSamplerType[h],d=u?ma.Comparison:ma.Filtering,f=a+"Sampler",m=this._webgpuProcessingContext.availableSamplers[f];m||(m={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:d});let g=o.charAt(0)==="u"?"u":o.charAt(0)==="i"?"i":"";g&&(o=o.substr(1));let _=u?Ts.Depth:g==="u"?Ts.Uint:g==="i"?Ts.Sint:Ts.Float;c.sampleType=_;let x=l>0,b=m.binding.groupIndex,C=m.binding.bindingIndex,R=Li._SamplerFunctionByWebGLSamplerType[o],E=Li._TextureTypeByWebGLSamplerType[o],S=Li._GpuTextureViewDimensionByWebGPUTextureType[E];if(!x)l=1,e=`layout(set = ${b}, binding = ${C}) uniform ${h} ${f};
                        layout(set = ${c.textures[0].groupIndex}, binding = ${c.textures[0].bindingIndex}) uniform ${g}${E} ${a}Texture;
                        #define ${a} ${g}${R}(${a}Texture, ${f})`;else{let A=[];A.push(`layout(set = ${b}, binding = ${C}) uniform ${g}${h} ${f};`),e=`
`;for(let L=0;L<l;++L){let G=c.textures[L].groupIndex,W=c.textures[L].bindingIndex;A.push(`layout(set = ${G}, binding = ${W}) uniform ${E} ${a}Texture${L};`),e+=`${L>0?`
`:""}#define ${a}${L} ${g}${R}(${a}Texture${L}, ${f})`}e=A.join(`
`)+e,this._textureArrayProcessing.push(a)}this._webgpuProcessingContext.availableTextures[a]=c,this._webgpuProcessingContext.availableSamplers[f]=m,this._addSamplerBindingDescription(f,m,!t);for(let A=0;A<l;++A)this._addTextureBindingDescription(a,c,A,S,null,!t)}else this._addUniformToLeftOverUBO(a,o,i),e=""}return e}uniformBufferProcessor(e,t){let r=/uniform\s+(\w+)/gm.exec(e);if(r!==null){let n=r[1],o=this._webgpuProcessingContext.availableBuffers[n];if(!o){let a=_a.KnownUBOs[n],l;a&&a.binding.groupIndex!==-1?l=a.binding:l=this._webgpuProcessingContext.getNextFreeUBOBinding(),o={binding:l},this._webgpuProcessingContext.availableBuffers[n]=o}this._addBufferBindingDescription(n,o,pa.Uniform,!t),e=e.replace("uniform",`layout(set = ${o.binding.groupIndex}, binding = ${o.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,r,n){let o=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,a=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(a,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){let l=e.indexOf("gl_FragCoord")>=0,c=`
                glFragCoord_ = gl_FragCoord;
                if (yFactor_ == 1.) {
                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;
                }
            `,h=l?`vec4 glFragCoord_;
`:"",u=e.search(/layout *\(location *= *0\) *out/g)!==-1;if(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/gl_FragCoord/g,"glFragCoord_"),!this._fragmentIsGLES3)e=e.replace(/void\s+?main\s*\(/g,(o||u?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main(");else{let d=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);d!==null&&(e=e.substring(0,d.index)+"layout(location = 0) "+e.substring(d.index))}e=e.replace(/dFdy/g,"(-yFactor_)*dFdy"),e=e.replace("##INJECTCODE##",h),l&&(e=fh(e,"void main",c))}else if(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex"),e=e.replace(/gl_VertexID/g,"gl_VertexIndex"),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;if(!i){let l=e.lastIndexOf("}");e=e.substring(0,l),e+=`gl_Position.y *= yFactor_;
`,e+="}"}return e}_applyTextureArrayProcessing(e,t){let i=new RegExp(t+"\\s*\\[(.+)?\\]","gm"),r=i.exec(e);for(;r!==null;){let n=r[1],o=+n;this._preProcessors&&isNaN(o)&&(o=+this._preProcessors[n.trim()]),e=e.replace(r[0],t+o),r=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {
    `;for(let r of this._webgpuProcessingContext.leftOverUniforms)r.length>0?i+=`    ${r.type} ${r.name}[${r.length}];
`:i+=`    ${r.type} ${r.name};
`;return i+=`};

`,i}finalizeShaders(e,t){for(let r=0;r<this._textureArrayProcessing.length;++r){let n=this._textureArrayProcessing[r];e=this._applyTextureArrayProcessing(e,n),t=this._applyTextureArrayProcessing(t,n)}for(let r=0;r<this._missingVaryings.length;++r){let n=this._missingVaryings[r];n&&n.length>0&&(t=n+`
`+t)}let i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}};var VY="bonesDeclaration",UY=`#if NUM_BONE_INFLUENCERS>0
attribute matricesIndices : vec4<f32>;attribute matricesWeights : vec4<f32>;
#if NUM_BONE_INFLUENCERS>4
attribute matricesIndicesExtra : vec4<f32>;attribute matricesWeightsExtra : vec4<f32>;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
var boneSampler : texture_2d<f32>;uniform boneTextureWidth : f32;
#else
uniform mBones : array<mat4x4,BonesPerMesh>;
#ifdef BONES_VELOCITY_ENABLED
uniform mPreviousBones : array<mat4x4,BonesPerMesh>;
#endif
#endif
#ifdef BONETEXTURE
fn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>
{let offset=i32(index) *4; 
let m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}
#endif
#endif
#endif
`;D.IncludesShadersStoreWGSL[VY]=UY;var kY="bonesVertex",GY=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
var influence : mat4x4<f32>;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[0])*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[1])*vertexInputs.matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[2])*vertexInputs.matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndices[3])*vertexInputs.matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[0])*vertexInputs.matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[1])*vertexInputs.matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[2])*vertexInputs.matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+readMatrixFromRawSampler(boneSampler,vertexInputs.matricesIndicesExtra[3])*vertexInputs.matricesWeightsExtra[3];
#endif 
#else 
influence=uniforms.mBones[int(vertexInputs.matricesIndices[0])]*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[1])]*vertexInputs.matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[2])]*vertexInputs.matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndices[3])]*vertexInputs.matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[0])]*vertexInputs.matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[1])]*vertexInputs.matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[2])]*vertexInputs.matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+uniforms.mBones[int(vertexInputs.matricesIndicesExtra[3])]*vertexInputs.matricesWeightsExtra[3];
#endif 
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;D.IncludesShadersStoreWGSL[kY]=GY;var zY="bakedVertexAnimationDeclaration",WY=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform bakedVertexAnimationTime: f32;uniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;uniform bakedVertexAnimationSettings: vec4<f32>;var bakedVertexAnimationTexture : texture_2d<f32>;
#ifdef INSTANCES
attribute bakedVertexAnimationSettingsInstanced : vec4<f32>;
#endif
fn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>
{let offset=i32(index)*4;let frameUV=i32(frame);let m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);let m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);let m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);let m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);return mat4x4<f32>(m0,m1,m2,m3);}
#endif
`;D.IncludesShadersStoreWGSL[zY]=WY;var HY="bakedVertexAnimation",XY=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
let VATStartFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.x;let VATEndFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.y;let VATOffsetFrame: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.z;let VATSpeed: f32=vertexInputs.bakedVertexAnimationSettingsInstanced.w;
#else
let VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;let VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;let VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;let VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;
#endif
let totalFrames: f32=VATEndFrame-VATStartFrame+1.0;let time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;let frameCorrection: f32=select(1.0,0.0,time<1.0);let numOfFrames: f32=totalFrames-frameCorrection;var VATFrameNum: f32=fract(time)*numOfFrames;VATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;VATFrameNum=floor(VATFrameNum);VATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;var VATInfluence : mat4x4<f32>;VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[0],VATFrameNum)*vertexInputs.matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[1],VATFrameNum)*vertexInputs.matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[2],VATFrameNum)*vertexInputs.matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndices[3],VATFrameNum)*vertexInputs.matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[0],VATFrameNum)*vertexInputs.matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[1],VATFrameNum)*vertexInputs.matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[2],VATFrameNum)*vertexInputs.matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,vertexInputs.matricesIndicesExtra[3],VATFrameNum)*vertexInputs.matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;}
#endif
`;D.IncludesShadersStoreWGSL[HY]=XY;var YY="clipPlaneFragment",$Y=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fragmentInputs.fClipDistance>0.0)
{discard;}
#endif
#ifdef CLIPPLANE2
else if (fragmentInputs.fClipDistance2>0.0)
{discard;}
#endif
#ifdef CLIPPLANE3
else if (fragmentInputs.fClipDistance3>0.0)
{discard;}
#endif
#ifdef CLIPPLANE4
else if (fragmentInputs.fClipDistance4>0.0)
{discard;}
#endif
#ifdef CLIPPLANE5
else if (fragmentInputs.fClipDistance5>0.0)
{discard;}
#endif
#ifdef CLIPPLANE6
else if (fragmentInputs.fClipDistance6>0.0)
{discard;}
#endif
`;D.IncludesShadersStoreWGSL[YY]=$Y;var jY="clipPlaneFragmentDeclaration",qY=`#ifdef CLIPPLANE
varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
varying fClipDistance6: f32;
#endif
`;D.IncludesShadersStoreWGSL[jY]=qY;var QY="clipPlaneVertex",KY=`#ifdef CLIPPLANE
vertexOutputs.fClipDistance=dot(worldPos,uniforms.vClipPlane);
#endif
#ifdef CLIPPLANE2
vertexOutputs.fClipDistance2=dot(worldPos,uniforms.vClipPlane2);
#endif
#ifdef CLIPPLANE3
vertexOutputs.fClipDistance3=dot(worldPos,uniforms.vClipPlane3);
#endif
#ifdef CLIPPLANE4
vertexOutputs.fClipDistance4=dot(worldPos,uniforms.vClipPlane4);
#endif
#ifdef CLIPPLANE5
vertexOutputs.fClipDistance5=dot(worldPos,uniforms.vClipPlane5);
#endif
#ifdef CLIPPLANE6
vertexOutputs.fClipDistance6=dot(worldPos,uniforms.vClipPlane6);
#endif
`;D.IncludesShadersStoreWGSL[QY]=KY;var ZY="clipPlaneVertexDeclaration",JY=`#ifdef CLIPPLANE
uniform vClipPlane: vec4<f32>;varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
uniform vClipPlane2: vec4<f32>;varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
uniform vClipPlane3: vec4<f32>;varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
uniform vClipPlane4: vec4<f32>;varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
uniform vClipPlane5: vec4<f32>;varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
uniform vClipPlane6: vec4<f32>;varying fClipDistance6: f32;
#endif
`;D.IncludesShadersStoreWGSL[ZY]=JY;var e$="instancesDeclaration",t$=`#ifdef INSTANCES
attribute world0 : vec4<f32>;attribute world1 : vec4<f32>;attribute world2 : vec4<f32>;attribute world3 : vec4<f32>;
#ifdef INSTANCESCOLOR
attribute instanceColor : vec4<f32>;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute previousWorld0 : vec4<f32>;attribute previousWorld1 : vec4<f32>;attribute previousWorld2 : vec4<f32>;attribute previousWorld3 : vec4<f32>;
#ifdef THIN_INSTANCES
uniform previousWorld : mat4x4<f32>;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform previousWorld : mat4x4<f32>;
#endif
#endif
`;D.IncludesShadersStoreWGSL[e$]=t$;var i$="instancesVertex",r$=`#ifdef INSTANCES
var finalWorld=mat4x4<f32>(vertexInputs.world0,vertexInputs.world1,vertexInputs.world2,vertexInputs.world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
var finalPreviousWorld=mat4x4<f32>(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
#if !defined(WORLD_UBO)
finalWorld=uniforms.world*finalWorld;
#else
finalWorld=mesh.world*finalWorld;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
var finalWorld=uniforms.world;
#else
var finalWorld=mesh.world;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
var finalPreviousWorld=previousWorld;
#endif
#endif
`;D.IncludesShadersStoreWGSL[i$]=r$;var s$="helperFunctions",n$=`const PI: f32=3.1415926535897932384626433832795;const RECIPROCAL_PI: f32=0.3183098861837907;const RECIPROCAL_PI2: f32=0.15915494309189535;const HALF_MIN: f32=5.96046448e-08; 
const LinearEncodePowerApprox: f32=2.2;const GammaEncodePowerApprox: f32=1.0/LinearEncodePowerApprox;const LuminanceEncodeApprox: vec3<f32>=vec3<f32> (0.2126,0.7152,0.0722);const Epsilon:f32=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
fn transposeMat3(inMatrix: mat3x3f)->mat3x3f {let i0: vec3<f32>=inMatrix[0];let i1: vec3<f32>=inMatrix[1];let i2: vec3<f32>=inMatrix[2];let outMatrix:mat3x3f=mat3x3f(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);return outMatrix;}
fn inverseMat3(inMatrix: mat3x3f)->mat3x3f {let a00: f32=inMatrix[0][0];let a01: f32=inMatrix[0][1];let a02: f32=inMatrix[0][2];let a10: f32=inMatrix[1][0];let a11: f32=inMatrix[1][1];let a12: f32=inMatrix[1][2];let a20: f32=inMatrix[2][0];let a21: f32=inMatrix[2][1];let a22: f32=inMatrix[2][2];let b01: f32=a22*a11-a12*a21;let b11: f32=-a22*a10+a12*a20;let b21: f32=a21*a10-a11*a20;let det: f32=a00*b01+a01*b11+a02*b21;return mat3x3f(b01/det,(-a22*a01+a02*a21)/det,(a12*a01-a02*a11)/det,
b11/det,(a22*a00-a02*a20)/det,(-a12*a00+a02*a10)/det,
b21/det,(-a21*a00+a01*a20)/det,(a11*a00-a01*a10)/det);}
#if USE_EXACT_SRGB_CONVERSIONS
fn toLinearSpaceExact(color: vec3<f32>)->vec3<f32>
{let nearZeroSection: vec3<f32>=0.0773993808*color;let remainingSection: vec3<f32>=pow(0.947867299*(color+vec3<f32>(0.055)),vec3<f32>(2.4));return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3<f32>(0.04045)));}
fn toGammaSpaceExact(color: vec3<f32>)->vec3<f32>
{let nearZeroSection: vec3<f32>=12.92*color;let remainingSection: vec3<f32>=1.055*pow(color,vec3<f32>(0.41666))-vec3<f32>(0.055);return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3<f32>(0.0031308)));}
#endif
fn toLinearSpace(color: vec4<f32>)->vec4<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4<f32>(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4<f32>(pow(color.rgb,vec3<f32>(LinearEncodePowerApprox)),color.a);
#endif
}
fn toLinearSpaceVec3(color: vec3<f32>)->vec3<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3<f32>(LinearEncodePowerApprox));
#endif
}
fn toGammaSpace(color: vec4<f32>)->vec4<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4<f32>(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4<f32>(pow(color.rgb,vec3<f32>(GammaEncodePowerApprox)),color.a);
#endif
}
fn toGammaSpaceVec3(color: vec3<f32>)->vec3<f32>
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3<f32>(GammaEncodePowerApprox));
#endif
}
fn square(value: vec3<f32>)->vec3<f32>
{return value*value;}
fn pow5(value: f32)->f32 {let sq: f32=value*value;return sq*sq*value;}
fn getLuminance(color: vec3<f32>)->f32
{return clamp(dot(color,LuminanceEncodeApprox),0.,1.);}
fn getRand(seed: vec2<f32>)->f32 {return fract(sin(dot(seed.xy ,vec2<f32>(12.9898,78.233)))*43758.5453);}
fn dither(seed: vec2<f32>,varianceAmount: f32)->f32 {let rand: f32=getRand(seed);let normVariance: f32=varianceAmount/255.0;let dither: f32=mix(-normVariance,normVariance,rand);return dither;}
const rgbdMaxRange: f32=255.0;fn toRGBD(color: vec3<f32>)->vec4<f32> {let maxRGB: f32=max(max(color.r,max(color.g,color.b)),Epsilon);var D: f32 =max(rgbdMaxRange/maxRGB,1.);D =clamp(floor(D)/255.0,0.,1.);var rgb: vec3<f32> =color.rgb*D;rgb=toGammaSpaceVec3(rgb);return vec4<f32>(clamp(rgb,vec3<f32>(0.,0.,0.),vec3<f32>(1.,1.,1.)),D); }
fn fromRGBD(rgbd: vec4<f32>)->vec3<f32> {let rgb=toLinearSpaceVec3(rgbd.rgb);return rgb/rgbd.a;}
fn parallaxCorrectNormal(vertexPos: vec3<f32>,origVec: vec3<f32>,cubeSize: vec3<f32>,cubePos: vec3<f32>)->vec3<f32> {let invOrigVec: vec3<f32>=vec3<f32>(1.0,1.0,1.0)/origVec;let halfSize: vec3<f32>=cubeSize*0.5;let intersecAtMaxPlane: vec3<f32>=(cubePos+halfSize-vertexPos)*invOrigVec;let intersecAtMinPlane: vec3<f32>=(cubePos-halfSize-vertexPos)*invOrigVec;let largestIntersec: vec3<f32>=max(intersecAtMaxPlane,intersecAtMinPlane);let distance: f32=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);let intersectPositionWS: vec3<f32>=vertexPos+origVec*distance;return intersectPositionWS-cubePos;}
`;D.IncludesShadersStoreWGSL[s$]=n$;var o$="fresnelFunction",a$=`#ifdef FRESNEL
fn computeFresnelTerm(viewDirection: vec3f,worldNormal: vec3f,bias: f32,power: f32)->f32
{let fresnelTerm: f32=pow(bias+abs(dot(viewDirection,worldNormal)),power);return clamp(fresnelTerm,0.,1.);}
#endif
`;D.IncludesShadersStoreWGSL[o$]=a$;var l$="meshUboDeclaration",c$=`struct Mesh {world : mat4x4<f32>,
visibility : f32,};var<uniform> mesh : Mesh;
#define WORLD_UBO
`;D.IncludesShadersStoreWGSL[l$]=c$;var h$="morphTargetsVertex",u$=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
#if {X}==0
for (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (i>=uniforms.morphTargetCount) {break;}
vertexID=f32(vertexInputs.vertexIndex)*uniforms.morphTargetTextureInfo.x;positionUpdated=positionUpdated+(readVector3FromRawSampler({X},vertexID)-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];vertexID=vertexID+1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated=normalUpdated+(readVector3FromRawSampler({X},vertexID) -vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(readVector3FromRawSampler({X},vertexID).xy-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz=tangentUpdated.xyz+(readVector3FromRawSampler({X},vertexID) -vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}];
#endif
}
#endif
#else
positionUpdated=positionUpdated+(position{X}-vertexInputs.position)*uniforms.morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-vertexInputs.normal)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz=tangentUpdated.xyz+(tangent{X}-vertexInputs.tangent.xyz)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(uv_{X}-vertexInputs.uv)*uniforms.morphTargetInfluences[{X}];
#endif
#endif
#endif
`;D.IncludesShadersStoreWGSL[h$]=u$;var d$="morphTargetsVertexDeclaration",f$=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute position{X} : vec3<f32>;
#ifdef MORPHTARGETS_NORMAL
attribute normal{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_TANGENT
attribute tangent{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_UV
attribute uv_{X} : vec2<f32>;
#endif
#elif {X}==0
uniform morphTargetCount: i32;
#endif
#endif
`;D.IncludesShadersStoreWGSL[d$]=f$;var p$="morphTargetsVertexGlobal",m$=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
var vertexID : f32;
#endif
#endif
`;D.IncludesShadersStoreWGSL[p$]=m$;var g$="morphTargetsVertexGlobalDeclaration",_$=`#ifdef MORPHTARGETS
uniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;
#ifdef MORPHTARGETS_TEXTURE 
uniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;uniform morphTargetTextureInfo : vec3<f32>;var morphTargets : texture_2d_array<f32>;var morphTargetsSampler : sampler;fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>
{ 
let y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;}
#endif
#endif
`;D.IncludesShadersStoreWGSL[g$]=_$;var x$="sceneUboDeclaration",v$=`struct Scene {viewProjection : mat4x4<f32>,
#ifdef MULTIVIEW
viewProjectionR : mat4x4<f32>,
#endif 
view : mat4x4<f32>,
projection : mat4x4<f32>,
vEyePosition : vec4<f32>,};var<uniform> scene : Scene;
`;D.IncludesShadersStoreWGSL[x$]=v$;var T$="lightsFragmentFunctions",C$=`struct lightingInfo
{diffuse: vec3f,
#ifdef SPECULARTERM
specular: vec3f,
#endif
#ifdef NDOTL
ndl: f32,
#endif
};fn computeLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var lightVectorW: vec3f;var attenuation: f32=1.0;if (lightData.w==0.)
{var direction: vec3f=lightData.xyz-vPositionW;var attenuation: f32=max(0.,1.0-length(direction)/range);lightVectorW=normalize(direction);}
else
{lightVectorW=normalize(-lightData.xyz);}
var ndl: f32=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
fn computeSpotLighting(viewDirectionW: vec3f,vNormal: vec3f ,lightData: vec4f,lightDirection: vec4f,diffuseColor: vec3f,specularColor: vec3f,range: f32,glossiness: f32)->lightingInfo {var result: lightingInfo;var direction: vec3f=lightData.xyz-vPositionW;var lightVectorW: vec3f=normalize(direction);var attenuation: f32=max(0.,1.0-length(direction)/range);var cosAngle: f32=max(0.,dot(lightDirection.xyz,-lightVectorW));if (cosAngle>=lightDirection.w)
{cosAngle=max(0.,pow(cosAngle,lightData.w));attenuation*=cosAngle;var ndl: f32=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightVectorW);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor*attenuation;
#endif
return result;}
result.diffuse=vec3f(0.);
#ifdef SPECULARTERM
result.specular=vec3f(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;}
fn computeHemisphericLighting(viewDirectionW: vec3f,vNormal: vec3f,lightData: vec4f,diffuseColor: vec3f,specularColor: vec3f,groundColor: vec3f,glossiness: f32)->lightingInfo {var result: lightingInfo;var ndl: f32=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
var angleW: vec3f=normalize(viewDirectionW+lightData.xyz);var specComp: f32=max(0.,dot(vNormal,angleW));specComp=pow(specComp,max(1.,glossiness));result.specular=specComp*specularColor;
#endif
return result;}
fn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f)->vec3f {var strq: vec4f=textureProjectionMatrix*vec4f(vPositionW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return textureColor;}`;D.IncludesShadersStoreWGSL[T$]=C$;var b$="lightFragment",S$=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightTexture{X},projectionLightTexture{X}Sampler,textureProjectionMatrix{X});
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSMDEBUG{X} 
var shadowDebug{X}: vec3f;
#endif
#ifdef SHADOWCSM{X}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
var index{X}: i32=-1;
#else
var index{X}: i32=SHADOWCSMNUM_CASCADES{X}-1;
#endif
var diff{X}: f32=0.;vPositionFromLight{X}[0]=fragmentInputs.vPositionFromLight{X}_0;vPositionFromLight{X}[1]=fragmentInputs.vPositionFromLight{X}_1;vPositionFromLight{X}[2]=fragmentInputs.vPositionFromLight{X}_2;vPositionFromLight{X}[3]=fragmentInputs.vPositionFromLight{X}_3;vDepthMetric{X}[0]=fragmentInputs.vDepthMetric{X}_0;vDepthMetric{X}[1]=fragmentInputs.vDepthMetric{X}_1;vDepthMetric{X}[2]=fragmentInputs.vDepthMetric{X}_2;vDepthMetric{X}[3]=fragmentInputs.vDepthMetric{X}_3;for (var i:i32=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=uniforms.viewFrustumZ{X}[i]+fragmentInputs.vPositionFromCamera{X}.z;
#else
diff{X}=uniforms.viewFrustumZ{X}[i]-fragmentInputs.vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {index{X}=i;break;}}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3f(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
var frustumLength:f32=uniforms.frustumLengths{X}[index{X}];var diffRatio:f32=clamp(diff{X}/frustumLength,0.,1.)*uniforms.cascadeBlendFactor{X};if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{index{X}+=1;var nextShadow: f32=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],,shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,uniforms.lightSizeUVCorrection{X}[index{X}],uniforms.depthCorrection{X}[index{X}],uniforms.penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(index{X},vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},depthTexture{X},depthTexture{X}Sampler,shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(vPositionW,light{X}.vLightData.xyz,shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(fragmentInputs.vPositionFromLight{X},fragmentInputs.vDepthMetric{X},shadowTexture{X},shadowTexture{X}Sampler,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
aggShadow+=shadow;numLights+=1.0;
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;D.IncludesShadersStoreWGSL[b$]=S$;var y$="lightUboDeclaration",E$=`#ifdef LIGHT{X}
struct Light{X}
{vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
#ifdef SPOTLIGHT{X}
vLightDirection: vec4f,
vLightFalloff: vec4f,
#elif defined(POINTLIGHT{X})
vLightFalloff: vec4f,
#elif defined(HEMILIGHT{X})
vLightGround: vec3f,
#endif
shadowsInfo: vec4f,
depthValues: vec2f} ;var<uniform> light{X} : Light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform textureProjectionMatrix{X}: mat4x4f;var projectionLightTexture{X}sampler: sampler;var projectionLightTexture{X}: texture_2d<f32>;
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;uniform viewFrustumZ{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform frustumLengths{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform cascadeBlendFactor{X}: f32;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;var<private> vPositionFromLight{X}: array<vec4f,4>;var<private> vDepthMetric{X} : array<f32,4>;
#if defined(SHADOWPCSS{X})
var shadowTexture{X}Sampler: sampler_comparison; 
var shadowTexture{X}: texture_depth_2d_array;var depthTexture{X}Sampler: sampler;var depthTexture{X}: texture_2d_array<f32>;uniform lightSizeUVCorrection{X}: array<vec2f,SHADOWCSMNUM_CASCADES{X}>;uniform depthCorrection{X}: array<f32,SHADOWCSMNUM_CASCADES{X}>;uniform penumbraDarkness{X}: f32;
#elif defined(SHADOWPCF{X})
var shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d_array;
#else 
var shadowTexture{X}Sampler: sampler; 
var shadowTexture{X}: texture_2d_array<f32>;
#endif
#ifdef SHADOWCSMDEBUG{X}
const vCascadeColorsMultiplier{X}: array<vec3f,8>=array<vec3f,8>
(
vec3f ( 1.5,0.0,0.0 ),
vec3f ( 0.0,1.5,0.0 ),
vec3f ( 0.0,0.0,5.5 ),
vec3f ( 1.5,0.0,5.5 ),
vec3f ( 1.5,1.5,0.0 ),
vec3f ( 1.0,1.0,1.0 ),
vec3f ( 0.0,1.0,5.5 ),
vec3f ( 0.5,3.5,0.75 )
);
#endif
#elif defined(SHADOWCUBE{X})
var shadowTexture{X}Sampler: sampler;var shadowTexture{X}: texture_cube<f32>;
#else
varying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;
#if defined(SHADOWPCSS{X})
var shadowTexture{X}Sampler: sampler_comparison; 
var shadowTexture{X}: texture_depth_2d;var depthTexture{X}Sampler: sampler; 
var depthTexture{X}: texture_2d<f32>;
#elif defined(SHADOWPCF{X})
var shadowTexture{X}Sampler: sampler_comparison;var shadowTexture{X}: texture_depth_2d;
#else
var shadowTexture{X}Sampler: sampler; 
var shadowTexture{X}: texture_2d<f32>;
#endif
uniform lightMatrix{X}: mat4x4f;
#endif
#endif
#endif
`;D.IncludesShadersStoreWGSL[y$]=E$;var A$="lightVxUboDeclaration",I$=`#ifdef LIGHT{X}
struct Light{X}
{vLightData: vec4f,
vLightDiffuse: vec4f,
vLightSpecular: vec4f,
#ifdef SPOTLIGHT{X}
vLightDirection: vec4f,
vLightFalloff: vec4f,
#elif defined(POINTLIGHT{X})
vLightFalloff: vec4f,
#elif defined(HEMILIGHT{X})
vLightGround: vec3f,
#endif
shadowsInfo: vec4f,
depthValues: vec2f} ;var<uniform> light{X} : Light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform lightMatrix{X}: array<mat4x4f,SHADOWCSMNUM_CASCADES{X}>;varying vPositionFromLight{X}_0: vec4f;varying vDepthMetric{X}_0: f32;varying vPositionFromLight{X}_1: vec4f;varying vDepthMetric{X}_1: f32;varying vPositionFromLight{X}_2: vec4f;varying vDepthMetric{X}_2: f32;varying vPositionFromLight{X}_3: vec4f;varying vDepthMetric{X}_3: f32;varying vPositionFromCamera{X}: vec4f;
#elif defined(SHADOWCUBE{X})
#else
varying vPositionFromLight{X}: vec4f;varying vDepthMetric{X}: f32;uniform lightMatrix{X}: mat4x4f;
#endif
#endif
#endif
`;D.IncludesShadersStoreWGSL[A$]=I$;var R$="shadowsFragmentFunctions",P$=`#ifdef SHADOWS
#ifndef SHADOWFLOAT
fn unpack(color: vec4f)->f32
{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}
#endif
fn computeFallOff(value: f32,clipSpace: vec2f,frustumEdgeFalloff: f32)->f32
{var mask: f32=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));return mix(value,1.0,mask);}
fn computeShadowCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadow: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
return select(darkness,1.0,depth>shadow);}
fn computeShadowWithPoissonSamplingCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);depth=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;var visibility: f32=1.;var poissonDisk: array<vec3f,4>;poissonDisk[0]= vec3f(-1.0,1.0,-1.0);poissonDisk[1]= vec3f(1.0,-1.0,-1.0);poissonDisk[2]= vec3f(-1.0,-1.0,-1.0);poissonDisk[3]= vec3f(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) {visibility-=0.25;};if (unpack(textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) {visibility-=0.25;};
#else
if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) {visibility-=0.25;};if (textureSample(shadowTexture,shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) {visibility-=0.25;};
#endif
return min(1.0,visibility+darkness);}
fn computeShadowWithESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
var esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return esm;}
fn computeShadowWithCloseESMCube(worldPos: vec3f,lightPosition: vec3f,shadowTexture: texture_cube<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,depthValues: vec2f)->f32
{var directionToLight: vec3f=worldPos-lightPosition;var depth: f32=length(directionToLight);depth=(depth+depthValues.x)/(depthValues.y);var shadowPixelDepth: f32=clamp(depth,0.,1.0);directionToLight=normalize(directionToLight);directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSample(shadowTexture,shadowSampler,directionToLight));
#else
var shadowMapSample: f32=textureSample(shadowTexture,shadowSampler,directionToLight).x;
#endif
var esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return esm;}
fn computeShadowCSM(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d_array<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSample(shadowTexture,shadowSampler,uv,layer));
#else
var shadow: f32=textureSample(shadowTexture,shadowSampler,uv,layer).x;
#endif
return select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}
fn computeShadow(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadow: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadow: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
return select(1.,computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff),shadowPixelDepth>shadow );}}
fn computeShadowWithPoissonSampling(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,mapSize: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);var visibility: f32=1.;var poissonDisk: array<vec2f,4>;poissonDisk[0]= vec2f(-0.94201624,-0.39906216);poissonDisk[1]= vec2f(0.94558609,-0.76890725);poissonDisk[2]= vec2f(-0.094184101,-0.92938870);poissonDisk[3]= vec2f(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
if (unpack(textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.))<shadowPixelDepth) {visibility-=0.25;}
#else
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[0]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[1]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[2]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
if (textureSampleLevel(shadowTexture,shadowSampler,uv+poissonDisk[3]*mapSize,0.).x<shadowPixelDepth) {visibility-=0.25;}
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
var esm: f32=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithCloseESM(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_2d<f32>,shadowSampler: sampler,darkness: f32,depthScale: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uv: vec2f=0.5*clipSpace.xy+ vec2f(0.5);if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{return 1.0;}
else
{var shadowPixelDepth: f32=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
var shadowMapSample: f32=unpack(textureSampleLevel(shadowTexture,shadowSampler,uv,0.));
#else
var shadowMapSample: f32=textureSampleLevel(shadowTexture,shadowSampler,uv,0.).x;
#endif
var esm: f32=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);}}
fn getZInClip(clipSpace: vec3f,uvDepth: vec3f)->f32
{
#ifdef IS_NDC_HALF_ZRANGE
return clipSpace.z;
#else
return uvDepth.z;
#endif
}
const GREATEST_LESS_THAN_ONE: f32=0.99999994;
#define DISABLE_UNIFORMITY_ANALYSIS
fn computeShadowWithCSMPCF1(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var shadow: f32=textureSampleCompare(shadowTexture,shadowSampler,uvDepth.xy,layer,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithCSMPCF3(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithCSMPCF5(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),layer,uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),layer,uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),layer,uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),layer,uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),layer,uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),layer,uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),layer,uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),layer,uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompare(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),layer,uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}
fn computeShadowWithPCF1(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var shadow: f32=textureSampleCompareLevel(shadowTexture,shadowSampler,uvDepth.xy,uvDepth.z);shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithPCF3(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=3.-2.*st;var uvw1: vec2f=1.+2.*st;var u: vec2f= vec2f((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;var v: vec2f= vec2f((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow=shadow/16.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
fn computeShadowWithPCF5(vPositionFromLight: vec4f,depthMetric: f32,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeAndInverse: vec2f,darkness: f32,frustumEdgeFalloff: f32)->f32
{if (depthMetric>1.0 || depthMetric<0.0) {return 1.0;}
else
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var uv: vec2f=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
var st: vec2f=fract(uv); 
var base_uv: vec2f=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
var uvw0: vec2f=4.-3.*st;var uvw1: vec2f= vec2f(7.);var uvw2: vec2f=1.+3.*st;var u: vec3f= vec3f((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;var v: vec3f= vec3f((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;var shadow: f32=0.;shadow+=uvw0.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[0]),uvDepth.z);shadow+=uvw1.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[0]),uvDepth.z);shadow+=uvw2.x*uvw0.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[0]),uvDepth.z);shadow+=uvw0.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[1]),uvDepth.z);shadow+=uvw1.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[1]),uvDepth.z);shadow+=uvw2.x*uvw1.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[1]),uvDepth.z);shadow+=uvw0.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[0],v[2]),uvDepth.z);shadow+=uvw1.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[1],v[2]),uvDepth.z);shadow+=uvw2.x*uvw2.y*textureSampleCompareLevel(shadowTexture,shadowSampler, base_uv.xy+ vec2f(u[2],v[2]),uvDepth.z);shadow=shadow/144.;shadow=mix(darkness,1.,shadow);return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);}}
const PoissonSamplers32: array<vec3f,64>=array<vec3f,64> (
vec3f(0.06407013,0.05409927,0.),
vec3f(0.7366577,0.5789394,0.),
vec3f(-0.6270542,-0.5320278,0.),
vec3f(-0.4096107,0.8411095,0.),
vec3f(0.6849564,-0.4990818,0.),
vec3f(-0.874181,-0.04579735,0.),
vec3f(0.9989998,0.0009880066,0.),
vec3f(-0.004920578,-0.9151649,0.),
vec3f(0.1805763,0.9747483,0.),
vec3f(-0.2138451,0.2635818,0.),
vec3f(0.109845,0.3884785,0.),
vec3f(0.06876755,-0.3581074,0.),
vec3f(0.374073,-0.7661266,0.),
vec3f(0.3079132,-0.1216763,0.),
vec3f(-0.3794335,-0.8271583,0.),
vec3f(-0.203878,-0.07715034,0.),
vec3f(0.5912697,0.1469799,0.),
vec3f(-0.88069,0.3031784,0.),
vec3f(0.5040108,0.8283722,0.),
vec3f(-0.5844124,0.5494877,0.),
vec3f(0.6017799,-0.1726654,0.),
vec3f(-0.5554981,0.1559997,0.),
vec3f(-0.3016369,-0.3900928,0.),
vec3f(-0.5550632,-0.1723762,0.),
vec3f(0.925029,0.2995041,0.),
vec3f(-0.2473137,0.5538505,0.),
vec3f(0.9183037,-0.2862392,0.),
vec3f(0.2469421,0.6718712,0.),
vec3f(0.3916397,-0.4328209,0.),
vec3f(-0.03576927,-0.6220032,0.),
vec3f(-0.04661255,0.7995201,0.),
vec3f(0.4402924,0.3640312,0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.),
vec3f(0.)
);const PoissonSamplers64: array<vec3f,64>=array<vec3f,64> (
vec3f(-0.613392,0.617481,0.),
vec3f(0.170019,-0.040254,0.),
vec3f(-0.299417,0.791925,0.),
vec3f(0.645680,0.493210,0.),
vec3f(-0.651784,0.717887,0.),
vec3f(0.421003,0.027070,0.),
vec3f(-0.817194,-0.271096,0.),
vec3f(-0.705374,-0.668203,0.),
vec3f(0.977050,-0.108615,0.),
vec3f(0.063326,0.142369,0.),
vec3f(0.203528,0.214331,0.),
vec3f(-0.667531,0.326090,0.),
vec3f(-0.098422,-0.295755,0.),
vec3f(-0.885922,0.215369,0.),
vec3f(0.566637,0.605213,0.),
vec3f(0.039766,-0.396100,0.),
vec3f(0.751946,0.453352,0.),
vec3f(0.078707,-0.715323,0.),
vec3f(-0.075838,-0.529344,0.),
vec3f(0.724479,-0.580798,0.),
vec3f(0.222999,-0.215125,0.),
vec3f(-0.467574,-0.405438,0.),
vec3f(-0.248268,-0.814753,0.),
vec3f(0.354411,-0.887570,0.),
vec3f(0.175817,0.382366,0.),
vec3f(0.487472,-0.063082,0.),
vec3f(-0.084078,0.898312,0.),
vec3f(0.488876,-0.783441,0.),
vec3f(0.470016,0.217933,0.),
vec3f(-0.696890,-0.549791,0.),
vec3f(-0.149693,0.605762,0.),
vec3f(0.034211,0.979980,0.),
vec3f(0.503098,-0.308878,0.),
vec3f(-0.016205,-0.872921,0.),
vec3f(0.385784,-0.393902,0.),
vec3f(-0.146886,-0.859249,0.),
vec3f(0.643361,0.164098,0.),
vec3f(0.634388,-0.049471,0.),
vec3f(-0.688894,0.007843,0.),
vec3f(0.464034,-0.188818,0.),
vec3f(-0.440840,0.137486,0.),
vec3f(0.364483,0.511704,0.),
vec3f(0.034028,0.325968,0.),
vec3f(0.099094,-0.308023,0.),
vec3f(0.693960,-0.366253,0.),
vec3f(0.678884,-0.204688,0.),
vec3f(0.001801,0.780328,0.),
vec3f(0.145177,-0.898984,0.),
vec3f(0.062655,-0.611866,0.),
vec3f(0.315226,-0.604297,0.),
vec3f(-0.780145,0.486251,0.),
vec3f(-0.371868,0.882138,0.),
vec3f(0.200476,0.494430,0.),
vec3f(-0.494552,-0.711051,0.),
vec3f(0.612476,0.705252,0.),
vec3f(-0.578845,-0.768792,0.),
vec3f(-0.772454,-0.090976,0.),
vec3f(0.504440,0.372295,0.),
vec3f(0.155736,0.065157,0.),
vec3f(0.391522,0.849605,0.),
vec3f(-0.620106,-0.328104,0.),
vec3f(0.789239,-0.419965,0.),
vec3f(-0.545396,0.538133,0.),
vec3f(-0.178564,-0.596057,0.)
);fn computeShadowWithCSMPCSS(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=clamp(getZInClip(clipSpace,uvDepth),0.,GREATEST_LESS_THAN_ONE);var uvDepthLayer: vec4f= vec4f(uvDepth.x,uvDepth.y,f32(layer),uvDepth.z);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;for (var i: i32=0; i<searchTapCount; i ++) {blockerDepth=textureSample(depthTexture,depthSampler, uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}
var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);var filterRadius: vec4f= vec4f(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {var offset: vec4f= vec4f(poissonSamplers[i],0.);offset= vec4f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);let coords=uvDepthLayer+offset*filterRadius;shadow+=textureSampleCompare(shadowTexture,shadowSampler,coords.xy,i32(coords.z),coords.w);}
shadow/= f32(pcfTapCount);shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,numBlocker<1.0);}
fn computeShadowWithPCSS(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,searchTapCount: i32,pcfTapCount: i32,poissonSamplers: array<vec3f,64>)->f32
{var clipSpace: vec3f=vPositionFromLight.xyz/vPositionFromLight.w;var uvDepth: vec3f= vec3f(0.5*clipSpace.xyz+ vec3f(0.5));uvDepth.z=getZInClip(clipSpace,uvDepth);var blockerDepth: f32=0.0;var sumBlockerDepth: f32=0.0;var numBlocker: f32=0.0;var exitCondition: bool=depthMetric>1.0 || depthMetric<0.0;for (var i: i32=0; i<searchTapCount; i ++) {if (exitCondition) {break;}
blockerDepth=textureSampleLevel(depthTexture,depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy),0).r;numBlocker+=select(0.,1.,blockerDepth<depthMetric);sumBlockerDepth+=select(0.,blockerDepth,blockerDepth<depthMetric);}
exitCondition=exitCondition || numBlocker<1.0;var avgBlockerDepth: f32=sumBlockerDepth/numBlocker;var AAOffset: f32=shadowMapSizeInverse*10.;var penumbraRatio: f32=((depthMetric-avgBlockerDepth)+AAOffset);var filterRadius: f32=penumbraRatio*lightSizeUV*shadowMapSizeInverse;var random: f32=getRand(vPositionFromLight.xy);var rotationAngle: f32=random*3.1415926;var rotationVector: vec2f= vec2f(cos(rotationAngle),sin(rotationAngle));var shadow: f32=0.;for (var i: i32=0; i<pcfTapCount; i++) {if (exitCondition) {break;}
var offset: vec3f=poissonSamplers[i];offset= vec3f(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);let coords=uvDepth+offset*filterRadius;shadow+=textureSampleCompareLevel(shadowTexture,shadowSampler,coords.xy,coords.z);}
shadow/= f32(pcfTapCount);shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);shadow=mix(darkness,1.,shadow);return select(computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff),1.0,exitCondition);}
fn computeShadowWithPCSS16(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);}
fn computeShadowWithPCSS32(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);}
fn computeShadowWithPCSS64(vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32)->f32
{return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);}
fn computeShadowWithCSMPCSS16(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
fn computeShadowWithCSMPCSS32(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
fn computeShadowWithCSMPCSS64(layer: i32,vPositionFromLight: vec4f,depthMetric: f32,depthTexture: texture_2d_array<f32>,depthSampler: sampler,shadowTexture: texture_depth_2d_array,shadowSampler: sampler_comparison,shadowMapSizeInverse: f32,lightSizeUV: f32,darkness: f32,frustumEdgeFalloff: f32,lightSizeUVCorrection: vec2f,depthCorrection: f32,penumbraDarkness: f32)->f32
{return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthTexture,depthSampler,shadowTexture,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);}
#endif
`;D.IncludesShadersStoreWGSL[R$]=P$;var M$="shadowsVertex",D$=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vertexOutputs.vPositionFromCamera{X}=view*worldPos;
#if SHADOWCSMNUM_CASCADES{X}>0
vertexOutputs.vPositionFromLight{X}_0=uniforms.lightMatrix{X}[0]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_0=(-vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_0= (vertexOutputs.vPositionFromLight{X}_0.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#if SHADOWCSMNUM_CASCADES{X}>1
vertexOutputs.vPositionFromLight{X}_1=uniforms.lightMatrix{X}[1]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_1=(-vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_1= (vertexOutputs.vPositionFromLight{X}_1.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#if SHADOWCSMNUM_CASCADES{X}>2
vertexOutputs.vPositionFromLight{X}_2=uniforms.lightMatrix{X}[2]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_2=(-vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_2= (vertexOutputs.vPositionFromLight{X}_2.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#if SHADOWCSMNUM_CASCADES{X}>3
vertexOutputs.vPositionFromLight{X}_3=uniforms.lightMatrix{X}[3]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}_3=(-vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}_3= (vertexOutputs.vPositionFromLight{X}_3.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif 
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vertexOutputs.vPositionFromLight{X}=uniforms.lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric{X}=(-vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vertexOutputs.vDepthMetric{X}=(vertexOutputs.vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;D.IncludesShadersStoreWGSL[M$]=D$;var O$="fogFragmentDeclaration",w$=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vFogInfos: vec4f;uniform vFogColor: vec3f;varying vFogDistance: vec3f;fn CalcFogFactor()->f32
{var fogCoeff: f32=1.0;var fogStart: f32=uniforms.vFogInfos.y;var fogEnd: f32=uniforms.vFogInfos.z;var fogDensity: f32=uniforms.vFogInfos.w;var fogDistance: f32=length(fragmentInputs.vFogDistance);if (FOGMODE_LINEAR==uniforms.vFogInfos.x)
{fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);}
else if (FOGMODE_EXP==uniforms.vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDensity);}
else if (FOGMODE_EXP2==uniforms.vFogInfos.x)
{fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);}
return clamp(fogCoeff,0.0,1.0);}
#endif
`;D.IncludesShadersStoreWGSL[O$]=w$;var N$="bumpFragment",F$=`var uvOffset: vec2f= vec2f(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
var normalScale: f32=1.0;
#elif defined(BUMP)
var normalScale: f32=vBumpInfos.y;
#else
var normalScale: f32=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=vTBN;
#elif defined(BUMP)
var TBNUV: vec2f=select(-vBumpUV,vBumpUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
var TBNUV: vec2f=select(-vDetailUV,vDetailUV,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW*normalScale,vPositionW,TBNUV, vec2f(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
var TBN: mat3x3f=vTBN;
#else
var TBNUV: vec2f=select( -vMainUV1,vMainUV1,fragmentInputs.frontFacing);var TBN: mat3x3f=cotangent_frame(normalW,vPositionW,TBNUV, vec2f(1.,1.));
#endif
#endif
#ifdef PARALLAX
var invTBN: mat3x3f=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
var detailColor: vec4f=textureSample(detail,detailSampler,vDetailUV+uvOffset);var detailNormalRG: vec2f=detailColor.wy*2.0-1.0;var detailNormalB: f32=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));var detailNormal: vec3f= vec3f(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
#define CUSTOM_FRAGMENT_BUMP_FRAGMENT
normalW=normalize(textureSample(bump,bumpSampler,vBumpUV).xyz *2.0-1.0);normalW=normalize( mat3x3f(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,textureSample(bump,bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
var bumpNormal: vec3f=textureSample(bump,bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;var blendedNormal: vec3f=normalize( vec3f(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;bumpNormal+= vec3f(0.0,0.0,1.0);detailNormal*= vec3f(-1.0,-1.0,1.0);var blendedNormal: vec3f=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;D.IncludesShadersStoreWGSL[N$]=F$;var L$="bumpFragmentMainFunctions",B$=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying vTBN: mat3x3f;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform normalMatrix: mat4x4f;
#if defined(WEBGL2) || defined(WEBGPU)
fn toNormalMatrix(wMatrix: mat4x4f)->mat4x4f
{var ret: mat4x4f=inverse(wMatrix);ret=transpose(ret);ret[0][3]=0.;ret[1][3]=0.;ret[2][3]=0.;ret[3]= vec4f(0.,0.,0.,1.);return ret;}
#else
fn toNormalMatrix(m: mat4x4f)->mat4x4f
{var a00: f32=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],
a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],
a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],
a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],
b00=a00*a11-a01*a10,
b01=a00*a12-a02*a10,
b02=a00*a13-a03*a10,
b03=a01*a12-a02*a11,
b04=a01*a13-a03*a11,
b05=a02*a13-a03*a12,
b06=a20*a31-a21*a30,
b07=a20*a32-a22*a30,
b08=a20*a33-a23*a30,
b09=a21*a32-a22*a31,
b10=a21*a33-a23*a31,
b11=a22*a33-a23*a32,
det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;var mi: mat4x4f= mat4x4f(
a11*b11-a12*b10+a13*b09,
a02*b10-a01*b11-a03*b09,
a31*b05-a32*b04+a33*b03,
a22*b04-a21*b05-a23*b03,
a12*b08-a10*b11-a13*b07,
a00*b11-a02*b08+a03*b07,
a32*b02-a30*b05-a33*b01,
a20*b05-a22*b02+a23*b01,
a10*b10-a11*b08+a13*b06,
a01*b08-a00*b10-a03*b06,
a30*b04-a31*b02+a33*b00,
a21*b02-a20*b04-a23*b00,
a11*b07-a10*b09-a12*b06,
a00*b09-a01*b07+a02*b06,
a31*b01-a30*b03-a32*b00,
a20*b03-a21*b01+a22*b00)/det;return mat4x4f(mi[0][0],mi[1][0],mi[2][0],mi[3][0],
mi[0][1],mi[1][1],mi[2][1],mi[3][1],
mi[0][2],mi[1][2],mi[2][2],mi[3][2],
mi[0][3],mi[1][3],mi[2][3],mi[3][3]);}
#endif
#endif
fn perturbNormalBase(cotangentFrame: mat3x3f,normal: vec3f,scale: f32)->vec3f
{
#ifdef NORMALXYSCALE
normal=normalize(normal* vec3f(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);}
fn perturbNormal(cotangentFrame: mat3x3f,textureSample: vec3f,scale: f32)->vec3f
{return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);}
fn cotangent_frame(normal: vec3f,p: vec3f,uv: vec2f,tangentSpaceParams: vec2f)->mat3x3f
{var dp1: vec3f=dpdx(p);var dp2: vec3f=dpdy(p);var duv1: vec2f=dpdx(uv);var duv2: vec2f=dpdy(uv);var dp2perp: vec3f=cross(dp2,normal);var dp1perp: vec3f=cross(normal,dp1);var tangent: vec3f=dp2perp*duv1.x+dp1perp*duv2.x;var bitangent: vec3f=dp2perp*duv1.y+dp1perp*duv2.y;tangent*=tangentSpaceParams.x;bitangent*=tangentSpaceParams.y;var det: f32=max(dot(tangent,tangent),dot(bitangent,bitangent));var invmax: f32=select(inverseSqrt(det),0.0,det==0.0);return mat3x3f(tangent*invmax,bitangent*invmax,normal);}
#endif
`;D.IncludesShadersStoreWGSL[L$]=B$;var V$="samplerFragmentDeclaration",U$=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying v_VARYINGNAME_UV: vec2f;
#endif
uniform _SAMPLERNAME_Sampler: sampler;uniform _SAMPLERNAME_: texture_2d<f32>;
#endif
`;D.IncludesShadersStoreWGSL[V$]=U$;var k$="bumpFragmentFunctions",G$=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const minSamples: f32=4.;const maxSamples: f32=15.;const iMaxSamples: i32=15;fn parallaxOcclusion(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32)->vec2f {var parallaxLimit: f32=length(vViewDirCoT.xy)/vViewDirCoT.z;parallaxLimit*=parallaxScale;var vOffsetDir: vec2f=normalize(vViewDirCoT.xy);var vMaxOffset: vec2f=vOffsetDir*parallaxLimit;var numSamples: f32=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));var stepSize: f32=1.0/numSamples;var currRayHeight: f32=1.0;var vCurrOffset: vec2f= vec2f(0,0);var vLastOffset: vec2f= vec2f(0,0);var lastSampledHeight: f32=1.0;var currSampledHeight: f32=1.0;var keepWorking: bool=true;for (var i: i32=0; i<iMaxSamples; i++)
{currSampledHeight=textureSample(bump,bumpSampler,texCoord+vCurrOffset).w;if (!keepWorking)
{}
else if (currSampledHeight>currRayHeight)
{var delta1: f32=currSampledHeight-currRayHeight;var delta2: f32=(currRayHeight+stepSize)-lastSampledHeight;var ratio: f32=delta1/(delta1+delta2);vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;keepWorking=false;}
else
{currRayHeight-=stepSize;vLastOffset=vCurrOffset;
#ifdef PARALLAX_RHS
vCurrOffset-=stepSize*vMaxOffset;
#else
vCurrOffset+=stepSize*vMaxOffset;
#endif
lastSampledHeight=currSampledHeight;}}
return vCurrOffset;}
fn parallaxOffset(viewDir: vec3f,heightScale: f32)->vec2f
{var height: f32=textureSample(bump,bumpSampler,vBumpUV).w;var texCoordOffset: vec2f=heightScale*viewDir.xy*height;
#ifdef PARALLAX_RHS
return texCoordOffset;
#else
return -texCoordOffset;
#endif
}
#endif
`;D.IncludesShadersStoreWGSL[k$]=G$;var z$="imageProcessingDeclaration",W$=`#ifdef EXPOSURE
uniform exposureLinear: f32;
#endif
#ifdef CONTRAST
uniform contrast: f32;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vInverseScreenSize: vec2f;
#endif
#ifdef VIGNETTE
uniform vignetteSettings1: vec4f;uniform vignetteSettings2: vec4f;
#endif
#ifdef COLORCURVES
uniform vCameraColorCurveNegative: vec4f;uniform vCameraColorCurveNeutral: vec4f;uniform vCameraColorCurvePositive: vec4f;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform colorTransformSettings: vec4f;
#endif
#ifdef DITHER
uniform ditherIntensity: f32;
#endif
`;D.IncludesShadersStoreWGSL[z$]=W$;var H$="imageProcessingFunctions",X$=`#if TONEMAPPING==3
const PBRNeutralStartCompression: f32=0.8-0.04;const PBRNeutralDesaturation: f32=0.15;fn PBRNeutralToneMapping( color: vec3f )->vec3f {var x: f32=min(color.r,min(color.g,color.b));var offset: f32=select(0.04,x-6.25*x*x,x<0.08);var result=color;result-=offset;var peak: f32=max(result.r,max(result.g,result.b));if (peak<PBRNeutralStartCompression) {return result;}
var d: f32=1.-PBRNeutralStartCompression;var newPeak: f32=1.-d*d/(peak+d-PBRNeutralStartCompression);result*=newPeak/peak;var g: f32=1.-1./(PBRNeutralDesaturation*(peak-newPeak)+1.);return mix(result,newPeak* vec3f(1,1,1),g);}
#endif
#if TONEMAPPING==2
const ACESInputMat: mat3x3f= mat3x3f(
vec3f(0.59719,0.07600,0.02840),
vec3f(0.35458,0.90834,0.13383),
vec3f(0.04823,0.01566,0.83777)
);const ACESOutputMat: mat3x3f= mat3x3f(
vec3f( 1.60475,-0.10208,-0.00327),
vec3f(-0.53108, 1.10813,-0.07276),
vec3f(-0.07367,-0.00605, 1.07602)
);fn RRTAndODTFit(v: vec3f)->vec3f
{var a: vec3f=v*(v+0.0245786)-0.000090537;var b: vec3f=v*(0.983729*v+0.4329510)+0.238081;return a/b;}
fn ACESFitted(color: vec3f)->vec3f
{var output=ACESInputMat*color;output=RRTAndODTFit(output);output=ACESOutputMat*output;output=saturate(output);return output;}
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_DEFINITIONS
fn applyImageProcessing(result: vec4f)->vec4f {
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATSTART
var rgb=result.rgb;;
#ifdef EXPOSURE
rgb*=uniforms.exposureLinear;
#endif
#ifdef VIGNETTE
var viewportXY: vec2f=fragmentInputs.position.xy*uniforms.vInverseScreenSize;viewportXY=viewportXY*2.0-1.0;var vignetteXY1: vec3f= vec3f(viewportXY*uniforms.vignetteSettings1.xy+uniforms.vignetteSettings1.zw,1.0);var vignetteTerm: f32=dot(vignetteXY1,vignetteXY1);var vignette: f32=pow(vignetteTerm,uniforms.vignetteSettings2.w);var vignetteColor: vec3f=uniforms.vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
var vignetteColorMultiplier: vec3f=mix(vignetteColor, vec3f(1,1,1),vignette);rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
rgb=mix(vignetteColor,rgb,vignette);
#endif
#endif
#if TONEMAPPING==3
rgb=PBRNeutralToneMapping(rgb);
#elif TONEMAPPING==2
rgb=ACESFitted(rgb);
#elif TONEMAPPING==1
const tonemappingCalibration: f32=1.590579;rgb=1.0-exp2(-tonemappingCalibration*rgb);
#endif
rgb=toGammaSpaceVec3(rgb);rgb=saturate(rgb);
#ifdef CONTRAST
var resultHighContrast: vec3f=rgb*rgb*(3.0-2.0*rgb);if (uniforms.contrast<1.0) {rgb=mix( vec3f(0.5,0.5,0.5),rgb,uniforms.contrast);} else {rgb=mix(rgb,resultHighContrast,uniforms.contrast-1.0);}
#endif
#ifdef COLORGRADING
var colorTransformInput: vec3f=rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
var colorTransformOutput: vec3f=texture(txColorTransform,colorTransformInput).rgb;
#else
var colorTransformOutput: vec3f=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
rgb=mix(rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
var luma: f32=getLuminance(rgb);var curveMix: vec2f=clamp( vec2f(luma*3.0-1.5,luma*-3.0+1.5), vec2f(0.0), vec2f(1.0));var colorCurve: vec4f=uniforms.vCameraColorCurveNeutral+curveMix.x*uniforms.vCameraColorCurvePositive-curveMix.y*uniforms.vCameraColorCurveNegative;rgb*=colorCurve.rgb;rgb=mix( vec3f(luma),rgb,colorCurve.a);
#endif
#ifdef DITHER
var rand: f32=getRand(fragmentInputs.position.xy*uniforms.vInverseScreenSize);var dither: f32=mix(-uniforms.ditherIntensity,uniforms.ditherIntensity,rand);rgb=saturate(rgb+ vec3f(dither));
#endif
#define CUSTOM_IMAGEPROCESSINGFUNCTIONS_UPDATERESULT_ATEND
return vec4f(rgb,result.a);}`;D.IncludesShadersStoreWGSL[H$]=X$;var Y$="reflectionFunction",$$=`fn computeFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f
{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0); }
fn computeMirroredFixedEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,direction: vec3f)->vec3f
{var lon: f32=atan2(direction.z,direction.x);var lat: f32=acos(direction.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(1.0-s,t,0); }
fn computeEquirectangularCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var cameraToVertex: vec3f=normalize(worldPos.xyz-eyePosition);var r: vec3f=normalize(reflect(cameraToVertex,worldNormal));r= (reflectionMatrix* vec4f(r,0)).xyz;var lon: f32=atan2(r.z,r.x);var lat: f32=acos(r.y);var sphereCoords: vec2f= vec2f(lon,lat)*RECIPROCAL_PI2*2.0;var s: f32=sphereCoords.x*0.5+0.5;var t: f32=sphereCoords.y;return vec3f(s,t,0);}
fn computeSphericalCoords(worldPos: vec4f,worldNormal: vec3f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=normalize((view*worldPos).xyz);var viewNormal: vec3f=normalize((view* vec4f(worldNormal,0.0)).xyz);var r: vec3f=reflect(viewDir,viewNormal);r= (reflectionMatrix* vec4f(r,0)).xyz;r.z=r.z-1.0;var m: f32=2.0*length(r);return vec3f(r.x/m+0.5,1.0-r.y/m-0.5,0);}
fn computePlanarCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=worldPos.xyz-eyePosition;var coords: vec3f=normalize(reflect(viewDir,worldNormal));return (reflectionMatrix* vec4f(coords,1)).xyz;}
fn computeCubicCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f)->vec3f
{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords= (reflectionMatrix* vec4f(coords,0)).xyz;
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
fn computeCubicLocalCoords(worldPos: vec4f,worldNormal: vec3f,eyePosition: vec3f,reflectionMatrix: mat4x4f,reflectionSize: vec3f,reflectionPosition: vec3f)->vec3f
{var viewDir: vec3f=normalize(worldPos.xyz-eyePosition);var coords: vec3f=reflect(viewDir,worldNormal);coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);coords=(reflectionMatrix* vec4f(coords,0)).xyz;
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;}
fn computeProjectionCoords(worldPos: vec4f,view: mat4x4f,reflectionMatrix: mat4x4f)->vec3f
{return (reflectionMatrix*(view*worldPos)).xyz;}
fn computeSkyBoxCoords(positionW: vec3f,reflectionMatrix: mat4x4f)->vec3f
{return (reflectionMatrix* vec4f(positionW,1.)).xyz;}
#ifdef REFLECTION
fn computeReflectionCoords(worldPos: vec4f,worldNormal: vec3f)->vec3f
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
var direction: vec3f=normalize(vDirectionW);return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
var direction: vec3f=normalize(vDirectionW);return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3f(0,0,0);
#endif
}
#endif
`;D.IncludesShadersStoreWGSL[Y$]=$$;var j$="fogVertexDeclaration",q$=`#ifdef FOG
varying vFogDistance: vec3f;
#endif
`;D.IncludesShadersStoreWGSL[j$]=q$;var Q$="logDepthDeclaration",K$=`#ifdef LOGARITHMICDEPTH
uniform logarithmicDepthConstant: f32;varying vFragmentDepth: f32;
#endif
`;D.IncludesShadersStoreWGSL[Q$]=K$;var Z$="fogVertex",J$=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;D.IncludesShadersStoreWGSL[Z$]=J$;var ej="logDepthVertex",tj=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+vertexOutputs.position.w;vertexOutputs.position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;D.IncludesShadersStoreWGSL[ej]=tj;var ij="particlesVertexShader",rj=`attribute position: vec3f;attribute color: vec4f;attribute angle: f32;attribute size: vec2f;
#ifdef ANIMATESHEET
attribute cellIndex: f32;
#endif
#ifndef BILLBOARD
attribute direction: vec3f;
#endif
#ifdef BILLBOARDSTRETCHED
attribute direction: vec3f;
#endif
#ifdef RAMPGRADIENT
attribute remapData: vec4f;
#endif
attribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform translationPivot: vec2f;
#ifdef ANIMATESHEET
uniform particlesInfos: vec3f; 
#endif
varying vUV: vec2f;varying vColor: vec4f;varying vPositionW: vec3f;
#ifdef RAMPGRADIENT
varying remapRanges: vec4f;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform invView: mat4x4f;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef BILLBOARD
uniform eyePosition: vec3f;
#endif
fn rotate(yaxis: vec3f,rotatedCorner: vec3f)->vec3f {var xaxis: vec3f=normalize(cross( vec3f(0.,1.0,0.),yaxis));var zaxis: vec3f=normalize(cross(yaxis,xaxis));var row0: vec3f= vec3f(xaxis.x,xaxis.y,xaxis.z);var row1: vec3f= vec3f(yaxis.x,yaxis.y,yaxis.z);var row2: vec3f= vec3f(zaxis.x,zaxis.y,zaxis.z);var rotMatrix: mat3x3f= mat3x3f(row0,row1,row2);var alignedCorner: vec3f=rotMatrix*rotatedCorner;return vertexInputs.position+alignedCorner;}
#ifdef BILLBOARDSTRETCHED
fn rotateAlign(toCamera: vec3f,rotatedCorner: vec3f)->vec3f {var normalizedToCamera: vec3f=normalize(toCamera);var normalizedCrossDirToCamera: vec3f=normalize(cross(normalize(direction),normalizedToCamera));var row0: vec3f= vec3f(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);var row2: vec3f= vec3f(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
#ifdef BILLBOARDSTRETCHED_LOCAL
var row1: vec3f=direction;
#else
var crossProduct: vec3f=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));var row1: vec3f= vec3f(crossProduct.x,crossProduct.y,crossProduct.z);
#endif
var rotMatrix: mat3x3f= mat3x3f(row0,row1,row2);var alignedCorner: vec3f=rotMatrix*rotatedCorner;return vertexInputs.position+alignedCorner;}
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input: VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var cornerPos: vec2f;cornerPos=( vec2f(vertexInputs.offset.x-0.5,vertexInputs.offset.y -0.5)-uniforms.translationPivot)*vertexInputs.size;
#ifdef BILLBOARD
var rotatedCorner: vec3f;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(vertexInputs.angle)-cornerPos.y*sin(vertexInputs.ngle);rotatedCorner.z=cornerPos.x*sin(vertexInputs.angle)+cornerPos.y*cos(vertexInputs.angle);rotatedCorner.y=0.;rotatedCorner.xz+=uniforms.translationPivot;var yaxis: vec3f=vertexInputs.position-eyePosition;yaxis.y=0.;vertexOutputs.vPositionW=rotate(normalize(yaxis),rotatedCorner);var viewPos: vec3f=(uniforms.view* vec4f(vertexOutputs.vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(vertexInputs.angle)-cornerPos.y*sin(vertexInputs.angle);rotatedCorner.y=cornerPos.x*sin(vertexInputs.angle)+cornerPos.y*cos(vertexInputs.angle);rotatedCorner.z=0.;rotatedCorner.x+=uniforms.translationPivot.x;rotatedCorner.y+=uniforms.translationPivot.y;var toCamera: vec3f=vertexInputs.position-eyePosition;vertexOutputs.vPositionW=rotateAlign(toCamera,rotatedCorner);var viewPos: vec3f=(uniforms.view* vec4f(vertexOutputs.vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(vertexInputs.angle)-cornerPos.y*sin(vertexInputs.angle);rotatedCorner.y=cornerPos.x*sin(vertexInputs.angle)+cornerPos.y*cos(vertexInputs.angle);rotatedCorner.z=0.;rotatedCorner.x+=uniforms.translationPivot.x;rotatedCorner.y+=uniforms.translationPivot.y;var viewPos: vec3f=(uniforms.view* vec4f(vertexInputs.position,1.0)).xyz+rotatedCorner;vertexOutputs.vPositionW=(uniforms.invView* vec4f(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
remapRanges=remapData;
#endif
vertexOutputs.position=uniforms.projection* vec4f(viewPos,1.0);
#else
var rotatedCorner: vec3f;rotatedCorner.x=cornerPos.x*cos(vertexInputs.angle)-cornerPos.y*sin(vertexInputs.angle);rotatedCorner.z=cornerPos.x*sin(vertexInputs.angle)+cornerPos.y*cos(vertexInputs.angle);rotatedCorner.y=0.;rotatedCorner.x+=uniforms.translationPivot.x;rotatedCorner.y+=uniforms.translationPivot.y;var yaxis: vec3f=normalize(direction);vertexOutputs.vPositionW=rotate(yaxis,rotatedCorner);vertexOutputs.position=uniforms.projection*view* vec4f(vertexOutputs.vPositionW,1.0);
#endif
vertexOutputs.vColor=vertexInputs.color;
#ifdef ANIMATESHEET
var rowOffset: f32=floor(cellIndex*particlesInfos.z);var columnOffset: f32=cellIndex-rowOffset/particlesInfos.z;var uvScale: vec2f=particlesInfos.xy;var uvOffset: vec2f= vec2f(vertexInputs.offset.x ,1.0-vertexInputs.offset.y);vertexOutputs.vUV=(uvOffset+ vec2f(columnOffset,rowOffset))*uvScale;
#else
vertexOutputs.vUV=vertexInputs.offset;
#endif
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
var worldPos: vec4f= vec4f(vertexOutputs.vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStoreWGSL[ij]=rj;var uV="fragmentOutputs.fragDepth",sj="uniforms",nj="internals",oj={texture_1d:dt.E1d,texture_2d:dt.E2d,texture_2d_array:dt.E2dArray,texture_3d:dt.E3d,texture_cube:dt.Cube,texture_cube_array:dt.CubeArray,texture_multisampled_2d:dt.E2d,texture_depth_2d:dt.E2d,texture_depth_2d_array:dt.E2dArray,texture_depth_cube:dt.Cube,texture_depth_cube_array:dt.CubeArray,texture_depth_multisampled_2d:dt.E2d,texture_storage_1d:dt.E1d,texture_storage_2d:dt.E2d,texture_storage_2d_array:dt.E2dArray,texture_storage_3d:dt.E3d,texture_external:null},Qv=class extends Li{constructor(){super(...arguments),this.shaderLanguage=pe.WGSL,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0}preProcessor(e,t,i,r,n){for(let o in i){if(o==="__VERSION__")continue;let a=i[o];(!isNaN(parseInt(a))||!isNaN(parseFloat(a)))&&(e=`const ${o} = ${a};
`+e)}return e}_getArraySize(e,t,i){let r=0,n=t.lastIndexOf(">");if(t.indexOf("array")>=0&&n>0){let o=n;for(;o>0&&t.charAt(o)!==" "&&t.charAt(o)!==",";)o--;let a=t.substring(o+1,n);for(r=+a,isNaN(r)&&(r=+i[a.trim()]);o>0&&(t.charAt(o)===" "||t.charAt(o)===",");)o--;t=t.substring(t.indexOf("<")+1,o+1)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesInputWGSL=[],this._attributesWGSL=[],this._attributesConversionCodeWGSL=[],this._hasNonFloatAttribute=!1,this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){let t=`struct ${Li.InternalsUBOName} {
  yFactor_: f32,
  textureOutputHeight_: f32,
};
var<uniform> ${nj} : ${Li.InternalsUBOName};
`;return e.indexOf(t)!==-1?e:t+Tm(e)}varyingCheck(e,t){return/(flat|linear|perspective)?\s*(center|centroid|sample)?\s*\bvarying\b/.test(e)}varyingProcessor(e,t,i){let n=/\s*(flat|linear|perspective)?\s*(center|centroid|sample)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(n!==null){let o=n[1]??"perspective",a=n[2]??"center",l=n[4],c=n[3],h=o==="flat"?`@interpolate(${o})`:`@interpolate(${o}, ${a})`,u;t?(u=this._webgpuProcessingContext.availableVaryings[c],u===void 0&&F.Warn(`Invalid fragment shader: The varying named "${c}" is not declared in the vertex shader! This declaration will be ignored.`)):(u=this._webgpuProcessingContext.getVaryingNextLocation(l,this._getArraySize(c,l,i)[2]),this._webgpuProcessingContext.availableVaryings[c]=u,this._varyingsWGSL.push(`  @location(${u}) ${h} ${c} : ${l},`),this._varyingNamesWGSL.push(c)),e=""}return e}attributeProcessor(e,t){let r=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(r!==null){let n=r[2],o=r[1],a=this._webgpuProcessingContext.getAttributeNextLocation(n,this._getArraySize(o,n,t)[2]);this._webgpuProcessingContext.availableAttributes[o]=a,this._webgpuProcessingContext.orderedAttributes[a]=o;let l=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[o];if(l!==void 0){let c=l<0?l===-1?"i32":"vec"+-l+"<i32>":l===1?"u32":"vec"+l+"<u32>",h=`_int_${o}_`;this._attributesInputWGSL.push(`@location(${a}) ${h} : ${c},`),this._attributesWGSL.push(`${o} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${o} = ${n}(vertexInputs_.${h});`),this._hasNonFloatAttribute=!0}else this._attributesInputWGSL.push(`@location(${a}) ${o} : ${n},`),this._attributesWGSL.push(`${o} : ${n},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${o} = vertexInputs_.${o};`);e=""}return e}uniformProcessor(e,t,i){let r=this.uniformRegexp.exec(e);if(r!==null){let n=r[2],o=r[1];this._addUniformToLeftOverUBO(o,n,i),e=""}return e}textureProcessor(e,t,i){let r=this.textureRegexp.exec(e);if(r!==null){let n=r[1],o=r[2],a=!!r[3],l=r[4],c=l.indexOf("storage")>0,h=r[6],u=c?h.substring(0,h.indexOf(",")).trim():null,d=a?this._getArraySize(n,o,i)[2]:0,f=this._webgpuProcessingContext.availableTextures[n];if(f)d=f.textures.length;else{f={isTextureArray:d>0,isStorageTexture:c,textures:[],sampleType:Ts.Float},d=d||1;for(let x=0;x<d;++x)f.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[n]=f;let m=l.indexOf("depth")>0,g=oj[l],_=m?Ts.Depth:h==="u32"?Ts.Uint:h==="i32"?Ts.Sint:Ts.Float;if(f.sampleType=_,g===void 0)throw`Can't get the texture dimension corresponding to the texture function "${l}"!`;for(let x=0;x<d;++x){let{groupIndex:b,bindingIndex:C}=f.textures[x];x===0&&(e=`@group(${b}) @binding(${C}) ${e}`),this._addTextureBindingDescription(n,f,x,g,u,!t)}}return e}finalizeShaders(e,t){let i=t.indexOf("fragmentInputs.position")>=0?`
            if (internals.yFactor_ == 1.) {
                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;
            }
        `:"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);let r=this._buildLeftOverUBO();e=r+e,t=r+t,e=e.replace(/#define (\w+)\s+(\d+\.?\d*)/g,"const $1 = $2;"),e=e.replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let n=`struct VertexInputs {
  @builtin(vertex_index) vertexIndex : u32,
  @builtin(instance_index) instanceIndex : u32,
`;this._attributesInputWGSL.length>0&&(n+=this._attributesInputWGSL.join(`
`)),n+=`
};
var<private> vertexInputs`+(this._hasNonFloatAttribute?"_":"")+` : VertexInputs;
`,this._hasNonFloatAttribute&&(n+=`struct VertexInputs_ {
  vertexIndex : u32, instanceIndex : u32,
`,n+=this._attributesWGSL.join(`
`),n+=`
};
var<private> vertexInputs : VertexInputs_;
`);let o=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
`;this._varyingsWGSL.length>0&&(o+=this._varyingsWGSL.join(`
`)),o+=`
};
var<private> vertexOutputs : FragmentInputs;
`,e=n+o+e;let a=`
  vertexInputs${this._hasNonFloatAttribute?"_":""} = input;
`;this._hasNonFloatAttribute&&(a+=`vertexInputs.vertexIndex = vertexInputs_.vertexIndex;
vertexInputs.instanceIndex = vertexInputs_.instanceIndex;
`,a+=this._attributesConversionCodeWGSL.join(`
`),a+=`
`);let l=`  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;
  return vertexOutputs;`,c=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")!==-1;e=(c?`diagnostic(off, derivative_uniformity);
`:"")+fh(e,"fn main",a,l),t=t.replace(/#define (\w+)\s+(\d+\.?\d*)/g,"const $1 = $2;"),t=t.replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t),t=t.replace(/dpdy/g,"(-internals.yFactor_)*dpdy");let h=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
  @builtin(front_facing) frontFacing : bool,
`;this._varyingsWGSL.length>0&&(h+=this._varyingsWGSL.join(`
`)),h+=`
};
var<private> fragmentInputs : FragmentInputs;
`;let u=`struct FragmentOutputs {
  @location(0) color : vec4<f32>,
`,d=!1,f=0;for(;!d&&(f=t.indexOf(uV,f),!(f<0));){let _=f;for(d=!0;f>1&&t.charAt(f)!==`
`;){if(t.charAt(f)==="/"&&t.charAt(f-1)==="/"){d=!1;break}f--}f=_+uV.length}d&&(u+=`  @builtin(frag_depth) fragDepth: f32,
`),u+=`};
var<private> fragmentOutputs : FragmentOutputs;
`,t=h+u+t;let m=`  fragmentInputs = input;
  `+i,g="  return fragmentOutputs;";return c=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")!==-1,t=(c?`diagnostic(off, derivative_uniformity);
`:"")+fh(t,"fn main",m,g),this._collectBindingNames(),this._preCreateBindGroupEntries(),this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",r=`struct ${e} {
`;for(let n of this._webgpuProcessingContext.leftOverUniforms){let o=n.type.replace(/^(.*?)(<.*>)?$/,"$1"),a=Li.UniformSizes[o];if(n.length>0)if(a<=2){let l=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${l} {
                        @size(16)
                        el: ${o},
                    }`,this._stridedUniformArrays.push(n.name),r+=` @align(16) ${n.name} : array<${l}, ${n.length}>,
`}else r+=` ${n.name} : array<${n.type}, ${n.length}>,
`;else r+=`  ${n.name} : ${n.type},
`}return r+=`};
`,r=`${i}
${r}`,r+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> ${sj} : ${e};
`,r}_processSamplers(e,t){let i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){let r=i.exec(e);if(r===null)break;let n=r[1],o=r[2],a=n.length-7,l=n.lastIndexOf("Sampler")===a?n.substring(0,a):null,c=o==="sampler_comparison"?ma.Comparison:ma.Filtering;if(l){let m=this._webgpuProcessingContext.availableTextures[l];m&&(m.autoBindSampler=!0)}let h=this._webgpuProcessingContext.availableSamplers[n];h||(h={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:c},this._webgpuProcessingContext.availableSamplers[n]=h),this._addSamplerBindingDescription(n,h,t);let u=e.substring(0,r.index),d=`@group(${h.binding.groupIndex}) @binding(${h.binding.bindingIndex}) `,f=e.substring(r.index);e=u+d+f,i.lastIndex+=d.length}return e}_processCustomBuffers(e,t){let i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){let r=i.exec(e);if(r===null)break;let n=r[1],o=r[3],a=r[4],l=r[5],c=this._webgpuProcessingContext.availableBuffers[a];if(!c){let g=n==="uniform"?_a.KnownUBOs[l]:null,_;g?(a=l,_=g.binding,_.groupIndex===-1&&(_=this._webgpuProcessingContext.availableBuffers[a]?.binding,_||(_=this._webgpuProcessingContext.getNextFreeUBOBinding()))):_=this._webgpuProcessingContext.getNextFreeUBOBinding(),c={binding:_},this._webgpuProcessingContext.availableBuffers[a]=c}this._addBufferBindingDescription(a,this._webgpuProcessingContext.availableBuffers[a],o==="read_write"?pa.Storage:n==="storage"?pa.ReadOnlyStorage:pa.Uniform,t);let h=c.binding.groupIndex,u=c.binding.bindingIndex,d=e.substring(0,r.index),f=`@group(${h}) @binding(${u}) `,m=e.substring(r.index);e=d+f+m,i.lastIndex+=f.length}return e}_processStridedUniformArrays(e){for(let t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*?)\\]`,"g"),`${t}[$1].el`);return e}};var ut=class{static ComputeNumMipmapLevels(e,t){return xe.ILog2(Math.max(e,t))+1}static GetTextureTypeFromFormat(e){switch(e){case B.R8Unorm:case B.R8Snorm:case B.R8Uint:case B.R8Sint:case B.RG8Unorm:case B.RG8Snorm:case B.RG8Uint:case B.RG8Sint:case B.RGBA8Unorm:case B.RGBA8UnormSRGB:case B.RGBA8Snorm:case B.RGBA8Uint:case B.RGBA8Sint:case B.BGRA8Unorm:case B.BGRA8UnormSRGB:case B.RGB10A2UINT:case B.RGB10A2Unorm:case B.RGB9E5UFloat:case B.RG11B10UFloat:case B.BC7RGBAUnorm:case B.BC7RGBAUnormSRGB:case B.BC6HRGBUFloat:case B.BC6HRGBFloat:case B.BC5RGUnorm:case B.BC5RGSnorm:case B.BC3RGBAUnorm:case B.BC3RGBAUnormSRGB:case B.BC2RGBAUnorm:case B.BC2RGBAUnormSRGB:case B.BC4RUnorm:case B.BC4RSnorm:case B.BC1RGBAUnorm:case B.BC1RGBAUnormSRGB:case B.ETC2RGB8Unorm:case B.ETC2RGB8UnormSRGB:case B.ETC2RGB8A1Unorm:case B.ETC2RGB8A1UnormSRGB:case B.ETC2RGBA8Unorm:case B.ETC2RGBA8UnormSRGB:case B.EACR11Unorm:case B.EACR11Snorm:case B.EACRG11Unorm:case B.EACRG11Snorm:case B.ASTC4x4Unorm:case B.ASTC4x4UnormSRGB:case B.ASTC5x4Unorm:case B.ASTC5x4UnormSRGB:case B.ASTC5x5Unorm:case B.ASTC5x5UnormSRGB:case B.ASTC6x5Unorm:case B.ASTC6x5UnormSRGB:case B.ASTC6x6Unorm:case B.ASTC6x6UnormSRGB:case B.ASTC8x5Unorm:case B.ASTC8x5UnormSRGB:case B.ASTC8x6Unorm:case B.ASTC8x6UnormSRGB:case B.ASTC8x8Unorm:case B.ASTC8x8UnormSRGB:case B.ASTC10x5Unorm:case B.ASTC10x5UnormSRGB:case B.ASTC10x6Unorm:case B.ASTC10x6UnormSRGB:case B.ASTC10x8Unorm:case B.ASTC10x8UnormSRGB:case B.ASTC10x10Unorm:case B.ASTC10x10UnormSRGB:case B.ASTC12x10Unorm:case B.ASTC12x10UnormSRGB:case B.ASTC12x12Unorm:case B.ASTC12x12UnormSRGB:case B.Stencil8:return 0;case B.R16Uint:case B.R16Sint:case B.RG16Uint:case B.RG16Sint:case B.RGBA16Uint:case B.RGBA16Sint:case B.Depth16Unorm:return 5;case B.R16Float:case B.RG16Float:case B.RGBA16Float:return 2;case B.R32Uint:case B.R32Sint:case B.RG32Uint:case B.RG32Sint:case B.RGBA32Uint:case B.RGBA32Sint:return 7;case B.R32Float:case B.RG32Float:case B.RGBA32Float:case B.Depth32Float:case B.Depth32FloatStencil8:case B.Depth24Plus:case B.Depth24PlusStencil8:return 1}return 0}static GetBlockInformationFromFormat(e){switch(e){case B.R8Unorm:case B.R8Snorm:case B.R8Uint:case B.R8Sint:return{width:1,height:1,length:1};case B.R16Uint:case B.R16Sint:case B.R16Float:case B.RG8Unorm:case B.RG8Snorm:case B.RG8Uint:case B.RG8Sint:return{width:1,height:1,length:2};case B.R32Uint:case B.R32Sint:case B.R32Float:case B.RG16Uint:case B.RG16Sint:case B.RG16Float:case B.RGBA8Unorm:case B.RGBA8UnormSRGB:case B.RGBA8Snorm:case B.RGBA8Uint:case B.RGBA8Sint:case B.BGRA8Unorm:case B.BGRA8UnormSRGB:case B.RGB9E5UFloat:case B.RGB10A2UINT:case B.RGB10A2Unorm:case B.RG11B10UFloat:return{width:1,height:1,length:4};case B.RG32Uint:case B.RG32Sint:case B.RG32Float:case B.RGBA16Uint:case B.RGBA16Sint:case B.RGBA16Float:return{width:1,height:1,length:8};case B.RGBA32Uint:case B.RGBA32Sint:case B.RGBA32Float:return{width:1,height:1,length:16};case B.Stencil8:throw"No fixed size for Stencil8 format!";case B.Depth16Unorm:return{width:1,height:1,length:2};case B.Depth24Plus:throw"No fixed size for Depth24Plus format!";case B.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!";case B.Depth32Float:return{width:1,height:1,length:4};case B.Depth32FloatStencil8:return{width:1,height:1,length:5};case B.BC7RGBAUnorm:case B.BC7RGBAUnormSRGB:case B.BC6HRGBUFloat:case B.BC6HRGBFloat:case B.BC5RGUnorm:case B.BC5RGSnorm:case B.BC3RGBAUnorm:case B.BC3RGBAUnormSRGB:case B.BC2RGBAUnorm:case B.BC2RGBAUnormSRGB:return{width:4,height:4,length:16};case B.BC4RUnorm:case B.BC4RSnorm:case B.BC1RGBAUnorm:case B.BC1RGBAUnormSRGB:return{width:4,height:4,length:8};case B.ETC2RGB8Unorm:case B.ETC2RGB8UnormSRGB:case B.ETC2RGB8A1Unorm:case B.ETC2RGB8A1UnormSRGB:case B.EACR11Unorm:case B.EACR11Snorm:return{width:4,height:4,length:8};case B.ETC2RGBA8Unorm:case B.ETC2RGBA8UnormSRGB:case B.EACRG11Unorm:case B.EACRG11Snorm:return{width:4,height:4,length:16};case B.ASTC4x4Unorm:case B.ASTC4x4UnormSRGB:return{width:4,height:4,length:16};case B.ASTC5x4Unorm:case B.ASTC5x4UnormSRGB:return{width:5,height:4,length:16};case B.ASTC5x5Unorm:case B.ASTC5x5UnormSRGB:return{width:5,height:5,length:16};case B.ASTC6x5Unorm:case B.ASTC6x5UnormSRGB:return{width:6,height:5,length:16};case B.ASTC6x6Unorm:case B.ASTC6x6UnormSRGB:return{width:6,height:6,length:16};case B.ASTC8x5Unorm:case B.ASTC8x5UnormSRGB:return{width:8,height:5,length:16};case B.ASTC8x6Unorm:case B.ASTC8x6UnormSRGB:return{width:8,height:6,length:16};case B.ASTC8x8Unorm:case B.ASTC8x8UnormSRGB:return{width:8,height:8,length:16};case B.ASTC10x5Unorm:case B.ASTC10x5UnormSRGB:return{width:10,height:5,length:16};case B.ASTC10x6Unorm:case B.ASTC10x6UnormSRGB:return{width:10,height:6,length:16};case B.ASTC10x8Unorm:case B.ASTC10x8UnormSRGB:return{width:10,height:8,length:16};case B.ASTC10x10Unorm:case B.ASTC10x10UnormSRGB:return{width:10,height:10,length:16};case B.ASTC12x10Unorm:case B.ASTC12x10UnormSRGB:return{width:12,height:10,length:16};case B.ASTC12x12Unorm:case B.ASTC12x12UnormSRGB:return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static IsHardwareTexture(e){return!!e.release}static IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return e.close!==void 0}static IsImageBitmapArray(e){return Array.isArray(e)&&e[0].close!==void 0}static IsCompressedFormat(e){switch(e){case B.BC7RGBAUnormSRGB:case B.BC7RGBAUnorm:case B.BC6HRGBFloat:case B.BC6HRGBUFloat:case B.BC5RGSnorm:case B.BC5RGUnorm:case B.BC4RSnorm:case B.BC4RUnorm:case B.BC3RGBAUnormSRGB:case B.BC3RGBAUnorm:case B.BC2RGBAUnormSRGB:case B.BC2RGBAUnorm:case B.BC1RGBAUnormSRGB:case B.BC1RGBAUnorm:case B.ETC2RGB8Unorm:case B.ETC2RGB8UnormSRGB:case B.ETC2RGB8A1Unorm:case B.ETC2RGB8A1UnormSRGB:case B.ETC2RGBA8Unorm:case B.ETC2RGBA8UnormSRGB:case B.EACR11Unorm:case B.EACR11Snorm:case B.EACRG11Unorm:case B.EACRG11Snorm:case B.ASTC4x4Unorm:case B.ASTC4x4UnormSRGB:case B.ASTC5x4Unorm:case B.ASTC5x4UnormSRGB:case B.ASTC5x5Unorm:case B.ASTC5x5UnormSRGB:case B.ASTC6x5Unorm:case B.ASTC6x5UnormSRGB:case B.ASTC6x6Unorm:case B.ASTC6x6UnormSRGB:case B.ASTC8x5Unorm:case B.ASTC8x5UnormSRGB:case B.ASTC8x6Unorm:case B.ASTC8x6UnormSRGB:case B.ASTC8x8Unorm:case B.ASTC8x8UnormSRGB:case B.ASTC10x5Unorm:case B.ASTC10x5UnormSRGB:case B.ASTC10x6Unorm:case B.ASTC10x6UnormSRGB:case B.ASTC10x8Unorm:case B.ASTC10x8UnormSRGB:case B.ASTC10x10Unorm:case B.ASTC10x10UnormSRGB:case B.ASTC12x10Unorm:case B.ASTC12x10UnormSRGB:case B.ASTC12x12Unorm:case B.ASTC12x12UnormSRGB:return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return B.Depth16Unorm;case 16:return B.Depth24Plus;case 13:return B.Depth24PlusStencil8;case 14:return B.Depth32Float;case 18:return B.Depth32FloatStencil8;case 19:return B.Stencil8;case 36492:return i?B.BC7RGBAUnormSRGB:B.BC7RGBAUnorm;case 36495:return B.BC6HRGBUFloat;case 36494:return B.BC6HRGBFloat;case 33779:return i?B.BC3RGBAUnormSRGB:B.BC3RGBAUnorm;case 33778:return i?B.BC2RGBAUnormSRGB:B.BC2RGBAUnorm;case 33777:case 33776:return i?B.BC1RGBAUnormSRGB:B.BC1RGBAUnorm;case 37808:return i?B.ASTC4x4UnormSRGB:B.ASTC4x4Unorm;case 36196:case 37492:return i?B.ETC2RGB8UnormSRGB:B.ETC2RGB8Unorm;case 37496:return i?B.ETC2RGBA8UnormSRGB:B.ETC2RGBA8Unorm}switch(e){case 3:switch(t){case 6:return B.R8Snorm;case 7:return B.RG8Snorm;case 4:throw"RGB format not supported in WebGPU";case 8:return B.R8Sint;case 9:return B.RG8Sint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return B.RGBA8Sint;default:return B.RGBA8Snorm}case 0:switch(t){case 6:return B.R8Unorm;case 7:return B.RG8Unorm;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?B.RGBA8UnormSRGB:B.RGBA8Unorm;case 12:return i?B.BGRA8UnormSRGB:B.BGRA8Unorm;case 8:return B.R8Uint;case 9:return B.RG8Uint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return B.RGBA8Uint;case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return B.RGBA8Unorm}case 4:switch(t){case 8:return B.R16Sint;case 9:return B.RG16Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return B.RGBA16Sint;default:return B.RGBA16Sint}case 5:switch(t){case 8:return B.R16Uint;case 9:return B.RG16Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return B.RGBA16Uint;default:return B.RGBA16Uint}case 6:switch(t){case 8:return B.R32Sint;case 9:return B.RG32Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return B.RGBA32Sint;default:return B.RGBA32Sint}case 7:switch(t){case 8:return B.R32Uint;case 9:return B.RG32Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return B.RGBA32Uint;default:return B.RGBA32Uint}case 1:switch(t){case 6:return B.R32Float;case 7:return B.RG32Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return B.RGBA32Float;default:return B.RGBA32Float}case 2:switch(t){case 6:return B.R16Float;case 7:return B.RG16Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return B.RGBA16Float;default:return B.RGBA16Float}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:switch(t){case 5:return B.RG11B10UFloat;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV";default:return B.RG11B10UFloat}case 14:switch(t){case 5:return B.RGB9E5UFloat;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV";default:return B.RGB9E5UFloat}case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:return B.RGB10A2Unorm;case 11:return B.RGB10A2UINT;default:return B.RGB10A2Unorm}}return i?B.RGBA8UnormSRGB:B.RGBA8Unorm}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case B.R8Unorm:case B.R8Snorm:case B.R8Uint:case B.R8Sint:case B.BC4RUnorm:case B.BC4RSnorm:case B.R16Uint:case B.R16Sint:case B.Depth16Unorm:case B.R16Float:case B.R32Uint:case B.R32Sint:case B.R32Float:case B.Depth32Float:case B.Stencil8:case B.Depth24Plus:case B.EACR11Unorm:case B.EACR11Snorm:return 1;case B.RG8Unorm:case B.RG8Snorm:case B.RG8Uint:case B.RG8Sint:case B.Depth32FloatStencil8:case B.BC5RGUnorm:case B.BC5RGSnorm:case B.RG16Uint:case B.RG16Sint:case B.RG16Float:case B.RG32Uint:case B.RG32Sint:case B.RG32Float:case B.Depth24PlusStencil8:case B.EACRG11Unorm:case B.EACRG11Snorm:return 2;case B.RGB9E5UFloat:case B.RG11B10UFloat:case B.BC6HRGBUFloat:case B.BC6HRGBFloat:case B.ETC2RGB8Unorm:case B.ETC2RGB8UnormSRGB:return 3;case B.RGBA8Unorm:case B.RGBA8UnormSRGB:case B.RGBA8Snorm:case B.RGBA8Uint:case B.RGBA8Sint:case B.BGRA8Unorm:case B.BGRA8UnormSRGB:case B.RGB10A2UINT:case B.RGB10A2Unorm:case B.BC7RGBAUnorm:case B.BC7RGBAUnormSRGB:case B.BC3RGBAUnorm:case B.BC3RGBAUnormSRGB:case B.BC2RGBAUnorm:case B.BC2RGBAUnormSRGB:case B.BC1RGBAUnorm:case B.BC1RGBAUnormSRGB:case B.RGBA16Uint:case B.RGBA16Sint:case B.RGBA16Float:case B.RGBA32Uint:case B.RGBA32Sint:case B.RGBA32Float:case B.ETC2RGB8A1Unorm:case B.ETC2RGB8A1UnormSRGB:case B.ETC2RGBA8Unorm:case B.ETC2RGBA8UnormSRGB:case B.ASTC4x4Unorm:case B.ASTC4x4UnormSRGB:case B.ASTC5x4Unorm:case B.ASTC5x4UnormSRGB:case B.ASTC5x5Unorm:case B.ASTC5x5UnormSRGB:case B.ASTC6x5Unorm:case B.ASTC6x5UnormSRGB:case B.ASTC6x6Unorm:case B.ASTC6x6UnormSRGB:case B.ASTC8x5Unorm:case B.ASTC8x5UnormSRGB:case B.ASTC8x6Unorm:case B.ASTC8x6UnormSRGB:case B.ASTC8x8Unorm:case B.ASTC8x8UnormSRGB:case B.ASTC10x5Unorm:case B.ASTC10x5UnormSRGB:case B.ASTC10x6Unorm:case B.ASTC10x6UnormSRGB:case B.ASTC10x8Unorm:case B.ASTC10x8UnormSRGB:case B.ASTC10x10Unorm:case B.ASTC10x10UnormSRGB:case B.ASTC12x10Unorm:case B.ASTC12x10UnormSRGB:case B.ASTC12x12Unorm:case B.ASTC12x12UnormSRGB:return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case B.Stencil8:case B.Depth32FloatStencil8:case B.Depth24PlusStencil8:return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case B.Depth32FloatStencil8:case B.Depth24PlusStencil8:return!0}return!1}static GetDepthFormatOnly(e){switch(e){case B.Depth16Unorm:return B.Depth16Unorm;case B.Depth24Plus:return B.Depth24Plus;case B.Depth24PlusStencil8:return B.Depth24Plus;case B.Depth32Float:return B.Depth32Float;case B.Depth32FloatStencil8:return B.Depth32Float}return e}static GetSample(e){return e>1?4:1}};var Kl=class{get underlyingResource(){return this._webgpuTexture}getMSAATexture(e=0){return this._webgpuMSAATexture?.[e]??null}setMSAATexture(e,t=-1){this._webgpuMSAATexture||(this._webgpuMSAATexture=[]),t===-1&&(t=this._webgpuMSAATexture.length),this._webgpuMSAATexture[t]=e}releaseMSAATexture(){if(this._webgpuMSAATexture){for(let e of this._webgpuMSAATexture)e?.destroy();this._webgpuMSAATexture=null}}constructor(e=null){this._originalFormatIsRGB=!1,this.format=B.RGBA8Unorm,this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=e,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,r,n,o,a,l){let c=dt.E2d,h=1;r?(c=i?dt.CubeArray:dt.Cube,h=6*(l||1)):n?(c=dt.E3d,h=1):i&&(c=dt.E2dArray,h=l);let u=ut.GetDepthFormatOnly(this.format),d=ut.HasDepthAndStencilAspects(this.format)?Cn.DepthOnly:Cn.All;this.createView({label:`TextureView${n?"3D":r?"Cube":"2D"}${i?"_Array"+h:""}_${o}x${a}_${t?"wmips":"womips"}_${this.format}_${c}`,format:u,dimension:c,mipLevelCount:t?xe.ILog2(Math.max(o,a))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:h,aspect:d})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){let i=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=i}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){this._webgpuTexture?.destroy(),this.releaseMSAATexture(),this._copyInvertYTempTexture?.destroy(),this.reset()}};var aj=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(location = 0) out vec2 vTex;

    void main() {
        vTex = tex[gl_VertexIndex];
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,lj=`
    layout(set = 0, binding = 0) uniform sampler imgSampler;
    layout(set = 0, binding = 1) uniform texture2D img;

    layout(location = 0) in vec2 vTex;
    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = texture(sampler2D(img, imgSampler), vTex);
    }
    `,fV=`
    #extension GL_EXT_samplerless_texture_functions : enable

    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(set = 0, binding = 0) uniform texture2D img;

    #ifdef INVERTY
        layout(location = 0) out flat ivec2 vTextureSize;
    #endif

    void main() {
        #ifdef INVERTY
            vTextureSize = textureSize(img, 0);
        #endif
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,cj=`
    #extension GL_EXT_samplerless_texture_functions : enable

    layout(set = 0, binding = 0) uniform texture2D img;

    #ifdef INVERTY
        layout(location = 0) in flat ivec2 vTextureSize;
    #endif
    layout(location = 0) out vec4 outColor;

    void main() {
    #ifdef INVERTY
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, vTextureSize.y - gl_FragCoord.y), 0);
    #else
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color.rgb *= color.a;
    #endif
        outColor = color;
    }
    `,hj=fV,uj=`
    #extension GL_EXT_samplerless_texture_functions : enable

    layout(set = 0, binding = 0) uniform texture2D img;
    layout(set = 0, binding = 1) uniform Params {
        float ofstX;
        float ofstY;
        float width;
        float height;
    };

    #ifdef INVERTY
        layout(location = 0) in flat ivec2 vTextureSize;
    #endif
    layout(location = 0) out vec4 outColor;

    void main() {
        if (gl_FragCoord.x < ofstX || gl_FragCoord.x >= ofstX + width) {
            discard;
        }
        if (gl_FragCoord.y < ofstY || gl_FragCoord.y >= ofstY + height) {
            discard;
        }
    #ifdef INVERTY
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, ofstY + height - (gl_FragCoord.y - ofstY)), 0);
    #else
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color.rgb *= color.a;
    #endif
        outColor = color;
    }
    `,dj=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));

    void main() {
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,fj=`
    layout(set = 0, binding = 0) uniform Uniforms {
        uniform vec4 color;
    };

    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = color;
    }
    `,pj=`
    struct VertexOutput {
        @builtin(position) Position : vec4<f32>,
        @location(0) fragUV : vec2<f32>
    }

    @vertex
    fn main(
        @builtin(vertex_index) VertexIndex : u32
    ) -> VertexOutput {
        var pos = array<vec2<f32>, 4>(
            vec2(-1.0,  1.0),
            vec2( 1.0,  1.0),
            vec2(-1.0, -1.0),
            vec2( 1.0, -1.0)
        );
        var tex = array<vec2<f32>, 4>(
            vec2(0.0, 0.0),
            vec2(1.0, 0.0),
            vec2(0.0, 1.0),
            vec2(1.0, 1.0)
        );

        var output: VertexOutput;

        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);
        output.fragUV = tex[VertexIndex];

        return output;
    }
    `,mj=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);
    }
    `,gj=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));
    }
    `,Mo=function(s){return s[s.MipMap=0]="MipMap",s[s.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",s[s.Clear=2]="Clear",s[s.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst",s}(Mo||{}),ym=function(s){return s[s.DontInvertY=0]="DontInvertY",s[s.InvertY=1]="InvertY",s}(ym||{}),dV=[{vertex:aj,fragment:lj},{vertex:fV,fragment:cj},{vertex:dj,fragment:fj},{vertex:hj,fragment:uj}],Qn={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2uint:22,rgb10a2unorm:23,rg32uint:24,rg32sint:25,rg32float:26,rgba16uint:27,rgba16sint:28,rgba16float:29,rgba32uint:30,rgba32sint:31,rgba32float:32,stencil8:33,depth16unorm:34,depth24plus:35,"depth24plus-stencil8":36,depth32float:37,"depth32float-stencil8":38},Kv=class{constructor(e,t,i,r,n,o){if(this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._engine=e,this._device=t,this._glslang=i,this._tintWASM=r,this._bufferManager=n,o.indexOf(Ro.RG11B10UFloatRenderable)!==-1){let a=Object.keys(Qn);Qn[B.RG11B10UFloat]=Qn[a[a.length-1]]+1}this._mipmapSampler=t.createSampler({minFilter:ht.Linear}),this._videoSampler=t.createSampler({minFilter:ht.Linear}),this._ubCopyWithOfst=this._bufferManager.createBuffer(4*4,kt.Uniform|kt.CopyDst,"UBCopyWithOffset").underlyingResource,this._getPipeline(B.RGBA8Unorm),this._getVideoPipeline(B.RGBA8Unorm)}_getPipeline(e,t=Mo.MipMap,i){let r=t===Mo.MipMap?1:t===Mo.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===Mo.Clear?8:t===Mo.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let n=this._pipelines[e][r];if(!n){let o=`#version 450
`;(t===Mo.InvertYPremultiplyAlpha||t===Mo.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(o+=`#define INVERTY
`),i.premultiplyAlpha&&(o+=`#define PREMULTIPLYALPHA
`));let a=this._compiledShaders[r];if(!a){let c=this._glslang.compileGLSL(o+dV[t].vertex,"vertex"),h=this._glslang.compileGLSL(o+dV[t].fragment,"fragment");this._tintWASM&&(c=this._tintWASM.convertSpirV2WGSL(c),h=this._tintWASM.convertSpirV2WGSL(h));let u=this._device.createShaderModule({code:c}),d=this._device.createShaderModule({code:h});a=this._compiledShaders[r]=[u,d]}let l=this._device.createRenderPipeline({layout:Dd.Auto,vertex:{module:a[0],entryPoint:"main"},fragment:{module:a[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:Vs.TriangleStrip,stripIndexFormat:ga.Uint16}});n=this._pipelines[e][r]=[l,l.getBindGroupLayout(0)]}return n}_getVideoPipeline(e,t=ym.DontInvertY){let i=t===ym.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let r=this._videoPipelines[e][i];if(!r){let n=this._videoCompiledShaders[i];if(!n){let a=this._device.createShaderModule({code:pj}),l=this._device.createShaderModule({code:i===0?mj:gj});n=this._videoCompiledShaders[i]=[a,l]}let o=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_${e}_${i===0?"DontInvertY":"InvertY"}`,layout:Dd.Auto,vertex:{module:n[0],entryPoint:"main"},fragment:{module:n[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:Vs.TriangleStrip,stripIndexFormat:ga.Uint16}});r=this._videoPipelines[e][i]=[o,o.getBindGroupLayout(0)]}return r}setCommandEncoder(e){this._commandEncoderForCreation=e}copyVideoToTexture(e,t,i,r=!1,n){let o=n===void 0,[a,l]=this._getVideoPipeline(i,r?ym.InvertY:ym.DontInvertY);o&&(n=this._device.createCommandEncoder({})),n.pushDebugGroup?.(`copy video to texture - invertY=${r}`);let c=t._hardwareTexture,h={label:`BabylonWebGPUDevice${this._engine.uniqueId}_copyVideoToTexture_${i}_${r?"InvertY":"DontInvertY"}${t.label?"_"+t.label:""}`,colorAttachments:[{view:c.underlyingResource.createView({format:i,dimension:dt.E2d,mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:Cn.All}),loadOp:ir.Load,storeOp:Qs.Store}]},u=n.beginRenderPass(h),d={layout:l,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},f=this._device.createBindGroup(d);u.setPipeline(a),u.setBindGroup(0,f),u.draw(4,1,0,0),u.end(),n.popDebugGroup?.(),o&&(this._device.queue.submit([n.finish()]),n=null)}invertYPreMultiplyAlpha(e,t,i,r,n=!1,o=!1,a=0,l=0,c=1,h=0,u=0,d=0,f=0,m,g){let _=d!==0,x=m===void 0,[b,C]=this._getPipeline(r,_?Mo.InvertYPremultiplyAlphaWithOfst:Mo.InvertYPremultiplyAlpha,{invertY:n,premultiplyAlpha:o});a=Math.max(a,0),x&&(m=this._device.createCommandEncoder({})),m.pushDebugGroup?.(`internal process texture - invertY=${n} premultiplyAlpha=${o}`);let R;if(ut.IsHardwareTexture(e)?(R=e.underlyingResource,n&&!o&&c===1&&a===0||(e=void 0)):(R=e,e=void 0),!R)return;_&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([h,u,d,f]),0,4*4);let E=e,S=E?._copyInvertYTempTexture??this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,r,1,m,pi.CopySrc|pi.RenderAttachment|pi.TextureBinding,void 0,"TempTextureForCopyWithInvertY"),A=E?._copyInvertYRenderPassDescr??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_invertYPreMultiplyAlpha_${r}_${n?"InvertY":"DontInvertY"}_${o?"PremultiplyAlpha":"DontPremultiplyAlpha"}`,colorAttachments:[{view:S.createView({format:r,dimension:dt.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:ir.Load,storeOp:Qs.Store}]},L=m.beginRenderPass(A),G=_?E?._copyInvertYBindGroupWithOfst:E?._copyInvertYBindGroup;if(!G){let W={layout:C,entries:[{binding:0,resource:R.createView({format:r,dimension:dt.E2d,baseMipLevel:l,mipLevelCount:1,arrayLayerCount:c,baseArrayLayer:a})}]};_&&W.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),G=this._device.createBindGroup(W)}L.setPipeline(b),L.setBindGroup(0,G),L.draw(4,1,0,0),L.end(),m.copyTextureToTexture({texture:S},{texture:R,mipLevel:l,origin:{x:0,y:0,z:a}},{width:t,height:i,depthOrArrayLayers:1}),E?(E._copyInvertYTempTexture=S,E._copyInvertYRenderPassDescr=A,_?E._copyInvertYBindGroupWithOfst=G:E._copyInvertYBindGroup=G):this._deferredReleaseTextures.push([S,null]),m.popDebugGroup?.(),x&&(this._device.queue.submit([m.finish()]),m=null)}copyWithInvertY(e,t,i,r){let n=r===void 0,[o,a]=this._getPipeline(t,Mo.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1});n&&(r=this._device.createCommandEncoder({})),r.pushDebugGroup?.("internal copy texture with invertY");let l=r.beginRenderPass(i),c=this._device.createBindGroup({layout:a,entries:[{binding:0,resource:e}]});l.setPipeline(o),l.setBindGroup(0,c),l.draw(4,1,0,0),l.end(),r.popDebugGroup?.(),n&&(this._device.queue.submit([r.finish()]),r=null)}createTexture(e,t=!1,i=!1,r=!1,n=!1,o=!1,a=B.RGBA8Unorm,l=1,c,h=-1,u=0,d){l=ut.GetSample(l);let f=e.layers||1,m={width:e.width,height:e.height,depthOrArrayLayers:f},g=Qn[a]?pi.RenderAttachment:0,_=ut.IsCompressedFormat(a),x=t?ut.ComputeNumMipmapLevels(e.width,e.height):1,b=h>=0?h:pi.CopySrc|pi.CopyDst|pi.TextureBinding;u|=t&&!_?pi.CopySrc|g:0,!_&&!o&&(u|=g|pi.CopyDst);let C=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_Texture${o?"3D":"2D"}_${d?d+"_":""}${m.width}x${m.height}x${m.depthOrArrayLayers}_${t?"wmips":"womips"}_${a}_samples${l}`,size:m,dimension:o?Tn.E3d:Tn.E2d,format:a,usage:b|u,sampleCount:l,mipLevelCount:x});return ut.IsImageBitmap(e)&&(this.updateTexture(e,C,e.width,e.height,f,a,0,0,r,n,0,0),t&&i&&this.generateMipmaps(C,a,x,0,o,c)),C}createCubeTexture(e,t=!1,i=!1,r=!1,n=!1,o=B.RGBA8Unorm,a=1,l,c=-1,h=0,u){a=ut.GetSample(a);let d=ut.IsImageBitmapArray(e)?e[0].width:e.width,f=ut.IsImageBitmapArray(e)?e[0].height:e.height,m=Qn[o]?pi.RenderAttachment:0,g=ut.IsCompressedFormat(o),_=t?ut.ComputeNumMipmapLevels(d,f):1,x=c>=0?c:pi.CopySrc|pi.CopyDst|pi.TextureBinding;h|=t&&!g?pi.CopySrc|m:0,g||(h|=m|pi.CopyDst);let b=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureCube_${u?u+"_":""}${d}x${f}x6_${t?"wmips":"womips"}_${o}_samples${a}`,size:{width:d,height:f,depthOrArrayLayers:6},dimension:Tn.E2d,format:o,usage:x|h,sampleCount:a,mipLevelCount:_});return ut.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,b,d,f,o,r,n,0,0),t&&i&&this.generateCubeMipmaps(b,o,_,l)),b}generateCubeMipmaps(e,t,i,r){let n=r===void 0;n&&(r=this._device.createCommandEncoder({})),r.pushDebugGroup?.(`create cube mipmaps - ${i} levels`);for(let o=0;o<6;++o)this.generateMipmaps(e,t,i,o,!1,r);r.popDebugGroup?.(),n&&(this._device.queue.submit([r.finish()]),r=null)}generateMipmaps(e,t,i,r=0,n=!1,o){let a=o===void 0,[l,c]=this._getPipeline(t);r=Math.max(r,0),a&&(o=this._device.createCommandEncoder({})),o.pushDebugGroup?.(`create mipmaps for face #${r} - ${i} levels`);let h;if(ut.IsHardwareTexture(e)?(h=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(h=e,e=void 0),!h)return;let u=e;for(let d=1;d<i;++d){let f=u?._mipmapGenRenderPassDescr[r]?.[d-1]??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_generateMipmaps_${t}_faceIndex${r}_level${d}`,colorAttachments:[{view:h.createView({format:t,dimension:n?dt.E3d:dt.E2d,baseMipLevel:d,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r}),loadOp:ir.Load,storeOp:Qs.Store}]};u&&(u._mipmapGenRenderPassDescr[r]=u._mipmapGenRenderPassDescr[r]||[],u._mipmapGenRenderPassDescr[r][d-1]=f);let m=o.beginRenderPass(f),g=u?._mipmapGenBindGroup[r]?.[d-1]??this._device.createBindGroup({layout:c,entries:[{binding:0,resource:this._mipmapSampler},{binding:1,resource:h.createView({format:t,dimension:n?dt.E3d:dt.E2d,baseMipLevel:d-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r})}]});u&&(u._mipmapGenBindGroup[r]=u._mipmapGenBindGroup[r]||[],u._mipmapGenBindGroup[r][d-1]=g),m.setPipeline(l),m.setBindGroup(0,g),m.draw(4,1,0,0),m.end()}o.popDebugGroup?.(),a&&(this._device.queue.submit([o.finish()]),o=null)}createGPUTextureForInternalTexture(e,t,i,r,n){e._hardwareTexture||(e._hardwareTexture=new Kl),t===void 0&&(t=e.width),i===void 0&&(i=e.height),r===void 0&&(r=e.depth);let o=e._hardwareTexture,a=((n??0)&1)!==0;o.format=ut.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),o.textureUsages=e._source===ke.RenderTarget||e.source===ke.MultiRenderTarget?pi.TextureBinding|pi.CopySrc|pi.RenderAttachment:e._source===ke.DepthStencil?pi.TextureBinding|pi.RenderAttachment:-1,o.textureAdditionalUsages=a?pi.StorageBinding:0;let l=e.generateMipMaps,c=r||1,h;if(e._maxLodLevel!==null?h=e._maxLodLevel:h=l?ut.ComputeNumMipmapLevels(t,i):1,e.isCube){let u=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(u);let d=e.is3D?1:c,f=ut.GetDepthFormatOnly(o.format),m=ut.HasDepthAndStencilAspects(o.format)?Cn.DepthOnly:Cn.All,g=e.is2DArray?dt.CubeArray:dt.Cube;o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureViewCube${e.is2DArray?"_Array"+d:""}_${t}x${i}_${l?"wmips":"womips"}_${f}_${g}_${m}_${e.label??"noname"}`,format:f,dimension:g,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:m},a)}else{let u=this.createTexture({width:t,height:i,layers:c},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,o.format,1,this._commandEncoderForCreation,o.textureUsages,o.textureAdditionalUsages,e.label);o.set(u);let d=e.is3D?1:c,f=ut.GetDepthFormatOnly(o.format),m=ut.HasDepthAndStencilAspects(o.format)?Cn.DepthOnly:Cn.All,g=e.is2DArray?dt.E2dArray:e.is3D?Tn.E3d:dt.E2d;o.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureView${e.is3D?"3D":"2D"}${e.is2DArray?"_Array"+d:""}_${t}x${i}${e.is3D?"x"+c:""}_${l?"wmips":"womips"}_${f}_${g}_${m}_${e.label??"noname"}`,format:f,dimension:g,mipLevelCount:h,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:d,aspect:m},a)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=r,this.createMSAATexture(e,e.samples),o}createMSAATexture(e,t,i=!0,r=-1){let n=e._hardwareTexture;if(i&&n?.releaseMSAATexture(),!n||(t??1)<=1)return;let o=e.width,a=e.height,l=this.createTexture({width:o,height:a,layers:1},!1,!1,!1,!1,!1,n.format,t,this._commandEncoderForCreation,pi.RenderAttachment,0,e.label?"MSAA"+e.label:void 0);n.setMSAATexture(l,r)}updateCubeTextures(e,t,i,r,n,o=!1,a=!1,l=0,c=0){let h=[0,3,1,4,2,5];for(let u=0;u<h.length;++u){let d=e[h[u]];this.updateTexture(d,t,i,r,1,n,u,0,o,a,l,c)}}updateTexture(e,t,i,r,n,o,a=0,l=0,c=!1,h=!1,u=0,d=0,f){let m=ut.IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,g=ut.GetBlockInformationFromFormat(o),_=ut.IsInternalTexture(t)?t._hardwareTexture:t,x={texture:m,origin:{x:u,y:d,z:Math.max(a,0)},mipLevel:l,premultipliedAlpha:h},b={width:Math.ceil(i/g.width)*g.width,height:Math.ceil(r/g.height)*g.height,depthOrArrayLayers:n||1};if(e.byteLength!==void 0){e=e;let C=Math.ceil(i/g.width)*g.length;if(Math.ceil(C/256)*256===C){let E=this._device.createCommandEncoder({}),S=this._bufferManager.createRawBuffer(e.byteLength,kt.MapWrite|kt.CopySrc,!0,"TempBufferForUpdateTexture"+(m?"_"+m.label:"")),A=S.getMappedRange();new Uint8Array(A).set(e),S.unmap(),E.copyBufferToTexture({buffer:S,offset:0,bytesPerRow:C,rowsPerImage:r},x,b),this._device.queue.submit([E.finish()]),this._bufferManager.releaseBuffer(S)}else this._device.queue.writeTexture(x,e,{offset:0,bytesPerRow:C,rowsPerImage:r},b);if(c||h)if(ut.IsInternalTexture(t)){let E=u===0&&d===0&&i===t.width&&r===t.height;this.invertYPreMultiplyAlpha(_,t.width,t.height,o,c,h,a,l,n||1,u,d,E?0:i,E?0:r,void 0,f)}else throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!"}else if(e=e,c)if(x.premultipliedAlpha=!1,ut.IsInternalTexture(t)&&u===0&&d===0&&i===t.width&&r===t.height)this._device.queue.copyExternalImageToTexture({source:e},x,b),this.invertYPreMultiplyAlpha(_,i,r,o,c,h,a,l,n||1,0,0,0,0,void 0,f);else{let C=this._device.createCommandEncoder({}),R=this.createTexture({width:i,height:r,layers:1},!1,!1,!1,!1,!1,o,1,C,pi.CopySrc|pi.TextureBinding,void 0,"TempTextureForUpdateTexture");this._deferredReleaseTextures.push([R,null]),b.depthOrArrayLayers=1,this._device.queue.copyExternalImageToTexture({source:e},{texture:R},b),b.depthOrArrayLayers=n||1,this.invertYPreMultiplyAlpha(R,i,r,o,c,h,a,l,n||1,0,0,0,0,C,f),C.copyTextureToTexture({texture:R},x,b),this._device.queue.submit([C.finish()])}else this._device.queue.copyExternalImageToTexture({source:e},x,b)}readPixels(e,t,i,r,n,o,a=0,l=0,c=null,h=!1){let u=ut.GetBlockInformationFromFormat(o),d=Math.ceil(r/u.width)*u.length,f=Math.ceil(d/256)*256,m=f*n,g=this._bufferManager.createRawBuffer(m,kt.MapRead|kt.CopyDst,void 0,"TempBufferForReadPixels"+(e.label?"_"+e.label:"")),_=this._device.createCommandEncoder({});return _.copyTextureToBuffer({texture:e,mipLevel:l,origin:{x:t,y:i,z:Math.max(a,0)}},{buffer:g,offset:0,bytesPerRow:f},{width:r,height:n,depthOrArrayLayers:1}),this._device.queue.submit([_.finish()]),this._bufferManager.readDataFromBuffer(g,m,r,n,d,f,ut.GetTextureTypeFromFormat(o),0,c,!0,h)}releaseTexture(e){if(ut.IsInternalTexture(e)){let t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){let[t,i]=this._deferredReleaseTextures[e];t&&(ut.IsHardwareTexture(t)?t.release():t.destroy()),i?.dispose()}this._deferredReleaseTextures.length=0}};var Zv=class extends Uf{constructor(e,t=0){super(),this.engineId=-1,this.capacity=t,this._buffer=e}get underlyingResource(){return this._buffer}};var Jv=class s{static _IsGPUBuffer(e){return e.underlyingResource===void 0}static _FlagsToString(e,t=""){let i=t;for(let r=0;r<=9;++r)e&1<<r&&(i&&(i+="_"),i+=kt[1<<r]);return i}constructor(e,t){this._deferredReleaseBuffers=[],this._engine=e,this._device=t}createRawBuffer(e,t,i=!1,r){let n=e.byteLength!==void 0?e.byteLength+3&-4:e+3&-4,o={label:"BabylonWebGPUDevice"+this._engine.uniqueId+"_"+s._FlagsToString(t,r??"Buffer")+"_size"+n,mappedAtCreation:i,size:n,usage:t};return this._device.createBuffer(o)}createBuffer(e,t,i){let r=e.byteLength!==void 0,n=this.createRawBuffer(e,t,void 0,i),o=new Zv(n);return o.references=1,o.capacity=r?e.byteLength:e,o.engineId=this._engine.uniqueId,r&&this.setSubData(o,0,e),o}setRawData(e,t,i,r,n){this._device.queue.writeBuffer(e,t,i.buffer,r,n)}setSubData(e,t,i,r=0,n=0){let o=e.underlyingResource;n=n||i.byteLength,n=Math.min(n,e.capacity-t);let a=i.byteOffset+r,l=a+n,c=n+3&-4;if(c!==n){let d=new Uint8Array(i.buffer.slice(a,l));i=new Uint8Array(c),i.set(d),r=0,a=0,l=c,n=c}let h=1024*1024*15,u=0;for(;l-(a+u)>h;)this._device.queue.writeBuffer(o,t+u,i.buffer,a+u,h),u+=h;this._device.queue.writeBuffer(o,t+u,i.buffer,a+u,n-u)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i||(i=new Float32Array(e));let r=new Uint16Array(t);for(;e--;)i[e]=qn(r[e]);return i}readDataFromBuffer(e,t,i,r,n,o,a=0,l=0,c=null,h=!0,u=!1){let d=a===1?2:a===2?1:0,f=this._engine.uniqueId;return new Promise((m,g)=>{e.mapAsync(rl.Read,l,t).then(()=>{let _=e.getMappedRange(l,t),x=c;if(u)x===null?x=XS(a,t,!0,_):x=XS(a,x.buffer,void 0,_);else if(x===null)switch(d){case 0:x=new Uint8Array(t),x.set(new Uint8Array(_));break;case 1:x=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,_);break;case 2:x=new Float32Array(t/4),x.set(new Float32Array(_));break}else switch(d){case 0:x=new Uint8Array(x.buffer),x.set(new Uint8Array(_));break;case 1:x=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,_,c);break;case 2:x=new Float32Array(x.buffer),x.set(new Float32Array(_));break}if(n!==o){d===1&&!u&&(n*=2,o*=2);let b=new Uint8Array(x.buffer),C=n,R=0;for(let E=1;E<r;++E){R=E*o;for(let S=0;S<n;++S)b[C++]=b[R++]}d!==0&&!u?x=new Float32Array(b.buffer,0,C/4):x=new Uint8Array(b.buffer,0,C)}e.unmap(),h&&this.releaseBuffer(e),m(x)},_=>{this._engine.isDisposed||this._engine.uniqueId!==f?m(new Uint8Array):g(_)})})}releaseBuffer(e){return s._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,e.references===0?(this._deferredReleaseBuffers.push(e.underlyingResource),!0):!1)}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}};var _j=[0,0,3,7,0,2,6,2,4,1,5,3,1],xj=[0,64,32,96,16,80,48,112,8],vj=[0,128,128,0,0,0,0,128,0,0,0,0,128],Od=class s{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){let t=e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1;return _j[e.samplingMode]+xj[(e._comparisonFunction||514)-512+1]+vj[e.samplingMode]+((e._cachedWrapU??1)<<8)+((e._cachedWrapV??1)<<10)+((e._cachedWrapR??1)<<12)+((e.useMipMaps?1:0)<<14)+(t<<15)}static _GetSamplerFilterDescriptor(e,t){let i,r,n,o,a,l=e.useMipMaps;switch(e.samplingMode){case 11:i=ht.Linear,r=ht.Linear,n=ht.Nearest,l||(o=a=0);break;case 3:case 3:i=ht.Linear,r=ht.Linear,l?n=ht.Linear:(n=ht.Nearest,o=a=0);break;case 8:i=ht.Nearest,r=ht.Nearest,l?n=ht.Linear:(n=ht.Nearest,o=a=0);break;case 4:i=ht.Nearest,r=ht.Nearest,n=ht.Nearest,l||(o=a=0);break;case 5:i=ht.Nearest,r=ht.Linear,n=ht.Nearest,l||(o=a=0);break;case 6:i=ht.Nearest,r=ht.Linear,l?n=ht.Linear:(n=ht.Nearest,o=a=0);break;case 7:i=ht.Nearest,r=ht.Linear,n=ht.Nearest,o=a=0;break;case 1:case 1:i=ht.Nearest,r=ht.Nearest,n=ht.Nearest,o=a=0;break;case 9:i=ht.Linear,r=ht.Nearest,n=ht.Nearest,l||(o=a=0);break;case 10:i=ht.Linear,r=ht.Nearest,l?n=ht.Linear:(n=ht.Nearest,o=a=0);break;case 2:case 2:i=ht.Linear,r=ht.Linear,n=ht.Nearest,o=a=0;break;case 12:i=ht.Linear,r=ht.Nearest,n=ht.Nearest,o=a=0;break;default:i=ht.Nearest,r=ht.Nearest,n=ht.Nearest,o=a=0;break}return t>1&&(o!==0||a!==0)&&n!==ht.Nearest?{magFilter:ht.Linear,minFilter:ht.Linear,mipmapFilter:ht.Linear,anisotropyEnabled:!0}:{magFilter:i,minFilter:r,mipmapFilter:n,lodMinClamp:o,lodMaxClamp:a}}static _GetWrappingMode(e){switch(e){case 1:return Md.Repeat;case 0:return Md.ClampToEdge;case 2:return Md.MirrorRepeat}return Md.Repeat}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e,t){let i=e.useMipMaps&&e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1,r=this._GetSamplerFilterDescriptor(e,i);return Kt(ie(ie({label:t},r),this._GetSamplerWrappingDescriptor(e)),{compare:e._comparisonFunction?s.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:r.anisotropyEnabled?i:1})}static GetCompareFunction(e){switch(e){case 519:return mr.Always;case 514:return mr.Equal;case 516:return mr.Greater;case 518:return mr.GreaterEqual;case 513:return mr.Less;case 515:return mr.LessEqual;case 512:return mr.Never;case 517:return mr.NotEqual;default:return mr.Less}}getSampler(e,t=!1,i=0,r){if(this.disabled)return this._device.createSampler(s._GetSamplerDescriptor(e,r));t?i=0:i===0&&(i=s.GetSamplerHashCode(e));let n=t?void 0:this._samplers[i];return n||(n=this._device.createSampler(s._GetSamplerDescriptor(e,r)),t||(this._samplers[i]=n)),n}};var Zi=function(s){return s[s.StencilReadMask=0]="StencilReadMask",s[s.StencilWriteMask=1]="StencilWriteMask",s[s.DepthBias=2]="DepthBias",s[s.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",s[s.DepthStencilState=4]="DepthStencilState",s[s.MRTAttachments1=5]="MRTAttachments1",s[s.MRTAttachments2=6]="MRTAttachments2",s[s.RasterizationState=7]="RasterizationState",s[s.ColorStates=8]="ColorStates",s[s.ShaderStage=9]="ShaderStage",s[s.TextureStage=10]="TextureStage",s[s.VertexState=11]="VertexState",s[s.NumStates=12]="NumStates",s}(Zi||{}),eT={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},wd={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7},pV=(()=>{class s{constructor(t,i){this.mrtTextureCount=0,this._device=t,this._useTextureStage=!0,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=i,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=t.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=[B.BGRA8Unorm],this.setColorFormat(B.BGRA8Unorm),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat(B.Depth24PlusStencil8),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments1>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(t,i,r,n=0){if(r=ut.GetSample(r),this.disabled){let a=s._GetTopology(t);return this._setVertexState(i),this._setTextureState(n),this._parameter.pipeline=this._createRenderPipeline(i,a,r),s.NumCacheMiss++,s._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(i.uniqueId),this._setRasterizationState(t,r),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(i),this._setTextureState(n),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,s.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return s.NumCacheHitWithHash++,this._parameter.pipeline;let o=s._GetTopology(t);return this._parameter.pipeline=this._createRenderPipeline(i,o,r),this._setRenderPipeline(this._parameter),s.NumCacheMiss++,s._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){s.NumPipelineCreationLastFrame=s._NumPipelineCreationCurrentFrame,s._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(t){this._alphaToCoverageEnabled=t}setFrontFace(t){this._frontFace=t}setCullEnabled(t){this._cullEnabled=t}setCullFace(t){this._cullFace=t}setClampDepth(t){this._clampDepth=t}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(t,i,r,n,o,a,l,c){this._depthWriteEnabled=l,this._depthTestEnabled=a,this._depthCompare=(c??519)-512,this._cullFace=r,this._cullEnabled=t,this._frontFace=i,this.setDepthBiasSlopeScale(n),this.setDepthBias(o)}setDepthBias(t){this._depthBias!==t&&(this._depthBias=t,this._states[Zi.DepthBias]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.DepthBias))}setDepthBiasSlopeScale(t){this._depthBiasSlopeScale!==t&&(this._depthBiasSlopeScale=t,this._states[Zi.DepthBiasSlopeScale]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.DepthBiasSlopeScale))}setColorFormat(t){this._webgpuColorFormat[0]=t,this._colorFormat=Qn[t??""]}setMRTAttachments(t){this.mrtAttachments=t;let i=0;for(let r=0;r<t.length;++r)t[r]!==0&&(i+=1<<r);this._mrtEnabledMask!==i&&(this._mrtEnabledMask=i,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.MRTAttachments1))}setMRT(t,i){if(i=i??t.length,i>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=t,this.mrtTextureCount=i,this._mrtEnabledMask=65535;let r=[0,0],n=0,o=0,a=0;for(let l=0;l<i;++l){let h=t[l]?._hardwareTexture;this._mrtFormats[a]=h?.format??this._webgpuColorFormat[0],r[n]+=Qn[this._mrtFormats[a]??""]<<o,o+=6,a++,o>=32&&(o=0,n++)}this._mrtFormats.length=a,(this._mrtAttachments1!==r[0]||this._mrtAttachments2!==r[1])&&(this._mrtAttachments1=r[0],this._mrtAttachments2=r[1],this._states[Zi.MRTAttachments1]=r[0],this._states[Zi.MRTAttachments2]=r[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.MRTAttachments1))}setAlphaBlendEnabled(t){this._alphaBlendEnabled=t}setAlphaBlendFactors(t,i){this._alphaBlendFuncParams=t,this._alphaBlendEqParams=i}setWriteMask(t){this._writeMask=t}setDepthStencilFormat(t){this._webgpuDepthStencilFormat=t,this._depthStencilFormat=t===void 0?0:Qn[t]}setDepthTestEnabled(t){this._depthTestEnabled=t}setDepthWriteEnabled(t){this._depthWriteEnabled=t}setDepthCompare(t){this._depthCompare=(t??519)-512}setStencilEnabled(t){this._stencilEnabled=t}setStencilCompare(t){this._stencilFrontCompare=(t??519)-512}setStencilDepthFailOp(t){this._stencilFrontDepthFailOp=t===null?1:wd[t]}setStencilPassOp(t){this._stencilFrontPassOp=t===null?2:wd[t]}setStencilFailOp(t){this._stencilFrontFailOp=t===null?1:wd[t]}setStencilReadMask(t){this._stencilReadMask!==t&&(this._stencilReadMask=t,this._states[Zi.StencilReadMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.StencilReadMask))}setStencilWriteMask(t){this._stencilWriteMask!==t&&(this._stencilWriteMask=t,this._states[Zi.StencilWriteMask]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(t,i,r,n,o,a,l){this._stencilEnabled=t,this._stencilFrontCompare=(i??519)-512,this._stencilFrontDepthFailOp=r===null?1:wd[r],this._stencilFrontPassOp=n===null?2:wd[n],this._stencilFrontFailOp=o===null?1:wd[o],this.setStencilReadMask(a),this.setStencilWriteMask(l)}setBuffers(t,i,r){this._vertexBuffers=t,this._overrideVertexBuffers=r,this._indexBuffer=i}static _GetTopology(t){switch(t){case 0:return Vs.TriangleList;case 2:return Vs.PointList;case 1:return Vs.LineList;case 3:return Vs.PointList;case 4:return Vs.LineList;case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return Vs.LineStrip;case 7:return Vs.TriangleStrip;case 8:throw"TriangleFan is an unsupported fillmode in WebGPU";default:return Vs.TriangleList}}static _GetAphaBlendOperation(t){switch(t){case 32774:return Ql.Add;case 32778:return Ql.Subtract;case 32779:return Ql.ReverseSubtract;case 32775:return Ql.Min;case 32776:return Ql.Max;default:return Ql.Add}}static _GetAphaBlendFactor(t){switch(t){case 0:return Qr.Zero;case 1:return Qr.One;case 768:return Qr.Src;case 769:return Qr.OneMinusSrc;case 770:return Qr.SrcAlpha;case 771:return Qr.OneMinusSrcAlpha;case 772:return Qr.DstAlpha;case 773:return Qr.OneMinusDstAlpha;case 774:return Qr.Dst;case 775:return Qr.OneMinusDst;case 776:return Qr.SrcAlphaSaturated;case 32769:return Qr.Constant;case 32770:return Qr.OneMinusConstant;case 32771:return Qr.Constant;case 32772:return Qr.OneMinusConstant;default:return Qr.One}}static _GetCompareFunction(t){switch(t){case 0:return mr.Never;case 1:return mr.Less;case 2:return mr.Equal;case 3:return mr.LessEqual;case 4:return mr.Greater;case 5:return mr.NotEqual;case 6:return mr.GreaterEqual;case 7:return mr.Always}return mr.Never}static _GetStencilOpFunction(t){switch(t){case 0:return Po.Zero;case 1:return Po.Keep;case 2:return Po.Replace;case 3:return Po.IncrementClamp;case 4:return Po.DecrementClamp;case 5:return Po.Invert;case 6:return Po.IncrementWrap;case 7:return Po.DecrementWrap}return Po.Keep}static _GetVertexInputDescriptorFormat(t){let i=t.type,r=t.normalized,n=t.getSize();switch(i){case y.BYTE:switch(n){case 1:case 2:return r?Ri.Snorm8x2:Ri.Sint8x2;case 3:case 4:return r?Ri.Snorm8x4:Ri.Sint8x4}break;case y.UNSIGNED_BYTE:switch(n){case 1:case 2:return r?Ri.Unorm8x2:Ri.Uint8x2;case 3:case 4:return r?Ri.Unorm8x4:Ri.Uint8x4}break;case y.SHORT:switch(n){case 1:case 2:return r?Ri.Snorm16x2:Ri.Sint16x2;case 3:case 4:return r?Ri.Snorm16x4:Ri.Sint16x4}break;case y.UNSIGNED_SHORT:switch(n){case 1:case 2:return r?Ri.Unorm16x2:Ri.Uint16x2;case 3:case 4:return r?Ri.Unorm16x4:Ri.Uint16x4}break;case y.INT:switch(n){case 1:return Ri.Sint32;case 2:return Ri.Sint32x2;case 3:return Ri.Sint32x3;case 4:return Ri.Sint32x4}break;case y.UNSIGNED_INT:switch(n){case 1:return Ri.Uint32;case 2:return Ri.Uint32x2;case 3:return Ri.Uint32x3;case 4:return Ri.Uint32x4}break;case y.FLOAT:switch(n){case 1:return Ri.Float32;case 2:return Ri.Float32x2;case 3:return Ri.Float32x3;case 4:return Ri.Float32x4}break}throw new Error(`Invalid Format '${t.getKind()}' - type=${i}, normalized=${r}, size=${n}`)}_getAphaBlendState(){return this._alphaBlendEnabled?{srcFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:s._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:null}_getColorBlendState(){return this._alphaBlendEnabled?{srcFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:s._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:s._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:null}_setShaderStage(t){this._shaderId!==t&&(this._shaderId=t,this._states[Zi.ShaderStage]=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.ShaderStage))}_setRasterizationState(t,i){let r=this._frontFace,n=this._cullEnabled?this._cullFace:0,o=this._clampDepth?1:0,a=this._alphaToCoverageEnabled?1:0,l=r-1+(n<<1)+(o<<3)+(a<<4)+(t<<5)+(i<<8);this._rasterizationState!==l&&(this._rasterizationState=l,this._states[Zi.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.RasterizationState))}_setColorStates(){let t=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(t+=((this._alphaBlendFuncParams[0]===null?2:eT[this._alphaBlendFuncParams[0]])<<0)+((this._alphaBlendFuncParams[1]===null?2:eT[this._alphaBlendFuncParams[1]])<<4)+((this._alphaBlendFuncParams[2]===null?2:eT[this._alphaBlendFuncParams[2]])<<8)+((this._alphaBlendFuncParams[3]===null?2:eT[this._alphaBlendFuncParams[3]])<<12)+((this._alphaBlendEqParams[0]===null?1:this._alphaBlendEqParams[0]-32773)<<16)+((this._alphaBlendEqParams[1]===null?1:this._alphaBlendEqParams[1]-32773)<<19)),t!==this._colorStates&&(this._colorStates=t,this._states[Zi.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.ColorStates))}_setDepthStencilState(){let t=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):591,i=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+(t<<10);this._depthStencilState!==i&&(this._depthStencilState=i,this._states[Zi.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.DepthStencilState))}_setVertexState(t){let i=this._statesLength,r=Zi.VertexState,n=t._pipelineContext,o=n.shaderProcessingContext.attributeNamesFromEffect,a=n.shaderProcessingContext.attributeLocationsFromEffect,l,c=0;for(let h=0;h<o.length;h++){let u=a[h],d=(this._overrideVertexBuffers&&this._overrideVertexBuffers[o[h]])??this._vertexBuffers[o[h]];d||(d=this._emptyVertexBuffer);let f=d.effectiveBuffer?.underlyingResource;if(d._validOffsetRange===void 0){let g=d.effectiveByteOffset,_=d.getSize(!0),x=d.effectiveByteStride;d._validOffsetRange=g+_<=this._kMaxVertexBufferStride&&x===0||x!==0&&g+_<=x}l&&l===f&&d._validOffsetRange||(this.vertexBuffers[c++]=d,l=d._validOffsetRange?f:null);let m=d.hashCode+(u<<7);this._isDirty=this._isDirty||this._states[r]!==m,this._states[r++]=m}this.vertexBuffers.length=c,this._statesLength=r,this._isDirty=this._isDirty||r!==i,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.VertexState))}_setTextureState(t){this._textureState!==t&&(this._textureState=t,this._states[Zi.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,Zi.TextureStage))}_createPipelineLayout(t){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(t);let i=[],r=t.shaderProcessingContext.bindGroupLayoutEntries;for(let n=0;n<r.length;n++){let o=r[n];i[n]=this._device.createBindGroupLayout({entries:o})}return t.bindGroupLayouts[0]=i,this._device.createPipelineLayout({bindGroupLayouts:i})}_createPipelineLayoutWithTextureStage(t){let i=t.shaderProcessingContext,r=i.bindGroupLayoutEntries,n=1;for(let a=0;a<r.length;a++){let l=r[a];for(let c=0;c<l.length;c++){let h=r[a][c];if(h.texture){let u=i.bindGroupLayoutEntryInfo[a][h.binding].name,d=i.availableTextures[u],f=d.autoBindSampler?i.availableSamplers[u+"Sampler"]:null,m=d.sampleType,g=f?.type??ma.Filtering;if(this._textureState&n&&m!==Ts.Depth&&(d.autoBindSampler&&(g=ma.NonFiltering),m=Ts.UnfilterableFloat),h.texture.sampleType=m,f){let _=i.bindGroupLayoutEntryInfo[f.binding.groupIndex][f.binding.bindingIndex].index;r[f.binding.groupIndex][_].sampler.type=g}n=n<<1}}}let o=[];for(let a=0;a<r.length;++a)o[a]=this._device.createBindGroupLayout({entries:r[a]});return t.bindGroupLayouts[this._textureState]=o,this._device.createPipelineLayout({bindGroupLayouts:o})}_getVertexInputDescriptor(t){let i=[],r=t._pipelineContext,n=r.shaderProcessingContext.attributeNamesFromEffect,o=r.shaderProcessingContext.attributeLocationsFromEffect,a,l;for(let c=0;c<n.length;c++){let h=o[c],u=(this._overrideVertexBuffers&&this._overrideVertexBuffers[n[c]])??this._vertexBuffers[n[c]];u||(u=this._emptyVertexBuffer);let d=u.effectiveBuffer?.underlyingResource,f=u.effectiveByteOffset,m=!u._validOffsetRange;if(!(a&&l&&a===d)||m){let g={arrayStride:u.effectiveByteStride,stepMode:u.getIsInstanced()?Yv.Instance:Yv.Vertex,attributes:[]};i.push(g),l=g.attributes,m&&(f=0,d=null)}l.push({shaderLocation:h,offset:f,format:s._GetVertexInputDescriptorFormat(u)}),a=d}return i}_createRenderPipeline(t,i,r){let n=t._pipelineContext,o=this._getVertexInputDescriptor(t),a=this._createPipelineLayout(n),l=[],c=this._getAphaBlendState(),h=this._getColorBlendState();if(this._vertexBuffers&&zv(this._vertexBuffers,t),this._mrtAttachments1>0)for(let m=0;m<this._mrtFormats.length;++m){let g=this._mrtFormats[m];if(g){let _={format:g,writeMask:this._mrtEnabledMask&1<<m?this._writeMask:0};c&&h&&(_.blend={alpha:c,color:h}),l.push(_)}else l.push(null)}else if(this._webgpuColorFormat[0]){let m={format:this._webgpuColorFormat[0],writeMask:this._writeMask};c&&h&&(m.blend={alpha:c,color:h}),l.push(m)}else l.push(null);let u={compare:s._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:s._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)},d;(i===Vs.LineStrip||i===Vs.TriangleStrip)&&(d=!this._indexBuffer||this._indexBuffer.is32Bits?ga.Uint32:ga.Uint16);let f=this._webgpuDepthStencilFormat?ut.HasStencilAspect(this._webgpuDepthStencilFormat):!1;return this._device.createRenderPipeline({label:`RenderPipeline_${l[0]?.format??"nooutput"}_${this._webgpuDepthStencilFormat??"nodepth"}_samples${r}_textureState${this._textureState}`,layout:a,vertex:{module:n.stages.vertexStage.module,entryPoint:n.stages.vertexStage.entryPoint,buffers:o},primitive:{topology:i,stripIndexFormat:d,frontFace:this._frontFace===1?Xv.CCW:Xv.CW,cullMode:this._cullEnabled?this._cullFace===2?bm.Front:bm.Back:bm.None},fragment:n.stages.fragmentStage?{module:n.stages.fragmentStage.module,entryPoint:n.stages.fragmentStage.entryPoint,targets:l}:void 0,multisample:{count:r},depthStencil:this._webgpuDepthStencilFormat===void 0?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?s._GetCompareFunction(this._depthCompare):mr.Always,format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&f?u:void 0,stencilBack:this._stencilEnabled&&f?u:void 0,stencilReadMask:this._stencilEnabled&&f?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&f?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale}})}}return s.NumCacheHitWithoutHash=0,s.NumCacheHitWithHash=0,s.NumCacheMiss=0,s.NumPipelineCreationLastFrame=0,s._NumPipelineCreationCurrentFrame=0,s})();var Em=class{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(let i in this.values){let r=this.values[i],[n,o]=r.count();e+=n,t+=o,e++}return[e,t]}},Zl=class s extends pV{static GetNodeCounts(){let e=s._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,r){if(e.pipeline){let n=i.slice();n.length=r,t.push(n)}for(let n in e.values){let o=e.values[n];i[r]=parseInt(n),s._GetPipelines(o,t,i,r+1)}}static GetPipelines(){let e=[];return s._GetPipelines(s._Cache,e,[],0),e}static ResetCache(){s._Cache=new Em}reset(){this._nodeStack=[],this._nodeStack[0]=s._Cache,super.reset()}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let i=this._stateDirtyLowestIndex;i<this._statesLength;++i){let r=t.values[this._states[i]];r||(r=new Em,t.values[this._states[i]]=r),t=r,this._nodeStack[i+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}};Zl._Cache=new Em;var tT=class extends LO{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){let e=this.stencilMaterial?.enabled;this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask)}};var iT=class extends FO{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e??1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e??2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}};var Nd=class{static IsExternalTexture(e){return e.underlyingResource!==void 0}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=!1,this.type=16,this.format=4294967295,this._video=e,this.uniqueId=Je._Counter++}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}};var mV=(()=>{class s{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatOrDepthTextures(){return this._numFloatOrDepthTextures>0}constructor(){this.uniqueId=s._Counter++,this.updateId=0,this.textureState=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatOrDepthTextures=0,this._numExternalTextures=0}setSampler(t,i){let r=this.samplers[t],n=-1;r?n=r.hashCode:this.samplers[t]=r={sampler:i,hashCode:0},r.sampler=i,r.hashCode=i?Od.GetSamplerHashCode(i):0;let o=n!==r.hashCode;o&&this.updateId++,this.isDirty||(this.isDirty=o)}setTexture(t,i){let r=this.textures[t],n=-1;r?n=r.texture?.uniqueId??-1:this.textures[t]=r={texture:i,isFloatOrDepthTexture:!1,isExternalTexture:!1},r.isExternalTexture&&this._numExternalTextures--,r.isFloatOrDepthTexture&&this._numFloatOrDepthTextures--,i?(r.isFloatOrDepthTexture=i.type===1||i.format>=13&&i.format<=18,r.isExternalTexture=Nd.IsExternalTexture(i),r.isFloatOrDepthTexture&&this._numFloatOrDepthTextures++,r.isExternalTexture&&this._numExternalTextures++):(r.isFloatOrDepthTexture=!1,r.isExternalTexture=!1),r.texture=i;let o=n!==(i?.uniqueId??-1);o&&this.updateId++,this.isDirty||(this.isDirty=o)}}return s._Counter=0,s})();var gV=(()=>{class s{isDirty(t){return this._isDirty||this._materialContextUpdateId!==t}resetIsDirty(t){this._isDirty=!1,this._materialContextUpdateId=t}get useInstancing(){return this._useInstancing}set useInstancing(t){this._useInstancing!==t&&(t?(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(20,kt.CopyDst|kt.Indirect|kt.Storage,void 0,"IndirectDrawBuffer"),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this.indirectDrawBuffer&&this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this._useInstancing=t,this._currentInstanceCount=-1)}constructor(t){this._bufferManager=t,this.uniqueId=s._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0}setBuffer(t,i){this._isDirty||(this._isDirty=i?.uniqueId!==this.buffers[t]?.uniqueId),this.buffers[t]=i}setIndirectData(t,i,r){i===this._currentInstanceCount||!this.indirectDrawBuffer||!this._indirectDrawData||(this._currentInstanceCount=i,this._indirectDrawData[0]=t,this._indirectDrawData[1]=i,this._indirectDrawData[2]=r,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0}}return s._Counter=0,s})();var ph=class{constructor(){this.values={}}},bn=class s{static get Statistics(){return{totalCreated:s.NumBindGroupsCreatedTotal,lastFrameCreated:s.NumBindGroupsCreatedLastFrame,lookupLastFrame:s.NumBindGroupsLookupLastFrame,noLookupLastFrame:s.NumBindGroupsNoLookupLastFrame}}static ResetCache(){s._Cache=new ph,s.NumBindGroupsCreatedTotal=0,s.NumBindGroupsCreatedLastFrame=0,s.NumBindGroupsLookupLastFrame=0,s.NumBindGroupsNoLookupLastFrame=0,s._NumBindGroupsCreatedCurrentFrame=0,s._NumBindGroupsLookupCurrentFrame=0,s._NumBindGroupsNoLookupCurrentFrame=0}constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}endFrame(){s.NumBindGroupsCreatedLastFrame=s._NumBindGroupsCreatedCurrentFrame,s.NumBindGroupsLookupLastFrame=s._NumBindGroupsLookupCurrentFrame,s.NumBindGroupsNoLookupLastFrame=s._NumBindGroupsNoLookupCurrentFrame,s._NumBindGroupsCreatedCurrentFrame=0,s._NumBindGroupsLookupCurrentFrame=0,s._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){let r,n=s._Cache,o=this.disabled||i.forceBindGroupCreation;if(!o){if(!t.isDirty(i.updateId)&&!i.isDirty)return s._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(let l of e.shaderProcessingContext.bufferNames){let c=t.buffers[l]?.uniqueId??0,h=n.values[c];h||(h=new ph,n.values[c]=h),n=h}for(let l of e.shaderProcessingContext.samplerNames){let c=i.samplers[l]?.hashCode??0,h=n.values[c];h||(h=new ph,n.values[c]=h),n=h}for(let l of e.shaderProcessingContext.textureNames){let c=i.textures[l]?.texture?.uniqueId??0,h=n.values[c];h||(h=new ph,n.values[c]=h),n=h}r=n.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,r)return t.bindGroups=r,s._NumBindGroupsLookupCurrentFrame++,r;r=[],t.bindGroups=r,o||(n.bindGroups=r),s.NumBindGroupsCreatedTotal++,s._NumBindGroupsCreatedCurrentFrame++;let a=e.bindGroupLayouts[i.textureState];for(let l=0;l<e.shaderProcessingContext.bindGroupLayoutEntries.length;l++){let c=e.shaderProcessingContext.bindGroupLayoutEntries[l],h=e.shaderProcessingContext.bindGroupEntries[l];for(let d=0;d<c.length;d++){let f=e.shaderProcessingContext.bindGroupLayoutEntries[l][d],m=e.shaderProcessingContext.bindGroupLayoutEntryInfo[l][f.binding],g=m.nameInArrayOfTexture??m.name;if(f.sampler){let _=i.samplers[g];if(_){let x=_.sampler;if(!x){this._engine.dbgSanityChecks&&F.Error(`Trying to bind a null sampler! entry=${JSON.stringify(f)}, name=${g}, bindingInfo=${JSON.stringify(_,(b,C)=>b==="texture"?"<no dump>":C)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}h[d].resource=this._cacheSampler.getSampler(x,!1,_.hashCode,x.label)}else F.Error(`Sampler "${g}" could not be bound. entry=${JSON.stringify(f)}, materialContext=${JSON.stringify(i,(x,b)=>x==="texture"||x==="sampler"?"<no dump>":b)}`,50)}else if(f.texture||f.storageTexture){let _=i.textures[g];if(_){if(this._engine.dbgSanityChecks&&_.texture===null){F.Error(`Trying to bind a null texture! entry=${JSON.stringify(f)}, bindingInfo=${JSON.stringify(_,(b,C)=>b==="texture"?"<no dump>":C)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}let x=_.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!x||f.texture&&!x.view||f.storageTexture&&!x.viewForWriting)){F.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(f)}, name=${g}, bindingInfo=${JSON.stringify(_,(b,C)=>b==="texture"?"<no dump>":C)}, isReady=${_.texture?.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}h[d].resource=f.storageTexture?x.viewForWriting:x.view}else F.Error(`Texture "${g}" could not be bound. entry=${JSON.stringify(f)}, materialContext=${JSON.stringify(i,(x,b)=>x==="texture"||x==="sampler"?"<no dump>":b)}`,50)}else if(f.externalTexture){let _=i.textures[g];if(_){if(this._engine.dbgSanityChecks&&_.texture===null){F.Error(`Trying to bind a null external texture! entry=${JSON.stringify(f)}, name=${g}, bindingInfo=${JSON.stringify(_,(b,C)=>b==="texture"?"<no dump>":C)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}let x=_.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!x){F.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(f)}, name=${g}, bindingInfo=${JSON.stringify(_,(b,C)=>b==="texture"?"<no dump>":C)}, isReady=${_.texture?.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}h[d].resource=this._device.importExternalTexture({source:x})}else F.Error(`Texture "${g}" could not be bound. entry=${JSON.stringify(f)}, materialContext=${JSON.stringify(i,(x,b)=>x==="texture"||x==="sampler"?"<no dump>":b)}`,50)}else if(f.buffer){let _=t.buffers[g];if(_){let x=_.underlyingResource;h[d].resource.buffer=x,h[d].resource.size=_.capacity}else F.Error(`Can't find buffer "${g}". entry=${JSON.stringify(f)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}let u=a[l];r[l]=this._device.createBindGroup({layout:u,entries:h})}return r}};bn.NumBindGroupsCreatedTotal=0;bn.NumBindGroupsCreatedLastFrame=0;bn.NumBindGroupsLookupLastFrame=0;bn.NumBindGroupsNoLookupLastFrame=0;bn._Cache=new ph;bn._NumBindGroupsCreatedCurrentFrame=0;bn._NumBindGroupsLookupCurrentFrame=0;bn._NumBindGroupsNoLookupCurrentFrame=0;var Tj="clearQuadVertexShader",Cj=`uniform depthValue: f32;const pos=array(
vec2f(-1.0,1.0),
vec2f(1.0,1.0),
vec2f(-1.0,-1.0),
vec2f(1.0,-1.0)
);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.position=vec4f(pos[input.vertexIndex],uniforms.depthValue,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;D.ShadersStoreWGSL[Tj]=Cj;var bj="clearQuadPixelShader",Sj=`uniform color: vec4f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=uniforms.color;}
`;D.ShadersStoreWGSL[bj]=Sj;var rT=class{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new Zl(this._device,i),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"],void 0,void 0,void 0,void 0,void 0,void 0,pe.WGSL)}clear(e,t,i,r,n=1){let o,a=null,l,c=!!this._engine._currentRenderTarget;if(e)o=e;else{let _=0;this._keyTemp.length=0;for(let b=0;b<this._cacheRenderPipeline.colorFormats.length;++b)this._keyTemp[_++]=Qn[this._cacheRenderPipeline.colorFormats[b]??""];let x=Qn[this._depthTextureFormat??0];if(this._keyTemp[_]=(t?t.r+t.g*256+t.b*256*256+t.a*256*256*256:0)+(i?2**32:0)+(r?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(c?2**35:0)+(n>1?2**36:0)+x*2**37,l=this._keyTemp.join("_"),a=this._bundleCache[l],a)return a;o=this._device.createRenderBundleEncoder({label:"clearQuadRenderBundle",colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:ut.GetSample(n)})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!r&&!!this._depthTextureFormat&&ut.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(r?255:0),this._cacheRenderPipeline.setStencilCompare(r?519:512),this._cacheRenderPipeline.setStencilPassOp(r?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);let h=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,n),u=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),u.uniformBuffer.update();let d=c?this._engine._ubInvertY:this._engine._ubDontInvertY,f=u.uniformBuffer.getBuffer(),m=f.uniqueId+"-"+d.uniqueId,g=this._bindGroups[m];if(!g){let _=u.bindGroupLayouts[0];g=this._bindGroups[m]=[],g.push(this._device.createBindGroup({label:`clearQuadBindGroup0-${m}`,layout:_[0],entries:[]})),_a._SimplifiedKnownBindings||g.push(this._device.createBindGroup({label:`clearQuadBindGroup1-${m}`,layout:_[1],entries:[]})),g.push(this._device.createBindGroup({label:`clearQuadBindGroup${_a._SimplifiedKnownBindings?1:2}-${m}`,layout:_[_a._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:d.underlyingResource,size:d.capacity}},{binding:1,resource:{buffer:f.underlyingResource,size:f.capacity}}]}))}o.setPipeline(h);for(let _=0;_<g.length;++_)o.setBindGroup(_,g[_]);return o.draw(4,1,0,0),e||(a=o.finish(),this._bundleCache[l]=a),a}};var sT=class s{constructor(e,t,i,r){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(r)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new s(this.x,this.y,this.w,this.h)}},nT=class s{constructor(e,t,i,r){this.x=e,this.y=t,this.w=i,this.h=r}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new s(this.x,this.y,this.w,this.h)}},Am=class s{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new s(this.ref)}},oT=class s{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new s(this.color)}},aT=class s{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new s(this.query)}},lT=class s{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new s}},g0=class s{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){let e=new s;return e.bundles=this.bundles,e}},cT=class s{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){let t=new g0;this._list[this._listLength++]=t,this._currentBundleList=t.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:ut.GetSample(i)})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();let e=new s(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}};var Fd=class{get querySet(){return this._querySet}constructor(e,t,i,r,n,o=!0,a){this._dstBuffers=[],this._engine=e,this._device=r,this._bufferManager=n,this._count=t,this._canUseMultipleBuffers=o,this._querySet=r.createQuerySet({label:a??"QuerySet",type:i,count:t}),this._queryBuffer=n.createRawBuffer(8*t,kt.QueryResolve|kt.CopySrc,void 0,"QueryBuffer"),o||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,kt.MapRead|kt.CopyDst,void 0,"QueryBufferNoMultipleBuffers"))}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&this._dstBuffers.length===0)return null;let i=this._device.createCommandEncoder(),r;return this._dstBuffers.length===0?r=this._bufferManager.createRawBuffer(8*this._count,kt.MapRead|kt.CopyDst,void 0,"QueryBufferAdditionalBuffer"):(r=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,r,0,8*t),this._device.queue.submit([i.finish()]),r}readValues(e=0,t=1){return $e(this,null,function*(){let i=this._getBuffer(e,t);if(i===null)return null;let r=this._engine.uniqueId;return i.mapAsync(rl.Read).then(()=>{let n=new BigUint64Array(i.getMappedRange()).slice();return i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,n},n=>{if(this._engine.isDisposed||this._engine.uniqueId!==r)return null;throw n})})}readValue(e=0){return $e(this,null,function*(){let t=this._getBuffer(e,1);if(t===null)return null;let i=this._engine.uniqueId;return t.mapAsync(rl.Read).then(()=>{let r=new BigUint64Array(t.getMappedRange()),n=Number(r[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,n},r=>{if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw r})})}readTwoValuesAndSubtract(e=0){return $e(this,null,function*(){let t=this._getBuffer(e,2);if(t===null)return null;let i=this._engine.uniqueId;return t.mapAsync(rl.Read).then(()=>{let r=new BigUint64Array(t.getMappedRange()),n=Number(r[1]-r[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,n},r=>{if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw r})})}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}};var hT=class{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t,i){this._enabled=!1,this._gpuFrameTimeCounter=new Ps,this._measureDurationState=0,this._engine=e,this._device=t,this._bufferManager=i}get enable(){return this._enabled}set enable(e){if(this._enabled!==e)if(this._enabled=e,this._measureDurationState=0,e)try{this._measureDuration=new _0(this._engine,this._device,this._bufferManager,2e3,"QuerySet_TimestampQuery")}catch(t){this._enabled=!1,F.Error(`Could not create a WebGPUDurationMeasure!
Error: `+t.message+`
Make sure timestamp query is supported and enabled in your browser.`);return}else this._measureDuration.dispose()}startFrame(e){this._enabled&&this._measureDurationState===0&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){this._measureDurationState===1&&(this._measureDurationState=2,this._measureDuration.stop(e).then(t=>{t!==null&&t>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(t,!0)),this._measureDurationState=0}))}startPass(e,t){this._enabled?this._measureDuration.startPass(e,t):e.timestampWrites=void 0}endPass(e,t){if(!this._enabled||!t)return;let i=this._engine.frameId;this._measureDuration.stopPass(e).then(r=>{t._addDuration(i,r!==null&&r>0?r:0)})}dispose(){this._measureDuration?.dispose()}},_0=class{constructor(e,t,i,r=2,n){this._count=r,this._querySet=new Fd(e,r,Sm.Timestamp,t,i,!0,n)}start(e){e.writeTimestamp?.(this._querySet.querySet,0)}stop(e){return $e(this,null,function*(){return e.writeTimestamp?.(this._querySet.querySet,1),e.writeTimestamp?this._querySet.readTwoValuesAndSubtract(0):0})}startPass(e,t){if(t+3>this._count)throw new Error("WebGPUDurationMeasure: index out of range ("+t+")");e.timestampWrites={querySet:this._querySet.querySet,beginningOfPassWriteIndex:t+2,endOfPassWriteIndex:t+3}}stopPass(e){return $e(this,null,function*(){return this._querySet.readTwoValuesAndSubtract(e+2)})}dispose(){this._querySet.dispose()}};var uT=class{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}canBeginQuery(e){if(this._frameQuerySetIsDirty===this._engine.frameId||this._queryFrameId[e]===this._engine.frameId)return!1;let t=this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet!==void 0;return t&&(this._queryFrameId[e]=this._engine.frameId),t}constructor(e,t,i,r=50,n=100){this._availableIndices=[],this._frameQuerySetIsDirty=-1,this._queryFrameId=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=n,this._allocateNewIndices(r)}createQuery(){this._availableIndices.length===0&&this._allocateNewIndices();let e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){return Number(this._lastBuffer?.[e]??-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new Fd(this._engine,this._currentTotalIndices,Sm.Occlusion,this._device,this._bufferManager,!1,"QuerySet_OcclusionQuery_count_"+this._currentTotalIndices),this._frameQuerySetIsDirty=this._engine.frameId}_delayQuerySetDispose(){let e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){this._querySet?.dispose(),this._availableIndices.length=0}};var Jl=class s{initTwgsl(e){return $e(this,null,function*(){if(!s._Twgsl)return e=e||{},e=ie(ie({},s._TWgslDefaultOptions),e),e.twgsl?(s._Twgsl=e.twgsl,Promise.resolve()):(e.jsPath&&e.wasmPath&&(yield H.LoadBabylonScriptAsync(e.jsPath)),self.twgsl?(s._Twgsl=yield self.twgsl(H.GetBabylonScriptURL(e.wasmPath)),Promise.resolve()):Promise.reject("twgsl is not available."))})}convertSpirV2WGSL(e,t=!1){let i=s._Twgsl.convertSpirV2WGSL(e,s.DisableUniformityAnalysis||t);return s.ShowWGSLShaderCode&&(F.Log(i),F.Log("***********************************************")),s.DisableUniformityAnalysis||t?`diagnostic(off, derivative_uniformity);
`+i:i}};Jl._TWgslDefaultOptions={jsPath:`${H._DefaultCdnUrl}/twgsl/twgsl.js`,wasmPath:`${H._DefaultCdnUrl}/twgsl/twgsl.wasm`};Jl.ShowWGSLShaderCode=!1;Jl.DisableUniformityAnalysis=!1;Jl._Twgsl=null;var dT=class{constructor(e,t,i){this._record=!1,this._play=!1,this._playBundleListIndex=0,this._allBundleLists=[],this._enabled=!1,this._engine=e,this._mode=t,this._bundleList=i}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._allBundleLists.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endRenderPass(e){if(!this._record&&!this._play)return!1;let t;if(this._record)t=this._bundleList.clone(),this._allBundleLists.push(t),this._bundleList.reset();else{if(this._playBundleListIndex>=this._allBundleLists.length)throw new Error(`Invalid playBundleListIndex! Your snapshot is no longer valid for the current frame, you should recreate a new one. playBundleListIndex=${this._playBundleListIndex}, allBundleLists.length=${this._allBundleLists.length}}`);t=this._allBundleLists[this._playBundleListIndex++]}return t.run(e),this._mode===1&&this._engine._reportDrawCall(t.numDrawCalls),!0}endFrame(){this._record&&(this._record=!1,this._play=!0,this._mode=this._modeSaved),this._playBundleListIndex=0}reset(){this.enabled=!1,this.enabled=!0}};var yj="postprocessVertexShader",Ej=`attribute position: vec2<f32>;uniform scale: vec2<f32>;varying vUV: vec2<f32>;const madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vUV=(vertexInputs.position*madd+madd)*uniforms.scale;vertexOutputs.position=vec4(vertexInputs.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;D.ShadersStoreWGSL[yj]=Ej;var fT=class extends Nd{constructor(e){super(e)}};var _V={label:"TextureView_SwapChain_ResolveTarget",dimension:Tn.E2d,format:void 0,mipLevelCount:1,arrayLayerCount:1},xV={label:"TextureView_SwapChain",dimension:Tn.E2d,format:void 0,mipLevelCount:1,arrayLayerCount:1},Aj=new oe,Ge=class s extends Se{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(e){this._snapshotRendering.mode=e}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(e){this._snapshotRendering.enabled=e}get disableCacheSamplers(){return this._cacheSampler?this._cacheSampler.disabled:!1}set disableCacheSamplers(e){this._cacheSampler&&(this._cacheSampler.disabled=e)}get disableCacheRenderPipelines(){return this._cacheRenderPipeline?this._cacheRenderPipeline.disabled:!1}set disableCacheRenderPipelines(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)}get disableCacheBindGroups(){return this._cacheBindGroups?this._cacheBindGroups.disabled:!1}set disableCacheBindGroups(e){this._cacheBindGroups&&(this._cacheBindGroups.disabled=e)}areAllEffectsReady(){return!0}getFontOffset(e){return Lx(e)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then(e=>!!e,()=>!1).catch(()=>!1):Promise.resolve(!1)}static get IsSupported(){return F.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get supportedLimits(){return this._adapterSupportedLimits}get currentLimits(){return this._deviceLimits}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:this._adapterInfo.vendor||"unknown vendor",renderer:this._adapterInfo.architecture||"unknown renderer",version:this._adapterInfo.description||"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=e}get enableGPUTimingMeasurements(){return this._timestampQuery.enable}set enableGPUTimingMeasurements(e){this._timestampQuery.enable!==e&&(this.gpuTimeInFrameForMainPass=e?new Ig:void 0,this._timestampQuery.enable=e)}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(e,t={}){let i=new s(e,t);return new Promise(r=>{i.initAsync(t.glslangOptions,t.twgslOptions).then(()=>r(i))})}constructor(e,t={}){if(super(t.antialias??!0,t),this.uniqueId=-1,this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._adapterInfo={vendor:"",architecture:"",device:"",description:""},this._timestampIndex=0,this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this.scenes=[],this._virtualScenes=new Array,this._commandBuffers=[null,null],this._currentRenderPass=null,this._mainRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._rttRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._pendingDebugCommands=[],this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsForFirstFrames=!1,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this._snapshotRenderingMode=0,this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,this._viewportsCurrent={x:0,y:0,w:0,h:0},this._scissorsCurrent={x:0,y:0,w:0,h:0},this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=-1,this._blendColorsCurrent=[null,null,null,null],this._performanceMonitor=new fd,this._name="WebGPU",this._drawCalls=new Ps,t.deviceDescriptor=t.deviceDescriptor||{},t.enableGPUDebugMarkers=t.enableGPUDebugMarkers??!1,F.Log(`Babylon.js v${K.Version} - ${this.description} engine`),!navigator.gpu){F.Error("WebGPU is not supported by your browser.");return}t.swapChainFormat=t.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",this._renderingCanvas=e,this._options=t,this._mainPassSampleCount=t.antialias?this._defaultSampleCount:1,navigator&&navigator.userAgent&&this._setupMobileChecks(),this._sharedInit(this._renderingCanvas),this._shaderProcessor=new qv,this._shaderProcessorWGSL=new Qv}initAsync(e,t){return this.uniqueId=s._InstanceId++,this._glslangOptions=e,this._twgslOptions=t,this._initGlslang(e??this._options?.glslangOptions).then(i=>(this._glslang=i,this._tintWASM=s.UseTWGSL?new Jl:null,this._tintWASM?this._tintWASM.initTwgsl(t??this._options?.twgslOptions).then(()=>navigator.gpu.requestAdapter(this._options)):navigator.gpu.requestAdapter(this._options))).then(i=>{if(i){this._adapter=i,this._adapterSupportedExtensions=[],this._adapter.features?.forEach(o=>this._adapterSupportedExtensions.push(o)),this._adapterSupportedLimits=this._adapter.limits,this._adapter.requestAdapterInfo().then(o=>{this._adapterInfo=o});let r=this._options.deviceDescriptor??{},n=r?.requiredFeatures??(this._options.enableAllFeatures?this._adapterSupportedExtensions:void 0);if(n){let o=n,a=[];for(let l of o)this._adapterSupportedExtensions.indexOf(l)!==-1&&a.push(l);r.requiredFeatures=a}if(this._options.setMaximumLimits&&!r.requiredLimits){r.requiredLimits={};for(let o in this._adapterSupportedLimits)o==="minSubgroupSize"||o==="maxSubgroupSize"||(r.requiredLimits[o]=this._adapterSupportedLimits[o])}return r.label=`BabylonWebGPUDevice${this.uniqueId}`,this._adapter.requestDevice(r)}else throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(i=>{this._device=i,this._deviceEnabledExtensions=[],this._device.features?.forEach(n=>this._deviceEnabledExtensions.push(n)),this._deviceLimits=i.limits;let r=-1;this._device.addEventListener("uncapturederror",n=>{++r<this.numMaxUncapturedErrors?F.Warn(`WebGPU uncaptured error (${r+1}): ${n.error} - ${n.error.message}`):r++===this.numMaxUncapturedErrors&&F.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)}),this._doNotHandleContextLost||this._device.lost?.then(n=>{this._isDisposed||(this._contextWasLost=!0,F.Warn("WebGPU context lost. "+n),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost(()=>$e(this,null,function*(){let o=this.snapshotRenderingMode,a=this.snapshotRendering,l=this.disableCacheSamplers,c=this.disableCacheRenderPipelines,h=this.disableCacheBindGroups,u=this.enableGPUTimingMeasurements;yield this.initAsync(this._glslangOptions??this._options?.glslangOptions,this._twgslOptions??this._options?.twgslOptions),this.snapshotRenderingMode=o,this.snapshotRendering=a,this.disableCacheSamplers=l,this.disableCacheRenderPipelines=c,this.disableCacheBindGroups=h,this.enableGPUTimingMeasurements=u,this._currentRenderPass=null})))})}).then(()=>{this._bufferManager=new Jv(this,this._device),this._textureHelper=new Kv(this,this._device,this._glslang,this._tintWASM,this._bufferManager,this._deviceEnabledExtensions),this._cacheSampler=new Od(this._device),this._cacheBindGroups=new bn(this._device,this._cacheSampler,this),this._timestampQuery=new hT(this,this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new uT(this,this._device,this._bufferManager):void 0,this._bundleList=new cT(this._device),this._snapshotRendering=new dT(this,this._snapshotRenderingMode,this._bundleList),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),kt.Uniform|kt.CopyDst,"UBInvertY"),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),kt.Uniform|kt.CopyDst,"UBDontInvertY"),this.dbgVerboseLogsForFirstFrames&&this._count===void 0&&(this._count=0,F.Log(["%c frame #"+this._count+" - begin","background: #ffff00"])),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._initializeLimits(),this._emptyVertexBuffer=new y(this,[0],"",{stride:1,offset:0,size:1,label:"EmptyVertexBuffer"}),this._cacheRenderPipeline=new Zl(this._device,this._emptyVertexBuffer),this._depthCullingState=new iT(this._cacheRenderPipeline),this._stencilStateComposer=new tT(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new rT(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()}).catch(i=>{throw F.Error("A fatal error occurred during WebGPU creation/initialization."),i})}_initGlslang(e){return e=e||{},e=ie(ie({},s._GLSLslangDefaultOptions),e),e.glslang?Promise.resolve(e.glslang):self.glslang?self.glslang(e.wasmPath):e.jsPath&&e.wasmPath?H.LoadBabylonScriptAsync(e.jsPath).then(()=>self.glslang(H.GetBabylonScriptURL(e.wasmPath))):Promise.reject("gslang is not available.")}_initializeLimits(){this._caps={maxTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxVertexTextureImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxCombinedTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage*2,maxTextureSize:this._deviceLimits.maxTextureDimension2D,maxCubemapTextureSize:this._deviceLimits.maxTextureDimension2D,maxRenderTextureSize:this._deviceLimits.maxTextureDimension2D,maxVertexAttribs:this._deviceLimits.maxVertexAttributes,maxVaryingVectors:this._deviceLimits.maxInterStageShaderVariables,maxFragmentUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),maxVertexUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf(Ro.TextureCompressionASTC)>=0?!0:void 0,s3tc:this._deviceEnabledExtensions.indexOf(Ro.TextureCompressionBC)>=0?!0:void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf(Ro.TextureCompressionETC2)>=0?!0:void 0,bptc:this._deviceEnabledExtensions.indexOf(Ro.TextureCompressionBC)>=0?!0:void 0,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:this._deviceEnabledExtensions.indexOf(Ro.RG11B10UFloatRenderable)>=0,textureFloat:!0,textureFloatLinearFiltering:this._deviceEnabledExtensions.indexOf(Ro.Float32Filterable)>=0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:typeof BigUint64Array<"u"&&this._deviceEnabledExtensions.indexOf(Ro.TimestampQuery)!==-1?!0:void 0,supportOcclusionQuery:typeof BigUint64Array<"u",canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:this._deviceLimits.maxTextureArrayLayers,disableMorphTargetTexture:!1},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!0,_collectUbosUpdatedInFrame:!1}}_initializeContextAndSwapChain(){if(!this._renderingCanvas)throw"The rendering canvas has not been set!";this._context=this._renderingCanvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new Kl],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat,this._setColorFormat(this._mainRenderPassWrapper)}_initializeMainAttachments(){if(!this._bufferManager)return;this.flushFramebuffer(),this._mainTextureExtends={width:this.getRenderWidth(!0),height:this.getRenderHeight(!0),depthOrArrayLayers:1};let e=new Float32Array([this.getRenderHeight(!0)]);this._bufferManager.setSubData(this._ubInvertY,4,e),this._bufferManager.setSubData(this._ubDontInvertY,4,e);let t;if(this._options.antialias){let n={label:`Texture_MainColor_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}_antialiasing`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Tn.E2d,format:this._options.swapChainFormat,usage:pi.RenderAttachment};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(n),t=[{view:this._mainTexture.createView({label:"TextureView_MainColor_antialiasing",dimension:Tn.E2d,format:this._options.swapChainFormat,mipLevelCount:1,arrayLayerCount:1}),clearValue:new oe(0,0,0,1),loadOp:ir.Clear,storeOp:Qs.Store}]}else t=[{view:void 0,clearValue:new oe(0,0,0,1),loadOp:ir.Clear,storeOp:Qs.Store}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?B.Depth24PlusStencil8:B.Depth32Float,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper);let i={label:`Texture_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Tn.E2d,format:this._mainRenderPassWrapper.depthTextureFormat,usage:pi.RenderAttachment};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(i);let r={view:this._depthTexture.createView({label:`TextureView_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,dimension:Tn.E2d,format:this._depthTexture.format,mipLevelCount:1,arrayLayerCount:1}),depthClearValue:this._clearDepthValue,depthLoadOp:ir.Clear,depthStoreOp:Qs.Store,stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?ir.Clear:void 0,stencilStoreOp:this.isStencilEnable?Qs.Store:void 0};this._mainRenderPassWrapper.renderPassDescriptor={label:"MainRenderPass",colorAttachments:t,depthStencilAttachment:r}}_sharedInit(e){super._sharedInit(e),Nx(this,e,this._creationOptions)}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:pi.RenderAttachment|pi.CopySrc,alphaMode:this.premultipliedAlpha?$v.Premultiplied:$v.Opaque})}resizeImageBitmap(e,t,i){return Vx(this,e,t,i)}_createImageBitmapFromSource(e,t){return Bx(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&Ux(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&kx()}enterPointerlock(){this._renderingCanvas&&$p(this._renderingCanvas)}exitPointerlock(){Gx()}_rebuildBuffers(){super._rebuildBuffers();for(let e of this._storageBuffers)e.getBuffer().engineId!==this.uniqueId&&e._rebuild()}_restoreEngineAfterContextLost(e){Zl.ResetCache(),bn.ResetCache();let t=r=>{for(let n of r){for(let o of n.meshes){let a=o.subMeshes;if(a)for(let l of a)l._drawWrappers=[]}for(let o of n.materials)o._materialContext?.reset()}};t(this.scenes),t(this._virtualScenes);let i=[];for(let r of this._uniformBuffers)r.name.indexOf("leftOver")<0&&i.push(r);this._uniformBuffers=i,super._restoreEngineAfterContextLost(e)}setSize(e,t,i=!1){return super.setSize(e,t,i)?(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&F.Log(["frame #"+this._count+" - setSize -",e,t])),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0):!1}_getShaderProcessor(e){return e===pe.WGSL?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(e){return new _a(e)}_currentPassIsMainPass(){return this._currentRenderTarget===null}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassWrapper(){return this._currentRenderTarget?this._rttRenderPassWrapper:this._mainRenderPassWrapper}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend)}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(e){this._colorWriteLocal=e,this._cacheRenderPipeline.setWriteMask(e?15:0)}getColorWrite(){return this._colorWriteLocal}_mustUpdateViewport(){let e=this._viewportCached.x,t=this._viewportCached.y,i=this._viewportCached.z,r=this._viewportCached.w,n=this._viewportsCurrent.x!==e||this._viewportsCurrent.y!==t||this._viewportsCurrent.w!==i||this._viewportsCurrent.h!==r;return n&&(this._viewportsCurrent.x=this._viewportCached.x,this._viewportsCurrent.y=this._viewportCached.y,this._viewportsCurrent.w=this._viewportCached.z,this._viewportsCurrent.h=this._viewportCached.w),n}_applyViewport(e){let t=Math.floor(this._viewportCached.x),i=Math.floor(this._viewportCached.z),r=Math.floor(this._viewportCached.w),n=Math.floor(this._viewportCached.y);this._currentRenderTarget||(n=this.getRenderHeight(!0)-n-r),e?e.addItem(new sT(t,n,i,r)):this._getCurrentRenderPass().setViewport(t,n,i,r,0,1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&F.Log(["frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_viewport(e,t,i,r){this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r}_mustUpdateScissor(){let e=this._scissorCached.x,t=this._scissorCached.y,i=this._scissorCached.z,r=this._scissorCached.w,n=this._scissorsCurrent.x!==e||this._scissorsCurrent.y!==t||this._scissorsCurrent.w!==i||this._scissorsCurrent.h!==r;return n&&(this._scissorsCurrent.x=this._scissorCached.x,this._scissorsCurrent.y=this._scissorCached.y,this._scissorsCurrent.w=this._scissorCached.z,this._scissorsCurrent.h=this._scissorCached.w),n}_applyScissor(e){let t=this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y;e?e.addItem(new nT(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w)):this._getCurrentRenderPass().setScissorRect(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&F.Log(["frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_scissorIsActive(){return this._scissorCached.x!==0||this._scissorCached.y!==0||this._scissorCached.z!==0||this._scissorCached.w!==0}enableScissor(e,t,i,r){this._scissorCached.x=e,this._scissorCached.y=t,this._scissorCached.z=i,this._scissorCached.w=r}disableScissor(){this._scissorCached.x=this._scissorCached.y=this._scissorCached.z=this._scissorCached.w=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0}_mustUpdateStencilRef(){let e=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent;return e&&(this._stencilRefsCurrent=this._stencilStateComposer.funcRef),e}_applyStencilRef(e){e?e.addItem(new Am(this._stencilStateComposer.funcRef??0)):this._getCurrentRenderPass().setStencilReference(this._stencilStateComposer.funcRef??0)}_mustUpdateBlendColor(){let e=this._alphaState._blendConstants,t=e[0]!==this._blendColorsCurrent[0]||e[1]!==this._blendColorsCurrent[1]||e[2]!==this._blendColorsCurrent[2]||e[3]!==this._blendColorsCurrent[3];return t&&(this._blendColorsCurrent[0]=e[0],this._blendColorsCurrent[1]=e[1],this._blendColorsCurrent[2]=e[2],this._blendColorsCurrent[3]=e[3]),t}_applyBlendColor(e){e?e.addItem(new oT(this._alphaState._blendConstants.slice())):this._getCurrentRenderPass().setBlendConstant(this._alphaState._blendConstants)}_resetRenderPassStates(){this._viewportsCurrent.x=this._viewportsCurrent.y=this._viewportsCurrent.w=this._viewportsCurrent.h=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0,this._stencilRefsCurrent=-1,this._blendColorsCurrent[0]=this._blendColorsCurrent[1]=this._blendColorsCurrent[2]=this._blendColorsCurrent[3]=null}clear(e,t,i,r=!1){e&&e.a===void 0&&(e.a=1);let n=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&F.Log(["frame #"+this._count+" - clear - backBuffer=",t," depth=",i," stencil=",r," scissor is active=",n])),this._currentRenderTarget?n?(this._currentRenderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,t?e:null,i,r),this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)):(this._currentRenderPass&&this._endCurrentRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,t?e:null,i,r)):((!this._currentRenderPass||!n)&&this._startMainRenderPass(!n,t?e:null,i,r),n&&(this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)))}_clearFullQuad(e,t,i){let r=this.compatibilityMode?this._getCurrentRenderPass():null;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments(this._cacheRenderPipeline.mrtAttachments??[],this._cacheRenderPipeline.mrtTextureArray??[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?r.setStencilReference(this._clearStencilValue):this._bundleList.addItem(new Am(this._clearStencilValue));let n=this._clearQuad.clear(r,e,t,i,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(null):(this._bundleList.addBundle(n),this._applyStencilRef(this._bundleList),this._reportDrawCall())}createVertexBuffer(e,t,i){let r;return e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e,this._bufferManager.createBuffer(r,kt.Vertex|kt.CopyDst,i)}createDynamicVertexBuffer(e,t){return this.createVertexBuffer(e,void 0,t)}createIndexBuffer(e,t,i){let r=!0,n;e instanceof Uint32Array||e instanceof Int32Array?n=e:e instanceof Uint16Array?(n=e,r=!1):e.length>65535?n=new Uint32Array(e):(n=new Uint16Array(e),r=!1);let o=this._bufferManager.createBuffer(n,kt.Index|kt.CopyDst,i);return o.is32Bits=r,o}updateDynamicIndexBuffer(e,t,i=0){let r=e,n;e.is32Bits?n=t instanceof Uint32Array?t:new Uint32Array(t):n=t instanceof Uint16Array?t:new Uint16Array(t),this._bufferManager.setSubData(r,i,n)}updateDynamicVertexBuffer(e,t,i,r){let n=e;i===void 0&&(i=0);let o;r===void 0?(t instanceof Array?o=new Float32Array(t):t instanceof ArrayBuffer?o=new Uint8Array(t):o=t,r=o.byteLength):t instanceof Array?o=new Float32Array(t):t instanceof ArrayBuffer?o=new Uint8Array(t):o=t,this._bufferManager.setSubData(n,i,o,0,r)}_createBuffer(e,t,i){let r;e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e;let n=0;return t&1&&(n|=kt.CopySrc),t&2&&(n|=kt.CopyDst),t&4&&(n|=kt.Uniform),t&8&&(n|=kt.Vertex),t&16&&(n|=kt.Index),t&32&&(n|=kt.Storage),t&64&&(n|=kt.Indirect),this._bufferManager.createBuffer(r,n,i)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}unbindInstanceAttributes(){}bindBuffers(e,t,i,r){this._currentIndexBuffer=t,this._currentOverrideVertexBuffers=r??null,this._cacheRenderPipeline.setBuffers(e,t,this._currentOverrideVertexBuffers)}_releaseBuffer(e){return this._bufferManager.releaseBuffer(e)}createUniformBuffer(e,t){let i;return e instanceof Array?i=new Float32Array(e):i=e,this._bufferManager.createBuffer(i,kt.Uniform|kt.CopyDst,t)}createDynamicUniformBuffer(e,t){return this.createUniformBuffer(e,t)}updateUniformBuffer(e,t,i,r){i===void 0&&(i=0);let n=e,o;r===void 0?(t instanceof Float32Array?o=t:o=new Float32Array(t),r=o.byteLength):t instanceof Float32Array?o=t:o=new Float32Array(t),this._bufferManager.setSubData(n,i,o,0,r)}bindUniformBufferBase(e,t,i){this._currentDrawContext.setBuffer(i,e)}bindUniformBlock(){}createEffect(e,t,i,r,n,o,a,l,c,h=pe.GLSL){let u=typeof e=="string"?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d=typeof e=="string"?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,f=this._getGlobalDefines(),m=n??t.defines??"";f&&(m+=`
`+f);let g=u+"+"+d+"@"+m;if(this._compiledEffects[g]){let x=this._compiledEffects[g];return a&&x.isReady()&&a(x),x}let _=new $t(e,t,i,r,this,n,o,a,l,c,g,t.shaderLanguage??h);return this._compiledEffects[g]=_,_}_compileRawShaderToSpirV(e,t){return this._glslang.compileGLSL(e,t)}_compileShaderToSpirV(e,t,i,r){return this._compileRawShaderToSpirV(r+(i?i+`
`:"")+e,t)}_getWGSLShader(e,t,i){return i?i="//"+i.split(`
`).join(`
//`)+`
`:i="",i+e}_createPipelineStageDescriptor(e,t,i,r,n){return this._tintWASM&&i===pe.GLSL&&(e=this._tintWASM.convertSpirV2WGSL(e,r),t=this._tintWASM.convertSpirV2WGSL(t,n)),{vertexStage:{module:this._device.createShaderModule({code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:t}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(e,t,i){let r=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,n=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,o=i===pe.GLSL?this._compileRawShaderToSpirV(e,"vertex"):e,a=i===pe.GLSL?this._compileRawShaderToSpirV(t,"fragment"):t;return this._createPipelineStageDescriptor(o,a,i,r,n)}_compilePipelineStageDescriptor(e,t,i,r){this.onBeforeShaderCompilationObservable.notifyObservers(this);let n=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,o=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,a=`#version 450
`,l=r===pe.GLSL?this._compileShaderToSpirV(e,"vertex",i,a):this._getWGSLShader(e,"vertex",i),c=r===pe.GLSL?this._compileShaderToSpirV(t,"fragment",i,a):this._getWGSLShader(t,"fragment",i),h=this._createPipelineStageDescriptor(l,c,r,n,o);return this.onAfterShaderCompilationObservable.notifyObservers(this),h}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(e){let t=new Rd(e);return t.debug=!1,t.processCode(),t.code}createPipelineContext(e){return new jv(e,this)}createMaterialContext(){return new mV}createDrawContext(){return new gV(this._bufferManager)}_preparePipelineContext(e,t,i,r,n,o,a,l){let c=e,h=c.shaderProcessingContext.shaderLanguage;this.dbgShowShaderCode&&(F.Log(["defines",l]),F.Log(t),F.Log(i),F.Log("***********************************************")),c.sources={fragment:i,vertex:t,rawVertex:n,rawFragment:o},r?c.stages=this._compileRawPipelineStageDescriptor(t,i,h):c.stages=this._compilePipelineStageDescriptor(t,i,l,h)}getAttributes(e,t){let i=new Array(t.length),r=e;for(let n=0;n<t.length;n++){let o=t[n],a=r.shaderProcessingContext.availableAttributes[o];a!==void 0&&(i[n]=a)}return i}enableEffect(e){if(e){if(!HS(e))this._currentEffect=e,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&F.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${e.uniqueId}, effect.name=${e.name}, effect.name.vertex=${typeof e.name=="string"?"":e.name.vertex}, effect.name.fragment=${typeof e.name=="string"?"":e.name.fragment}`,10);else if(!e.effect||e.effect===this._currentEffect&&e.materialContext===this._currentMaterialContext&&e.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!e.effect&&this.dbgShowEmptyEnableEffectCalls)throw F.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the effect property is empty!";return}else if(this._currentEffect=e.effect,this._currentMaterialContext=e.materialContext,this._currentDrawContext=e.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw F.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the materialContext property is empty!";this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=!1,this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect)}}_releaseEffect(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))}releaseEffects(){for(let e in this._compiledEffects){let t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}_deletePipelineContext(e){let t=e;t&&NO(t)}get needPOTTextures(){return!1}_createHardwareTexture(){return new Kl}_releaseTexture(e){let t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),this._textureHelper.releaseTexture(e)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(e,t){e._comparisonFunction=t}_createInternalTexture(e,t,i=!0,r=ke.Unknown){let n={};t!==void 0&&typeof t=="object"?(n.generateMipMaps=t.generateMipMaps,n.type=t.type===void 0?0:t.type,n.samplingMode=t.samplingMode===void 0?3:t.samplingMode,n.format=t.format===void 0?5:t.format,n.samples=t.samples??1,n.creationFlags=t.creationFlags??0,n.useSRGBBuffer=t.useSRGBBuffer??!1,n.label=t.label):(n.generateMipMaps=t,n.type=0,n.samplingMode=3,n.format=5,n.samples=1,n.creationFlags=0,n.useSRGBBuffer=!1),(n.type===1&&!this._caps.textureFloatLinearFiltering||n.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(n.samplingMode=1),n.type===1&&!this._caps.textureFloat&&(n.type=0,F.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));let o=new Je(this,r),a=e.width||e,l=e.height||e,c=e.depth||0,h=e.layers||0;return o.baseWidth=a,o.baseHeight=l,o.width=a,o.height=l,o.depth=c||h,o.isReady=!0,o.samples=n.samples,o.generateMipMaps=!!n.generateMipMaps,o.samplingMode=n.samplingMode,o.type=n.type,o.format=n.format,o.is2DArray=h>0,o.is3D=c>0,o._cachedWrapU=0,o._cachedWrapV=0,o._useSRGBBuffer=n.useSRGBBuffer,o.label=n.label,this._internalTexturesCache.push(o),i||this._textureHelper.createGPUTextureForInternalTexture(o,a,l,h||1,n.creationFlags),o}createTexture(e,t,i,r,n=3,o=null,a=null,l=null,c=null,h=null,u=null,d,f,m,g){return this._createTextureBase(e,t,i,r,n,o,a,(_,x,b,C,R,E,S,A)=>{let L=C;if(_.baseWidth=L.width,_.baseHeight=L.height,_.width=L.width,_.height=L.height,_.format=_.format!==-1?_.format:h??5,_.type=_.type!==-1?_.type:0,_._creationFlags=m??0,A(_.width,_.height,L,x,_,()=>{}),_._hardwareTexture?.underlyingResource)!E&&!S&&this._generateMipmaps(_,this._uploadEncoder);else{let G=this._textureHelper.createGPUTextureForInternalTexture(_,L.width,L.height,void 0,m);ut.IsImageBitmap(L)&&(this._textureHelper.updateTexture(L,_,L.width,L.height,_.depth,G.format,0,0,R,!1,0,0),!E&&!S&&this._generateMipmaps(_,this._uploadEncoder))}b&&b.removePendingData(_),_.isReady=!0,_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear()},()=>!1,l,c,h,u,d,f,g)}wrapWebGPUTexture(e){let t=new Kl(e),i=new Je(this,ke.Unknown,!0);return i._hardwareTexture=t,i.isReady=!0,i}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers}_unpackFlipY(e){}updateTextureSamplingMode(e,t,i=!1){i&&(t.generateMipMaps=!0,this._generateMipmaps(t)),t.samplingMode=e}updateTextureWrappingMode(e,t,i=null,r=null){t!==null&&(e._cachedWrapU=t),i!==null&&(e._cachedWrapV=i),(e.is2DArray||e.is3D)&&r!==null&&(e._cachedWrapR=r)}updateTextureDimensions(e,t,i,r=1){if(!e._hardwareTexture||e.width===t&&e.height===i&&e.depth===r)return;let n=e._hardwareTexture.textureAdditionalUsages;e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,t,i,r,n)}_setInternalTexture(e,t,i){if(i=i??e,this._currentEffect){let n=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[i];if(this._currentMaterialContext.setTexture(e,t),n&&n.autoBindSampler){let o=i+"Sampler";this._currentMaterialContext.setSampler(o,t)}}}createPrefilteredCubeTexture(e,t,i,r,n=null,o=null,a,l=null,c=!0){let h=u=>{if(!u){n&&n(null);return}let d=u.texture;c?u.info.sphericalPolynomial&&(d._sphericalPolynomial=u.info.sphericalPolynomial):d._sphericalPolynomial=new vs,d._source=ke.CubePrefiltered,n&&n(d)};return this.createCubeTexture(e,t,null,!1,h,o,a,l,c,i,r)}setTexture(e,t,i,r){this._setTexture(e,i,!1,!1,r,r)}setTextureArray(e,t,i,r){for(let n=0;n<i.length;n++)this._setTexture(-1,i[n],!0,!1,r+n.toString(),r)}_setTexture(e,t,i=!1,r=!1,n="",o){if(o=o??n,this._currentEffect){if(!t)return this._currentMaterialContext.setTexture(n,null),!1;if(t.video)t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let a=null;if(r?a=t.depthStencilTexture:t.isReady()?a=t.getInternalTexture():t.isCube?a=this.emptyCubeTexture:t.is3D?a=this.emptyTexture3D:t.is2DArray?a=this.emptyTexture2DArray:a=this.emptyTexture,a&&!a.isMultiview){if(a.isCube&&a._cachedCoordinatesMode!==t.coordinatesMode){a._cachedCoordinatesMode=t.coordinatesMode;let l=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=l,t.wrapV=l}a._cachedWrapU=t.wrapU,a._cachedWrapV=t.wrapV,a.is3D&&(a._cachedWrapR=t.wrapR),this._setAnisotropicLevel(0,a,t.anisotropicFilteringLevel)}this._setInternalTexture(n,a,o)}else this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&F.Log(["frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",t]));return!0}_setAnisotropicLevel(e,t,i){t._cachedAnisotropicFilteringLevel!==i&&(t._cachedAnisotropicFilteringLevel=Math.min(i,this._caps.maxAnisotropy))}_bindTexture(e,t,i){e!==void 0&&this._setInternalTexture(i,t)}generateMipmaps(e){this._generateMipmaps(e)}_generateMipmaps(e,t){t=t??this._renderEncoder;let i=e._hardwareTexture;if(!i)return;t===this._renderEncoder&&this._endCurrentRenderPass();let r=e._hardwareTexture.format,n=ut.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&F.Log("frame #"+this._count+" - generate mipmaps - width="+e.width+", height="+e.height+", isCube="+e.isCube+", command encoder="+(t===this._renderEncoder?"render":"copy"))),e.isCube?this._textureHelper.generateCubeMipmaps(i,r,n,t):this._textureHelper.generateMipmaps(i,r,n,0,e.is3D,t)}updateTextureData(e,t,i,r,n,o,a=0,l=0,c=!1){let h=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(h=this._textureHelper.createGPUTextureForInternalTexture(e));let u=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(u,e,n,o,e.depth,h.format,a,l,e.invertY,!1,i,r),c&&this._generateMipmaps(e)}_uploadCompressedDataToTextureDirectly(e,t,i,r,n,o=0,a=0){let l=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(e.format=t,l=this._textureHelper.createGPUTextureForInternalTexture(e,i,r));let c=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);this._textureHelper.updateTexture(c,e,i,r,e.depth,l.format,o,a,!1,!1,0,0)}_uploadDataToTextureDirectly(e,t,i=0,r=0,n,o=!1){let a=Math.round(Math.log(e.width)*Math.LOG2E),l=Math.round(Math.log(e.height)*Math.LOG2E),c=o?e.width:Math.pow(2,Math.max(a-r,0)),h=o?e.height:Math.pow(2,Math.max(l-r,0)),u=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(u=this._textureHelper.createGPUTextureForInternalTexture(e,c,h));let d=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(d,e,c,h,e.depth,u.format,i,r,e.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){this._uploadDataToTextureDirectly(e,t,i,r)}_uploadImageToTexture(e,t,i=0,r=0){let n=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(n=this._textureHelper.createGPUTextureForInternalTexture(e)),t instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";let o=t,a=Math.ceil(e.width/(1<<r)),l=Math.ceil(e.height/(1<<r));this._textureHelper.updateTexture(o,e,a,l,e.depth,n.format,i,r,e.invertY,!1,0,0)}readPixels(e,t,i,r,n=!0,o=!0){let l=this._getCurrentRenderPassWrapper().colorAttachmentGPUTextures[0];if(!l)return Promise.resolve(new Uint8Array(0));let c=l.underlyingResource,h=l.format;return c?(o&&this.flushFramebuffer(),this._textureHelper.readPixels(c,e,t,i,r,h)):Promise.resolve(new Uint8Array(0))}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}beginFrame(){this._measureFps(),super.beginFrame()}endFrame(){if(this._endCurrentRenderPass(),this._snapshotRendering.endFrame(),this._timestampQuery.endFrame(this._renderEncoder),this._timestampIndex=0,this.flushFramebuffer(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){let e=[];for(let t in _r._UpdatedUbosInFrame)e.push(t+":"+_r._UpdatedUbosInFrame[t]);F.Log(["frame #"+this._count+" - updated ubos -",e.join(", ")])}_r._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&F.Log(["%c frame #"+this._count+" - end","background: #ffff00"]),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&F.Log(["%c frame #"+this._count+" - begin","background: #ffff00"]))),super.endFrame()}extractDriverInfo(){return""}flushFramebuffer(){this._endCurrentRenderPass(),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset()}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentPassIsMainPass()}_startRenderTargetRenderPass(e,t,i,r,n){this._endCurrentRenderPass();let o=e,a=o._depthStencilTexture,l=a?._hardwareTexture,c=l?.underlyingResource,h=l?.getMSAATexture(),u=c?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),d=h?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),f=l?ut.HasStencilAspect(l.format):!1,m=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();let g=Aj;i&&(g.r=i.r*255,g.g=i.g*255,g.b=i.b*255,g.a=i.a*255);let _=t&&i,x=t&&r,b=t&&n;if(o._attachments&&o.isMulti){(!this._mrtAttachments||this._mrtAttachments.length===0)&&(this._mrtAttachments=o._defaultAttachments);for(let C=0;C<this._mrtAttachments.length;++C){let R=this._mrtAttachments[C],E=o.textures[C],S=E?._hardwareTexture,A=S?.underlyingResource;if(S&&A){let L=S.getMSAATexture(C),G=o.layerIndices?.[C]??0,W=o.faceIndices?.[C]??0,$=Kt(ie({},this._rttRenderPassWrapper.colorAttachmentViewDescriptor),{dimension:E.is3D?dt.E3d:dt.E2d,format:S.format,baseArrayLayer:E.isCube?G*6+W:E.is3D?0:G}),re=Kt(ie({},this._rttRenderPassWrapper.colorAttachmentViewDescriptor),{dimension:E.is3D?dt.E3d:dt.E2d,format:S.format,baseArrayLayer:0}),we=E.type===7||E.type===5,_e=A.createView($),ce=L?.createView(re);m.push({view:ce||_e,resolveTarget:L?_e:void 0,depthSlice:E.is3D?G:void 0,clearValue:R!==0&&_?we?g:i:void 0,loadOp:R!==0&&_?ir.Clear:ir.Load,storeOp:Qs.Store})}}this._cacheRenderPipeline.setMRT(o.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{let C=o.texture;if(C){let R=C._hardwareTexture,E=R.underlyingResource,S;o.is3D&&(S=this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer,this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer=0);let A=R.getMSAATexture(),L=E.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),G=A?.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),W=C.type===7||C.type===5;m.push({view:G||L,resolveTarget:A?L:void 0,depthSlice:S,clearValue:_?W?g:i:void 0,loadOp:_?ir.Clear:ir.Load,storeOp:Qs.Store})}else m.push(null)}if(this._debugPushGroup?.("render target pass"+(e.label?" ("+e.label+")":""),1),this._rttRenderPassWrapper.renderPassDescriptor={label:(e.label??"RTT")+"RenderPass",colorAttachments:m,depthStencilAttachment:a&&c?{view:d||u,depthClearValue:x?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:x?ir.Clear:ir.Load,depthStoreOp:Qs.Store,stencilClearValue:o._depthStencilTextureWithStencil&&b?this._clearStencilValue:void 0,stencilLoadOp:f?o._depthStencilTextureWithStencil&&b?ir.Clear:ir.Load:void 0,stencilStoreOp:f?Qs.Store:void 0}:void 0,occlusionQuerySet:this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0},this._timestampQuery.startPass(this._rttRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){let C=o.texture;F.Log(["frame #"+this._count+" - render target begin pass - rtt name="+e.label+", internalTexture.uniqueId="+C.uniqueId+", width="+C.width+", height="+C.height+", setClearStates="+t,"renderPassDescriptor=",this._rttRenderPassWrapper.renderPassDescriptor])}this._debugFlushPendingCommands?.(),this._resetRenderPassStates(),(!l||!ut.HasStencilAspect(l.format))&&(this._stencilStateComposer.enabled=!1)}_startMainRenderPass(e,t,i,r){this._endCurrentRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();let n=e&&t,o=e&&i,a=e&&r;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=n?t:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=n?ir.Clear:ir.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=o?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=o?ir.Clear:ir.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=a?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?a?ir.Clear:ir.Load:void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0;let l=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(l),this._options.antialias?(_V.format=l.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=l.createView(_V)):(xV.format=l.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=l.createView(xV)),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&F.Log(["frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height+", setClearStates="+e,"renderPassDescriptor=",this._mainRenderPassWrapper.renderPassDescriptor])),this._debugPushGroup?.("main pass",0),this._timestampQuery.startPass(this._mainRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper),this._debugFlushPendingCommands?.(),this._resetRenderPassStates(),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}_endCurrentRenderPass(){if(!this._currentRenderPass)return 0;let e=this._currentPassIsMainPass()?2:1;return!this._snapshotRendering.endRenderPass(this._currentRenderPass)&&!this.compatibilityMode&&(this._bundleList.run(this._currentRenderPass),this._bundleList.reset()),this._currentRenderPass.end(),this._timestampQuery.endPass(this._timestampIndex,this._currentRenderTarget&&this._currentRenderTarget.gpuTimeInFrame?this._currentRenderTarget.gpuTimeInFrame:this.gpuTimeInFrameForMainPass),this._timestampIndex+=2,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&F.Log("frame #"+this._count+" - "+(e===2?"main":"render target")+" end pass"+(e===1?" - internalTexture.uniqueId="+this._currentRenderTarget?.texture?.uniqueId:""))),this._debugPopGroup?.(0),this._currentRenderPass=null,e}bindFramebuffer(e,t=0,i,r,n,o=0,a=0){let l=e.texture?._hardwareTexture;this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass(),this._currentRenderTarget=e;let c=this._currentRenderTarget._depthStencilTexture;this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=l,this._rttRenderPassWrapper.depthTextureFormat=c?ut.GetWebGPUTextureFormat(-1,c.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:e.is3D?dt.E3d:dt.E2d,mipLevelCount:1,baseArrayLayer:e.isCube?a*6+t:a,baseMipLevel:o,arrayLayerCount:1,aspect:Cn.All},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:c&&c.is3D?dt.E3d:dt.E2d,mipLevelCount:1,baseArrayLayer:c?c.isCube?a*6+t:a:0,baseMipLevel:0,arrayLayerCount:1,aspect:Cn.All},this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&F.Log(["frame #"+this._count+" - bindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId="+e.texture?.uniqueId+", face="+t+", lodLevel="+o+", layer="+a,"colorAttachmentViewDescriptor=",this._rttRenderPassWrapper.colorAttachmentViewDescriptor,"depthAttachmentViewDescriptor=",this._rttRenderPassWrapper.depthAttachmentViewDescriptor])),this._cachedViewport&&!n?this.setViewport(this._cachedViewport,i,r):(i||(i=e.width,o&&(i=i/Math.pow(2,o))),r||(r=e.height,o&&(r=r/Math.pow(2,o))),this._viewport(0,0,i,r)),this.wipeCaches()}unBindFramebuffer(e,t=!1,i){let r=this._currentRenderTarget;this._currentRenderTarget=null,i&&i(),this._currentRenderTarget=r,this._endCurrentRenderPass(),e.texture?.generateMipMaps&&!t&&!e.isCube&&this._generateMipmaps(e.texture),this._currentRenderTarget=null,this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&F.Log("frame #"+this._count+" - unBindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId=",e.texture?.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._currentRenderPass||this._startMainRenderPass(!1),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(e){let t=e.colorAttachmentGPUTextures[0]?.format??null;this._cacheRenderPipeline.setColorFormat(t),this._colorFormat!==t&&(this._colorFormat=t)}_setDepthTextureFormat(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}_executeWhenRenderingStateIsCompiled(e,t){t()}bindSamplers(){}_getUnpackAlignement(){return 1}_bindTextureDirectly(){return!1}setState(e,t=0,i,r=!1,n,o,a=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);let l=this.cullBackFaces??n??!0?1:2;(this._depthCullingState.cullFace!==l||i)&&(this._depthCullingState.cullFace=l),this.setZOffset(t),this.setZOffsetUnits(a);let c=r?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==c||i)&&(this._depthCullingState.frontFace=c),this._stencilStateComposer.stencilMaterial=o}_applyRenderPassChanges(e){let t=this._stencilStateComposer.enabled?this._mustUpdateStencilRef():!1,i=this._alphaState.alphaBlend?this._mustUpdateBlendColor():!1;this._mustUpdateViewport()&&this._applyViewport(e),this._mustUpdateScissor()&&this._applyScissor(e),t&&this._applyStencilRef(e),i&&this._applyBlendColor(e)}_draw(e,t,i,r,n){let o=this._getCurrentRenderPass(),a=this._bundleList;this.applyStates();let l=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,Li.InternalsUBOName),l.uniformBuffer&&(l.uniformBuffer.update(),this.bindUniformBufferBase(l.uniformBuffer.getBuffer(),0,Li.LeftOvertUBOName)),this._snapshotRendering.play){this._reportDrawCall();return}!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);let c=!this.compatibilityMode&&this._currentDrawContext.fastBundle,h=o;if(c||this._snapshotRendering.record){if(this._applyRenderPassChanges(a),!this._snapshotRendering.record){this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(r,n||1,i),a.addBundle(this._currentDrawContext.fastBundle),this._reportDrawCall();return}h=a.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),a.numDrawCalls++}let u=0;if(this._currentMaterialContext.hasFloatOrDepthTextures){let _=1;for(let x=0;x<l.shaderProcessingContext.textureNames.length;++x){let b=l.shaderProcessingContext.textureNames[x],C=this._currentMaterialContext.textures[b]?.texture,R=C&&C.format>=13&&C.format<=18;(C?.type===1&&!this._caps.textureFloatLinearFiltering||R)&&(u|=_),_=_<<1}}this._currentMaterialContext.textureState=u;let d=this._cacheRenderPipeline.getRenderPipeline(t,this._currentEffect,this.currentSampleCount,u),f=this._cacheBindGroups.getBindGroups(l,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(this.compatibilityMode?null:a),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,h=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:ut.GetSample(this.currentSampleCount)}))),h.setPipeline(d),this._currentIndexBuffer&&h.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?ga.Uint32:ga.Uint16,0);let m=this._cacheRenderPipeline.vertexBuffers;for(let _=0;_<m.length;_++){let x=m[_],b=x.effectiveBuffer;b&&h.setVertexBuffer(_,b.underlyingResource,x._validOffsetRange?0:x.byteOffset)}for(let _=0;_<f.length;_++)h.setBindGroup(_,f[_]);let g=!this.compatibilityMode&&!this._snapshotRendering.record;g&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(r,n||1,i),e===0?h.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):h.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):e===0?h.drawIndexed(r,n||1,i,0,0):h.draw(r,n||1,i,0),g&&(this._currentDrawContext.fastBundle=h.finish(),a.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(e,t,i,r=1){this._draw(0,e,t,i,r)}drawArraysType(e,t,i,r=1){this._currentIndexBuffer=null,this._draw(1,e,t,i,r)}dispose(){this._isDisposed=!0,this.hideLoadingUI(),this._timestampQuery.dispose(),this._mainTexture?.destroy(),this._depthTexture?.destroy(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._device.destroy(),Fx(this,this._renderingCanvas),super.dispose()}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._renderingCanvas?.width??0}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._renderingCanvas?.height??0}getError(){return 0}createExternalTexture(e){return new fT(e)}setExternalTexture(e,t){if(!t){this._currentMaterialContext.setTexture(e,null);return}this._setInternalTexture(e,t)}setTextureSampler(e,t){this._currentMaterialContext?.setSampler(e,t)}createStorageBuffer(e,t,i){return this._createBuffer(e,t|32,i)}updateStorageBuffer(e,t,i,r){let n=e;i===void 0&&(i=0);let o;r===void 0?(t instanceof Array?o=new Float32Array(t):t instanceof ArrayBuffer?o=new Uint8Array(t):o=t,r=o.byteLength):t instanceof Array?o=new Float32Array(t):t instanceof ArrayBuffer?o=new Uint8Array(t):o=t,this._bufferManager.setSubData(n,i,o,0,r)}readFromStorageBuffer(e,t,i,r,n){i=i||e.capacity;let o=this._bufferManager.createRawBuffer(i,kt.MapRead|kt.CopyDst,void 0,"TempReadFromStorageBuffer");return this._renderEncoder.copyBufferToBuffer(e.underlyingResource,t??0,o,0,i),new Promise((a,l)=>{let c=()=>{o.mapAsync(rl.Read,0,i).then(()=>{let h=o.getMappedRange(0,i),u=r;if(u===void 0)u=new Uint8Array(i),u.set(new Uint8Array(h));else{let d=u.constructor;u=new d(u.buffer),u.set(new d(h))}o.unmap(),this._bufferManager.releaseBuffer(o),a(u)},h=>{this.isDisposed?a(new Uint8Array):l(h)})};n?(this.flushFramebuffer(),c()):this.onEndFrameObservable.addOnce(()=>{c()})})}setStorageBuffer(e,t){this._currentDrawContext?.setBuffer(e,t?.getBuffer()??null)}};Ge._GLSLslangDefaultOptions={jsPath:`${H._DefaultCdnUrl}/glslang/glslang.js`,wasmPath:`${H._DefaultCdnUrl}/glslang/glslang.wasm`};Ge._InstanceId=0;Ge.UseTWGSL=!0;Ge.prototype.setAlphaMode=function(s,e=!1){if(this._alphaMode===s&&(s===0&&!this._alphaState.alphaBlend||s!==0&&this._alphaState.alphaBlend)){if(!e){let t=s===0;this.depthCullingState.depthMask!==t&&(this.setDepthWrite(t),this._cacheRenderPipeline.setDepthWriteEnabled(t))}return}switch(s){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,1),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(772,1,0,0),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(775,769,773,771),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,0),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(775,769,0,1),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,771),this._alphaState.alphaBlend=!0;break}e||(this.setDepthWrite(s===0),this._cacheRenderPipeline.setDepthWriteEnabled(s===0)),this._alphaMode=s,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};Ge.prototype.setAlphaEquation=function(s){Se.prototype.setAlphaEquation.call(this,s),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};var vV=(()=>{class s{getBindGroups(t,i,r){if(!r)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(this._bindGroups.length===0){let n=this._bindGroupEntries.length>0;for(let o in t){let a=t[o],l=r[o],c=l.group,h=l.binding,u=a.type,d=a.object,f=a.indexInGroupEntries,m=this._bindGroupEntries[c];switch(m||(m=this._bindGroupEntries[c]=[]),u){case sn.Sampler:{let g=d;f!==void 0&&n?m[f].resource=this._cacheSampler.getSampler(g):(a.indexInGroupEntries=m.length,m.push({binding:h,resource:this._cacheSampler.getSampler(g)}));break}case sn.Texture:case sn.TextureWithoutSampler:{let g=d,_=g._texture._hardwareTexture;f!==void 0&&n?(u===sn.Texture&&(m[f++].resource=this._cacheSampler.getSampler(g._texture)),m[f].resource=_.view):(a.indexInGroupEntries=m.length,u===sn.Texture&&m.push({binding:h-1,resource:this._cacheSampler.getSampler(g._texture)}),m.push({binding:h,resource:_.view}));break}case sn.StorageTexture:{let g=d,_=g._texture._hardwareTexture;_.textureAdditionalUsages&pi.StorageBinding||F.Error(`computeDispatch: The texture (name=${g.name}, uniqueId=${g.uniqueId}) is not a storage texture!`,50),f!==void 0&&n?m[f].resource=_.viewForWriting:(a.indexInGroupEntries=m.length,m.push({binding:h,resource:_.viewForWriting}));break}case sn.ExternalTexture:{let _=d.underlyingResource;f!==void 0&&n?m[f].resource=this._device.importExternalTexture({source:_}):(a.indexInGroupEntries=m.length,m.push({binding:h,resource:this._device.importExternalTexture({source:_})}));break}case sn.UniformBuffer:case sn.StorageBuffer:case sn.DataBuffer:{let g=u===sn.DataBuffer?d:(u===sn.UniformBuffer,d.getBuffer()),_=g.underlyingResource;f!==void 0&&n?(m[f].resource.buffer=_,m[f].resource.size=g.capacity):(a.indexInGroupEntries=m.length,m.push({binding:h,resource:{buffer:_,offset:0,size:g.capacity}}));break}}}for(let o=0;o<this._bindGroupEntries.length;++o){let a=this._bindGroupEntries[o];if(!a){this._bindGroups[o]=void 0;continue}this._bindGroups[o]=this._device.createBindGroup({layout:i.getBindGroupLayout(o),entries:a})}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(t,i){this._device=t,this._cacheSampler=i,this.uniqueId=s._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}return s._Counter=0,s})();var pT=class{get isAsync(){return!1}get isReady(){return this.isAsync,!1}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){return this.sources?.compute}dispose(){}};var TV={};Ge.prototype.createComputeContext=function(){return new vV(this._device,this._cacheSampler)};Ge.prototype.createComputeEffect=function(s,e){let i=(typeof s=="string"?s:s.computeToken||s.computeSource||s.computeElement||s.compute)+"@"+e.defines;if(this._compiledComputeEffects[i]){let n=this._compiledComputeEffects[i];return e.onCompiled&&n.isReady()&&e.onCompiled(n),n}let r=new fB(s,e,this,i);return this._compiledComputeEffects[i]=r,r};Ge.prototype.createComputePipelineContext=function(){return new pT(this)};Ge.prototype.areAllComputeEffectsReady=function(){for(let s in this._compiledComputeEffects)if(!this._compiledComputeEffects[s].isReady())return!1;return!0};Ge.prototype.computeDispatch=function(s,e,t,i,r=1,n=1,o,a){this._computeDispatch(s,e,t,i,r,n,void 0,void 0,o,a)};Ge.prototype.computeDispatchIndirect=function(s,e,t,i,r=0,n,o){this._computeDispatch(s,e,t,void 0,void 0,void 0,i,r,n,o)};Ge.prototype._computeDispatch=function(s,e,t,i,r,n,o,a,l,c){this._endCurrentRenderPass();let h=s._pipelineContext,u=e;h.computePipeline||(h.computePipeline=this._device.createComputePipeline({layout:Dd.Auto,compute:h.stage})),c&&this._timestampQuery.startPass(TV,this._timestampIndex);let d=this._renderEncoder.beginComputePass(TV);d.setPipeline(h.computePipeline);let f=u.getBindGroups(t,h.computePipeline,l);for(let m=0;m<f.length;++m){let g=f[m];g&&d.setBindGroup(m,g)}o!==void 0?d.dispatchWorkgroupsIndirect(o.underlyingResource,a):i+r+n>0&&d.dispatchWorkgroups(i,r,n),d.end(),c&&(this._timestampQuery.endPass(this._timestampIndex,c),this._timestampIndex+=2)};Ge.prototype.releaseComputeEffects=function(){for(let s in this._compiledComputeEffects){let e=this._compiledComputeEffects[s].getPipelineContext();this._deleteComputePipelineContext(e)}this._compiledComputeEffects={}};Ge.prototype._prepareComputePipelineContext=function(s,e,t,i,r){let n=s;this.dbgShowShaderCode&&(F.Log(i),F.Log(e)),n.sources={compute:e,rawCompute:t},n.stage=this._createComputePipelineStageDescriptor(e,i,r)};Ge.prototype._releaseComputeEffect=function(s){this._compiledComputeEffects[s._key]&&(delete this._compiledComputeEffects[s._key],this._deleteComputePipelineContext(s.getPipelineContext()))};Ge.prototype._rebuildComputeEffects=function(){for(let s in this._compiledComputeEffects){let e=this._compiledComputeEffects[s];e._pipelineContext=null,e._wasPreviouslyReady=!1,e._prepareEffect()}};Ge.prototype._executeWhenComputeStateIsCompiled=function(s,e){s.stage.module.getCompilationInfo().then(t=>{let i={numErrors:0,messages:[]};for(let r of t.messages)r.type==="error"&&i.numErrors++,i.messages.push({type:r.type,text:r.message,line:r.lineNum,column:r.linePos,length:r.length,offset:r.offset});e(i)})};Ge.prototype._deleteComputePipelineContext=function(s){s&&s.dispose()};Ge.prototype._createComputePipelineStageDescriptor=function(s,e,t){return e?e="//"+e.split(`
`).join(`
//`)+`
`:e="",{module:this._device.createShaderModule({code:e+s}),entryPoint:t}};Ge.prototype._createDepthStencilCubeTexture=function(s,e){let t=new Je(this,e.generateStencil?ke.DepthStencil:ke.Depth);t.isCube=!0,t.label=e.label;let i=ie({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14},e);t.format=i.depthTextureFormat,this._setupDepthStencilTexture(t,s,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t);let r=t._hardwareTexture;return t.type=ut.GetTextureTypeFromFormat(r.format),this._internalTexturesCache.push(t),t};Ge.prototype.createCubeTexture=function(s,e,t,i,r=null,n=null,o,a=null,l=!1,c=0,h=0,u=null,d,f=!1,m=null){return this.createCubeTextureBase(s,e,t,!!i,r,n,o,a,l,c,h,u,null,(g,_)=>{let x=_,b=x[0].width,C=b;this._setCubeMapTextureParams(g,!i),g.format=o??-1;let R=this._textureHelper.createGPUTextureForInternalTexture(g,b,C);this._textureHelper.updateCubeTextures(x,R.underlyingResource,b,C,R.format,!1,!1,0,0),i||this._generateMipmaps(g,this._uploadEncoder),g.isReady=!0,g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear(),r&&r()},!!f,m)};Ge.prototype._setCubeMapTextureParams=function(s,e,t){s.samplingMode=e?3:2,s._cachedWrapU=0,s._cachedWrapV=0,t&&(s._maxLodLevel=t)};Ge.prototype.generateMipMapsForCubemap=function(s){s.generateMipMaps&&(s._hardwareTexture?.underlyingResource||this._textureHelper.createGPUTextureForInternalTexture(s),this._generateMipmaps(s))};Ge.prototype._debugPushGroup=function(s,e){this._options.enableGPUDebugMarkers&&(e===0||e===1?this._renderEncoder.pushDebugGroup(s):this._currentRenderPass?this._currentRenderPass.pushDebugGroup(s):this._pendingDebugCommands.push(["push",s]))};Ge.prototype._debugPopGroup=function(s){this._options.enableGPUDebugMarkers&&(s===0||s===1?this._renderEncoder.popDebugGroup():this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null]))};Ge.prototype._debugInsertMarker=function(s,e){this._options.enableGPUDebugMarkers&&(e===0||e===1?this._renderEncoder.insertDebugMarker(s):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(s):this._pendingDebugCommands.push(["insert",s]))};Ge.prototype._debugFlushPendingCommands=function(){for(let s=0;s<this._pendingDebugCommands.length;++s){let[e,t]=this._pendingDebugCommands[s];switch(e){case"push":this._debugPushGroup(t);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(t);break}}this._pendingDebugCommands.length=0};Ge.prototype.createDynamicTexture=function(s,e,t,i){let r=new Je(this,ke.Dynamic);return r.baseWidth=s,r.baseHeight=e,t&&(s=this.needPOTTextures?Rr(s,this._caps.maxTextureSize):s,e=this.needPOTTextures?Rr(e,this._caps.maxTextureSize):e),r.width=s,r.height=e,r.isReady=!1,r.generateMipMaps=t,r.samplingMode=i,this.updateTextureSamplingMode(i,r),this._internalTexturesCache.push(r),s&&e&&this._textureHelper.createGPUTextureForInternalTexture(r,s,e),r};Ge.prototype.updateDynamicTexture=function(s,e,t,i=!1,r,n,o){if(!s)return;let a=e.width,l=e.height,c=s._hardwareTexture;s._hardwareTexture?.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(s,a,l)),this._textureHelper.updateTexture(e,s,a,l,s.depth,c.format,0,0,t,i,0,0,o),s.generateMipMaps&&this._generateMipmaps(s),s._dynamicTextureSource=e,s._premulAlpha=i,s.invertY=t||!1,s.isReady=!0};Ge.prototype.unBindMultiColorAttachmentFramebuffer=function(s,e=!1,t){t&&t();let r=s._attachments.length;this._endCurrentRenderPass();for(let n=0;n<r;n++){let o=s.textures[n];o.generateMipMaps&&!e&&!o.isCube&&!o.is3D&&this._generateMipmaps(o)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)};Ge.prototype.createMultipleRenderTarget=function(s,e,t){let i=!1,r=!0,n=!1,o=!1,a=15,l=1,c=0,h=3,u=!1,d=5,f=3553,m=[],g=[],_=[],x=[],b=[],C=[],R=[],E=[],S=[],A=this._createHardwareRenderTargetWrapper(!0,!1,s);e!==void 0&&(i=e.generateMipMaps===void 0?!1:e.generateMipMaps,r=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,n=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,o=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,l=e.textureCount||1,a=e.depthTextureFormat??15,e.types&&(m=e.types),e.samplingModes&&(g=e.samplingModes),e.useSRGBBuffers&&(_=e.useSRGBBuffers),e.formats&&(x=e.formats),e.targetTypes&&(b=e.targetTypes),e.faceIndex&&(C=e.faceIndex),e.layerIndex&&(R=e.layerIndex),e.layerCounts&&(E=e.layerCounts),S=e.labels??S),A.label=e?.label??"MultiRenderTargetWrapper";let L=s.width||s,G=s.height||s,W=null;(r||n||o)&&(o||(r&&n?a=13:r?a=14:a=19),W=A.createDepthStencilTexture(0,!1,n,1,a,"MultipleRenderTargetDepthStencil"));let $=[],re=[],we=[];A._generateDepthBuffer=r,A._generateStencilBuffer=n,A._attachments=re,A._defaultAttachments=we;for(let _e=0;_e<l;_e++){let ce=g[_e]||h,ne=m[_e]||c,Fe=x[_e]||d,Oe=(_[_e]||u)&&this._caps.supportSRGBBuffers,he=b[_e]||f,ee=E[_e]??1;if((ne===1&&!this._caps.textureFloatLinearFiltering||ne===2&&!this._caps.textureHalfFloatLinearFiltering)&&(ce=1),ne===1&&!this._caps.textureFloat&&(ne=0,F.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),re.push(_e+1),we.push(t?_e+1:_e===0?1:0),he===-1)continue;let V=new Je(this,ke.MultiRenderTarget);switch($[_e]=V,he){case 34067:V.isCube=!0;break;case 32879:V.is3D=!0,V.baseDepth=V.depth=ee;break;case 35866:V.is2DArray=!0,V.baseDepth=V.depth=ee;break}V.baseWidth=L,V.baseHeight=G,V.width=L,V.height=G,V.isReady=!0,V.samples=1,V.generateMipMaps=i,V.samplingMode=ce,V.type=ne,V._cachedWrapU=0,V._cachedWrapV=0,V._useSRGBBuffer=Oe,V.format=Fe,V.label=S[_e],this._internalTexturesCache.push(V),this._textureHelper.createGPUTextureForInternalTexture(V)}return W&&(W.incrementReferences(),$[l]=W,this._internalTexturesCache.push(W)),A.setTextures($),A.setLayerAndFaceIndices(R,C),A};Ge.prototype.updateMultipleRenderTargetTextureSampleCount=function(s,e){if(!s||!s.textures||s.textures[0].samples===e)return e;let t=s.textures.length;if(t===0)return 1;e=Math.min(e,this.getCaps().maxMSAASamples);for(let r=0;r<t;++r)s.textures[r]._hardwareTexture?.releaseMSAATexture();let i=s._depthStencilTexture===s.textures[t-1];for(let r=0;r<t;++r){let n=s.textures[r];this._textureHelper.createMSAATexture(n,e,!1,r===t-1&&i?0:r),n.samples=e}return s._depthStencilTexture&&!i&&(this._textureHelper.createMSAATexture(s._depthStencilTexture,e),s._depthStencilTexture.samples=e),e};Ge.prototype.bindAttachments=function(s){s.length===0||!this._currentRenderTarget||(this._mrtAttachments=s,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(s))};Ge.prototype.buildTextureLayout=function(s){let e=[];for(let t=0;t<s.length;t++)s[t]?e.push(t+1):e.push(0);return e};Ge.prototype.restoreSingleAttachment=function(){};Ge.prototype.restoreSingleAttachmentForRenderTarget=function(){};Ge.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter};Ge.prototype.captureGPUFrameTime=function(s){this._timestampQuery.enable=s&&!!this._caps.timerQuery};Ge.prototype.createQuery=function(){return this._occlusionQuery.createQuery()};Ge.prototype.deleteQuery=function(s){return this._occlusionQuery.deleteQuery(s),this};Ge.prototype.isQueryResultAvailable=function(s){return this._occlusionQuery.isQueryResultAvailable(s)};Ge.prototype.getQueryResult=function(s){return this._occlusionQuery.getQueryResult(s)};Ge.prototype.beginOcclusionQuery=function(s,e){if(this.compatibilityMode){if(this._occlusionQuery.canBeginQuery(e))return this._currentRenderPass?.beginOcclusionQuery(e),!0}else return this._bundleList.addItem(new aT(e)),!0;return!1};Ge.prototype.endOcclusionQuery=function(){return this.compatibilityMode?this._currentRenderPass?.endOcclusionQuery():this._bundleList.addItem(new lT),this};Ge.prototype.createRawTexture=function(s,e,t,i,r,n,o,a=null,l=0,c=0,h=!1){let u=new Je(this,ke.Raw);return u.baseWidth=e,u.baseHeight=t,u.width=e,u.height=t,u.format=i,u.generateMipMaps=r,u.samplingMode=o,u.invertY=n,u._compression=a,u.type=l,u._creationFlags=c,u._useSRGBBuffer=h,this._doNotHandleContextLost||(u._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(u,e,t,void 0,c),this.updateRawTexture(u,s,i,n,a,l,h),this._internalTexturesCache.push(u),u};Ge.prototype.updateRawTexture=function(s,e,t,i,r=null,n=0,o=!1){if(s){if(this._doNotHandleContextLost||(s._bufferView=e,s.invertY=i,s._compression=r,s._useSRGBBuffer=o),e){let a=s._hardwareTexture;t===4&&(e=Im(e,s.width,s.height,n));let c=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(c,s,s.width,s.height,s.depth,a.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0}};Ge.prototype.createRawCubeTexture=function(s,e,t,i,r,n,o,a=null){let l=new Je(this,ke.CubeRaw);if(i===1&&!this._caps.textureFloatLinearFiltering?(r=!1,o=1,F.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===2&&!this._caps.textureHalfFloatLinearFiltering?(r=!1,o=1,F.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===1&&!this._caps.textureFloatRender?(r=!1,F.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):i===2&&!this._caps.colorBufferFloat&&(r=!1,F.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")),l.isCube=!0,l._originalFormat=t,l.format=t===4?5:t,l.type=i,l.generateMipMaps=r,l.width=e,l.height=e,l.samplingMode=o,this._doNotHandleContextLost||(l._bufferViewArray=s),l.invertY=n,l._compression=a,l._cachedWrapU=0,l._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(l),t===4){let c=l._hardwareTexture;c._originalFormatIsRGB=!0}return s&&this.updateRawCubeTexture(l,s,t,i,n,a),l.isReady=!0,l};Ge.prototype.updateRawCubeTexture=function(s,e,t,i,r,n=null){s._bufferViewArray=e,s.invertY=r,s._compression=n;let o=s._hardwareTexture,a=o._originalFormatIsRGB,l=[0,2,4,1,3,5],c=[];for(let h=0;h<e.length;++h){let u=e[l[h]];a&&(u=Im(u,s.width,s.height,i)),c.push(new Uint8Array(u.buffer,u.byteOffset,u.byteLength))}this._textureHelper.updateCubeTextures(c,o.underlyingResource,s.width,s.height,o.format,r,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder),s.isReady=!0};Ge.prototype.createRawCubeTextureFromUrl=function(s,e,t,i,r,n,o,a,l=null,c=null,h=3,u=!1){let d=this.createRawCubeTexture(null,t,i,r,!n,u,h,null);e?.addPendingData(d),d.url=s,this._internalTexturesCache.push(d);let f=(g,_)=>{e?.removePendingData(d),c&&g&&c(g.status+" "+g.statusText,_)},m=g=>{let _=d.width,x=o(g);if(x){if(a){let b=i===4,C=a(x),R=d._hardwareTexture,E=[0,1,2,3,4,5];for(let S=0;S<C.length;S++){let A=_>>S,L=[];for(let G=0;G<6;G++){let W=C[S][E[G]];b&&(W=Im(W,A,A,r)),L.push(new Uint8Array(W.buffer,W.byteOffset,W.byteLength))}this._textureHelper.updateCubeTextures(L,R.underlyingResource,A,A,R.format,u,!1,0,0)}}else this.updateRawCubeTexture(d,x,i,r,u);d.isReady=!0,e?.removePendingData(d),l&&l()}};return this._loadFile(s,g=>{m(g)},void 0,e?.offlineProvider,!0,f),d};Ge.prototype.createRawTexture3D=function(s,e,t,i,r,n,o,a,l=null,c=0,h=0){let u=ke.Raw3D,d=new Je(this,u);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=r,d.type=c,d.generateMipMaps=n,d.samplingMode=a,d.is3D=!0,d._creationFlags=h,this._doNotHandleContextLost||(d._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,void 0,h),this.updateRawTexture3D(d,s,r,o,l,c),this._internalTexturesCache.push(d),d};Ge.prototype.updateRawTexture3D=function(s,e,t,i,r=null,n=0){if(this._doNotHandleContextLost||(s._bufferView=e,s.format=t,s.invertY=i,s._compression=r),e){let o=s._hardwareTexture;t===4&&(e=Im(e,s.width,s.height,n));let l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,s,s.width,s.height,s.depth,o.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0};Ge.prototype.createRawTexture2DArray=function(s,e,t,i,r,n,o,a,l=null,c=0,h=0){let u=ke.Raw2DArray,d=new Je(this,u);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=r,d.type=c,d.generateMipMaps=n,d.samplingMode=a,d.is2DArray=!0,d._creationFlags=h,this._doNotHandleContextLost||(d._bufferView=s),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,i,h),this.updateRawTexture2DArray(d,s,r,o,l,c),this._internalTexturesCache.push(d),d};Ge.prototype.updateRawTexture2DArray=function(s,e,t,i,r=null,n=0){if(this._doNotHandleContextLost||(s._bufferView=e,s.format=t,s.invertY=i,s._compression=r),e){let o=s._hardwareTexture;t===4&&(e=Im(e,s.width,s.height,n));let l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,s,s.width,s.height,s.depth,o.format,0,0,i,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s,this._uploadEncoder)}s.isReady=!0};function Im(s,e,t,i){let r,n=1;i===1?r=new Float32Array(e*t*4):i===2?(r=new Uint16Array(e*t*4),n=15360):i===7?r=new Uint32Array(e*t*4):r=new Uint8Array(e*t*4);for(let o=0;o<e;o++)for(let a=0;a<t;a++){let l=(a*e+o)*3,c=(a*e+o)*4;r[c+0]=s[l+0],r[c+1]=s[l+1],r[c+2]=s[l+2],r[c+3]=n}return r}Ge.prototype._readTexturePixels=function(s,e,t,i=-1,r=0,n=null,o=!0,a=!1,l=0,c=0){let h=s._hardwareTexture;return o&&this.flushFramebuffer(),this._textureHelper.readPixels(h.underlyingResource,l,c,e,t,h.format,i,r,n,a)};Ge.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};var mT=class extends Qa{constructor(e,t,i,r,n){super(e,t,i,r,n),r.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new Ig)}};Ge.prototype._createHardwareRenderTargetWrapper=function(s,e,t){let i=new mT(s,e,t,this);return this._renderTargetWrapperCache.push(i),i};Ge.prototype.createRenderTargetTexture=function(s,e){let t=this._createHardwareRenderTargetWrapper(!1,!1,s),i={};e!==void 0&&typeof e=="object"?(i.generateMipMaps=e.generateMipMaps,i.generateDepthBuffer=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,i.generateStencilBuffer=i.generateDepthBuffer&&e.generateStencilBuffer,i.samplingMode=e.samplingMode===void 0?3:e.samplingMode,i.creationFlags=e.creationFlags??0,i.noColorAttachment=!!e.noColorAttachment,i.samples=e.samples,i.label=e.label):(i.generateMipMaps=e,i.generateDepthBuffer=!0,i.generateStencilBuffer=!1,i.samplingMode=3,i.creationFlags=0,i.noColorAttachment=!1);let r=i.noColorAttachment?null:this._createInternalTexture(s,e,!0,ke.RenderTarget);return t.label=i.label??"RenderTargetWrapper",t._samples=i.samples??1,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=!!i.generateStencilBuffer,t.setTextures(r),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,!1,t._generateStencilBuffer,t.samples,i.generateStencilBuffer?13:14,i.label?i.label+"-DepthStencil":void 0),r&&(e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r,void 0,void 0,void 0,i.creationFlags),e!==void 0&&typeof e=="object"&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!1)),t};Ge.prototype._createDepthStencilTexture=function(s,e){let t=new Je(this,e.generateStencil?ke.DepthStencil:ke.Depth);t.label=e.label;let i=ie({bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14},e);t.format=i.depthTextureFormat,this._setupDepthStencilTexture(t,s,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t);let r=t._hardwareTexture;return t.type=ut.GetTextureTypeFromFormat(r.format),this._internalTexturesCache.push(t),t};Ge.prototype._setupDepthStencilTexture=function(s,e,t,i,r,n=1){let o=e.width||e,a=e.height||e,l=e.layers||0,c=e.depth||0;s.baseWidth=o,s.baseHeight=a,s.width=o,s.height=a,s.is2DArray=l>0,s.is3D=c>0,s.depth=l||c,s.isReady=!0,s.samples=n,s.generateMipMaps=!1,s.samplingMode=i?2:1,s.type=1,s._comparisonFunction=r,s._cachedWrapU=0,s._cachedWrapV=0};Ge.prototype.updateRenderTargetTextureSampleCount=function(s,e){return!s||!s.texture||s.samples===e||(e=Math.min(e,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(s.texture,e),s._depthStencilTexture&&(this._textureHelper.createMSAATexture(s._depthStencilTexture,e),s._depthStencilTexture.samples=e),s._samples=e,s.texture.samples=e),e};Ge.prototype.createRenderTargetCubeTexture=function(s,e){let t=this._createHardwareRenderTargetWrapper(!1,!0,s),i=ie({generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1},e);i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,t.label=i.label??"RenderTargetWrapper",t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer;let r=new Je(this,ke.RenderTarget);return r.width=s,r.height=s,r.depth=0,r.isReady=!0,r.isCube=!0,r.samples=i.samples,r.generateMipMaps=i.generateMipMaps,r.samplingMode=i.samplingMode,r.type=i.type,r.format=i.format,this._internalTexturesCache.push(r),t.setTextures(r),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,i.samplingMode===void 0||i.samplingMode===2||i.samplingMode===2||i.samplingMode===3||i.samplingMode===3||i.samplingMode===5||i.samplingMode===6||i.samplingMode===7||i.samplingMode===11,t._generateStencilBuffer,t.samples),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r),e&&e.createMipMaps&&!i.generateMipMaps&&(r.generateMipMaps=!1),t};Ge.prototype.setDepthStencilTexture=function(s,e,t,i){!t||!t.depthStencilTexture?this._setTexture(s,null,void 0,void 0,i):this._setTexture(s,t,!1,!0,i)};function Ij(s){return!!(s&&s.underlyingResource!==void 0)}Ge.prototype.updateVideoTexture=function(s,e,t){if(!s||s._isDisabled)return;this._videoTextureSupported===void 0&&(this._videoTextureSupported=!0);let i=s._hardwareTexture;if(s._hardwareTexture?.underlyingResource||(i=this._textureHelper.createGPUTextureForInternalTexture(s)),Ij(e)){if(e.isReady()){try{this._textureHelper.copyVideoToTexture(e,s,i.format,!t),s.generateMipMaps&&this._generateMipmaps(s)}catch{}s.isReady=!0}}else e&&this.createImageBitmap(e).then(r=>{this._textureHelper.updateTexture(r,s,s.width,s.height,s.depth,i.format,0,0,!t,!1,0,0),s.generateMipMaps&&this._generateMipmaps(s),s.isReady=!0}).catch(()=>{s.isReady=!0})};var Ld=class s extends Bs{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}set rotationColor(e){this._rotationShaderMaterial.setColor3("rotationColor",e)}get disableMaterial(){return this._disableMaterial}constructor(e,t=X.Gray(),i=ji.DefaultUtilityLayer,r=32,n=null,o=!1,a=1,l=X.Yellow(),c=X.Gray()){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new U,this.angle=0,this.sensitivity=1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._angles=new p,this._parent=n,this._coloredMaterial=new Ee("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new X(.1,.1,.1)),this._hoverMaterial=new Ee("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=l,this._hoverMaterial.specularColor=l,this._disableMaterial=new Ee("",i.utilityLayerScene),this._disableMaterial.diffuseColor=c,this._disableMaterial.alpha=.4,this._gizmoMesh=new k("",i.utilityLayerScene);let{rotationMesh:h,collider:u}=this._createGizmoMesh(this._gizmoMesh,a,r);this._rotationDisplayPlane=Yn("rotationDisplay",{size:.6,updatable:!1},this.gizmoLayer.utilityLayerScene),this._rotationDisplayPlane.rotation.z=Math.PI*.5,this._rotationDisplayPlane.parent=this._gizmoMesh,this._rotationDisplayPlane.setEnabled(!1),$t.ShadersStore.rotationGizmoVertexShader=s._RotationGizmoVertexShader,$t.ShadersStore.rotationGizmoFragmentShader=s._RotationGizmoFragmentShader,this._rotationShaderMaterial=new Fi("shader",this.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles","rotationColor"]}),this._rotationShaderMaterial.backFaceCulling=!1,this.rotationColor=l,this._rotationDisplayPlane.material=this._rotationShaderMaterial,this._rotationDisplayPlane.visibility=.999,this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,Bs.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3),this.dragBehavior=new qc({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.maxDragAngle=s.MaxDragAngle,this.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,this._rootMesh.addBehavior(this.dragBehavior);let d=new p,f=new N,m=new p,g=new p;this.dragBehavior.onDragStartObservable.add(S=>{this.attachedNode&&(d.copyFrom(S.dragPlanePoint),this._rotationDisplayPlane.setEnabled(!0),this._rotationDisplayPlane.getWorldMatrix().invertToRef(f),p.TransformCoordinatesToRef(S.dragPlanePoint,f,d),this._angles.x=Math.atan2(d.y,d.x)+Math.PI,this._angles.y=0,this._angles.z=this.updateGizmoRotationToMatchAttachedMesh?1:0,this._dragging=!0,d.copyFrom(S.dragPlanePoint),this._rotationShaderMaterial.setVector3("angles",this._angles),this.angle=0)}),this.dragBehavior.onDragEndObservable.add(()=>{this._dragging=!1,this._rotationDisplayPlane.setEnabled(!1)});let _={snapDistance:0},x=0,b=new N,C=new q;this.dragBehavior.onDragObservable.add(S=>{if(this.attachedNode){let A=new p(1,1,1),L=new q(0,0,0,1),G=new p(0,0,0);if(this.attachedNode.getWorldMatrix().decompose(A,L,G),!(Math.abs(Math.abs(A.x)-Math.abs(A.y))<=je&&Math.abs(Math.abs(A.x)-Math.abs(A.z))<=je)&&this.updateGizmoRotationToMatchAttachedMesh){F.Warn("Unable to use a rotation gizmo matching mesh rotation with non uniform scaling. Use uniform scaling or set updateGizmoRotationToMatchAttachedMesh to false.");return}L.normalize();let $=this.updateGizmoPositionToMatchAttachedMesh?G:this._rootMesh.absolutePosition,re=S.dragPlanePoint.subtract($).normalize(),we=d.subtract($).normalize(),_e=p.Cross(re,we),ce=p.Dot(re,we),ne=Math.atan2(_e.length(),ce)*this.sensitivity;m.copyFrom(e),g.copyFrom(e),this.updateGizmoRotationToMatchAttachedMesh&&(L.toRotationMatrix(f),g=p.TransformCoordinates(m,f));let Fe=!1;if(i.utilityLayerScene.activeCamera){let V=i.utilityLayerScene.activeCamera.position.subtract($).normalize();p.Dot(V,g)>0&&(m.scaleInPlace(-1),g.scaleInPlace(-1),Fe=!0)}p.Dot(g,_e)>0&&(ne=-ne),O.Vector3[0].set(ne,0,0),this.dragBehavior.validateDrag(O.Vector3[0])||(ne=0);let he=!1;if(this.snapDistance!=0)if(x+=ne,Math.abs(x)>this.snapDistance){let V=Math.floor(Math.abs(x)/this.snapDistance);x<0&&(V*=-1),x=x%this.snapDistance,ne=this.snapDistance*V,he=!0}else ne=0;let ee=Math.sin(ne/2);if(C.set(m.x*ee,m.y*ee,m.z*ee,Math.cos(ne/2)),b.determinant()>0){let V=new p;C.toEulerAnglesToRef(V),q.RotationYawPitchRollToRef(V.y,-V.x,-V.z,C)}if(this.updateGizmoRotationToMatchAttachedMesh)L.multiplyToRef(C,L),L.normalize(),N.ComposeToRef(A,L,G,this.attachedNode.getWorldMatrix());else{C.toRotationMatrix(O.Matrix[0]);let V=this.attachedNode.getWorldMatrix().getTranslation();this.attachedNode.getWorldMatrix().multiplyToRef(O.Matrix[0],this.attachedNode.getWorldMatrix()),this.attachedNode.getWorldMatrix().setTranslation(V)}d.copyFrom(S.dragPlanePoint),he&&(_.snapDistance=ne,this.onSnapObservable.notifyObservers(_)),this._angles.y+=ne,this.angle+=Fe?-ne:ne,this._rotationShaderMaterial.setVector3("angles",this._angles),this._matrixChanged()}});let R=i._getSharedGizmoLight();R.includedOnlyMeshes=R.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));let E={colliderMeshes:[u],gizmoMeshes:[h],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,E),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add(S=>{if(!this._customMeshSet&&(this.dragBehavior.maxDragAngle=s.MaxDragAngle,this._isHovered=E.colliderMeshes.indexOf(S?.pickInfo?.pickedMesh)!=-1,!this._parent)){let A=E.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(E.gizmoMeshes,A)}}),this.dragBehavior.onEnabledObservable.add(S=>{this._setGizmoMeshMaterial(E.gizmoMeshes,S?this._coloredMaterial:this._disableMaterial)})}_createGizmoMesh(e,t,i){let r=vn("ignore",{diameter:.6,thickness:.03*t,tessellation:i},this.gizmoLayer.utilityLayerScene);r.visibility=0;let n=vn("",{diameter:.6,thickness:.005*t,tessellation:i},this.gizmoLayer.utilityLayerScene);return n.material=this._coloredMaterial,n.rotation.x=Math.PI/2,r.rotation.x=Math.PI/2,e.addChild(n,Bs.PreserveScaling),e.addChild(r,Bs.PreserveScaling),{rotationMesh:n,collider:r}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(e=>{e&&e.dispose()}),super.dispose()}};Ld.MaxDragAngle=Math.PI*9/20;Ld._RotationGizmoVertexShader=`
        precision highp float;
        attribute vec3 position;
        attribute vec2 uv;
        uniform mat4 worldViewProjection;
        varying vec3 vPosition;
        varying vec2 vUV;

        void main(void) {
            gl_Position = worldViewProjection * vec4(position, 1.0);
            vUV = uv;
        }`;Ld._RotationGizmoFragmentShader=`
        precision highp float;
        varying vec2 vUV;
        varying vec3 vPosition;
        uniform vec3 angles;
        uniform vec3 rotationColor;

        #define twopi 6.283185307

        void main(void) {
            vec2 uv = vUV - vec2(0.5);
            float angle = atan(uv.y, uv.x) + 3.141592;
            float delta = gl_FrontFacing ? angles.y : -angles.y;
            float begin = angles.x - delta * angles.z;
            float start = (begin < (begin + delta)) ? begin : (begin + delta);
            float end = (begin > (begin + delta)) ? begin : (begin + delta);
            float len = sqrt(dot(uv,uv));
            float opacity = 1. - step(0.5, len);

            float base = abs(floor(start / twopi)) * twopi;
            start += base;
            end += base;

            float intensity = 0.;
            for (int i = 0; i < 5; i++)
            {
                intensity += max(step(start, angle) - step(end, angle), 0.);
                angle += twopi;
            }
            gl_FragColor = vec4(rotationColor, min(intensity * 0.25, 0.8)) * opacity;
        }
    `;var Kn=class extends tt{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=N.Identity(),this._projectionMatrix=N.Identity()}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=p.Zero()),p.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=p.Zero()),p.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=p.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();let e=p.Cross(this.direction,qt.Y),t=p.Cross(e,this.direction);return p.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=p.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=N.Identity()),N.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){let t=O.Vector3[0],i=this.position;this.computeTransformedInformation()&&(i=this.transformedPosition),p.NormalizeToRef(this.getShadowDirection(e),t),Math.abs(p.Dot(t,p.Up()))===1&&(t.z=1e-13);let r=O.Vector3[1];return i.addToRef(t,r),N.LookAtLHToRef(i,r,p.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,e??this._viewMatrix,t??[]),this._projectionMatrix}};v([mi()],Kn.prototype,"position",null);v([mi()],Kn.prototype,"direction",null);v([I()],Kn.prototype,"shadowMinZ",null);v([I()],Kn.prototype,"shadowMaxZ",null);Xe.AddNodeConstructor("Light_Type_1",(s,e)=>()=>new Cr(s,p.Zero(),e));var Cr=class extends Kn{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return tt.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){let t=this.getScene().activeCamera;t&&N.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:t.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){let r=this.getScene().activeCamera;if(!r)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){let h=p.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let u=Number.MAX_VALUE,d=-Number.MAX_VALUE;for(let f=0;f<i.length;f++){let m=i[f];if(!m)continue;let _=m.getBoundingInfo().boundingBox;for(let x=0;x<_.vectorsWorld.length;x++)p.TransformCoordinatesToRef(_.vectorsWorld[x],t,h),h.x<this._orthoLeft&&(this._orthoLeft=h.x),h.y<this._orthoBottom&&(this._orthoBottom=h.y),h.x>this._orthoRight&&(this._orthoRight=h.x),h.y>this._orthoTop&&(this._orthoTop=h.y),this.autoCalcShadowZBounds&&(h.z<u&&(u=h.z),h.z>d&&(d=h.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=u,this._shadowMaxZ=d)}let n=this._orthoRight-this._orthoLeft,o=this._orthoTop-this._orthoBottom,a=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,l=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,c=this.getScene().getEngine().useReverseDepthBuffer;N.OrthoOffCenterLHToRef(this._orthoLeft-n*this.shadowOrthoScale,this._orthoRight+n*this.shadowOrthoScale,this._orthoBottom-o*this.shadowOrthoScale,this._orthoTop+o*this.shadowOrthoScale,c?l:a,c?a:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){let t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){let t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}};v([I()],Cr.prototype,"shadowFrustumSize",null);v([I()],Cr.prototype,"shadowOrthoScale",null);v([I()],Cr.prototype,"autoUpdateExtends",void 0);v([I()],Cr.prototype,"autoCalcShadowZBounds",void 0);v([I("orthoLeft")],Cr.prototype,"_orthoLeft",void 0);v([I("orthoRight")],Cr.prototype,"_orthoRight",void 0);v([I("orthoTop")],Cr.prototype,"_orthoTop",void 0);v([I("orthoBottom")],Cr.prototype,"_orthoBottom",void 0);P("BABYLON.DirectionalLight",Cr);function CV(s,e={},t){e.diameter||(e.diameter=1),e.segments||(e.segments=16);let i=pr("",{slice:.5,diameter:e.diameter,segments:e.segments},t),r=fm("",{radius:e.diameter/2,tessellation:e.segments*3+(4-e.segments)},t);r.rotation.x=-Math.PI/2,r.parent=i;let n=k.MergeMeshes([r,i],!0);return n.name=s,n}k.CreateHemisphere=(s,e,t,i)=>CV(s,{segments:e,diameter:t},i);Xe.AddNodeConstructor("Light_Type_2",(s,e)=>()=>new Hr(s,p.Zero(),p.Zero(),0,0,e));var Hr=class s extends Kn{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(s._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):s._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return e.onGeneratedObservable!==void 0}static _IsTexture(e){return e.onLoadObservable!==void 0}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,r,n,o){super(e,o),this._innerAngle=0,this._projectionTextureMatrix=N.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=p.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=p.Zero(),this._projectionTextureViewLightMatrix=N.Zero(),this._projectionTextureProjectionLightMatrix=N.Zero(),this._projectionTextureScalingMatrix=N.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=r,this.exponent=n}getClassName(){return"SpotLight"}getTypeID(){return tt.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){let r=this.getScene().activeCamera;if(!r)return;this._shadowAngleScale=this._shadowAngleScale||1;let n=this._shadowAngleScale*this._angle,o=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,a=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;N.PerspectiveFovLHToRef(n,1,l?a:o,l?o:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.getShadowDirection(),this._projectionTextureViewTargetVector),N.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;let e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),r=-i*t,n=1/Math.tan(this._angle/2);N.FromValuesToRef(n/1,0,0,0,0,n,0,0,0,0,i,1,0,0,r,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof z){let e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;N.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightTexture"+t,this.projectionTexture)),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=p.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=p.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return this.computeTransformedInformation()?i=p.Normalize(this.transformedDirection):i=p.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){let t=this._scene.getEngine(),i=this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){let t=this._scene.getEngine(),i=this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady())}};v([I()],Hr.prototype,"angle",null);v([I()],Hr.prototype,"innerAngle",null);v([I()],Hr.prototype,"shadowAngleScale",null);v([I()],Hr.prototype,"exponent",void 0);v([I()],Hr.prototype,"projectionTextureLightNear",null);v([I()],Hr.prototype,"projectionTextureLightFar",null);v([I()],Hr.prototype,"projectionTextureUpDirection",null);v([Qe("projectedLightTexture")],Hr.prototype,"_projectionTexture",void 0);P("BABYLON.SpotLight",Hr);var Rj="kernelBlurVaryingDeclaration",Pj="varying vec2 sampleCoord{X};";D.IncludesShadersStore[Rj]=Pj;var Mj="packingFunctions",Dj=`vec4 pack(float depth)
{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}`;D.IncludesShadersStore[Mj]=Dj;var Oj="kernelBlurFragment",wj=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;D.IncludesShadersStore[Oj]=wj;var Nj="kernelBlurFragment2",Fj=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;D.IncludesShadersStore[Nj]=Fj;var Lj="kernelBlurPixelShader",Bj=`uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float computedWeight=0.0;
#ifdef PACKEDFLOAT
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT; 
float factor=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;D.ShadersStore[Lj]=Bj;var Vj="kernelBlurVertex",Uj="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";D.IncludesShadersStore[Vj]=Uj;var kj="kernelBlurVertexShader",Gj=`attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[kj]=Gj;var Ci=class s extends ve{set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}constructor(e,t,i,r,n,o=z.BILINEAR_SAMPLINGMODE,a,l,c=0,h="",u=!1,d=5){super(e,"kernelBlur",["delta","direction"],["circleOfConfusionSampler"],r,n,o,a,l,null,c,"kernelBlur",{varyingCount:0,depCount:0},!0,d),this._blockCompilation=u,this._packedFloat=!1,this._staticDefines="",this._staticDefines=h,this.direction=t,this.onApplyObservable.add(f=>{this._outputTexture?f.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):f.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)}),this.kernel=i}updateEffect(e=null,t=null,i=null,r,n,o){this._updateParameters(n,o)}_updateParameters(e,t){let i=this._kernel,r=(i-1)/2,n=[],o=[],a=0;for(let _=0;_<i;_++){let x=_/(i-1),b=this._gaussianWeight(x*2-1);n[_]=_-r,o[_]=b,a+=b}for(let _=0;_<o.length;_++)o[_]/=a;let l=[],c=[],h=[];for(let _=0;_<=r;_+=2){let x=Math.min(_+1,Math.floor(r));if(_===x)h.push({o:n[_],w:o[_]});else{let C=x===r,R=o[_]+o[x]*(C?.5:1),E=n[_]+1/(1+o[_]/o[x]);E===0?(h.push({o:n[_],w:o[_]}),h.push({o:n[_+1],w:o[_+1]})):(h.push({o:E,w:R}),h.push({o:-E,w:R}))}}for(let _=0;_<h.length;_++)c[_]=h[_].o,l[_]=h[_].w;n=c,o=l;let u=this.getEngine().getCaps().maxVaryingVectors,d=Math.max(u,0)-1,f=Math.min(n.length,d),m="";m+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(m+=`#define CENTER_WEIGHT ${this._glslFloat(o[f-1])}
`,f--);for(let _=0;_<f;_++)m+=`#define KERNEL_OFFSET${_} ${this._glslFloat(n[_])}
`,m+=`#define KERNEL_WEIGHT${_} ${this._glslFloat(o[_])}
`;let g=0;for(let _=d;_<n.length;_++)m+=`#define KERNEL_DEP_OFFSET${g} ${this._glslFloat(n[_])}
`,m+=`#define KERNEL_DEP_WEIGHT${g} ${this._glslFloat(o[_])}
`,g++;this.packedFloat&&(m+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(m,null,null,{varyingCount:f,depCount:g},e,t)}_nearestBestKernel(e){let t=Math.round(e);for(let i of[t,t-1,t+1,t-2,t+2])if(i%2!==0&&Math.floor(i/2)%2===0&&i>0)return Math.max(i,3);return Math.max(t,3)}_gaussianWeight(e){let t=.3333333333333333,i=Math.sqrt(2*Math.PI)*t,r=-(e*e/(2*t*t));return 1/i*Math.exp(r)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1),e,i,r)}};v([I("kernel")],Ci.prototype,"_kernel",void 0);v([I("packedFloat")],Ci.prototype,"_packedFloat",void 0);v([gu()],Ci.prototype,"direction",void 0);P("BABYLON.BlurPostProcess",Ci);var Rm=class s extends vt{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){let e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){let e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,r,n=0,o=z.BILINEAR_SAMPLINGMODE,a=!0){if(super(e,t,i,r,!0,n,!1,o,a),this.mirrorPlane=new zs(0,1,0,1),this._transformMatrix=N.Zero(),this._mirrorMatrix=N.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,i=this.getScene(),!i)return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()});let l=i.getEngine();l.supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeBindObservable.add(()=>{l._debugPushGroup?.(`mirror generation for ${e}`,1)}),this.onAfterUnbindObservable.add(()=>{l._debugPopGroup?.(1)});let c;this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),N.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),c=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=p.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=c})}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){let e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new Ci("horizontal blur",new j(1,0),this._blurKernelX,this._blurRatio,null,z.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new Ci("vertical blur",new j(0,1),this._blurKernelY,this._blurRatio,null,z.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){let e=this.getScene();if(!e)return this;let t=this.getSize(),i=new s(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;let e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){super.dispose();let e=this.getScene();e&&e.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),this._sceneUBO?.dispose()}};z._CreateMirror=(s,e,t,i)=>new Rm(s,e,t,i);var Hi=class s extends Qi{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(N.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let r="";return e.forEach(n=>r+=n),new s(r,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,r=!0){let n=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;let o=new s(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=n,o}constructor(e,t,i=null,r=!1,n=null,o=null,a=null,l=5,c=!1,h=null,u=!1,d=.8,f=0,m,g){super(t),this._lodScale=.8,this._lodOffset=0,this.onLoadObservable=new U,this.boundingBoxPosition=p.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new N,this._buffer=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=N.Identity(),this.coordinatesMode=z.CUBIC_MODE;let _=null,x=null;i!==null&&!Array.isArray(i)?(_=i.extensions??null,this._noMipmap=i.noMipmap??!1,n=i.files??null,x=i.buffer??null,this._format=i.format??5,c=i.prefiltered??!1,h=i.forcedExtension??null,this._createPolynomials=i.createPolynomials??!1,this._lodScale=i.lodScale??0,this._lodOffset=i.lodOffset??0,this._loaderOptions=i.loaderOptions,this._useSRGBBuffer=i.useSRGBBuffer,o=i.onLoad??null,a=i.onError??null):(this._noMipmap=r,this._format=l,this._createPolynomials=u,_=i,this._loaderOptions=m,this._useSRGBBuffer=g,this._lodScale=d,this._lodOffset=f),!(!e&&!n)&&this.updateURL(e,h,o,c,a,_,this.getScene()?.useDelayedTextureLoading,n,x)}getClassName(){return"CubeTexture"}updateURL(e,t=null,i=null,r=!1,n=null,o=null,a=!1,l=null,c=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);let h=e.lastIndexOf("."),u=t||(h>-1?e.substring(h).toLowerCase():""),d=u.indexOf(".dds")===0,f=u.indexOf(".env")===0,m=u.indexOf(".basis")===0;if(f?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!m&&!f&&!d&&!o&&(o=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,o){for(let g=0;g<o.length;g++)this._files.push(e+o[g]);this._extensions=o}this._buffer=c,a?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=n):this._loadTexture(i,n)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,n=>n.getActiveTextures().indexOf(this)!==-1),this._textureMatrix=e,!this.getScene()?.useRightHandedSystem))return;let t=O.Vector3[0],i=O.Quaternion[0],r=O.Vector3[1];this._textureMatrix.decompose(t,i,r),i.z*=-1,i.w*=-1,N.ComposeToRef(t,i,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){return this.getScene()?.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){let i=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);let n=()=>{this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),this.getScene()?.markAllMaterialsAsDirty(1)),e&&e()},o=(a,l)=>{this._loadingError=!0,this._errorObject={message:a,exception:l},t&&t(a,l),z.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?H.SetImmediate(()=>n()):this._texture.onLoadedObservable.add(()=>n()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,this._lodScale,this._lodOffset,e,o,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,e,o,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),this._texture?.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){let r=ae.Parse(()=>{let n=!1;return e.prefiltered&&(n=e.prefiltered),new s(i+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,n,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=p.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=p.FromArray(e.boundingBoxSize)),e.animations)for(let n=0;n<e.animations.length;n++){let o=e.animations[n],a=Et("BABYLON.Animation");a&&r.animations.push(a.Parse(o))}return r}clone(){let e=0,t=ae.Clone(()=>{let i=new s(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}};v([I()],Hi.prototype,"url",void 0);v([mi()],Hi.prototype,"boundingBoxPosition",void 0);v([mi()],Hi.prototype,"boundingBoxSize",null);v([I("rotationY")],Hi.prototype,"rotationY",null);v([I("files")],Hi.prototype,"_files",void 0);v([I("forcedExtension")],Hi.prototype,"_forcedExtension",void 0);v([I("extensions")],Hi.prototype,"_extensions",void 0);v([Lf("textureMatrix")],Hi.prototype,"_textureMatrix",void 0);v([Lf("textureMatrixRefraction")],Hi.prototype,"_textureMatrixRefraction",void 0);z._CubeTextureParser=Hi.Parse;P("BABYLON.CubeTexture",Hi);var zj="backgroundFragmentDeclaration",Wj=`uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
#ifdef PROJECTED_GROUND
uniform vec2 projectedGroundInfos;
#endif
`;D.IncludesShadersStore[zj]=Wj;var Hj="backgroundUboDeclaration",Xj=`layout(std140,column_major) uniform;uniform Material
{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform vec2 vReflectionInfos;uniform mat4 diffuseMatrix;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;};
#include<sceneUboDeclaration>
`;D.IncludesShadersStore[Hj]=Xj;var Yj="backgroundPixelShader",$j=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#include<helperFunctions>
varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif 
#ifdef MAINUV2 
varying vec2 vMainUV2; 
#endif 
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
float diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }
vec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}
float sphereIntersect(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return -1.0; }
h=sqrt(h);return-b+h;}
vec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersect(eyePosition,camDir,radius);vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersect(eyePosition,p,radius);vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif
float shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
vec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#endif
vec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif
diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);
#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif
vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color.rgb=clamp(color.rgb,0.,30.0);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);
#endif
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;D.ShadersStore[Yj]=$j;var jj="backgroundVertexDeclaration",qj=`uniform mat4 view;uniform mat4 viewProjection;uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;D.IncludesShadersStore[jj]=qj;var Qj="backgroundVertexShader",Kj=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (vDiffuseInfos.x==0.)
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}
else
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=color;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;D.ShadersStore[Qj]=Kj;var x0=class extends Qt{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}},ft=class s extends Xs{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t=t*2,this.reflectionReflectance0=s.StandardReflectance0*t,this.reflectionReflectance90=s.StandardReflectance90*t):(t=t*2-1,this.reflectionReflectance0=s.StandardReflectance0+(1-s.StandardReflectance0)*t,this.reflectionReflectance90=s.StandardReflectance90+(1-s.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()})))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.primaryColor=X.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=p.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new _i(16),this._reflectionControls=De.Zero(),this._white=X.White(),this._primaryShadowColor=X.Black(),this._primaryHighlightColor=X.Black(),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new x0);let n=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=n.getEngine();if(co(n,e,o,!1,this._maxSimultaneousLights),o._needNormals=!0,Na(n,o),o._areTexturesDirty){if(o._needUVs=!1,n.texturesEnabled){if(n.getEngine().getCaps().textureLOD&&(o.TEXTURELODSUPPORT=!0),this._diffuseTexture&&ge.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;bt(this._diffuseTexture,o,"DIFFUSE"),o.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,o.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,o.OPACITYFRESNEL=this._opacityFresnel}else o.DIFFUSE=!1,o.DIFFUSEDIRECTUV=0,o.DIFFUSEHASALPHA=!1,o.GAMMADIFFUSE=!1,o.OPACITYFRESNEL=!1;let l=this._reflectionTexture;if(l&&ge.ReflectionTextureEnabled){if(!l.isReadyOrNotBlocking())return!1;switch(o.REFLECTION=!0,o.GAMMAREFLECTION=l.gammaSpace,o.RGBDREFLECTION=l.isRGBD,o.REFLECTIONBLUR=this._reflectionBlur>0,o.LODINREFLECTIONALPHA=l.lodLevelInAlpha,o.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,o.REFLECTIONBGR=this.switchToBGR,l.coordinatesMode===z.INVCUBIC_MODE&&(o.INVERTCUBICMAP=!0),o.REFLECTIONMAP_3D=l.isCube,o.REFLECTIONMAP_OPPOSITEZ=o.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!l.invertZ:l.invertZ,l.coordinatesMode){case z.EXPLICIT_MODE:o.REFLECTIONMAP_EXPLICIT=!0;break;case z.PLANAR_MODE:o.REFLECTIONMAP_PLANAR=!0;break;case z.PROJECTION_MODE:o.REFLECTIONMAP_PROJECTION=!0;break;case z.SKYBOX_MODE:o.REFLECTIONMAP_SKYBOX=!0;break;case z.SPHERICAL_MODE:o.REFLECTIONMAP_SPHERICAL=!0;break;case z.EQUIRECTANGULAR_MODE:o.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case z.FIXED_EQUIRECTANGULAR_MODE:o.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:o.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case z.CUBIC_MODE:case z.INVCUBIC_MODE:default:o.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(o.REFLECTIONFRESNEL=!0,o.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(o.REFLECTIONFRESNEL=!1,o.REFLECTIONFALLOFF=!1)}else o.REFLECTION=!1,o.REFLECTIONFRESNEL=!1,o.REFLECTIONFALLOFF=!1,o.REFLECTIONBLUR=!1,o.REFLECTIONMAP_3D=!1,o.REFLECTIONMAP_SPHERICAL=!1,o.REFLECTIONMAP_PLANAR=!1,o.REFLECTIONMAP_CUBIC=!1,o.REFLECTIONMAP_PROJECTION=!1,o.REFLECTIONMAP_SKYBOX=!1,o.REFLECTIONMAP_EXPLICIT=!1,o.REFLECTIONMAP_EQUIRECTANGULAR=!1,o.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,o.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,o.INVERTCUBICMAP=!1,o.REFLECTIONMAP_OPPOSITEZ=!1,o.LODINREFLECTIONALPHA=!1,o.GAMMAREFLECTION=!1,o.RGBDREFLECTION=!1}o.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,o.USERGBCOLOR=this._useRGBColor,o.NOISE=this._enableNoise}if(o._areLightsDirty&&(o.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),o.BACKMAT_SHADOWONLY=this._shadowOnly),o._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(o)}if(o._areMiscDirty&&(o.REFLECTIONMAP_3D&&this._enableGroundProjection?(o.PROJECTED_GROUND=!0,o.REFLECTIONMAP_SKYBOX=!0):o.PROJECTED_GROUND=!1),Da(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),o),Oa(n,a,this,o,i,null,t.getRenderingMesh().hasThinInstances),wa(e,o,!1,!0,!1)&&e&&!n.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(y.NormalKind)&&(e.createNormals(!0),F.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),o.isDirty){o.markAsProcessed(),n.resetCachedMaterial();let l=new ps;o.FOG&&l.addFallback(0,"FOG"),o.POINTSIZE&&l.addFallback(1,"POINTSIZE"),o.MULTIVIEW&&l.addFallback(0,"MULTIVIEW"),bc(o,l,this._maxSimultaneousLights);let c=[y.PositionKind];o.NORMAL&&c.push(y.NormalKind),o.UV1&&c.push(y.UVKind),o.UV2&&c.push(y.UV2Kind),Cc(c,e,o,l),Ma(c,o);let h=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];er(h);let u=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],d=["Material","Scene"];rt&&(rt.PrepareUniforms(h,o),rt.PrepareSamplers(u,o)),Fa({uniformsNames:h,uniformBuffersNames:d,samplers:u,defines:o,maxSimultaneousLights:this._maxSimultaneousLights});let f=o.toString(),m=n.getEngine().createEffect("background",{attributes:c,uniformsNames:h,uniformBuffersNames:d,samplers:u,defines:f,fallbacks:l,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},a);t.setEffect(m,o,this._materialContext),this.buildUniformLayout()}return!t.effect||!t.effect.isReady()?!1:(o._renderId=n.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){let r=this.getScene(),n=i.materialDefines;if(!n)return;let o=i.effect;if(!o)return;this._activeEffect=o,this.bindOnlyWorldMatrix(e),ao(t,this._activeEffect);let a=this._mustRebind(r,o,i,t.visibility);if(a){this._uniformBuffer.bindToEffect(o,"Material"),this.bindViewProjection(o);let l=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync||i._drawWrapper._forceRebindOnNextCall)&&(r.texturesEnabled&&(this._diffuseTexture&&ge.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),It(this._diffuseTexture,this._uniformBuffer,"diffuse")),l&&ge.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",l.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),n.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),r.texturesEnabled&&(this._diffuseTexture&&ge.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&ge.ReflectionTextureEnabled&&(n.REFLECTIONBLUR&&n.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",l):n.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",l._lodTextureMid||l),this._uniformBuffer.setTexture("reflectionSamplerLow",l._lodTextureLow||l),this._uniformBuffer.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)):this._uniformBuffer.setTexture("reflectionSampler",l),n.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),n.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),Yi(this._activeEffect,this,r),r.bindEyePosition(o)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(o,"Material"),this._needToBindSceneUbo=!0);(a||!this.isFrozen)&&(r.lightsEnabled&&lo(r,t,this._activeEffect,n,this._maxSimultaneousLights),this.bindView(o),Ms(r,t,this._activeEffect,!0),this._useLogarithmicDepth&&Br(n,o,r),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),this._uniformBuffer.update()}hasTexture(e){return!!(super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return ae.Clone(()=>new s(e,this.getScene()),this)}serialize(){let e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return ae.Parse(()=>new s(e.name,t),e,t,i)}};ft.StandardReflectance0=.05;ft.StandardReflectance90=.5;v([At()],ft.prototype,"_primaryColor",void 0);v([Q("_markAllSubMeshesAsLightsDirty")],ft.prototype,"primaryColor",void 0);v([At()],ft.prototype,"__perceptualColor",void 0);v([I()],ft.prototype,"_primaryColorShadowLevel",void 0);v([I()],ft.prototype,"_primaryColorHighlightLevel",void 0);v([Q("_markAllSubMeshesAsLightsDirty")],ft.prototype,"primaryColorHighlightLevel",null);v([Qe()],ft.prototype,"_reflectionTexture",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionTexture",void 0);v([I()],ft.prototype,"_reflectionBlur",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionBlur",void 0);v([Qe()],ft.prototype,"_diffuseTexture",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"diffuseTexture",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"shadowLights",void 0);v([I()],ft.prototype,"_shadowLevel",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"shadowLevel",void 0);v([mi()],ft.prototype,"_sceneCenter",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"sceneCenter",void 0);v([I()],ft.prototype,"_opacityFresnel",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"opacityFresnel",void 0);v([I()],ft.prototype,"_reflectionFresnel",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionFresnel",void 0);v([I()],ft.prototype,"_reflectionFalloffDistance",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionFalloffDistance",void 0);v([I()],ft.prototype,"_reflectionAmount",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionAmount",void 0);v([I()],ft.prototype,"_reflectionReflectance0",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionReflectance0",void 0);v([I()],ft.prototype,"_reflectionReflectance90",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"reflectionReflectance90",void 0);v([I()],ft.prototype,"_useRGBColor",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"useRGBColor",void 0);v([I()],ft.prototype,"_enableNoise",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"enableNoise",void 0);v([I()],ft.prototype,"_maxSimultaneousLights",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ft.prototype,"maxSimultaneousLights",void 0);v([I()],ft.prototype,"_shadowOnly",void 0);v([Q("_markAllSubMeshesAsLightsDirty")],ft.prototype,"shadowOnly",void 0);v([Sg()],ft.prototype,"_imageProcessingConfiguration",void 0);v([I(),Q("_markAllSubMeshesAsMiscDirty")],ft.prototype,"enableGroundProjection",void 0);v([I()],ft.prototype,"projectedGroundRadius",void 0);v([I()],ft.prototype,"projectedGroundHeight",void 0);P("BABYLON.BackgroundMaterial",ft);var v0=(()=>{class s{static _GetDefaultOptions(t){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new X(.2,.2,.3).toLinearSpace(t.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new X(.2,.2,.3).toLinearSpace(t.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:p.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(t,i){this._errorHandler=(r,n)=>{this.onErrorObservable.notifyObservers({message:r,exception:n})},this._options=ie(ie({},s._GetDefaultOptions(i)),t),this._scene=i,this.onErrorObservable=new U,this._setupBackground(),this._setupImageProcessing()}updateOptions(t){let i=ie(ie({},this._options),t);this._ground&&!i.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!i.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=i.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!i.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!i.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=i.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!i.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=i.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=i,this._setupBackground(),this._setupImageProcessing()}setMainColor(t){this.groundMaterial&&(this.groundMaterial.primaryColor=t),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=t),this.groundMirror&&(this.groundMirror.clearColor=new oe(t.r,t.g,t.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof Qi){this._scene.environmentTexture=this._options.environmentTexture;return}let t=Hi.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=t}_setupBackground(){this._rootMesh||(this._rootMesh=new k("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;let t=this._getSceneSize();this._options.createGround&&(this._setupGround(t),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(t),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(t),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=t.rootPosition.x,this._rootMesh.position.z=t.rootPosition.z,this._rootMesh.position.y=t.rootPosition.y}_getSceneSize(){let t=this._options.groundSize,i=this._options.skyboxSize,r=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:t,skyboxSize:i,rootPosition:r};let n=this._scene.getWorldExtends(a=>a!==this._ground&&a!==this._rootMesh&&a!==this._skybox),o=n.max.subtract(n.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof Bt&&this._scene.activeCamera.upperRadiusLimit&&(t=this._scene.activeCamera.upperRadiusLimit*2,i=t);let a=o.length();a>t&&(t=a*2,i=t),t*=1.1,i*=1.5,r=n.min.add(o.scale(.5)),r.y=n.min.y-this._options.groundYBias}return{groundSize:t,skyboxSize:i,rootPosition:r}}_setupGround(t){(!this._ground||this._ground.isDisposed())&&(this._ground=Yn("BackgroundPlane",{size:t.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.isPickable=!1,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(()=>{this._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new ft("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){if(this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof Qi){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new z(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}}_setupGroundMirrorTexture(t){let i=z.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new Rm("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,z.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new zs(0,-1,0,t.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=i,this._groundMirror.wrapV=i,this._groundMirror.renderList))for(let n=0;n<this._scene.meshes.length;n++){let o=this._scene.meshes[n];o!==this._ground&&o!==this._skybox&&o!==this._rootMesh&&this._groundMirror.renderList.push(o)}let r=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new oe(r.r,r.g,r.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(t){(!this._skybox||this._skybox.isDisposed())&&(this._skybox=ha("BackgroundSkybox",{size:t.skyboxSize,sideOrientation:k.BACKSIDE},this._scene),this._skybox.isPickable=!1,this._skybox.onDisposeObservable.add(()=>{this._skybox=null})),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new ft("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){if(this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof Qi){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new Hi(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=z.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}return s._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",s._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",s._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env",s})();var xa=(()=>{class s extends Ze{get texture(){return this._texture}set texture(t){this._texture!==t&&(this._texture=t,this._useDirectMapping?(this._texture.wrapU=z.CLAMP_ADDRESSMODE,this._texture.wrapV=z.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=z.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))}get mesh(){return this._mesh}get fovMultiplier(){return this._material.fovMultiplier}set fovMultiplier(t){this._material.fovMultiplier=t}get textureMode(){return this._textureMode}set textureMode(t){this._textureMode!==t&&this._changeTextureMode(t)}get halfDome(){return this._halfDome}set halfDome(t){this._halfDome=t,this._halfDomeMask.setEnabled(t),this._changeTextureMode(this._textureMode)}set crossEye(t){this._crossEye=t,this._changeTextureMode(this._textureMode)}get crossEye(){return this._crossEye}get material(){return this._material}constructor(t,i,r,n,o=null){super(t,n),this.onError=o,this._halfDome=!1,this._crossEye=!1,this._useDirectMapping=!1,this._textureMode=s.MODE_MONOSCOPIC,this._onBeforeCameraRenderObserver=null,this.onLoadErrorObservable=new U,this.onLoadObservable=new U,n=this.getScene(),t=t||"textureDome",r.resolution=Math.abs(r.resolution)|0||32,r.clickToPlay=!!r.clickToPlay,r.autoPlay=r.autoPlay===void 0?!0:!!r.autoPlay,r.loop=r.loop===void 0?!0:!!r.loop,r.size=Math.abs(r.size)||(n.activeCamera?n.activeCamera.maxZ*.48:1e3),r.useDirectMapping===void 0?this._useDirectMapping=!0:this._useDirectMapping=r.useDirectMapping,r.faceForward===void 0&&(r.faceForward=!0),this._setReady(!1),r.mesh?this._mesh=r.mesh:this._mesh=pr(t+"_mesh",{segments:r.resolution,diameter:r.size,updatable:!1,sideOrientation:k.BACKSIDE},n);let a=this._material=new ft(t+"_material",n);a.useEquirectangularFOV=!0,a.fovMultiplier=1,a.opacityFresnel=!1;let l=this._initTexture(i,n,r);if(this.texture=l,this._mesh.material=a,this._mesh.parent=this,this._halfDomeMask=pr("",{slice:.5,diameter:r.size*.98,segments:r.resolution*2,sideOrientation:k.BACKSIDE},n),this._halfDomeMask.rotate(qt.X,-Math.PI/2),this._halfDomeMask.parent=this._mesh,this._halfDome=!!r.halfDomeMode,this._halfDomeMask.setEnabled(this._halfDome),this._crossEye=!!r.crossEyeMode,this._texture.anisotropicFilteringLevel=1,this._texture.onLoadObservable.addOnce(()=>{this._setReady(!0)}),r.faceForward&&n.activeCamera){let c=n.activeCamera,h=p.Forward(),u=p.TransformNormal(h,c.getViewMatrix());u.normalize(),this.rotation.y=Math.acos(p.Dot(h,u))}this._changeTextureMode(this._textureMode)}_changeTextureMode(t){switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=t,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,t){case s.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case s.MODE_SIDEBYSIDE:{this._texture.uScale=this._halfDome?.99999:.5;let i=this._halfDome?0:.5,r=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(n=>{let o=n.isRightCamera;this._crossEye&&(o=!o),o?this._texture.uOffset=i:this._texture.uOffset=r});break}case s.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(i=>{let r=i.isRightCamera;this._crossEye&&(r=!r),this._texture.vOffset=r?.5:0});break}}dispose(t,i=!1){this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),super.dispose(t,i)}}return s.MODE_MONOSCOPIC=0,s.MODE_TOPBOTTOM=1,s.MODE_SIDEBYSIDE=2,s})();var Pm=class extends xa{get photoTexture(){return this.texture}set photoTexture(e){this.texture=e}get imageMode(){return this.textureMode}set imageMode(e){this.textureMode=e}_initTexture(e,t,i){return new z(e,t,!i.generateMipMaps,!this._useDirectMapping,void 0,()=>{this.onLoadObservable.notifyObservers()},(r,n)=>{this.onLoadErrorObservable.notifyObservers(r||"Unknown error occured"),this.onError&&this.onError(r,n)})}};Pm.MODE_MONOSCOPIC=xa.MODE_MONOSCOPIC;Pm.MODE_TOPBOTTOM=xa.MODE_TOPBOTTOM;Pm.MODE_SIDEBYSIDE=xa.MODE_SIDEBYSIDE;var Zj="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==",Jj=0,Bd=s=>{if(!s.environmentBRDFTexture){let e=s.useDelayedTextureLoading;s.useDelayedTextureLoading=!1;let t=s._blockEntityCollection;s._blockEntityCollection=!1;let i=z.CreateFromBase64String(Zj,"EnvironmentBRDFTexture"+Jj++,s,!0,!1,z.BILINEAR_SAMPLINGMODE);s._blockEntityCollection=t;let r=s.getEngine().getLoadedTexturesCache(),n=r.indexOf(i.getInternalTexture());n!==-1&&r.splice(n,1),i.isRGBD=!0,i.wrapU=z.CLAMP_ADDRESSMODE,i.wrapV=z.CLAMP_ADDRESSMODE,s.environmentBRDFTexture=i,s.useDelayedTextureLoading=e,Id.ExpandRGBDTexture(i);let o=s.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;let a=s.onBeforeRenderObservable.add(()=>{i.isReady()&&(s.onBeforeRenderObservable.remove(a),Id.ExpandRGBDTexture(i))})});s.onDisposeObservable.add(()=>{s.getEngine().onContextRestoredObservable.remove(o)})}return s.environmentBRDFTexture};var T0=class extends Qt{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}},Sn=class s extends Ti{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRBRDF",90,new T0,t),this._useEnergyConservation=s.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=s.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=s.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=s.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=s.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=s.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=s.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=s.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}};Sn.DEFAULT_USE_ENERGY_CONSERVATION=!0;Sn.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0;Sn.DEFAULT_USE_SPHERICAL_HARMONICS=!0;Sn.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0;v([I(),Q("_markAllSubMeshesAsMiscDirty")],Sn.prototype,"useEnergyConservation",void 0);v([I(),Q("_markAllSubMeshesAsMiscDirty")],Sn.prototype,"useSmithVisibilityHeightCorrelated",void 0);v([I(),Q("_markAllSubMeshesAsMiscDirty")],Sn.prototype,"useSphericalHarmonics",void 0);v([I(),Q("_markAllSubMeshesAsMiscDirty")],Sn.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);var e6="pbrFragmentDeclaration",t6=`uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#ifdef SS_DISPERSION
uniform float dispersion;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;uniform vec4 vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;D.IncludesShadersStore[e6]=t6;var i6="pbrUboDeclaration",r6=`layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec2 vReflectionInfos;vec2 vReflectionFilteringInfo;vec3 vReflectionPosition;vec3 vReflectionSize;vec3 vBumpInfos;mat4 albedoMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;mat4 reflectionMatrix;vec3 vReflectionColor;vec4 vAlbedoColor;vec4 vLightingIntensity;vec3 vReflectionMicrosurfaceInfos;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;D.IncludesShadersStore[i6]=r6;var s6="pbrFragmentExtraDeclaration",n6=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
`;D.IncludesShadersStore[s6]=n6;var o6="samplerFragmentAlternateDeclaration",a6=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;D.IncludesShadersStore[o6]=a6;var l6="pbrFragmentSamplersDeclaration",c6=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
`;D.IncludesShadersStore[l6]=c6;var h6="subSurfaceScatteringFunctions",u6=`bool testLightingForSSS(float diffusionProfile)
{return diffusionProfile<1.;}`;D.IncludesShadersStore[h6]=u6;var d6="importanceSampling",f6=`vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;D.IncludesShadersStore[d6]=f6;var p6="pbrHelperFunctions",m6=`#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{return square(roughness)+MINIMUMVARIANCE;}
float fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#else
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}
#endif
`;D.IncludesShadersStore[p6]=m6;var g6="harmonicsFunctions",_6=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}
#endif
#endif
`;D.IncludesShadersStore[g6]=_6;var x6="pbrDirectLightingSetupFunctions",v6=`struct preLightingInfo
{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float roughness;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightOffset=lightData.xyz-vPositionW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}`;D.IncludesShadersStore[x6]=v6;var T6="pbrDirectLightingFalloffFunctions",C6=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{return max(0.,1.0-length(lightOffset)/range);}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{return 1.0/maxEps(lightDistanceSquared);}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;D.IncludesShadersStore[T6]=C6;var b6="pbrBRDFFunctions",S6=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
vec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}
float getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}
vec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
float cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)
{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}
return max(I,vec3(0.0));}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
float lambdaSheen(float cosTheta,float alphaG)
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
float computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}
#endif
`;D.IncludesShadersStore[b6]=S6;var y6="hdrFilteringFunctions",E6=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
float radicalInverse_VdC(uint bits) 
{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }
vec2 hammersley(uint i,uint N)
{return vec2(float(i)/float(N),radicalInverse_VdC(i));}
#else
float vanDerCorpus(int n,int base)
{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)
{if(n>0)
{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}
return result;}
vec2 hammersley(int i,int N)
{return vec2(float(i)/float(N),vanDerCorpus(i,2));}
#endif
float log4(float x) {return log2(x)/2.;}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;
#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 result=vec3(0.0);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);vec3 Ns=vec3(0.,0.,1.);float NoL=dot(Ns,Ls);if (NoL>0.) {float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.0,maxLevel);vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c;}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; 
if (alphaG==0.) {
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#endif
#endif
`;D.IncludesShadersStore[y6]=E6;var A6="pbrDirectLightingFunctions",I6=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {float NdotL=absEps(info.NdotLUnclamped);float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
float sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
`;D.IncludesShadersStore[A6]=I6;var R6="pbrIBLFunctions",P6=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;D.IncludesShadersStore[R6]=P6;var M6="pbrBlockAlbedoOpacity",D6=`struct albedoOpacityOutParams
{vec3 surfaceAlbedo;float alpha;};
#define pbr_inline
void albedoOpacityBlock(
in vec4 vAlbedoColor,
#ifdef ALBEDO
in vec4 albedoTexture,
in vec2 albedoInfos,
#endif
#ifdef OPACITY
in vec4 opacityMap,
in vec2 vOpacityInfos,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
#ifdef DECAL
in vec4 decalColor,
in vec4 vDecalInfos,
#endif
out albedoOpacityOutParams outParams
)
{vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST 
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;}
`;D.IncludesShadersStore[M6]=D6;var O6="pbrBlockReflectivity",w6=`struct reflectivityOutParams
{float microSurface;float roughness;vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
vec2 metallicRoughness;
#ifdef REFLECTIVITY
vec4 surfaceMetallicColorMap;
#endif
#ifndef FROSTBITE_REFLECTANCE
vec3 metallicF0;
#endif
#else
#ifdef REFLECTIVITY
vec4 surfaceReflectivityColorMap;
#endif
#endif
#endif
};
#define pbr_inline
void reflectivityBlock(
in vec4 vReflectivityColor,
#ifdef METALLICWORKFLOW
in vec3 surfaceAlbedo,
in vec4 metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
in vec3 reflectivityInfos,
in vec4 surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
in vec3 ambientOcclusionColorIn,
#endif
#ifdef MICROSURFACEMAP
in vec4 microSurfaceTexel,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
out reflectivityOutParams outParams
)
{float microSurface=vReflectivityColor.a;vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);float roughness=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;}
`;D.IncludesShadersStore[O6]=w6;var N6="pbrBlockAmbientOcclusion",F6=`struct ambientOcclusionOutParams
{vec3 ambientOcclusionColor;
#if DEBUGMODE>0 && defined(AMBIENT)
vec3 ambientOcclusionColorMap;
#endif
};
#define pbr_inline
void ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos,
#endif
out ambientOcclusionOutParams outParams
)
{vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;}
`;D.IncludesShadersStore[N6]=F6;var L6="pbrBlockAlphaFresnel",B6=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{float alpha;};
#define pbr_inline
void alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface,
out alphaFresnelOutParams outParams
)
{float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
}
#endif
#endif
`;D.IncludesShadersStore[L6]=B6;var V6="pbrBlockAnisotropic",U6=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
void anisotropicBlock(
in vec3 vAnisotropy,
in float roughness,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW,
out anisotropicOutParams outParams
)
{float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
anisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection.rg*=anisotropyMapData.rg;
#else
anisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);}
#endif
`;D.IncludesShadersStore[V6]=U6;var k6="pbrBlockReflection",G6=`#ifdef REFLECTION
struct reflectionOutParams
{vec4 environmentRadiance;vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}
#define pbr_inline
#define inline
void reflectionBlock(
in vec3 vPositionW,
in vec3 normalW,
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
in vec3 vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in mat4 reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out reflectionOutParams outParams
)
{vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);vec3 environmentIrradiance=vec3(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;outParams.environmentRadiance=environmentRadiance;outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;}
#endif
`;D.IncludesShadersStore[k6]=G6;var z6="pbrBlockSheen",W6=`#ifdef SHEEN
struct sheenOutParams
{float sheenIntensity;vec3 sheenColor;float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
vec4 sheenMapData;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 sheenEnvironmentReflectance;
#endif
#endif
};
#define pbr_inline
#define inline
void sheenBlock(
in vec4 vSheenColor,
#ifdef SHEEN_ROUGHNESS
in float vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 sheenMapRoughnessData,
#endif
#endif
in float roughness,
#ifdef SHEEN_TEXTURE
in vec4 sheenMapData,
in float sheenMapLevel,
#endif
in float reflectance,
#ifdef SHEEN_LINKWITHALBEDO
in vec3 baseColor,
in vec3 surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
in float NdotV,
in vec3 environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
in vec2 AARoughnessFactors,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
in vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
in vec2 reflectionCoords,
#endif
in float NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
in float seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
in float eho,
#endif
#endif
out sheenOutParams outParams
)
{float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;}
#endif
`;D.IncludesShadersStore[z6]=W6;var H6="pbrBlockClearcoat",X6=`struct clearcoatOutParams
{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
mat3 TBNClearCoat;
#endif
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData;
#endif
#ifdef REFLECTION
vec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;
#endif
float clearCoatNdotV;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
void clearcoatBlock(
in vec3 vPositionW,
in vec3 geometricNormalW,
in vec3 viewDirectionW,
in vec2 vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 clearCoatMapRoughnessData,
#endif
in vec3 specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
in vec4 vClearCoatTintParams,
in float clearCoatColorAtDistance,
in vec4 vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
in vec4 clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
in vec2 vClearCoatBumpInfos,
in vec4 clearCoatBumpMapData,
in vec2 vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
in mat3 vTBN,
#else
in vec2 vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
in mat4 normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
in vec3 faceNormal,
#endif
#ifdef REFLECTION
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
in float ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
in float frontFacingMultiplier,
#endif
out clearcoatOutParams outParams
)
{float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
}
#endif
`;D.IncludesShadersStore[H6]=X6;var Y6="pbrBlockIridescence",$6=`struct iridescenceOutParams
{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
void iridescenceBlock(
in vec4 vIridescenceParams,
in float viewAngle,
in vec3 specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
in vec2 iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
in vec2 iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
in float NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#endif
out iridescenceOutParams outParams
)
{float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;}
#endif
`;D.IncludesShadersStore[Y6]=$6;var j6="pbrBlockSubSurface",q6=`struct subSurfaceOutParams
{vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction;vec3 refractionTransmittance;
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
#define inline
vec4 sampleEnvironmentRefraction(
in float ior
,in float thickness
,in float refractionLOD
,in vec3 normalW
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
return environmentRefraction;}
#endif
#define pbr_inline
#define inline
void subSurfaceBlock(
in vec3 vSubSurfaceIntensity,
in vec2 vThicknessParam,
in vec4 vTintColor,
in vec3 normalW,
in vec3 specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
in vec4 thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
in vec4 refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
in vec4 translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
in mat4 reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in vec3 irradianceVector_,
#endif
#if defined(REALTIME_FILTERING)
in samplerCube reflectionSampler,
in vec2 vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
in vec3 surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
in vec3 vPositionW,
in vec3 viewDirectionW,
in mat4 view,
in vec4 vRefractionInfos,
in mat4 refractionMatrix,
in vec4 vRefractionMicrosurfaceInfos,
in vec4 vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
in float alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
in float NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
in float roughness,
#endif
in float alphaG,
#ifdef SS_REFRACTIONMAP_3D
in samplerCube refractionSampler,
#ifndef LODBASEDMICROSFURACE
in samplerCube refractionSamplerLow,
in samplerCube refractionSamplerHigh,
#endif
#else
in sampler2D refractionSampler,
#ifndef LODBASEDMICROSFURACE
in sampler2D refractionSamplerLow,
in sampler2D refractionSamplerHigh,
#endif
#endif
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
in vec2 vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
in vec3 refractionPosition,
in vec3 refractionSize,
#endif
#ifdef SS_DISPERSION
in float dispersion,
#endif
#endif
#ifdef SS_TRANSLUCENCY
in vec3 vDiffusionDistance,
in vec4 vTranslucencyColor,
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
in vec4 translucencyColorMap,
#endif
#endif
out subSurfaceOutParams outParams
)
{outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);vec4 translucencyColor=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
vec3 transmittance=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
float refraction_ior=vRefractionInfos.y;
#ifdef SS_DISPERSION
float realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];
#endif
vec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#else
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
}
#endif
`;D.IncludesShadersStore[j6]=q6;var Q6="pbrBlockNormalGeometric",K6=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;D.IncludesShadersStore[Q6]=K6;var Z6="pbrBlockNormalFinal",J6=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;D.IncludesShadersStore[Z6]=J6;var e8="pbrBlockLightmapInit",t8=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;D.IncludesShadersStore[e8]=t8;var i8="pbrBlockGeometryInfo",r8=`float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;D.IncludesShadersStore[i8]=r8;var s8="pbrBlockReflectance0",n8=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else 
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;D.IncludesShadersStore[s8]=n8;var o8="pbrBlockReflectance",a8=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;D.IncludesShadersStore[o8]=a8;var l8="pbrBlockDirectLighting",c8=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
preLightingInfo preInfo;lightingInfo info;float shadow=1.; 
float aggShadow=0.;float numLights=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;D.IncludesShadersStore[l8]=c8;var h8="pbrBlockFinalLitComponents",u8=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;D.IncludesShadersStore[h8]=u8;var d8="pbrBlockFinalUnlitComponents",f8=`vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo.rgb;finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;D.IncludesShadersStore[d8]=f8;var p8="pbrBlockFinalColorComposition",m8=`vec4 finalColor=vec4(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
finalColor.rgb+=finalEmissive;
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;D.IncludesShadersStore[p8]=m8;var g8="pbrBlockImageProcessing",_8=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;D.IncludesShadersStore[g8]=_8;var x8="pbrDebug",v8=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
gl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
gl_FragColor.rgb=vec3(microSurface);
#elif DEBUGMODE==73
gl_FragColor.rgb=vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
gl_FragColor.rgb=vEmissiveColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
gl_FragColor.rgb=vec3(albedoTexture.a);
#elif DEBUGMODE==89
gl_FragColor.rgb=aoOut.ambientOcclusionColor.rgb;
#else
float stripeWidth=30.;float stripePos=floor((gl_FragCoord.x+gl_FragCoord.y)/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return;
#endif
}
#endif
`;D.IncludesShadersStore[x8]=v8;var T8="pbrPixelShader",C8=`#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
albedoOpacityBlock(
vAlbedoColor,
#ifdef ALBEDO
albedoTexture,
vAlbedoInfos,
#endif
#ifdef OPACITY
opacityMap,
vOpacityInfos,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
#ifdef DECAL
decalColor,
vDecalInfos,
#endif
albedoOpacityOut
);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos,
#endif
aoOut
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else
vec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityBlock(
vReflectivityColor,
#ifdef METALLICWORKFLOW
surfaceAlbedo,
metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
vReflectivityInfos,
surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor,
#endif
#ifdef MICROSURFACEMAP
microSurfaceTexel,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
reflectivityOut
);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface,
alphaFresnelOut
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicBlock(
vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW,
anisotropicOut
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionBlock(
vPositionW,
normalW,
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
reflectionSampler,
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
reflectionOut
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenBlock(
vSheenColor,
#ifdef SHEEN_ROUGHNESS
vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
sheenMapRoughnessData,
#endif
#endif
roughness,
#ifdef SHEEN_TEXTURE
sheenMapData,
vSheenInfos.y,
#endif
reflectance,
#ifdef SHEEN_LINKWITHALBEDO
baseColor,
surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
NdotV,
environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
AARoughnessFactors,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
reflectionOut.reflectionCoords,
NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
eho,
#endif
#endif
sheenOut
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceBlock(
vIridescenceParams,
NdotV,
specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#endif
iridescenceOut
);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatBlock(
vPositionW,
geometricNormalW,
viewDirectionW,
vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatMapRoughnessData,
#endif
specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
vClearCoatTintParams,
clearCoatColorAtDistance,
vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
vClearCoatBumpInfos,
clearCoatBumpMapData,
vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
vTBN,
#else
vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
faceNormal,
#endif
#ifdef REFLECTION
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
(gl_FrontFacing ? 1. : -1.),
#endif
clearcoatOut
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
vec4 translucencyColorMap=texture2D(translucencyColorSampler,vTranslucencyColorUV+uvOffset);
#endif
subSurfaceBlock(
vSubSurfaceIntensity,
vThicknessParam,
vTintColor,
normalW,
specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionOut.irradianceVector,
#endif
#if defined(REALTIME_FILTERING)
reflectionSampler,
vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
vPositionW,
viewDirectionW,
view,
vRefractionInfos,
refractionMatrix,
vRefractionMicrosurfaceInfos,
vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
roughness,
#endif
alphaG,
refractionSampler,
#ifndef LODBASEDMICROSFURACE
refractionSamplerLow,
refractionSamplerHigh,
#endif
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
vRefractionPosition,
vRefractionSize,
#endif
#ifdef SS_DISPERSION
dispersion,
#endif
#endif
#ifdef SS_TRANSLUCENCY
vDiffusionDistance,
vTranslucencyColor,
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColorMap,
#endif
#endif
subSurfaceOut
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
gl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); 
irradiance/=sqAlbedo;
#else
gl_FragData[0]=finalColor; 
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#else
gl_FragData[0]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalW,writeGeometryInfo); 
#else
gl_FragData[PREPASS_NORMAL_INDEX]=vec4(normalize((view*vec4(normalW,0.0)).rgb),writeGeometryInfo); 
#endif
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;D.ShadersStore[T8]=C8;var b8="pbrVertexDeclaration",S8=`uniform mat4 view;uniform mat4 viewProjection;
#ifdef ALBEDO
uniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY 
uniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;D.IncludesShadersStore[b8]=S8;var y8="pbrVertexShader",E8=`precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);
#include<prePassVertex>
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[y8]=E8;var C0=class extends Qt{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}},cr=class s extends Ti{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRClearCoat",100,new C0,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=s._DefaultIndexOfRefraction,this.indexOfRefraction=s._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=X.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;let r=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ge.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&ge.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&ge.ClearCoatBumpTextureEnabled&&!r&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&ge.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ge.ClearCoatTextureEnabled?bt(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&ge.ClearCoatTextureEnabled?bt(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&ge.ClearCoatBumpTextureEnabled?bt(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===s._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&ge.ClearCoatTintTextureEnabled?(bt(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,r){if(!this._isEnabled)return;let n=r.materialDefines,o=this._material.isFrozen,a=this._material._disableBumpMap,l=this._material._invertNormalMapX,c=this._material._invertNormalMapY;if(!e.useUbo||!o||!e.isSync){(this._texture||this._textureRoughness)&&ge.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&It(this._texture,e,"clearCoat"),this._textureRoughness&&!n.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&It(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&ge.ClearCoatTextureEnabled&&!a&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),It(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",l?1:-1,c?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",l?-1:1,c?-1:1)),this._tintTexture&&ge.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),It(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);let h=1-this._indexOfRefraction,u=1+this._indexOfRefraction,d=Math.pow(-h/u,2),f=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",d,f,h,u),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&ge.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!n.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&ge.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&ge.ClearCoatBumpTextureEnabled&&!a&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&ge.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose(),this._bumpTexture?.dispose(),this._tintTexture?.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}};cr._DefaultIndexOfRefraction=1.5;v([I(),Q("_markAllSubMeshesAsTexturesDirty")],cr.prototype,"isEnabled",void 0);v([I()],cr.prototype,"intensity",void 0);v([I()],cr.prototype,"roughness",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],cr.prototype,"indexOfRefraction",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],cr.prototype,"texture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],cr.prototype,"useRoughnessFromMainTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],cr.prototype,"textureRoughness",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],cr.prototype,"remapF0OnInterfaceChange",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],cr.prototype,"bumpTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],cr.prototype,"isTintEnabled",void 0);v([At()],cr.prototype,"tintColor",void 0);v([I()],cr.prototype,"tintColorAtDistance",void 0);v([I()],cr.prototype,"tintThickness",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],cr.prototype,"tintTexture",void 0);var b0=class extends Qt{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0}},Kr=class s extends Ti{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"PBRIridescence",110,new b0,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=s._DefaultMinimumThickness,this.maximumThickness=s._DefaultMaximumThickness,this.indexOfRefraction=s._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ge.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&ge.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.IRIDESCENCE=!0,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ge.IridescenceTextureEnabled?bt(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,this._thicknessTexture&&ge.IridescenceTextureEnabled?bt(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t){if(!this._isEnabled)return;let i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&((this._texture||this._thicknessTexture)&&ge.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._thicknessTexture?.coordinatesIndex??0,this._thicknessTexture?.level??0),this._texture&&It(this._texture,e,"iridescence"),this._thicknessTexture&&It(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&ge.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&ge.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){e&&(this._texture?.dispose(),this._thicknessTexture?.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}};Kr._DefaultMinimumThickness=100;Kr._DefaultMaximumThickness=400;Kr._DefaultIndexOfRefraction=1.3;v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Kr.prototype,"isEnabled",void 0);v([I()],Kr.prototype,"intensity",void 0);v([I()],Kr.prototype,"minimumThickness",void 0);v([I()],Kr.prototype,"maximumThickness",void 0);v([I()],Kr.prototype,"indexOfRefraction",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Kr.prototype,"texture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Kr.prototype,"thicknessTexture",void 0);var S0=class extends Qt{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}},va=class extends Ti{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new S0,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new j(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&ge.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(y.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ge.AnisotropicTextureEnabled?bt(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;let i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&(this._texture&&ge.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),It(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&ge.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),e.legacy===void 0&&(this.legacy=!0)}};v([I(),Q("_markAllSubMeshesAsTexturesDirty")],va.prototype,"isEnabled",void 0);v([I()],va.prototype,"intensity",void 0);v([gu()],va.prototype,"direction",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],va.prototype,"texture",void 0);v([I(),Q("_markAllSubMeshesAsMiscDirty")],va.prototype,"legacy",void 0);var y0=class extends Qt{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1}},Ks=class extends Ti{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"Sheen",120,new y0,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=X.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ge.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&ge.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ge.SheenTextureEnabled?(bt(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&ge.SheenTextureEnabled?bt(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,r){if(!this._isEnabled)return;let n=r.materialDefines,o=this._material.isFrozen;(!e.useUbo||!o||!e.isSync)&&((this._texture||this._textureRoughness)&&ge.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&It(this._texture,e,"sheen"),this._textureRoughness&&!n.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&It(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&ge.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!n.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&ge.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}};v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Ks.prototype,"isEnabled",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Ks.prototype,"linkSheenWithAlbedo",void 0);v([I()],Ks.prototype,"intensity",void 0);v([At()],Ks.prototype,"color",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Ks.prototype,"texture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Ks.prototype,"useRoughnessFromMainTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Ks.prototype,"roughness",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Ks.prototype,"textureRoughness",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Ks.prototype,"albedoScaling",void 0);var E0=class extends Qt{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,this.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_USE_GLTF_TEXTURES=!1}},ci=class extends Ti{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}constructor(e,t=!0){super(e,"PBRSubSurface",130,new E0,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=X.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=X.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this.translucencyColor=null,this._translucencyColorTexture=null,this.translucencyColorTexture=null,this._useGltfStyleTextures=!0,this.useGltfStyleTextures=!0,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&ge.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking()||this._translucencyColorTexture&&ge.TranslucencyColorTextureEnabled&&!this._translucencyColorTexture.isReadyOrNotBlocking())return!1;let i=this._getRefractionTexture(t);if(i&&ge.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0;return}if(e._areTexturesDirty){if(e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&ge.ThicknessTextureEnabled&&bt(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&ge.RefractionIntensityTextureEnabled&&bt(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&ge.TranslucencyIntensityTextureEnabled&&bt(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE"),this._translucencyColorTexture&&ge.TranslucencyColorTextureEnabled&&bt(this._translucencyColorTexture,e,"SS_TRANSLUCENCYCOLOR_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._refractionIntensityTexture,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._translucencyIntensityTexture,this._isRefractionEnabled&&t.texturesEnabled){let i=this._getRefractionTexture(t);i&&ge.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=i.isCube,e.SS_GAMMAREFRACTION=i.gammaSpace,e.SS_RGBDREFRACTION=i.isRGBD,e.SS_LINEARSPECULARREFRACTION=i.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&i.isCube?!i.invertZ:i.invertZ,e.SS_LODINREFRACTIONALPHA=i.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=i.isCube&&i.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,r){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;r.getRenderingMesh().getWorldMatrix().decompose(O.Vector3[0]);let n=Math.max(Math.abs(O.Vector3[0].x),Math.abs(O.Vector3[0].y),Math.abs(O.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*n,(this.maximumThickness-this.minimumThickness)*n)}bindForSubMesh(e,t,i,r){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;let n=r.materialDefines,o=this._material.isFrozen,a=this._material.realTimeFiltering,l=n.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!o||!e.isSync){if(this._thicknessTexture&&ge.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),It(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&ge.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),It(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyColorTexture&&ge.TranslucencyColorTextureEnabled&&n.SS_TRANSLUCENCYCOLOR_TEXTURE&&(e.updateFloat2("vTranslucencyColorInfos",this._translucencyColorTexture.coordinatesIndex,this._translucencyColorTexture.level),It(this._translucencyColorTexture,e,"translucencyColor")),c&&ge.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getRefractionTextureMatrix());let h=1;c.isCube||c.depth&&(h=c.depth);let u=c.getSize().width,d=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",c.level,1/d,h,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",u,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),a&&e.updateFloat2("vRefractionFilteringInfo",u,xe.Log2(u)),c.boundingBoxSize){let f=c;e.updateVector3("vRefractionPosition",f.boundingBoxPosition),e.updateVector3("vRefractionSize",f.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateColor4("vTranslucencyColor",this.translucencyColor??this.tintColor,0),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&ge.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&ge.RefractionIntensityTextureEnabled&&n.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&ge.TranslucencyIntensityTextureEnabled&&n.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),this._translucencyColorTexture&&ge.TranslucencyColorTextureEnabled&&n.SS_TRANSLUCENCYCOLOR_TEXTURE&&e.setTexture("translucencyColorSampler",this._translucencyColorTexture),c&&ge.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){ge.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e||this._refractionIntensityTexture===e||this._translucencyIntensityTexture===e||this._translucencyColorTexture===e}hasRenderTargetTextures(){return!!(ge.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture),this._translucencyColorTexture&&e.push(this._translucencyColorTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),this._translucencyColorTexture&&this._translucencyColorTexture.animations&&this._translucencyColorTexture.animations.length>0&&e.push(this._translucencyColorTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose(),this._translucencyColorTexture&&this._translucencyColorTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","translucencyColorSampler")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"},{name:"vTranslucencyColor",size:4,type:"vec4"},{name:"vTranslucencyColorInfos",size:2,type:"vec2"},{name:"translucencyColorMatrix",size:16,type:"mat4"}]}}};v([I(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"isRefractionEnabled",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"isTranslucencyEnabled",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"isDispersionEnabled",void 0);v([I(),Q("_markScenePrePassDirty")],ci.prototype,"isScatteringEnabled",void 0);v([I()],ci.prototype,"_scatteringDiffusionProfileIndex",void 0);v([I()],ci.prototype,"refractionIntensity",void 0);v([I()],ci.prototype,"translucencyIntensity",void 0);v([I()],ci.prototype,"useAlbedoToTintRefraction",void 0);v([I()],ci.prototype,"useAlbedoToTintTranslucency",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"thicknessTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"refractionTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"indexOfRefraction",void 0);v([I()],ci.prototype,"_volumeIndexOfRefraction",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"volumeIndexOfRefraction",null);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"invertRefractionY",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"linkRefractionWithTransparency",void 0);v([I()],ci.prototype,"minimumThickness",void 0);v([I()],ci.prototype,"maximumThickness",void 0);v([I()],ci.prototype,"useThicknessAsDepth",void 0);v([At()],ci.prototype,"tintColor",void 0);v([I()],ci.prototype,"tintColorAtDistance",void 0);v([I()],ci.prototype,"dispersion",void 0);v([At()],ci.prototype,"diffusionDistance",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"useMaskFromThicknessTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"refractionIntensityTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"translucencyIntensityTexture",void 0);v([At()],ci.prototype,"translucencyColor",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"translucencyColorTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],ci.prototype,"useGltfStyleTextures",void 0);var Vd={effect:null,subMesh:null},gT=class extends Qt{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}},Gt=class s extends Xs{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}constructor(e,t){super(e,t),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new De(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=s.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=X.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new X(0,0,0),this._albedoColor=new X(1,1,1),this._reflectivityColor=new X(1,1,1),this._reflectionColor=new X(1,1,1),this._emissiveColor=new X(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=s.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new _i(16),this._globalAmbientColor=new X(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new Sn(this),this.clearCoat=new cr(this),this.iridescence=new Kr(this),this.anisotropy=new va(this),this.sheen=new Ks(this),this.subSurface=new ci(this),this.detailMap=new xn(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),ge.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=Bd(this.getScene()),this.prePassConfiguration=new ca}get hasRenderTargetTextures(){return ge.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){return this._transparencyMode===s.PBRMATERIAL_OPAQUE||this._transparencyMode===s.PBRMATERIAL_ALPHATEST||this.subSurface?.disableAlphaBlending}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()}needAlphaTesting(){return this._forceAlphaTest?!0:this.subSurface?.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===s.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==s.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){this._uniformBufferLayoutBuilt||this.buildUniformLayout();let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(or.GetDefineNames,this._eventInfo),t.materialDefines=new gT(this._eventInfo.defineNames));let n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let o=this.getScene(),a=o.getEngine();if(n._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,o.texturesEnabled)){if(this._albedoTexture&&ge.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&ge.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&ge.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;let d=this._getReflectionTexture();if(d&&ge.ReflectionTextureEnabled){if(!d.isReadyOrNotBlocking())return!1;if(d.irradianceTexture){if(!d.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!d.sphericalPolynomial&&d.getInternalTexture()?._sphericalPolynomialPromise)return!1}if(this._lightmapTexture&&ge.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&ge.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(ge.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(a.getCaps().standardDerivatives&&this._bumpTexture&&ge.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&ge.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=n,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||n._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!a.getCaps().standardDerivatives&&!e.isVerticesDataPresent(y.NormalKind)&&(e.createNormals(!0),F.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));let l=t.effect,c=n._areLightsDisposed,h=this._prepareEffect(e,n,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),u=!1;if(h)if(this._onEffectCreatedObservable&&(Vd.effect=h,Vd.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Vd)),this.allowShaderHotSwapping&&l&&!h.isReady()){if(h=l,n.markAsUnprocessed(),u=this.isFrozen,c)return n._areLightsDisposed=!0,!1}else o.resetCachedMaterial(),t.setEffect(h,n,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(n._renderId=o.getRenderId(),r._wasPreviouslyReady=!u,r._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),!0)}isMetallicWorkflow(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)}_prepareEffect(e,t,i=null,r=null,n=null,o=null,a){if(this._prepareDefines(e,t,n,o,a),!t.isDirty)return null;t.markAsProcessed();let c=this.getScene().getEngine(),h=new ps,u=0;t.USESPHERICALINVERTEX&&h.addFallback(u++,"USESPHERICALINVERTEX"),t.FOG&&h.addFallback(u,"FOG"),t.SPECULARAA&&h.addFallback(u,"SPECULARAA"),t.POINTSIZE&&h.addFallback(u,"POINTSIZE"),t.LOGARITHMICDEPTH&&h.addFallback(u,"LOGARITHMICDEPTH"),t.PARALLAX&&h.addFallback(u,"PARALLAX"),t.PARALLAX_RHS&&h.addFallback(u,"PARALLAX_RHS"),t.PARALLAXOCCLUSION&&h.addFallback(u++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&h.addFallback(u++,"ENVIRONMENTBRDF"),t.TANGENT&&h.addFallback(u++,"TANGENT"),t.BUMP&&h.addFallback(u++,"BUMP"),u=bc(t,h,this._maxSimultaneousLights,u++),t.SPECULARTERM&&h.addFallback(u++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&h.addFallback(u++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&h.addFallback(u++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&h.addFallback(u++,"LIGHTMAP"),t.NORMAL&&h.addFallback(u++,"NORMAL"),t.AMBIENT&&h.addFallback(u++,"AMBIENT"),t.EMISSIVE&&h.addFallback(u++,"EMISSIVE"),t.VERTEXCOLOR&&h.addFallback(u++,"VERTEXCOLOR"),t.MORPHTARGETS&&h.addFallback(u++,"MORPHTARGETS"),t.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");let d=[y.PositionKind];t.NORMAL&&d.push(y.NormalKind),t.TANGENT&&d.push(y.TangentKind);for(let E=1;E<=6;++E)t["UV"+E]&&d.push(`uv${E===1?"":E}`);t.VERTEXCOLOR&&d.push(y.ColorKind),Cc(d,e,t,h),Ma(d,t),kf(d,e,t),Tc(d,e,t);let f="pbr",m=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],g=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],_=["Material","Scene","Mesh"],x={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=u,this._eventInfo.defines=t,this._eventInfo.uniforms=m,this._eventInfo.attributes=d,this._eventInfo.samplers=g,this._eventInfo.uniformBuffersNames=_,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=x,this._callbackPluginEventGeneric(or.PrepareEffect,this._eventInfo),ca.AddUniforms(m),ca.AddSamplers(g),er(m),rt&&(rt.PrepareUniforms(m,t),rt.PrepareSamplers(g,t)),Fa({uniformsNames:m,uniformBuffersNames:_,samplers:g,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});let b={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,m,_,g,t,d,b));let C=t.toString(),R=c.createEffect(f,{attributes:d,uniformsNames:m,uniformBuffersNames:_,samplers:g,defines:C,fallbacks:h,onCompiled:i,onError:r,indexParameters:x,processFinalCode:b.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS},c);return this._eventInfo.customCode=void 0,R}_prepareDefines(e,t,i=null,r=null,n=!1){let o=this.getScene(),a=o.getEngine();co(o,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,Na(o,t);let l=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(Sc(o,t,this.canRenderToMRT&&!l),Wf(o,t,l),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let c=1;c<=6;++c)t["MAINUV"+c]=!1;if(o.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,a.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&ge.DiffuseTextureEnabled?(bt(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&ge.AmbientTextureEnabled?(bt(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&ge.OpacityTextureEnabled?(bt(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;let c=this._getReflectionTexture();if(c&&ge.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=c.gammaSpace,t.RGBDREFLECTION=c.isRGBD,t.LODINREFLECTIONALPHA=c.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=c.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,a._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=c.coordinatesMode===z.INVCUBIC_MODE,t.REFLECTIONMAP_3D=c.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!c.invertZ:c.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,c.coordinatesMode){case z.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case z.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case z.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case z.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case z.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case z.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case z.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case z.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case z.CUBIC_MODE:case z.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!c.boundingBoxSize;break}c.coordinatesMode!==z.SKYBOX_MODE&&(c.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):c.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||a.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;this._lightmapTexture&&ge.LightmapTextureEnabled?(bt(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&ge.EmissiveTextureEnabled?(bt(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,ge.SpecularTextureEnabled?(this._metallicTexture?(bt(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(bt(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture?(t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture,this._metallicReflectanceTexture?(bt(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(bt(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1):(t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1),this._microSurfaceTexture?bt(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1):(t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1),a.getCaps().standardDerivatives&&this._bumpTexture&&ge.BumpTextureEnabled&&!this._disableBumpMap?(bt(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&ge.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAX_RHS=o.useRightHandedSystem,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAX_RHS=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&ge.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===s.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===s.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=a.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1===0?".":""}`,t.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(Da(e,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t,this._applyDecalMapAfterDetailMap),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(y.NormalKind),t.DEBUGMODE=this._debugMode),Oa(o,a,this,t,!!i,r,n),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),wa(e,t,!0,!0,!0,this._transparencyMode!==s.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){let r=ie({clipPlane:!1,useInstances:!1},i);this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(or.GetDefineNames,this._eventInfo);let n=new gT(this._eventInfo.defineNames),o=this._prepareEffect(e,n,void 0,void 0,r.useInstances,r.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(Vd.effect=o,Vd.subMesh=null,this._onEffectCreatedObservable.notifyObservers(Vd)),o.isReady()?t&&t(this):o.onCompileObservable.add(()=>{t&&t(this)})}buildUniformLayout(){let e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){let r=this.getScene(),n=i.materialDefines;if(!n)return;let o=i.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e);let a=r.getEngine();this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));let l=this._mustRebind(r,o,i,t.visibility);ao(t,this._activeEffect,this.prePassConfiguration);let c=null,h=this._uniformBuffer;if(l){if(this.bindViewProjection(o),c=this._getReflectionTexture(),!h.useUbo||!this.isFrozen||!h.isSync||i._drawWrapper._forceRebindOnNextCall){if(r.texturesEnabled){if(this._albedoTexture&&ge.DiffuseTextureEnabled&&(h.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),It(this._albedoTexture,h,"albedo")),this._ambientTexture&&ge.AmbientTextureEnabled&&(h.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),It(this._ambientTexture,h,"ambient")),this._opacityTexture&&ge.OpacityTextureEnabled&&(h.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),It(this._opacityTexture,h,"opacity")),c&&ge.ReflectionTextureEnabled){if(h.updateMatrix("reflectionMatrix",c.getReflectionTextureMatrix()),h.updateFloat2("vReflectionInfos",c.level,0),c.boundingBoxSize){let u=c;h.updateVector3("vReflectionPosition",u.boundingBoxPosition),h.updateVector3("vReflectionSize",u.boundingBoxSize)}if(this.realTimeFiltering){let u=c.getSize().width;h.updateFloat2("vReflectionFilteringInfo",u,xe.Log2(u))}if(!n.USEIRRADIANCEMAP){let u=c.sphericalPolynomial;if(n.USESPHERICALFROMREFLECTIONMAP&&u)if(n.SPHERICAL_HARMONICS){let d=u.preScaledHarmonics;h.updateVector3("vSphericalL00",d.l00),h.updateVector3("vSphericalL1_1",d.l1_1),h.updateVector3("vSphericalL10",d.l10),h.updateVector3("vSphericalL11",d.l11),h.updateVector3("vSphericalL2_2",d.l2_2),h.updateVector3("vSphericalL2_1",d.l2_1),h.updateVector3("vSphericalL20",d.l20),h.updateVector3("vSphericalL21",d.l21),h.updateVector3("vSphericalL22",d.l22)}else h.updateFloat3("vSphericalX",u.x.x,u.x.y,u.x.z),h.updateFloat3("vSphericalY",u.y.x,u.y.y,u.y.z),h.updateFloat3("vSphericalZ",u.z.x,u.z.y,u.z.z),h.updateFloat3("vSphericalXX_ZZ",u.xx.x-u.zz.x,u.xx.y-u.zz.y,u.xx.z-u.zz.z),h.updateFloat3("vSphericalYY_ZZ",u.yy.x-u.zz.x,u.yy.y-u.zz.y,u.yy.z-u.zz.z),h.updateFloat3("vSphericalZZ",u.zz.x,u.zz.y,u.zz.z),h.updateFloat3("vSphericalXY",u.xy.x,u.xy.y,u.xy.z),h.updateFloat3("vSphericalYZ",u.yz.x,u.yz.y,u.yz.z),h.updateFloat3("vSphericalZX",u.zx.x,u.zx.y,u.zx.z)}h.updateFloat3("vReflectionMicrosurfaceInfos",c.getSize().width,c.lodGenerationScale,c.lodGenerationOffset)}this._emissiveTexture&&ge.EmissiveTextureEnabled&&(h.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),It(this._emissiveTexture,h,"emissive")),this._lightmapTexture&&ge.LightmapTextureEnabled&&(h.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),It(this._lightmapTexture,h,"lightmap")),ge.SpecularTextureEnabled&&(this._metallicTexture?(h.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),It(this._metallicTexture,h,"reflectivity")):this._reflectivityTexture&&(h.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),It(this._reflectivityTexture,h,"reflectivity")),this._metallicReflectanceTexture&&(h.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),It(this._metallicReflectanceTexture,h,"metallicReflectance")),this._reflectanceTexture&&n.REFLECTANCE&&(h.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),It(this._reflectanceTexture,h,"reflectance")),this._microSurfaceTexture&&(h.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),It(this._microSurfaceTexture,h,"microSurfaceSampler"))),this._bumpTexture&&a.getCaps().standardDerivatives&&ge.BumpTextureEnabled&&!this._disableBumpMap&&(h.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),It(this._bumpTexture,h,"bump"),r._mirroredCameraPosition?h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&h.updateFloat("pointSize",this.pointSize),n.METALLICWORKFLOW){gt.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,gt.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,h.updateColor4("vReflectivityColor",gt.Color3[0],1);let u=this.subSurface?._indexOfRefraction??1.5,d=1,f=Math.pow((u-d)/(u+d),2);this._metallicReflectanceColor.scaleToRef(f*this._metallicF0Factor,gt.Color3[0]);let m=this._metallicF0Factor;h.updateColor4("vMetallicReflectanceFactors",gt.Color3[0],m)}else h.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);h.updateColor3("vEmissiveColor",ge.EmissiveTextureEnabled?this._emissiveColor:X.BlackReadOnly),h.updateColor3("vReflectionColor",this._reflectionColor),!n.SS_REFRACTION&&this.subSurface?._linkRefractionWithTransparency?h.updateColor4("vAlbedoColor",this._albedoColor,1):h.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*r.environmentIntensity,this._lightingInfos.w=this._specularIntensity,h.updateVector4("vLightingIntensity",this._lightingInfos),r.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),h.updateColor3("vAmbientColor",this._globalAmbientColor),h.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}r.texturesEnabled&&(this._albedoTexture&&ge.DiffuseTextureEnabled&&h.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&ge.AmbientTextureEnabled&&h.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&ge.OpacityTextureEnabled&&h.setTexture("opacitySampler",this._opacityTexture),c&&ge.ReflectionTextureEnabled&&(n.LODBASEDMICROSFURACE?h.setTexture("reflectionSampler",c):(h.setTexture("reflectionSampler",c._lodTextureMid||c),h.setTexture("reflectionSamplerLow",c._lodTextureLow||c),h.setTexture("reflectionSamplerHigh",c._lodTextureHigh||c)),n.USEIRRADIANCEMAP&&h.setTexture("irradianceSampler",c.irradianceTexture)),n.ENVIRONMENTBRDF&&h.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&ge.EmissiveTextureEnabled&&h.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&ge.LightmapTextureEnabled&&h.setTexture("lightmapSampler",this._lightmapTexture),ge.SpecularTextureEnabled&&(this._metallicTexture?h.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&h.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&h.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&n.REFLECTANCE&&h.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&h.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&a.getCaps().standardDerivatives&&ge.BumpTextureEnabled&&!this._disableBumpMap&&h.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),Yi(this._activeEffect,this,r),this.bindEyePosition(o)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&lo(r,t,this._activeEffect,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==Te.FOGMODE_NONE||c||this.subSurface.refractionTexture||t.receiveShadows||n.PREPASS)&&this.bindView(o),Ms(r,t,this._activeEffect,!0),n.NUM_MORPH_INFLUENCERS&&Vr(t,this._activeEffect),n.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(o,n.INSTANCES),this._imageProcessingConfiguration.bind(this._activeEffect),Br(n,this._activeEffect,r)),this._afterBind(t,this._activeEffect,i),h.update()}getAnimatables(){let e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){let e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)}setPrePassRenderer(){if(!this.subSurface?.isScatteringEnabled)return!1;let e=this.getScene().enableSubSurfaceForPrePass();return e&&(e.enabled=!0),!0}dispose(e,t){t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),this._albedoTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._metallicTexture?.dispose(),this._reflectivityTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._metallicReflectanceTexture?.dispose(),this._reflectanceTexture?.dispose(),this._microSurfaceTexture?.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}};Gt.PBRMATERIAL_OPAQUE=se.MATERIAL_OPAQUE;Gt.PBRMATERIAL_ALPHATEST=se.MATERIAL_ALPHATEST;Gt.PBRMATERIAL_ALPHABLEND=se.MATERIAL_ALPHABLEND;Gt.PBRMATERIAL_ALPHATESTANDBLEND=se.MATERIAL_ALPHATESTANDBLEND;Gt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0;Gt.LIGHTFALLOFF_PHYSICAL=0;Gt.LIGHTFALLOFF_GLTF=1;Gt.LIGHTFALLOFF_STANDARD=2;v([Sg()],Gt.prototype,"_imageProcessingConfiguration",void 0);v([Q("_markAllSubMeshesAsMiscDirty")],Gt.prototype,"debugMode",void 0);var Pe=class s extends Gt{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===Gt.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=Gt.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=Gt.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===Gt.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=Gt.LIGHTFALLOFF_GLTF:this._lightFalloff=Gt.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t){super(e,t),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=s.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=X.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new X(0,0,0),this.albedoColor=new X(1,1,1),this.reflectivityColor=new X(1,1,1),this.reflectionColor=new X(1,1,1),this.emissiveColor=new X(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=Bd(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){let r=ae.Clone(()=>new s(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.id=e,r.name=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}serialize(){let e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){let r=ae.Parse(()=>new s(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),se._ParsePlugins(e,r,t,i),e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}};Pe.PBRMATERIAL_OPAQUE=Gt.PBRMATERIAL_OPAQUE;Pe.PBRMATERIAL_ALPHATEST=Gt.PBRMATERIAL_ALPHATEST;Pe.PBRMATERIAL_ALPHABLEND=Gt.PBRMATERIAL_ALPHABLEND;Pe.PBRMATERIAL_ALPHATESTANDBLEND=Gt.PBRMATERIAL_ALPHATESTANDBLEND;Pe.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=Gt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS;v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"directIntensity",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"emissiveIntensity",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"environmentIntensity",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"specularIntensity",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"disableBumpMap",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"albedoTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"ambientTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"ambientTextureStrength",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"ambientTextureImpactOnAnalyticalLights",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesAndMiscDirty")],Pe.prototype,"opacityTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"reflectionTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"emissiveTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"reflectivityTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"metallicTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"metallic",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"roughness",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"metallicF0Factor",void 0);v([At(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"metallicReflectanceColor",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"metallicReflectanceTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"reflectanceTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"microSurfaceTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"bumpTexture",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty",null)],Pe.prototype,"lightmapTexture",void 0);v([At("ambient"),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"ambientColor",void 0);v([At("albedo"),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"albedoColor",void 0);v([At("reflectivity"),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"reflectivityColor",void 0);v([At("reflection"),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"reflectionColor",void 0);v([At("emissive"),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"emissiveColor",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"microSurface",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useLightmapAsShadowmap",void 0);v([I(),Q("_markAllSubMeshesAsTexturesAndMiscDirty")],Pe.prototype,"useAlphaFromAlbedoTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesAndMiscDirty")],Pe.prototype,"forceAlphaTest",void 0);v([I(),Q("_markAllSubMeshesAsTexturesAndMiscDirty")],Pe.prototype,"alphaCutOff",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useSpecularOverAlpha",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useRoughnessFromMetallicTextureAlpha",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useRoughnessFromMetallicTextureGreen",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useMetallnessFromMetallicTextureBlue",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useAmbientInGrayScale",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0);v([I()],Pe.prototype,"usePhysicalLightFalloff",null);v([I()],Pe.prototype,"useGLTFLightFalloff",null);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useRadianceOverAlpha",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useObjectSpaceNormalMap",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useParallax",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useParallaxOcclusion",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"parallaxScaleBias",void 0);v([I(),Q("_markAllSubMeshesAsLightsDirty")],Pe.prototype,"disableLighting",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"forceIrradianceInFragment",void 0);v([I(),Q("_markAllSubMeshesAsLightsDirty")],Pe.prototype,"maxSimultaneousLights",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"invertNormalMapX",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"invertNormalMapY",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"twoSidedLighting",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useAlphaFresnel",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useLinearAlphaFresnel",void 0);v([Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"environmentBRDFTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"forceNormalForward",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"enableSpecularAntiAliasing",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useHorizonOcclusion",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Pe.prototype,"useRadianceOcclusion",void 0);v([I(),Q("_markAllSubMeshesAsMiscDirty")],Pe.prototype,"unlit",void 0);v([I(),Q("_markAllSubMeshesAsMiscDirty")],Pe.prototype,"applyDecalMapAfterDetailMap",void 0);P("BABYLON.PBRMaterial",Pe);var A0=class{constructor(){this.supportCascades=!0}canLoad(e){return e.endsWith(".dds")}loadCubeData(e,t,i,r){let n=t.getEngine(),o,a=!1,l=1e3;if(Array.isArray(e))for(let c=0;c<e.length;c++){let h=e[c];o=il.GetDDSInfo(h),t.width=o.width,t.height=o.height,a=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,n._unpackFlipY(o.isCompressed),il.UploadDDSLevels(n,t,h,o,a,6,-1,c),!o.isFourCC&&o.mipmapCount===1?n.generateMipMapsForCubemap(t):l=o.mipmapCount-1}else{let c=e;o=il.GetDDSInfo(c),t.width=o.width,t.height=o.height,i&&(o.sphericalPolynomial=new vs),a=(o.isRGB||o.isLuminance||o.mipmapCount>1)&&t.generateMipMaps,n._unpackFlipY(o.isCompressed),il.UploadDDSLevels(n,t,c,o,a,6),!o.isFourCC&&o.mipmapCount===1?n.generateMipMapsForCubemap(t,!1):l=o.mipmapCount-1}n._setCubeMapTextureParams(t,a,l),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r({isDDS:!0,width:t.width,info:o,data:e,texture:t})}loadData(e,t,i){let r=il.GetDDSInfo(e),n=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&t.generateMipMaps&&r.width>>r.mipmapCount-1===1;i(r.width,r.height,n,r.isFourCC,()=>{il.UploadDDSLevels(t.getEngine(),t,e,r,n,1)})}};K._TextureLoaders.push(new A0);var I0=class{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".env")}loadCubeData(e,t,i,r,n){if(Array.isArray(e))return;let o=wv(e);if(o){t.width=o.width,t.height=o.width;try{Fv(t,o),ZB(t,e,o).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()},a=>{n?.("Can not upload environment levels",a)})}catch(a){n?.("Can not upload environment file",a)}}else n&&n("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}};K._TextureLoaders.push(new I0);var _T=(()=>{class s{constructor(t,i){if(this.data=t,this.isInvalid=!1,!s.IsValid(t)){this.isInvalid=!0,F.Error("texture missing KTX identifier");return}let r=Uint32Array.BYTES_PER_ELEMENT,n=new DataView(this.data.buffer,this.data.byteOffset+12,13*r),a=n.getUint32(0,!0)===67305985;if(this.glType=n.getUint32(1*r,a),this.glTypeSize=n.getUint32(2*r,a),this.glFormat=n.getUint32(3*r,a),this.glInternalFormat=n.getUint32(4*r,a),this.glBaseInternalFormat=n.getUint32(5*r,a),this.pixelWidth=n.getUint32(6*r,a),this.pixelHeight=n.getUint32(7*r,a),this.pixelDepth=n.getUint32(8*r,a),this.numberOfArrayElements=n.getUint32(9*r,a),this.numberOfFaces=n.getUint32(10*r,a),this.numberOfMipmapLevels=n.getUint32(11*r,a),this.bytesOfKeyValueData=n.getUint32(12*r,a),this.glType!==0){F.Error("only compressed formats currently supported"),this.isInvalid=!0;return}else this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){F.Error("only 2D textures currently supported"),this.isInvalid=!0;return}if(this.numberOfArrayElements!==0){F.Error("texture arrays not currently supported"),this.isInvalid=!0;return}if(this.numberOfFaces!==i){F.Error("number of faces expected"+i+", but found "+this.numberOfFaces),this.isInvalid=!0;return}this.loadType=s.COMPRESSED_2D}uploadLevels(t,i){switch(this.loadType){case s.COMPRESSED_2D:this._upload2DCompressedLevels(t,i);break;case s.TEX_2D:case s.COMPRESSED_3D:case s.TEX_3D:}}_upload2DCompressedLevels(t,i){let r=s.HEADER_LEN+this.bytesOfKeyValueData,n=this.pixelWidth,o=this.pixelHeight,a=i?this.numberOfMipmapLevels:1;for(let l=0;l<a;l++){let c=new Int32Array(this.data.buffer,this.data.byteOffset+r,1)[0];r+=4;for(let h=0;h<this.numberOfFaces;h++){let u=new Uint8Array(this.data.buffer,this.data.byteOffset+r,c);t.getEngine()._uploadCompressedDataToTextureDirectly(t,t.format,n,o,u,h,l),r+=c,r+=3-(c+3)%4}n=Math.max(1,n*.5),o=Math.max(1,o*.5)}}static IsValid(t){if(t.byteLength>=12){let i=new Uint8Array(t.buffer,t.byteOffset,12);if(i[0]===171&&i[1]===75&&i[2]===84&&i[3]===88&&i[4]===32&&i[5]===49&&i[6]===49&&i[7]===187&&i[8]===13&&i[9]===10&&i[10]===26&&i[11]===10)return!0}return!1}}return s.HEADER_LEN=12+13*4,s.COMPRESSED_2D=0,s.COMPRESSED_3D=1,s.TEX_2D=2,s.TEX_3D=3,s})();var R0=class{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(t=>({workerPromise:Promise.resolve(t),idle:!0}))}dispose(){for(let e of this._workerInfos)e.workerPromise.then(t=>{t.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(let t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(i=>{t(i,()=>{let r=this._pendingActions.shift();r?this._execute(e,r):e.idle=!0})})}},xT=(()=>{class s extends R0{constructor(t,i,r=s.DefaultOptions){super([]),this._maxWorkers=t,this._createWorkerAsync=i,this._options=r}push(t){if(!this._executeOnIdleWorker(t))if(this._workerInfos.length<this._maxWorkers){let i={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(i),this._execute(i,t)}else this._pendingActions.push(t)}_execute(t,i){t.timeoutId&&(clearTimeout(t.timeoutId),delete t.timeoutId),super._execute(t,(r,n)=>{i(r,()=>{n(),t.idle&&(t.timeoutId=setTimeout(()=>{t.workerPromise.then(a=>{a.terminate()});let o=this._workerInfos.indexOf(t);o!==-1&&this._workerInfos.splice(o,1)},this._options.idleTimeElapsedBeforeRelease))})})}}return s.DefaultOptions={idleTimeElapsedBeforeRelease:1e3},s})();var Mm=function(s){return s[s.ASTC_4X4_RGBA=0]="ASTC_4X4_RGBA",s[s.BC7_RGBA=1]="BC7_RGBA",s[s.BC3_RGBA=2]="BC3_RGBA",s[s.BC1_RGB=3]="BC1_RGB",s[s.PVRTC1_4_RGBA=4]="PVRTC1_4_RGBA",s[s.PVRTC1_4_RGB=5]="PVRTC1_4_RGB",s[s.ETC2_RGBA=6]="ETC2_RGBA",s[s.ETC1_RGB=7]="ETC1_RGB",s[s.RGBA32=8]="RGBA32",s[s.R8=9]="R8",s[s.RG8=10]="RG8",s}(Mm||{}),P0=function(s){return s[s.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",s[s.COMPRESSED_RGBA_ASTC_4X4_KHR=37808]="COMPRESSED_RGBA_ASTC_4X4_KHR",s[s.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",s[s.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",s[s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",s[s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",s[s.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",s[s.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",s[s.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",s[s.RGBA8Format=32856]="RGBA8Format",s[s.R8Format=33321]="R8Format",s[s.RG8Format=33323]="RG8Format",s}(P0||{});function Dm(s,e){let t=e?.jsDecoderModule||KTX2DECODER;s&&(s.wasmUASTCToASTC&&(t.LiteTranscoder_UASTC_ASTC.WasmModuleURL=s.wasmUASTCToASTC),s.wasmUASTCToBC7&&(t.LiteTranscoder_UASTC_BC7.WasmModuleURL=s.wasmUASTCToBC7),s.wasmUASTCToRGBA_UNORM&&(t.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=s.wasmUASTCToRGBA_UNORM),s.wasmUASTCToRGBA_SRGB&&(t.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=s.wasmUASTCToRGBA_SRGB),s.wasmUASTCToR8_UNORM&&(t.LiteTranscoder_UASTC_R8_UNORM.WasmModuleURL=s.wasmUASTCToR8_UNORM),s.wasmUASTCToRG8_UNORM&&(t.LiteTranscoder_UASTC_RG8_UNORM.WasmModuleURL=s.wasmUASTCToRG8_UNORM),s.jsMSCTranscoder&&(t.MSCTranscoder.JSModuleURL=s.jsMSCTranscoder),s.wasmMSCTranscoder&&(t.MSCTranscoder.WasmModuleURL=s.wasmMSCTranscoder),s.wasmZSTDDecoder&&(t.ZSTDDecoder.WasmModuleURL=s.wasmZSTDDecoder)),e&&(e.wasmUASTCToASTC&&(t.LiteTranscoder_UASTC_ASTC.WasmBinary=e.wasmUASTCToASTC),e.wasmUASTCToBC7&&(t.LiteTranscoder_UASTC_BC7.WasmBinary=e.wasmUASTCToBC7),e.wasmUASTCToRGBA_UNORM&&(t.LiteTranscoder_UASTC_RGBA_UNORM.WasmBinary=e.wasmUASTCToRGBA_UNORM),e.wasmUASTCToRGBA_SRGB&&(t.LiteTranscoder_UASTC_RGBA_SRGB.WasmBinary=e.wasmUASTCToRGBA_SRGB),e.wasmUASTCToR8_UNORM&&(t.LiteTranscoder_UASTC_R8_UNORM.WasmBinary=e.wasmUASTCToR8_UNORM),e.wasmUASTCToRG8_UNORM&&(t.LiteTranscoder_UASTC_RG8_UNORM.WasmBinary=e.wasmUASTCToRG8_UNORM),e.jsMSCTranscoder&&(t.MSCTranscoder.JSModule=e.jsMSCTranscoder),e.wasmMSCTranscoder&&(t.MSCTranscoder.WasmBinary=e.wasmMSCTranscoder),e.wasmZSTDDecoder&&(t.ZSTDDecoder.WasmBinary=e.wasmZSTDDecoder))}function bV(s){typeof s>"u"&&typeof KTX2DECODER<"u"&&(s=KTX2DECODER);let e;onmessage=t=>{if(t.data)switch(t.data.action){case"init":{let i=t.data.urls;i&&(i.jsDecoderModule&&typeof s>"u"&&(importScripts(i.jsDecoderModule),s=KTX2DECODER),Dm(i)),t.data.wasmBinaries&&Dm(void 0,Kt(ie({},t.data.wasmBinaries),{jsDecoderModule:s})),e=new s.KTX2Decoder,postMessage({action:"init"});break}case"setDefaultDecoderOptions":{s.KTX2Decoder.DefaultDecoderOptions=t.data.options;break}case"decode":e.decode(t.data.data,t.data.caps,t.data.options).then(i=>{let r=[];for(let n=0;n<i.mipmaps.length;++n){let o=i.mipmaps[n];o&&o.data&&r.push(o.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:i},r)}).catch(i=>{postMessage({action:"decoded",success:!1,msg:i})});break}}}function SV(s,e,t){return new Promise((i,r)=>{let n=a=>{s.removeEventListener("error",n),s.removeEventListener("message",o),r(a)},o=a=>{a.data.action==="init"&&(s.removeEventListener("error",n),s.removeEventListener("message",o),i(s))};s.addEventListener("error",n),s.addEventListener("message",o),s.postMessage({action:"init",urls:t,wasmBinaries:e})})}var M0=class{constructor(){this._isDirty=!0,this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=!0,this._ktx2DecoderOptions={}}get isDirty(){return this._isDirty}get useRGBAIfASTCBC7NotAvailableWhenUASTC(){return this._useRGBAIfASTCBC7NotAvailableWhenUASTC}set useRGBAIfASTCBC7NotAvailableWhenUASTC(e){this._useRGBAIfASTCBC7NotAvailableWhenUASTC!==e&&(this._useRGBAIfASTCBC7NotAvailableWhenUASTC=e,this._isDirty=!0)}get useRGBAIfOnlyBC1BC3AvailableWhenUASTC(){return this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC}set useRGBAIfOnlyBC1BC3AvailableWhenUASTC(e){this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC!==e&&(this._useRGBAIfOnlyBC1BC3AvailableWhenUASTC=e,this._isDirty=!0)}get forceRGBA(){return this._forceRGBA}set forceRGBA(e){this._forceRGBA!==e&&(this._forceRGBA=e,this._isDirty=!0)}get forceR8(){return this._forceR8}set forceR8(e){this._forceR8!==e&&(this._forceR8=e,this._isDirty=!0)}get forceRG8(){return this._forceRG8}set forceRG8(e){this._forceRG8!==e&&(this._forceRG8=e,this._isDirty=!0)}get bypassTranscoders(){return this._bypassTranscoders}set bypassTranscoders(e){this._bypassTranscoders!==e&&(this._bypassTranscoders=e,this._isDirty=!0)}_getKTX2DecoderOptions(){if(!this._isDirty)return this._ktx2DecoderOptions;this._isDirty=!1;let e={useRGBAIfASTCBC7NotAvailableWhenUASTC:this._useRGBAIfASTCBC7NotAvailableWhenUASTC,forceRGBA:this._forceRGBA,forceR8:this._forceR8,forceRG8:this._forceRG8,bypassTranscoders:this._bypassTranscoders};return this.useRGBAIfOnlyBC1BC3AvailableWhenUASTC&&(e.transcodeFormatDecisionTree={UASTC:{transcodeFormat:[Mm.BC1_RGB,Mm.BC3_RGBA],yes:{transcodeFormat:Mm.RGBA32,engineFormat:P0.RGBA8Format,roundToMultiple4:!1}}}),this._ktx2DecoderOptions=e,e}},sl=class s{static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static _Initialize(e){if(s._WorkerPoolPromise||s._DecoderModulePromise)return;let t={jsDecoderModule:H.GetBabylonScriptURL(this.URLConfig.jsDecoderModule,!0),wasmUASTCToASTC:H.GetBabylonScriptURL(this.URLConfig.wasmUASTCToASTC,!0),wasmUASTCToBC7:H.GetBabylonScriptURL(this.URLConfig.wasmUASTCToBC7,!0),wasmUASTCToRGBA_UNORM:H.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_UNORM,!0),wasmUASTCToRGBA_SRGB:H.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRGBA_SRGB,!0),wasmUASTCToR8_UNORM:H.GetBabylonScriptURL(this.URLConfig.wasmUASTCToR8_UNORM,!0),wasmUASTCToRG8_UNORM:H.GetBabylonScriptURL(this.URLConfig.wasmUASTCToRG8_UNORM,!0),jsMSCTranscoder:H.GetBabylonScriptURL(this.URLConfig.jsMSCTranscoder,!0),wasmMSCTranscoder:H.GetBabylonScriptURL(this.URLConfig.wasmMSCTranscoder,!0),wasmZSTDDecoder:H.GetBabylonScriptURL(this.URLConfig.wasmZSTDDecoder,!0)};e&&typeof Worker=="function"&&typeof URL<"u"?s._WorkerPoolPromise=new Promise(i=>{let r=`${Dm}(${bV})()`,n=URL.createObjectURL(new Blob([r],{type:"application/javascript"}));i(new xT(e,()=>SV(new Worker(n),void 0,t)))}):typeof s._KTX2DecoderModule>"u"?s._DecoderModulePromise=H.LoadBabylonScriptAsync(t.jsDecoderModule).then(()=>(s._KTX2DecoderModule=KTX2DECODER,s._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,s._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,Dm(t,s._KTX2DecoderModule),new s._KTX2DecoderModule.KTX2Decoder)):(s._KTX2DecoderModule.MSCTranscoder.UseFromWorkerThread=!1,s._KTX2DecoderModule.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,s._DecoderModulePromise=Promise.resolve(new s._KTX2DecoderModule.KTX2Decoder))}constructor(e,t=s.DefaultNumWorkers){this._engine=e;let i=typeof t=="object"&&t.workerPool||s.WorkerPool;if(i)s._WorkerPoolPromise=Promise.resolve(i);else{typeof t=="object"?s._KTX2DecoderModule=t?.binariesAndModulesContainer?.jsDecoderModule:typeof KTX2DECODER<"u"&&(s._KTX2DecoderModule=KTX2DECODER);let r=typeof t=="number"?t:t.numWorkers??s.DefaultNumWorkers;s._Initialize(r)}}_uploadAsync(e,t,i){let r=this._engine.getCaps(),n={astc:!!r.astc,bptc:!!r.bptc,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,etc1:!!r.etc1};if(s._WorkerPoolPromise)return s._WorkerPoolPromise.then(o=>new Promise((a,l)=>{o.push((c,h)=>{let u=m=>{c.removeEventListener("error",u),c.removeEventListener("message",d),l(m),h()},d=m=>{if(m.data.action==="decoded"){if(c.removeEventListener("error",u),c.removeEventListener("message",d),!m.data.success)l({message:m.data.msg});else try{this._createTexture(m.data.decodedData,t,i),a()}catch(g){l({message:g})}h()}};c.addEventListener("error",u),c.addEventListener("message",d),c.postMessage({action:"setDefaultDecoderOptions",options:s.DefaultDecoderOptions._getKTX2DecoderOptions()});let f=new Uint8Array(e.byteLength);f.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),c.postMessage({action:"decode",data:f,caps:n,options:i},[f.buffer])})}));if(s._DecoderModulePromise)return s._DecoderModulePromise.then(o=>(s.DefaultDecoderOptions.isDirty&&(s._KTX2DecoderModule.KTX2Decoder.DefaultDecoderOptions=s.DefaultDecoderOptions._getKTX2DecoderOptions()),new Promise((a,l)=>{o.decode(e,r).then(c=>{this._createTexture(c,t),a()}).catch(c=>{l({message:c})})})));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName);let n=!0;switch(e.transcodedFormat){case 32856:t.type=0,t.format=5;break;case 33321:t.type=0,t.format=6;break;case 33323:t.type=0,t.format=7;break;default:t.format=e.transcodedFormat,n=!1;break}if(t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let o=0;o<e.mipmaps.length;++o){let a=e.mipmaps[o];if(!a||!a.data)throw new Error("KTX2 container - could not transcode one of the image");n?(t.width=a.width,t.height=a.height,this._engine._uploadDataToTextureDirectly(t,a.data,0,o,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,a.width,a.height,a.data,0,o)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){let t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===50&&t[6]===48&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}};sl.URLConfig={jsDecoderModule:"https://cdn.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,wasmUASTCToR8_UNORM:null,wasmUASTCToRG8_UNORM:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null};sl.DefaultNumWorkers=sl.GetDefaultNumWorkers();sl.DefaultDecoderOptions=new M0;function A8(s){switch(s){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}var D0=class{constructor(){this.supportCascades=!1}canLoad(e,t){return e.endsWith(".ktx")||e.endsWith(".ktx2")||t==="image/ktx"||t==="image/ktx2"}loadCubeData(e,t,i,r){if(Array.isArray(e))return;t._invertVScale=!t.invertY;let n=t.getEngine(),o=new _T(e,6),a=o.numberOfMipmapLevels>1&&t.generateMipMaps;n._unpackFlipY(!0),o.uploadLevels(t,t.generateMipMaps),t.width=o.pixelWidth,t.height=o.pixelHeight,n._setCubeMapTextureParams(t,a,o.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()}loadData(e,t,i,r){if(_T.IsValid(e)){t._invertVScale=!t.invertY;let n=new _T(e,1),o=A8(n.glInternalFormat);o?(t.format=o,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=n.glInternalFormat,i(n.pixelWidth,n.pixelHeight,t.generateMipMaps,!0,()=>{n.uploadLevels(t,t.generateMipMaps)},n.isInvalid)}else sl.IsValid(e)?new sl(t.getEngine())._uploadAsync(e,t,r).then(()=>{i(t.width,t.height,t.generateMipMaps,!0,()=>{},!1)},o=>{F.Warn(`Failed to load KTX2 texture data: ${o.message}`),i(0,0,!1,!1,()=>{},!0)}):(F.Error("texture missing KTX identifier"),i(0,0,!1,!1,()=>{},!0))}};K._TextureLoaders.push(new D0);var Om=class s extends wi{constructor(e,t,i){super(e,p.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=q.Identity(),this._referencedPosition=new p,this._trackingState=Sd.NOT_TRACKING,this.onXRCameraInitializedObservable=new U,this.onBeforeCameraTeleport=new U,this.onAfterCameraTeleport=new U,this.onTrackingStateChanged=new U,this.compensateOnFirstFrame=!0,this._rotate180=new q(0,1,0,0),this.minZ=.1,this.rotationQuaternion=new q,this.cameraRigMode=Ce.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._deferOnly=!0,this._xrSessionManager.onXRSessionInit.add(()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame,this._xrSessionManager.onWorldScaleFactorChangedObservable.add(()=>{this._xrSessionManager.currentFrame&&this._updateDepthNearFar()})}),this._xrSessionManager.onXRFrameObservable.add(()=>{this._firstFrame&&this._updateFromXRSession(),this.onXRCameraInitializedObservable.hasObservers()&&(this.onXRCameraInitializedObservable.notifyObservers(this),this.onXRCameraInitializedObservable.clear()),this._deferredUpdated&&(this.position.copyFrom(this._deferredPositionUpdate),this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)),this._updateReferenceSpace(),this._updateFromXRSession()},void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){let e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y*this._xrSessionManager.worldScalingFactor:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new Dr(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new Dr(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){if(!e||e===this)return;e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,q.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace()}getClassName(){return"WebXRCamera"}setTarget(e){let t=O.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();let i=Math.atan2(t.x,t.z);this.rotationQuaternion.toEulerAnglesToRef(t),q.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0}_updateDepthNearFar(){let e=(this.maxZ||1e4)*this._xrSessionManager.worldScalingFactor,t={depthFar:e,depthNear:this.minZ};this._xrSessionManager.updateRenderState(t),this._cache.minZ=this.minZ,this._cache.maxZ=e}_updateFromXRSession(){let e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e){this._setTrackingState(Sd.NOT_TRACKING);return}let t=e.emulatedPosition?Sd.TRACKING_LOST:Sd.TRACKING;if(this._setTrackingState(t),(this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ)&&this._updateDepthNearFar(),e.transform){let i=e.transform.orientation;if(e.transform.orientation.x===void 0)return;let r=e.transform.position;this._referencedPosition.set(r.x,r.y,r.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._referenceQuaternion.set(i.x,i.y,i.z,i.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach((i,r)=>{let n=this.rigCameras[r];!n.isLeftCamera&&!n.isRightCamera&&(i.eye==="right"?n._isRightCamera=!0:i.eye==="left"&&(n._isLeftCamera=!0));let o=this.getScene().customRenderTargets;for(let u=0;u<o.length;u++){let d=o[u];n.customRenderTargets.indexOf(d)===-1&&n.customRenderTargets.push(d)}let a=i.transform.position,l=i.transform.orientation;n.parent=this.parent,n.position.set(a.x,a.y,a.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),n.rotationQuaternion.set(l.x,l.y,l.z,l.w),this._scene.useRightHandedSystem?n.rotationQuaternion.multiplyInPlace(this._rotate180):(n.position.z*=-1,n.rotationQuaternion.z*=-1,n.rotationQuaternion.w*=-1),N.FromFloat32ArrayToRefScaled(i.projectionMatrix,0,1,n._projectionMatrix),this._scene.useRightHandedSystem||n._projectionMatrix.toggleProjectionMatrixHandInPlace();let c=Math.atan2(1,i.projectionMatrix[5])*2;n.fov=c,r===0&&(this.fov=c,this._projectionMatrix.copyFrom(n._projectionMatrix));let h=this._xrSessionManager.getRenderTargetTextureForView(i);this._renderingMultiview=h?._texture?.isMultiview||!1,this._renderingMultiview?r==0&&(this._xrSessionManager.trySetViewportForView(this.viewport,i),this.outputRenderTarget=h):(this._xrSessionManager.trySetViewportForView(n.viewport,i),n.outputRenderTarget=h||this._xrSessionManager.getRenderTargetTextureForView(i)),n.layerMask=this.layerMask})}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){let t=new lr("XR-RigCamera: "+this.rigCameras.length,p.Zero(),this.getScene());t.minZ=.1,t.rotationQuaternion=new q,t.updateUpVectorFromRotation=!0,t.isRigCamera=!0,t.rigParent=this,t.freezeProjectionMatrix(),this.rigCameras.push(t)}for(;this.rigCameras.length>e;){let t=this.rigCameras.pop();t&&t.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){let e=O.Matrix[0],t=O.Matrix[1],i=O.Matrix[2];N.ComposeToRef(s._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),N.ComposeToRef(s._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);let r=new XRRigidTransform({x:this._referencedPosition.x/this._xrSessionManager.worldScalingFactor,y:this._referencedPosition.y/this._xrSessionManager.worldScalingFactor,z:this._referencedPosition.z/this._xrSessionManager.worldScalingFactor},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(r)}}};Om._ScaleReadOnly=p.One();var vT=class s{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new U,this.onStateChangedObservable=new U,this.state=Ki.NOT_IN_XR,this.sessionManager=new bd(e),this.camera=new Om("webxr",e,this.sessionManager),this.featuresManager=new mt(this.sessionManager),e.onDisposeObservable.addOnce(()=>{this.dispose()})}static CreateAsync(e){let t=new s(e);return t.sessionManager.initializeAsync().then(()=>(t._supported=!0,t)).catch(i=>{throw t._setState(Ki.NOT_IN_XR),t.dispose(),i})}dispose(){this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),this._spectatorCamera?.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}enterXRAsync(n,o){return $e(this,arguments,function*(e,t,i=this.sessionManager.getWebXRRenderTarget(),r={}){if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(Ki.ENTERING_XR),t!=="viewer"&&t!=="local"&&(r.optionalFeatures=r.optionalFeatures||[],r.optionalFeatures.push(t)),r=yield this.featuresManager._extendXRSessionInitObject(r),e==="immersive-ar"&&t!=="unbounded"&&F.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{yield this.sessionManager.initializeSessionAsync(e,r),yield this.sessionManager.setReferenceSpaceTypeAsync(t);let a={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};if(!this.featuresManager.getEnabledFeature(ct.LAYERS)){let l=yield i.initializeXRLayerAsync(this.sessionManager.session);a.baseLayer=l}return this.sessionManager.updateRenderState(a),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!this._nonVRCamera?.inputs?.attachedToElement,this._nonVRCamera?.detachControl(),this._scene.activeCamera=this.camera,e!=="immersive-ar"?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)),K.audioEngine?._resumeAudioContextOnStateChange(),this.sessionManager.onXRSessionEnded.addOnce(()=>{this.state!==Ki.EXITING_XR&&this._setState(Ki.EXITING_XR),this.camera.rigCameras.forEach(l=>{l.outputRenderTarget=null}),this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),e!=="immersive-ar"&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(Ki.NOT_IN_XR)}),this.sessionManager.onXRFrameObservable.addOnce(()=>{this._setState(Ki.IN_XR)}),this.sessionManager}catch(a){throw F.Log(a),F.Log(a.message),this._setState(Ki.NOT_IN_XR),a}})}exitXRAsync(){return this.state!==Ki.IN_XR?Promise.resolve():(this._setState(Ki.EXITING_XR),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){let i=1/(e?.fps?e.fps:1e3)*1e3,r=e?.preferredCameraIndex?e?.preferredCameraIndex:0,n=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=i&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[r].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[r].absoluteRotation))};if(this._spectatorMode){if(r>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");let o=()=>{this.state===Ki.IN_XR?(this._spectatorCamera=new _n("webxr-spectator",p.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new q,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(n),this._scene.onAfterRenderCameraObservable.add(a=>{a===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)})):this.state===Ki.EXITING_XR&&(this.sessionManager.onXRFrameObservable.removeCallback(n),this._scene.activeCameras=null)};this.onStateChangedObservable.add(o),o()}else this.sessionManager.onXRFrameObservable.removeCallback(n),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}};var yn=(()=>{class s{constructor(t,i,r=-1,n=[]){this.id=t,this.type=i,this._buttonIndex=r,this._axesIndices=n,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new U,this.onButtonStateChangedObservable=new U}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return this._axesIndices.length!==0}isButton(){return this._buttonIndex!==-1}update(t){let i=!1,r=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){let n=t.buttons[this._buttonIndex];if(!n)return;this._currentValue!==n.value&&(this.changes.value={current:n.value,previous:this._currentValue},i=!0,this._currentValue=n.value),this._touched!==n.touched&&(this.changes.touched={current:n.touched,previous:this._touched},i=!0,this._touched=n.touched),this._pressed!==n.pressed&&(this.changes.pressed={current:n.pressed,previous:this._pressed},i=!0,this._pressed=n.pressed)}this.isAxes()&&(this._axes.x!==t.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:t.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=t.axes[this._axesIndices[0]],r=!0),this._axes.y!==t.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=t.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:t.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=t.axes[this._axesIndices[1]],r=!0)),i&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),r&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}return s.BUTTON_TYPE="button",s.SQUEEZE_TYPE="squeeze",s.THUMBSTICK_TYPE="thumbstick",s.TOUCHPAD_TYPE="touchpad",s.TRIGGER_TYPE="trigger",s})();var Zs=class{constructor(e,t,i,r,n=!1,o){this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=r,this._doNotLoadControllerMesh=n,this._controllerCache=o,this._initComponent=a=>{if(!a)return;let l=this.layout.components[a],c=l.type,h=l.gamepadIndices.button,u=[];l.gamepadIndices.xAxis!==void 0&&l.gamepadIndices.yAxis!==void 0&&u.push(l.gamepadIndices.xAxis,l.gamepadIndices.yAxis),this.components[a]=new yn(a,c,h,u)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new U,t.components&&Object.keys(t.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach(e=>this.getComponent(e).dispose()),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach(e=>{e.setEnabled(!1)}),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache))}getAllComponentsOfType(e){return this.getComponentIds().map(t=>this.components[t]).filter(t=>t.type===e)}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}loadModel(){return $e(this,null,function*(){let e=!this._getModelLoadingConstraints(),t=this._getGenericFilenameAndPath();return e?F.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),new Promise((i,r)=>{let n=o=>{e?this._getGenericParentMesh(o):this._setRootMesh(o),this._processLoadedModel(o),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){let o=this._controllerCache.filter(a=>a.filename===t.filename&&a.path===t.path);if(o[0]){o[0].meshes.forEach(a=>a.setEnabled(!0)),n(o[0].meshes);return}}Mt.ImportMesh("",t.path,t.filename,this.scene,o=>{this._controllerCache&&this._controllerCache.push(Kt(ie({},t),{meshes:o})),n(o)},null,(o,a)=>{F.Log(a),F.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),r(a)})})})}updateFromXRFrame(e){this.getComponentIds().forEach(t=>this.getComponent(t).update(this.gamepadObject)),this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(e,t):Promise.resolve(!1)}_getChildByName(e,t){return e.getChildren(i=>i.name===t,!1)[0]}_getImmediateChildByName(e,t){return e.getChildren(i=>i.name==t,!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh||!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;let r=i?t*.5+.5:t;q.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,r,e.valueMesh.rotationQuaternion),p.LerpToRef(e.minMesh.position,e.maxMesh.position,r,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new k(this.profileId+" "+this.handedness,this.scene),e.forEach(t=>{t.parent||(t.isPickable=!1,t.setParent(this.rootMesh))}),this.rootMesh.rotationQuaternion=q.FromEulerAngles(0,Math.PI,0)}};var O0=(()=>{class s extends Zs{constructor(t,i,r){super(t,I8[r],i,r),this.profileId=s.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(t){}_setRootMesh(t){this.rootMesh=new k(this.profileId+" "+this.handedness,this.scene),t.forEach(i=>{i.isPickable=!1,i.parent||i.setParent(this.rootMesh)}),this.rootMesh.rotationQuaternion=q.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}return s.ProfileId="generic-trigger",s})(),I8={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};var TT=class extends Zs{constructor(e,t,i,r,n){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,n),this._repositoryUrl=r,this.controllerCache=n,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach(e=>{this._touchDots[e].dispose()})}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){let e=Mt.IsPluginForExtensionAvailable(".glb");return e||F.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach(t=>{let i=this.layout.components[t];this._buttonMeshMapping[t]={mainMesh:this._getChildByName(this.rootMesh,i.rootNodeName),states:{}},Object.keys(i.visualResponses).forEach(r=>{let n=i.visualResponses[r];if(n.valueNodeProperty==="transform")this._buttonMeshMapping[t].states[r]={valueMesh:this._getChildByName(this.rootMesh,n.valueNodeName),minMesh:this._getChildByName(this.rootMesh,n.minNodeName),maxMesh:this._getChildByName(this.rootMesh,n.maxNodeName)};else{let o=i.type===yn.TOUCHPAD_TYPE&&i.touchPointNodeName?i.touchPointNodeName:n.valueNodeName;if(this._buttonMeshMapping[t].states[r]={valueMesh:this._getChildByName(this.rootMesh,o)},i.type===yn.TOUCHPAD_TYPE&&!this._touchDots[r]){let a=pr(r+"dot",{diameter:.0015,segments:8},this.scene);a.material=new Ee(r+"mat",this.scene),a.material.diffuseColor=X.Red(),a.parent=this._buttonMeshMapping[t].states[r].valueMesh||null,a.isVisible=!1,this._touchDots[r]=a}}})})}_setRootMesh(e){this.rootMesh=new k(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;let t;for(let i=0;i<e.length;i++){let r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(qt.Y,Math.PI,Ke.WORLD)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach(t=>{let i=this.getComponent(t);if(!i.hasChanges)return;let r=this._buttonMeshMapping[t],n=this.layout.components[t];Object.keys(n.visualResponses).forEach(o=>{let a=n.visualResponses[o],l=i.value;if(a.componentProperty==="xAxis"?l=i.axes.x:a.componentProperty==="yAxis"&&(l=i.axes.y),a.valueNodeProperty==="transform")this._lerpTransform(r.states[o],l,a.componentProperty!=="button");else{let c=r.states[o].valueMesh;c&&(c.isVisible=i.touched||i.pressed),this._touchDots[o]&&(this._touchDots[o].isVisible=i.touched||i.pressed)}})})}};var w0=[],br=(()=>{class s{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(t){let i=this._Fallbacks[t]||[];return i.unshift(t),i}static GetMotionControllerWithXRInput(t,i,r){let n=[];if(r&&n.push(r),n.push(...t.profiles||[]),n.length&&!n[0]&&n.pop(),t.gamepad&&t.gamepad.id)switch(t.gamepad.id){case(t.gamepad.id.match(/oculus touch/gi)?t.gamepad.id:void 0):n.push("oculus-touch-v2");break}let o=n.indexOf("windows-mixed-reality");if(o!==-1&&n.splice(o,0,"microsoft-mixed-reality"),n.length||n.push("generic-trigger"),this.UseOnlineRepository){let a=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,l=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return a.call(this,n,t,i).catch(()=>l.call(this,n,t,i))}else return this._LoadProfilesFromAvailableControllers(n,t,i)}static RegisterController(t,i){this._AvailableControllers[t]=i}static RegisterFallbacksForProfileId(t,i){this._Fallbacks[t]?this._Fallbacks[t].push(...i):this._Fallbacks[t]=i}static UpdateProfilesList(){return this._ProfilesList=H.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then(t=>JSON.parse(t)),this._ProfilesList}static ClearControllerCache(){w0.forEach(t=>{t.meshes.forEach(i=>{i.dispose(!1,!0)})}),w0.length=0}static _LoadProfileFromRepository(t,i,r){return Promise.resolve().then(()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList()).then(n=>{for(let o=0;o<t.length;++o)if(t[o]&&n[t[o]])return t[o];throw new Error(`neither controller ${t[0]} nor all fallbacks were found in the repository,`)}).then(n=>(this._ProfileLoadingPromises[n]||(this._ProfileLoadingPromises[n]=H.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${n}/profile.json`,!1).then(o=>JSON.parse(o))),this._ProfileLoadingPromises[n])).then(n=>new TT(r,i,n,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:w0))}static _LoadProfilesFromAvailableControllers(t,i,r){for(let n=0;n<t.length;++n){if(!t[n])continue;let o=this.FindFallbackWithProfileId(t[n]);for(let a=0;a<o.length;++a){let l=this._AvailableControllers[o[a]];if(l)return Promise.resolve(l(i,r))}}throw new Error("no controller requested was found in the available controllers list")}}return s._AvailableControllers={},s._Fallbacks={},s._ProfileLoadingPromises={},s.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",s.PrioritizeOnlineRepository=!0,s.UseOnlineRepository=!0,s.DisableControllerCache=!0,s})();br.RegisterController(O0.ProfileId,(s,e)=>new O0(e,s.gamepad,s.handedness));br.DefaultFallbacks();var R8=0,CT=class{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new p,this._disposed=!1,this.onDisposeObservable=new U,this.onMeshLoadedObservable=new U,this.onMotionControllerInitObservable=new U,this._uniqueId=`controller-${R8++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new k(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new q,this.inputSource.gripSpace&&(this.grip=new k(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new q),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&this.inputSource.targetRayMode==="tracked-pointer"&&br.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then(r=>{this.motionController=r,this.onMotionControllerInitObservable.notifyObservers(r),!this._options.doNotLoadControllerMesh&&!this.motionController._doNotLoadControllerMesh&&this.motionController.loadModel().then(n=>{n&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach(o=>o.renderingGroupId=this._options.renderingGroupId)),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&this.motionController?.dispose()})},()=>{H.Warn("Could not find a matching motion controller for the registered input source")})}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){let i=t&&this.grip?this.grip:this.pointer;p.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i,r){let n=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=n,n){let o=n.transform.position;this.pointer.position.set(o.x,o.y,o.z).scaleInPlace(r.worldScalingFactor);let a=n.transform.orientation;this.pointer.rotationQuaternion.set(a.x,a.y,a.z,a.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent,this.pointer.scaling.setAll(r.worldScalingFactor)}if(this.inputSource.gripSpace&&this.grip){let o=e.getPose(this.inputSource.gripSpace,t);if(o){let a=o.transform.position,l=o.transform.orientation;this.grip.position.set(a.x,a.y,a.z).scaleInPlace(r.worldScalingFactor),this.grip.rotationQuaternion.set(l.x,l.y,l.z,l.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent,this.grip.scaling.setAll(r.worldScalingFactor)}this.motionController&&this.motionController.updateFromXRFrame(e)}};var bT=class{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new U,this.onControllerRemovedObservable=new U,this._onInputSourcesChange=r=>{this._addAndRemoveControllers(r.added,r.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(()=>{this._addAndRemoveControllers([],this.controllers.map(r=>r.inputSource))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(r=>{r.addEventListener("inputsourceschange",this._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(r=>{this.controllers.forEach(n=>{n.updateFromXRFrame(r,this.xrSessionManager.referenceSpace,this.xrCamera,this.xrSessionManager)})}),this._options.customControllersRepositoryURL&&(br.BaseRepositoryUrl=this._options.customControllersRepositoryURL),br.UseOnlineRepository=!this._options.disableOnlineControllerRepository,br.UseOnlineRepository)try{br.UpdateProfilesList().catch(()=>{br.UseOnlineRepository=!1})}catch{br.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){let i=this.controllers.map(o=>o.inputSource);for(let o of e)if(i.indexOf(o)===-1){let a=new CT(this.xrSessionManager.scene,o,Kt(ie({},this._options.controllerOptions||{}),{forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation}));this.controllers.push(a),this.onControllerAddedObservable.notifyObservers(a)}let r=[],n=[];this.controllers.forEach(o=>{t.indexOf(o.inputSource)===-1?r.push(o):n.push(o)}),this.controllers=r,n.forEach(o=>{this.onControllerRemovedObservable.notifyObservers(o),o.dispose()})}dispose(){this.controllers.forEach(e=>{e.dispose()}),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),br.ClearControllerCache()}};var Ta=class s extends Ct{constructor(e,t){super(e),this._options=t,this._attachController=i=>{if(this._controllers[i.uniqueId])return;let{laserPointer:r,selectionMesh:n}=this._generateNewMeshPair(this._options.forceGripIfAvailable&&i.grip?i.grip:i.pointer);switch(this._controllers[i.uniqueId]={xrController:i,laserPointer:r,selectionMesh:n,meshUnderPointer:null,pick:null,tmpRay:new pt(new p,new p),disabledByNearInteraction:!1,id:s._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(i);case"gaze":return this._attachGazeMode(i);case"screen":case"transient-pointer":return this._attachScreenRayMode(i)}},this._controllers={},this._tmpVectorForPickCompare=new p,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new X(.9,.9,.9),this.laserPointerDefaultColor=new X(.7,.7,.7),this.selectionMeshDefaultColor=new X(.8,.8,.8),this.selectionMeshPickedColor=new X(.3,.3,1),this._identityMatrix=N.Identity(),this._screenCoordinatesRef=p.Zero(),this._viewportRef=new Dr(0,0,0,0),this._scene=this._xrSessionManager.scene,this._options.lookAndPickMode===void 0&&(this._scene.getEngine()._badDesktopOS||this._scene.getEngine()._badOS)&&(this._options.lookAndPickMode=!0),this._options.lookAndPickMode&&(this._options.enablePointerSelectionOnAllControllers=!0,this.displayLaserPointer=!1)}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController,!0),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)},!0),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){let e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new pt(new p,new p),disabledByNearInteraction:!1,id:s._IdCounter++},this._attachGazeMode()}return!0}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0):!1}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){let t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){let t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){let i=Object.keys(this._controllers);for(let r=0;r<i.length;++r)if(this._controllers[i[r]].id===e){this._controllers[i[r]].disabledByNearInteraction=t;return}}_onXRFrame(e){Object.keys(this._controllers).forEach(t=>{let i=this._controllers[t];if(this._options.lookAndPickMode&&i.xrController?.inputSource.targetRayMode!=="transient-pointer")return;if(!this._options.enablePointerSelectionOnAllControllers&&t!==this._attachedController||i.disabledByNearInteraction){i.selectionMesh.isVisible=!1,i.laserPointer.isVisible=!1,i.pick=null;return}i.laserPointer.isVisible=this.displayLaserPointer;let r;if(i.xrController)r=this._options.forceGripIfAvailable&&i.xrController.grip?i.xrController.grip.position:i.xrController.pointer.position,i.xrController.getWorldPointerRayToRef(i.tmpRay,this._options.forceGripIfAvailable);else if(i.webXRCamera)r=i.webXRCamera.position,i.webXRCamera.getForwardRayToRef(i.tmpRay);else return;if(this._options.maxPointerDistance&&(i.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&r){let l=this._xrSessionManager.scene,c=this._options.xrInput.xrCamera;c&&(c.viewport.toGlobalToRef(l.getEngine().getRenderWidth()/c.rigCameras.length,l.getEngine().getRenderHeight(),this._viewportRef),p.ProjectToRef(r,this._identityMatrix,c.getTransformationMatrix(),this._viewportRef,this._screenCoordinatesRef),typeof this._screenCoordinatesRef.x=="number"&&typeof this._screenCoordinatesRef.y=="number"&&!isNaN(this._screenCoordinatesRef.x)&&!isNaN(this._screenCoordinatesRef.y)&&this._screenCoordinatesRef.x!==1/0&&this._screenCoordinatesRef.y!==1/0&&(l.pointerX=this._screenCoordinatesRef.x,l.pointerY=this._screenCoordinatesRef.y,i.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let n=null;this._utilityLayerScene&&(n=this._utilityLayerScene.pickWithRay(i.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));let o=this._scene.pickWithRay(i.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);!n||!n.hit?i.pick=o:!o||!o.hit||n.distance<o.distance?i.pick=n:i.pick=o,i.pick&&i.xrController&&(i.pick.aimTransform=i.xrController.pointer,i.pick.gripTransform=i.xrController.grip||null,i.pick.originMesh=i.xrController.pointer);let a=i.pick;if(a&&a.pickedPoint&&a.hit){this._updatePointerDistance(i.laserPointer,a.distance),i.selectionMesh.position.copyFrom(a.pickedPoint),i.selectionMesh.scaling.x=Math.sqrt(a.distance),i.selectionMesh.scaling.y=Math.sqrt(a.distance),i.selectionMesh.scaling.z=Math.sqrt(a.distance);let l=this._convertNormalToDirectionOfRay(a.getNormal(!0),i.tmpRay),c=.001;if(i.selectionMesh.position.copyFrom(a.pickedPoint),l){let h=p.Cross(qt.Y,l),u=p.Cross(l,h);p.RotationFromAxisToRef(u,l,h,i.selectionMesh.rotation),i.selectionMesh.position.addInPlace(l.scale(c))}i.selectionMesh.isVisible=this.displaySelectionMesh,i.meshUnderPointer=a.pickedMesh}else i.selectionMesh.isVisible=!1,this._updatePointerDistance(i.laserPointer,1),i.meshUnderPointer=null})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||ji.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){let t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,r=this._options.useUtilityLayer?this._utilityLayerScene:this._scene,n=new oi,o=vn("selection",{diameter:.0035*15,thickness:.0025*6,tessellation:20},r);o.isVisible=!1,o.isPickable=!1,o.parent=t.selectionMesh;let a=0,l=!1,c={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{if(t.pick){if(this._augmentPointerInit(c,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,o.isVisible=!1,t.pick.hit)if(this._pickingMoved(n,t.pick))l&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,c)),l=!1,a=0;else if(a>i/10&&(o.isVisible=!0),a+=this._scene.getEngine().getDeltaTime(),a>=i)this._scene.simulatePointerDown(t.pick,c),l=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,c),o.isVisible=!1;else{let h=1-a/i;o.scaling.set(h,h,h)}else l=!1,a=0;this._scene.simulatePointerMove(t.pick,c),n=t.pick}}),this._options.renderingGroupId!==void 0&&(o.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&l&&(this._scene.simulatePointerUp(t.pick,c),t.finalPointerUpTriggered=!0),o.dispose()})}_attachScreenRayMode(e){let t=this._controllers[e.uniqueId],i=!1,r={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),!(!t.pick||this._options.disablePointerUpOnTouchOut&&i)&&(i?this._scene.simulatePointerMove(t.pick,r):(this._scene.simulatePointerDown(t.pick,r),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,r)))}),e.onDisposeObservable.addOnce(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame(()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,r),t.finalPointerUpTriggered=!0)})})}_attachTrackedPointerRayMode(e){let t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);let i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))}),e.inputSource.gamepad){let r=n=>{this._options.overrideButtonId&&(t.selectionComponent=n.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=n.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(o=>{if(o.changes.pressed){let a=o.changes.pressed.current;if(t.pick)(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),a?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor));else if(a&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick){let l=this._controllers[this._attachedController];l&&l.pointerDownTriggered&&!l.finalPointerUpTriggered&&(this._augmentPointerInit(i,l.id,l.screenCoordinates),this._scene.simulatePointerUp(new oi,{pointerId:l.id,pointerType:"xr"}),l.finalPointerUpTriggered=!0),this._attachedController=e.uniqueId}}})};e.motionController?r(e.motionController):e.onMotionControllerInitObservable.add(r)}else{let r=o=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)})},n=o=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)})};t.eventListeners={selectend:n,selectstart:r},this._xrSessionManager.session.addEventListener("selectstart",r),this._xrSessionManager.session.addEventListener("selectend",n)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(p.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){let t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(i=>{let r=t.eventListeners&&t.eventListeners[i];r&&this._xrSessionManager.session.removeEventListener(i,r)}),!t.finalPointerUpTriggered&&t.pointerDownTriggered){let i={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new oi,i),t.finalPointerUpTriggered=!0})}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce(()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){let i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}catch{H.Warn("controller already detached.")}})}}_generateNewMeshPair(e){let t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||ji.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():qs("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;let r=new Ee("laserPointerMat",t);r.emissiveColor=this.laserPointerDefaultColor,r.alpha=.7,i.material=r,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;let n=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():vn("gazeTracker",{diameter:.0035*3,thickness:.0025*3,tessellation:20},t);n.bakeCurrentTransformIntoVertices(),n.isPickable=!1,n.isVisible=!1;let o=new Ee("targetMat",t);return o.specularColor=X.Black(),o.emissiveColor=this.selectionMeshDefaultColor,o.backFaceCulling=!1,n.material=o,this._options.renderingGroupId!==void 0&&(i.renderingGroupId=this._options.renderingGroupId,n.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:n}}_pickingMoved(e,t){if(!e.hit||!t.hit||!e.pickedMesh||!e.pickedPoint||!t.pickedMesh||!t.pickedPoint||e.pickedMesh!==t.pickedMesh)return!0;e.pickedPoint?.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));let i=(this._options.gazeModePointerMovedFactor||1)*.01*t.distance;return this._tmpVectorForPickCompare.length()>i}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}};Ta._IdCounter=200;Ta.Name=ct.POINTER_SELECTION;Ta.Version=1;mt.AddWebXRFeature(Ta.Name,(s,e)=>()=>new Ta(s,e),Ta.Version,!0);Wi.prototype._projectOnTrianglesToRef=function(s,e,t,i,r,n){let o=O.Vector3[0],a=O.Vector3[1],l=1/0;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-i);c+=i){let h=t[c],u=t[c+1],d=t[c+2];if(r&&d===4294967295){c+=2;continue}let f=e[h],m=e[u],g=e[d];if(!f||!m||!g)continue;let _=p.ProjectOnTriangleToRef(s,f,m,g,a);_<l&&(o.copyFrom(a),l=_)}return n.copyFrom(o),l};Wi.prototype._projectOnUnIndexedTrianglesToRef=function(s,e,t,i){let r=O.Vector3[0],n=O.Vector3[1],o=1/0;for(let a=this.verticesStart;a<this.verticesStart+this.verticesCount;a+=3){let l=e[a],c=e[a+1],h=e[a+2],u=p.ProjectOnTriangleToRef(s,l,c,h,n);u<o&&(r.copyFrom(n),o=u)}return i.copyFrom(r),o};Wi.prototype.projectToRef=function(s,e,t,i){let r=this.getMaterial();if(!r)return-1;let n=3,o=!1;switch(r.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:n=1,o=!0;break;default:break}return r.fillMode===4?-1:!t.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(s,e,t,i):this._projectOnTrianglesToRef(s,e,t,n,o,i)};var En=function(s){return s[s.DEHYDRATED=0]="DEHYDRATED",s[s.HOVER=1]="HOVER",s[s.TOUCH=2]="TOUCH",s}(En||{}),Ud=function(s){return s[s.DISABLED=0]="DISABLED",s[s.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",s[s.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT",s}(Ud||{}),Ca=class s extends Ct{constructor(e,t){super(e),this._options=t,this._tmpRay=new pt(new p,new p),this._attachController=i=>{if(this._controllers[i.uniqueId])return;let{touchCollisionMesh:r,touchCollisionMeshFunction:n,hydrateCollisionMeshFunction:o}=this._generateNewTouchPointMesh(),a=this._generateVisualCue();switch(this._controllers[i.uniqueId]={xrController:i,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:r,touchCollisionMeshFunction:n,hydrateCollisionMeshFunction:o,currentAnimationState:En.DEHYDRATED,grabRay:new pt(new p,new p),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,downTriggered:!1,id:s._IdCounter++,pickedPointVisualCue:a},this._controllers[i.uniqueId]._worldScaleObserver=this._controllers[i.uniqueId]._worldScaleObserver||this._xrSessionManager.onWorldScaleFactorChangedObservable.add(l=>{if(l.newScaleFactor!==l.previousScaleFactor){this._controllers[i.uniqueId].touchCollisionMesh.dispose(),this._controllers[i.uniqueId].pickedPointVisualCue.dispose();let{touchCollisionMesh:c,touchCollisionMeshFunction:h,hydrateCollisionMeshFunction:u}=this._generateNewTouchPointMesh();this._controllers[i.uniqueId].touchCollisionMesh=c,this._controllers[i.uniqueId].touchCollisionMeshFunction=h,this._controllers[i.uniqueId].hydrateCollisionMeshFunction=u,this._controllers[i.uniqueId].pickedPointVisualCue=this._generateVisualCue()}}),this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(i);case"gaze":return null;case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new X(.8,.8,.8),this.selectionMeshPickedColor=new X(.3,.3,1),this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,this._options.nearInteractionControllerMode===void 0&&(this._options.nearInteractionControllerMode=Ud.CENTERED_IN_FRONT),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return super.attach()?(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0):!1}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){let t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){if(!(e.currentAnimationState===t||this._options.nearInteractionControllerMode!==Ud.CENTERED_IN_FRONT||e.xrController?.inputSource.hand)){if(t>e.currentAnimationState)switch(e.currentAnimationState){case En.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===En.HOVER)break;case En.HOVER:if(e.touchCollisionMeshFunction(!0),t===En.TOUCH)break}else switch(e.currentAnimationState){case En.TOUCH:if(e.touchCollisionMeshFunction(!1),t===En.HOVER)break;case En.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===En.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){let r=this._controllers[e];r.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(O.Vector3[0]),r.grabRay.direction.copyFrom(O.Vector3[0]),this._options.nearInteractionControllerMode===Ud.CENTERED_IN_FRONT&&!r.xrController?.inputSource.hand&&(r.xrController.getWorldPointerRayToRef(this._tmpRay),r.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),r.grabRay.length=this._nearGrabLengthScale*this._hoverRadius*this._xrSessionManager.worldScalingFactor,r.touchCollisionMesh.position.copyFrom(r.grabRay.origin).scaleInPlace(this._xrSessionManager.worldScalingFactor)}_onXRFrame(e){Object.keys(this._controllers).forEach(t=>{let i=this._controllers[t],r=i.xrController?.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!i.xrController||!r&&(!this._options.nearInteractionControllerMode||!i.xrController.inputSource.gamepad)){i.pick=null;return}if(i.hoverInteraction=!1,i.nearInteraction=!1,i.xrController){if(r){let l=r.get("index-finger-tip");if(l){let c=e.getJointPose(l,this._xrSessionManager.referenceSpace);if(c&&c.transform){let h=this._scene.useRightHandedSystem?1:-1;O.Vector3[0].set(c.transform.position.x,c.transform.position.y,c.transform.position.z*h),O.Quaternion[0].set(c.transform.orientation.x,c.transform.orientation.y,c.transform.orientation.z*h,c.transform.orientation.w*h),this._processTouchPoint(t,O.Vector3[0],O.Quaternion[0])}}}else if(i.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==Ud.DISABLED){let l=i.xrController.pointer;i.xrController.grip&&this._options.nearInteractionControllerMode===Ud.CENTERED_ON_CONTROLLER&&(l=i.xrController.grip),this._processTouchPoint(t,l.position,l.rotationQuaternion)}}else return;let n=(l,c)=>{let h=null;return!c||!c.hit?h=l:!l||!l.hit||c.distance<l.distance?h=c:h=l,h},o=l=>{let c=new oi,h=!1,u=l&&l.pickedPoint&&l.hit;return l?.pickedPoint&&(h=l.pickedPoint.x===0&&l.pickedPoint.y===0&&l.pickedPoint.z===0),u&&!h&&(c=l),c};if(!i.grabInteraction){let l=null,c=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(c=this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._utilityLayerScene,d=>this._nearInteractionPredicate(d)));let h=this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._scene,d=>this._nearInteractionPredicate(d)),u=n(h,c);if(u&&u.hit&&(l=o(u),l.hit&&(i.hoverInteraction=!0)),i.hoverInteraction){let d=null,f=(r?this._pickRadius:this._controllerPickRadius)*this._xrSessionManager.worldScalingFactor;this._options.useUtilityLayer&&this._utilityLayerScene&&(d=this._pickWithSphere(i,f,this._utilityLayerScene,x=>this._nearPickPredicate(x)));let m=this._pickWithSphere(i,f,this._scene,x=>this._nearPickPredicate(x)),g=n(m,d),_=o(g);_.hit&&(l=_,i.nearInteraction=!0)}i.stalePick=i.pick,i.pick=l,i.pick&&i.pick.pickedPoint&&i.pick.hit?(i.meshUnderPointer=i.pick.pickedMesh,i.pickedPointVisualCue.position.copyFrom(i.pick.pickedPoint),i.pickedPointVisualCue.isVisible=!0,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!0)):(i.meshUnderPointer=null,i.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!1))}let a=En.DEHYDRATED;i.grabInteraction||i.nearInteraction?a=En.TOUCH:i.hoverInteraction&&(a=En.HOVER),this._handleTransitionAnimation(i,a)})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||ji.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){let e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||ji.DefaultUtilityLayer.utilityLayerScene:this._scene,t=pr("nearInteraction",{diameter:.0035*3*this._xrSessionManager.worldScalingFactor},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=q.Identity();let i=new Ee("targetMat",e);return i.specularColor=X.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return this._farInteractionFeature?this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e):!0}_attachNearInteractionMode(e){let t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{!this._options.enableNearInteractionOnAllControllers&&e.uniqueId!==this._attachedController||!t.xrController||!t.xrController.inputSource.hand&&(!this._options.nearInteractionControllerMode||!t.xrController.inputSource.gamepad)||(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer,t.downTriggered=!0):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.downTriggered=!1,t.nearInteractionTargetMesh=null))});let r=n=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),n&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0):!n&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.downTriggered=!1,t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)):n&&!this._options.enableNearInteractionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){let n=o=>{t.squeezeComponent=o.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add(a=>{if(a.changes.pressed){let l=a.changes.pressed.current;r(l)}}):(t.selectionComponent=o.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(a=>{if(a.changes.pressed){let l=a.changes.pressed.current;r(l)}}))};e.motionController?n(e.motionController):e.onMotionControllerInitObservable.add(n)}else{let n=a=>{t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0)},o=a=>{t.xrController&&a.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0,t.downTriggered=!1)};t.eventListeners={selectend:o,selectstart:n},this._xrSessionManager.session.addEventListener("selectstart",n),this._xrSessionManager.session.addEventListener("selectend",o)}}_detachController(e){let t=this._controllers[e];if(t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(i=>{let r=t.eventListeners&&t.eventListeners[i];r&&this._xrSessionManager.session.removeEventListener(i,r)}),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame(()=>{if(!t.downTriggered)return;let i={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new oi,i)}),t._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(t._worldScaleObserver),delete this._controllers[e],this._attachedController===e)){let i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}_generateNewTouchPointMesh(){let e=this._xrSessionManager.worldScalingFactor,t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||ji.DefaultUtilityLayer.utilityLayerScene:this._scene,i=pr("PickSphere",{diameter:1*e},t);if(i.isVisible=!1,this._options.motionControllerOrbMaterial)i.material=this._options.motionControllerOrbMaterial;else{let L;this._options.motionControllerTouchMaterialSnippetUrl?L=$i.ParseFromFileAsync("motionControllerTouchMaterial",this._options.motionControllerTouchMaterialSnippetUrl,t):L=$i.ParseFromSnippetAsync("8RUNKL#3",t),L.then(G=>{i.material=G}).catch(G=>{F.Warn(`Error creating touch material in WebXRNearInteraction: ${G}`)})}let r=new Dx;r.setEasingMode(fs.EASINGMODE_EASEINOUT);let n=new p(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius).scaleInPlace(e),o=this._controllerPickRadius*(4/3),a=new p(o,o,o).scaleInPlace(e),l=this._controllerPickRadius*(7/6),c=new p(l,l,l).scaleInPlace(e),h=this._controllerPickRadius*(4/5),u=new p(h,h,h).scaleInPlace(e),d=this._controllerPickRadius*(3/2),f=new p(d,d,d).scaleInPlace(e),m=[{frame:0,value:n},{frame:10,value:f},{frame:18,value:a}],g=[{frame:0,value:a},{frame:10,value:u},{frame:18,value:n}],_=[{frame:0,value:p.ZeroReadOnly},{frame:12,value:c},{frame:15,value:n}],x=[{frame:0,value:n},{frame:10,value:p.ZeroReadOnly},{frame:15,value:p.ZeroReadOnly}],b=new te("touch","scaling",60,te.ANIMATIONTYPE_VECTOR3,te.ANIMATIONLOOPMODE_CONSTANT),C=new te("release","scaling",60,te.ANIMATIONTYPE_VECTOR3,te.ANIMATIONLOOPMODE_CONSTANT),R=new te("hydrate","scaling",60,te.ANIMATIONTYPE_VECTOR3,te.ANIMATIONLOOPMODE_CONSTANT),E=new te("dehydrate","scaling",60,te.ANIMATIONTYPE_VECTOR3,te.ANIMATIONLOOPMODE_CONSTANT);return b.setEasingFunction(r),C.setEasingFunction(r),R.setEasingFunction(r),E.setEasingFunction(r),b.setKeys(m),C.setKeys(g),R.setKeys(_),E.setKeys(x),{touchCollisionMesh:i,touchCollisionMeshFunction:L=>{let G=L?b:C;t.beginDirectAnimation(i,[G],0,18,!1,1)},hydrateCollisionMeshFunction:L=>{let G=L?R:E;L&&(i.isVisible=!0),t.beginDirectAnimation(i,[G],0,15,!1,1,()=>{L||(i.isVisible=!1)})}}}_pickWithSphere(e,t,i,r){let n=new oi;if(n.distance=1/0,e.touchCollisionMesh&&e.xrController){let o=e.touchCollisionMesh.position,a=ta.CreateFromCenterAndRadius(o,t);for(let l=0;l<i.meshes.length;l++){let c=i.meshes[l];if(!r(c)||!this._controllerAvailablePredicate(c,e.xrController.uniqueId))continue;let h=s.PickMeshWithSphere(c,a);h&&h.hit&&h.distance<n.distance&&(n.hit=h.hit,n.pickedMesh=c,n.pickedPoint=h.pickedPoint,n.aimTransform=e.xrController.pointer,n.gripTransform=e.xrController.grip||null,n.originMesh=e.touchCollisionMesh,n.distance=h.distance,n.bu=h.bu,n.bv=h.bv,n.faceId=h.faceId,n.subMeshId=h.subMeshId)}}return n}static PickMeshWithSphere(e,t,i=!1){let r=e.subMeshes,n=new oi,o=e.getBoundingInfo();if(!e._generatePointsArray()||!e.subMeshes||!o||!i&&!ta.Intersects(o.boundingSphere,t))return n;let a=O.Vector3[0],l=O.Vector3[1],c=new pt(p.Zero(),p.Zero(),1),h=1/0,u,d,f,m,g=O.Vector3[2],_=O.Matrix[0];_.copyFrom(e.getWorldMatrix()),_.invert(),p.TransformCoordinatesToRef(t.center,_,g);for(let x=0;x<r.length;x++)r[x].projectToRef(g,e._positions,e.getIndices(),l),p.TransformCoordinatesToRef(l,e.getWorldMatrix(),l),u=p.Distance(l,t.center),f=p.Distance(l,e.getAbsolutePosition()),d=p.Distance(t.center,e.getAbsolutePosition()),d!==-1&&f!==-1&&f>d&&(u=0,l.copyFrom(t.center)),u!==-1&&u<h&&(h=u,pt.CreateFromToToRef(t.center,l,c),c.length=h*2,m=c.intersectsMesh(e),a.copyFrom(l));return h<t.radius&&(n.hit=!0,n.distance=h,n.pickedMesh=e,n.pickedPoint=a.clone(),m&&m.bu!==null&&m.bv!==null&&(n.faceId=m.faceId,n.subMeshId=m.subMeshId,n.bu=m.bu,n.bv=m.bv)),n}};Ca._IdCounter=200;Ca.Name=ct.NEAR_INTERACTION;Ca.Version=1;mt.AddWebXRFeature(Ca.Name,(s,e)=>()=>new Ca(s,e),Ca.Version,!0);var N0=class{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}};var ST=class s{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new U,this._onSessionGranted=r=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window<"u"&&window.location&&window.location.protocol==="http:"&&window.location.hostname!=="localhost")throw H.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";let r=t.sessionMode||"immersive-vr",n=t.referenceSpaceType||"local-floor",a=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(typeof SVGSVGElement>"u"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";a+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';let l=document.createElement("style");l.appendChild(document.createTextNode(a)),document.getElementsByTagName("head")[0].appendChild(l);let c=document.createElement("button");c.className="babylonVRicon",c.title=`${r} - ${n}`,this._buttons.push(new N0(c,r,n)),this._buttons[this._buttons.length-1].update=function(h){this.element.style.display=h===null||h===this?"":"none",c.className="babylonVRicon"+(h===this?" vrdisplaypresenting":"")},this._updateButtons(null)}let i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce(()=>{this.dispose()}))}setHelperAsync(e,t){return $e(this,null,function*(){this._helper=e,this._renderTarget=t;let i=this._buttons.map(n=>e.sessionManager.isSessionSupportedAsync(n.sessionMode));e.onStateChangedObservable.add(n=>{n==Ki.NOT_IN_XR&&this._updateButtons(null)}),(yield Promise.all(i)).forEach((n,o)=>{n?(this.overlay.appendChild(this._buttons[o].element),this._buttons[o].element.onclick=this._enterXRWithButtonIndex.bind(this,o)):H.Warn(`Session mode "${this._buttons[o].sessionMode}" not supported in browser`)})})}static CreateAsync(e,t,i){return $e(this,null,function*(){let r=new s(e,i);return yield r.setHelperAsync(t,i.renderTarget||void 0),r})}_enterXRWithButtonIndex(e=0){return $e(this,null,function*(){if(this._helper.state==Ki.IN_XR)yield this._helper.exitXRAsync(),this._updateButtons(null);else if(this._helper.state==Ki.NOT_IN_XR)try{yield this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);let i=this._buttons[e].element,r=i.title;i.title="Error entering XR session : "+r,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}})}dispose(){let e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach(t=>{t.update(this._activeButton)}),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}};var kd=function(s){return s[s.INIT=0]="INIT",s[s.STARTED=1]="STARTED",s[s.ENDED=2]="ENDED",s}(kd||{});function wm(s){let e=0,t=Date.now();s.observableParameters=s.observableParameters??{};let i=s.contextObservable.add(r=>{let n=Date.now();e=n-t;let o={startTime:t,currentTime:n,deltaTime:e,completeRate:e/s.timeout,payload:r};s.onTick&&s.onTick(o),s.breakCondition&&s.breakCondition()&&(s.contextObservable.remove(i),s.onAborted&&s.onAborted(o)),e>=s.timeout&&(s.contextObservable.remove(i),s.onEnded&&s.onEnded(o))},s.observableParameters.mask,s.observableParameters.insertFirst,s.observableParameters.scope);return i}var yT=class{constructor(e){this.onEachCountObservable=new U,this.onTimerAbortedObservable=new U,this.onTimerEndedObservable=new U,this.onStateChangedObservable=new U,this._observer=null,this._breakOnNextTick=!1,this._tick=t=>{let i=Date.now();this._timer=i-this._startTime;let r={startTime:this._startTime,currentTime:i,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:t},n=this._breakOnNextTick||this._breakCondition(r);n||this._timer>=this._timeToEnd?this._stop(r,n):this.onEachCountObservable.notifyObservers(r)},this._setState(kd.INIT),this._contextObservable=e.contextObservable,this._observableParameters=e.observableParameters??{},this._breakCondition=e.breakCondition??(()=>!1),this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(this._state===kd.STARTED)throw new Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(kd.STARTED)}stop(){this._state===kd.STARTED&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,t=!1){this._contextObservable.remove(this._observer),this._setState(kd.ENDED),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}};var nl=class extends Ct{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){let t=this._options.teleportationTargetMesh.getChildMeshes(!1,i=>i.name==="rotationCone");t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new oe(1,1,1,1),this._tmpRay=new pt(new p,new p),this._tmpVector=new p,this._tmpQuaternion=new q,this._worldScaleObserver=null,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new U,this.teleportationEnabled=!0,this._rotationEnabled=!0,this.onBeforeCameraTeleportRotation=new U,this.onAfterCameraTeleportRotation=new U,this._attachController=i=>{if(this._controllers[i.uniqueId]||this._options.forceHandedness&&i.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[i.uniqueId]={xrController:i,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1,initialHit:!1,mainComponentUsed:!1}};let r=this._controllers[i.uniqueId];if(r.xrController.inputSource.targetRayMode==="tracked-pointer"&&r.xrController.inputSource.gamepad){let n=()=>{if(i.motionController){let o=i.motionController.getComponentOfType(yn.THUMBSTICK_TYPE)||i.motionController.getComponentOfType(yn.TOUCHPAD_TYPE);if(!o||this._options.useMainComponentOnly){let a=i.motionController.getMainComponent();if(!a)return;r.teleportationState.mainComponentUsed=!0,r.teleportationComponent=a,r.onButtonChangedObserver=a.onButtonStateChangedObservable.add(()=>{if(!this.teleportationEnabled)return;let l=()=>{r.teleportationState.forward=!0,r.teleportationState.initialHit=!1,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;let c=this._options.timeToTeleport||3e3;wm({timeout:c,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!a.pressed,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(i.uniqueId)}})};a.changes.pressed&&(a.changes.pressed.current?this._options.timeToTeleportStart?wm({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{a.pressed&&l()}}):l():(r.teleportationState.forward=!1,this._currentTeleportationControllerId=""))})}else r.teleportationComponent=o,r.onAxisChangedObserver=o.onAxisValueChangedObservable.add(a=>{if(a.y<=.7&&r.teleportationState.backwards&&(r.teleportationState.backwards=!1),a.y>.7&&!r.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!r.teleportationState.backwards){r.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,q.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);let l=this._xrSessionManager.scene.pickWithRay(this._tmpRay,c=>this._floorMeshes.indexOf(c)!==-1);l&&l.pickedPoint&&(this._options.xrInput.xrCamera.position.x=l.pickedPoint.x,this._options.xrInput.xrCamera.position.z=l.pickedPoint.z)}if(a.y<-.7&&!this._currentTeleportationControllerId&&!r.teleportationState.rotating&&this.teleportationEnabled&&(r.teleportationState.forward=!0,this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),a.x){if(r.teleportationState.forward)this._currentTeleportationControllerId===r.xrController.uniqueId&&(this.rotationEnabled?setTimeout(()=>{r.teleportationState.currentRotation=Math.atan2(a.x,a.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))}):r.teleportationState.currentRotation=0);else if(!r.teleportationState.rotating&&Math.abs(a.x)>.7){r.teleportationState.rotating=!0;let l=this.rotationAngle*(a.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this.onBeforeCameraTeleportRotation.notifyObservers(l),q.FromEulerAngles(0,l,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleportRotation.notifyObservers(this._options.xrInput.xrCamera.rotationQuaternion)}}else r.teleportationState.rotating=!1;a.x===0&&a.y===0&&(r.teleportationState.blocked&&(r.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),r.teleportationState.forward&&this._teleportForward(i.uniqueId))})}};i.motionController?n():i.onMotionControllerInitObservable.addOnce(()=>{n()})}else{r.teleportationState.mainComponentUsed=!0;let n=!1,o=()=>{this._currentTeleportationControllerId=r.xrController.uniqueId,r.teleportationState.forward=!0,r.teleportationState.initialHit=!1,r.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,r.teleportationState.currentRotation=0;let a=this._options.timeToTeleport||3e3;wm({timeout:a,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&r.teleportationState.forward&&this._teleportForward(i.uniqueId)}})};this._xrSessionManager.scene.onPointerObservable.add(a=>{a.type===Ae.POINTERDOWN?(n=!1,this._options.timeToTeleportStart?wm({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===r.xrController.uniqueId&&o()},breakCondition:()=>n?(n=!1,!0):!1}):o()):a.type===Ae.POINTERUP&&(n=!0,r.teleportationState.forward=!1,this._currentTeleportationControllerId="")})}},this._colorArray=Array(24).fill(this._cachedColor4White),this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new oe(1,0,0,.75),this._setTargetMeshVisibility(!1),this.onBeforeCameraTeleport=t.xrInput.xrCamera.onBeforeCameraTeleport,this.onAfterCameraTeleport=t.xrInput.xrCamera.onAfterCameraTeleport,this.parabolicCheckRadius*=this._xrSessionManager.worldScalingFactor,this._worldScaleObserver=e.onWorldScaleFactorChangedObservable.add(i=>{this.parabolicCheckRadius=this.parabolicCheckRadius/i.previousScaleFactor*i.newScaleFactor,this._options.teleportationTargetMesh?.scaling.scaleInPlace(i.newScaleFactor/i.previousScaleFactor)})}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return super.attach()?(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0):!1}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver)}removeFloorMesh(e){let t=this._floorMeshes.indexOf(e);t!==-1&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];let t=this._options.pickBlockerMeshes.indexOf(e);t!==-1&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){let t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(t===-1){for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}}return t!==-1?(this._snapToPositions.splice(t,1),!0):!1}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){let t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;let r=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!r)return;r.rotationQuaternion=r.rotationQuaternion||new q;let n=this._controllers[this._currentTeleportationControllerId];if(n&&n.teleportationState.forward){q.RotationYawPitchRollToRef(n.teleportationState.currentRotation+n.teleportationState.baseRotation,0,0,r.rotationQuaternion);let o=!1,a=n.xrController.inputSource.targetRayMode!=="transient-pointer";if(n.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){let l=i.pickWithRay(this._tmpRay,h=>{if(this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(h)||this._options.blockAllPickableMeshes&&h.isPickable||this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(h)!==-1)return!0;let u=this._floorMeshes.indexOf(h);return u===-1?!1:this._floorMeshes[u].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y}),c=l&&l.pickedMesh&&this._floorMeshes.indexOf(l.pickedMesh)!==-1;if(l&&l.pickedMesh&&!c){if(n.teleportationState.mainComponentUsed&&!n.teleportationState.initialHit){n.teleportationState.forward=!1;return}n.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,a),this._showParabolicPath(l);return}else l&&l.pickedPoint&&(n.teleportationState.initialHit=!0,n.teleportationState.blocked=!1,o=!0,this._setTargetMeshPosition(l),this._setTargetMeshVisibility(!0,!1,a),this._showParabolicPath(l))}if(this.parabolicRayEnabled&&!o){let l=n.xrController.pointer.rotationQuaternion.toEulerAngles().x,c=1+(Math.PI/2-Math.abs(l)),h=this.parabolicCheckRadius*c;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(h*2),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(h)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();let u=i.pickWithRay(this._tmpRay,f=>this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(f)||this._options.blockAllPickableMeshes&&f.isPickable||this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(f)!==-1?!0:this._floorMeshes.indexOf(f)!==-1),d=u&&u.pickedMesh&&this._floorMeshes.indexOf(u.pickedMesh)!==-1;if(u&&u.pickedMesh&&!d){if(n.teleportationState.mainComponentUsed&&!n.teleportationState.initialHit){n.teleportationState.forward=!1;return}n.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,a),this._showParabolicPath(u);return}else u&&u.pickedPoint&&(n.teleportationState.initialHit=!0,n.teleportationState.blocked=!1,o=!0,this._setTargetMeshPosition(u),this._setTargetMeshVisibility(!0,!1,a),this._showParabolicPath(u))}this._setTargetMeshVisibility(o,!1,a)}else this._setTargetMeshVisibility(!1,!1,!0)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1,!1,!0)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};let e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||ji.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=Ed("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{let o=new Hl("teleportationPlaneDynamicTexture",512,e,!0);o.hasAlpha=!0;let a=o.getContext(),l=512/2,c=512/2,h=200;a.beginPath(),a.arc(l,c,h,0,2*Math.PI,!1),a.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",a.fill(),a.lineWidth=10,a.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",a.stroke(),a.closePath(),o.update();let u=new Ee("teleportationPlaneMaterial",e);u.diffuseTexture=o,t.material=u}let i=vn("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){let n=new te("animationInnerCircle","position.y",30,te.ANIMATIONTYPE_FLOAT,te.ANIMATIONLOOPMODE_CYCLE),o=[];o.push({frame:0,value:0}),o.push({frame:30,value:.4}),o.push({frame:60,value:0}),n.setKeys(o);let a=new hd;a.setEasingMode(fs.EASINGMODE_EASEINOUT),n.setEasingFunction(a),i.animations=[],i.animations.push(n),e.beginAnimation(i,0,60,!0)}let r=qs("rotationCone",{diameterTop:0,tessellation:4},e);if(r.isPickable=!1,r.scaling.set(.5,.12,.2),r.rotate(qt.X,Math.PI/2),r.position.z=.6,r.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,r.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{let n=new Ee("torusConsMat",e);n.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,n.disableLighting?n.emissiveColor=new X(.3,.3,1):n.diffuseColor=new X(.3,.3,1),n.alpha=.9,i.material=n,r.material=n,this._teleportationRingMaterial=n}this._options.renderingGroupId!==void 0&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._options.teleportationTargetMesh.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._setTargetMeshVisibility(!1)}_detachController(e){let t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,r=Number.MAX_VALUE;if(this._snapToPositions.length){let n=t*t;this._snapToPositions.forEach(o=>{let a=p.DistanceSquared(o,e);a<=n&&a<r&&(r=a,i=o)})}return i}_setTargetMeshPosition(e){let t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;let i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,t,i){this._options.teleportationTargetMesh&&(this._options.teleportationTargetMesh.isVisible===e&&!t||(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach(r=>{r.isVisible=e}),e?this._selectionFeature&&i&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&i&&this._selectionFeature.attach())))}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;let t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||ji.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],r=cd.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),n=i.teleportationState.blocked?this._blockedRayColor:void 0,o=this._colorArray.fill(n||this._cachedColor4White),a=r.getPoints();a.shift(),a.shift(),this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(r.getPoints(),e):this._quadraticBezierCurve=da("teleportation path line",{points:a,instance:this._quadraticBezierCurve,updatable:!0,colors:o},t),this._quadraticBezierCurve.isPickable=!1,this._options.renderingGroupId!==void 0&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){let t=this._controllers[e];if(!(!t||!t.teleportationState.forward||!this.teleportationEnabled)&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!(this.snapPointsOnly&&!this._snappedToPoint))){if(this.skipNextTeleportation){this.skipNextTeleportation=!1;return}if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){let i=this._options.xrInput.xrCamera.realWorldHeight;this.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=i,q.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}};nl.Name=ct.TELEPORTATION;nl.Version=1;mt.AddWebXRFeature(nl.Name,(s,e)=>()=>new nl(s,e),nl.Version,!0);var ET=class s{constructor(){}static CreateAsync(e,t={}){let i=new s;if(e.onDisposeObservable.addOnce(()=>{i.dispose()}),!t.disableDefaultUI){let r=ie({renderTarget:i.renderTarget},t.uiOptions||{});t.optionalFeatures&&(typeof t.optionalFeatures=="boolean"?r.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:r.optionalFeatures=t.optionalFeatures),i.enterExitUI=new ST(e,r)}return vT.CreateAsync(e).then(r=>{if(i.baseExperience=r,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new bT(r.sessionManager,r.camera,ie({controllerOptions:{renderingGroupId:t.renderingGroupId}},t.inputOptions||{})),!t.disablePointerSelection){let n=Kt(ie({},t.pointerSelectionOptions),{xrInput:i.input,renderingGroupId:t.renderingGroupId});i.pointerSelection=i.baseExperience.featuresManager.enableFeature(Ta.Name,t.useStablePlugins?"stable":"latest",n),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(nl.Name,t.useStablePlugins?"stable":"latest",ie({floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId},t.teleportationOptions)),i.teleportation.setSelectionFeature(i.pointerSelection))}if(t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(Ca.Name,t.useStablePlugins?"stable":"latest",ie({xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0},t.nearInteractionOptions))),t.disableHandTracking||i.baseExperience.featuresManager.enableFeature(ms.Name,t.useStablePlugins?"stable":"latest",ie({xrInput:i.input},t.handSupportOptions),void 0,!1),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),!t.disableDefaultUI)return i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)}).then(()=>i).catch(r=>(F.Error("Error initializing XR"),F.Error(r),i))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}};Te.prototype.createDefaultLight=function(s=!1){if(s&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();this.lights.length===0&&new as("default light",p.Up(),this)};Te.prototype.createDefaultCamera=function(s=!1,e=!1,t=!1){if(e&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){let i=this.getWorldExtends(l=>l.isVisible&&l.isEnabled()),r=i.max.subtract(i.min),n=i.min.add(r.scale(.5)),o,a=r.length()*1.5;if(isFinite(a)||(a=1,n.copyFromFloats(0,0,0)),s){let l=new Bt("default camera",-(Math.PI/2),Math.PI/2,a,n,this);l.lowerRadiusLimit=a*.01,l.wheelPrecision=100/a,o=l}else{let l=new wi("default camera",new p(n.x,n.y,-a),this);l.setTarget(n),o=l}o.minZ=a*.01,o.maxZ=a*1e3,o.speed=a*.2,this.activeCamera=o,t&&o.attachControl()}};Te.prototype.createDefaultCameraOrLight=function(s=!1,e=!1,t=!1){this.createDefaultLight(e),this.createDefaultCamera(s,e,t)};Te.prototype.createDefaultSkybox=function(s,e=!1,t=1e3,i=0,r=!0){if(!s)return F.Warn("Can not create default skybox without environment texture."),null;r&&s&&(this.environmentTexture=s);let n=ha("hdrSkyBox",{size:t},this);if(e){let o=new Pe("skyBox",this);o.backFaceCulling=!1,o.reflectionTexture=s.clone(),o.reflectionTexture&&(o.reflectionTexture.coordinatesMode=z.SKYBOX_MODE),o.microSurface=1-i,o.disableLighting=!0,o.twoSidedLighting=!0,n.material=o}else{let o=new Ee("skyBox",this);o.backFaceCulling=!1,o.reflectionTexture=s.clone(),o.reflectionTexture&&(o.reflectionTexture.coordinatesMode=z.SKYBOX_MODE),o.disableLighting=!0,n.material=o}return n.isPickable=!1,n.infiniteDistance=!0,n.ignoreCameraMaxZ=!0,n};Te.prototype.createDefaultEnvironment=function(s){return v0?new v0(s,this):null};Te.prototype.createDefaultVRExperience=function(s={}){return new uB(this,s)};Te.prototype.createDefaultXRExperienceAsync=function(s={}){return ET.CreateAsync(this,s).then(e=>e)};function yV(s){for(;s.firstChild;)s.removeChild(s.firstChild);s.srcObject=null,s.src="",s.removeAttribute("src")}var ol=class s extends z{get onUserActionRequestedObservable(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new U),this._onUserActionRequestedObservable}_processError(e){this._errorFound=!0,this._onError?this._onError(e?.message):F.Error(e?.message)}_handlePlay(){this._errorFound=!1,this.video.play().catch(e=>{if(e?.name==="NotAllowedError"){if(this._onUserActionRequestedObservable&&this._onUserActionRequestedObservable.hasObservers()){this._onUserActionRequestedObservable.notifyObservers(this);return}else if(!this.video.muted){F.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this._errorFound=!1,this.video.play().catch(t=>{this._processError(t)});return}}this._processError(e)})}constructor(e,t,i,r=!1,n=!1,o=z.TRILINEAR_SAMPLINGMODE,a={},l,c=5){super(null,i,!r,n),this._externalTexture=null,this._onUserActionRequestedObservable=null,this._stillImageCaptured=!1,this._displayingPosterTexture=!1,this._frameId=-1,this._currentSrc=null,this._errorFound=!1,this.isVideo=!0,this._resizeInternalTexture=()=>{this._texture!=null&&this._texture.dispose(),!this._getEngine().needPOTTextures||H.IsExponentOfTwo(this.video.videoWidth)&&H.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=z.WRAP_ADDRESSMODE,this.wrapV=z.WRAP_ADDRESSMODE):(this.wrapU=z.CLAMP_ADDRESSMODE,this.wrapV=z.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),this._texture=this._getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this.samplingMode),this._texture.format=this._format??5,this._frameId=-1,this._updateInternalTexture()},this._createInternalTexture=()=>{if(this._texture!=null)if(this._displayingPosterTexture)this._displayingPosterTexture=!1;else return;if(this.video.addEventListener("resize",this._resizeInternalTexture),this._resizeInternalTexture(),!this.video.autoplay&&!this._settings.poster&&!this._settings.independentVideoSource){let f=this.video.onplaying,m=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=m,this.video.onplaying=f,this._updateInternalTexture(),this._errorFound||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._handlePlay()}else this._updateInternalTexture(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._reset=()=>{this._texture!=null&&(this._displayingPosterTexture||(this._texture.dispose(),this._texture=null))},this._updateInternalTexture=()=>{if(this._texture==null||this.video.readyState<this.video.HAVE_CURRENT_DATA||this._displayingPosterTexture)return;let f=this.getScene().getFrameId();this._frameId!==f&&(this._frameId=f,this._getEngine().updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:this.video,this._invertY))},this._settings=ie({autoPlay:!0,loop:!0,autoUpdateTexture:!0},a),this._onError=l,this._generateMipMaps=r,this._initialSamplingMode=o,this.autoUpdateTexture=this._settings.autoUpdateTexture,this._currentSrc=t,this.name=e||this._getName(t),this.video=this._getVideo(t);let h=this._engine,u=h?.createExternalTexture;u&&(this._externalTexture=u.call(h,this.video)),this._settings.independentVideoSource||(this._settings.poster&&(this.video.poster=this._settings.poster),this._settings.autoPlay!==void 0&&(this.video.autoplay=this._settings.autoPlay),this._settings.loop!==void 0&&(this.video.loop=this._settings.loop),this._settings.muted!==void 0&&(this.video.muted=this._settings.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this._updateInternalTexture),this.video.addEventListener("seeked",this._updateInternalTexture),this.video.addEventListener("loadeddata",this._updateInternalTexture),this.video.addEventListener("emptied",this._reset),this._settings.autoPlay&&this._handlePlay()),this._createInternalTextureOnEvent=this._settings.poster&&!this._settings.autoPlay?"play":"canplay",this.video.addEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._format=c;let d=this.video.readyState>=this.video.HAVE_CURRENT_DATA;this._settings.poster&&(!this._settings.autoPlay||!d)?(this._texture=this._getEngine().createTexture(this._settings.poster,!1,!this.invertY,i),this._displayingPosterTexture=!0):d&&this._createInternalTexture()}getClassName(){return"VideoTexture"}_getName(e){return e instanceof HTMLVideoElement?e.currentSrc:typeof e=="object"?e.toString():e}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return H.SetCorsBehavior(e.currentSrc,e),e;let t=document.createElement("video");return typeof e=="string"?(H.SetCorsBehavior(e,t),t.src=e):(H.SetCorsBehavior(e[0],t),e.forEach(i=>{let r=document.createElement("source");r.src=i,t.appendChild(r)})),this.onDisposeObservable.addOnce(()=>{yV(t)}),t}_rebuild(){this.update()}update(){this.autoUpdateTexture&&this.updateTexture(!0)}updateTexture(e){e&&(this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture()))}get externalTexture(){return this._externalTexture}updateURL(e){this.video.src=e,this._currentSrc=e}clone(){return new s(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)}dispose(){super.dispose(),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._settings.independentVideoSource||(this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("loadeddata",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.removeEventListener("resize",this._resizeInternalTexture),this.video.pause()),this._externalTexture?.dispose()}static CreateFromStreamAsync(e,t,i,r=!0){let n=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(n),n.style.transform="scale(0.0001, 0.0001)",n.style.opacity="0",n.style.position="fixed",n.style.bottom="0px",n.style.right="0px"),n.setAttribute("autoplay",""),n.setAttribute("muted","true"),n.setAttribute("playsinline",""),n.muted=!0,n.isNative||(n.mozSrcObject!==void 0?n.mozSrcObject=t:typeof n.srcObject=="object"?n.srcObject=t:n.src=window.URL&&window.URL.createObjectURL(t)),new Promise(o=>{let a=()=>{let l=new s("video",n,e,!0,r,void 0,void 0,void 0,4);e.getEngine()._badOS&&l.onDisposeObservable.addOnce(()=>{n.remove()}),l.onDisposeObservable.addOnce(()=>{yV(n)}),o(l),n.removeEventListener("playing",a)};n.addEventListener("playing",a),n.play()})}static CreateFromWebCamAsync(e,t,i=!1,r=!0){return $e(this,null,function*(){if(navigator.mediaDevices){let n=yield navigator.mediaDevices.getUserMedia({video:t,audio:i}),o=yield this.CreateFromStreamAsync(e,n,t,r);return o.onDisposeObservable.addOnce(()=>{n.getTracks().forEach(a=>{a.stop()})}),o}return Promise.reject("No support for userMedia on this device")})}static CreateFromWebCam(e,t,i,r=!1,n=!0){this.CreateFromWebCamAsync(e,i,r,n).then(function(o){t&&t(o)}).catch(function(o){F.Error(o.name)})}};v([I("settings")],ol.prototype,"_settings",void 0);v([I("src")],ol.prototype,"_currentSrc",void 0);v([I()],ol.prototype,"isVideo",void 0);z._CreateVideoTexture=(s,e,t,i=!1,r=!1,n=z.TRILINEAR_SAMPLINGMODE,o={},a,l=5)=>new ol(s,e,t,i,r,n,o,a,l);P("BABYLON.VideoTexture",ol);var Nm=class extends xa{get videoTexture(){return this._texture}get videoMode(){return this.textureMode}set videoMode(e){this.textureMode=e}_initTexture(e,t,i){let r={loop:i.loop,autoPlay:i.autoPlay,autoUpdateTexture:!0,poster:i.poster},n=new ol((this.name||"videoDome")+"_texture",e,t,i.generateMipMaps,this._useDirectMapping,z.TRILINEAR_SAMPLINGMODE,r);return i.clickToPlay&&(this._pointerObserver=t.onPointerObservable.add(o=>{o.pickInfo?.pickedMesh===this.mesh&&this._texture.video.play()},Ae.POINTERDOWN)),this._textureObserver=n.onLoadObservable.add(()=>{this.onLoadObservable.notifyObservers()}),n}dispose(e,t=!1){this._texture.onLoadObservable.remove(this._textureObserver),this._scene.onPointerObservable.remove(this._pointerObserver),super.dispose(e,t)}};Nm.MODE_MONOSCOPIC=xa.MODE_MONOSCOPIC;Nm.MODE_TOPBOTTOM=xa.MODE_TOPBOTTOM;Nm.MODE_SIDEBYSIDE=xa.MODE_SIDEBYSIDE;var P8="glowMapGenerationPixelShader",M8=`#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)
#include<helperFunctions>
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;uniform sampler2D diffuseSampler;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;uniform sampler2D opacitySampler;uniform float opacityIntensity;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;uniform sampler2D emissiveSampler;
#endif
#ifdef VERTEXALPHA
varying vec4 vColor;
#endif
uniform vec4 glowColor;uniform float glowIntensity;
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
vec4 finalColor=glowColor;
#ifdef DIFFUSE
vec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);
#ifdef DIFFUSE_ISLINEAR
albedoTexture=toGammaSpace(albedoTexture);
#endif
#ifdef GLOW
finalColor.a*=albedoTexture.a;
#endif
#ifdef HIGHLIGHT
finalColor.a=albedoTexture.a;
#endif
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vUVOpacity);
#ifdef OPACITYRGB
finalColor.a*=getLuminance(opacityMap.rgb);
#else
finalColor.a*=opacityMap.a;
#endif
finalColor.a*=opacityIntensity;
#endif
#ifdef VERTEXALPHA
finalColor.a*=vColor.a;
#endif
#ifdef ALPHATEST
if (finalColor.a<ALPHATESTVALUE)
discard;
#endif
#ifdef EMISSIVE
vec4 emissive=texture2D(emissiveSampler,vUVEmissive);
#ifdef EMISSIVE_ISLINEAR
emissive=toGammaSpace(emissive);
#endif
gl_FragColor=emissive*finalColor*glowIntensity;
#else
gl_FragColor=finalColor*glowIntensity;
#endif
#ifdef HIGHLIGHT
gl_FragColor.a=glowColor.a;
#endif
}`;D.ShadersStore[P8]=M8;var D8="glowMapGenerationVertexShader",O8=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;varying vec4 vPosition;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;uniform mat4 diffuseMatrix;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;uniform mat4 opacityMatrix;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;uniform mat4 emissiveMatrix;
#endif
#ifdef VERTEXALPHA
attribute vec4 color;varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef CUBEMAP
vPosition=worldPos;gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#else
vPosition=viewProjection*worldPos;gl_Position=vPosition;
#endif
#ifdef DIFFUSE
#ifdef DIFFUSEUV1
vUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef DIFFUSEUV2
vUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef OPACITY
#ifdef OPACITYUV1
vUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef OPACITYUV2
vUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef EMISSIVE
#ifdef EMISSIVEUV1
vUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef EMISSIVEUV2
vUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef VERTEXALPHA
vColor=color;
#endif
#include<clipPlaneVertex>
}`;D.ShadersStore[D8]=O8;var bs=class s{get camera(){return this._effectLayerOptions.camera}get renderingGroupId(){return this._effectLayerOptions.renderingGroupId}set renderingGroupId(e){this._effectLayerOptions.renderingGroupId=e}get mainTexture(){return this._mainTexture}setMaterialForRendering(e,t){if(this._mainTexture.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){let r=e[i];t?this._materialForRendering[r.uniqueId]=[r,t]:delete this._materialForRendering[r.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}getEffectIntensity(e){return this._effectIntensity[e.uniqueId]??1}setEffectIntensity(e,t){this._effectIntensity[e.uniqueId]=t}constructor(e,t){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new oe},this._effectIntensity={},this.neutralColor=new oe,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new U,this.onBeforeRenderMainTextureObservable=new U,this.onBeforeComposeObservable=new U,this.onBeforeRenderMeshToEffect=new U,this.onAfterRenderMeshToEffect=new U,this.onAfterComposeObservable=new U,this.onSizeChangedObservable=new U,this._materialForRendering={},this.name=e,this._scene=t||me.LastCreatedScene,s._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}_numInternalDraws(){return 1}_init(e){this._effectLayerOptions=ie({mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,generateStencilBuffer:!1},e),this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses()}_generateIndexBuffer(){let e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){let e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);let t=new y(this._engine,e,y.PositionKind,!1,!1,2);this._vertexBuffers[y.PositionKind]=t}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?Rr(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?Rr(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new vt("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,this._effectLayerOptions.mainTextureType,!1,z.TRILINEAR_SAMPLINGMODE,!0,this._effectLayerOptions.generateStencilBuffer),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=z.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=z.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(z.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0;for(let e in this._materialForRendering){let[t,i]=this._materialForRendering[e];this._mainTexture.setMaterialForRendering(t,i)}if(this._mainTexture.customIsReadyFunction=(e,t,i)=>{if((i||t===0)&&e.subMeshes)for(let r=0;r<e.subMeshes.length;++r){let n=e.subMeshes[r],o=n.getMaterial(),a=n.getRenderingMesh();if(!o)continue;let c=a._getInstancesRenderList(n._id,!!n.getReplacementMesh()).hardwareInstancedRendering[n._id]||a.hasThinInstances;if(this._setEmissiveTextureAndColor(a,n,o),!this._isReady(n,c,this._emissiveTextureAndColor.texture))return!1}return!0},this._mainTexture.customRenderFunction=(e,t,i,r)=>{this.onBeforeRenderMainTextureObservable.notifyObservers(this);let n,o=this._scene.getEngine();if(r.length){for(o.setColorWrite(!1),n=0;n<r.length;n++)this._renderSubMesh(r.data[n]);o.setColorWrite(!0)}for(n=0;n<e.length;n++)this._renderSubMesh(e.data[n]);for(n=0;n<t.length;n++)this._renderSubMesh(t.data[n]);let a=o.getAlphaMode();for(n=0;n<i.length;n++)this._renderSubMesh(i.data[n],!0);o.setAlphaMode(a)},this._mainTexture.onClearObservable.add(e=>{e.clear(this.neutralColor,!0,!0,!0)}),this._scene.getBoundingBoxRenderer){let e=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&e}),this._mainTexture.onAfterUnbindObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=e})}}_addCustomEffectDefines(e){}_isReady(e,t,i){let r=this._scene.getEngine(),n=e.getMesh(),o=n._internalAbstractMeshDataInfo._materialForRenderPass?.[r.currentRenderPassId];if(o)return o.isReadyForSubMesh(n,e,t);let a=e.getMaterial();if(!a)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return a.isReadyForSubMesh(e.getMesh(),e,t);let l=[],c=[y.PositionKind],h=!1,u=!1;if(a){let b=a.needAlphaTesting(),C=a.getAlphaTestTexture(),R=C&&C.hasAlpha&&(a.useAlphaFromDiffuseTexture||a._useAlphaFromAlbedoTexture);C&&(b||R)&&(l.push("#define DIFFUSE"),n.isVerticesDataPresent(y.UV2Kind)&&C.coordinatesIndex===1?(l.push("#define DIFFUSEUV2"),u=!0):n.isVerticesDataPresent(y.UVKind)&&(l.push("#define DIFFUSEUV1"),h=!0),b&&(l.push("#define ALPHATEST"),l.push("#define ALPHATESTVALUE 0.4")),C.gammaSpace||l.push("#define DIFFUSE_ISLINEAR"));let E=a.opacityTexture;E&&(l.push("#define OPACITY"),n.isVerticesDataPresent(y.UV2Kind)&&E.coordinatesIndex===1?(l.push("#define OPACITYUV2"),u=!0):n.isVerticesDataPresent(y.UVKind)&&(l.push("#define OPACITYUV1"),h=!0))}i&&(l.push("#define EMISSIVE"),n.isVerticesDataPresent(y.UV2Kind)&&i.coordinatesIndex===1?(l.push("#define EMISSIVEUV2"),u=!0):n.isVerticesDataPresent(y.UVKind)&&(l.push("#define EMISSIVEUV1"),h=!0),i.gammaSpace||l.push("#define EMISSIVE_ISLINEAR")),n.useVertexColors&&n.isVerticesDataPresent(y.ColorKind)&&n.hasVertexAlpha&&a.transparencyMode!==se.MATERIAL_OPAQUE&&(c.push(y.ColorKind),l.push("#define VERTEXALPHA")),h&&(c.push(y.UVKind),l.push("#define UV1")),u&&(c.push(y.UV2Kind),l.push("#define UV2"));let d=new ps;if(n.useBones&&n.computeBonesUsingShaders){c.push(y.MatricesIndicesKind),c.push(y.MatricesWeightsKind),n.numBoneInfluencers>4&&(c.push(y.MatricesIndicesExtraKind),c.push(y.MatricesWeightsExtraKind)),l.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers);let b=n.skeleton;b&&b.isUsingTextureForMatrices?l.push("#define BONETEXTURE"):l.push("#define BonesPerMesh "+(b?b.bones.length+1:0)),n.numBoneInfluencers>0&&d.addCPUSkinningFallback(0,n)}else l.push("#define NUM_BONE_INFLUENCERS 0");let f=n.morphTargetManager,m=0;f&&(m=f.numMaxInfluencers||f.numInfluencers,m>0&&(l.push("#define MORPHTARGETS"),l.push("#define NUM_MORPH_INFLUENCERS "+m),f.isUsingTextureForTargets&&l.push("#define MORPHTARGETS_TEXTURE"),oo(c,n,m))),t&&(l.push("#define INSTANCES"),Ds(c),e.getRenderingMesh().hasThinInstances&&l.push("#define THIN_INSTANCES")),cs(a,this._scene,l),this._addCustomEffectDefines(l);let g=e._getDrawWrapper(void 0,!0),_=g.defines,x=l.join(`
`);if(_!==x){let b=["world","mBones","viewProjection","glowColor","morphTargetInfluences","morphTargetCount","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices","glowIntensity"];er(b),g.setEffect(this._engine.createEffect("glowMapGeneration",c,b,["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],x,d,void 0,void 0,{maxSimultaneousMorphTargets:m}),x)}return g.effect.isReady()}render(){for(let o=0;o<this._postProcesses.length;o++)if(!this._postProcesses[o].isReady())return;let e=this._scene.getEngine(),t=this._numInternalDraws(),i=!0;for(let o=0;o<t;++o){let a=this._mergeDrawWrapper[o];a||(a=this._mergeDrawWrapper[o]=new Xt(this._engine),a.setEffect(this._createMergeEffect())),i=i&&a.effect.isReady()}if(!i)return;this.onBeforeComposeObservable.notifyObservers(this);let r=e.getAlphaMode();for(let o=0;o<t;++o){let a=this._mergeDrawWrapper[o];e.enableEffect(a),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,a.effect),e.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(a.effect,o)}e.setAlphaMode(r),this.onAfterComposeObservable.notifyObservers(this);let n=this._mainTexture.getSize();this._setMainTextureSize(),(n.width!==this._mainTextureDesiredSize.width||n.height!==this._mainTextureDesiredSize.height)&&this._mainTextureDesiredSize.width!==0&&this._mainTextureDesiredSize.height!==0&&(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}hasMesh(e){return this.renderingGroupId===-1||e.renderingGroupId===this.renderingGroupId}shouldRender(){return this.isEnabled&&this._shouldRender}_shouldRenderMesh(e){return!0}_canRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_shouldRenderEmissiveTextureForMesh(){return!0}_renderSubMesh(e,t=!1){if(!this.shouldRender())return;let i=e.getMaterial(),r=e.getMesh(),n=e.getReplacementMesh(),o=e.getRenderingMesh(),a=e.getEffectiveMesh(),l=this._scene,c=l.getEngine();if(a._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!i||!this._canRenderMesh(o,i))return;let h=i._getEffectiveOrientation(o);a._getWorldMatrixDeterminant()<0&&(h=h===se.ClockWiseSideOrientation?se.CounterClockWiseSideOrientation:se.ClockWiseSideOrientation);let d=h===se.ClockWiseSideOrientation;c.setState(i.backFaceCulling,i.zOffset,void 0,d,i.cullBackFaces,void 0,i.zOffsetUnits);let f=o._getInstancesRenderList(e._id,!!n);if(f.mustReturn||!this._shouldRenderMesh(o))return;let m=f.hardwareInstancedRendering[e._id]||o.hasThinInstances;if(this._setEmissiveTextureAndColor(o,e,i),this.onBeforeRenderMeshToEffect.notifyObservers(r),this._useMeshMaterial(o))o.render(e,t,n||void 0);else if(this._isReady(e,m,this._emissiveTextureAndColor.texture)){let g=a._internalAbstractMeshDataInfo._materialForRenderPass?.[c.currentRenderPassId],_=e._getDrawWrapper();if(!_&&g&&(_=g._getDrawWrapper()),!_)return;let x=_.effect;if(c.enableEffect(_),m||o._bind(e,x,i.fillMode),g?g.bindForSubMesh(a.getWorldMatrix(),a,e):(x.setMatrix("viewProjection",l.getTransformMatrix()),x.setMatrix("world",a.getWorldMatrix()),x.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!g){let b=i.needAlphaTesting(),C=i.getAlphaTestTexture(),R=C&&C.hasAlpha&&(i.useAlphaFromDiffuseTexture||i._useAlphaFromAlbedoTexture);if(C&&(b||R)){x.setTexture("diffuseSampler",C);let S=C.getTextureMatrix();S&&x.setMatrix("diffuseMatrix",S)}let E=i.opacityTexture;if(E){x.setTexture("opacitySampler",E),x.setFloat("opacityIntensity",E.level);let S=E.getTextureMatrix();S&&x.setMatrix("opacityMatrix",S)}if(this._emissiveTextureAndColor.texture&&(x.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),x.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),o.useBones&&o.computeBonesUsingShaders&&o.skeleton){let S=o.skeleton;if(S.isUsingTextureForMatrices){let A=S.getTransformMatrixTexture(o);if(!A)return;x.setTexture("boneSampler",A),x.setFloat("boneTextureWidth",4*(S.bones.length+1))}else x.setMatrices("mBones",S.getTransformMatrices(o))}Vr(o,x),o.morphTargetManager&&o.morphTargetManager.isUsingTextureForTargets&&o.morphTargetManager._bind(x),t&&c.setAlphaMode(i.alphaMode),x.setFloat("glowIntensity",this.getEffectIntensity(o)),Yi(x,i,l)}o._processRendering(a,e,x,i.fillMode,f,m,(b,C)=>x.setMatrix("world",C))}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(r)}_useMeshMaterial(e){return!1}_rebuild(){let e=this._vertexBuffers[y.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){let e=this._vertexBuffers[y.PositionKind];e&&(e.dispose(),this._vertexBuffers[y.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(let i of this._mergeDrawWrapper)i.dispose();this._mergeDrawWrapper=[],this._disposeTextureAndPostProcesses();let t=this._scene.effectLayers.indexOf(this,0);t>-1&&this._scene.effectLayers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return H.Instantiate(e.customType).Parse(e,t,i)}};bs._SceneComponentInitialization=s=>{throw We("EffectLayerSceneComponent")};v([I()],bs.prototype,"name",void 0);v([_u()],bs.prototype,"neutralColor",void 0);v([I()],bs.prototype,"isEnabled",void 0);v([IO()],bs.prototype,"camera",null);v([I()],bs.prototype,"renderingGroupId",null);v([I()],bs.prototype,"disableBoundingBoxesFromEffectLayer",void 0);Jt.AddParser(ye.NAME_EFFECTLAYER,(s,e,t,i)=>{if(s.effectLayers){t.effectLayers||(t.effectLayers=[]);for(let r=0;r<s.effectLayers.length;r++){let n=bs.Parse(s.effectLayers[r],e,i);t.effectLayers.push(n)}}});Jt.prototype.removeEffectLayer=function(s){let e=this.effectLayers.indexOf(s);return e!==-1&&this.effectLayers.splice(e,1),e};Jt.prototype.addEffectLayer=function(s){this.effectLayers.push(s)};var F0=class{constructor(e){this.name=ye.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||me.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.effectLayers=[])}register(){this.scene._isReadyForMeshStage.registerStep(ye.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(ye.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(ye.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(ye.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(ye.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(ye.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){let e=this.scene.effectLayers;for(let t of e)t._rebuild()}serialize(e){e.effectLayers=[];let t=this.scene.effectLayers;for(let i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){e.effectLayers&&e.effectLayers.forEach(t=>{this.scene.addEffectLayer(t)})}removeFromContainer(e,t){e.effectLayers&&e.effectLayers.forEach(i=>{this.scene.removeEffectLayer(i),t&&i.dispose()})}dispose(){let e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){let i=this._engine.currentRenderPassId,r=this.scene.effectLayers;for(let n of r){if(!n.hasMesh(e))continue;let o=n._mainTexture;this._engine.currentRenderPassId=o.renderPassId;for(let a of e.subMeshes)if(!n.isReady(a,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1,i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(let r of i)if(r.shouldRender()&&(!r.camera||r.camera.cameraRigMode===Ce.RIG_MODE_NONE&&e===r.camera||r.camera.cameraRigMode!==Ce.RIG_MODE_NONE&&r.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||r.needStencil();let n=r._mainTexture;n._shouldRender()&&(this.scene.incrementRenderId(),n.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);let t=this.scene.effectLayers;for(let i=0;i<t.length;i++){let r=t[i];r.renderingGroupId===e&&r.shouldRender()&&r.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}};bs._SceneComponentInitialization=s=>{let e=s._getComponent(ye.NAME_EFFECTLAYER);e||(e=new F0(s),s._addComponent(e))};var w8="glowMapMergePixelShader",N8=`varying vec2 vUV;uniform sampler2D textureSampler;
#ifdef EMISSIVE
uniform sampler2D textureSampler2;
#endif
uniform float offset;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef EMISSIVE
baseColor+=texture2D(textureSampler2,vUV);baseColor*=offset;
#else
baseColor.a=abs(offset-baseColor.a);
#ifdef STROKE
float alpha=smoothstep(.0,.1,baseColor.a);baseColor.a=alpha;baseColor.rgb=baseColor.rgb*alpha;
#endif
#endif
#if LDR
baseColor=clamp(baseColor,0.,1.0);
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;D.ShadersStore[w8]=N8;var F8="glowMapMergeVertexShader",L8=`attribute vec2 position;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[F8]=L8;Jt.prototype.getGlowLayerByName=function(s){for(let e=0;e<this.effectLayers?.length;e++)if(this.effectLayers[e].name===s&&this.effectLayers[e].getEffectName()===Zn.EffectName)return this.effectLayers[e];return null};var Zn=class s extends bs{set blurKernelSize(e){if(e===this._options.blurKernelSize)return;this._options.blurKernelSize=e;let t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t}get blurKernelSize(){return this._options.blurKernelSize}set intensity(e){this._intensity=e}get intensity(){return this._intensity}constructor(e,t,i){super(e,t),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this.neutralColor=new oe(0,0,0,1),this._options=ie({mainTextureRatio:s.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,mainTextureType:0,generateStencilBuffer:!1},i),this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType,generateStencilBuffer:this._options.generateStencilBuffer})}getEffectName(){return s.EffectName}_createMergeEffect(){let e=`#define EMISSIVE 
`;return this._options.ldrMerge&&(e+=`#define LDR 
`),this._engine.createEffect("glowMapMerge",[y.PositionKind],["offset"],["textureSampler","textureSampler2"],e)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?Rr(e,this._maxSize):e,t=this._engine.needPOTTextures?Rr(t,this._maxSize):t;let i=0;this._engine.getCaps().textureHalfFloatRender?i=2:i=0,this._blurTexture1=new vt("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=z.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=z.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(z.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;let r=Math.floor(e/2),n=Math.floor(t/2);this._blurTexture2=new vt("GlowLayerBlurRTT2",{width:r,height:n},this._scene,!1,!0,i),this._blurTexture2.wrapU=z.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=z.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(z.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2];let o=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new Ci("GlowLayerHBP1",new j(1,0),o,{width:e,height:t},null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add(a=>{a.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess1=new Ci("GlowLayerVBP1",new j(0,1),o,{width:e,height:t},null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2=new Ci("GlowLayerHBP2",new j(1,0),o,{width:r,height:n},null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2.width=r,this._horizontalBlurPostprocess2.height=n,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add(a=>{a.setTexture("textureSampler",this._blurTexture1)}),this._verticalBlurPostprocess2=new Ci("GlowLayerVBP2",new j(0,1),o,{width:r,height:n},null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(()=>{let a=this._blurTexture1.renderTarget;if(a){this._scene.postProcessManager.directRender(this._postProcesses1,a,!0);let l=this._blurTexture2.renderTarget;l&&this._scene.postProcessManager.directRender(this._postProcesses2,l,!0),this._engine.unBindFramebuffer(l??a,!0)}}),this._postProcesses.map(a=>{a.autoClear=!1})}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(e,t){let i=e.getMaterial(),r=e.getRenderingMesh();if(!i||!r)return!1;let n=i.emissiveTexture;return super._isReady(e,t,n)}needStencil(){return!1}_canRenderMesh(e,t){return!0}_internalRender(e){e.setTexture("textureSampler",this._blurTexture1),e.setTexture("textureSampler2",this._blurTexture2),e.setFloat("offset",this._intensity);let t=this._engine,i=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(se.TriangleFillMode,0,6),t.setStencilBuffer(i)}_setEmissiveTextureAndColor(e,t,i){let r=1;if(this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(r=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector)this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color);else if(i.emissiveColor){let n=i.emissiveIntensity??1;r*=n,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*r,i.emissiveColor.g*r,i.emissiveColor.b*r,i.alpha)}else this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(e){return this.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define GLOW")}addExcludedMesh(e){this._excludedMeshes.indexOf(e.uniqueId)===-1&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){let t=this._excludedMeshes.indexOf(e.uniqueId);t!==-1&&this._excludedMeshes.splice(t,1)}addIncludedOnlyMesh(e){this._includedOnlyMeshes.indexOf(e.uniqueId)===-1&&this._includedOnlyMeshes.push(e.uniqueId)}removeIncludedOnlyMesh(e){let t=this._includedOnlyMeshes.indexOf(e.uniqueId);t!==-1&&this._includedOnlyMeshes.splice(t,1)}hasMesh(e){return super.hasMesh(e)?this._includedOnlyMeshes.length?this._includedOnlyMeshes.indexOf(e.uniqueId)!==-1:this._excludedMeshes.length?this._excludedMeshes.indexOf(e.uniqueId)===-1:!0:!1}_useMeshMaterial(e){return this._meshesUsingTheirOwnMaterials.length==0?!1:this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(e){e.resetDrawCache(this._mainTexture.renderPassId),this._meshesUsingTheirOwnMaterials.push(e.uniqueId),e.onDisposeObservable.add(()=>{this._disposeMesh(e)})}unReferenceMeshFromUsingItsOwnMaterial(e){let t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);for(;t>=0;)this._meshesUsingTheirOwnMaterials.splice(t,1),t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);e.resetDrawCache(this._mainTexture.renderPassId)}_disposeMesh(e){this.removeIncludedOnlyMesh(e),this.removeExcludedMesh(e)}getClassName(){return"GlowLayer"}serialize(){let e=ae.Serialize(this);e.customType="BABYLON.GlowLayer";let t;if(e.includedMeshes=[],this._includedOnlyMeshes.length)for(t=0;t<this._includedOnlyMeshes.length;t++){let i=this._scene.getMeshByUniqueId(this._includedOnlyMeshes[t]);i&&e.includedMeshes.push(i.id)}if(e.excludedMeshes=[],this._excludedMeshes.length)for(t=0;t<this._excludedMeshes.length;t++){let i=this._scene.getMeshByUniqueId(this._excludedMeshes[t]);i&&e.excludedMeshes.push(i.id)}return e}static Parse(e,t,i){let r=ae.Parse(()=>new s(e.name,t,e.options),e,t,i),n;for(n=0;n<e.excludedMeshes.length;n++){let o=t.getMeshById(e.excludedMeshes[n]);o&&r.addExcludedMesh(o)}for(n=0;n<e.includedMeshes.length;n++){let o=t.getMeshById(e.includedMeshes[n]);o&&r.addIncludedOnlyMesh(o)}return r}};Zn.EffectName="GlowLayer";Zn.DefaultBlurKernelSize=32;Zn.DefaultTextureRatio=.5;v([I()],Zn.prototype,"blurKernelSize",null);v([I()],Zn.prototype,"intensity",null);v([I("options")],Zn.prototype,"_options",void 0);P("BABYLON.GlowLayer",Zn);var B8="glowBlurPostProcessPixelShader",V8=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 direction;uniform float blurWidth;float getLuminance(vec3 color)
{return dot(color,vec3(0.2126,0.7152,0.0722));}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float weights[7];weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);vec2 texelStep=texelSize*direction*blurWidth;vec2 start=vUV-3.0*texelStep;vec4 baseColor=vec4(0.,0.,0.,0.);vec2 texelOffset=vec2(0.,0.);for (int i=0; i<7; i++)
{vec4 texel=texture2D(textureSampler,start+texelOffset);baseColor.a+=texel.a*weights[i];float luminance=getLuminance(baseColor.rgb);float luminanceTexel=getLuminance(texel.rgb);float choice=step(luminanceTexel,luminance);baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;texelOffset+=texelStep;}
gl_FragColor=baseColor;}`;D.ShadersStore[B8]=V8;Jt.prototype.getHighlightLayerByName=function(s){for(let e=0;e<this.effectLayers?.length;e++)if(this.effectLayers[e].name===s&&this.effectLayers[e].getEffectName()===An.EffectName)return this.effectLayers[e];return null};var AT=class extends ve{constructor(e,t,i,r,n,o=z.BILINEAR_SAMPLINGMODE,a,l){super(e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,r,n,o,a,l),this.direction=t,this.kernel=i,this.onApplyObservable.add(c=>{c.setFloat2("screenSize",this.width,this.height),c.setVector2("direction",this.direction),c.setFloat("blurWidth",this.kernel)})}},An=class s extends bs{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i){super(e,t),this.name=e,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new U,this.onAfterBlurObservable=new U,this._instanceGlowingMeshStencilReference=s.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this.neutralColor=s.NeutralColor,this._engine.isStencilEnable||F.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options=ie({mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0},i),this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType}),this._shouldRender=!1}getEffectName(){return s.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[y.PositionKind],["offset"],["textureSampler"],this._options.isStroke?`#define STROKE 
`:void 0)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?Rr(e,this._maxSize):e,t=this._engine.needPOTTextures?Rr(t,this._maxSize):t;let i=0;this._engine.getCaps().textureHalfFloatRender?i=2:i=0,this._blurTexture=new vt("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=z.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=z.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(z.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],this._options.alphaBlendingMode===2?(this._downSamplePostprocess=new qr("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add(r=>{r.setTexture("textureSampler",this._mainTexture)}),this._horizontalBlurPostprocess=new AT("HighlightLayerHBP",new j(1,0),this._options.blurHorizontalSize,1,null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(r=>{r.setFloat2("screenSize",e,t)}),this._verticalBlurPostprocess=new AT("HighlightLayerVBP",new j(0,1),this._options.blurVerticalSize,1,null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(r=>{r.setFloat2("screenSize",e,t)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new Ci("HighlightLayerHBP",new j(1,0),this._options.blurHorizontalSize/2,{width:e,height:t},null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess.width=e,this._horizontalBlurPostprocess.height=t,this._horizontalBlurPostprocess.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess.onApplyObservable.add(r=>{r.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess=new Ci("HighlightLayerVBP",new j(0,1),this._options.blurVerticalSize/2,{width:e,height:t},null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add(()=>{this.onBeforeBlurObservable.notifyObservers(this);let r=this._blurTexture.renderTarget;r&&(this._scene.postProcessManager.directRender(this._postProcesses,r,!0),this._engine.unBindFramebuffer(r,!0)),this.onAfterBlurObservable.notifyObservers(this)}),this._postProcesses.map(r=>{r.autoClear=!1})}needStencil(){return!0}isReady(e,t){let i=e.getMaterial(),r=e.getRenderingMesh();if(!i||!r||!this._meshes)return!1;let n=null,o=this._meshes[r.uniqueId];return o&&o.glowEmissiveOnly&&i&&(n=i.emissiveTexture),super._isReady(e,t,n)}_internalRender(e,t){e.setTexture("textureSampler",this._blurTexture);let i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&t===0&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(se.TriangleFillMode,0,6)),this.innerGlow&&t===1&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(se.TriangleFillMode,0,6)),i.restoreStencilState()}shouldRender(){return super.shouldRender()?!!this._meshes:!1}_shouldRenderMesh(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!super.hasMesh(e))}_canRenderMesh(e,t){return!0}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}_setEmissiveTextureAndColor(e,t,i){let r=this._meshes[e.uniqueId];r?this._emissiveTextureAndColor.color.set(r.color.r,r.color.g,r.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),r&&r.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}addExcludedMesh(e){if(!this._excludedMeshes)return;if(!this._excludedMeshes[e.uniqueId]){let i={mesh:e,beforeBind:null,afterRender:null,stencilState:!1};i.beforeBind=e.onBeforeBindObservable.add(r=>{i.stencilState=r.getEngine().getStencilBuffer(),r.getEngine().setStencilBuffer(!1)}),i.afterRender=e.onAfterRenderObservable.add(r=>{r.getEngine().setStencilBuffer(i.stencilState)}),this._excludedMeshes[e.uniqueId]=i}}removeExcludedMesh(e){if(!this._excludedMeshes)return;let t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!this._meshes||!super.hasMesh(e)?!1:this._meshes[e.uniqueId]!==void 0&&this._meshes[e.uniqueId]!==null}addMesh(e,t,i=!1){if(!this._meshes)return;let r=this._meshes[e.uniqueId];r?r.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add(n=>{this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[n.uniqueId]?this._defaultStencilReference(n):n.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))}),observerDefault:e.onAfterRenderObservable.add(n=>{this.isEnabled&&this._defaultStencilReference(n)}),glowEmissiveOnly:i},e.onDisposeObservable.add(()=>{this._disposeMesh(e)})),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;let t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(let i in this._meshes)if(this._meshes[i]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes){for(let e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){let t=this._meshes[e];t&&this.removeMesh(t.mesh)}}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(s.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(let e in this._meshes){let t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(let e in this._excludedMeshes){let t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){let e=ae.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(let t in this._meshes){let i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(let t in this._excludedMeshes){let i=this._excludedMeshes[t];i&&e.excludedMeshes.push(i.mesh.id)}return e}static Parse(e,t,i){let r=ae.Parse(()=>new s(e.name,t,e.options),e,t,i),n;for(n=0;n<e.excludedMeshes.length;n++){let o=t.getMeshById(e.excludedMeshes[n]);o&&r.addExcludedMesh(o)}for(n=0;n<e.meshes.length;n++){let o=e.meshes[n],a=t.getMeshById(o.meshId);a&&r.addMesh(a,X.FromArray(o.color),o.glowEmissiveOnly)}return r}};An.EffectName="HighlightLayer";An.NeutralColor=new oe(0,0,0,0);An.GlowingMeshStencilReference=2;An.NormalMeshStencilReference=1;v([I()],An.prototype,"innerGlow",void 0);v([I()],An.prototype,"outerGlow",void 0);v([I()],An.prototype,"blurHorizontalSize",null);v([I()],An.prototype,"blurVerticalSize",null);v([I("options")],An.prototype,"_options",void 0);P("BABYLON.HighlightLayer",An);var U8="layerPixelShader",k8=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef LINEAR
baseColor.rgb=toGammaSpace(baseColor.rgb);
#endif
#ifdef ALPHATEST
if (baseColor.a<0.4)
discard;
#endif
gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;D.ShadersStore[U8]=k8;var G8="layerVertexShader",z8=`attribute vec2 position;uniform vec2 scale;uniform vec2 offset;uniform mat4 textureMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 shiftedPosition=position*scale+offset;vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));gl_Position=vec4(shiftedPosition,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[G8]=z8;var IT=class s{static AddFlare(e,t,i,r,n){return new s(e,t,i,r,n)}constructor(e,t,i,r,n){this.size=e,this.position=t,this.alphaMode=6,this.color=i||new X(1,1,1),this.texture=r?new z(r,n.getScene(),!0):null,this._system=n;let o=n.scene.getEngine();this._drawWrapper=new Xt(o),this._drawWrapper.effect=o.createEffect("lensFlare",[y.PositionKind],["color","viewportMatrix"],["textureSampler"],""),n.lensFlares.push(this)}dispose(){this.texture&&this.texture.dispose();let e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)}};var W8="lensFlarePixelShader",H8=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;D.ShadersStore[W8]=H8;var X8="lensFlareVertexShader",Y8=`attribute vec2 position;uniform mat4 viewportMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=position*madd+madd;gl_Position=viewportMatrix*vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[X8]=Y8;var L0=(()=>{class s{get scene(){return this._scene}constructor(t,i,r){this.name=t,this.lensFlares=[],this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._vertexBuffers={},this._isEnabled=!0,this._scene=r||me.LastCreatedScene,s._SceneComponentInitialization(this._scene),this._emitter=i,this.id=t,r.lensFlareSystems.push(this),this.meshesSelectionPredicate=a=>r.activeCamera&&a.material&&a.isVisible&&a.isEnabled()&&a.isBlocker&&(a.layerMask&r.activeCamera.layerMask)!=0;let n=r.getEngine(),o=[];o.push(1,1),o.push(-1,1),o.push(-1,-1),o.push(1,-1),this._vertexBuffers[y.PositionKind]=new y(n,o,y.PositionKind,!1,!1,2),this._createIndexBuffer()}_createIndexBuffer(){let t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(t)}get isEnabled(){return this._isEnabled}set isEnabled(t){this._isEnabled=t}getScene(){return this._scene}getEmitter(){return this._emitter}setEmitter(t){this._emitter=t}getEmitterPosition(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position}computeEffectivePosition(t){let i=this.getEmitterPosition();i=p.Project(i,N.Identity(),this._scene.getTransformMatrix(),t),this._positionX=i.x,this._positionY=i.y,i=p.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(t.x-=this.viewportBorder,t.y-=this.viewportBorder,t.width+=this.viewportBorder*2,t.height+=this.viewportBorder*2,i.x+=this.viewportBorder,i.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);let r=this._scene.useRightHandedSystem;return i.z>0&&!r||i.z<0&&r?(this._positionX>t.x&&this._positionX<t.x+t.width&&this._positionY>t.y&&this._positionY<t.y+t.height,!0):!1}_isVisible(){if(!this._isEnabled||!this._scene.activeCamera)return!1;let i=this.getEmitterPosition().subtract(this._scene.activeCamera.globalPosition),r=i.length();i.normalize();let n=new pt(this._scene.activeCamera.globalPosition,i),o=this._scene.pickWithRay(n,this.meshesSelectionPredicate,!0);return!o||!o.hit||o.distance>r}render(){if(!this._scene.activeCamera)return!1;let t=this._scene.getEngine(),r=this._scene.activeCamera.viewport.toGlobal(t.getRenderWidth(!0),t.getRenderHeight(!0));if(!this.computeEffectivePosition(r)||!this._isVisible())return!1;let n,o;this._positionX<this.borderLimit+r.x?n=this.borderLimit+r.x-this._positionX:this._positionX>r.x+r.width-this.borderLimit?n=this._positionX-r.x-r.width+this.borderLimit:n=0,this._positionY<this.borderLimit+r.y?o=this.borderLimit+r.y-this._positionY:this._positionY>r.y+r.height-this.borderLimit?o=this._positionY-r.y-r.height+this.borderLimit:o=0;let a=n>o?n:o;a-=this.viewportBorder,a>this.borderLimit&&(a=this.borderLimit);let l=1-xe.Clamp(a/this.borderLimit,0,1);if(l<0)return!1;l>1&&(l=1),this.viewportBorder>0&&(r.x+=this.viewportBorder,r.y+=this.viewportBorder,r.width-=this.viewportBorder*2,r.height-=this.viewportBorder*2,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);let c=r.x+r.width/2,h=r.y+r.height/2,u=c-this._positionX,d=h-this._positionY;t.setState(!1),t.setDepthBuffer(!1);for(let f=0;f<this.lensFlares.length;f++){let m=this.lensFlares[f];if(!m._drawWrapper.effect.isReady()||m.texture&&!m.texture.isReady())continue;t.enableEffect(m._drawWrapper),t.bindBuffers(this._vertexBuffers,this._indexBuffer,m._drawWrapper.effect),t.setAlphaMode(m.alphaMode);let g=c-u*m.position,_=h-d*m.position,x=m.size,b=m.size*t.getAspectRatio(this._scene.activeCamera,!0),C=2*((g-r.x)/r.width)-1,R=1-2*((_-r.y)/r.height),E=N.FromValues(x/2,0,0,0,0,b/2,0,0,0,0,1,0,C,R,0,1);m._drawWrapper.effect.setMatrix("viewportMatrix",E),m._drawWrapper.effect.setTexture("textureSampler",m.texture),m._drawWrapper.effect.setFloat4("color",m.color.r*l,m.color.g*l,m.color.b*l,1),t.drawElementsType(se.TriangleFillMode,0,6)}return t.setDepthBuffer(!0),t.setAlphaMode(0),!0}rebuild(){this._createIndexBuffer();for(let t in this._vertexBuffers)this._vertexBuffers[t]?._rebuild()}dispose(){let t=this._vertexBuffers[y.PositionKind];for(t&&(t.dispose(),this._vertexBuffers[y.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();let i=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(i,1)}static Parse(t,i,r){let n=i.getLastEntryById(t.emitterId),o=t.name||"lensFlareSystem#"+t.emitterId,a=new s(o,n,i);a.id=t.id||o,a.borderLimit=t.borderLimit;for(let l=0;l<t.flares.length;l++){let c=t.flares[l];IT.AddFlare(c.size,c.position,X.FromArray(c.color),c.textureName?r+c.textureName:"",a)}return a}serialize(){let t={};t.id=this.id,t.name=this.name,t.emitterId=this.getEmitter().id,t.borderLimit=this.borderLimit,t.flares=[];for(let i=0;i<this.lensFlares.length;i++){let r=this.lensFlares[i];t.flares.push({size:r.size,position:r.position,color:r.color.asArray(),textureName:H.GetFilename(r.texture?r.texture.name:"")})}return t}}return s._SceneComponentInitialization=e=>{throw We("LensFlareSystemSceneComponent")},s})();Jt.AddParser(ye.NAME_LENSFLARESYSTEM,(s,e,t,i)=>{if(s.lensFlareSystems!==void 0&&s.lensFlareSystems!==null){t.lensFlareSystems||(t.lensFlareSystems=[]);for(let r=0,n=s.lensFlareSystems.length;r<n;r++){let o=s.lensFlareSystems[r],a=L0.Parse(o,e,i);t.lensFlareSystems.push(a)}}});Jt.prototype.getLensFlareSystemByName=function(s){for(let e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].name===s)return this.lensFlareSystems[e];return null};Jt.prototype.getLensFlareSystemById=function(s){for(let e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].id===s)return this.lensFlareSystems[e];return null};Jt.prototype.getLensFlareSystemByID=function(s){return this.getLensFlareSystemById(s)};Jt.prototype.removeLensFlareSystem=function(s){let e=this.lensFlareSystems.indexOf(s);return e!==-1&&this.lensFlareSystems.splice(e,1),e};Jt.prototype.addLensFlareSystem=function(s){this.lensFlareSystems.push(s)};var B0=class{constructor(e){this.name=ye.NAME_LENSFLARESYSTEM,this.scene=e,e.lensFlareSystems=[]}register(){this.scene._afterCameraDrawStage.registerStep(ye.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)}rebuild(){for(let e=0;e<this.scene.lensFlareSystems.length;e++)this.scene.lensFlareSystems[e].rebuild()}addFromContainer(e){e.lensFlareSystems&&e.lensFlareSystems.forEach(t=>{this.scene.addLensFlareSystem(t)})}removeFromContainer(e,t){e.lensFlareSystems&&e.lensFlareSystems.forEach(i=>{this.scene.removeLensFlareSystem(i),t&&i.dispose()})}serialize(e){e.lensFlareSystems=[];let t=this.scene.lensFlareSystems;for(let i of t)e.lensFlareSystems.push(i.serialize())}dispose(){let e=this.scene.lensFlareSystems;for(;e.length;)e[0].dispose()}_draw(e){if(this.scene.lensFlaresEnabled){let t=this.scene.lensFlareSystems;H.StartPerformanceCounter("Lens flares",t.length>0);for(let i of t)e.layerMask&i.layerMask&&i.render();H.EndPerformanceCounter("Lens flares",t.length>0)}}};L0._SceneComponentInitialization=s=>{let e=s._getComponent(ye.NAME_LENSFLARESYSTEM);e||(e=new B0(s),s._addComponent(e))};var $8="bayerDitherFunctions",j8=`float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}
float bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5*mod(_P,4.0)); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);}
float bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5 *mod(_P,4.0)); 
vec2 P4=floor(0.25*mod(_P,8.0)); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}
`;D.IncludesShadersStore[$8]=j8;var q8="shadowMapFragmentExtraDeclaration",Q8=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform float softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
uniform vec3 lightDataSM;varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;D.IncludesShadersStore[q8]=Q8;var K8="shadowMapFragment",Z8=`float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
depthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_FragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
gl_FragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;D.IncludesShadersStore[K8]=Z8;var J8="shadowMapPixelShader",eq=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEXTURE
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEXTURE
float alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;
#ifdef ALPHATESTVALUE
if (alphaFromAlphaTexture<ALPHATESTVALUE)
discard;
#endif
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEXTURE
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;
#endif
#endif
#include<shadowMapFragment>
}`;D.ShadersStore[J8]=eq;var tq="sceneVertexDeclaration",iq=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;
`;D.IncludesShadersStore[tq]=iq;var rq="meshVertexDeclaration",sq=`uniform mat4 world;uniform float visibility;
`;D.IncludesShadersStore[rq]=sq;var nq="shadowMapVertexDeclaration",oq=`#include<sceneVertexDeclaration>
#include<meshVertexDeclaration>
`;D.IncludesShadersStore[nq]=oq;var aq="shadowMapUboDeclaration",lq=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;D.IncludesShadersStore[aq]=lq;var cq="shadowMapVertexExtraDeclaration",hq=`#if SM_NORMALBIAS==1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;D.IncludesShadersStore[cq]=hq;var uq="shadowMapVertexNormalBias",dq=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;D.IncludesShadersStore[uq]=dq;var fq="shadowMapVertexMetric",pq=`#if SM_USEDISTANCE==1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#else
gl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
zSM=gl_Position.z;gl_Position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
vDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
`;D.IncludesShadersStore[fq]=pq;var mq="shadowMapVertexShader",gq=`attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#endif
#include<helperFunctions>
#include<__decl__shadowMapVertex>
#ifdef ALPHATEXTURE
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEXTURE
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;D.ShadersStore[mq]=gq;var _q="depthBoxBlurPixelShader",xq=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 colorDepth=vec4(0.0);for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));}`;D.ShadersStore[_q]=xq;var vq="shadowMapFragmentSoftTransparentShadow",Tq=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;
#endif
`;D.IncludesShadersStore[vq]=Tq;var Ss=(()=>{class s{get bias(){return this._bias}set bias(t){this._bias=t}get normalBias(){return this._normalBias}set normalBias(t){this._normalBias=t}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(t){this._blurBoxOffset!==t&&(this._blurBoxOffset=t,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(t){this._blurScale!==t&&(this._blurScale=t,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(t){this._blurKernel!==t&&(this._blurKernel=t,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(t){this._useKernelBlur!==t&&(this._useKernelBlur=t,this._disposeBlurPostProcesses())}get depthScale(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()}set depthScale(t){this._depthScale=t}_validateFilter(t){return t}get filter(){return this._filter}set filter(t){if(t=this._validateFilter(t),this._light.needCube()){if(t===s.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(t===s.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(t===s.FILTER_PCF||t===s.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((t===s.FILTER_PCF||t===s.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==t&&(this._filter=t,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get usePoissonSampling(){return this.filter===s.FILTER_POISSONSAMPLING}set usePoissonSampling(t){let i=this._validateFilter(s.FILTER_POISSONSAMPLING);!t&&this.filter!==s.FILTER_POISSONSAMPLING||(this.filter=t?i:s.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===s.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(t){let i=this._validateFilter(s.FILTER_EXPONENTIALSHADOWMAP);!t&&this.filter!==s.FILTER_EXPONENTIALSHADOWMAP||(this.filter=t?i:s.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===s.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(t){let i=this._validateFilter(s.FILTER_BLUREXPONENTIALSHADOWMAP);!t&&this.filter!==s.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=t?i:s.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===s.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(t){let i=this._validateFilter(s.FILTER_CLOSEEXPONENTIALSHADOWMAP);!t&&this.filter!==s.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=t?i:s.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===s.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(t){let i=this._validateFilter(s.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!t&&this.filter!==s.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=t?i:s.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===s.FILTER_PCF}set usePercentageCloserFiltering(t){let i=this._validateFilter(s.FILTER_PCF);!t&&this.filter!==s.FILTER_PCF||(this.filter=t?i:s.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(t){this._filteringQuality!==t&&(this._filteringQuality=t,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===s.FILTER_PCSS}set useContactHardeningShadow(t){let i=this._validateFilter(s.FILTER_PCSS);!t&&this.filter!==s.FILTER_PCSS||(this.filter=t?i:s.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(t){this._contactHardeningLightSizeUVRatio=t}get darkness(){return this._darkness}set darkness(t){this.setDarkness(t)}getDarkness(){return this._darkness}setDarkness(t){return t>=1?this._darkness=1:t<=0?this._darkness=0:this._darkness=t,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(t){this.setTransparencyShadow(t)}setTransparencyShadow(t){return this._transparencyShadow=t,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return s.CLASSNAME}addShadowCaster(t,i=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(t)===-1&&this._shadowMap.renderList.push(t),i)for(let r of t.getChildMeshes())this._shadowMap.renderList.indexOf(r)===-1&&this._shadowMap.renderList.push(r);return this}removeShadowCaster(t,i=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;let r=this._shadowMap.renderList.indexOf(t);if(r!==-1&&this._shadowMap.renderList.splice(r,1),i)for(let n of t.getChildren())this.removeShadowCaster(n);return this}getLight(){return this._light}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(t){this._mapSize=t,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(t,i,r,n,o){this.onBeforeShadowMapRenderObservable=new U,this.onAfterShadowMapRenderObservable=new U,this.onBeforeShadowMapRenderMeshObservable=new U,this.onAfterShadowMapRenderMeshObservable=new U,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=s.FILTER_NONE,this._filteringQuality=s.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=p.Zero(),this._viewMatrix=N.Zero(),this._projectionMatrix=N.Zero(),this._transformMatrix=N.Zero(),this._cachedPosition=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new p(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=N.Identity(),this._mapSize=t,this._light=i,this._scene=i.getScene(),this._camera=n??null,this._useRedTextureType=!!o;let a=i._shadowGenerators;a||(a=i._shadowGenerators=new Map),a.set(this._camera,this),this.id=i.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),s._SceneComponentInitialization(this._scene);let l=this._scene.getEngine().getCaps();r?l.textureFloatRender&&l.textureFloatLinearFiltering?this._textureType=1:l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:l.textureHalfFloatRender&&l.textureHalfFloatLinearFiltering?this._textureType=2:l.textureFloatRender&&l.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){let t=this._scene.getEngine();t._features.supportDepthStencilTexture?(this._shadowMap=new vt(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(t.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new vt(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),this._shadowMap===null)return;this._shadowMap.wrapU=z.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=z.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(z.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(n,o,a,l)=>this._renderForShadowMap(n,o,a,l),this._shadowMap.customIsReadyFunction=()=>!0;let t=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),t._debugPushGroup?.(`shadow map generation for pass id ${t.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(n=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=n,this._filter===s.FILTER_PCF&&t.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===s.FILTER_PCF&&t.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap){t._debugPopGroup?.(1);return}let n=this.getShadowMapForRendering();n&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,n.renderTarget,!0),t.unBindFramebuffer(n.renderTarget,!0),t._debugPopGroup?.(1))});let i=new oe(0,0,0,0),r=new oe(1,1,1,1);this._shadowMap.onClearObservable.add(n=>{this._filter===s.FILTER_PCF?n.clear(r,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?n.clear(i,!0,!0,!1):n.clear(r,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(n=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=n.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let n=Hc.MIN_RENDERINGGROUPS;n<Hc.MAX_RENDERINGGROUPS;n++)this._shadowMap.setRenderingAutoClearDepthStencil(n,!1)}_initializeBlurRTTAndPostProcesses(){let t=this._scene.getEngine(),i=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new vt(this._light.name+"_shadowMap2",i,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=z.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=z.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(z.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new Ci(this._light.name+"KernelBlurX",new j(1,0),this.blurKernel,1,null,z.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.width=i,this._kernelBlurXPostprocess.height=i,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(r=>{r.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new Ci(this._light.name+"KernelBlurY",new j(0,1),this.blurKernel,1,null,z.BILINEAR_SAMPLINGMODE,t,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new ve(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,z.BILINEAR_SAMPLINGMODE,t,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(r=>{r.setFloat2("screenSize",i,i),r.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(t,i,r,n){let o;if(n.length)for(o=0;o<n.length;o++)this._renderSubMeshForShadowMap(n.data[o]);for(o=0;o<t.length;o++)this._renderSubMeshForShadowMap(t.data[o]);for(o=0;o<i.length;o++)this._renderSubMeshForShadowMap(i.data[o]);if(this._transparencyShadow)for(o=0;o<r.length;o++)this._renderSubMeshForShadowMap(r.data[o],!0);else for(o=0;o<r.length;o++)r.data[o].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(t,i,r){i.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(t,i=!1){let r=t.getRenderingMesh(),n=t.getEffectiveMesh(),o=this._scene,a=o.getEngine(),l=t.getMaterial();if(n._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!l||t.verticesCount===0||t._renderId===o.getRenderId())return;let c=o.useRightHandedSystem,h=n._getWorldMatrixDeterminant()<0,u=l._getEffectiveOrientation(r);(h&&!c||!h&&c)&&(u=u===0?1:0);let d=u===0;a.setState(l.backFaceCulling,void 0,void 0,d,l.cullBackFaces);let f=r._getInstancesRenderList(t._id,!!t.getReplacementMesh());if(f.mustReturn)return;let m=a.getCaps().instancedArrays&&(f.visibleInstances[t._id]!==null&&f.visibleInstances[t._id]!==void 0||r.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(t)))if(this.isReady(t,m,i)){t._renderId=o.getRenderId();let g=l.shadowDepthWrapper,_=g?.getEffect(t,this,a.currentRenderPassId)??t._getDrawWrapper(),x=Xt.GetEffect(_);a.enableEffect(_),m||r._bind(t,x,l.fillMode),this.getTransformMatrix(),x.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===tt.LIGHTTYPEID_DIRECTIONALLIGHT?x.setVector3("lightDataSM",this._cachedDirection):x.setVector3("lightDataSM",this._cachedPosition);let b=this._getCamera();if(b&&x.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(b),this.getLight().getDepthMinZ(b)+this.getLight().getDepthMaxZ(b)),i&&this.enableSoftTransparentShadow&&x.setFloat("softTransparentShadowSM",n.visibility*l.alpha),g)t._setMainDrawWrapperOverride(_),g.standalone?g.baseMaterial.bindForSubMesh(n.getWorldMatrix(),r,t):l.bindForSubMesh(n.getWorldMatrix(),r,t),t._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(x.setTexture("diffuseSampler",this._opacityTexture),x.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),r.useBones&&r.computeBonesUsingShaders&&r.skeleton){let E=r.skeleton;if(E.isUsingTextureForMatrices){let S=E.getTransformMatrixTexture(r);if(!S)return;x.setTexture("boneSampler",S),x.setFloat("boneTextureWidth",4*(E.bones.length+1))}else x.setMatrices("mBones",E.getTransformMatrices(r))}Vr(r,x),r.morphTargetManager&&r.morphTargetManager.isUsingTextureForTargets&&r.morphTargetManager._bind(x);let R=t.getMesh().bakedVertexAnimationManager;m&&R&&R.isEnabled&&R.bind(x,!0),Yi(x,l,o)}!this._useUBO&&!g&&this._bindCustomEffectForRenderSubMeshForShadowMap(t,x,n),Pa(x,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();let C=n.getWorldMatrix();m&&(n.getMeshUniformBuffer().bindToEffect(x,"Mesh"),n.transferToEffect(C)),this.forceBackFacesOnly&&a.setState(!0,0,!1,!0,l.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(r),this.onBeforeShadowMapRenderObservable.notifyObservers(x),r._processRendering(n,t,x,l.fillMode,f,m,(R,E)=>{n!==r&&!R?(r.getMeshUniformBuffer().bindToEffect(x,"Mesh"),r.transferToEffect(E)):(n.getMeshUniformBuffer().bindToEffect(x,"Mesh"),n.transferToEffect(R?E:C))}),this.forceBackFacesOnly&&a.setState(!0,0,!1,!1,l.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(x),this.onAfterShadowMapRenderMeshObservable.notifyObservers(r)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){this._shadowMap&&(this.filter===s.FILTER_NONE||this.filter===s.FILTER_PCSS?this._shadowMap.updateSamplingMode(z.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(z.BILINEAR_SAMPLINGMODE))}forceCompilation(t,i){let r=ie({useInstances:!1},i),n=this.getShadowMap();if(!n){t&&t(this);return}let o=n.renderList;if(!o){t&&t(this);return}let a=[];for(let h of o)a.push(...h.subMeshes);if(a.length===0){t&&t(this);return}let l=0,c=()=>{if(!(!this._scene||!this._scene.getEngine())){for(;this.isReady(a[l],r.useInstances,a[l].getMaterial()?.needAlphaBlendingForMesh(a[l].getMesh())??!1);)if(l++,l>=a.length){t&&t(this);return}setTimeout(c,16)}};c()}forceCompilationAsync(t){return new Promise(i=>{this.forceCompilation(()=>{i()},t)})}_isReadyCustomDefines(t,i,r){}_prepareShadowDefines(t,i,r,n){r.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),r.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),r.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),r.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));let o=t.getMesh();return r.push("#define SM_NORMALBIAS "+(this.normalBias&&o.isVerticesDataPresent(y.NormalKind)?"1":"0")),r.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===tt.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),r.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),r.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&n?"1":"0")),this._isReadyCustomDefines(r,t,i),r}isReady(t,i,r){let n=t.getMaterial(),o=n?.shadowDepthWrapper;if(this._opacityTexture=null,!n)return!1;let a=[];if(this._prepareShadowDefines(t,i,a,r),o){if(!o.isReadyForSubMesh(t,a,this,i,this._scene.getEngine().currentRenderPassId))return!1}else{let l=t._getDrawWrapper(void 0,!0),c=l.effect,h=l.defines,u=[y.PositionKind],d=t.getMesh();this.normalBias&&d.isVerticesDataPresent(y.NormalKind)&&(u.push(y.NormalKind),a.push("#define NORMAL"),d.nonUniformScaling&&a.push("#define NONUNIFORMSCALING"));let f=n.needAlphaTesting();if((f||n.needAlphaBlending())&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=n.opacityTexture:this._opacityTexture=n.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;let C=n.alphaCutOff??s.DEFAULT_ALPHA_CUTOFF;a.push("#define ALPHATEXTURE"),f&&a.push(`#define ALPHATESTVALUE ${C}${C%1===0?".":""}`),d.isVerticesDataPresent(y.UVKind)&&(u.push(y.UVKind),a.push("#define UV1")),d.isVerticesDataPresent(y.UV2Kind)&&this._opacityTexture.coordinatesIndex===1&&(u.push(y.UV2Kind),a.push("#define UV2"))}let m=new ps;if(d.useBones&&d.computeBonesUsingShaders&&d.skeleton){u.push(y.MatricesIndicesKind),u.push(y.MatricesWeightsKind),d.numBoneInfluencers>4&&(u.push(y.MatricesIndicesExtraKind),u.push(y.MatricesWeightsExtraKind));let C=d.skeleton;a.push("#define NUM_BONE_INFLUENCERS "+d.numBoneInfluencers),d.numBoneInfluencers>0&&m.addCPUSkinningFallback(0,d),C.isUsingTextureForMatrices?a.push("#define BONETEXTURE"):a.push("#define BonesPerMesh "+(C.bones.length+1))}else a.push("#define NUM_BONE_INFLUENCERS 0");let g=d.morphTargetManager,_=0;if(g&&(_=g.numMaxInfluencers||g.numInfluencers,_>0&&(a.push("#define MORPHTARGETS"),a.push("#define NUM_MORPH_INFLUENCERS "+_),g.isUsingTextureForTargets&&a.push("#define MORPHTARGETS_TEXTURE"),oo(u,d,_))),cs(n,this._scene,a),i&&(a.push("#define INSTANCES"),Ds(u),t.getRenderingMesh().hasThinInstances&&a.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(let C of this.customShaderOptions.defines)a.indexOf(C)===-1&&a.push(C);let x=d.bakedVertexAnimationManager;i&&x&&x.isEnabled&&(a.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),u.push("bakedVertexAnimationSettingsInstanced"));let b=a.join(`
`);if(h!==b){h=b;let C="shadowMap",R=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],E=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],S=["Scene","Mesh"];if(er(R),this.customShaderOptions){if(C=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(let L of this.customShaderOptions.attributes)u.indexOf(L)===-1&&u.push(L);if(this.customShaderOptions.uniforms)for(let L of this.customShaderOptions.uniforms)R.indexOf(L)===-1&&R.push(L);if(this.customShaderOptions.samplers)for(let L of this.customShaderOptions.samplers)E.indexOf(L)===-1&&E.push(L)}let A=this._scene.getEngine();c=A.createEffect(C,{attributes:u,uniformsNames:R,uniformBuffersNames:S,samplers:E,defines:b,fallbacks:m,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:_}},A),l.setEffect(c,h)}if(!c.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(t,i){let r=this._scene,n=this._light;!r.shadowsEnabled||!n.shadowEnabled||(t["SHADOW"+i]=!0,this.useContactHardeningShadow?(t["SHADOWPCSS"+i]=!0,this._filteringQuality===s.QUALITY_LOW?t["SHADOWLOWQUALITY"+i]=!0:this._filteringQuality===s.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePercentageCloserFiltering?(t["SHADOWPCF"+i]=!0,this._filteringQuality===s.QUALITY_LOW?t["SHADOWLOWQUALITY"+i]=!0:this._filteringQuality===s.QUALITY_MEDIUM&&(t["SHADOWMEDIUMQUALITY"+i]=!0)):this.usePoissonSampling?t["SHADOWPOISSON"+i]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?t["SHADOWESM"+i]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(t["SHADOWCLOSEESM"+i]=!0),n.needCube()&&(t["SHADOWCUBE"+i]=!0))}bindShadowLight(t,i){let r=this._light;if(!this._scene.shadowsEnabled||!r.shadowEnabled)return;let o=this._getCamera();if(!o)return;let a=this.getShadowMap();if(!a)return;r.needCube()||i.setMatrix("lightMatrix"+t,this.getTransformMatrix());let l=this.getShadowMapForRendering();this._filter===s.FILTER_PCF?(i.setDepthStencilTexture("shadowTexture"+t,l),r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a.getSize().width,1/a.getSize().width,this.frustumEdgeFalloff,t)):this._filter===s.FILTER_PCSS?(i.setDepthStencilTexture("shadowTexture"+t,l),i.setTexture("depthTexture"+t,l),r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a.getSize().width,this._contactHardeningLightSizeUVRatio*a.getSize().width,this.frustumEdgeFalloff,t)):(i.setTexture("shadowTexture"+t,l),r._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/a.getSize().width,this.depthScale,this.frustumEdgeFalloff,t)),r._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(o),this.getLight().getDepthMinZ(o)+this.getLight().getDepthMaxZ(o),t)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){let t=this._scene;if(this._currentRenderId===t.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=t.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let i=this._light.position;if(this._light.computeTransformedInformation()&&(i=this._light.transformedPosition),p.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(p.Dot(this._lightDirection,p.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!i.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(i),this._cachedDirection.copyFrom(this._lightDirection),N.LookAtLHToRef(i,i.add(this._lightDirection),p.Up(),this._viewMatrix);let r=this.getShadowMap();if(r){let n=r.renderList;n&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,n)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){let t=this._shadowMap;if(!t)return;let i=t.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),i){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(let r of i)this._shadowMap.renderList.push(r)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(let t of this._sceneUBOs)t.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){let t=this._light._shadowGenerators.entries();for(let i=t.next();i.done!==!0;i=t.next()){let[r,n]=i.value;n===this&&this._light._shadowGenerators.delete(r)}this._light._shadowGenerators.size===0&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){let t={},i=this.getShadowMap();if(!i)return t;if(t.className=this.getClassName(),t.lightId=this._light.id,t.cameraId=this._camera?.id,t.id=this.id,t.mapSize=i.getRenderSize(),t.forceBackFacesOnly=this.forceBackFacesOnly,t.darkness=this.getDarkness(),t.transparencyShadow=this._transparencyShadow,t.frustumEdgeFalloff=this.frustumEdgeFalloff,t.bias=this.bias,t.normalBias=this.normalBias,t.usePercentageCloserFiltering=this.usePercentageCloserFiltering,t.useContactHardeningShadow=this.useContactHardeningShadow,t.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,t.filteringQuality=this.filteringQuality,t.useExponentialShadowMap=this.useExponentialShadowMap,t.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,t.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,t.usePoissonSampling=this.usePoissonSampling,t.depthScale=this.depthScale,t.blurBoxOffset=this.blurBoxOffset,t.blurKernel=this.blurKernel,t.blurScale=this.blurScale,t.useKernelBlur=this.useKernelBlur,t.renderList=[],i.renderList)for(let r=0;r<i.renderList.length;r++){let n=i.renderList[r];t.renderList.push(n.id)}return t}static Parse(t,i,r){let n=i.getLightById(t.lightId),o=t.cameraId!==void 0?i.getCameraById(t.cameraId):null,a=r?r(t.mapSize,n,o):new s(t.mapSize,n,void 0,o),l=a.getShadowMap();for(let c=0;c<t.renderList.length;c++)i.getMeshesById(t.renderList[c]).forEach(function(u){l&&(l.renderList||(l.renderList=[]),l.renderList.push(u))});return t.id!==void 0&&(a.id=t.id),a.forceBackFacesOnly=!!t.forceBackFacesOnly,t.darkness!==void 0&&a.setDarkness(t.darkness),t.transparencyShadow&&a.setTransparencyShadow(!0),t.frustumEdgeFalloff!==void 0&&(a.frustumEdgeFalloff=t.frustumEdgeFalloff),t.bias!==void 0&&(a.bias=t.bias),t.normalBias!==void 0&&(a.normalBias=t.normalBias),t.usePercentageCloserFiltering?a.usePercentageCloserFiltering=!0:t.useContactHardeningShadow?a.useContactHardeningShadow=!0:t.usePoissonSampling?a.usePoissonSampling=!0:t.useExponentialShadowMap?a.useExponentialShadowMap=!0:t.useBlurExponentialShadowMap?a.useBlurExponentialShadowMap=!0:t.useCloseExponentialShadowMap?a.useCloseExponentialShadowMap=!0:t.useBlurCloseExponentialShadowMap?a.useBlurCloseExponentialShadowMap=!0:t.useVarianceShadowMap?a.useExponentialShadowMap=!0:t.useBlurVarianceShadowMap&&(a.useBlurExponentialShadowMap=!0),t.contactHardeningLightSizeUVRatio!==void 0&&(a.contactHardeningLightSizeUVRatio=t.contactHardeningLightSizeUVRatio),t.filteringQuality!==void 0&&(a.filteringQuality=t.filteringQuality),t.depthScale&&(a.depthScale=t.depthScale),t.blurScale&&(a.blurScale=t.blurScale),t.blurBoxOffset&&(a.blurBoxOffset=t.blurBoxOffset),t.useKernelBlur&&(a.useKernelBlur=t.useKernelBlur),t.blurKernel&&(a.blurKernel=t.blurKernel),a}}return s.CLASSNAME="ShadowGenerator",s.FILTER_NONE=0,s.FILTER_EXPONENTIALSHADOWMAP=1,s.FILTER_POISSONSAMPLING=2,s.FILTER_BLUREXPONENTIALSHADOWMAP=3,s.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,s.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,s.FILTER_PCF=6,s.FILTER_PCSS=7,s.QUALITY_HIGH=0,s.QUALITY_MEDIUM=1,s.QUALITY_LOW=2,s.DEFAULT_ALPHA_CUTOFF=.5,s._SceneComponentInitialization=e=>{throw We("ShadowGeneratorSceneComponent")},s})();var Cq="depthPixelShader",bq=`#ifdef ALPHATEST
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
#ifdef STORE_CAMERASPACE_Z
varying vec4 vViewPos;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef STORE_CAMERASPACE_Z
#ifdef PACKED
gl_FragColor=pack(vViewPos.z);
#else
gl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);
#endif
#else
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
#endif
}`;D.ShadersStore[Cq]=bq;var Sq="pointCloudVertexDeclaration",yq=`#ifdef POINTSIZE
uniform float pointSize;
#endif
`;D.IncludesShadersStore[Sq]=yq;var Eq="depthVertexShader",Aq=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef STORE_CAMERASPACE_Z
uniform mat4 view;varying vec4 vViewPos;
#endif
#include<pointCloudVertexDeclaration>
varying float vDepthMetric;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
gl_Position=viewProjection*worldPos;
#ifdef STORE_CAMERASPACE_Z
vViewPos=view*worldPos;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));
#else
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#endif
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<pointCloudVertex>
}
`;D.ShadersStore[Eq]=Aq;var mh=(()=>{class s{setMaterialForRendering(t,i){this._depthMap.setMaterialForRendering(t,i)}constructor(t,i=1,r=null,n=!1,o=z.TRILINEAR_SAMPLINGMODE,a=!1,l){this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._scene=t,this._storeNonLinearDepth=n,this._storeCameraSpaceZ=a,this.isPacked=i===0,this.isPacked?this.clearColor=new oe(1,1,1,1):this.clearColor=new oe(a?1e8:1,0,0,1),s._SceneComponentInitialization(this._scene);let c=t.getEngine();this._camera=r,o!==z.NEAREST_SAMPLINGMODE&&(i===1&&!c._caps.textureFloatLinearFiltering&&(o=z.NEAREST_SAMPLINGMODE),i===2&&!c._caps.textureHalfFloatLinearFiltering&&(o=z.NEAREST_SAMPLINGMODE));let h=this.isPacked||!c._features.supportExtendedTextureFormats?5:6;this._depthMap=new vt(l??"DepthRenderer",{width:c.getRenderWidth(),height:c.getRenderHeight()},this._scene,!1,!0,i,!1,o,void 0,void 0,void 0,h),this._depthMap.wrapU=z.CLAMP_ADDRESSMODE,this._depthMap.wrapV=z.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(d=>{d.clear(this.clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{c._debugPushGroup?.("depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{c._debugPopGroup?.(1)}),this._depthMap.customIsReadyFunction=(d,f,m)=>{if((m||f===0)&&d.subMeshes)for(let g=0;g<d.subMeshes.length;++g){let _=d.subMeshes[g],x=_.getRenderingMesh(),b=x._getInstancesRenderList(_._id,!!_.getReplacementMesh()),C=c.getCaps().instancedArrays&&(b.visibleInstances[_._id]!==null&&b.visibleInstances[_._id]!==void 0||x.hasThinInstances);if(!this.isReady(_,C))return!1}return!0};let u=d=>{let f=d.getRenderingMesh(),m=d.getEffectiveMesh(),g=this._scene,_=g.getEngine(),x=d.getMaterial();if(m._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!x||m.infiniteDistance||x.disableDepthWrite||d.verticesCount===0||d._renderId===g.getRenderId())return;let b=m._getWorldMatrixDeterminant()<0,C=x._getEffectiveOrientation(f);b&&(C=C===0?1:0);let R=C===0;_.setState(x.backFaceCulling,0,!1,R,this.reverseCulling?!x.cullBackFaces:x.cullBackFaces);let E=f._getInstancesRenderList(d._id,!!d.getReplacementMesh());if(E.mustReturn)return;let S=_.getCaps().instancedArrays&&(E.visibleInstances[d._id]!==null&&E.visibleInstances[d._id]!==void 0||f.hasThinInstances),A=this._camera||g.activeCamera;if(this.isReady(d,S)&&A){d._renderId=g.getRenderId();let L=m._internalAbstractMeshDataInfo._materialForRenderPass?.[_.currentRenderPassId],G=d._getDrawWrapper();!G&&L&&(G=L._getDrawWrapper());let W=A.mode===Ce.ORTHOGRAPHIC_CAMERA;if(!G)return;let $=G.effect;_.enableEffect(G),S||f._bind(d,$,x.fillMode),L?L.bindForSubMesh(m.getWorldMatrix(),m,d):($.setMatrix("viewProjection",g.getTransformMatrix()),$.setMatrix("world",m.getWorldMatrix()),this._storeCameraSpaceZ&&$.setMatrix("view",g.getViewMatrix()));let re,we;if(W?(re=!_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:1,we=_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:1):(re=_.useReverseDepthBuffer&&_.isNDCHalfZRange?A.minZ:_.isNDCHalfZRange?0:A.minZ,we=_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:A.maxZ),$.setFloat2("depthValues",re,re+we),!L){if(x.needAlphaTesting()){let _e=x.getAlphaTestTexture();_e&&($.setTexture("diffuseSampler",_e),$.setMatrix("diffuseMatrix",_e.getTextureMatrix()))}if(f.useBones&&f.computeBonesUsingShaders&&f.skeleton){let _e=f.skeleton;if(_e.isUsingTextureForMatrices){let ce=_e.getTransformMatrixTexture(f);if(!ce)return;$.setTexture("boneSampler",ce),$.setFloat("boneTextureWidth",4*(_e.bones.length+1))}else $.setMatrices("mBones",_e.getTransformMatrices(f))}Yi($,x,g),Vr(f,$),f.morphTargetManager&&f.morphTargetManager.isUsingTextureForTargets&&f.morphTargetManager._bind($),x.pointsCloud&&$.setFloat("pointSize",x.pointSize)}f._processRendering(m,d,$,x.fillMode,E,S,(_e,ce)=>$.setMatrix("world",ce))}};this._depthMap.customRenderFunction=(d,f,m,g)=>{let _;if(g.length)for(_=0;_<g.length;_++)u(g.data[_]);for(_=0;_<d.length;_++)u(d.data[_]);for(_=0;_<f.length;_++)u(f.data[_]);if(this.forceDepthWriteTransparentMeshes)for(_=0;_<m.length;_++)u(m.data[_]);else for(_=0;_<m.length;_++)m.data[_].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}isReady(t,i){let r=this._scene.getEngine(),n=t.getMesh(),o=n.getScene(),a=n._internalAbstractMeshDataInfo._materialForRenderPass?.[r.currentRenderPassId];if(a)return a.isReadyForSubMesh(n,t,i);let l=t.getMaterial();if(!l||l.disableDepthWrite)return!1;let c=[],h=[y.PositionKind];l&&l.needAlphaTesting()&&l.getAlphaTestTexture()&&(c.push("#define ALPHATEST"),n.isVerticesDataPresent(y.UVKind)&&(h.push(y.UVKind),c.push("#define UV1")),n.isVerticesDataPresent(y.UV2Kind)&&(h.push(y.UV2Kind),c.push("#define UV2"))),n.useBones&&n.computeBonesUsingShaders?(h.push(y.MatricesIndicesKind),h.push(y.MatricesWeightsKind),n.numBoneInfluencers>4&&(h.push(y.MatricesIndicesExtraKind),h.push(y.MatricesWeightsExtraKind)),c.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),c.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0)),t.getRenderingMesh().skeleton?.isUsingTextureForMatrices&&c.push("#define BONETEXTURE")):c.push("#define NUM_BONE_INFLUENCERS 0");let u=n.morphTargetManager,d=0;u&&(d=u.numMaxInfluencers||u.numInfluencers,d>0&&(c.push("#define MORPHTARGETS"),c.push("#define NUM_MORPH_INFLUENCERS "+d),u.isUsingTextureForTargets&&c.push("#define MORPHTARGETS_TEXTURE"),oo(h,n,d))),l.pointsCloud&&c.push("#define POINTSIZE"),i&&(c.push("#define INSTANCES"),Ds(h),t.getRenderingMesh().hasThinInstances&&c.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&c.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&c.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&c.push("#define PACKED"),cs(l,o,c);let f=t._getDrawWrapper(void 0,!0),m=f.defines,g=c.join(`
`);if(m!==g){let _=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices"];er(_),f.setEffect(r.createEffect("depth",h,_,["diffuseSampler","morphTargets","boneSampler"],g,void 0,void 0,void 0,{maxSimultaneousMorphTargets:d}),g)}return f.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){let t=[];for(let i in this._scene._depthRenderer)this._scene._depthRenderer[i]===this&&t.push(i);if(t.length>0){this._depthMap.dispose();for(let i of t)delete this._scene._depthRenderer[i]}}}return s._SceneComponentInitialization=e=>{throw We("DepthRendererSceneComponent")},s})();var Iq="minmaxReduxPixelShader",Rq=`varying vec2 vUV;uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform sampler2D sourceTexture;uniform vec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(sourceTexture,coord,0).r;float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;float minz=min(min(min(f1,f2),f3),f4);
#ifdef DEPTH_REDUX
float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#else
float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(MAIN)
uniform vec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(f1.x,f2.x);float maxz=max(f1.y,f2.y);glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(LAST)
void main(void)
{glFragColor=vec4(0.);if (true) { 
discard;}}
#endif
`;D.ShadersStore[Iq]=Rq;var RT=class{constructor(e){this.onAfterReductionPerformed=new U,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new $a(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,r=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=r;let n=this._camera.getScene(),o=new ve("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,n.getEngine(),!1,"#define INITIAL"+(t?`
#define DEPTH_REDUX`:""),i,void 0,void 0,void 0,7);o.autoClear=!1,o.forceFullscreenViewport=r;let a=this._sourceTexture.getRenderWidth(),l=this._sourceTexture.getRenderHeight();o.onApply=((h,u)=>d=>{d.setTexture("sourceTexture",this._sourceTexture),d.setFloat2("texSize",h,u)})(a,l),this._reductionSteps.push(o);let c=1;for(;a>1||l>1;){a=Math.max(Math.round(a/2),1),l=Math.max(Math.round(l/2),1);let h=new ve("Reduction phase "+c,"minmaxRedux",["texSize"],null,{width:a,height:l},null,1,n.getEngine(),!1,"#define "+(a==1&&l==1?"LAST":a==1||l==1?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(h.autoClear=!1,h.forceFullscreenViewport=r,h.onApply=((u,d)=>f=>{u==1||d==1?f.setInt2("texSize",u,d):f.setFloat2("texSize",u,d)})(a,l),this._reductionSteps.push(h),c++,a==1&&l==1){let u=(d,f,m)=>{let g=new Float32Array(4*d*f),_={min:0,max:0};return()=>{n.getEngine()._readTexturePixels(m.inputTexture.texture,d,f,-1,0,g,!1),_.min=g[0],_.max=g[1],this.onAfterReductionPerformed.notifyObservers(_)}};h.onAfterRenderObservable.add(u(a,l,h))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{let e=this._camera.getScene().getEngine();e._debugPushGroup?.("min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),e.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),e._debugPopGroup?.(1)}),this._activated=!0)}deactivate(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let t=0;t<this._reductionSteps.length;++t)this._reductionSteps[t].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}};var PT=class extends RT{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){let r=this._camera.getScene();this._depthRenderer&&(delete r._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),e===null&&(r._depthRenderer||(r._depthRenderer={}),e=this._depthRenderer=new mh(r,t,this._camera,!1,1),e.enabled=!1,this._depthRendererId="minmax"+this._camera.id,r._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,r=!0){super.setSourceTexture(e,t,i,r)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){let t=this._depthRenderer.getDepthMap().getScene();t&&delete t._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}};var EV=p.Up(),Pq=p.Zero(),hr=new p,Gd=new p,MT=new N,Do=class s extends Ss{_validateFilter(e){return e===Ss.FILTER_NONE||e===Ss.FILTER_PCF||e===Ss.FILTER_PCSS?e:(F.Error('Unsupported filter "'+e+'"!'),Ss.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){e=Math.min(Math.max(e,s.MIN_CASCADES_COUNT),s.MAX_CASCADES_COUNT),e!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!e&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(()=>this._computeShadowCastersBoundingInfo())),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){let e=this._shadowMap.renderList;for(let i=0;i<e.length;i++){let r=e[i];if(!r)continue;let n=r.getBoundingInfo(),o=n.boundingBox;this._scbiMin.minimizeInPlace(o.minimumWorld),this._scbiMax.maximizeInPlace(o.maximumWorld)}let t=this._scene.meshes;for(let i=0;i<t.length;i++){let r=t[i];if(!r||!r.isVisible||!r.isEnabled||!r.receiveShadows)continue;let n=r.getBoundingInfo(),o=n.boundingBox;this._scbiMin.minimizeInPlace(o.minimumWorld),this._scbiMax.maximizeInPlace(o.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return s.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){let t=this._getCamera();if(!t){this._shadowMaxZ=e;return}this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&t.maxZ!==0||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){let t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){let t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new PT(t),this._depthReducer.onAfterReductionPerformed.add(i=>{let r=i.min,n=i.max;r>=n&&(r=0,n=1),(r!=this._minDistance||n!=this._maxDistance)&&this.setMinMaxDistance(r,n)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){return this._depthReducer?.depthRenderer?.getDepthMap().refreshRate??-1}set autoCalcDepthBoundsRefreshRate(e){this._depthReducer?.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){let e=this._getCamera();if(!e)return;let t=e.minZ,i=e.maxZ||this._shadowMaxZ,r=i-t,n=this._minDistance,o=this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance,a=t+n*r,l=t+o*r,c=l-a,h=l/a;for(let u=0;u<this._cascades.length;++u){let d=(u+1)/this._numCascades,f=a*h**d,m=a+c*d,g=this._lambda*(f-m)+m;this._cascades[u].prevBreakDistance=u===0?n:this._cascades[u-1].breakDistance,this._cascades[u].breakDistance=(g-t)/r,this._viewSpaceFrustumsZ[u]=g,this._frustumLengths[u]=(this._cascades[u].breakDistance-this._cascades[u].prevBreakDistance)*r}this._breaksAreDirty=!1}_computeMatrices(){let e=this._scene;if(!this._getCamera())return;p.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),Math.abs(p.Dot(this._lightDirection,p.Up()))===1&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);let i=e.getEngine().useReverseDepthBuffer;for(let r=0;r<this._numCascades;++r){this._computeFrustumInWorldSpace(r),this._computeCascadeFrustum(r),this._cascadeMaxExtents[r].subtractToRef(this._cascadeMinExtents[r],hr),this._frustumCenter[r].addToRef(this._lightDirection.scale(this._cascadeMinExtents[r].z),this._shadowCameraPos[r]),N.LookAtLHToRef(this._shadowCameraPos[r],this._frustumCenter[r],EV,this._viewMatrices[r]);let n=0,o=hr.z,a=this._shadowCastersBoundingInfo;a.update(this._viewMatrices[r]),o=Math.min(o,a.boundingBox.maximumWorld.z),!this._depthClamp||this.filter===Ss.FILTER_PCSS?n=Math.min(n,a.boundingBox.minimumWorld.z):n=Math.max(n,a.boundingBox.minimumWorld.z),N.OrthoOffCenterLHToRef(this._cascadeMinExtents[r].x,this._cascadeMaxExtents[r].x,this._cascadeMinExtents[r].y,this._cascadeMaxExtents[r].y,i?o:n,i?n:o,this._projectionMatrices[r],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[r].z=n,this._cascadeMaxExtents[r].z=o,this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),p.TransformCoordinatesToRef(Pq,this._transformMatrices[r],hr),hr.scaleInPlace(this._mapSize/2),Gd.copyFromFloats(Math.round(hr.x),Math.round(hr.y),Math.round(hr.z)),Gd.subtractInPlace(hr).scaleInPlace(2/this._mapSize),N.TranslationToRef(Gd.x,Gd.y,0,MT),this._projectionMatrices[r].multiplyToRef(MT,this._projectionMatrices[r]),this._viewMatrices[r].multiplyToRef(this._projectionMatrices[r],this._transformMatrices[r]),this._transformMatrices[r].copyToArray(this._transformMatricesAsArray,r*16)}}_computeFrustumInWorldSpace(e){let t=this._getCamera();if(!t)return;let i=this._cascades[e].prevBreakDistance,r=this._cascades[e].breakDistance,n=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();let o=t.maxZ===0,a=t.maxZ;o&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));let l=N.Invert(t.getTransformationMatrix());o&&(t.maxZ=a,t.getProjectionMatrix(!0));let c=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let h=0;h<s._FrustumCornersNDCSpace.length;++h)hr.copyFrom(s._FrustumCornersNDCSpace[(h+c)%s._FrustumCornersNDCSpace.length]),n&&hr.z===-1&&(hr.z=0),p.TransformCoordinatesToRef(hr,l,this._frustumCornersWorldSpace[e][h]);for(let h=0;h<s._FrustumCornersNDCSpace.length/2;++h)hr.copyFrom(this._frustumCornersWorldSpace[e][h+4]).subtractInPlace(this._frustumCornersWorldSpace[e][h]),Gd.copyFrom(hr).scaleInPlace(i),hr.scaleInPlace(r),hr.addInPlace(this._frustumCornersWorldSpace[e][h]),this._frustumCornersWorldSpace[e][h+4].copyFrom(hr),this._frustumCornersWorldSpace[e][h].addInPlace(Gd)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),!!this._getCamera()){for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][i]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let i=0;for(let r=0;r<this._frustumCornersWorldSpace[e].length;++r){let n=this._frustumCornersWorldSpace[e][r].subtractToRef(this._frustumCenter[e],hr).length();i=Math.max(i,n)}i=Math.ceil(i*16)/16,this._cascadeMaxExtents[e].copyFromFloats(i,i,i),this._cascadeMinExtents[e].copyFromFloats(-i,-i,-i)}else{let i=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,hr),N.LookAtLHToRef(i,hr,EV,MT);for(let r=0;r<this._frustumCornersWorldSpace[e].length;++r)p.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][r],MT,hr),this._cascadeMinExtents[e].minimizeInPlace(hr),this._cascadeMaxExtents[e].maximizeInPlace(hr)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){let e=me.LastCreatedEngine;return e?e._features.supportCSM:!1}constructor(e,t,i,r,n=!0){if(!s.IsSupported){F.Error("CascadedShadowMap is not supported by the current engine.");return}super(e,t,i,r,n),this.usePercentageCloserFiltering=!0}_initializeGenerator(){this.penumbraDarkness=this.penumbraDarkness??1,this._numCascades=this._numCascades??s.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=this.stabilizeCascades??!1,this._freezeShadowCastersBoundingInfoObservable=this._freezeShadowCastersBoundingInfoObservable??null,this.freezeShadowCastersBoundingInfo=this.freezeShadowCastersBoundingInfo??!1,this._scbiMin=this._scbiMin??new p(0,0,0),this._scbiMax=this._scbiMax??new p(0,0,0),this._shadowCastersBoundingInfo=this._shadowCastersBoundingInfo??new dr(new p(0,0,0),new p(0,0,0)),this._breaksAreDirty=this._breaksAreDirty??!0,this._minDistance=this._minDistance??0,this._maxDistance=this._maxDistance??1,this._currentLayer=this._currentLayer??0,this._shadowMaxZ=this._shadowMaxZ??this._getCamera()?.maxZ??1e4,this._debug=this._debug??!1,this._depthClamp=this._depthClamp??!0,this._cascadeBlendPercentage=this._cascadeBlendPercentage??.1,this._lambda=this._lambda??.5,this._autoCalcDepthBounds=this._autoCalcDepthBounds??!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){let e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new vt(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForCSMShadowGenerator-${this._light.name}`),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),this._shadowMap===null)return;this._transformMatricesAsArray=new Float32Array(this._numCascades*16),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(this._numCascades*2),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let t=0;t<this._numCascades;++t){this._cascades[t]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[t]=N.Zero(),this._projectionMatrices[t]=N.Zero(),this._transformMatrices[t]=N.Zero(),this._cascadeMinExtents[t]=new p,this._cascadeMaxExtents[t]=new p,this._frustumCenter[t]=new p,this._shadowCameraPos[t]=new p,this._frustumCornersWorldSpace[t]=new Array(s._FrustumCornersNDCSpace.length);for(let i=0;i<s._FrustumCornersNDCSpace.length;++i)this._frustumCornersWorldSpace[t][i]=new p}let e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===Ss.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==Ss.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);let i=this._scene,r=this._light;if(!i.shadowsEnabled||!r.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;let n=this._getCamera();n&&this._shadowMaxZ<=(n.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),this.cascadeBlendPercentage===0&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){let i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;let n=this._getCamera();if(!n)return;let o=this.getShadowMap();if(!o)return;let a=o.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,this.cascadeBlendPercentage===0?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===Ss.FILTER_PCF)t.setDepthStencilTexture("shadowTexture"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,e);else if(this._filter===Ss.FILTER_PCSS){for(let l=0;l<this._numCascades;++l)this._lightSizeUVCorrection[l*2+0]=l===0?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[l].x-this._cascadeMinExtents[l].x),this._lightSizeUVCorrection[l*2+1]=l===0?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[l].y-this._cascadeMinExtents[l].y),this._depthCorrection[l]=l===0?1:(this._cascadeMaxExtents[l].z-this._cascadeMinExtents[l].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowTexture"+e,o),t.setTexture("depthTexture"+e,o),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/a,this._contactHardeningLightSizeUVRatio*a,this.frustumEdgeFalloff,e)}else t.setTexture("shadowTexture"+e,o),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),a,1/a,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(n),this.getLight().getDepthMinZ(n)+this.getLight().getDepthMaxZ(n),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){let e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){let r=t.renderList[i];e.renderList.push(r.id)}return e}static Parse(e,t){let i=Ss.Parse(e,t,(r,n,o)=>new s(r,n,void 0,o));return e.numCascades!==void 0&&(i.numCascades=e.numCascades),e.debug!==void 0&&(i.debug=e.debug),e.stabilizeCascades!==void 0&&(i.stabilizeCascades=e.stabilizeCascades),e.lambda!==void 0&&(i.lambda=e.lambda),e.cascadeBlendPercentage!==void 0&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),e.depthClamp!==void 0&&(i.depthClamp=e.depthClamp),e.autoCalcDepthBounds!==void 0&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),e.shadowMaxZ!==void 0&&(i.shadowMaxZ=e.shadowMaxZ),e.penumbraDarkness!==void 0&&(i.penumbraDarkness=e.penumbraDarkness),e.freezeShadowCastersBoundingInfo!==void 0&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),e.minDistance!==void 0&&e.maxDistance!==void 0&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}};Do._FrustumCornersNDCSpace=[new p(-1,1,-1),new p(1,1,-1),new p(1,-1,-1),new p(-1,-1,-1),new p(-1,1,1),new p(1,1,1),new p(1,-1,1),new p(-1,-1,1)];Do.CLASSNAME="CascadedShadowGenerator";Do.DEFAULT_CASCADES_COUNT=4;Do.MIN_CASCADES_COUNT=2;Do.MAX_CASCADES_COUNT=4;Do._SceneComponentInitialization=s=>{throw We("ShadowGeneratorSceneComponent")};Jt.AddParser(ye.NAME_SHADOWGENERATOR,(s,e)=>{if(s.shadowGenerators!==void 0&&s.shadowGenerators!==null)for(let t=0,i=s.shadowGenerators.length;t<i;t++){let r=s.shadowGenerators[t];r.className===Do.CLASSNAME?Do.Parse(r,e):Ss.Parse(r,e)}});var V0=class{constructor(e){this.name=ye.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(ye.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];let t=this.scene.lights;for(let i of t){let r=i.getShadowGenerators();if(r){let n=r.values();for(let o=n.next();o.done!==!0;o=n.next()){let a=o.value;e.shadowGenerators.push(a.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){let t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){let r=t.lights[i],n=r.getShadowGenerators();if(r.isEnabled()&&r.shadowEnabled&&n){let o=n.values();for(let a=o.next();a.done!==!0;a=o.next()){let c=a.value.getShadowMap();t.textures.indexOf(c)!==-1&&e.push(c)}}}}};Ss._SceneComponentInitialization=s=>{let e=s._getComponent(ye.NAME_SHADOWGENERATOR);e||(e=new V0(s),s._addComponent(e))};Xe.AddNodeConstructor("Light_Type_0",(s,e)=>()=>new In(s,p.Zero(),e));var In=class extends Kn{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){let t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){let i=this._shadowGenerators.values();for(let r=i.next();r.done!==!0;r=i.next())r.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return tt.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new p(1,0,0);case 1:return new p(-1,0,0);case 2:return new p(0,-1,0);case 3:return new p(0,1,0);case 4:return new p(0,0,1);case 5:return new p(0,0,-1)}return p.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){let r=this.getScene().activeCamera;if(!r)return;let n=this.shadowMinZ!==void 0?this.shadowMinZ:r.minZ,o=this.shadowMaxZ!==void 0?this.shadowMaxZ:r.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;N.PerspectiveFovLHToRef(this.shadowAngle,1,a?o:n,a?n:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}};v([I()],In.prototype,"shadowAngle",null);P("BABYLON.PointLight",In);var Mq=(()=>{class s{constructor(t,i="",r="black"){this._renderingCanvas=t,this._loadingText=i,this._loadingDivBackgroundColor=r,this._resizeLoadingUI=()=>{let n=this._renderingCanvas.getBoundingClientRect(),o=window.getComputedStyle(this._renderingCanvas).position;this._loadingDiv&&(this._loadingDiv.style.position=o==="fixed"?"fixed":"absolute",this._loadingDiv.style.left=n.left+"px",this._loadingDiv.style.top=n.top+"px",this._loadingDiv.style.width=n.width+"px",this._loadingDiv.style.height=n.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css";let t=`@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}
                    100% { -webkit-transform: rotate(360deg);}
                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}
                    100% { transform: rotate(360deg);}
                }`;this._style.innerHTML=t,document.getElementsByTagName("head")[0].appendChild(this._style);let i=!!window.SVGSVGElement,r=new Image;s.DefaultLogoUrl?r.src=s.DefaultLogoUrl:r.src=i?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",r.style.width="150px",r.style.gridColumn="1",r.style.gridRow="1",r.style.top="50%",r.style.left="50%",r.style.transform="translate(-50%, -50%)",r.style.position="absolute";let n=document.createElement("div");n.style.width="300px",n.style.gridColumn="1",n.style.gridRow="1",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.position="absolute";let o=new Image;if(s.DefaultSpinnerUrl?o.src=s.DefaultSpinnerUrl:o.src=i?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",o.style.animation="spin1 0.75s infinite linear",o.style.webkitAnimation="spin1 0.75s infinite linear",o.style.transformOrigin="50% 50%",o.style.webkitTransformOrigin="50% 50%",!i){let a={w:16,h:18.5},l={w:30,h:30};r.style.width=`${a.w}vh`,r.style.height=`${a.h}vh`,r.style.left=`calc(50% - ${a.w/2}vh)`,r.style.top=`calc(50% - ${a.h/2}vh)`,o.style.width=`${l.w}vh`,o.style.height=`${l.h}vh`,o.style.left=`calc(50% - ${l.w/2}vh)`,o.style.top=`calc(50% - ${l.h/2}vh)`}n.appendChild(o),this._loadingDiv.appendChild(r),this._loadingDiv.appendChild(n),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){if(!this._loadingDiv)return;let t=()=>{this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)};this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",t)}set loadingUIText(t){this._loadingText=t,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(t){this._loadingDivBackgroundColor=t,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}return s.DefaultLogoUrl="",s.DefaultSpinnerUrl="",s})();Se.DefaultLoadingScreenFactory=s=>new Mq(s);var Oo=class{static ConvertPanoramaToCubemap(e,t,i,r,n=!1){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";let o=this.CreateCubemapTexture(r,this.FACE_FRONT,e,t,i,n),a=this.CreateCubemapTexture(r,this.FACE_BACK,e,t,i,n),l=this.CreateCubemapTexture(r,this.FACE_LEFT,e,t,i,n),c=this.CreateCubemapTexture(r,this.FACE_RIGHT,e,t,i,n),h=this.CreateCubemapTexture(r,this.FACE_UP,e,t,i,n),u=this.CreateCubemapTexture(r,this.FACE_DOWN,e,t,i,n);return{front:o,back:a,left:l,right:c,up:h,down:u,size:r,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,r,n,o=!1){let a=new ArrayBuffer(e*e*4*3),l=new Float32Array(a),c=o?Math.max(1,Math.round(r/4/e)):1,h=1/c,u=h*h,d=t[1].subtract(t[0]).scale(h/e),f=t[3].subtract(t[2]).scale(h/e),m=1/e,g=0;for(let _=0;_<e;_++)for(let x=0;x<c;x++){let b=t[0],C=t[2];for(let R=0;R<e;R++)for(let E=0;E<c;E++){let S=C.subtract(b).scale(g).add(b);S.normalize();let A=this.CalcProjectionSpherical(S,i,r,n);l[_*e*3+R*3+0]+=A.r*u,l[_*e*3+R*3+1]+=A.g*u,l[_*e*3+R*3+2]+=A.b*u,b=b.add(d),C=C.add(f)}g+=m*h}return l}static CalcProjectionSpherical(e,t,i,r){let n=Math.atan2(e.z,e.x),o=Math.acos(e.y);for(;n<-Math.PI;)n+=2*Math.PI;for(;n>Math.PI;)n-=2*Math.PI;let a=n/Math.PI,l=o/Math.PI;a=a*.5+.5;let c=Math.round(a*i);c<0?c=0:c>=i&&(c=i-1);let h=Math.round(l*r);h<0?h=0:h>=r&&(h=r-1);let u=r-h-1,d=t[u*i*3+c*3+0],f=t[u*i*3+c*3+1],m=t[u*i*3+c*3+2];return{r:d,g:f,b:m}}};Oo.FACE_LEFT=[new p(-1,-1,-1),new p(1,-1,-1),new p(-1,1,-1),new p(1,1,-1)];Oo.FACE_RIGHT=[new p(1,-1,1),new p(-1,-1,1),new p(1,1,1),new p(-1,1,1)];Oo.FACE_FRONT=[new p(1,-1,-1),new p(1,-1,1),new p(1,1,-1),new p(1,1,1)];Oo.FACE_BACK=[new p(-1,-1,1),new p(-1,-1,-1),new p(-1,1,1),new p(-1,1,-1)];Oo.FACE_DOWN=[new p(1,1,-1),new p(1,1,1),new p(-1,1,-1),new p(-1,1,1)];Oo.FACE_UP=[new p(-1,-1,-1),new p(-1,-1,1),new p(1,-1,-1),new p(1,-1,1)];var gh=class{static _Ldexp(e,t){return t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t)}static _Rgbe2float(e,t,i,r,n,o){n>0?(n=this._Ldexp(1,n-136),e[o+0]=t*n,e[o+1]=i*n,e[o+2]=r*n):(e[o+0]=0,e[o+1]=0,e[o+2]=0)}static _ReadStringLine(e,t){let i="",r="";for(let n=t;n<e.length-t&&(r=String.fromCharCode(e[n]),r!=`
`);n++)i+=r;return i}static RGBE_ReadHeader(e){let t=0,i=0,r=this._ReadStringLine(e,0);if(r[0]!="#"||r[1]!="?")throw"Bad HDR Format.";let n=!1,o=!1,a=0;do a+=r.length+1,r=this._ReadStringLine(e,a),r=="FORMAT=32-bit_rle_rgbe"?o=!0:r.length==0&&(n=!0);while(!n);if(!o)throw"HDR Bad header format, unsupported FORMAT";a+=r.length+1,r=this._ReadStringLine(e,a);let c=/^-Y (.*) \+X (.*)$/g.exec(r);if(!c||c.length<3)throw"HDR Bad header format, no size";if(i=parseInt(c[2]),t=parseInt(c[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return a+=r.length+1,{height:t,width:i,dataPosition:a}}static GetCubeMapTextureData(e,t,i=!1){let r=new Uint8Array(e),n=this.RGBE_ReadHeader(r),o=this.RGBE_ReadPixels(r,n);return Oo.ConvertPanoramaToCubemap(o,n.width,n.height,t,i)}static RGBE_ReadPixels(e,t){return this._RGBEReadPixelsRLE(e,t)}static _RGBEReadPixelsRLE(e,t){let i=t.height,r=t.width,n,o,a,l,c,h=t.dataPosition,u=0,d=0,f=0,m=new ArrayBuffer(r*4),g=new Uint8Array(m),_=new ArrayBuffer(t.width*t.height*4*3),x=new Float32Array(_);for(;i>0;){if(n=e[h++],o=e[h++],a=e[h++],l=e[h++],n!=2||o!=2||a&128||t.width<8||t.width>32767)return this._RGBEReadPixelsNOTRLE(e,t);if((a<<8|l)!=r)throw"HDR Bad header format, wrong scan line width";for(u=0,f=0;f<4;f++)for(d=(f+1)*r;u<d;)if(n=e[h++],o=e[h++],n>128){if(c=n-128,c==0||c>d-u)throw"HDR Bad Format, bad scanline data (run)";for(;c-- >0;)g[u++]=o}else{if(c=n,c==0||c>d-u)throw"HDR Bad Format, bad scanline data (non-run)";if(g[u++]=o,--c>0)for(let b=0;b<c;b++)g[u++]=e[h++]}for(f=0;f<r;f++)n=g[f],o=g[f+r],a=g[f+2*r],l=g[f+3*r],this._Rgbe2float(x,n,o,a,l,(t.height-i)*r*3+f*3);i--}return x}static _RGBEReadPixelsNOTRLE(e,t){let i=t.height,r=t.width,n,o,a,l,c,h=t.dataPosition,u=new ArrayBuffer(t.width*t.height*4*3),d=new Float32Array(u);for(;i>0;){for(c=0;c<t.width;c++)n=e[h++],o=e[h++],a=e[h++],l=e[h++],this._Rgbe2float(d,n,o,a,l,(t.height-i)*r*3+c*3);i--}return d}};var Dq="hdrFilteringVertexShader",Oq=`attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
mat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[Dq]=Oq;var wq="hdrFilteringPixelShader",Nq=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform float alphaG;uniform samplerCube inputTexture;uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);gl_FragColor=vec4(color*hdrScale,1.0);}`;D.ShadersStore[wq]=Nq;var zd=class{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);let i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){let t=e.getSize().width,i=xe.ILog2(t)+1,r=this._effectWrapper.effect,n=this._createRenderTarget(t);this._effectRenderer.saveStates(),this._effectRenderer.setViewport();let o=e.getInternalTexture();o&&this._engine.updateTextureSamplingMode(3,o,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let a=[[new p(0,0,-1),new p(0,-1,0),new p(1,0,0)],[new p(0,0,1),new p(0,-1,0),new p(-1,0,0)],[new p(1,0,0),new p(0,0,1),new p(0,1,0)],[new p(1,0,0),new p(0,0,-1),new p(0,-1,0)],[new p(1,0,0),new p(0,-1,0),new p(0,0,1)],[new p(-1,0,0),new p(0,-1,0),new p(0,0,-1)]];r.setFloat("hdrScale",this.hdrScale),r.setFloat2("vFilteringInfo",e.getSize().width,i),r.setTexture("inputTexture",e);for(let h=0;h<6;h++){r.setVector3("up",a[h][0]),r.setVector3("right",a[h][1]),r.setVector3("front",a[h][2]);for(let u=0;u<i;u++){this._engine.bindFramebuffer(n,h,void 0,void 0,!0,u),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let d=Math.pow(2,(u-this._lodGenerationOffset)/this._lodGenerationScale)/t;u===0&&(d=0),r.setFloat("alphaG",d),this._effectRenderer.draw()}}this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture);let l=n.texture.type,c=n.texture.format;return n._swapAndDie(e._texture),e._texture.type=l,e._texture.format=c,e.gammaSpace=!1,e.lodGenerationOffset=this._lodGenerationOffset,e.lodGenerationScale=this._lodGenerationScale,e._prefiltered=!0,e}_createEffect(e,t){let i=[];return e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u"),new os({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:i,onCompiled:t})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e,t=null){return this._engine._features.allowTexturePrefiltering?new Promise(i=>{this._effectRenderer=new sa(this._engine),this._effectWrapper=this._createEffect(e),this._effectWrapper.effect.executeWhenCompiled(()=>{this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose(),i(),t&&t()})}):(F.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))}};var DT=(()=>{class s extends Qi{set isBlocking(t){this._isBlocking=t}get isBlocking(){return this._isBlocking}set rotationY(t){this._rotationY=t,this.setReflectionTextureMatrix(N.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(t){if(this._boundingBoxSize&&this._boundingBoxSize.equals(t))return;this._boundingBoxSize=t;let i=this.getScene();i&&i.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(t,i,r,n=!1,o=!0,a=!1,l=!1,c=null,h=null,u=!1){super(i),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=p.Zero(),this.onLoadObservable=new U,t&&(this._coordinatesMode=z.CUBIC_MODE,this.name=t,this.url=t,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=N.Identity(),this._prefilterOnLoad=l,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),c&&c()},this._onError=h,this.gammaSpace=a,this._noMipmap=n,this._size=r,this._supersample=u,this._generateHarmonics=o,this._texture=this._getFromCache(t,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?H.SetImmediate(()=>this._onLoad()):this._texture.onLoadedObservable.add(this._onLoad):this.getScene()?.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture())}getClassName(){return"HDRCubeTexture"}_loadTexture(){let t=this._getEngine(),i=t.getCaps(),r=0;i.textureFloat&&i.textureFloatLinearFiltering?r=1:i.textureHalfFloat&&i.textureHalfFloatLinearFiltering&&(r=2);let n=o=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;let a=gh.GetCubeMapTextureData(o,this._size,this._supersample);if(this._generateHarmonics){let u=Io.ConvertCubeMapToSphericalPolynomial(a);this.sphericalPolynomial=u}let l=[],c=null,h=null;for(let u=0;u<6;u++){r===2?h=new Uint16Array(this._size*this._size*3):r===0&&(c=new Uint8Array(this._size*this._size*3));let d=a[s._FacesMapping[u]];if(this.gammaSpace||h||c){for(let f=0;f<this._size*this._size;f++)if(this.gammaSpace&&(d[f*3+0]=Math.pow(d[f*3+0],pu),d[f*3+1]=Math.pow(d[f*3+1],pu),d[f*3+2]=Math.pow(d[f*3+2],pu)),h&&(h[f*3+0]=jn(d[f*3+0]),h[f*3+1]=jn(d[f*3+1]),h[f*3+2]=jn(d[f*3+2])),c){let m=Math.max(d[f*3+0]*255,0),g=Math.max(d[f*3+1]*255,0),_=Math.max(d[f*3+2]*255,0),x=Math.max(Math.max(m,g),_);if(x>255){let b=255/x;m*=b,g*=b,_*=b}c[f*3+0]=m,c[f*3+1]=g,c[f*3+2]=_}}h?l.push(h):c?l.push(c):l.push(d)}return l};if(t._features.allowTexturePrefiltering&&this._prefilterOnLoad){let o=this._onLoad,a=new zd(t);this._onLoad=()=>{a.prefilter(this,o)}}this._texture=t.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,r,this._noMipmap,n,null,this._onLoad,this._onError)}clone(){let t=new s(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(t){this._textureMatrix=t,t.updateFlag!==this._textureMatrix.updateFlag&&t.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1)}dispose(){this.onLoadObservable.clear(),super.dispose()}static Parse(t,i,r){let n=null;return t.name&&!t.isRenderTarget&&(n=new s(r+t.name,i,t.size,t.noMipmap,t.generateHarmonics,t.useInGammaSpace),n.name=t.name,n.hasAlpha=t.hasAlpha,n.level=t.level,n.coordinatesMode=t.coordinatesMode,n.isBlocking=t.isBlocking),n&&(t.boundingBoxPosition&&(n.boundingBoxPosition=p.FromArray(t.boundingBoxPosition)),t.boundingBoxSize&&(n.boundingBoxSize=p.FromArray(t.boundingBoxSize)),t.rotationY&&(n.rotationY=t.rotationY)),n}serialize(){if(!this.name)return null;let t={};return t.name=this.name,t.hasAlpha=this.hasAlpha,t.isCube=!0,t.level=this.level,t.size=this._size,t.coordinatesMode=this.coordinatesMode,t.useInGammaSpace=this.gammaSpace,t.generateHarmonics=this._generateHarmonics,t.customType="BABYLON.HDRCubeTexture",t.noMipmap=this._noMipmap,t.isBlocking=this._isBlocking,t.rotationY=this._rotationY,t}}return s._FacesMapping=["right","left","up","down","front","back"],s})();P("BABYLON.HDRCubeTexture",DT);var _h=class s{get influence(){return this._influence}set influence(e){if(this._influence===e)return;let t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new U,this._onDataLayoutChanged=new U,this._animationPropertiesOverride=null,this._scene=i||me.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){let t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){let t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){let t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){let t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){let e=ae.Clone(()=>new s(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){let e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),ae.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){let i=new s(e.name,e.influence);if(i.setPositions(e.positions),e.id!=null&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let r=0;r<e.animations.length;r++){let n=e.animations[r],o=Et("BABYLON.Animation");o&&i.animations.push(o.Parse(n))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);let r=new s(t,i,e.getScene());return r.setPositions(e.getVerticesData(y.PositionKind)),e.isVerticesDataPresent(y.NormalKind)&&r.setNormals(e.getVerticesData(y.NormalKind)),e.isVerticesDataPresent(y.TangentKind)&&r.setTangents(e.getVerticesData(y.TangentKind)),e.isVerticesDataPresent(y.UVKind)&&r.setUVs(e.getVerticesData(y.UVKind)),r}};v([I()],_h.prototype,"id",void 0);var OT=class s extends z{get depth(){return this._depth}constructor(e,t,i,r,n,o,a=!0,l=!1,c=z.TRILINEAR_SAMPLINGMODE,h=0,u){super(null,o,!a,l),this.format=n,this._texture=o.getEngine().createRawTexture2DArray(e,t,i,r,n,a,l,c,null,h,u),this._depth=r,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,r,n,o=!0,a=!1,l=3,c=0){return new s(e,t,i,r,5,n,o,a,l,c)}};var Wd=(()=>{class s{set areUpdatesFrozen(t){t?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(t=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new _i(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,t||(t=me.LastCreatedScene),this._scene=t,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();let i=this._scene.getEngine().getCaps();this._canUseTextureForTargets=i.canUseGLVertexID&&i.textureFloat&&i.maxVertexTextureImageUnits>0&&i.texture2DArrayMaxLayerCount>1}}get numMaxInfluencers(){return this._numMaxInfluencers}set numMaxInfluencers(t){this._numMaxInfluencers!==t&&(this._numMaxInfluencers=t,this._syncActiveTargets(!0))}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(t){this._useTextureToStoreTargets=t}get isUsingTextureForTargets(){return s.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!this._scene?.getEngine().getCaps().disableMorphTargetTexture}getActiveTarget(t){return this._activeTargets.data[t]}getTarget(t){return this._targets[t]}getTargetByName(t){for(let i of this._targets)if(i.name===t)return i;return null}addTarget(t){this._targets.push(t),this._targetInfluenceChangedObservers.push(t.onInfluenceChanged.add(i=>{this._syncActiveTargets(i)})),this._targetDataLayoutChangedObservers.push(t._onDataLayoutChanged.add(()=>{this._syncActiveTargets(!0)})),this._syncActiveTargets(!0)}removeTarget(t){let i=this._targets.indexOf(t);i>=0&&(this._targets.splice(i,1),t.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(i,1)[0]),t._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(i,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(t)}_bind(t){t.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),t.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),t.setTexture("morphTargets",this._targetStoreTexture),t.setInt("morphTargetCount",this.numInfluencers)}clone(){let t=new s(this._scene);for(let i of this._targets)t.addTarget(i.clone());return t.enableNormalMorphing=this.enableNormalMorphing,t.enableTangentMorphing=this.enableTangentMorphing,t.enableUVMorphing=this.enableUVMorphing,t}serialize(){let t={};t.id=this.uniqueId,t.targets=[];for(let i of this._targets)t.targets.push(i.serialize());return t}_syncActiveTargets(t){if(this.areUpdatesFrozen)return;let i=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let r=-1;for(let n of this._targets){if(r++,n.influence===0&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=s.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(n),this._morphTargetTextureIndices[i]=r,this._tempInfluences[i++]=n.influence,this._supportsNormals=this._supportsNormals&&n.hasNormals,this._supportsTangents=this._supportsTangents&&n.hasTangents,this._supportsUVs=this._supportsUVs&&n.hasUVs;let o=n.getPositions();if(o){let a=o.length/3;if(this._vertexCount===0)this._vertexCount=a;else if(this._vertexCount!==a){F.Error("Incompatible target. Targets must all have the same vertices count.");return}}}this._morphTargetTextureIndices.length!==i&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,i)),(!this._influences||this._influences.length!==i)&&(this._influences=new Float32Array(i));for(let n=0;n<i;n++)this._influences[n]=this._tempInfluences[n];t&&this.synchronize()}synchronize(){if(!(!this._scene||this.areUpdatesFrozen)){if(this.isUsingTextureForTargets&&(this._vertexCount||this.numMaxInfluencers>0)){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;let t=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>t&&(this._textureHeight=Math.ceil(this._textureWidth/t),this._textureWidth=t);let i=!0;if(this._targetStoreTexture){let r=this._targetStoreTexture.getSize();r.width===this._textureWidth&&r.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(i=!1)}if(i){this._targetStoreTexture&&this._targetStoreTexture.dispose();let r=this._targets.length,n=new Float32Array(r*this._textureWidth*this._textureHeight*4),o=0;for(let a=0;a<r;a++){let l=this._targets[a],c=l.getPositions(),h=l.getNormals(),u=l.getUVs(),d=l.getTangents();if(!c){a===0&&F.Error("Invalid morph target. Target must have positions.");return}o=a*this._textureWidth*this._textureHeight*4;for(let f=0;f<this._vertexCount;f++)n[o]=c[f*3],n[o+1]=c[f*3+1],n[o+2]=c[f*3+2],o+=4,this._supportsNormals&&h&&(n[o]=h[f*3],n[o+1]=h[f*3+1],n[o+2]=h[f*3+2],o+=4),this._supportsUVs&&u&&(n[o]=u[f*2],n[o+1]=u[f*2+1],o+=4),this._supportsTangents&&d&&(n[o]=d[f*3],n[o+1]=d[f*3+1],n[o+2]=d[f*3+2],o+=4)}this._targetStoreTexture=OT.CreateRGBATexture(n,this._textureWidth,this._textureHeight,r,this._scene,!1,!1,1,1)}}for(let t of this._scene.meshes)t.morphTargetManager===this&&t._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){let t=this._parentContainer.morphTargetManagers.indexOf(this);t>-1&&this._parentContainer.morphTargetManagers.splice(t,1),this._parentContainer=null}for(let t of this._targets)this._scene.stopAnimation(t)}}static Parse(t,i){let r=new s(i);r._uniqueId=t.id;for(let n of t.targets)r.addTarget(_h.Parse(n,i));return r}}return s.EnableTextureStorage=!0,s.MaxActiveMorphTargetsInVertexAttributeMode=8,s})();var Hd=class{constructor(){this._hasHit=!1,this._hitNormal=p.Zero(),this._hitPoint=p.Zero(),this._triangleIndex=-1}get hitPoint(){return this._hitPoint}get hitNormal(){return this._hitNormal}get hasHit(){return this._hasHit}get triangleIndex(){return this._triangleIndex}setHitData(e,t,i){this._hasHit=!0,this._hitNormal.set(e.x,e.y,e.z),this._hitPoint.set(t.x,t.y,t.z),this._triangleIndex=i??-1}reset(){this._hasHit=!1,this._hitNormal.setAll(0),this._hitPoint.setAll(0),this._triangleIndex=-1,this.body=void 0,this.bodyIndex=void 0,this.shape=void 0}};var ba=class extends Hd{constructor(){super(...arguments),this._hitDistance=0,this._rayFromWorld=p.Zero(),this._rayToWorld=p.Zero()}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormal}get hitPointWorld(){return this._hitPoint}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=p.Distance(this._rayFromWorld,this._hitPoint)}reset(e=p.Zero(),t=p.Zero()){super.reset(),this._rayFromWorld.copyFrom(e),this._rayToWorld.copyFrom(t),this._hitDistance=0}};var Xd=class s{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw We("CannonJSPlugin")}constructor(e,t=s.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new p(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach(function(e){e.dispose()}),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){let t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){let r={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(r),this._physicsPlugin.generateJoint(r)}removeJoint(e,t,i){let r=this._joints.filter(function(n){return n.connectedImpostor===t&&n.joint===i&&n.mainImpostor===e});r.length&&this._physicsPlugin.removeJoint(r[0])}_step(e){this._impostors.forEach(t=>{t.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(t)}),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}};var Yd=class{constructor(e=!0,t=10,i=CANNON){if(this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new q,this._minus90X=new q(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new q(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=p.Zero(),this._tmpDeltaPosition=p.Zero(),this._tmpUnityRotation=new q,this.BJSCANNON=i,!this.isSupported()){F.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new ba}getPluginVersion(){return 1}setGravity(e){let t=e;this.world.gravity.set(t.x,t.y,t.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(let i of t)i.type==He.HeightmapImpostor||i.type===He.PlaneImpostor||i.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach(e=>{typeof this.world.removeBody=="function"?this.world.removeBody(e):this.world.remove(e)}),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(e,t,i){let r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(n,r)}applyForce(e,t,i){let r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),n=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(n,r)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){let t=this._createShape(e);if(!t){F.Warn("It was not possible to create a physics body for this object.");return}let i=e.physicsBody;i&&this.removePhysicsBody(e);let r=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),n={mass:e.getParam("mass"),material:r},o=e.getParam("nativeOptions");for(let a in o)Object.prototype.hasOwnProperty.call(o,a)&&(n[a]=o[a]);e.physicsBody=new this.BJSCANNON.Body(n),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),typeof this.world.addBody=="function"?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach(function(a){let l=i[a];e.physicsBody[a].set(l.x,l.y,l.z)}),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}_processChildMeshes(e){let t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){let r=n=>{if(!n.rotationQuaternion)return;let o=n.getPhysicsImpostor();if(o&&o.parent!==e&&n.parent){let l=n.getAbsolutePosition().subtract(n.parent.getAbsolutePosition()),c=n.rotationQuaternion.multiply(this._tmpQuaternion);o.physicsBody&&(this.removePhysicsBody(o),o.physicsBody=null),o.parent=e,o.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(o),new this.BJSCANNON.Vec3(l.x,l.y,l.z),new this.BJSCANNON.Quaternion(c.x,c.y,c.z,c.w)),e.physicsBody.mass+=o.getParam("mass")}n.getChildMeshes(!0).filter(a=>!!a.physicsImpostor).forEach(r)};t.filter(n=>!!n.physicsImpostor).forEach(r)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)===-1&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){let t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let r,n=e.joint.jointData,o={pivotA:n.mainPivot?new this.BJSCANNON.Vec3().set(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z):null,pivotB:n.connectedPivot?new this.BJSCANNON.Vec3().set(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z):null,axisA:n.mainAxis?new this.BJSCANNON.Vec3().set(n.mainAxis.x,n.mainAxis.y,n.mainAxis.z):null,axisB:n.connectedAxis?new this.BJSCANNON.Vec3().set(n.connectedAxis.x,n.connectedAxis.y,n.connectedAxis.z):null,maxForce:n.nativeParams.maxForce,collideConnected:!!n.collision};switch(e.joint.type){case zt.HingeJoint:case zt.Hinge2Joint:r=new this.BJSCANNON.HingeConstraint(t,i,o);break;case zt.DistanceJoint:r=new this.BJSCANNON.DistanceConstraint(t,i,n.maxDistance||2);break;case zt.SpringJoint:{let a=n;r=new this.BJSCANNON.Spring(t,i,{restLength:a.length,stiffness:a.stiffness,damping:a.damping,localAnchorA:o.pivotA,localAnchorB:o.pivotB});break}case zt.LockJoint:r=new this.BJSCANNON.LockConstraint(t,i,o);break;case zt.PointToPointJoint:case zt.BallAndSocketJoint:default:r=new this.BJSCANNON.PointToPointConstraint(t,o.pivotA,i,o.pivotB,o.maxForce);break}r.collideConnected=!!n.collision,e.joint.physicsJoint=r,e.joint.type!==zt.SpringJoint?this.world.addConstraint(r):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){r.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==zt.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let r,n;for(r=0;r<this._physicsMaterials.length;r++)if(n=this._physicsMaterials[r],n.friction===t&&n.restitution===i)return n;let o=new this.BJSCANNON.Material(e);return o.friction=t,o.restitution=i,this._physicsMaterials.push(o),o}_checkWithEpsilon(e){return e<je?je:e}_createShape(e){let t=e.object,i,r=e.getObjectExtents();switch(e.type){case He.SphereImpostor:{let n=r.x,o=r.y,a=r.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(n),this._checkWithEpsilon(o),this._checkWithEpsilon(a))/2);break}case He.CylinderImpostor:{let n=e.getParam("nativeOptions");n||(n={});let o=n.radiusTop!==void 0?n.radiusTop:this._checkWithEpsilon(r.x)/2,a=n.radiusBottom!==void 0?n.radiusBottom:this._checkWithEpsilon(r.x)/2,l=n.height!==void 0?n.height:this._checkWithEpsilon(r.y),c=n.numSegments!==void 0?n.numSegments:16;i=new this.BJSCANNON.Cylinder(o,a,l,c);let h=new this.BJSCANNON.Quaternion;h.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);let u=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(u,h);break}case He.BoxImpostor:{let n=r.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(n.x),this._checkWithEpsilon(n.y),this._checkWithEpsilon(n.z)));break}case He.PlaneImpostor:F.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case He.MeshImpostor:{let n=t.getVerticesData?t.getVerticesData(y.PositionKind):[],o=t.getIndices?t.getIndices():[];if(!n){F.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");return}let a=t.position.clone(),l=t.rotation&&t.rotation.clone(),c=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();let h=t.computeWorldMatrix(!0),u=[],d;for(d=0;d<n.length;d+=3)p.TransformCoordinates(p.FromArray(n,d),h).toArray(u,d);F.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(u,o),t.position.copyFrom(a),l&&t.rotation&&t.rotation.copyFrom(l),c&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(c);break}case He.HeightmapImpostor:{let n=t.position.clone(),o=t.rotation&&t.rotation.clone(),a=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(t),t.position.copyFrom(n),o&&t.rotation&&t.rotation.copyFrom(o),a&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(a),t.computeWorldMatrix(!0);break}case He.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case He.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0));break}return i}_createHeightmap(e,t){let i=e.getVerticesData(y.PositionKind),r=e.computeWorldMatrix(!0),n=[],o;for(o=0;o<i.length;o+=3)p.TransformCoordinates(p.FromArray(i,o),r).toArray(n,o);i=n;let a=new Array,l=t||~~(Math.sqrt(i.length/3)-1),c=e.getBoundingInfo(),h=Math.min(c.boundingBox.extendSizeWorld.x,c.boundingBox.extendSizeWorld.y),u=c.boundingBox.extendSizeWorld.z,d=h*2/l;for(let m=0;m<i.length;m=m+3){let g=Math.round(i[m+0]/d+l/2),_=Math.round((i[m+1]/d-l/2)*-1),x=-i[m+2]+u;a[g]||(a[g]=[]),a[g][_]||(a[g][_]=x),a[g][_]=Math.max(x,a[g][_])}for(let m=0;m<=l;++m){if(!a[m]){let g=1;for(;!a[(m+g)%l];)g++;a[m]=a[(m+g)%l].slice()}for(let g=0;g<=l;++g)if(!a[m][g]){let _=1,x;for(;x===void 0;)x=a[m][(g+_++)%l];a[m][g]=x}}let f=new this.BJSCANNON.Heightfield(a,{elementSize:d});return f.minY=u,f}_updatePhysicsBodyTransformation(e){let t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;let i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let r=t.rotationQuaternion;if(r){if((e.type===He.PlaneImpostor||e.type===He.HeightmapImpostor)&&(r=r.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===He.HeightmapImpostor){let n=t,o=n.getBoundingInfo(),a=n.rotationQuaternion;n.rotationQuaternion=this._tmpUnityRotation,n.computeWorldMatrix(!0);let l=i.clone(),c=n.getPivotMatrix();c?c=c.clone():c=N.Identity();let h=N.Translation(o.boundingBox.extendSizeWorld.x,0,-o.boundingBox.extendSizeWorld.z);n.setPreTransformMatrix(h),n.computeWorldMatrix(!0),o=n.getBoundingInfo();let u=o.boundingBox.centerWorld.subtract(i).subtract(n.position).negate();this._tmpPosition.copyFromFloats(u.x,u.y-o.boundingBox.extendSizeWorld.y,u.z),this._tmpDeltaPosition.copyFrom(o.boundingBox.centerWorld.subtract(l)),this._tmpDeltaPosition.y+=o.boundingBox.extendSizeWorld.y,n.rotationQuaternion=a,n.setPreTransformMatrix(c),n.computeWorldMatrix(!0)}else e.type===He.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(r.x,r.y,r.z,r.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){let t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return this.BJSCANNON!==void 0}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){let t=e.physicsBody.velocity;return t?new p(t.x,t.y,t.z):null}getAngularVelocity(e){let t=e.physicsBody.angularVelocity;return t?new p(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,r){r||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=t===void 0?-t:t}syncMeshWithImpostor(e,t){let i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){let i=e.physicsBody.shapes[0];t.x=i.halfExtents.x*2,t.y=i.halfExtents.y*2,t.z=i.halfExtents.z*2}dispose(){}_extendNamespace(){let e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,r,n){if(n=n||10,r=r||0,r===0)this.internalStep(i),this.time+=i;else{let o=Math.floor((this.time+r)/i)-Math.floor(this.time/i);o=Math.min(o,n)||1;let a=performance.now();for(let d=0;d!==o&&(this.internalStep(i),!(performance.now()-a>i*1e3));d++);this.time+=r;let c=this.time%i/i,h=e,u=this.bodies;for(let d=0;d!==u.length;d++){let f=u[d];f.type!==t.Body.STATIC&&f.sleepState!==t.Body.SLEEPING?(f.position.vsub(f.previousPosition,h),h.scale(c,h),f.position.vadd(h,f.interpolatedPosition)):(f.interpolatedPosition.set(f.position.x,f.position.y,f.position.z),f.interpolatedQuaternion.set(f.quaternion.x,f.quaternion.y,f.quaternion.z,f.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),i.reset(e,t),this._cannonRaycastResult.hasHit&&(i.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),i.setHitDistance(this._cannonRaycastResult.distance))}};Xd.DefaultPluginFactory=()=>new Yd;var Fm=class{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=p.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new ba}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){t.forEach(function(r){r.beforeStep()}),this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step(),t.forEach(r=>{r.afterStep(),this._tmpImpostorsArray[r.uniqueId]=r});let i=this.world.contacts;for(;i!==null;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}let r=this._tmpImpostorsArray[+i.body1.name],n=this._tmpImpostorsArray[+i.body2.name];if(!r||!n){i=i.next;continue}r.onCollide({body:n.physicsBody,point:null,distance:0,impulse:0,normal:null}),n.onCollide({body:r.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next}}applyImpulse(e,t,i){let r=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*r))}applyForce(e,t,i){F.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){let t={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:e.getParam("mass")!==0,density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},i=[e];(a=>{a.getChildMeshes&&a.getChildMeshes().forEach(function(l){l.physicsImpostor&&i.push(l.physicsImpostor)})})(e.object);let n=a=>Math.max(a,je),o=new q;i.forEach(a=>{if(!a.object.rotationQuaternion)return;let l=a.object.rotationQuaternion;o.copyFrom(l),a.object.rotationQuaternion.set(0,0,0,1),a.object.computeWorldMatrix(!0);let c=o.toEulerAngles(),h=a.getObjectExtents(),u=57.29577951308232;if(a===e){let d=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(d,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),t.pos.push(d.x),t.pos.push(d.y),t.pos.push(d.z),t.posShape.push(0,0,0),t.rotShape.push(0,0,0)}else{let d=a.object.position.clone();t.posShape.push(d.x),t.posShape.push(d.y),t.posShape.push(d.z),t.rotShape.push(c.x*u,c.y*u,c.z*u)}switch(a.object.rotationQuaternion.copyFrom(o),a.type){case He.ParticleImpostor:F.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case He.SphereImpostor:{let d=h.x,f=h.y,m=h.z,g=Math.max(n(d),n(f),n(m))/2;t.type.push("sphere"),t.size.push(g),t.size.push(g),t.size.push(g);break}case He.CylinderImpostor:{let d=n(h.x)/2,f=n(h.y);t.type.push("cylinder"),t.size.push(d),t.size.push(f),t.size.push(f);break}case He.PlaneImpostor:case He.BoxImpostor:default:{let d=n(h.x),f=n(h.y),m=n(h.z);t.type.push("box"),t.size.push(d),t.size.push(f),t.size.push(m);break}}a.object.rotationQuaternion=l}),e.physicsBody=this.world.add(t),e.physicsBody.resetQuaternion(o),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){let t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let r=e.joint.jointData,n=r.nativeParams||{},o,a={body1:t,body2:i,axe1:n.axe1||(r.mainAxis?r.mainAxis.asArray():null),axe2:n.axe2||(r.connectedAxis?r.connectedAxis.asArray():null),pos1:n.pos1||(r.mainPivot?r.mainPivot.asArray():null),pos2:n.pos2||(r.connectedPivot?r.connectedPivot.asArray():null),min:n.min,max:n.max,collision:n.collision||r.collision,spring:n.spring,world:this.world};switch(e.joint.type){case zt.BallAndSocketJoint:o="jointBall";break;case zt.SpringJoint:{F.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");let l=r;a.min=l.length||a.min,a.max=Math.max(a.min,a.max)}case zt.DistanceJoint:o="jointDistance",a.max=r.maxDistance;break;case zt.PrismaticJoint:o="jointPrisme";break;case zt.SliderJoint:o="jointSlide";break;case zt.WheelJoint:o="jointWheel";break;case zt.HingeJoint:default:o="jointHinge";break}a.type=o,e.joint.physicsJoint=this.world.add(a)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(t){F.Warn(t)}}isSupported(){return this.BJSOIMO!==void 0}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{let t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){let t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){let r=e.physicsBody;e.physicsBody.shapes.next||(r.position.set(t.x,t.y,t.z),r.orientation.set(i.x,i.y,i.z,i.w),r.syncShapes(),r.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){let t=e.physicsBody.linearVelocity;return t?new p(t.x,t.y,t.z):null}getAngularVelocity(e){let t=e.physicsBody.angularVelocity;return t?new p(t.x,t.y,t.z):null}setBodyMass(e,t){let i=t===0;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,i!==void 0&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,r){i!==void 0?F.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6,t*=-1;let n=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;n&&n.setMotor(t,i)}setLimit(e,t,i,r){let n=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;n&&n.setLimit(t,i===void 0?-t:i)}syncMeshWithImpostor(e,t){let i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){let i=e.physicsBody.shapes;t.x=i.halfWidth*2,t.y=i.halfHeight*2,t.z=i.halfDepth*2}dispose(){this.world.clear()}raycast(e,t){return F.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,i){F.Warn("raycast is not currently supported by the Oimo physics plugin"),i.reset(e,t)}};var U0=(()=>{class s{constructor(t=!0,i=Ammo,r=null){if(this._useDeltaForWorldStep=t,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new q,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new p,this._tmpContactNormal=new p,this._tmpVec3=new p,this._tmpMatrix=new N,typeof i=="function"){F.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.");return}else this.bjsAMMO=i;if(!this.isSupported()){F.Error("AmmoJS is not available. Please make sure you included the js file.");return}this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=r||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=n=>{n=this.bjsAMMO.wrapPointer(n,this.bjsAMMO.btManifoldPoint);let o=n.getPositionWorldOnA(),a=n.m_normalWorldOnB;this._tmpContactPoint.x=o.x(),this._tmpContactPoint.y=o.y(),this._tmpContactPoint.z=o.z(),this._tmpContactNormal.x=a.x(),this._tmpContactNormal.y=a.y(),this._tmpContactNormal.z=a.z(),this._tmpContactImpulse=n.getAppliedImpulse(),this._tmpContactDistance=n.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new ba,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)}getPluginVersion(){return 1}setGravity(t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(t){this._timeStep=t}setFixedTimeStep(t){this._fixedTimeStep=t}setMaxSteps(t){this._maxSteps=t}getTimeStep(){return this._timeStep}_isImpostorInContact(t){return this._tmpContactCallbackResult=!1,this.world.contactTest(t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(t,i){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(t.physicsBody,i.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(t=1/60,i=10,r=1/60){if(i==0)this.world.stepSimulation(t,0);else for(;i>0&&t>0;)t-r<r?(this.world.stepSimulation(t,0),t=0):(t-=r,this.world.stepSimulation(r,0)),i--}executeStep(t,i){for(let r of i)r.soft||r.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?t:this._timeStep,this._maxSteps,this._fixedTimeStep);for(let r of i)if(r.soft?this._afterSoftStep(r):r.afterStep(),r._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(r))for(let n of r._onPhysicsCollideCallbacks)for(let o of n.otherImpostors)(r.physicsBody.isActive()||o.physicsBody.isActive())&&this._isImpostorPairInContact(r,o)&&(r.onCollide({body:o.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),o.onCollide({body:r.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(t){t.type===He.RopeImpostor?this._ropeStep(t):this._softbodyOrClothStep(t)}_ropeStep(t){let i=t.physicsBody.get_m_nodes(),r=i.size(),n,o,a,l,c,h=new Array;for(let f=0;f<r;f++)n=i.at(f),o=n.get_m_x(),a=o.x(),l=o.y(),c=o.z(),h.push(new p(a,l,c));let u=t.object,d=t.getParam("shape");t._isFromLine?t.object=da("lines",{points:h,instance:u}):t.object=Av("ext",{shape:d,path:h,instance:u})}_softbodyOrClothStep(t){let i=t.type===He.ClothImpostor?1:-1,r=t.object,n=r.getVerticesData(y.PositionKind);n||(n=[]);let o=r.getVerticesData(y.NormalKind);o||(o=[]);let a=n.length/3,l=t.physicsBody.get_m_nodes(),c,h,u,d,f,m,g,_;for(let b=0;b<a;b++){c=l.at(b),h=c.get_m_x(),u=h.x(),d=h.y(),f=h.z()*i;let C=c.get_m_n();m=C.x(),g=C.y(),_=C.z()*i,n[3*b]=u,n[3*b+1]=d,n[3*b+2]=f,o[3*b]=m,o[3*b+1]=g,o[3*b+2]=_}let x=new le;x.positions=n,x.normals=o,x.uvs=r.getVerticesData(y.UVKind),x.colors=r.getVerticesData(y.ColorKind),r&&r.getIndices&&(x.indices=r.getIndices()),x.applyToMesh(r)}applyImpulse(t,i,r){if(t.soft)F.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();let n=this._tmpAmmoVectorA,o=this._tmpAmmoVectorB;t.object&&t.object.getWorldMatrix&&r.subtractInPlace(t.object.getWorldMatrix().getTranslation()),n.setValue(r.x,r.y,r.z),o.setValue(i.x,i.y,i.z),t.physicsBody.applyImpulse(o,n)}}applyForce(t,i,r){if(t.soft)F.Warn("Cannot be applied to a soft body");else{t.physicsBody.activate();let n=this._tmpAmmoVectorA,o=this._tmpAmmoVectorB;if(t.object&&t.object.getWorldMatrix){let a=t.object.getWorldMatrix().getTranslation();n.setValue(r.x-a.x,r.y-a.y,r.z-a.z)}else n.setValue(r.x,r.y,r.z);o.setValue(i.x,i.y,i.z),t.physicsBody.applyForce(o,n)}}generatePhysicsBody(t){if(t._pluginData.toDispose=[],t.parent){t.physicsBody&&(this.removePhysicsBody(t),t.forceUpdate());return}if(t.isBodyInitRequired()){let i=this._createShape(t),r=t.getParam("mass");if(t._pluginData.mass=r,t.soft)i.get_m_cfg().set_collisions(17),i.get_m_cfg().set_kDP(t.getParam("damping")),this.bjsAMMO.castObject(i,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(t.getParam("margin")),i.setActivationState(s._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(i,1,-1),t.physicsBody=i,t._pluginData.toDispose.push(i),this.setBodyPressure(t,0),t.type===He.SoftbodyImpostor&&this.setBodyPressure(t,t.getParam("pressure")),this.setBodyStiffness(t,t.getParam("stiffness")),this.setBodyVelocityIterations(t,t.getParam("velocityIterations")),this.setBodyPositionIterations(t,t.getParam("positionIterations"));else{let n=new this.bjsAMMO.btVector3(0,0,0),o=new this.bjsAMMO.btTransform;t.object.computeWorldMatrix(!0),o.setIdentity(),r!==0&&i.calculateLocalInertia(r,n),this._tmpAmmoVectorA.setValue(t.object.position.x,t.object.position.y,t.object.position.z),this._tmpAmmoQuaternion.setValue(t.object.rotationQuaternion.x,t.object.rotationQuaternion.y,t.object.rotationQuaternion.z,t.object.rotationQuaternion.w),o.setOrigin(this._tmpAmmoVectorA),o.setRotation(this._tmpAmmoQuaternion);let a=new this.bjsAMMO.btDefaultMotionState(o),l=new this.bjsAMMO.btRigidBodyConstructionInfo(r,a,i,n),c=new this.bjsAMMO.btRigidBody(l);if(r===0&&(c.setCollisionFlags(c.getCollisionFlags()|s._KINEMATIC_FLAG),c.setActivationState(s._DISABLE_DEACTIVATION_FLAG)),t.type==He.NoImpostor&&!i.getChildShape&&c.setCollisionFlags(c.getCollisionFlags()|s._DISABLE_COLLISION_FLAG),t.type!==He.MeshImpostor&&t.type!==He.NoImpostor){let d=t.object.getBoundingInfo();this._tmpVec3.copyFrom(t.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(d.boundingBox.centerWorld),this._tmpVec3.x/=t.object.scaling.x,this._tmpVec3.y/=t.object.scaling.y,this._tmpVec3.z/=t.object.scaling.z,t.setDeltaPosition(this._tmpVec3)}let h=t.getParam("group"),u=t.getParam("mask");h&&u?this.world.addRigidBody(c,h,u):this.world.addRigidBody(c),t.physicsBody=c,t._pluginData.toDispose=t._pluginData.toDispose.concat([c,l,a,o,n,i])}this.setBodyRestitution(t,t.getParam("restitution")),this.setBodyFriction(t,t.getParam("friction"))}}removePhysicsBody(t){this.world&&(t.soft?this.world.removeSoftBody(t.physicsBody):this.world.removeRigidBody(t.physicsBody),t._pluginData&&(t._pluginData.toDispose.forEach(i=>{this.bjsAMMO.destroy(i)}),t._pluginData.toDispose=[]))}generateJoint(t){let i=t.mainImpostor.physicsBody,r=t.connectedImpostor.physicsBody;if(!i||!r||t.joint.physicsJoint)return;let n=t.joint.jointData;n.mainPivot||(n.mainPivot=new p(0,0,0)),n.connectedPivot||(n.connectedPivot=new p(0,0,0));let o;switch(t.joint.type){case zt.DistanceJoint:{let a=n.maxDistance;a&&(n.mainPivot=new p(0,-a/2,0),n.connectedPivot=new p(0,a/2,0));let l=this._tmpAmmoVectorA;l.setValue(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z);let c=this._tmpAmmoVectorB;c.setValue(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z),o=new this.bjsAMMO.btPoint2PointConstraint(i,r,l,c);break}case zt.HingeJoint:{n.mainAxis||(n.mainAxis=new p(0,0,0)),n.connectedAxis||(n.connectedAxis=new p(0,0,0));let a=this._tmpAmmoVectorA;a.setValue(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z);let l=this._tmpAmmoVectorB;l.setValue(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z);let c=this._tmpAmmoVectorC;c.setValue(n.mainAxis.x,n.mainAxis.y,n.mainAxis.z);let h=this._tmpAmmoVectorD;h.setValue(n.connectedAxis.x,n.connectedAxis.y,n.connectedAxis.z),o=new this.bjsAMMO.btHingeConstraint(i,r,a,l,c,h);break}case zt.BallAndSocketJoint:{let a=this._tmpAmmoVectorA;a.setValue(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z);let l=this._tmpAmmoVectorB;l.setValue(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z),o=new this.bjsAMMO.btPoint2PointConstraint(i,r,a,l);break}default:{F.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint");let a=this._tmpAmmoVectorA;a.setValue(n.mainPivot.x,n.mainPivot.y,n.mainPivot.z);let l=this._tmpAmmoVectorB;l.setValue(n.connectedPivot.x,n.connectedPivot.y,n.connectedPivot.z),o=new this.bjsAMMO.btPoint2PointConstraint(i,r,a,l);break}}this.world.addConstraint(o,!t.joint.jointData.collision),t.joint.physicsJoint=o}removeJoint(t){this.world&&this.world.removeConstraint(t.joint.physicsJoint),this.bjsAMMO.destroy(t.joint.physicsJoint)}_addMeshVerts(t,i,r){let n=0;if(r&&r.getIndices&&r.getWorldMatrix&&r.getChildMeshes){let o=r.getIndices();o||(o=[]);let a=r.getVerticesData(y.PositionKind);a||(a=[]);let l;if(i&&i!==r){let h;i.rotationQuaternion?h=i.rotationQuaternion:i.rotation?h=q.FromEulerAngles(i.rotation.x,i.rotation.y,i.rotation.z):h=q.Identity(),N.Compose(p.One(),h,i.position).invertToRef(this._tmpMatrix),l=r.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else N.ScalingToRef(r.scaling.x,r.scaling.y,r.scaling.z,this._tmpMatrix),l=this._tmpMatrix;let c=o.length/3;for(let h=0;h<c;h++){let u=[];for(let d=0;d<3;d++){let f=new p(a[o[h*3+d]*3+0],a[o[h*3+d]*3+1],a[o[h*3+d]*3+2]);f=p.TransformCoordinates(f,l);let m;d==0?m=this._tmpAmmoVectorA:d==1?m=this._tmpAmmoVectorB:m=this._tmpAmmoVectorC,m.setValue(f.x,f.y,f.z),u.push(m)}t.addTriangle(u[0],u[1],u[2]),n++}r.getChildMeshes().forEach(h=>{n+=this._addMeshVerts(t,i,h)})}return n}_softVertexData(t){let i=t.object;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let r=i.getIndices();r||(r=[]);let n=i.getVerticesData(y.PositionKind);n||(n=[]);let o=i.getVerticesData(y.NormalKind);o||(o=[]),i.computeWorldMatrix(!1);let a=[],l=[];for(let h=0;h<n.length;h+=3){let u=new p(n[h],n[h+1],n[h+2]),d=new p(o[h],o[h+1],o[h+2]);u=p.TransformCoordinates(u,i.getWorldMatrix()),d=p.TransformNormal(d,i.getWorldMatrix()),a.push(u.x,u.y,u.z),l.push(d.x,d.y,d.z)}let c=new le;return c.positions=a,c.normals=l,c.uvs=i.getVerticesData(y.UVKind),c.colors=i.getVerticesData(y.ColorKind),i&&i.getIndices&&(c.indices=i.getIndices()),c.applyToMesh(i),i.position=p.Zero(),i.rotationQuaternion=null,i.rotation=p.Zero(),i.computeWorldMatrix(!0),c}return le.ExtractFromMesh(i)}_createSoftbody(t){let i=t.object;if(i&&i.getIndices){let r=i.getIndices();r||(r=[]);let n=this._softVertexData(t),o=n.positions,a=n.normals;if(o===null||a===null)return new this.bjsAMMO.btCompoundShape;{let l=[],c=[];for(let g=0;g<o.length;g+=3){let _=new p(o[g],o[g+1],o[g+2]),x=new p(a[g],a[g+1],a[g+2]);l.push(_.x,_.y,-_.z),c.push(x.x,x.y,-x.z)}let h=new this.bjsAMMO.btSoftBodyHelpers().CreateFromTriMesh(this.world.getWorldInfo(),l,i.getIndices(),r.length/3,!0),u=o.length/3,d=h.get_m_nodes(),f,m;for(let g=0;g<u;g++)f=d.at(g),m=f.get_m_n(),m.setX(c[3*g]),m.setY(c[3*g+1]),m.setZ(c[3*g+2]);return h}}}_createCloth(t){let i=t.object;if(i&&i.getIndices){let r=i.getIndices();r||(r=[]);let n=this._softVertexData(t),o=n.positions,a=n.normals;if(o===null||a===null)return new this.bjsAMMO.btCompoundShape;{let l=o.length,c=Math.sqrt(l/3);t.segments=c;let h=c-1;return this._tmpAmmoVectorA.setValue(o[0],o[1],o[2]),this._tmpAmmoVectorB.setValue(o[3*h],o[3*h+1],o[3*h+2]),this._tmpAmmoVectorD.setValue(o[l-3],o[l-2],o[l-1]),this._tmpAmmoVectorC.setValue(o[l-3-3*h],o[l-2-3*h],o[l-1-3*h]),new this.bjsAMMO.btSoftBodyHelpers().CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,c,c,t.getParam("fixedPoints"),!0)}}}_createRope(t){let i,r,n=this._softVertexData(t),o=n.positions,a=n.normals;if(o===null||a===null)return new this.bjsAMMO.btCompoundShape;n.applyToMesh(t.object,!0),t._isFromLine=!0;let l=a.map(f=>f*f),c=(f,m)=>f+m;if(l.reduce(c)===0)i=o.length,r=i/3-1,this._tmpAmmoVectorA.setValue(o[0],o[1],o[2]),this._tmpAmmoVectorB.setValue(o[i-3],o[i-2],o[i-1]);else{t._isFromLine=!1;let f=t.getParam("path");if(t.getParam("shape")===null)return F.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;i=f.length,r=i-1,this._tmpAmmoVectorA.setValue(f[0].x,f[0].y,f[0].z),this._tmpAmmoVectorB.setValue(f[i-1].x,f[i-1].y,f[i-1].z)}t.segments=r;let u=t.getParam("fixedPoints");u=u>3?3:u;let d=new this.bjsAMMO.btSoftBodyHelpers().CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,r-1,u);return d.get_m_cfg().set_collisions(17),d}_createCustom(t){let i=null;return this.onCreateCustomShape&&(i=this.onCreateCustomShape(t)),i==null&&(i=new this.bjsAMMO.btCompoundShape),i}_addHullVerts(t,i,r){let n=0;if(r&&r.getIndices&&r.getWorldMatrix&&r.getChildMeshes){let o=r.getIndices();o||(o=[]);let a=r.getVerticesData(y.PositionKind);a||(a=[]),r.computeWorldMatrix(!1);let l=o.length/3;for(let c=0;c<l;c++){let h=[];for(let u=0;u<3;u++){let d=new p(a[o[c*3+u]*3+0],a[o[c*3+u]*3+1],a[o[c*3+u]*3+2]);N.ScalingToRef(r.scaling.x,r.scaling.y,r.scaling.z,this._tmpMatrix),d=p.TransformCoordinates(d,this._tmpMatrix);let f;u==0?f=this._tmpAmmoVectorA:u==1?f=this._tmpAmmoVectorB:f=this._tmpAmmoVectorC,f.setValue(d.x,d.y,d.z),h.push(f)}t.addPoint(h[0],!0),t.addPoint(h[1],!0),t.addPoint(h[2],!0),n++}r.getChildMeshes().forEach(c=>{n+=this._addHullVerts(t,i,c)})}return n}_createShape(t,i=!1){let r=t.object,n,o=t.getObjectExtents();if(!i){let a=t.object.getChildMeshes?t.object.getChildMeshes(!0):[];n=new this.bjsAMMO.btCompoundShape;let l=0;if(a.forEach(c=>{let h=c.getPhysicsImpostor();if(h){if(h.type==He.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";let u=this._createShape(h),d=c.parent.getWorldMatrix().clone(),f=new p;d.decompose(f),this._tmpAmmoTransform.getOrigin().setValue(c.position.x*f.x,c.position.y*f.y,c.position.z*f.z),this._tmpAmmoQuaternion.setValue(c.rotationQuaternion.x,c.rotationQuaternion.y,c.rotationQuaternion.z,c.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),n.addChildShape(this._tmpAmmoTransform,u),h.dispose(),l++}}),l>0){if(t.type!=He.NoImpostor){let c=this._createShape(t,!0);c&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),n.addChildShape(this._tmpAmmoTransform,c))}return n}else this.bjsAMMO.destroy(n),n=null}switch(t.type){case He.SphereImpostor:if(xe.WithinEpsilon(o.x,o.y,1e-4)&&xe.WithinEpsilon(o.x,o.z,1e-4))n=new this.bjsAMMO.btSphereShape(o.x/2);else{this._tmpAmmoVectorA.setValue(0,0,0);let a=[this._tmpAmmoVectorA],l=[1];n=new this.bjsAMMO.btMultiSphereShape(a,l,1),this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),n.setLocalScaling(this._tmpAmmoVectorA)}break;case He.CapsuleImpostor:{let a=o.x/2;n=new this.bjsAMMO.btCapsuleShape(a,o.y-a*2)}break;case He.CylinderImpostor:this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),n=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case He.PlaneImpostor:case He.BoxImpostor:this._tmpAmmoVectorA.setValue(o.x/2,o.y/2,o.z/2),n=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case He.MeshImpostor:if(t.getParam("mass")==0){if(this.onCreateCustomMeshImpostor)n=this.onCreateCustomMeshImpostor(t);else{let a=new this.bjsAMMO.btTriangleMesh;t._pluginData.toDispose.push(a),this._addMeshVerts(a,r,r)==0?n=new this.bjsAMMO.btCompoundShape:n=new this.bjsAMMO.btBvhTriangleMeshShape(a)}break}case He.ConvexHullImpostor:{if(this.onCreateCustomConvexHullImpostor)n=this.onCreateCustomConvexHullImpostor(t);else{let a=new this.bjsAMMO.btConvexHullShape;this._addHullVerts(a,r,r)==0?(t._pluginData.toDispose.push(a),n=new this.bjsAMMO.btCompoundShape):n=a}break}case He.NoImpostor:n=new this.bjsAMMO.btSphereShape(o.x/2);break;case He.CustomImpostor:n=this._createCustom(t);break;case He.SoftbodyImpostor:n=this._createSoftbody(t);break;case He.ClothImpostor:n=this._createCloth(t);break;case He.RopeImpostor:n=this._createRope(t);break;default:F.Warn("The impostor type is not currently supported by the ammo plugin.");break}return n}setTransformationFromPhysicsBody(t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),t.object.rotationQuaternion?t.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):t.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(t.object.rotation))}setPhysicsBodyTransformation(t,i,r){let n=t.physicsBody.getWorldTransform();if(Math.abs(n.getOrigin().x()-i.x)>je||Math.abs(n.getOrigin().y()-i.y)>je||Math.abs(n.getOrigin().z()-i.z)>je||Math.abs(n.getRotation().x()-r.x)>je||Math.abs(n.getRotation().y()-r.y)>je||Math.abs(n.getRotation().z()-r.z)>je||Math.abs(n.getRotation().w()-r.w)>je)if(this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),n.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(r.x,r.y,r.z,r.w),n.setRotation(this._tmpAmmoQuaternion),t.physicsBody.setWorldTransform(n),t.mass==0){let o=t.physicsBody.getMotionState();o&&o.setWorldTransform(n)}else t.physicsBody.activate()}isSupported(){return this.bjsAMMO!==void 0}setLinearVelocity(t,i){this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),t.soft?t.physicsBody.linearVelocity(this._tmpAmmoVectorA):t.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(t,i){this._tmpAmmoVectorA.setValue(i.x,i.y,i.z),t.soft?t.physicsBody.angularVelocity(this._tmpAmmoVectorA):t.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(t){let i;if(t.soft?i=t.physicsBody.linearVelocity():i=t.physicsBody.getLinearVelocity(),!i)return null;let r=new p(i.x(),i.y(),i.z());return this.bjsAMMO.destroy(i),r}getAngularVelocity(t){let i;if(t.soft?i=t.physicsBody.angularVelocity():i=t.physicsBody.getAngularVelocity(),!i)return null;let r=new p(i.x(),i.y(),i.z());return this.bjsAMMO.destroy(i),r}setBodyMass(t,i){t.soft?t.physicsBody.setTotalMass(i,!1):t.physicsBody.setMassProps(i),t._pluginData.mass=i}getBodyMass(t){return t._pluginData.mass||0}getBodyFriction(t){return t._pluginData.friction||0}setBodyFriction(t,i){t.soft?t.physicsBody.get_m_cfg().set_kDF(i):t.physicsBody.setFriction(i),t._pluginData.friction=i}getBodyRestitution(t){return t._pluginData.restitution||0}setBodyRestitution(t,i){t.physicsBody.setRestitution(i),t._pluginData.restitution=i}getBodyPressure(t){return t.soft?t._pluginData.pressure||0:(F.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(t,i){t.soft?t.type===He.SoftbodyImpostor?(t.physicsBody.get_m_cfg().set_kPR(i),t._pluginData.pressure=i):(t.physicsBody.get_m_cfg().set_kPR(0),t._pluginData.pressure=0):F.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(t){return t.soft?t._pluginData.stiffness||0:(F.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(t,i){t.soft?(i=i<0?0:i,i=i>1?1:i,t.physicsBody.get_m_materials().at(0).set_m_kLST(i),t._pluginData.stiffness=i):F.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(t){return t.soft?t._pluginData.velocityIterations||0:(F.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(t,i){t.soft?(i=i<0?0:i,t.physicsBody.get_m_cfg().set_viterations(i),t._pluginData.velocityIterations=i):F.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(t){return t.soft?t._pluginData.positionIterations||0:(F.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(t,i){t.soft?(i=i<0?0:i,t.physicsBody.get_m_cfg().set_piterations(i),t._pluginData.positionIterations=i):F.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(t,i,r,n,o=1,a=!1){let l=t.segments,c=Math.round((l-1)*r),h=Math.round((l-1)*n),u=l-1-h,d=c+l*u;t.physicsBody.appendAnchor(d,i.physicsBody,a,o)}appendHook(t,i,r,n=1,o=!1){let a=Math.round(t.segments*r);t.physicsBody.appendAnchor(a,i.physicsBody,o,n)}sleepBody(t){t.physicsBody.forceActivationState(0)}wakeUpBody(t){t.physicsBody.activate()}updateDistanceJoint(){F.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(t,i,r){t.physicsJoint.enableAngularMotor(!0,i,r)}setLimit(){F.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(t,i){i.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),t.position.x=this._tmpAmmoTransform.getOrigin().x(),t.position.y=this._tmpAmmoTransform.getOrigin().y(),t.position.z=this._tmpAmmoTransform.getOrigin().z(),t.rotationQuaternion&&(t.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),t.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),t.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),t.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(t){return t.getObjectExtents().x/2}getBoxSizeToRef(t,i){let r=t.getObjectExtents();i.x=r.x,i.y=r.y,i.z=r.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._softBodySolver),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoVectorD),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(t,i){return this.raycastToRef(t,i,this._raycastResult),this._raycastResult}raycastToRef(t,i,r){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(t.x,t.y,t.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(i.x,i.y,i.z);let n=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,n),r.reset(t,i),n.hasHit()&&(r.setHitData({x:n.get_m_hitNormalWorld().x(),y:n.get_m_hitNormalWorld().y(),z:n.get_m_hitNormalWorld().z()},{x:n.get_m_hitPointWorld().x(),y:n.get_m_hitPointWorld().y(),z:n.get_m_hitPointWorld().z()}),r.calculateHitDistance()),this.bjsAMMO.destroy(n),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}return s._DISABLE_COLLISION_FLAG=4,s._KINEMATIC_FLAG=2,s._DISABLE_DEACTIVATION_FLAG=4,s})();Jt.prototype.removeReflectionProbe=function(s){if(!this.reflectionProbes)return-1;let e=this.reflectionProbes.indexOf(s);return e!==-1&&this.reflectionProbes.splice(e,1),e};Jt.prototype.addReflectionProbe=function(s){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(s)};var xh=class s{constructor(e,t,i,r=!0,n=!1,o=!1){if(this.name=e,this._viewMatrix=N.Identity(),this._target=p.Zero(),this._add=p.Zero(),this._invertYAxis=!1,this.position=p.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let h=0;h<6;++h)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${h}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=[]),this._scene.reflectionProbes.push(this);let a=0;if(n){let h=this._scene.getEngine().getCaps();h.textureHalfFloatRender?a=2:h.textureFloatRender&&(a=1)}this._renderTargetTexture=new vt(e,t,i,r,!0,a,!0),this._renderTargetTexture.gammaSpace=!o,this._renderTargetTexture.invertZ=i.useRightHandedSystem;let l=i.getEngine().useReverseDepthBuffer;this._renderTargetTexture.onBeforeRenderObservable.add(h=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[h]),i.getSceneUniformBuffer().unbindEffect()),h){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1);break}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);let u=i.useRightHandedSystem?N.LookAtRHToRef:N.LookAtLHToRef,d=i.useRightHandedSystem?N.PerspectiveFovRH:N.PerspectiveFovLH;u(this.position,this._target,p.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=d(Math.PI/2,1,l?i.activeCamera.maxZ:i.activeCamera.minZ,l?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position});let c;this._renderTargetTexture.onBeforeBindObservable.add(()=>{this._currentSceneUBO=i.getSceneUniformBuffer(),i.getEngine()._debugPushGroup?.(`reflection probe generation for ${e}`,1),c=this._scene.imageProcessingConfiguration.applyByPostProcess,o&&(i.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(()=>{i.imageProcessingConfiguration.applyByPostProcess=c,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),i.getEngine()._debugPopGroup?.(1)})}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}set renderList(e){this._renderTargetTexture.renderList=e}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){let e=this._scene.reflectionProbes.indexOf(this);if(e!==-1&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){let t=this._parentContainer.reflectionProbes.indexOf(this);t>-1&&this._parentContainer.reflectionProbes.splice(t,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(let t of this._sceneUBOs)t.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){let e=ae.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let r=null;if(t.reflectionProbes)for(let n=0;n<t.reflectionProbes.length;n++){let o=t.reflectionProbes[n];if(o.name===e.name){r=o;break}}return r=ae.Parse(()=>r||new s(e.name,e.renderTargetSize,t,e._generateMipMaps),e,t,i),r.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&r.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(r.metadata=e.metadata),r}};v([Go()],xh.prototype,"_attachedMesh",void 0);v([mi()],xh.prototype,"position",void 0);var wT=class{get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,i,r,n){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=r||1,this._animationStarted=!0,this._onBaseAnimationEnd=n,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}};var NT=class s extends wT{get size(){return this.width}set size(e){this.width=e,this.height=e}get manager(){return this._manager}constructor(e,t){super(),this.name=e,this.animations=new Array,this.isPickable=!1,this.useAlphaForPicking=!1,this.onDisposeObservable=new U,this._onAnimationEnd=null,this._endAnimation=()=>{this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()},this.color=new oe(1,1,1,1),this.position=p.Zero(),this._manager=t,this._manager.sprites.push(this),this.uniqueId=this._manager.scene.getUniqueId()}getClassName(){return"Sprite"}get fromIndex(){return this._fromIndex}set fromIndex(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)}get toIndex(){return this._toIndex}set toIndex(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)}get delay(){return Math.max(this._delay,1)}set delay(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)}playAnimation(e,t,i,r,n=null){this._onAnimationEnd=n,super.playAnimation(e,t,i,r,this._endAnimation)}dispose(){for(let e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}serialize(){let e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e}static Parse(e,t){let i=new s(e.name,t);return i.position=p.FromArray(e.position),i.color=oe.FromArray(e.color),i.width=e.width,i.height=e.height,i.angle=e.angle,i.cellIndex=e.cellIndex,i.cellRef=e.cellRef,i.invertU=e.invertU,i.invertV=e.invertV,i.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,i.isPickable=e.isPickable,i.isVisible=e.isVisible,i.useAlphaForPicking=e.useAlphaForPicking,i._fromIndex=e.fromIndex,i._toIndex=e.toIndex,i._loopAnimation=e.loopAnimation,i._delay=e.delay,e.animationStarted&&i.playAnimation(i.fromIndex,i.toIndex,i.loopAnimation,i.delay),i}};Te.prototype._internalPickSprites=function(s,e,t,i){if(!oi)return null;let r=null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let n=0;n<this.spriteManagers.length;n++){let o=this.spriteManagers[n];if(!o.isPickable)continue;let a=o.intersects(s,i,e,t);if(!(!a||!a.hit)&&!(!t&&r!=null&&a.distance>=r.distance)&&(r=a,t))break}return r||new oi};Te.prototype._internalMultiPickSprites=function(s,e,t){if(!oi)return null;let i=[];if(!t){if(!this.activeCamera)return null;t=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let r=0;r<this.spriteManagers.length;r++){let n=this.spriteManagers[r];if(!n.isPickable)continue;let o=n.multiIntersects(s,t,e);o!==null&&(i=i.concat(o))}return i};Te.prototype.pickSprite=function(s,e,t,i,r){if(!this._tempSpritePickingRay)return null;this.createPickingRayInCameraSpaceToRef(s,e,this._tempSpritePickingRay,r);let n=this._internalPickSprites(this._tempSpritePickingRay,t,i,r);return n&&(n.ray=this.createPickingRayInCameraSpace(s,e,r)),n};Te.prototype.pickSpriteWithRay=function(s,e,t,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}pt.TransformToRef(s,i.getViewMatrix(),this._tempSpritePickingRay);let r=this._internalPickSprites(this._tempSpritePickingRay,e,t,i);return r&&(r.ray=s),r};Te.prototype.multiPickSprite=function(s,e,t,i){return this.createPickingRayInCameraSpaceToRef(s,e,this._tempSpritePickingRay,i),this._internalMultiPickSprites(this._tempSpritePickingRay,t,i)};Te.prototype.multiPickSpriteWithRay=function(s,e,t){if(!this._tempSpritePickingRay)return null;if(!t){if(!this.activeCamera)return null;t=this.activeCamera}return pt.TransformToRef(s,t.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,e,t)};Te.prototype.setPointerOverSprite=function(s){this._pointerOverSprite!==s&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,Ii.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=s,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,Ii.CreateNewFromSprite(this._pointerOverSprite,this)))};Te.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};var FT=class{constructor(e){this.name=ye.NAME_SPRITE,this.scene=e,this.scene.spriteManagers=[],this.scene._tempSpritePickingRay=pt?pt.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new U,this.scene.onAfterSpritesRenderingObservable=new U,this._spritePredicate=t=>t.actionManager?t.isPickable&&t.actionManager.hasPointerTriggers:!1}register(){this.scene._pointerMoveStage.registerStep(ye.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(ye.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(ye.STEP_POINTERUP_SPRITE,this,this._pointerUp)}rebuild(){}dispose(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();let e=this.scene.spriteManagers;if(e)for(;e.length;)e[0].dispose()}_pickSpriteButKeepRay(e,t,i,r,n){let o=this.scene.pickSprite(t,i,this._spritePredicate,r,n);return o&&(o.ray=e?e.ray:null),o}_pointerMove(e,t,i,r,n){let o=this.scene;return r?o.setPointerOverSprite(null):(i=this._pickSpriteButKeepRay(i,e,t,!1,o.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite?(o.setPointerOverSprite(i.pickedSprite),!o.doNotHandleCursors&&n&&(o._pointerOverSprite&&o._pointerOverSprite.actionManager&&o._pointerOverSprite.actionManager.hoverCursor?n.style.cursor=o._pointerOverSprite.actionManager.hoverCursor:n.style.cursor=o.hoverCursor)):o.setPointerOverSprite(null)),i}_pointerDown(e,t,i,r){let n=this.scene;if(n._pickedDownSprite=null,n.spriteManagers&&n.spriteManagers.length>0&&(i=n.pickSprite(e,t,this._spritePredicate,!1,n.cameraToUseForPointers||void 0),i&&i.hit&&i.pickedSprite&&i.pickedSprite.actionManager)){switch(n._pickedDownSprite=i.pickedSprite,r.button){case 0:i.pickedSprite.actionManager.processTrigger(2,Ii.CreateNewFromSprite(i.pickedSprite,n,r));break;case 1:i.pickedSprite.actionManager.processTrigger(4,Ii.CreateNewFromSprite(i.pickedSprite,n,r));break;case 2:i.pickedSprite.actionManager.processTrigger(3,Ii.CreateNewFromSprite(i.pickedSprite,n,r));break}i.pickedSprite.actionManager&&i.pickedSprite.actionManager.processTrigger(5,Ii.CreateNewFromSprite(i.pickedSprite,n,r))}return i}_pointerUp(e,t,i,r,n){let o=this.scene;if(o.spriteManagers&&o.spriteManagers.length>0){let a=o.pickSprite(e,t,this._spritePredicate,!1,o.cameraToUseForPointers||void 0);a&&(a.hit&&a.pickedSprite&&a.pickedSprite.actionManager&&(a.pickedSprite.actionManager.processTrigger(7,Ii.CreateNewFromSprite(a.pickedSprite,o,r)),a.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||a.pickedSprite.actionManager.processTrigger(1,Ii.CreateNewFromSprite(a.pickedSprite,o,r)),n&&a.pickedSprite.actionManager.processTrigger(6,Ii.CreateNewFromSprite(a.pickedSprite,o,r)))),o._pickedDownSprite&&o._pickedDownSprite.actionManager&&o._pickedDownSprite!==a.pickedSprite&&o._pickedDownSprite.actionManager.processTrigger(16,Ii.CreateNewFromSprite(o._pickedDownSprite,o,r)))}return i}};var Fq="imageProcessingCompatibility",Lq=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;D.IncludesShadersStore[Fq]=Lq;var Bq="spritesPixelShader",Vq=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform bool alphaTest;varying vec4 vColor;varying vec2 vUV;uniform sampler2D diffuseSampler;
#include<fogFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
#ifdef PIXEL_PERFECT
vec2 uvPixelPerfect(vec2 uv) {vec2 res=vec2(textureSize(diffuseSampler,0));uv=uv*res;vec2 seam=floor(uv+0.5);uv=seam+clamp((uv-seam)/fwidth(uv),-0.5,0.5);return uv/res;}
#endif
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#ifdef PIXEL_PERFECT
vec2 uv=uvPixelPerfect(vUV);
#else
vec2 uv=vUV;
#endif
vec4 color=texture2D(diffuseSampler,uv);float fAlphaTest=float(alphaTest);if (fAlphaTest != 0.)
{if (color.a<0.95)
discard;}
color*=vColor;
#include<logDepthFragment>
#include<fogFragment>
gl_FragColor=color;
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}`;D.ShadersStore[Bq]=Vq;var Uq="spritesVertexShader",kq=`attribute vec4 position;attribute vec2 options;attribute vec2 offsets;attribute vec2 inverts;attribute vec4 cellInfo;attribute vec4 color;uniform mat4 view;uniform mat4 projection;varying vec2 vUV;varying vec4 vColor;
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; 
vec2 cornerPos;float angle=position.w;vec2 size=vec2(options.x,options.y);vec2 offset=offsets.xy;cornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;gl_Position=projection*vec4(viewPos,1.0); 
vColor=color;vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));vec2 uvPlace=cellInfo.xy;vec2 uvSize=cellInfo.zw;vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vUV.y=uvPlace.y+uvSize.y*uvOffset.y;
#ifdef FOG
vFogDistance=viewPos;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[Uq]=kq;var LT=class{get fogEnabled(){return this._fogEnabled}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this._createEffects())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){let t=!!this._scene?.getEngine().getCaps().fragmentDepthSupported;e&&!t&&F.Warn("Logarithmic depth has been requested for a sprite renderer on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._createEffects()}get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(e){this._pixelPerfect!==e&&(this._pixelPerfect=e,this._createEffects())}constructor(e,t,i=.01,r=null){this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this._fogEnabled=!0,this._pixelPerfect=!1,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._capacity=t,this._epsilon=i,this._engine=e,this._useInstancing=e.getCaps().instancedArrays&&e._features.supportSpriteInstancing,this._useVAO=e.getCaps().vertexArrayObject&&!e.disableVertexArrayObjects,this._scene=r,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(t*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new gi(e,this._vertexData,!0,this._vertexBufferSize);let n=this._buffer.createVertexBuffer(y.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),o=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing),a=6,l;if(this._useInstancing){let d=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new gi(e,d,!1,2),l=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else l=this._buffer.createVertexBuffer("offsets",a,2,this._vertexBufferSize,this._useInstancing),a+=2;let c=this._buffer.createVertexBuffer("inverts",a,2,this._vertexBufferSize,this._useInstancing),h=this._buffer.createVertexBuffer("cellInfo",a+2,4,this._vertexBufferSize,this._useInstancing),u=this._buffer.createVertexBuffer(y.ColorKind,a+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[y.PositionKind]=n,this._vertexBuffers.options=o,this._vertexBuffers.offsets=l,this._vertexBuffers.inverts=c,this._vertexBuffers.cellInfo=h,this._vertexBuffers[y.ColorKind]=u,this._createEffects()}_createEffects(){this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._drawWrapperBase=new Xt(this._engine),this._drawWrapperDepth=new Xt(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing);let e="";this._pixelPerfect&&(e+=`#define PIXEL_PERFECT
`),this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0&&this._fogEnabled&&(e+=`#define FOG
`),this._useLogarithmicDepth&&(e+=`#define LOGARITHMICDEPTH
`),this._drawWrapperBase.effect=this._engine.createEffect("sprites",[y.PositionKind,"options","offsets","inverts","cellInfo",y.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor","logarithmicDepthConstant"],["diffuseSampler"],e),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext}render(e,t,i,r,n=null){if(!this.texture||!this.texture.isReady()||!e.length)return;let o=this._drawWrapperBase,a=this._drawWrapperDepth,l=this.fogEnabled&&this._scene&&this._scene.fogEnabled&&this._scene.fogMode!==0,c=o.effect;if(!c.isReady())return;let h=this._engine,u=!!(this._scene&&this._scene.useRightHandedSystem),d=this.texture.getBaseSize(),f=Math.min(this._capacity,e.length),m=0,g=!0;for(let C=0;C<f;C++){let R=e[C];!R||!R.isVisible||(g=!1,R._animate(t),this._appendSpriteVertex(m++,R,0,0,d,u,n),this._useInstancing||(this._appendSpriteVertex(m++,R,1,0,d,u,n),this._appendSpriteVertex(m++,R,1,1,d,u,n),this._appendSpriteVertex(m++,R,0,1,d,u,n)))}if(g)return;this._buffer.update(this._vertexData);let _=!!h.depthCullingState.cull,x=h.depthCullingState.zOffset,b=h.depthCullingState.zOffsetUnits;if(h.setState(_,x,!1,!1,void 0,void 0,b),h.enableEffect(o),c.setTexture("diffuseSampler",this.texture),c.setMatrix("view",i),c.setMatrix("projection",r),l){let C=this._scene;c.setFloat4("vFogInfos",C.fogMode,C.fogStart,C.fogEnd,C.fogDensity),c.setColor3("vFogColor",C.fogColor)}this.useLogarithmicDepth&&this._scene&&Br(o.defines,c,this._scene),this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=h.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,c)),h.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):h.bindBuffers(this._vertexBuffers,this._indexBuffer,c),h.depthCullingState.depthFunc=h.useReverseDepthBuffer?518:515,this.disableDepthWrite||(c.setBool("alphaTest",!0),h.setColorWrite(!1),h.enableEffect(a),this._useInstancing?h.drawArraysType(7,0,4,m):h.drawElementsType(0,0,m/4*6),h.enableEffect(o),h.setColorWrite(!0),c.setBool("alphaTest",!1)),h.setAlphaMode(this.blendMode),this._useInstancing?h.drawArraysType(7,0,4,m):h.drawElementsType(0,0,m/4*6),this.autoResetAlpha&&h.setAlphaMode(0),u&&this._scene.getEngine().setState(_,x,!1,!0,void 0,void 0,b),h.unbindInstanceAttributes()}_appendSpriteVertex(e,t,i,r,n,o,a){let l=e*this._vertexBufferSize;if(i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),r===0?r=this._epsilon:r===1&&(r=1-this._epsilon),a)a(t,n);else{t.cellIndex||(t.cellIndex=0);let c=n.width/this.cellWidth,h=t.cellIndex/c>>0;t._xOffset=(t.cellIndex-h*c)*this.cellWidth/n.width,t._yOffset=h*this.cellHeight/n.height,t._xSize=this.cellWidth,t._ySize=this.cellHeight}this._vertexData[l]=t.position.x,this._vertexData[l+1]=t.position.y,this._vertexData[l+2]=t.position.z,this._vertexData[l+3]=t.angle,this._vertexData[l+4]=t.width,this._vertexData[l+5]=t.height,this._useInstancing?l-=2:(this._vertexData[l+6]=i,this._vertexData[l+7]=r),o?this._vertexData[l+8]=t.invertU?0:1:this._vertexData[l+8]=t.invertU?1:0,this._vertexData[l+9]=t.invertV?1:0,this._vertexData[l+10]=t._xOffset,this._vertexData[l+11]=t._yOffset,this._vertexData[l+12]=t._xSize/n.width,this._vertexData[l+13]=t._ySize/n.height,this._vertexData[l+14]=t.color.r,this._vertexData[l+15]=t.color.g,this._vertexData[l+16]=t.color.b,this._vertexData[l+17]=t.color.a}_buildIndexBuffer(){let e=[],t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}rebuild(){this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild();for(let e in this._vertexBuffers)this._vertexBuffers[e]._rebuild();this._spriteBuffer?._rebuild()}dispose(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),this._drawWrapperBase.dispose(),this._drawWrapperDepth.dispose()}};var ec=class s{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get children(){return this.sprites}get scene(){return this._scene}get capacity(){return this._spriteRenderer.capacity}get texture(){return this._spriteRenderer.texture}set texture(e){e.wrapU=z.CLAMP_ADDRESSMODE,e.wrapV=z.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=e,this._textureContent=null}get cellWidth(){return this._spriteRenderer.cellWidth}set cellWidth(e){this._spriteRenderer.cellWidth=e}get cellHeight(){return this._spriteRenderer.cellHeight}set cellHeight(e){this._spriteRenderer.cellHeight=e}get fogEnabled(){return this._spriteRenderer.fogEnabled}set fogEnabled(e){this._spriteRenderer.fogEnabled=e}get useLogarithmicDepth(){return this._spriteRenderer.useLogarithmicDepth}set useLogarithmicDepth(e){this._spriteRenderer.useLogarithmicDepth=e}get blendMode(){return this._spriteRenderer.blendMode}set blendMode(e){this._spriteRenderer.blendMode=e}get disableDepthWrite(){return this._disableDepthWrite}set disableDepthWrite(e){this._disableDepthWrite=e,this._spriteRenderer.disableDepthWrite=e}get pixelPerfect(){return this._spriteRenderer.pixelPerfect}set pixelPerfect(e){this._spriteRenderer.pixelPerfect=e,e&&this.texture.samplingMode!==3&&this.texture.updateSamplingMode(3)}constructor(e,t,i,r,n,o=.01,a=z.TRILINEAR_SAMPLINGMODE,l=!1,c=null){this.name=e,this.sprites=[],this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.metadata=null,this._wasDispatched=!1,this.onDisposeObservable=new U,this._disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=(u,d)=>{u.cellRef||(u.cellIndex=0);let f=u.cellIndex;typeof f=="number"&&isFinite(f)&&Math.floor(f)===f&&(u.cellRef=this._spriteMap[u.cellIndex]),u._xOffset=this._cellData[u.cellRef].frame.x/d.width,u._yOffset=this._cellData[u.cellRef].frame.y/d.height,u._xSize=this._cellData[u.cellRef].frame.w,u._ySize=this._cellData[u.cellRef].frame.h},n||(n=me.LastCreatedScene),n._getComponent(ye.NAME_SPRITE)||n._addComponent(new FT(n)),this._fromPacked=l,this._scene=n;let h=this._scene.getEngine();if(this._spriteRenderer=new LT(h,i,o,n),r.width&&r.height)this.cellWidth=r.width,this.cellHeight=r.height;else if(r!==void 0)this.cellWidth=r,this.cellHeight=r;else{this._spriteRenderer=null;return}this._scene.spriteManagers&&this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),t&&(this.texture=new z(t,n,!0,!1,a)),this._fromPacked&&this._makePacked(t,c)}getClassName(){return"SpriteManager"}_makePacked(e,t){if(t!==null)try{let i;if(typeof t=="string"?i=JSON.parse(t):i=t,i.frames.length){let n={};for(let o=0;o<i.frames.length;o++){let a=i.frames[o];if(typeof Object.keys(a)[0]!="string")throw new Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");let l=a[Object.keys(a)[0]];n[l]=a}i.frames=n}let r=Reflect.ownKeys(i.frames);this._spriteMap=r,this._packedAndReady=!0,this._cellData=i.frames}catch{throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{let i=/\./g,r;do r=i.lastIndex,i.test(e);while(i.lastIndex>0);let n=e.substring(0,r-1)+".json",o=()=>{F.Error("JSON ERROR: Unable to load JSON file."),this._fromPacked=!1,this._packedAndReady=!1},a=l=>{try{let c=JSON.parse(l),h=Reflect.ownKeys(c.frames);this._spriteMap=h,this._packedAndReady=!0,this._cellData=c.frames}catch{throw this._fromPacked=!1,this._packedAndReady=!1,new Error("Invalid JSON format. Please check documentation for format specifications.")}};H.LoadFile(n,a,void 0,void 0,!1,o)}}_checkTextureAlpha(e,t,i,r,n){if(!e.useAlphaForPicking||!this.texture)return!0;let o=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(o.width*o.height*4),this.texture.readPixels(0,0,this._textureContent));let a=O.Vector3[0];a.copyFrom(t.direction),a.normalize(),a.scaleInPlace(i),a.addInPlace(t.origin);let l=(a.x-r.x)/(n.x-r.x),c=1-(a.y-r.y)/(n.y-r.y),h=e._xOffset*o.width+l*e._xSize|0,u=e._yOffset*o.height+c*e._ySize|0;return this._textureContent[(h+u*o.width)*4+3]>.5}intersects(e,t,i,r){let n=Math.min(this.capacity,this.sprites.length),o=p.Zero(),a=p.Zero(),l=Number.MAX_VALUE,c=null,h=O.Vector3[0],u=O.Vector3[1],d=t.getViewMatrix(),f=e,m=e;for(let g=0;g<n;g++){let _=this.sprites[g];if(_){if(i){if(!i(_))continue}else if(!_.isPickable)continue;if(p.TransformCoordinatesToRef(_.position,d,u),_.angle?(N.TranslationToRef(-u.x,-u.y,0,O.Matrix[1]),N.TranslationToRef(u.x,u.y,0,O.Matrix[2]),N.RotationZToRef(-_.angle,O.Matrix[3]),O.Matrix[1].multiplyToRef(O.Matrix[3],O.Matrix[4]),O.Matrix[4].multiplyToRef(O.Matrix[2],O.Matrix[0]),f=e.clone(),p.TransformCoordinatesToRef(e.origin,O.Matrix[0],f.origin),p.TransformNormalToRef(e.direction,O.Matrix[0],f.direction)):f=e,o.copyFromFloats(u.x-_.width/2,u.y-_.height/2,u.z),a.copyFromFloats(u.x+_.width/2,u.y+_.height/2,u.z),f.intersectsBoxMinMax(o,a)){let x=p.Distance(u,f.origin);if(l>x){if(!this._checkTextureAlpha(_,f,x,o,a))continue;if(m=f,l=x,c=_,r)break}}}}if(c){let g=new oi;d.invertToRef(O.Matrix[0]),g.hit=!0,g.pickedSprite=c,g.distance=l;let _=O.Vector3[2];return _.copyFrom(m.direction),_.normalize(),_.scaleInPlace(l),m.origin.addToRef(_,h),g.pickedPoint=p.TransformCoordinates(h,O.Matrix[0]),g}return null}multiIntersects(e,t,i){let r=Math.min(this.capacity,this.sprites.length),n=p.Zero(),o=p.Zero(),a,l=[],c=O.Vector3[0].copyFromFloats(0,0,0),h=O.Vector3[1].copyFromFloats(0,0,0),u=t.getViewMatrix();for(let d=0;d<r;d++){let f=this.sprites[d];if(f){if(i){if(!i(f))continue}else if(!f.isPickable)continue;if(p.TransformCoordinatesToRef(f.position,u,h),n.copyFromFloats(h.x-f.width/2,h.y-f.height/2,h.z),o.copyFromFloats(h.x+f.width/2,h.y+f.height/2,h.z),e.intersectsBoxMinMax(n,o)){if(a=p.Distance(h,e.origin),!this._checkTextureAlpha(f,e,a,n,o))continue;let m=new oi;l.push(m),u.invertToRef(O.Matrix[0]),m.hit=!0,m.pickedSprite=f,m.distance=a;let g=O.Vector3[2];g.copyFrom(e.direction),g.normalize(),g.scaleInPlace(a),e.origin.addToRef(g,c),m.pickedPoint=p.TransformCoordinates(c,O.Matrix[0])}}}return l}render(){if(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))return;let t=this._scene.getEngine().getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,t,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,t,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}rebuild(){this._spriteRenderer?.rebuild()}dispose(){if(this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null,this._scene.spriteManagers){let e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1)}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null}serialize(e=!1){let t={};t.name=this.name,t.capacity=this.capacity,t.cellWidth=this.cellWidth,t.cellHeight=this.cellHeight,t.fogEnabled=this.fogEnabled,t.blendMode=this.blendMode,t.disableDepthWrite=this.disableDepthWrite,t.pixelPerfect=this.pixelPerfect,t.useLogarithmicDepth=this.useLogarithmicDepth,this.texture&&(e?t.texture=this.texture.serialize():(t.textureUrl=this.texture.name,t.invertY=this.texture._invertY)),t.sprites=[];for(let i of this.sprites)t.sprites.push(i.serialize());return t.metadata=this.metadata,t}static Parse(e,t,i){let r=new s(e.name,"",e.capacity,{width:e.cellWidth,height:e.cellHeight},t);e.fogEnabled!==void 0&&(r.fogEnabled=e.fogEnabled),e.blendMode!==void 0&&(r.blendMode=e.blendMode),e.disableDepthWrite!==void 0&&(r.disableDepthWrite=e.disableDepthWrite),e.pixelPerfect!==void 0&&(r.pixelPerfect=e.pixelPerfect),e.useLogarithmicDepth!==void 0&&(r.useLogarithmicDepth=e.useLogarithmicDepth),e.metadata!==void 0&&(r.metadata=e.metadata),e.texture?r.texture=z.Parse(e.texture,t,i):e.textureName&&(r.texture=new z(i+e.textureUrl,t,!1,e.invertY!==void 0?e.invertY:!0));for(let n of e.sprites)NT.Parse(n,r);return r}static ParseFromFileAsync(e,t,i,r=""){return new Promise((n,o)=>{let a=new gr;a.addEventListener("readystatechange",()=>{if(a.readyState==4)if(a.status==200){let l=JSON.parse(a.responseText),c=s.Parse(l,i||me.LastCreatedScene,r);e&&(c.name=e),n(c)}else o("Unable to load the sprite manager")}),a.open("GET",t),a.send()})}static ParseFromSnippetAsync(e,t,i=""){return e==="_BLANK"?Promise.resolve(new s("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,t)):new Promise((r,n)=>{let o=new gr;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){let a=JSON.parse(JSON.parse(o.responseText).jsonPayload),l=JSON.parse(a.spriteManager),c=s.Parse(l,t||me.LastCreatedScene,i);c.snippetId=e,r(c)}else n("Unable to load the snippet "+e)}),o.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),o.send()})}};ec.SnippetUrl="https://snippet.babylonjs.com";ec.CreateFromSnippetAsync=ec.ParseFromSnippetAsync;var qd=class{};qd.LoaderInjectedPhysicsEngine=void 0;var $d={},tc={},AV=(s,e,t,i)=>{if(!e.materials)return null;for(let r=0,n=e.materials.length;r<n;r++){let o=e.materials[r];if(s(o))return{parsedMaterial:o,material:se.Parse(o,t,i)}}return null},Gq=(s,e,t)=>{for(let i in e)if(s.name===e[i])return t.push(s.id),!0;return s.parentId!==void 0&&t.indexOf(s.parentId)!==-1?(t.push(s.id),!0):!1},jd=(s,e)=>s+" of "+(e?e.file+" from "+e.name+" version: "+e.version+", exporter version: "+e.exporter_version:"unknown"),RV=(s,e)=>{let t=e;if(e._waitingData.lods){if(e._waitingData.lods.ids&&e._waitingData.lods.ids.length>0){let i=e._waitingData.lods.ids,r=t.isEnabled(!1);if(e._waitingData.lods.distances){let n=e._waitingData.lods.distances;if(n.length>=i.length){let o=n.length>i.length?n[n.length-1]:0;t.setEnabled(!1);for(let a=0;a<i.length;a++){let l=i[a],c=s.getMeshById(l);c!=null&&t.addLODLevel(n[a],c)}o>0&&t.addLODLevel(o,null),r===!0&&t.setEnabled(!0)}else H.Warn("Invalid level of detail distances for "+e.name)}}e._waitingData.lods=null}},BT=(s,e,t)=>{if(typeof s!="number"){let r=t.getLastEntryById(s);return r&&e!==void 0&&e!==null?r.instances[parseInt(e)]:r}let i=$d[s];return i&&e!==void 0&&e!==null?i.instances[parseInt(e)]:i},VT=(s,e)=>typeof s!="number"?e.getLastMaterialById(s,!0):tc[s],IV=(s,e,t,i,r=!1)=>{let n=new md(s),o="importScene has failed JSON parse";try{var a=JSON.parse(e);o="";let l=Mt.loggingLevel===Mt.DETAILED_LOGGING,c,h;if(a.environmentTexture!==void 0&&a.environmentTexture!==null){let d=a.isPBR!==void 0?a.isPBR:!0;if(a.environmentTextureType&&a.environmentTextureType==="BABYLON.HDRCubeTexture"){let f=a.environmentTextureSize?a.environmentTextureSize:128,m=new DT((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,s,f,!0,!d,void 0,a.environmentTexturePrefilterOnLoad);a.environmentTextureRotationY&&(m.rotationY=a.environmentTextureRotationY),s.environmentTexture=m}else if(typeof a.environmentTexture=="object"){let f=Hi.Parse(a.environmentTexture,s,t);s.environmentTexture=f}else if(a.environmentTexture.endsWith(".env")){let f=new Hi((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,s,a.environmentTextureForcedExtension);a.environmentTextureRotationY&&(f.rotationY=a.environmentTextureRotationY),s.environmentTexture=f}else{let f=Hi.CreateFromPrefilteredData((a.environmentTexture.match(/https?:\/\//g)?"":t)+a.environmentTexture,s,a.environmentTextureForcedExtension);a.environmentTextureRotationY&&(f.rotationY=a.environmentTextureRotationY),s.environmentTexture=f}if(a.createDefaultSkybox===!0){let f=s.activeCamera!==void 0&&s.activeCamera!==null?(s.activeCamera.maxZ-s.activeCamera.minZ)/2:1e3,m=a.skyboxBlurLevel||0;s.createDefaultSkybox(s.environmentTexture,d,f,m)}n.environmentTexture=s.environmentTexture}if(a.environmentIntensity!==void 0&&a.environmentIntensity!==null&&(s.environmentIntensity=a.environmentIntensity),a.lights!==void 0&&a.lights!==null)for(c=0,h=a.lights.length;c<h;c++){let d=a.lights[c],f=tt.Parse(d,s);f&&($d[d.uniqueId]=f,n.lights.push(f),f._parentContainer=n,o+=c===0?`
	Lights:`:"",o+=`
		`+f.toString(l))}if(a.reflectionProbes!==void 0&&a.reflectionProbes!==null)for(c=0,h=a.reflectionProbes.length;c<h;c++){let d=a.reflectionProbes[c],f=xh.Parse(d,s,t);f&&(n.reflectionProbes.push(f),f._parentContainer=n,o+=c===0?`
	Reflection Probes:`:"",o+=`
		`+f.toString(l))}if(a.animations!==void 0&&a.animations!==null)for(c=0,h=a.animations.length;c<h;c++){let d=a.animations[c],f=Et("BABYLON.Animation");if(f){let m=f.Parse(d);s.animations.push(m),n.animations.push(m),o+=c===0?`
	Animations:`:"",o+=`
		`+m.toString(l)}}if(a.materials!==void 0&&a.materials!==null)for(c=0,h=a.materials.length;c<h;c++){let d=a.materials[c],f=se.Parse(d,s,t);f&&(tc[d.uniqueId||d.id]=f,n.materials.push(f),f._parentContainer=n,o+=c===0?`
	Materials:`:"",o+=`
		`+f.toString(l),f.getActiveTextures().forEach(g=>{n.textures.indexOf(g)==-1&&(n.textures.push(g),g._parentContainer=n)}))}if(a.multiMaterials!==void 0&&a.multiMaterials!==null)for(c=0,h=a.multiMaterials.length;c<h;c++){let d=a.multiMaterials[c],f=Hs.ParseMultiMaterial(d,s);tc[d.uniqueId||d.id]=f,n.multiMaterials.push(f),f._parentContainer=n,o+=c===0?`
	MultiMaterials:`:"",o+=`
		`+f.toString(l),f.getActiveTextures().forEach(g=>{n.textures.indexOf(g)==-1&&(n.textures.push(g),g._parentContainer=n)})}if(a.morphTargetManagers!==void 0&&a.morphTargetManagers!==null)for(let d of a.morphTargetManagers){let f=Wd.Parse(d,s);n.morphTargetManagers.push(f),f._parentContainer=n}if(a.skeletons!==void 0&&a.skeletons!==null)for(c=0,h=a.skeletons.length;c<h;c++){let d=a.skeletons[c],f=Xn.Parse(d,s);n.skeletons.push(f),f._parentContainer=n,o+=c===0?`
	Skeletons:`:"",o+=`
		`+f.toString(l)}let u=a.geometries;if(u!=null){let d=new Array,f=u.vertexData;if(f!=null)for(c=0,h=f.length;c<h;c++){let m=f[c];d.push(nr.Parse(m,s,t))}d.forEach(m=>{m&&(n.geometries.push(m),m._parentContainer=n)})}if(a.transformNodes!==void 0&&a.transformNodes!==null)for(c=0,h=a.transformNodes.length;c<h;c++){let d=a.transformNodes[c],f=Ze.Parse(d,s,t);$d[d.uniqueId]=f,n.transformNodes.push(f),f._parentContainer=n}if(a.meshes!==void 0&&a.meshes!==null)for(c=0,h=a.meshes.length;c<h;c++){let d=a.meshes[c],f=k.Parse(d,s,t);if($d[d.uniqueId]=f,n.meshes.push(f),f._parentContainer=n,f.hasInstances)for(let m of f.instances)n.meshes.push(m),m._parentContainer=n;o+=c===0?`
	Meshes:`:"",o+=`
		`+f.toString(l)}if(a.cameras!==void 0&&a.cameras!==null)for(c=0,h=a.cameras.length;c<h;c++){let d=a.cameras[c],f=Ce.Parse(d,s);$d[d.uniqueId]=f,n.cameras.push(f),f._parentContainer=n,o+=c===0?`
	Cameras:`:"",o+=`
		`+f.toString(l)}if(a.postProcesses!==void 0&&a.postProcesses!==null)for(c=0,h=a.postProcesses.length;c<h;c++){let d=a.postProcesses[c],f=ve.Parse(d,s,t);f&&(n.postProcesses.push(f),f._parentContainer=n,o+=c===0?`
Postprocesses:`:"",o+=`
		`+f.toString())}if(a.animationGroups!==void 0&&a.animationGroups!==null)for(c=0,h=a.animationGroups.length;c<h;c++){let d=a.animationGroups[c],f=ud.Parse(d,s);n.animationGroups.push(f),f._parentContainer=n,o+=c===0?`
	AnimationGroups:`:"",o+=`
		`+f.toString(l)}if(a.spriteManagers)for(let d=0,f=a.spriteManagers.length;d<f;d++){let m=a.spriteManagers[d],g=ec.Parse(m,s,t);o+=`
		SpriteManager `+g.name}for(c=0,h=s.cameras.length;c<h;c++){let d=s.cameras[c];d._waitingParentId!==null&&(d.parent=BT(d._waitingParentId,d._waitingParentInstanceIndex,s),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,h=s.lights.length;c<h;c++){let d=s.lights[c];d&&d._waitingParentId!==null&&(d.parent=BT(d._waitingParentId,d._waitingParentInstanceIndex,s),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,h=s.transformNodes.length;c<h;c++){let d=s.transformNodes[c];d._waitingParentId!==null&&(d.parent=BT(d._waitingParentId,d._waitingParentInstanceIndex,s),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(c=0,h=s.meshes.length;c<h;c++){let d=s.meshes[c];d._waitingParentId!==null&&(d.parent=BT(d._waitingParentId,d._waitingParentInstanceIndex,s),d._waitingParentId=null,d._waitingParentInstanceIndex=null),d._waitingData.lods&&RV(s,d)}for(s.multiMaterials.forEach(d=>{d._waitingSubMaterialsUniqueIds.forEach(f=>{d.subMaterials.push(VT(f,s))}),d._waitingSubMaterialsUniqueIds=[]}),s.meshes.forEach(d=>{d._waitingMaterialId!==null&&(d.material=VT(d._waitingMaterialId,s),d._waitingMaterialId=null)}),c=0,h=s.skeletons.length;c<h;c++){let d=s.skeletons[c];d._hasWaitingData&&(d.bones!=null&&d.bones.forEach(f=>{if(f._waitingTransformNodeId){let m=s.getLastEntryById(f._waitingTransformNodeId);m&&f.linkTransformNode(m),f._waitingTransformNodeId=null}}),d._hasWaitingData=null)}for(c=0,h=s.meshes.length;c<h;c++){let d=s.meshes[c];d._waitingData.freezeWorldMatrix?(d.freezeWorldMatrix(),d._waitingData.freezeWorldMatrix=null):d.computeWorldMatrix(!0)}for(c=0,h=s.lights.length;c<h;c++){let d=s.lights[c];if(d._excludedMeshesIds.length>0){for(let f=0;f<d._excludedMeshesIds.length;f++){let m=s.getMeshById(d._excludedMeshesIds[f]);m&&d.excludedMeshes.push(m)}d._excludedMeshesIds=[]}if(d._includedOnlyMeshesIds.length>0){for(let f=0;f<d._includedOnlyMeshesIds.length;f++){let m=s.getMeshById(d._includedOnlyMeshesIds[f]);m&&d.includedOnlyMeshes.push(m)}d._includedOnlyMeshesIds=[]}}for(s.geometries.forEach(d=>{d._loadedUniqueId=""}),Jt.Parse(a,s,n,t),c=0,h=s.meshes.length;c<h;c++){let d=s.meshes[c];d._waitingData.actions&&(JA.Parse(d._waitingData.actions,d,s),d._waitingData.actions=null)}a.actions!==void 0&&a.actions!==null&&JA.Parse(a.actions,null,s)}catch(l){let c=jd("loadAssets",a?a.producer:"Unknown")+o;if(i)i(c,l);else throw F.Log(c),l}finally{$d={},tc={},r||n.removeAllFromScene(),o!==null&&Mt.loggingLevel!==Mt.NO_LOGGING&&F.Log(jd("loadAssets",a?a.producer:"Unknown")+(Mt.loggingLevel!==Mt.MINIMAL_LOGGING?o:""))}return n};Mt.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:s=>s.indexOf("babylon")!==-1,importMesh:(s,e,t,i,r,n,o,a)=>{let l="importMesh has failed JSON parse";try{var c=JSON.parse(t);l="";let h=Mt.loggingLevel===Mt.DETAILED_LOGGING;s?Array.isArray(s)||(s=[s]):s=null;let u=[],d=new Map,f=[];if(c.transformNodes!==void 0&&c.transformNodes!==null)for(let m=0,g=c.transformNodes.length;m<g;m++){let _=c.transformNodes[m],x=Ze.Parse(_,e,i);f.push(x),d.set(x._waitingParsedUniqueId,x),x._waitingParsedUniqueId=null}if(c.meshes!==void 0&&c.meshes!==null){let m=[],g=[],_=[],x=[];for(let C=0,R=c.meshes.length;C<R;C++){let E=c.meshes[C];if(s===null||Gq(E,s,u)){if(s!==null&&delete s[s.indexOf(E.name)],E.geometryId!==void 0&&E.geometryId!==null&&c.geometries!==void 0&&c.geometries!==null){let A=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(L=>{A===!0||!c.geometries[L]||!Array.isArray(c.geometries[L])||c.geometries[L].forEach(G=>{if(G.id===E.geometryId){switch(L){case"vertexData":nr.Parse(G,e,i);break}A=!0}})}),A===!1&&F.Warn("Geometry not found for mesh "+E.id)}if(E.materialUniqueId||E.materialId){let A=E.materialUniqueId?_:g,L=A.indexOf(E.materialUniqueId||E.materialId)!==-1;if(L===!1&&c.multiMaterials!==void 0&&c.multiMaterials!==null){let G=(W,$)=>{A.push(W);let re=AV($,c,e,i);re&&re.material&&(tc[re.parsedMaterial.uniqueId||re.parsedMaterial.id]=re.material,l+=`
	Material `+re.material.toString(h))};for(let W=0,$=c.multiMaterials.length;W<$;W++){let re=c.multiMaterials[W];if(E.materialUniqueId&&re.uniqueId===E.materialUniqueId||re.id===E.materialId){re.materialsUniqueIds?re.materialsUniqueIds.forEach(_e=>G(_e,ce=>ce.uniqueId===_e)):re.materials.forEach(_e=>G(_e,ce=>ce.id===_e)),A.push(re.uniqueId||re.id);let we=Hs.ParseMultiMaterial(re,e);tc[re.uniqueId||re.id]=we,we&&(L=!0,l+=`
	Multi-Material `+we.toString(h));break}}}if(L===!1){A.push(E.materialUniqueId||E.materialId);let G=AV(W=>E.materialUniqueId&&W.uniqueId===E.materialUniqueId||W.id===E.materialId,c,e,i);!G||!G.material?F.Warn("Material not found for mesh "+E.id):(tc[G.parsedMaterial.uniqueId||G.parsedMaterial.id]=G.material,l+=`
	Material `+G.material.toString(h))}}if(E.skeletonId!==null&&E.skeletonId!==void 0&&c.skeletonId!==-1&&c.skeletons!==void 0&&c.skeletons!==null&&!(m.indexOf(E.skeletonId)>-1))for(let L=0,G=c.skeletons.length;L<G;L++){let W=c.skeletons[L];if(W.id===E.skeletonId){let $=Xn.Parse(W,e);o.push($),m.push(W.id),l+=`
	Skeleton `+$.toString(h)}}if(E.morphTargetManagerId>-1&&c.morphTargetManagers!==void 0&&c.morphTargetManagers!==null&&!(x.indexOf(E.morphTargetManagerId)>-1))for(let L=0,G=c.morphTargetManagers.length;L<G;L++){let W=c.morphTargetManagers[L];if(W.id===E.morphTargetManagerId){let $=Wd.Parse(W,e);x.push($.uniqueId),l+=`
Morph target `+$.toString()}}let S=k.Parse(E,e,i);r.push(S),d.set(S._waitingParsedUniqueId,S),S._waitingParsedUniqueId=null,l+=`
	Mesh `+S.toString(h)}}e.multiMaterials.forEach(C=>{C._waitingSubMaterialsUniqueIds.forEach(R=>{C.subMaterials.push(VT(R,e))}),C._waitingSubMaterialsUniqueIds=[]}),e.meshes.forEach(C=>{C._waitingMaterialId!==null&&(C.material=VT(C._waitingMaterialId,e),C._waitingMaterialId=null)});for(let C=0,R=e.transformNodes.length;C<R;C++){let E=e.transformNodes[C];if(E._waitingParentId!==null){let S=d.get(parseInt(E._waitingParentId))||null;S===null&&(S=e.getLastEntryById(E._waitingParentId));let A=S;E._waitingParentInstanceIndex&&(A=S.instances[parseInt(E._waitingParentInstanceIndex)],E._waitingParentInstanceIndex=null),E.parent=A,E._waitingParentId=null}}let b;for(let C=0,R=e.meshes.length;C<R;C++){if(b=e.meshes[C],b._waitingParentId){let E=d.get(parseInt(b._waitingParentId))||null;E===null&&(E=e.getLastEntryById(b._waitingParentId));let S=E;if(b._waitingParentInstanceIndex&&(S=E.instances[parseInt(b._waitingParentInstanceIndex)],b._waitingParentInstanceIndex=null),b.parent=S,b.parent?.getClassName()==="TransformNode"){let A=f.indexOf(b.parent);A>-1&&f.splice(A,1)}b._waitingParentId=null}b._waitingData.lods&&RV(e,b)}for(let C of f)C.dispose();for(let C=0,R=e.skeletons.length;C<R;C++){let E=e.skeletons[C];E._hasWaitingData&&(E.bones!=null&&E.bones.forEach(S=>{if(S._waitingTransformNodeId){let A=e.getLastEntryById(S._waitingTransformNodeId);A&&S.linkTransformNode(A),S._waitingTransformNodeId=null}}),E._hasWaitingData=null)}for(let C=0,R=e.meshes.length;C<R;C++)b=e.meshes[C],b._waitingData.freezeWorldMatrix?(b.freezeWorldMatrix(),b._waitingData.freezeWorldMatrix=null):b.computeWorldMatrix(!0)}if(c.particleSystems!==void 0&&c.particleSystems!==null){let m=Jt.GetIndividualParser(ye.NAME_PARTICLESYSTEM);if(m)for(let g=0,_=c.particleSystems.length;g<_;g++){let x=c.particleSystems[g];u.indexOf(x.emitterId)!==-1&&n.push(m(x,e,i))}}return e.geometries.forEach(m=>{m._loadedUniqueId=""}),!0}catch(h){let u=jd("importMesh",c?c.producer:"Unknown")+l;if(a)a(u,h);else throw F.Log(u),h}finally{l!==null&&Mt.loggingLevel!==Mt.NO_LOGGING&&F.Log(jd("importMesh",c?c.producer:"Unknown")+(Mt.loggingLevel!==Mt.MINIMAL_LOGGING?l:"")),tc={}}return!1},load:(s,e,t,i)=>{let r="importScene has failed JSON parse";try{var n=JSON.parse(e);switch(r="",n.useDelayedTextureLoading!==void 0&&n.useDelayedTextureLoading!==null&&(s.useDelayedTextureLoading=n.useDelayedTextureLoading&&!Mt.ForceFullSceneLoadingForIncremental),n.autoClear!==void 0&&n.autoClear!==null&&(s.autoClear=n.autoClear),n.clearColor!==void 0&&n.clearColor!==null&&(s.clearColor=oe.FromArray(n.clearColor)),n.ambientColor!==void 0&&n.ambientColor!==null&&(s.ambientColor=X.FromArray(n.ambientColor)),n.gravity!==void 0&&n.gravity!==null&&(s.gravity=p.FromArray(n.gravity)),n.useRightHandedSystem!==void 0&&(s.useRightHandedSystem=!!n.useRightHandedSystem),n.fogMode!==void 0&&n.fogMode!==null&&(s.fogMode=n.fogMode),n.fogColor!==void 0&&n.fogColor!==null&&(s.fogColor=X.FromArray(n.fogColor)),n.fogStart!==void 0&&n.fogStart!==null&&(s.fogStart=n.fogStart),n.fogEnd!==void 0&&n.fogEnd!==null&&(s.fogEnd=n.fogEnd),n.fogDensity!==void 0&&n.fogDensity!==null&&(s.fogDensity=n.fogDensity),r+="	Fog mode for scene:  ",s.fogMode){case 0:r+=`none
`;break;case 1:r+=`exp
`;break;case 2:r+=`exp2
`;break;case 3:r+=`linear
`;break}if(n.physicsEnabled){let a;n.physicsEngine==="cannon"||n.physicsEngine===Yd.name?a=new Yd(void 0,void 0,qd.LoaderInjectedPhysicsEngine):n.physicsEngine==="oimo"||n.physicsEngine===Fm.name?a=new Fm(void 0,qd.LoaderInjectedPhysicsEngine):(n.physicsEngine==="ammo"||n.physicsEngine===U0.name)&&(a=new U0(void 0,qd.LoaderInjectedPhysicsEngine,void 0)),r="	Physics engine "+(n.physicsEngine?n.physicsEngine:"oimo")+` enabled
`;let l=n.gravity?p.FromArray(n.gravity):n.physicsGravity?p.FromArray(n.physicsGravity):null;s.enablePhysics(l,a)}return n.metadata!==void 0&&n.metadata!==null&&(s.metadata=n.metadata),n.collisionsEnabled!==void 0&&n.collisionsEnabled!==null&&(s.collisionsEnabled=n.collisionsEnabled),IV(s,e,t,i,!0)?(n.autoAnimate&&s.beginAnimation(s,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1),n.activeCameraID!==void 0&&n.activeCameraID!==null&&s.setActiveCameraById(n.activeCameraID),!0):!1}catch(o){let a=jd("importScene",n?n.producer:"Unknown")+r;if(i)i(a,o);else throw F.Log(a),o}finally{r!==null&&Mt.loggingLevel!==Mt.NO_LOGGING&&F.Log(jd("importScene",n?n.producer:"Unknown")+(Mt.loggingLevel!==Mt.MINIMAL_LOGGING?r:""))}return!1},loadAssetContainer:(s,e,t,i)=>IV(s,e,t,i)});var k0=class s{get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,K.MarkAllMaterialsAsDirty(20))}constructor(e={}){this._isEnabled=!0,this.bias=e.bias===void 0?0:e.bias,this.power=e.power===void 0?1:e.power,this.leftColor=e.leftColor||X.White(),this.rightColor=e.rightColor||X.Black(),e.isEnabled===!1&&(this.isEnabled=!1)}clone(){let e=new s;return ei.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new s({isEnabled:e.isEnabled,leftColor:X.FromArray(e.leftColor),rightColor:X.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}};ae._FresnelParametersParser=k0.Parse;var Or=class extends Gt{get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new X(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}getClassName(){return"PBRBaseSimpleMaterial"}};v([I(),Q("_markAllSubMeshesAsLightsDirty")],Or.prototype,"maxSimultaneousLights",void 0);v([I(),Q("_markAllSubMeshesAsLightsDirty")],Or.prototype,"disableLighting",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],Or.prototype,"environmentTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Or.prototype,"invertNormalMapX",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Or.prototype,"invertNormalMapY",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],Or.prototype,"normalTexture",void 0);v([At("emissive"),Q("_markAllSubMeshesAsTexturesDirty")],Or.prototype,"emissiveColor",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty")],Or.prototype,"emissiveTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],Or.prototype,"occlusionStrength",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],Or.prototype,"occlusionTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],Or.prototype,"alphaCutOff",void 0);v([I()],Or.prototype,"doubleSided",null);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty",null)],Or.prototype,"lightmapTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Or.prototype,"useLightmapAsShadowmap",void 0);var ic=class s extends Or{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){let t=ae.Clone(()=>new s(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){let e=ae.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){let r=ae.Parse(()=>new s(e.name,t),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}};v([At(),Q("_markAllSubMeshesAsTexturesDirty","_albedoColor")],ic.prototype,"baseColor",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],ic.prototype,"baseTexture",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],ic.prototype,"metallic",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],ic.prototype,"roughness",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],ic.prototype,"metallicRoughnessTexture",void 0);P("BABYLON.PBRMetallicRoughnessMaterial",ic);var rc=class s extends Or{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){let t=ae.Clone(()=>new s(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){let e=ae.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){let r=ae.Parse(()=>new s(e.name,t),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}};v([At("diffuse"),Q("_markAllSubMeshesAsTexturesDirty","_albedoColor")],rc.prototype,"diffuseColor",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],rc.prototype,"diffuseTexture",void 0);v([At("specular"),Q("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],rc.prototype,"specularColor",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty","_microSurface")],rc.prototype,"glossiness",void 0);v([Qe(),Q("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],rc.prototype,"specularGlossinessTexture",void 0);P("BABYLON.PBRSpecularGlossinessMaterial",rc);var zq=(()=>{class s extends Qi{constructor(t,i,r=null){if(super(i),!!t)if(this._textureMatrix=N.Identity(),this.name=t,this.url=t,this._onLoad=r,this._texture=this._getFromCache(t,!0),this._texture)this._triggerOnLoad();else{let n=this.getScene();n?n.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture():this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){let t=this._getEngine(),i;t._features.support3DTextures?i=t.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):i=t.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=i,this._texture.isReady=!1,this.isCube=!1,this.is3D=t._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;let r=o=>{if(typeof o!="string")return;let a=null,l=null,c,h=o.split(`
`),u=0,d=0,f=0,m=0,g=0;for(let _=0;_<h.length;_++){if(c=h[_],!s._NoneEmptyLineRegex.test(c)||c.indexOf("#")===0)continue;let x=c.split(" ");if(u===0){u=x.length,a=new Uint8Array(u*u*u*4),l=new Float32Array(u*u*u*4);continue}if(u!=0){let b=Math.max(parseInt(x[0]),0),C=Math.max(parseInt(x[1]),0),R=Math.max(parseInt(x[2]),0);g=Math.max(b,g),g=Math.max(C,g),g=Math.max(R,g);let E=(d+m*u+f*u*u)*4;l&&(l[E+0]=b,l[E+1]=C,l[E+2]=R),f++,f%u==0&&(m++,f=0,m%u==0&&(d++,m=0))}}if(l&&a)for(let _=0;_<l.length;_++)if(_>0&&(_+1)%4===0)a[_]=255;else{let x=l[_];a[_]=x/g*255}i.is3D?(i.updateSize(u,u,u),t.updateRawTexture3D(i,a,5,!1)):(i.updateSize(u*u,u),t.updateRawTexture(i,a,5,!1)),i.isReady=!0,this._triggerOnLoad()},n=this.getScene();return n?n._loadFile(this.url,r):t._loadFile(this.url,r),this._texture}_loadTexture(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this._load3dlTexture()}clone(){let t=new s(this.url,this.getScene()||this._getEngine());return t.level=this.level,t}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(t,i){let r=null;return t.name&&!t.isRenderTarget&&(r=new s(t.name,i),r.name=t.name,r.level=t.level),r}serialize(){if(!this.name)return null;let t={};return t.name=this.name,t.level=this.level,t.customType="BABYLON.ColorGradingTexture",t}}return s._NoneEmptyLineRegex=/\S+/,s})();P("BABYLON.ColorGradingTexture",zq);var Wq=1,Hq=2,Xq=3,Yq=9,$q=10,jq=11,qq=48,Qq=4,Kq=0,Zq=1,Jq=2,eQ=3;function Qd(s){let e=0;return{id_length:s[e++],colormap_type:s[e++],image_type:s[e++],colormap_index:s[e++]|s[e++]<<8,colormap_length:s[e++]|s[e++]<<8,colormap_size:s[e++],origin:[s[e++]|s[e++]<<8,s[e++]|s[e++]<<8],width:s[e++]|s[e++]<<8,height:s[e++]|s[e++]<<8,pixel_size:s[e++],flags:s[e++]}}function G0(s,e){if(e.length<19){F.Error("Unable to load TGA file - Not enough data to contain header");return}let t=18,i=Qd(e);if(i.id_length+t>e.length){F.Error("Unable to load TGA file - Not enough data");return}t+=i.id_length;let r=!1,n=!1,o=!1;switch(i.image_type){case Yq:r=!0;case Wq:n=!0;break;case $q:r=!0;case Hq:break;case jq:r=!0;case Xq:o=!0;break}let a,l=i.pixel_size>>3,c=i.width*i.height*l,h;if(n&&(h=e.subarray(t,t+=i.colormap_length*(i.colormap_size>>3))),r){a=new Uint8Array(c);let R,E,S,A=0,L=new Uint8Array(l);for(;t<c&&A<c;)if(R=e[t++],E=(R&127)+1,R&128){for(S=0;S<l;++S)L[S]=e[t++];for(S=0;S<E;++S)a.set(L,A+S*l);A+=l*E}else{for(E*=l,S=0;S<E;++S)a[A+S]=e[t++];A+=E}}else a=e.subarray(t,t+=n?i.width*i.height:c);let u,d,f,m,g,_;switch((i.flags&qq)>>Qq){default:case Jq:u=0,f=1,_=i.width,d=0,m=1,g=i.height;break;case Kq:u=0,f=1,_=i.width,d=i.height-1,m=-1,g=-1;break;case eQ:u=i.width-1,f=-1,_=-1,d=0,m=1,g=i.height;break;case Zq:u=i.width-1,f=-1,_=-1,d=i.height-1,m=-1,g=-1;break}let x="_getImageData"+(o?"Grey":"")+i.pixel_size+"bits",b=aQ[x](i,h,a,d,m,g,u,f,_);s.getEngine()._uploadDataToTextureDirectly(s,b)}function tQ(s,e,t,i,r,n,o,a,l){let c=t,h=e,u=s.width,d=s.height,f,m=0,g,_,x=new Uint8Array(u*d*4);for(_=i;_!==n;_+=r)for(g=o;g!==l;g+=a,m++)f=c[m],x[(g+u*_)*4+3]=255,x[(g+u*_)*4+2]=h[f*3+0],x[(g+u*_)*4+1]=h[f*3+1],x[(g+u*_)*4+0]=h[f*3+2];return x}function iQ(s,e,t,i,r,n,o,a,l){let c=t,h=s.width,u=s.height,d,f=0,m,g,_=new Uint8Array(h*u*4);for(g=i;g!==n;g+=r)for(m=o;m!==l;m+=a,f+=2){d=c[f+0]+(c[f+1]<<8);let x=((d&31744)>>10)*255/31|0,b=((d&992)>>5)*255/31|0,C=(d&31)*255/31|0;_[(m+h*g)*4+0]=x,_[(m+h*g)*4+1]=b,_[(m+h*g)*4+2]=C,_[(m+h*g)*4+3]=d&32768?0:255}return _}function rQ(s,e,t,i,r,n,o,a,l){let c=t,h=s.width,u=s.height,d=0,f,m,g=new Uint8Array(h*u*4);for(m=i;m!==n;m+=r)for(f=o;f!==l;f+=a,d+=3)g[(f+h*m)*4+3]=255,g[(f+h*m)*4+2]=c[d+0],g[(f+h*m)*4+1]=c[d+1],g[(f+h*m)*4+0]=c[d+2];return g}function sQ(s,e,t,i,r,n,o,a,l){let c=t,h=s.width,u=s.height,d=0,f,m,g=new Uint8Array(h*u*4);for(m=i;m!==n;m+=r)for(f=o;f!==l;f+=a,d+=4)g[(f+h*m)*4+2]=c[d+0],g[(f+h*m)*4+1]=c[d+1],g[(f+h*m)*4+0]=c[d+2],g[(f+h*m)*4+3]=c[d+3];return g}function nQ(s,e,t,i,r,n,o,a,l){let c=t,h=s.width,u=s.height,d,f=0,m,g,_=new Uint8Array(h*u*4);for(g=i;g!==n;g+=r)for(m=o;m!==l;m+=a,f++)d=c[f],_[(m+h*g)*4+0]=d,_[(m+h*g)*4+1]=d,_[(m+h*g)*4+2]=d,_[(m+h*g)*4+3]=255;return _}function oQ(s,e,t,i,r,n,o,a,l){let c=t,h=s.width,u=s.height,d=0,f,m,g=new Uint8Array(h*u*4);for(m=i;m!==n;m+=r)for(f=o;f!==l;f+=a,d+=2)g[(f+h*m)*4+0]=c[d+0],g[(f+h*m)*4+1]=c[d+0],g[(f+h*m)*4+2]=c[d+0],g[(f+h*m)*4+3]=c[d+1];return g}var aQ={GetTGAHeader:Qd,UploadContent:G0,_getImageData8bits:tQ,_getImageData16bits:iQ,_getImageData24bits:rQ,_getImageData32bits:sQ,_getImageDataGrey8bits:nQ,_getImageDataGrey16bits:oQ};var z0=class{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".tga")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){let r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=Qd(r);i(n.width,n.height,t.generateMipMaps,!1,()=>{G0(t,r)})}};K._TextureLoaders.push(new z0);var W0=class{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".hdr")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){let r=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=gh.RGBE_ReadHeader(r),o=gh.RGBE_ReadPixels(r,n),a=n.width*n.height,l=new Float32Array(a*4);for(let c=0;c<a;c+=1)l[c*4]=o[c*3],l[c*4+1]=o[c*3+1],l[c*4+2]=o[c*3+2],l[c*4+3]=1;i(n.width,n.height,t.generateMipMaps,!1,()=>{let c=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,c._uploadDataToTextureDirectly(t,l)})}};K._TextureLoaders.push(new W0);function PV(){let s={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC4:4,cTFBC5:5,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFBGR565:15,cTFRGBA4444:16,cTFFXT1_RGB:17,cTFPVRTC2_4_RGB:18,cTFPVRTC2_4_RGBA:19,cTFETC2_EAC_R11:20,cTFETC2_EAC_RG11:21},e=null;onmessage=o=>{if(o.data.action==="init"){if(o.data.url)try{importScripts(o.data.url)}catch(a){postMessage({action:"error",error:a})}e||(e=BASIS({wasmBinary:o.data.wasmBinary})),e!==null&&e.then(a=>{BASIS=a,a.initializeBasis(),postMessage({action:"init"})})}else if(o.data.action==="transcode"){let a=o.data.config,l=o.data.imageData,c=new BASIS.BasisFile(l),h=i(c),u=o.data.ignoreSupportedFormats?null:t(o.data.config,h),d=!1;u===null&&(d=!0,u=h.hasAlpha?s.cTFBC3:s.cTFBC1);let f=!0;c.startTranscoding()||(f=!1);let m=[];for(let g=0;g<h.images.length&&f;g++){let _=h.images[g];if(a.loadSingleImage===void 0||a.loadSingleImage===g){let x=_.levels.length;a.loadMipmapLevels===!1&&(x=1);for(let b=0;b<x;b++){let C=_.levels[b],R=r(c,g,b,u,d);if(!R){f=!1;break}C.transcodedPixels=R,m.push(C.transcodedPixels.buffer)}}}c.close(),c.delete(),d&&(u=-1),f?postMessage({action:"transcode",success:f,id:o.data.id,fileInfo:h,format:u},m):postMessage({action:"transcode",success:f,id:o.data.id})}};function t(o,a){let l=null;return o.supportedCompressionFormats&&(o.supportedCompressionFormats.astc?l=s.cTFASTC_4x4:o.supportedCompressionFormats.bc7?l=s.cTFBC7:o.supportedCompressionFormats.s3tc?l=a.hasAlpha?s.cTFBC3:s.cTFBC1:o.supportedCompressionFormats.pvrtc?l=a.hasAlpha?s.cTFPVRTC1_4_RGBA:s.cTFPVRTC1_4_RGB:o.supportedCompressionFormats.etc2?l=s.cTFETC2:o.supportedCompressionFormats.etc1?l=s.cTFETC1:l=s.cTFRGB565),l}function i(o){let a=o.getHasAlpha(),l=o.getNumImages(),c=[];for(let u=0;u<l;u++){let d={levels:[]},f=o.getNumLevels(u);for(let m=0;m<f;m++){let g={width:o.getImageWidth(u,m),height:o.getImageHeight(u,m)};d.levels.push(g)}c.push(d)}return{hasAlpha:a,images:c}}function r(o,a,l,c,h){let u=o.getImageTranscodedSizeInBytes(a,l,c),d=new Uint8Array(u);if(!o.transcodeImage(d,a,l,c,1,0))return null;if(h){let f=o.getImageWidth(a,l)+3&-4,m=o.getImageHeight(a,l)+3&-4;d=n(d,0,f,m)}return d}function n(o,a,l,c){let h=new Uint16Array(4),u=new Uint16Array(l*c),d=l/4,f=c/4;for(let m=0;m<f;m++)for(let g=0;g<d;g++){let _=a+8*(m*d+g);h[0]=o[_]|o[_+1]<<8,h[1]=o[_+2]|o[_+3]<<8,h[2]=(2*(h[0]&31)+1*(h[1]&31))/3|(2*(h[0]&2016)+1*(h[1]&2016))/3&2016|(2*(h[0]&63488)+1*(h[1]&63488))/3&63488,h[3]=(2*(h[1]&31)+1*(h[0]&31))/3|(2*(h[1]&2016)+1*(h[0]&2016))/3&2016|(2*(h[1]&63488)+1*(h[0]&63488))/3&63488;for(let x=0;x<4;x++){let b=o[_+4+x],C=(m*4+x)*l+g*4;u[C++]=h[b&3],u[C++]=h[b>>2&3],u[C++]=h[b>>4&3],u[C++]=h[b>>6&3]}}return u}}function MV(s,e,t){return new Promise((i,r)=>{let n=o=>{o.data.action==="init"?(s.removeEventListener("message",n),i(s)):o.data.action==="error"&&r(o.data.error||"error initializing worker")};s.addEventListener("message",n),s.postMessage({action:"init",url:t?H.GetBabylonScriptURL(t):void 0,wasmBinary:e},[e])})}var sc=function(s){return s[s.cTFETC1=0]="cTFETC1",s[s.cTFETC2=1]="cTFETC2",s[s.cTFBC1=2]="cTFBC1",s[s.cTFBC3=3]="cTFBC3",s[s.cTFBC4=4]="cTFBC4",s[s.cTFBC5=5]="cTFBC5",s[s.cTFBC7=6]="cTFBC7",s[s.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",s[s.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",s[s.cTFASTC_4x4=10]="cTFASTC_4x4",s[s.cTFATC_RGB=11]="cTFATC_RGB",s[s.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",s[s.cTFRGBA32=13]="cTFRGBA32",s[s.cTFRGB565=14]="cTFRGB565",s[s.cTFBGR565=15]="cTFBGR565",s[s.cTFRGBA4444=16]="cTFRGBA4444",s[s.cTFFXT1_RGB=17]="cTFFXT1_RGB",s[s.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",s[s.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",s[s.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",s[s.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11",s}(sc||{}),nc={JSModuleURL:`${H._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.js`,WasmModuleURL:`${H._DefaultCdnUrl}/basisTranscoder/1/basis_transcoder.wasm`},lQ=(s,e)=>{let t;switch(s){case sc.cTFETC1:t=36196;break;case sc.cTFBC1:t=33776;break;case sc.cTFBC4:t=33779;break;case sc.cTFASTC_4x4:t=37808;break;case sc.cTFETC2:t=37496;break;case sc.cTFBC7:t=36492;break}if(t===void 0)throw"The chosen Basis transcoder format is not currently supported";return t},H0=null,vh=null,cQ=0,hQ=!1,uQ=()=>(H0||(H0=new Promise((s,e)=>{vh?s(vh):H.LoadFileAsync(H.GetBabylonScriptURL(nc.WasmModuleURL)).then(t=>{if(typeof URL!="function")return e("Basis transcoder requires an environment with a URL constructor");let i=URL.createObjectURL(new Blob([`(${PV})()`],{type:"application/javascript"}));vh=new Worker(i),MV(vh,t,nc.JSModuleURL).then(s,e)}).catch(e)})),H0);var kT=(s,e)=>{let t=s instanceof ArrayBuffer?new Uint8Array(s):s;return new Promise((i,r)=>{uQ().then(()=>{let n=cQ++,o=l=>{l.data.action==="transcode"&&l.data.id===n&&(vh.removeEventListener("message",o),l.data.success?i(l.data):r("Transcode is not supported on this device"))};vh.addEventListener("message",o);let a=new Uint8Array(t.byteLength);a.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),vh.postMessage({action:"transcode",id:n,imageData:a,config:e,ignoreSupportedFormats:hQ},[a.buffer])},n=>{r(n)})})},UT=(s,e)=>{let t=e._gl?.TEXTURE_2D;s.isCube&&(t=e._gl?.TEXTURE_CUBE_MAP),e._bindTextureDirectly(t,s,!0)},GT=(s,e)=>{let t=s.getEngine();for(let i=0;i<e.fileInfo.images.length;i++){let r=e.fileInfo.images[i].levels[0];if(s._invertVScale=s.invertY,e.format===-1||e.format===sc.cTFRGB565)if(s.type=10,s.format=4,t._features.basisNeedsPOT&&(xe.Log2(r.width)%1!==0||xe.Log2(r.height)%1!==0)){let n=new Je(t,ke.Temp);s._invertVScale=s.invertY,n.type=10,n.format=4,n.width=r.width+3&-4,n.height=r.height+3&-4,UT(n,t),t._uploadDataToTextureDirectly(n,new Uint16Array(r.transcodedPixels.buffer),i,0,4,!0),t._rescaleTexture(n,s,t.scenes[0],t._getInternalFormat(4),()=>{t._releaseTexture(n),UT(s,t)})}else s._invertVScale=!s.invertY,s.width=r.width+3&-4,s.height=r.height+3&-4,s.samplingMode=2,UT(s,t),t._uploadDataToTextureDirectly(s,new Uint16Array(r.transcodedPixels.buffer),i,0,4,!0);else{s.width=r.width,s.height=r.height,s.generateMipMaps=e.fileInfo.images[i].levels.length>1;let n=X0.GetInternalFormatFromBasisFormat(e.format,t);s.format=n,UT(s,t),e.fileInfo.images[i].levels.forEach((o,a)=>{t._uploadCompressedDataToTextureDirectly(s,n,o.width,o.height,o.transcodedPixels,i,a)}),t._features.basisNeedsPOT&&(xe.Log2(s.width)%1!==0||xe.Log2(s.height)%1!==0)&&(H.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),s._cachedWrapU=z.CLAMP_ADDRESSMODE,s._cachedWrapV=z.CLAMP_ADDRESSMODE)}}},X0={JSModuleURL:nc.JSModuleURL,WasmModuleURL:nc.WasmModuleURL,GetInternalFormatFromBasisFormat:lQ,TranscodeAsync:kT,LoadTextureFromTranscodeResult:GT};Object.defineProperty(X0,"JSModuleURL",{get:function(){return nc.JSModuleURL},set:function(s){nc.JSModuleURL=s}});Object.defineProperty(X0,"WasmModuleURL",{get:function(){return nc.WasmModuleURL},set:function(s){nc.WasmModuleURL=s}});var Y0=class{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".basis")}loadCubeData(e,t,i,r,n){if(Array.isArray(e))return;let o=t.getEngine().getCaps(),a={supportedCompressionFormats:{etc1:!!o.etc1,s3tc:!!o.s3tc,pvrtc:!!o.pvrtc,etc2:!!o.etc2,astc:!!o.astc,bc7:!!o.bptc}};kT(e,a).then(l=>{let c=l.fileInfo.images[0].levels.length>1&&t.generateMipMaps;GT(t,l),t.getEngine()._setCubeMapTextureParams(t,c),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),r&&r()}).catch(l=>{H.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),t.isReady=!0,n&&n(l)})}loadData(e,t,i){let r=t.getEngine().getCaps(),n={supportedCompressionFormats:{etc1:!!r.etc1,s3tc:!!r.s3tc,pvrtc:!!r.pvrtc,etc2:!!r.etc2,astc:!!r.astc,bc7:!!r.bptc}};kT(e,n).then(o=>{let a=o.fileInfo.images[0].levels[0],l=o.fileInfo.images[0].levels.length>1&&t.generateMipMaps;i(a.width,a.height,l,o.format!==-1,()=>{GT(t,o)})}).catch(o=>{H.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),H.Warn(`Failed to transcode Basis file: ${o}`),i(0,0,!1,!1,()=>{},!0)})}};Se._TextureLoaders.push(new Y0);var Rn=class extends vt{get isSupported(){return this._engine?.getCaps().drawBuffersExtension??!1}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,r,n,o){let a=n&&n.generateMipMaps?n.generateMipMaps:!1,l=n&&n.generateDepthTexture?n.generateDepthTexture:!1,c=n&&n.depthTextureFormat?n.depthTextureFormat:15,h=!n||n.doNotChangeAspectRatio===void 0?!0:n.doNotChangeAspectRatio,u=n&&n.drawOnlyOnFirstAttachmentByDefault?n.drawOnlyOnFirstAttachmentByDefault:!1;if(super(e,t,r,a,h,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported){this.dispose();return}this._textureNames=o;let d=[],f=[],m=[],g=[],_=[],x=[],b=[],C=[];this._initTypes(i,d,f,m,g,_,x,b,C,n);let R=!n||n.generateDepthBuffer===void 0?!0:n.generateDepthBuffer,E=!n||n.generateStencilBuffer===void 0?!1:n.generateStencilBuffer;this._multiRenderTargetOptions={samplingModes:f,generateMipMaps:a,generateDepthBuffer:R,generateStencilBuffer:E,generateDepthTexture:l,depthTextureFormat:c,types:d,textureCount:i,useSRGBBuffers:m,formats:g,targetTypes:_,faceIndex:x,layerIndex:b,layerCounts:C,labels:o,label:e},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=u,i>0&&(this._createInternalTextures(),this._createTextures(o))}_initTypes(e,t,i,r,n,o,a,l,c,h){for(let u=0;u<e;u++)h&&h.types&&h.types[u]!==void 0?t.push(h.types[u]):t.push(h&&h.defaultType?h.defaultType:0),h&&h.samplingModes&&h.samplingModes[u]!==void 0?i.push(h.samplingModes[u]):i.push(z.BILINEAR_SAMPLINGMODE),h&&h.useSRGBBuffers&&h.useSRGBBuffers[u]!==void 0?r.push(h.useSRGBBuffers[u]):r.push(!1),h&&h.formats&&h.formats[u]!==void 0?n.push(h.formats[u]):n.push(5),h&&h.targetTypes&&h.targetTypes[u]!==void 0?o.push(h.targetTypes[u]):o.push(3553),h&&h.faceIndex&&h.faceIndex[u]!==void 0?a.push(h.faceIndex[u]):a.push(0),h&&h.layerIndex&&h.layerIndex[u]!==void 0?l.push(h.layerIndex[u]):l.push(0),h&&h.layerCounts&&h.layerCounts[u]!==void 0?c.push(h.layerCounts[u]):c.push(1)}_createInternaTextureIndexMapping(){let e={},t=[];if(!this._renderTarget)return t;let i=this._renderTarget.textures;for(let r=0;r<i.length;r++){let n=i[r];if(!n)continue;let o=e[n.uniqueId];o!==void 0?t[r]=o:e[n.uniqueId]=r}return t}_rebuild(e=!1,t=!1,i){if(this._count<1||e)return;let r=this._createInternaTextureIndexMapping();this.releaseInternalTextures(),this._createInternalTextures(),t&&(this._releaseTextures(),this._createTextures(i));let n=this._renderTarget.textures;for(let o=0;o<n.length;o++){let a=this._textures[o];r[o]!==void 0&&this._renderTarget.setTexture(n[r[o]],o),a._texture=n[o],a._texture&&(a._noMipmap=!a._texture.useMipMaps,a._useSRGBBuffer=a._texture._useSRGBBuffer)}this.samples!==1&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){let t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){let r=new z(null,this.getScene());e?.[i]&&(r.name=e[i]),r._texture=t[i],r._texture&&(r._noMipmap=!r._texture.useMipMaps,r._useSRGBBuffer=r._texture._useSRGBBuffer),this._textures.push(r)}}setInternalTexture(e,t,i=!0){if(this.renderTarget&&(t===0&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new z(null,this.getScene()),this.textures[t].name=this._textureNames?.[t]??this.textures[t].name),this.textures[t]._texture=e,this.textures[t]._noMipmap=!e.useMipMaps,this.textures[t]._useSRGBBuffer=e._useSRGBBuffer,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer),this._multiRenderTargetOptions.targetTypes&&this._multiRenderTargetOptions.targetTypes[t]!==-1)){let r=0;e.is2DArray?r=35866:e.isCube?r=34067:e.is3D?r=32879:r=3553,this._multiRenderTargetOptions.targetTypes[t]=r}}setLayerAndFaceIndex(e,t=-1,i=-1){!this.textures[e]||!this.renderTarget||(this._multiRenderTargetOptions.layerIndex&&(this._multiRenderTargetOptions.layerIndex[e]=t),this._multiRenderTargetOptions.faceIndex&&(this._multiRenderTargetOptions.faceIndex[e]=i),this.renderTarget.setLayerAndFaceIndex(e,t,i))}setLayerAndFaceIndices(e,t){this.renderTarget&&(this._multiRenderTargetOptions.layerIndex=e,this._multiRenderTargetOptions.faceIndex=t,this.renderTarget.setLayerAndFaceIndices(e,t))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._processSizeParameter(e,!1),this._rebuild(!1,void 0,this._textureNames)}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;let r=[],n=[],o=[],a=[],l=[],c=[],h=[],u=[];this._textureNames=i,this._initTypes(e,r,n,o,a,l,c,h,u,t),this._multiRenderTargetOptions.types=r,this._multiRenderTargetOptions.samplingModes=n,this._multiRenderTargetOptions.useSRGBBuffers=o,this._multiRenderTargetOptions.formats=a,this._multiRenderTargetOptions.targetTypes=l,this._multiRenderTargetOptions.faceIndex=c,this._multiRenderTargetOptions.layerIndex=h,this._multiRenderTargetOptions.layerCounts=u,this._multiRenderTargetOptions.labels=i,this._rebuild(!1,!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){let e=this._renderTarget?.textures;if(e){for(let t=e.length-1;t>=0;t--)this._textures[t]._texture=null;this._renderTarget?.dispose(),this._renderTarget=null}}};var dQ="noisePixelShader",fQ=`uniform float brightness;uniform float persistence;uniform float timeScale;varying vec2 vUV;vec2 hash22(vec2 p)
{p=p*mat2(127.1,311.7,269.5,183.3);p=-1.0+2.0*fract(sin(p)*43758.5453123);return sin(p*6.283+timeScale);}
float interpolationNoise(vec2 p)
{vec2 pi=floor(p);vec2 pf=p-pi;vec2 w=pf*pf*(3.-2.*pf);float f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));float f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));float f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));float f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));float xm1=mix(f00,f10,w.x);float xm2=mix(f01,f11,w.x);float ym=mix(xm1,xm2,w.y); 
return ym;}
float perlinNoise2D(float x,float y)
{float sum=0.0;float frequency=0.0;float amplitude=0.0;for(int i=0; i<OCTAVES; i++)
{frequency=pow(2.0,float(i));amplitude=pow(persistence,float(i));sum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;}
return sum;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float x=abs(vUV.x);float y=abs(vUV.y);float noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);gl_FragColor=vec4(noise,noise,noise,1.0);}
`;D.ShadersStore[dQ]=fQ;var $0=class s extends gn{constructor(e,t=256,i=me.LastCreatedScene,r,n){super(e,t,"noise",i,r,n),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this._updateShaderUniforms()}_updateShaderUniforms(){let e=this.getScene();e&&(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}_getDefines(){return"#define OCTAVES "+(this.octaves|0)}render(e){this._updateShaderUniforms(),super.render(e)}serialize(){let e={};return e.customType="BABYLON.NoiseProceduralTexture",e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e}clone(){let e=this.getSize(),t=new s(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t}static Parse(e,t){let i=new s(e.name,e.size,t,void 0,e.generateMipMaps);return i.brightness=e.brightness,i.octaves=e.octaves,i.persistence=e.persistence,i.animationSpeedFactor=e.animationSpeedFactor,i.time=e.time??0,i}};P("BABYLON.NoiseProceduralTexture",$0);var zT=class s extends Hi{constructor(e,t,i,r=5,n=0,o=!1,a=!1,l=3,c=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,i,r,n,o,a,l,c)}update(e,t,i,r,n=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,i,r,n)}updateRGBDAsync(e,t=null,i=.8,r=0){return JB(this._texture,e,t,i,r).then(()=>{})}clone(){return ae.Clone(()=>{let e=this.getScene(),t=this._texture,i=new s(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===ke.CubeRawRGBD&&i.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),i},this)}};var Dt=class s extends Qc{constructor(e,t,i,r,n){super(e,t,i),this._blockType=r,this._blockName=n,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof s&&e._blockName===this._blockName?mn.Compatible:mn.TypeIncompatible}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}};var j0=class extends Z{constructor(e){super(e,w.Vertex),this.registerInput("matricesIndices",T.Vector4),this.registerInput("matricesWeights",T.Vector4),this.registerInput("matricesIndicesExtra",T.Vector4,!0),this.registerInput("matricesWeightsExtra",T.Vector4,!0),this.registerInput("world",T.Matrix),this.registerOutput("output",T.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.matricesIndices.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="matricesIndices"&&t(r));i||(i=new Be("matricesIndices"),i.setAsAttribute("matricesIndices")),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="matricesWeights"&&t(r));i||(i=new Be("matricesWeights"),i.setAsAttribute("matricesWeights")),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.World&&t(r));i||(i=new Be("world"),i.setAsSystemValue(qe.World)),i.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){ao(i,e)}prepareDefines(e,t,i){i._areAttributesDirty&&$S(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");let t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});let i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});let r=this._outputs[0],n=this.world;return e.compilationString+=`#if NUM_BONE_INFLUENCERS>0
`,e.compilationString+=e._declareOutput(r)+` = ${n.associatedVariableName} * ${i};
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(r)+` = ${n.associatedVariableName};
`,e.compilationString+=`#endif
`,this}};P("BABYLON.BonesBlock",j0);var q0=class extends Z{constructor(e){super(e,w.Vertex),this.registerInput("world0",T.Vector4),this.registerInput("world1",T.Vector4),this.registerInput("world2",T.Vector4),this.registerInput("world3",T.Vector4),this.registerInput("world",T.Matrix,!0),this.registerOutput("output",T.Matrix),this.registerOutput("instanceID",T.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e,t=()=>!0){if(!this.world0.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world0"&&t(r));i||(i=new Be("world0"),i.setAsAttribute("world0")),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world1"&&t(r));i||(i=new Be("world1"),i.setAsAttribute("world1")),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world2"&&t(r));i||(i=new Be("world2"),i.setAsAttribute("world2")),i.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world3"&&t(r));i||(i=new Be("world3"),i.setAsAttribute("world3")),i.output.connectTo(this.world3)}if(!this.world.connectedPoint){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="world"&&t(r));i||(i=new Be("world"),i.setAsSystemValue(qe.World)),i.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,r=!1,n){let o=!1;i.INSTANCES!==r&&(i.setValue("INSTANCES",r),o=!0),n&&i.THIN_INSTANCES!==!!n?.getRenderingMesh().hasThinInstances&&(i.setValue("THIN_INSTANCES",!!n?.getRenderingMesh().hasThinInstances),o=!0),o&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);let t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);let i=this._outputs[0],r=this._outputs[1],n=this.world0,o=this.world1,a=this.world2,l=this.world3,c="mat4",h="gl_InstanceID",u="float";return e.shaderLanguage===pe.WGSL&&(c="mat4x4f",h="vertexInputs.instanceIndex",u="f32"),e.compilationString+=`#ifdef INSTANCES
`,e.compilationString+=e._declareOutput(i)+` = ${c}(${n.associatedVariableName}, ${o.associatedVariableName}, ${a.associatedVariableName}, ${l.associatedVariableName});
`,e.compilationString+=`#ifdef THIN_INSTANCES
`,e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};
`,e.compilationString+=`#endif
`,t._caps.canUseGLInstanceID?e.compilationString+=e._declareOutput(r)+` = ${u}(${h});
`:e.compilationString+=e._declareOutput(r)+` = 0.0;
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(i)+` = ${this.world.associatedVariableName};
`,e.compilationString+=e._declareOutput(r)+` = 0.0;
`,e.compilationString+=`#endif
`,this}};P("BABYLON.InstancesBlock",q0);var Lm=class extends Z{constructor(e){super(e,w.Vertex),this.registerInput("position",T.Vector3),this.registerInput("normal",T.Vector3),this.registerInput("tangent",T.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(T.Color4|T.Vector4|T.Vector3),this.registerInput("uv",T.Vector2),this.registerOutput("positionOutput",T.Vector3),this.registerOutput("normalOutput",T.Vector3),this.registerOutput("tangentOutput",T.Vector4),this.registerOutput("uvOutput",T.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}initialize(e){e._excludeVariableName("morphTargetInfluences")}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="position"&&t(r));i||(i=new Be("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="normal"&&t(r));i||(i=new Be("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="tangent"&&t(r));i||(i=new Be("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="uv"&&t(r));i||(i=new Be("uv"),i.setAsAttribute("uv")),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){if(e.morphTargetManager){let r=e.morphTargetManager;r?.isUsingTextureForTargets&&(r.numMaxInfluencers||r.numInfluencers)!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}i._areAttributesDirty&&jS(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&(Vr(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,r){let n=this.position,o=this.normal,a=this.tangent,l=this.uv,c=this.positionOutput,h=this.normalOutput,u=this.tangentOutput,d=this.uvOutput,f=e,m=r.NUM_MORPH_INFLUENCERS,g=i.morphTargetManager,_=g&&g.supportsNormals&&r.NORMAL,x=g&&g.supportsTangents&&r.TANGENT,b=g&&g.supportsUVs&&r.UV1,C="";g?.isUsingTextureForTargets&&m>0&&(C+=`${f._declareLocalVar("vertexID",T.Float)};
`),C+=`#ifdef MORPHTARGETS
`;let R=f.shaderLanguage===pe.WGSL,E=R?"uniforms.":"";if(g?.isUsingTextureForTargets)C+=`for (${R?"var":"int"} i = 0; i < NUM_MORPH_INFLUENCERS; i++) {
`,C+=`if (i >= ${E}morphTargetCount) { break; }
`,C+=`vertexID = ${R?"f32(vertexInputs.vertexIndex":"float(gl_VertexID"}) * ${E}morphTargetTextureInfo.x;
`,C+=`${c.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${n.associatedVariableName}) * ${E}morphTargetInfluences[i];
`,C+=`vertexID += 1.0;
`,_&&(C+=`#ifdef MORPHTARGETS_NORMAL
`,C+=`${h.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${o.associatedVariableName}) * ${E}morphTargetInfluences[i];
`,C+=`vertexID += 1.0;
`,C+=`#endif
`),b&&(C+=`#ifdef MORPHTARGETS_UV
`,C+=`${d.associatedVariableName} += (readVector3FromRawSampler(i, vertexID).xy - ${l.associatedVariableName}) * ${E}morphTargetInfluences[i];
`,C+=`vertexID += 1.0;
`,C+=`#endif
`),x&&(C+=`#ifdef MORPHTARGETS_TANGENT
`,C+=`${u.associatedVariableName}.xyz += (readVector3FromRawSampler(i, vertexID) - ${a.associatedVariableName}.xyz) * ${E}morphTargetInfluences[i];
`,a.type===T.Vector4?C+=`${u.associatedVariableName}.w = ${a.associatedVariableName}.w;
`:C+=`${u.associatedVariableName}.w = 1.;
`,C+=`#endif
`),C+=`}
`;else for(let S=0;S<m;S++)C+=`${c.associatedVariableName} += (position${S} - ${n.associatedVariableName}) * ${E}morphTargetInfluences[${S}];
`,_&&(C+=`#ifdef MORPHTARGETS_NORMAL
`,C+=`${h.associatedVariableName} += (normal${S} - ${o.associatedVariableName}) * ${E}morphTargetInfluences[${S}];
`,C+=`#endif
`),b&&(C+=`#ifdef MORPHTARGETS_UV
`,C+=`${d.associatedVariableName}.xy += (uv_${S} - ${l.associatedVariableName}.xy) * ${E}morphTargetInfluences[${S}];
`,C+=`#endif
`),x&&(C+=`#ifdef MORPHTARGETS_TANGENT
`,C+=`${u.associatedVariableName}.xyz += (tangent${S} - ${a.associatedVariableName}.xyz) * ${E}morphTargetInfluences[${S}];
`,a.type===T.Vector4?C+=`${u.associatedVariableName}.w = ${a.associatedVariableName}.w;
`:C+=`${u.associatedVariableName}.w = 1.;
`,C+=`#endif
`);if(C+=`#endif
`,f.compilationString=f.compilationString.replace(this._repeatableContentAnchor,C),m>0)for(let S=0;S<m;S++)f.attributes.push(y.PositionKind+S),_&&f.attributes.push(y.NormalKind+S),x&&f.attributes.push(y.TangentKind+S),b&&f.attributes.push(y.UVKind+"_"+S)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);let t=this.position,i=this.normal,r=this.tangent,n=this.uv,o=this.positionOutput,a=this.normalOutput,l=this.tangentOutput,c=this.uvOutput,h=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetCount"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",h),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",h,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${e._declareOutput(o)} = ${t.associatedVariableName};
`,e.compilationString+=`#ifdef NORMAL
`,e.compilationString+=`${e._declareOutput(a)} = ${i.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(a)} = vec3(0., 0., 0.);
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef TANGENT
`,e.compilationString+=`${e._declareOutput(l)} = ${r.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(l)} = vec4(0., 0., 0., 0.);
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef UV1
`,e.compilationString+=`${e._declareOutput(c)} = ${n.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(c)} = vec2(0., 0.);
`,e.compilationString+=`#endif
`,this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}};P("BABYLON.MorphTargetsBlock",Lm);var Q0=class extends Z{constructor(e){super(e,w.Vertex),this.registerInput("worldPosition",T.Vector4,!1,w.Vertex),this.registerOutput("direction",T.Vector3),this.registerOutput("color",T.Color3),this.registerOutput("intensity",T.Float),this.registerOutput("shadowBias",T.Float),this.registerOutput("shadowNormalBias",T.Float),this.registerOutput("shadowDepthScale",T.Float),this.registerOutput("shadowDepthRange",T.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let r=this.light,n=t.getScene();if(!r&&n.lights.length&&(r=this.light=n.lights[0],this._forcePrepareDefines=!0),!r||!r.isEnabled){e.setFloat3(this._lightDataUniformName,0,0,0),e.setFloat4(this._lightColorUniformName,0,0,0,0);return}r.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,r.diffuse,r.intensity);let o=r.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(o?e.setFloat3(this._lightShadowUniformName,o.bias,o.normalBias,o.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(o&&n.activeCamera){let a=r;e.setFloat2(this._lightShadowExtraUniformName,a.getDepthMinZ(n.activeCamera),a.getDepthMinZ(n.activeCamera)+a.getDepthMaxZ(n.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;let r=this.light;i.setValue(this._lightTypeDefineName,!!(r&&r instanceof In),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);let t=this.direction,i=this.color,r=this.intensity,n=this.shadowBias,o=this.shadowNormalBias,a=this.shadowDepthScale,l=this.shadowDepthRange;this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE");let c=e.shaderLanguage===pe.WGSL?"uniforms.":"";return e._emitUniformFromString(this._lightDataUniformName,T.Vector3),e._emitUniformFromString(this._lightColorUniformName,T.Vector4),e.compilationString+=`#ifdef ${this._lightTypeDefineName}
`,e.compilationString+=e._declareOutput(t)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${this._lightDataUniformName});
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(t)+` = ${c}${this._lightDataUniformName};
`,e.compilationString+=`#endif
`,e.compilationString+=e._declareOutput(i)+` = ${c}${this._lightColorUniformName}.rgb;
`,e.compilationString+=e._declareOutput(r)+` = ${c}${this._lightColorUniformName}.a;
`,(n.hasEndpoints||o.hasEndpoints||a.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,T.Vector3),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${c}${this._lightShadowUniformName}.x;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${c}${this._lightShadowUniformName}.y;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${c}${this._lightShadowUniformName}.z;
`)),l.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,T.Vector2),e.compilationString+=e._declareOutput(l)+` = ${this._lightShadowUniformName};
`),this}serialize(){let e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}};P("BABYLON.LightInformationBlock",Q0);var WT=class extends Z{constructor(e){super(e,w.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",T.AutoDetect),this.registerOutput("output",T.Color4),this.registerOutput("rgb",T.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Color4|T.Vector3|T.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity")}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){i&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");let t=this.color,i=this._outputs[0],r=`//${this.name}`,n=e.shaderLanguage===pe.WGSL?"Vec3":"";return e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),t.connectedPoint?.isConnected&&(t.connectedPoint.type===T.Color4||t.connectedPoint.type===T.Vector4?e.compilationString+=`${e._declareOutput(i)} = ${t.associatedVariableName};
`:e.compilationString+=`${e._declareOutput(i)} = vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);
`,e.compilationString+=`#ifdef IMAGEPROCESSINGPOSTPROCESS
`,this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${n}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);
`),e.compilationString+=`#else
`,e.compilationString+=`#ifdef IMAGEPROCESSING
`,this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${n}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);
`),e.compilationString+=`${i.associatedVariableName} = applyImageProcessing(${i.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#endif
`,this.rgb.hasEndpoints&&(e.compilationString+=e._declareOutput(this.rgb)+` = ${this.output.associatedVariableName}.xyz;
`)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};
`,e}serialize(){let e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertInputToLinearSpace=e.convertInputToLinearSpace??!0}};v([de("Convert input to linear space",ue.Boolean,"ADVANCED")],WT.prototype,"convertInputToLinearSpace",void 0);P("BABYLON.ImageProcessingBlock",WT);var al=class s extends Z{constructor(e){super(e,w.Fragment,!0),this.registerInput("normal",T.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(T.Color4|T.Vector4|T.Vector3),this.registerInput("tangent",T.Vector4,!1),this.registerInput("world",T.Matrix,!1),this.registerOutput("TBN",T.Object,w.Fragment,new Dt("TBN",this,xt.Output,s,"TBNBlock")),this.registerOutput("row0",T.Vector3,w.Fragment),this.registerOutput("row1",T.Vector3,w.Fragment),this.registerOutput("row2",T.Vector3,w.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return w.Fragment}set target(e){}autoConfigure(e,t=()=>!0){if(!this.world.isConnected){let i=e.getInputBlockByPredicate(r=>r.isSystemValue&&r.systemValue===qe.World&&t(r));i||(i=new Be("world"),i.setAsSystemValue(qe.World)),i.output.connectTo(this.world)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="normal"&&t(r));i||(i=new Be("normal"),i.setAsAttribute("normal")),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="tangent"&&r.type===T.Vector4&&t(r));i||(i=new Be("tangent"),i.setAsAttribute("tangent")),i.output.connectTo(this.tangent)}}prepareDefines(e,t,i){let r=this.normal,n=this.tangent,o=r.isConnected;r.connectInputBlock?.isAttribute&&!e.isVerticesDataPresent(r.connectInputBlock?.name)&&(o=!1);let a=n.isConnected;n.connectInputBlock?.isAttribute&&!e.isVerticesDataPresent(n.connectInputBlock?.name)&&(a=!1);let l=o&&a;i.setValue("TBNBLOCK",l,!0)}_buildBlock(e){super._buildBlock(e);let t=this.normal,i=this.tangent,r=this.world,n=this.TBN,o=this.row0,a=this.row1,l=this.row2,c=e.shaderLanguage===pe.WGSL,h=c?"mat3x3f":"mat3",u=c?"f":"";return e.target===w.Fragment&&(e.compilationString+=`
                // ${this.name}
                ${e._declareLocalVar("tbnNormal",T.Vector3)} = normalize(${t.associatedVariableName}).xyz;
                ${e._declareLocalVar("tbnTangent",T.Vector3)} = normalize(${i.associatedVariableName}.xyz);
                ${e._declareLocalVar("tbnBitangent",T.Vector3)} = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;
                ${c?"var":"mat3"} ${n.associatedVariableName} = ${h}(${r.associatedVariableName}[0].xyz, ${r.associatedVariableName}[1].xyz, ${r.associatedVariableName}[2].xyz) * ${h}(tbnTangent, tbnBitangent, tbnNormal);
            `,o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = vec3${u}(${n.associatedVariableName}[0][0], ${n.associatedVariableName}[0][1], ${n.associatedVariableName}[0][2]);
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = vec3${u}(${n.associatedVariableName}[1[0], ${n.associatedVariableName}[1][1], ${n.associatedVariableName}[1][2]);
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = vec3${u}(${n.associatedVariableName}[2][0], ${n.associatedVariableName}[2][1], ${n.associatedVariableName}[2][2]);
`),e.sharedData.blocksWithDefines.push(this)),this}};P("BABYLON.TBNBlock",al);var Th=class extends Z{constructor(e){super(e,w.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",T.Vector4,!1),this.registerInput("worldNormal",T.Vector4,!1),this.registerInput("worldTangent",T.Vector4,!0),this.registerInput("uv",T.Vector2,!1),this.registerInput("normalMapColor",T.Color3,!1),this.registerInput("strength",T.Float,!1),this.registerInput("viewDirection",T.Vector3,!0),this.registerInput("parallaxScale",T.Float,!0),this.registerInput("parallaxHeight",T.Float,!0),this.registerInput("TBN",T.Object,!0,w.VertexAndFragment,new Dt("TBN",this,xt.Input,al,"TBNBlock")),this.registerInput("world",T.Matrix,!0),this.registerOutput("output",T.Vector4),this.registerOutput("uvOffset",T.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}prepareDefines(e,t,i){let r=this.normalMapColor.connectedPoint._ownerBlock.samplerName,n=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&r||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",n,!0),i.setValue("PARALLAX_RHS",t.getScene().useRightHandedSystem,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="uv"&&t(r));i||(i=new Be("uv"),i.setAsAttribute()),i.output.connectTo(this.uv)}if(!this.strength.isConnected){let i=new Be("strength");i.value=1,i.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);let t=`//${this.name}`,i=this.uv,r=this.worldPosition,n=this.worldNormal,o=this.worldTangent,a=e.shaderLanguage===pe.WGSL,l=a?"mat3x3f":"mat3",c=a?"f":"",h=a?"uniforms.":"";e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,T.Vector2),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,T.Float),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,T.Matrix);let u=null;this.normalMapColor.connectedPoint&&(u=this.normalMapColor.connectedPoint._ownerBlock.samplerName);let d=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&u||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),f=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",m=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`
#if !defined(NORMALXYSCALE)
1.0/
#endif
${e._emitFloat(this.strength.connectInputBlock.value)}`:`
#if !defined(NORMALXYSCALE)
1.0/
#endif
${this.strength.associatedVariableName}`;a||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let g={search:/defined\(TANGENT\)/g,replace:o.isConnected?"defined(TANGENT)":"defined(IGNORE)"},_={search:/varying mat3 vTBN;/g,replace:""},x={search:/uniform mat4 normalMatrix;/g,replace:""},b=this.TBN;b.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            ${a?"var":"mat3"} vTBN = ${b.associatedVariableName};
            #endif
            `:o.isConnected&&(e.compilationString+=`${e._declareLocalVar("tbnNormal",T.Vector3)} = normalize(${n.associatedVariableName}.xyz);
`,e.compilationString+=`${e._declareLocalVar("tbnTangent",T.Vector3)} = normalize(${o.associatedVariableName}.xyz);
`,e.compilationString+=`${e._declareLocalVar("tbnBitangent",T.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};
`,e.compilationString+=`${a?"var":"mat3"} vTBN = ${l}(tbnTangent, tbnBitangent, tbnNormal);
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:[g,_,x]});let C=a?"fn parallaxOcclusion(vViewDirCoT: vec3f, vNormalCoT: vec3f, texCoord: vec2f, parallaxScale:f32, bump: texture_2d<f32>, bumpSampler: sampler)":`#define inline
vec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)`,R=a?/fn parallaxOcclusion\(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32\)/g:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,E=a?"fn parallaxOffset(viewDir: vec3f, heightScale: f32, height_: f32)":"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)",S=a?/fn parallaxOffset\(viewDir: vec3f,heightScale: f32\)/g:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g;e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:R,replace:C},{search:S,replace:E},{search:/texture.+?bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});let A=a?`textureSample(${u}, ${u+"Sampler"}`:`texture2D(${u}`,L=!d||!u?this.normalMapColor.associatedVariableName:`${A}, ${i.associatedVariableName} + uvOffset).xyz`,G=e._getFreeVariableName("tempOutput");return e.compilationString+=e._declareLocalVar(G,T.Vector3)+` = vec3${c}(0.);
`,e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:[{search:/texture.+?bumpSampler,vBumpUV\)/g,replace:`${L}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`${e._declareLocalVar("normalMatrix",T.Matrix)} = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:/perturbNormal\(TBN,texture.+?bumpSampler,vBumpUV\+uvOffset\).xyz,vBumpInfos.y\)/g,replace:`perturbNormal(TBN, ${L}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${a?d&&this.useParallaxOcclusion?`${u}, ${u+"Sampler"}`:"bump, bumpSampler":d&&this.useParallaxOcclusion?u:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${d?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vTangentSpaceParams/g,replace:h+this._tangentSpaceParameterName},{search:/vBumpInfos.y/g,replace:m},{search:/vBumpInfos.z/g,replace:f},{search:/vBumpUV/g,replace:i.associatedVariableName},{search:/vPositionW/g,replace:r.associatedVariableName+".xyz"},{search:/normalW=/g,replace:G+" = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:`${l}(normalMatrix) * `+G},{search:/normalW/g,replace:n.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:d?this.viewDirection.associatedVariableName:`vec3${c}(0.)`},g]}),e.compilationString+=e._declareOutput(this.output)+` = vec4${c}(${G}, 0.);
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};
`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};
`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};
`,e+=`${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};
`,e}serialize(){let e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}};v([de("Invert X axis",ue.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Th.prototype,"invertX",void 0);v([de("Invert Y axis",ue.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Th.prototype,"invertY",void 0);v([de("Use parallax occlusion",ue.Boolean)],Th.prototype,"useParallaxOcclusion",void 0);v([de("Object Space Mode",ue.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Th.prototype,"useObjectSpaceNormalMap",void 0);P("BABYLON.PerturbNormalBlock",Th);var K0=class extends Z{constructor(e){super(e,w.Fragment,!0),this.registerInput("value",T.Float,!0),this.registerInput("cutoff",T.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,!(!this.cutoff.isConnected||!this.value.isConnected))return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) { discard; }
`,this}};P("BABYLON.DiscardBlock",K0);var Z0=class extends Z{constructor(e){super(e,w.Fragment),this.registerOutput("output",T.Float,w.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===w.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary("1.0","0.0",e.shaderLanguage===pe.GLSL?"gl_FrontFacing":"fragmentInputs.frontFacing")};
`,this}};P("BABYLON.FrontFacingBlock",Z0);var J0=class extends Z{constructor(e){super(e,w.Fragment),this.registerInput("input",T.AutoDetect,!1),this.registerOutput("dx",T.BasedOnInput),this.registerOutput("dy",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._outputs[1];e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let r="dFdx",n="dFdy";return e.shaderLanguage===pe.WGSL&&(r="dpdx",n="dpdy"),t.hasEndpoints&&(e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});
`),i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${n}(${this.input.associatedVariableName});
`),this}};P("BABYLON.DerivativeBlock",J0);var eR=class extends Z{constructor(e){super(e,w.Fragment),this.registerOutput("xy",T.Vector2,w.Fragment),this.registerOutput("xyz",T.Vector3,w.Fragment),this.registerOutput("xyzw",T.Vector4,w.Fragment),this.registerOutput("x",T.Float,w.Fragment),this.registerOutput("y",T.Float,w.Fragment),this.registerOutput("z",T.Float,w.Fragment),this.registerOutput("w",T.Float,w.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="",i=e.shaderLanguage===pe.WGSL?"fragmentInputs.position":"gl_FragCoord";for(let r of this._outputs)r.hasEndpoints&&(t+=`${e._declareOutput(r)} = ${i}.${r.name};
`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===w.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}};P("BABYLON.FragCoordBlock",eR);var tR=class extends Z{constructor(e){super(e,w.Fragment),this.registerOutput("xy",T.Vector2,w.Fragment),this.registerOutput("x",T.Float,w.Fragment),this.registerOutput("y",T.Float,w.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){let t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(let r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};
`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===w.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,T.Vector2);let t=e.shaderLanguage===pe.WGSL?"uniforms.":"";return e.compilationString+=this.writeOutputs(e,t+this._varName),this}};P("BABYLON.ScreenSizeBlock",tR);var iR=class extends Z{constructor(e){super(e,w.Fragment),this.registerInput("vector",T.AutoDetect),this.registerInput("worldViewProjection",T.Matrix),this.registerOutput("output",T.Vector2),this.registerOutput("x",T.Float),this.registerOutput("y",T.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Vector3|T.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e,t=()=>!0){if(!this.worldViewProjection.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.WorldViewProjection&&t(r));i||(i=new Be("worldViewProjection"),i.setAsSystemValue(qe.WorldViewProjection)),i.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);let t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;let r=i.associatedVariableName,n=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case T.Vector3:e.compilationString+=`${e._declareLocalVar(n,T.Vector4)} = ${r} * vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);
`;break;case T.Vector4:e.compilationString+=`${e._declareLocalVar(n,T.Vector4)} = ${r} * ${t.associatedVariableName};
`;break}return e.compilationString+=`${n} = vec4${e.fSuffix}(${n}.xy / ${n}.w, ${n}.zw);`,e.compilationString+=`${n} = vec4${e.fSuffix}(${n}.xy * 0.5 + vec2${e.fSuffix}(0.5, 0.5), ${n}.zw);`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${n}.xy;
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${n}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${n}.y;
`),this}};P("BABYLON.ScreenSpaceBlock",iR);var rR=class extends Z{constructor(e){super(e,w.Fragment),this.registerInput("input",T.Vector2),this.registerInput("strength",T.Float),this.registerInput("center",T.Vector2),this.registerInput("offset",T.Vector2),this.registerOutput("output",T.Vector2),this.registerOutput("x",T.Float),this.registerOutput("y",T.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){let e=new Be("center");e.value=new j(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){let e=new Be("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){let e=new Be("offset");e.value=new j(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);let t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),r=e._getFreeVariableName("x"),n=e._getFreeVariableName("y"),o=e._getFreeVariableName("result");return e.compilationString+=`        
            ${e._declareLocalVar(t,T.Vector2)} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};
            ${e._declareLocalVar(i,T.Float)} = ${this.strength.associatedVariableName} * length(${t});
            ${e._declareLocalVar(r,T.Float)} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;
            ${e._declareLocalVar(n,T.Float)} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;
            ${e._declareLocalVar(o,T.Vector2)} = vec2(${r} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${n} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);
        `,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${o};
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${o}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${o}.y;
`),this}};P("BABYLON.TwirlBlock",rR);var Kd=class extends Z{constructor(e){super(e,w.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",T.Float),this.registerInput("worldPosition",T.Vector3),this.registerInput("worldNormal",T.Vector3),this.registerInput("worldTangent",T.AutoDetect,!0),this.registerOutput("output",T.Vector4),this.registerOutput("xyz",T.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Vector3|T.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=e.shaderLanguage===pe.WGSL,r=e.fSuffix;!this.generateInWorldSpace&&!this.worldTangent.isConnected&&F.Error(`You must connect the 'worldTangent' input of the ${this.name} block!`);let n=this.generateInWorldSpace?"":`
            vec3 biTangent = cross(norm, tgt);
            mat3 TBN = mat3(tgt, biTangent, norm);
            `,o=this.generateInWorldSpace?"":`
            result = TBN * result;
            result = result * vec3(0.5) + vec3(0.5);
            `,a=`
            vec4 heightToNormal(float height, vec3 position, vec3 tangent, vec3 normal) {
                vec3 tgt = ${this.automaticNormalizationTangent?"normalize(tangent);":"tangent;"}
                vec3 norm = ${this.automaticNormalizationNormal?"normalize(normal);":"normal;"}
                ${n}
                vec3 worlddX = dFdx(position);
                vec3 worlddY = dFdy(position);
                vec3 crossX = cross(norm, worlddX);
                vec3 crossY = cross(norm, worlddY);
                float d = abs(dot(crossY, worlddX));
                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));
                inToNormal.y *= -1.0;
                vec3 result = normalize((d * norm) - inToNormal);
                ${o}
                return vec4(result, 0.);
            }`;return i?a=e._babylonSLtoWGSL(a):e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",a,"// heightToNormal"),e.compilationString+=e._declareOutput(t)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:`vec3${r}(0.)`}.xyz, ${this.worldNormal.associatedVariableName});
`,this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;
`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};
`,e+=`${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};
`,e+=`${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};
`,e}serialize(){let e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}};v([de("Generate in world space instead of tangent space",ue.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Kd.prototype,"generateInWorldSpace",void 0);v([de("Force normalization for the worldNormal input",ue.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Kd.prototype,"automaticNormalizationNormal",void 0);v([de("Force normalization for the worldTangent input",ue.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Kd.prototype,"automaticNormalizationTangent",void 0);P("BABYLON.HeightToNormalBlock",Kd);var sR=class extends Z{constructor(e){super(e,w.Fragment,!0),this.registerInput("depth",T.Float,!0),this.registerInput("worldPos",T.Vector4,!0),this.registerInput("viewProjection",T.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){super._buildBlock(e);let t=e.shaderLanguage===pe.GLSL?"gl_FragDepth":"fragmentOutputs.fragDepth";return this.depth.isConnected?e.compilationString+=`${t} = ${this.depth.associatedVariableName};
`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`
                ${e._declareLocalVar("p",T.Vector4)} = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};
                ${e._declareLocalVar("v",T.Float)} = p.z / p.w;
                #ifndef IS_NDC_HALF_ZRANGE
                    v = v * 0.5 + 0.5;
                #endif
                ${t} = v;
    
            `:F.Warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}};P("BABYLON.FragDepthBlock",sR);var nR=class extends Z{constructor(e){super(e,w.Fragment),this.registerInput("worldPosition",T.Vector4,!1),this.registerInput("viewProjection",T.Matrix,!1),this.registerInput("worldNormal",T.AutoDetect,!0),this.registerOutput("depth",T.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Vector3|T.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM")}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=`//${this.name}`;return e._emitUniformFromString("biasAndScaleSM",T.Vector3),e._emitUniformFromString("lightDataSM",T.Vector3),e._emitUniformFromString("depthValuesSM",T.Vector2),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`vec4 worldPos = ${this.worldPosition.associatedVariableName};
`,e.compilationString+=`vec3 vPositionWSM;
`,e.compilationString+=`float vDepthMetricSM = 0.0;
`,e.compilationString+=`float zSM;
`,this.worldNormal.isConnected&&(e.compilationString+=`vec3 vNormalW = ${this.worldNormal.associatedVariableName}.xyz;
`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`vec4 clipPos = ${this.viewProjection.associatedVariableName} * worldPos;
`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]}),e.compilationString+=`
            #if SM_DEPTHTEXTURE == 1
                #ifdef IS_NDC_HALF_ZRANGE
                    gl_FragDepth = (clipPos.z / clipPos.w);
                #else
                    gl_FragDepth = (clipPos.z / clipPos.w) * 0.5 + 0.5;
                #endif
            #endif
        `,e.compilationString+=`${e._declareOutput(this.depth)} = vec3(depthSM, 1., 1.);
`,this}};P("BABYLON.ShadowMapBlock",nR);var oR=class extends Z{constructor(e){super(e,w.Fragment,!0),this.registerInput("viewDepth",T.Float,!0),this.registerInput("worldPosition",T.AutoDetect,!0),this.registerInput("viewNormal",T.AutoDetect,!0),this.registerInput("reflectivity",T.AutoDetect,!0),this.inputs[1].addExcludedConnectionPointFromAllowedTypes(T.Vector3|T.Vector4),this.inputs[2].addExcludedConnectionPointFromAllowedTypes(T.Vector3|T.Vector4),this.inputs[3].addExcludedConnectionPointFromAllowedTypes(T.Vector3|T.Vector4|T.Color3|T.Color4)}getClassName(){return"PrePassOutputBlock"}get viewDepth(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get viewNormal(){return this._inputs[2]}get reflectivity(){return this._inputs[3]}_buildBlock(e){super._buildBlock(e);let t=this.worldPosition,i=this.viewNormal,r=this.viewDepth,n=this.reflectivity;e.sharedData.blocksWithDefines.push(this);let o=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",o),e.compilationString+=`#if defined(PREPASS)\r
`,e.compilationString+=`#ifdef PREPASS_DEPTH\r
`,r.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_DEPTH_INDEX] = vec4(${r.associatedVariableName}, 0.0, 0.0, 1.0);\r
`:e.compilationString+=` gl_FragData[PREPASS_DEPTH_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_POSITION\r
`,t.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_POSITION_INDEX] = vec4(${t.associatedVariableName}.rgb, ${t.connectedPoint.type===T.Vector4?t.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` gl_FragData[PREPASS_POSITION_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_NORMAL\r
`,i.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_NORMAL_INDEX] = vec4(${i.associatedVariableName}.rgb, ${i.connectedPoint.type===T.Vector4?i.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` gl_FragData[PREPASS_NORMAL_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_REFLECTIVITY\r
`,n.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_REFLECTIVITY_INDEX] = vec4(${n.associatedVariableName}.rgb, ${n.connectedPoint.type===T.Vector4?n.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` gl_FragData[PREPASS_REFLECTIVITY_INDEX] = vec4(0.0, 0.0, 0.0, 1.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#endif\r
`,this}};P("BABYLON.PrePassOutputBlock",oR);var aR=class extends Z{constructor(e){super(e,w.VertexAndFragment,!1),this.registerInput("worldPosition",T.Vector4,!1,w.Vertex),this.registerInput("view",T.Matrix,!1,w.Vertex),this.registerInput("input",T.AutoDetect,!1,w.Fragment),this.registerInput("fogColor",T.AutoDetect,!1,w.Fragment),this.registerOutput("output",T.Color3,w.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Vector3|T.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Vector3|T.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.View&&t(r));i||(i=new Be("view"),i.setAsSystemValue(qe.View)),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.FogColor&&t(r));i||(i=new Be("fogColor",void 0,T.Color3),i.setAsSystemValue(qe.FogColor)),i.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){let r=e.getScene();i.setValue("FOG",t.fogEnabled&&YS(e,r))}bind(e,t,i){if(!i)return;let r=i.getScene();e.setFloat4(this._fogParameters,r.fogMode,r.fogStart,r.fogEnd,r.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===w.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=[],i="",r="";e.shaderLanguage===pe.WGSL?(t=[{search:/fn CalcFogFactor\(\)/,replace:"fn CalcFogFactor(vFogDistance: vec3f, vFogInfos: vec4f)"},{search:/uniforms.vFogInfos/g,replace:"vFogInfos"},{search:/fragmentInputs.vFogDistance/g,replace:"vFogDistance"}],i="fragmentInputs.",r="uniforms."):t=[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}],e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:t});let n=e._getFreeVariableName("fog"),o=this.input,a=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");let l=this._outputs[0];e._emitUniformFromString(this._fogParameters,T.Vector4),e.compilationString+=`#ifdef FOG
`,e.compilationString+=`${e._declareLocalVar(n,T.Float)} = CalcFogFactor(${i}${this._fogDistanceName}, ${r}${this._fogParameters});
`,e.compilationString+=e._declareOutput(l)+` = ${n} * ${o.associatedVariableName}.rgb + (1.0 - ${n}) * ${a.associatedVariableName}.rgb;
`,e.compilationString+=`#else
${e._declareOutput(l)} =  ${o.associatedVariableName}.rgb;
`,e.compilationString+=`#endif
`}else{let t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,T.Vector3);let r=e.shaderLanguage===pe.WGSL?"vertexOutputs.":"";e.compilationString+=`${r}${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;
`}return this}};P("BABYLON.FogBlock",aR);var Bm=class extends Z{static _OnGenerateOnlyFragmentCodeChanged(e,t){let i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,F.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?w.Fragment:w.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?w.Fragment:w.Vertex}constructor(e){super(e,w.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",T.Vector4,!1,w.Vertex),this.registerInput("worldNormal",T.Vector4,!1,w.Fragment),this.registerInput("cameraPosition",T.Vector3,!1,w.Fragment),this.registerInput("glossiness",T.Float,!0,w.Fragment),this.registerInput("glossPower",T.Float,!0,w.Fragment),this.registerInput("diffuseColor",T.Color3,!0,w.Fragment),this.registerInput("specularColor",T.Color3,!0,w.Fragment),this.registerInput("view",T.Matrix,!0),this.registerOutput("diffuseOutput",T.Color3,w.Fragment),this.registerOutput("specularOutput",T.Color3,w.Fragment),this.registerOutput("shadow",T.Float,w.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.CameraPosition&&t(r));i||(i=new Be("cameraPosition"),i.setAsSystemValue(qe.CameraPosition)),i.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;let r=e.getScene();if(!this.light)co(r,e,i,!0,t.maxSimultaneousLights);else{let n={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};zf(r,e,this.light,this._lightId,i,!0,n),n.needRebuild&&i.rebuild()}}updateUniformsAndSamples(e,t,i,r){for(let n=0;n<t.maxSimultaneousLights&&i["LIGHT"+n];n++){let o=e.uniforms.indexOf("vLightData"+n)>=0;Hf(n,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+n],r,o)}}bind(e,t,i){if(!i)return;let r=i.getScene();this.light?Gf(this.light,this._lightId,r,e,!0):lo(r,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){let t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));let r="v_"+t.associatedVariableName;e._emitVaryingFromString(r,T.Vector4)&&(e.compilationString+=(e.shaderLanguage===pe.WGSL?"vertexOutputs.":"")+`${r} = ${t.associatedVariableName};
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",T.Vector4)} = ${t.associatedVariableName};
`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",T.Matrix)} = ${this.view.associatedVariableName};
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_injectUBODeclaration(e){let t=`//${this.name}`;this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0})}_buildBlock(e){super._buildBlock(e);let t=e.shaderLanguage===pe.WGSL,i=t?"f":"",r=`//${this.name}`;if(e.target!==w.Fragment){this._injectVertexCode(e);return}this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);let n=e.shaderLanguage===pe.WGSL?"fragmentInputs.":"";e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);let o=this.worldPosition,a=o.associatedVariableName;this.generateOnlyFragmentCode?(a=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`${e._declareLocalVar(a,T.Vector3)};
`,r),e.compilationString+=`${a} = ${o.associatedVariableName}.xyz;
`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${o.associatedVariableName}`:void 0})):a=n+"v_"+a+".xyz",e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("lightsFragmentFunctions",r,{replaceStrings:[{search:/vPositionW/g,replace:a}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",r,{replaceStrings:[{search:/vPositionW/g,replace:a}]}),this._injectUBODeclaration(e),this._lightId===0&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",T.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${a});
`),e.compilationString+=t?`var info: lightingInfo;
`:`lightingInfo info;
`,e.compilationString+=`${e._declareLocalVar("shadow",T.Float)} = 1.;
`,e.compilationString+=`${e._declareLocalVar("aggShadow",T.Float)} = 0.;
`,e.compilationString+=`${e._declareLocalVar("numLights",T.Float)} = 0.;
`,e.compilationString+=`${e._declareLocalVar("glossiness",T.Float)} = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};
`,e.compilationString+=`${e._declareLocalVar("diffuseBase",T.Vector3)} = vec3${i}(0., 0., 0.);
`,e.compilationString+=`${e._declareLocalVar("specularBase",T.Vector3)}  = vec3${i}(0., 0., 0.);
`,e.compilationString+=`${e._declareLocalVar("normalW",T.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;
`),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/vPositionW/g,replace:a+".xyz"}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{repeatKey:"maxSimultaneousLights",substitutionVars:`vPositionW,${a}.xyz`}),this._lightId===0&&(e.compilationString+=`aggShadow = aggShadow / numLights;
`);let l=this.diffuseOutput,c=this.specularOutput;return e.compilationString+=e._declareOutput(l)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};
`,c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};
`),this.shadow.hasEndpoints&&(e.compilationString+=e._declareOutput(this.shadow)+` = aggShadow;
`),this}serialize(){let e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}};v([de("Generate only fragment code",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Bm._OnGenerateOnlyFragmentCodeChanged}})],Bm.prototype,"generateOnlyFragmentCode",void 0);P("BABYLON.LightBlock",Bm);var Us=class s extends Z{get texture(){return this._texture}set texture(e){if(this._texture===e)return;let t=e?.getScene()??me.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}get samplerName(){return this._samplerName}constructor(e){super(e,w.VertexAndFragment),this.registerOutput("source",T.Object,w.VertexAndFragment,new Dt("source",this,xt.Output,s,"ImageSourceBlock"))}bind(e){this.texture&&e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.target===w.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e}serialize(){let e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,r){super._deserialize(e,t,i,r),e.texture&&!$i.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(e.texture.url.indexOf("data:")===0?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url),this.texture=z.Parse(e.texture,t,i))}};P("BABYLON.ImageSourceBlock",Us);var lR=class s extends Z{get texture(){return this.source.isConnected?(this.source.connectedPoint?.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;let t=e?.getScene()??me.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}static _IsPrePassTextureBlock(e){return e?.getClassName()==="PrePassTextureBlock"}get _isSourcePrePass(){return s._IsPrePassTextureBlock(this._imageSource)}get samplerName(){if(this._imageSource){if(!s._IsPrePassTextureBlock(this._imageSource))return this._imageSource.samplerName;if(this.source.connectedPoint)return this._imageSource.getSamplerName(this.source.connectedPoint)}return this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture&&(this.texture.getScene()??me.LastCreatedScene)?.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture)))}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture&&(this.texture.getScene()??me.LastCreatedScene)?.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture)))}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?w.Fragment:w.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",T.AutoDetect,!1,w.VertexAndFragment),this.registerInput("source",T.Object,!0,w.VertexAndFragment,new Dt("source",this,xt.Input,Us,"ImageSourceBlock")),this.registerInput("layer",T.Float,!0),this.registerInput("lod",T.Float,!0),this.registerOutput("rgba",T.Color4,w.Neutral),this.registerOutput("rgb",T.Color3,w.Neutral),this.registerOutput("r",T.Float,w.Neutral),this.registerOutput("g",T.Float,w.Neutral),this.registerOutput("b",T.Float,w.Neutral),this.registerOutput("a",T.Float,w.Neutral),this.registerOutput("level",T.Float,w.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Vector2|T.Vector3|T.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get lod(){return this._inputs[3]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}get target(){if(this._fragmentOnly)return w.Fragment;if(!this.uv.isConnected)return w.VertexAndFragment;if(this.uv.sourceBlock.isInput)return w.VertexAndFragment;let e=this.uv.connectedPoint;for(;e;){if(e.target===w.Fragment)return w.Fragment;if(e.target===w.Vertex)return w.VertexAndFragment;if(e.target===w.Neutral||e.target===w.VertexAndFragment){let t=e.ownerBlock;if(t.target===w.Fragment)return w.Fragment;e=null;for(let i of t.inputs)if(i.connectedPoint){e=i.connectedPoint;break}}}return w.VertexAndFragment}set target(e){}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected)if(e.mode===ns.PostProcess){let i=e.getBlockByPredicate(r=>r.name==="uv"&&t(r));i&&i.connectTo(this)}else{let i=e.mode===ns.Particle?"particle_uv":"uv",r=e.getInputBlockByPredicate(n=>n.isAttribute&&n.name===i&&t(n));r||(r=new Be("uv"),r.setAsAttribute(i)),r.output.connectTo(this.uv)}}initializeDefines(e,t,i){i._areTexturesDirty&&this._mainUVDefineName!==void 0&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix){this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0));return}let r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,n=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,n,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),i[this._mainUVDefineName]==null&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return this._isSourcePrePass?!0:!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this._isSourcePrePass&&e.setFloat(this._textureInfoName,1),this.texture&&(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==w.Fragment}_injectVertexCode(e){let t=this.uv;this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.declarationVariableName.toUpperCase(),this._mainUVName="vMain"+t.declarationVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,T.Vector2,this._defineName),e._emitVaryingFromString(this._mainUVName,T.Vector2,this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,T.Matrix,this._defineName);let i=e._getShaderType(T.Vector4),r=e._getShaderType(T.Vector2);if(e.compilationString+=`#ifdef ${this._defineName}
`,e.compilationString+=`${e._getVaryingName(this._transformedUVName)} = ${r}(${this._textureTransformName} * ${i}(${t.associatedVariableName}.xy, 1.0, 0.0));
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})
`,e.compilationString+=`${e._getVaryingName(this._mainUVName)} = ${t.associatedVariableName}.xy;
`,e.compilationString+=`#endif
`,!!this._outputs.some(n=>n.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(let n of this._outputs)n.hasEndpoints&&n.name!=="level"&&this._writeOutput(e,n,n.name,!0)}}_getUVW(e){let t=e,i=this._texture?._texture?.is2DArray??!1,r=this._texture?._texture?.is3D??!1;if(i){let n=this.layer.isConnected?this.layer.associatedVariableName:"0";t=`vec3(${e}, ${n})`}else if(r){let n=this.layer.isConnected?this.layer.associatedVariableName:"0";t=`vec3(${e}, ${n})`}return t}_samplerFunc(e){return e.shaderLanguage===pe.WGSL?e.target===w.Vertex?"textureSampleLevel":"textureSample":this.lod.isConnected?"texture2DLodEXT":"texture2D"}get _samplerLodSuffix(){return this.lod.isConnected?`, ${this.lod.associatedVariableName}`:""}_generateTextureSample(e,t){if(t.shaderLanguage===pe.WGSL){let i=t.target===w.Vertex;return`${this._samplerFunc(t)}(${this.samplerName},${this.samplerName+"Sampler"}, ${this._getUVW(e)}${this._samplerLodSuffix}${i?", 0":""})`}return`${this._samplerFunc(t)}(${this.samplerName}, ${this._getUVW(e)}${this._samplerLodSuffix})`}_generateTextureLookup(e){e.compilationString+=`#ifdef ${this._defineName}
`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,T.Vector4)} = ${this._generateTextureSample(e._getVaryingName(this._transformedUVName),e)};
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})
`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,T.Vector4)} = ${this._generateTextureSample(this._mainUVName?e._getVaryingName(this._mainUVName):this.uv.associatedVariableName,e)}${this._samplerLodSuffix};
`,e.compilationString+=`#endif
`}_writeTextureRead(e,t=!1){let i=this.uv;if(t){if(e.target===w.Fragment)return;this._generateTextureLookup(e);return}if(this.uv.ownerBlock.target===w.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,T.Vector4)} = ${this._generateTextureSample(i.associatedVariableName,e)}${this._samplerLodSuffix};
`;return}this._generateTextureLookup(e)}_generateConversionCode(e,t,i){i!=="a"&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
                #endif
            `)}_writeOutput(e,t,i,r=!1){if(r){if(e.target===w.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,this._generateConversionCode(e,t,i);return}if(this.uv.ownerBlock.target===w.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,this._generateConversionCode(e,t,i);return}let n="";this.disableLevelMultiplication||(n=` * ${(e.shaderLanguage===pe.WGSL?"uniforms.":"")+this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${n};
`,this._generateConversionCode(e,t,i)}_buildBlock(e){if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===w.Vertex||this._fragmentOnly||e.target===w.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),!this._isMixed&&e.target===w.Fragment||this._isMixed&&e.target===w.Vertex){if(!this._imageSource){let i=e._getFreeVariableName(this.name);this._samplerName=i+"Texture",this._texture?._texture?.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)}e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)}if(e.target!==w.Fragment){this._injectVertexCode(e);return}if(!this._outputs.some(i=>i.isConnectedInFragmentShader))return;this._isMixed&&!this._imageSource&&(this._texture?._texture?.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName));let t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._isMixed&&e._emitUniformFromString(this._textureInfoName,T.Float),this._writeTextureRead(e);for(let i of this._outputs)i.hasEndpoints&&i.name!=="level"&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};
`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,r){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!$i.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(e.texture.url.indexOf("data:")===0?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url),this.texture=z.Parse(e.texture,t,i))}};P("BABYLON.TextureBlock",lR);var ll=class extends Z{get texture(){return this._texture}set texture(e){if(this._texture===e)return;let t=e?.getScene()??me.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?w.Fragment:w.VertexAndFragment)}constructor(e){super(e,w.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate(r=>r.isAttribute&&r.name==="position"&&t(r));i||(i=new Be("position"),i.setAsAttribute()),i.output.connectTo(this.position)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.World&&t(r));i||(i=new Be("world"),i.setAsSystemValue(qe.World)),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.View&&t(r));i||(i=new Be("view"),i.setAsSystemValue(qe.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;let r=this._getTexture();!r||!r.getTextureMatrix||(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLocalCubicName,!!r.boundingBoxSize,!0),i.setValue(this._defineExplicitName,r.coordinatesMode===0,!0),i.setValue(this._defineSkyboxName,r.coordinatesMode===5,!0),i.setValue(this._defineCubicName,r.coordinatesMode===3||r.coordinatesMode===6,!0),i.setValue("INVERTCUBICMAP",r.coordinatesMode===6,!0),i.setValue(this._defineSphericalName,r.coordinatesMode===1,!0),i.setValue(this._definePlanarName,r.coordinatesMode===2,!0),i.setValue(this._defineProjectionName,r.coordinatesMode===4,!0),i.setValue(this._defineEquirectangularName,r.coordinatesMode===7,!0),i.setValue(this._defineEquirectangularFixedName,r.coordinatesMode===8,!0),i.setValue(this._defineMirroredEquirectangularFixedName,r.coordinatesMode===9,!0))}isReady(){let e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i,r){let n=this._getTexture();if(!(!i||!n)&&(e.setMatrix(this._reflectionMatrixName,n.getReflectionTextureMatrix()),n.isCube?e.setTexture(this._cubeSamplerName,n):e.setTexture(this._2DSamplerName,n),n.boundingBoxSize)){let o=n;e.setVector3(this._reflectionPositionName,o.boundingBoxPosition),e.setVector3(this._reflectionSizeName,o.boundingBoxSize)}}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===w.Vertex)return"";this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,T.Matrix);let t="",i=e.shaderLanguage===pe.WGSL;this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");let r=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(r,T.Vector4))&&(this.generateOnlyFragmentCode?t+=`${e._declareLocalVar(r,T.Vector4)} = ${this.worldPosition.associatedVariableName};
`:t+=`${i?"vertexOutputs.":""}${r} = ${this.worldPosition.associatedVariableName};
`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,T.Vector3,this._defineSkyboxName))&&(t+=`#ifdef ${this._defineSkyboxName}
`,this.generateOnlyFragmentCode?t+=`${e._declareLocalVar(this._positionUVWName,T.Vector3)} = ${this.position.associatedVariableName}.xyz;
`:t+=`${i?"vertexOutputs.":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;
`,t+=`#endif
`),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWName,T.Vector3,`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(t+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})
`,this.generateOnlyFragmentCode?t+=`${e._declareLocalVar(this._directionWName,T.Vector3)} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));
`:t+=`${i?"vertexOutputs.":""}${this._directionWName} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));
`,t+=`#endif
`),t}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}
`,e._emitCubeSampler(this._cubeSamplerName,"",!0),e._samplerDeclaration+=`#else
`,e._emit2DSampler(this._2DSamplerName,"",!0),e._samplerDeclaration+=`#endif
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"},{search:/fn computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,T.Vector3),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,T.Vector3)}handleFragmentSideCodeReflectionCoords(e,t,i,r=!1,n=!1){i||(i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`v_${this.worldPosition.associatedVariableName}`);let o=this._reflectionMatrixName,a=`normalize(${this._directionWName})`,l=`${this._positionUVWName}`,c=`${this.cameraPosition.associatedVariableName}`,h=`${this.view.associatedVariableName}`;t+=".xyz",e.shaderLanguage===pe.WGSL&&!this.generateOnlyFragmentCode&&(i="fragmentInputs."+i,o="uniforms."+o);let u=`
            #ifdef ${this._defineMirroredEquirectangularFixedName}
               ${e._declareLocalVar(this._reflectionVectorName,T.Vector3)} = computeMirroredFixedEquirectangularCoords(${i}, ${t}, ${a});
            #endif

            #ifdef ${this._defineEquirectangularFixedName}
                ${e._declareLocalVar(this._reflectionVectorName,T.Vector3)} = computeFixedEquirectangularCoords(${i}, ${t}, ${a});
            #endif

            #ifdef ${this._defineEquirectangularName}
                ${e._declareLocalVar(this._reflectionVectorName,T.Vector3)} = computeEquirectangularCoords(${i}, ${t}, ${c}.xyz, ${o});
            #endif

            #ifdef ${this._defineSphericalName}
                ${e._declareLocalVar(this._reflectionVectorName,T.Vector3)} = computeSphericalCoords(${i}, ${t}, ${h}, ${o});
            #endif

            #ifdef ${this._definePlanarName}
                ${e._declareLocalVar(this._reflectionVectorName,T.Vector3)} = computePlanarCoords(${i}, ${t}, ${c}.xyz, ${o});
            #endif

            #ifdef ${this._defineCubicName}
                #ifdef ${this._defineLocalCubicName}
                    ${e._declareLocalVar(this._reflectionVectorName,T.Vector3)} = computeCubicLocalCoords(${i}, ${t}, ${c}.xyz, ${o}, ${this._reflectionSizeName}, ${this._reflectionPositionName});
                #else
                ${e._declareLocalVar(this._reflectionVectorName,T.Vector3)} = computeCubicCoords(${i}, ${t}, ${c}.xyz, ${o});
                #endif
            #endif

            #ifdef ${this._defineProjectionName}
                ${e._declareLocalVar(this._reflectionVectorName,T.Vector3)} = computeProjectionCoords(${i}, ${h}, ${o});
            #endif

            #ifdef ${this._defineSkyboxName}
                ${e._declareLocalVar(this._reflectionVectorName,T.Vector3)} = computeSkyBoxCoords(${l}, ${o});
            #endif

            #ifdef ${this._defineExplicitName}
                ${e._declareLocalVar(this._reflectionVectorName,T.Vector3)} = vec3(0, 0, 0);
            #endif
`;return n||(u+=`#ifdef ${this._defineOppositeZ}
                ${this._reflectionVectorName}.z *= -1.0;
            #endif
`),r||(u+=`
                #ifdef ${this._define3DName}
                    ${e._declareLocalVar(this._reflectionCoordsName,T.Vector3)} = ${this._reflectionVectorName};
                #else
                    ${e._declareLocalVar(this._reflectionCoordsName,T.Vector2)} = ${this._reflectionVectorName}.xy;
                    #ifdef ${this._defineProjectionName}
                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;
                    #endif
                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;
                #endif
`),u}handleFragmentSideCodeReflectionColor(e,t,i=".rgb"){let r=T.Vector4;i.length===3&&(r=T.Vector3);let n=`${e._declareLocalVar(this._reflectionColorName,r)};
            #ifdef ${this._define3DName}
`;return t?n+=`${this._reflectionColorName} = ${e._generateTextureSampleCubeLOD(this._reflectionVectorName,this._cubeSamplerName,t)}${i};
`:n+=`${this._reflectionColorName} = ${e._generateTextureSampleCube(this._reflectionVectorName,this._cubeSamplerName)}${i};
`,n+=`
            #else
`,t?n+=`${this._reflectionColorName} =${e._generateTextureSampleLOD(this._reflectionCoordsName,this._2DSamplerName,t)}${i};
`:n+=`${this._reflectionColorName} = ${e._generateTextureSample(this._reflectionCoordsName,this._2DSamplerName)}${i};
`,n+=`#endif
`,n}writeOutputs(e,t){let i="";if(e.target===w.Fragment)for(let r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};
`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){let t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});
`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);
`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`,e}serialize(){let e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!$i.IgnoreTexturesAtLoadTime&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=Hi.Parse(e.texture,t,i):this.texture=z.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}};v([de("Generate only fragment code",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:ll._OnGenerateOnlyFragmentCodeChanged}})],ll.prototype,"generateOnlyFragmentCode",void 0);P("BABYLON.ReflectionTextureBaseBlock",ll);var cR=class extends ll{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,F.Error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,F.Error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?w.Fragment:w.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?w.Fragment:w.Vertex}constructor(e){super(e),this.registerInput("position",T.AutoDetect,!1,w.Vertex),this.registerInput("worldPosition",T.Vector4,!1,w.Vertex),this.registerInput("worldNormal",T.Vector4,!1,w.Fragment),this.registerInput("world",T.Matrix,!1,w.Vertex),this.registerInput("cameraPosition",T.Vector3,!1,w.Fragment),this.registerInput("view",T.Matrix,!1,w.Fragment),this.registerOutput("rgb",T.Color3,w.Fragment),this.registerOutput("rgba",T.Color4,w.Fragment),this.registerOutput("r",T.Float,w.Fragment),this.registerOutput("g",T.Float,w.Fragment),this.registerOutput("b",T.Float,w.Fragment),this.registerOutput("a",T.Float,w.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Vector3|T.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e,t=()=>!0){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.CameraPosition&&t(r));i||(i=new Be("cameraPosition"),i.setAsSystemValue(qe.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,`vec4${e.fSuffix}(0.)`),this;if(e.target!==w.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);let t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`${e._declareLocalVar(t,T.Vector4)} = normalize(${this.worldNormal.associatedVariableName});
`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(e,t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(e,void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}};P("BABYLON.ReflectionTextureBlock",cR);var Zd=class extends Z{constructor(e){super(e,w.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",T.AutoDetect,!1,w.VertexAndFragment),this.registerOutput("depth",T.Float,w.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Vector2|T.Vector3|T.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return this.uv.isConnected?this.uv.sourceBlock.isInput?w.VertexAndFragment:w.Fragment:w.VertexAndFragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){let i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){let t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,t.type===T.Vector3?T.Vector3:t.type===T.Vector4?T.Vector4:T.Vector2)),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,T.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(let i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,"r",!0)}}_writeTextureRead(e,t=!1){let i=this.uv;if(t){if(e.target===w.Fragment)return;let n=e.shaderLanguage===pe.GLSL?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,o=e.shaderLanguage===pe.GLSL?"":", 0";e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,T.Vector4)}=  ${n} ${i.associatedVariableName}.xy${o});
`;return}let r=e.shaderLanguage===pe.GLSL?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;if(this.uv.ownerBlock.target===w.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,T.Vector4)} = ${r} ${i.associatedVariableName}.xy);
`;return}e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,T.Vector4)} = ${r} ${this._mainUVName});
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===w.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}if(this.uv.ownerBlock.target===w.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==w.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(this._outputs.some(t=>t.isConnectedInFragmentShader)){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(let t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){let e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}};v([de("Use non linear depth",ue.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(s,e)=>{let t=e,i=!1;return t.useNonLinearDepth&&(t.storeCameraSpaceZ=!1,i=!0),s&&s.disableDepthRenderer(),i}}})],Zd.prototype,"useNonLinearDepth",void 0);v([de("Store Camera space Z",ue.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(s,e)=>{let t=e,i=!1;return t.storeCameraSpaceZ&&(t.useNonLinearDepth=!1,i=!0),s&&s.disableDepthRenderer(),i}}})],Zd.prototype,"storeCameraSpaceZ",void 0);v([de("Force 32 bits float",ue.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:s=>s?.disableDepthRenderer()}})],Zd.prototype,"force32itsFloat",void 0);P("BABYLON.SceneDepthBlock",Zd);var hR=class extends Z{constructor(e){super(e,w.VertexAndFragment,!0),this.registerInput("worldPosition",T.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6")}get worldPosition(){return this._inputs[0]}get target(){return w.VertexAndFragment}set target(e){}prepareDefines(e,t,i){let r=e.getScene(),n=!!(t.clipPlane??r.clipPlane),o=!!(t.clipPlane2??r.clipPlane2),a=!!(t.clipPlane3??r.clipPlane3),l=!!(t.clipPlane4??r.clipPlane4),c=!!(t.clipPlane5??r.clipPlane5),h=!!(t.clipPlane6??r.clipPlane6);i.setValue("CLIPPLANE",n,!0),i.setValue("CLIPPLANE2",o,!0),i.setValue("CLIPPLANE3",a,!0),i.setValue("CLIPPLANE4",l,!0),i.setValue("CLIPPLANE5",c,!0),i.setValue("CLIPPLANE6",h,!0)}bind(e,t,i){if(!i)return;let r=i.getScene();Yi(e,t,r)}_buildBlock(e){super._buildBlock(e);let t=`//${this.name}`;if(e.target!==w.Fragment){let i=this.worldPosition;e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane",T.Vector4),e._emitUniformFromString("vClipPlane2",T.Vector4),e._emitUniformFromString("vClipPlane3",T.Vector4),e._emitUniformFromString("vClipPlane4",T.Vector4),e._emitUniformFromString("vClipPlane5",T.Vector4),e._emitUniformFromString("vClipPlane6",T.Vector4);return}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}};P("BABYLON.ClipPlanesBlock",hR);var uR=class extends Z{get texture(){return null}set texture(e){}constructor(e,t=w.VertexAndFragment){super(e,t,!1),this.registerOutput("position",T.Object,w.VertexAndFragment,new Dt("position",this,xt.Output,Us,"ImageSourceBlock")),this.registerOutput("depth",T.Object,w.VertexAndFragment,new Dt("depth",this,xt.Output,Us,"ImageSourceBlock")),this.registerOutput("normal",T.Object,w.VertexAndFragment,new Dt("normal",this,xt.Output,Us,"ImageSourceBlock"))}getSamplerName(e){return e===this._outputs[0]?this._positionSamplerName:e===this._outputs[1]?this._depthSamplerName:e===this._outputs[2]?this._normalSamplerName:""}get position(){return this._outputs[0]}get depth(){return this._outputs[1]}get normal(){return this._outputs[2]}get positionSamplerName(){return this._positionSamplerName}get normalSamplerName(){return this._normalSamplerName}get depthSamplerName(){return this._depthSamplerName}getClassName(){return"PrePassTextureBlock"}_buildBlock(e){if(super._buildBlock(e),e.target!==w.Vertex)return this._positionSamplerName="prepassPositionSampler",this._depthSamplerName="prepassDepthSampler",this._normalSamplerName="prepassNormalSampler",e.sharedData.variableNames.prepassPositionSampler=0,e.sharedData.variableNames.prepassDepthSampler=0,e.sharedData.variableNames.prepassNormalSampler=0,e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this),e._emit2DSampler(this._positionSamplerName),e._emit2DSampler(this._depthSamplerName),e._emit2DSampler(this._normalSamplerName),this}bind(e,t){let r=t.getScene().enablePrePassRenderer();if(!r)return;let n=r.defaultRT;n.textures&&(this.position.isConnected&&e.setTexture(this._positionSamplerName,n.textures[r.getIndex(1)]),this.depth.isConnected&&e.setTexture(this._depthSamplerName,n.textures[r.getIndex(5)]),this.normal.isConnected&&e.setTexture(this._normalSamplerName,n.textures[r.getIndex(6)]))}};P("BABYLON.PrePassTextureBlock",uR);var dR=class extends Z{get endpoints(){return this._endpoints}get target(){let e=this._inputs[0];if(e.isConnected){let t=e.connectedPoint.ownerBlock;if(t.target!==w.VertexAndFragment)return t.target;if(e.connectedPoint.target!==w.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}constructor(e){super(e,w.Neutral),this._endpoints=[],this.registerInput("input",T.AutoDetect)}getClassName(){return"NodeMaterialTeleportInBlock"}get input(){return this._inputs[0]}isConnectedInFragmentShader(){return this.endpoints.some(e=>e.output.isConnectedInFragmentShader)}_dumpCode(e,t){let i=super._dumpCode(e,t);for(let r of this.endpoints)t.indexOf(r)===-1&&(i+=r._dumpCode(e,t));return i}isAnAncestorOf(e){for(let t of this.endpoints)if(t===e||t.isAnAncestorOf(e))return!0;return!1}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){let t=this._endpoints.indexOf(e);t!==-1&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}dispose(){super.dispose();for(let e of this._endpoints)this.detachFromEndpoint(e);this._endpoints=[]}};P("BABYLON.NodeMaterialTeleportInBlock",dR);var fR=class extends Z{constructor(e){super(e,w.Neutral),this._entryPoint=null,this._tempEntryPointUniqueId=null,this.registerOutput("output",T.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeMaterialTeleportOutBlock"}get output(){return this._outputs[0]}get target(){return this._entryPoint?this._entryPoint.target:this._target}set target(e){this._target&e||(this._target=e)}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(e){super._buildBlock(e),this.entryPoint&&(e.compilationString+=e._declareOutput(this.output)+` = ${this.entryPoint.input.associatedVariableName};
`)}clone(e,t=""){let i=super.clone(e,t);return this.entryPoint&&this.entryPoint.attachToEndpoint(i),i}_customBuildStep(e,t){this.entryPoint&&this.entryPoint.build(e,t)}_dumpCode(e,t){let i="";return this.entryPoint&&t.indexOf(this.entryPoint)===-1&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});
`),e}serialize(){let e=super.serialize();return e.entryPoint=this.entryPoint?.uniqueId??"",e}_deserialize(e,t,i){super._deserialize(e,t,i),this._tempEntryPointUniqueId=e.entryPoint}};P("BABYLON.NodeMaterialTeleportOutBlock",fR);var pR=class extends ra{constructor(e){super(e)}getClassName(){return"AddBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};
`,this}};P("BABYLON.AddBlock",pR);var mR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("input",T.AutoDetect),this.registerInput("factor",T.Float),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};
`,this}};P("BABYLON.ScaleBlock",mR);var Vm=class extends Z{constructor(e){super(e,w.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=e.shaderLanguage===pe.WGSL?e._getShaderType(this.value.type):"";return e.compilationString+=e._declareOutput(t)+` = clamp(${this.value.associatedVariableName}, ${i}(${this._writeFloat(this.minimum)}), ${i}(${this._writeFloat(this.maximum)}));
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};
`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};
`,e}serialize(){let e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}};v([de("Minimum",ue.Float)],Vm.prototype,"minimum",void 0);v([de("Maximum",ue.Float)],Vm.prototype,"maximum",void 0);P("BABYLON.ClampBlock",Vm);var gR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("left",T.AutoDetect),this.registerInput("right",T.AutoDetect),this.registerOutput("output",T.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(T.Float),this._inputs[0].excludedConnectionPointTypes.push(T.Matrix),this._inputs[0].excludedConnectionPointTypes.push(T.Vector2),this._inputs[1].excludedConnectionPointTypes.push(T.Float),this._inputs[1].excludedConnectionPointTypes.push(T.Matrix),this._inputs[1].excludedConnectionPointTypes.push(T.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);
`,this}};P("BABYLON.CrossBlock",gR);var _R=class extends Z{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach(n=>{let o=new RegExp("\\{TYPE_"+n.name+"\\}","gm"),a=e._getGLType(n.type);t=t.replace(o,a),i=i.replace(o,a)}),this._outputs.forEach(n=>{let o=new RegExp("\\{TYPE_"+n.name+"\\}","gm"),a=e._getGLType(n.type);t=t.replace(o,a),i=i.replace(o,a)}),e._emitFunction(i,t,""),this._outputs.forEach(n=>{e.compilationString+=e._declareOutput(n)+`;
`}),e.compilationString+=i+"(";let r=!1;return this._inputs.forEach((n,o)=>{o>0&&(e.compilationString+=", "),this._inputSamplers&&this._inputSamplers.indexOf(n.name)!==-1?e.compilationString+=n.connectedPoint?.ownerBlock?.samplerName??n.associatedVariableName:e.compilationString+=n.associatedVariableName,r=!0}),this._outputs.forEach((n,o)=>{(o>0||r)&&(e.compilationString+=", "),e.compilationString+=n.associatedVariableName}),e.compilationString+=`);
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};
`,e}serialize(){let e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){this._options=e,this._code=e.code.join(`
`)+`
`,this.name=this.name||e.name,this.target=w[e.target],e.inParameters?.forEach((t,i)=>{let r=T[t.type];t.type==="sampler2D"||t.type==="samplerCube"?(this._inputSamplers=this._inputSamplers||[],this._inputSamplers.push(t.name),this.registerInput(t.name,T.Object,!0,w.VertexAndFragment,new Dt(t.name,this,xt.Input,Us,"ImageSourceBlock"))):this.registerInput(t.name,r),Object.defineProperty(this,t.name,{get:function(){return this._inputs[i]},enumerable:!0,configurable:!0})}),e.outParameters?.forEach((t,i)=>{this.registerOutput(t.name,T[t.type]),Object.defineProperty(this,t.name,{get:function(){return this._outputs[i]},enumerable:!0,configurable:!0}),t.type==="BasedOnInput"&&(this._outputs[i]._typeConnectionSource=this._findInputByName(t.typeFromInput)[0])}),e.inLinkedConnectionTypes?.forEach(t=>{this._linkConnectionTypes(this._findInputByName(t.input1)[1],this._findInputByName(t.input2)[1])})}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}};P("BABYLON.CustomBlock",_R);var xR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("left",T.AutoDetect),this.registerInput("right",T.AutoDetect),this.registerOutput("output",T.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(T.Float),this._inputs[0].excludedConnectionPointTypes.push(T.Matrix),this._inputs[1].excludedConnectionPointTypes.push(T.Float),this._inputs[1].excludedConnectionPointTypes.push(T.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}};P("BABYLON.DotBlock",xR);var vR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("input",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(T.Float),this._inputs[0].excludedConnectionPointTypes.push(T.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${i.associatedVariableName});
`,this}};P("BABYLON.NormalizeBlock",vR);var TR=class extends Z{constructor(e){super(e,w.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",T.Color3,!0),this.registerInput("r",T.Float,!0),this.registerInput("g",T.Float,!0),this.registerInput("b",T.Float,!0),this.registerInput("a",T.Float,!0),this.registerOutput("rgba",T.Color4),this.registerOutput("rgb",T.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return e==="rgb "?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substr(0,e)}_buildBlock(e){super._buildBlock(e);let t=this.r,i=this.g,r=this.b,n=this.a,o=this.rgbIn,a=this._outputs[0],l=this._outputs[1],c=e._getShaderType(T.Vector4),h=e._getShaderType(T.Vector3);return o.isConnected?(a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${c}(${o.associatedVariableName}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${o.associatedVariableName}${this._buildSwizzle(3)};
`)):(a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${c}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${n.isConnected?this._writeVariable(n):"0.0"})${this._buildSwizzle(4)};
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${h}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`)),this}serialize(){let e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.rSwizzle=e.rSwizzle??"r",this.gSwizzle=e.gSwizzle??"g",this.bSwizzle=e.bSwizzle??"b",this.aSwizzle=e.aSwizzle??"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";
`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";
`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";
`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";
`,e}};P("BABYLON.ColorMergerBlock",TR);var CR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("xyzw",T.Vector4,!0),this.registerInput("xyz ",T.Vector3,!0),this.registerInput("xy ",T.Vector2,!0),this.registerOutput("xyz",T.Vector3),this.registerOutput("xy",T.Vector2),this.registerOutput("zw",T.Vector2),this.registerOutput("x",T.Float),this.registerOutput("y",T.Float),this.registerOutput("z",T.Float),this.registerOutput("w",T.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);let t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],r=this._outputs[1],n=this._outputs[2],o=this._outputs[3],a=this._outputs[4],l=this._outputs[5],c=this._outputs[6],h=e._getShaderType(T.Vector3);return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=e._declareOutput(i)+` = ${h}(${t.associatedVariableName}, 0.0);
`:e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.xyz;
`),n.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=e._declareOutput(n)+` = ${this.xyzw.associatedVariableName}.zw;
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.xy;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.x;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.y;
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${t.associatedVariableName}.z;
`),c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${t.associatedVariableName}.w;
`),this}};P("BABYLON.VectorSplitterBlock",CR);var bR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("left",T.AutoDetect),this.registerInput("right",T.AutoDetect),this.registerInput("gradient",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(T.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});
`,this}};P("BABYLON.LerpBlock",bR);var SR=class extends ra{constructor(e){super(e)}getClassName(){return"DivideBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};
`,this}};P("BABYLON.DivideBlock",SR);var yR=class extends ra{constructor(e){super(e)}getClassName(){return"SubtractBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};
`,this}};P("BABYLON.SubtractBlock",yR);var ER=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("value",T.Float),this.registerInput("edge",T.Float),this.registerOutput("output",T.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});
`,this}};P("BABYLON.StepBlock",ER);var HT=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("input",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(T.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = 1. - ${this.input.associatedVariableName};
`,this}};P("BABYLON.OneMinusBlock",HT);P("BABYLON.OppositeBlock",HT);var Um=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("worldPosition",T.Vector4),this.registerInput("cameraPosition",T.Vector3),this.registerOutput("output",T.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.CameraPosition&&t(r));i||(i=new Be("cameraPosition"),i.setAsSystemValue(qe.CameraPosition)),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);
`,this}};P("BABYLON.ViewDirectionBlock",Um);var AR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("worldNormal",T.Vector4),this.registerInput("viewDirection",T.Vector3),this.registerInput("bias",T.Float),this.registerInput("power",T.Float),this.registerOutput("fresnel",T.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){let t=new Um("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){let t=new Be("bias");t.value=0,t.output.connectTo(this.bias)}if(!this.power.isConnected){let t=new Be("power");t.value=1,t.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);let t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=e._declareOutput(this.fresnel)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});
`,this}};P("BABYLON.FresnelBlock",AR);var IR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("left",T.AutoDetect),this.registerInput("right",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}};P("BABYLON.MaxBlock",IR);var RR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("left",T.AutoDetect),this.registerInput("right",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}};P("BABYLON.MinBlock",RR);var PR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("left",T.AutoDetect),this.registerInput("right",T.AutoDetect),this.registerOutput("output",T.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(T.Float),this._inputs[0].excludedConnectionPointTypes.push(T.Matrix),this._inputs[1].excludedConnectionPointTypes.push(T.Float),this._inputs[1].excludedConnectionPointTypes.push(T.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});
`,this}};P("BABYLON.DistanceBlock",PR);var MR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("value",T.AutoDetect),this.registerOutput("output",T.Float),this._inputs[0].excludedConnectionPointTypes.push(T.Float),this._inputs[0].excludedConnectionPointTypes.push(T.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.value.associatedVariableName});
`,this}};P("BABYLON.LengthBlock",MR);var DR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("value",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = -1.0 * ${this.value.associatedVariableName};
`,this}};P("BABYLON.NegateBlock",DR);var OR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("value",T.AutoDetect),this.registerInput("power",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = pow(${this.value.associatedVariableName}, ${this.power.associatedVariableName});
`,this}};P("BABYLON.PowBlock",OR);var wR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("seed",T.AutoDetect),this.registerOutput("output",T.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Vector2|T.Vector3|T.Vector4|T.Color3|T.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=e._declareOutput(t)+` = getRand(${this.seed.associatedVariableName}.xy);
`,this}};P("BABYLON.RandomNumberBlock",wR);var NR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("x",T.Float),this.registerInput("y",T.Float),this.registerOutput("output",T.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=e.shaderLanguage===pe.WGSL?"atan2":"atan";return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.x.associatedVariableName}, ${this.y.associatedVariableName});
`,this}};P("BABYLON.ArcTan2Block",NR);var FR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("value",T.AutoDetect),this.registerInput("edge0",T.Float),this.registerInput("edge1",T.Float),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=e._getShaderType(this.value.type);return e.compilationString+=e._declareOutput(t)+` = smoothstep(${i}(${this.edge0.associatedVariableName}), ${i}(${this.edge1.associatedVariableName}), ${this.value.associatedVariableName});
`,this}};P("BABYLON.SmoothStepBlock",FR);var LR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("input",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return this.input.type===T.Matrix?e.compilationString+=e._declareOutput(t)+` = inverse(${this.input.associatedVariableName});
`:e.compilationString+=e._declareOutput(t)+` = 1. / ${this.input.associatedVariableName};
`,this}};P("BABYLON.ReciprocalBlock",LR);var BR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("value",T.AutoDetect),this.registerInput("reference",T.AutoDetect),this.registerInput("distance",T.Float),this.registerInput("replacement",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(T.Float),this._inputs[0].excludedConnectionPointTypes.push(T.Matrix),this._inputs[1].excludedConnectionPointTypes.push(T.Float),this._inputs[1].excludedConnectionPointTypes.push(T.Matrix),this._inputs[3].excludedConnectionPointTypes.push(T.Float),this._inputs[3].excludedConnectionPointTypes.push(T.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+`;
`,e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {
`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};
`,e.compilationString+=`} else {
`,e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};
`,e.compilationString+=`}
`,this}};P("BABYLON.ReplaceColorBlock",BR);var VR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("value",T.AutoDetect),this.registerInput("steps",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(T.Matrix),this._inputs[1].excludedConnectionPointTypes.push(T.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(T.Float)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});
`,this}};P("BABYLON.PosterizeBlock",VR);var km=function(s){return s[s.SawTooth=0]="SawTooth",s[s.Square=1]="Square",s[s.Triangle=2]="Triangle",s}(km||{}),UR=class extends Z{constructor(e){super(e,w.Neutral),this.kind=km.SawTooth,this.registerInput("input",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(T.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];switch(this.kind){case km.SawTooth:{e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});
`;break}case km.Square:{e.compilationString+=e._declareOutput(t)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));
`;break}case km.Triangle:{e.compilationString+=e._declareOutput(t)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;
`;break}}return this}serialize(){let e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}};P("BABYLON.WaveBlock",UR);var Gm=class{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}},kR=class extends Z{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,w.Neutral),this.colorSteps=[new Gm(0,X.Black()),new Gm(1,X.White())],this.onValueChangedObservable=new U,this.registerInput("gradient",T.AutoDetect),this.registerOutput("output",T.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Float|T.Vector2|T.Vector3|T.Vector4|T.Color3|T.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e,t){let i=this.colorSteps[e];return`${t}(${i.color.r}, ${i.color.g}, ${i.color.b})`}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=e._getShaderType(T.Vector3);if(!this.colorSteps.length||!this.gradient.connectedPoint){e.compilationString+=e._declareOutput(t)+` = ${i}(0., 0., 0.);
`;return}let r=e._getFreeVariableName("gradientTempColor"),n=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`${e._declareLocalVar(r,T.Vector3)} = ${this._writeColorConstant(0,i)};
`,e.compilationString+=`${e._declareLocalVar(n,T.Float)};
`;let o=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==T.Float&&(o+=".x");for(let a=1;a<this.colorSteps.length;a++){let l=this.colorSteps[a],c=this.colorSteps[a-1];e.compilationString+=`${n} = clamp((${o} - ${e._emitFloat(c.step)}) / (${e._emitFloat(l.step)} -  ${e._emitFloat(c.step)}), 0.0, 1.0) * step(${e._emitFloat(a)}, ${e._emitFloat(this.colorSteps.length-1)});
`,e.compilationString+=`${r} = mix(${r}, ${this._writeColorConstant(a,i)}, ${n});
`}return e.compilationString+=e._declareOutput(t)+` = ${r};
`,this}serialize(){let e=super.serialize();e.colorSteps=[];for(let t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(let r of e.colorSteps)this.colorSteps.push(new Gm(r.step,new X(r.color.r,r.color.g,r.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];
`;for(let t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));
`;return e}};P("BABYLON.GradientBlock",kR);var GR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("left",T.AutoDetect),this.registerInput("right",T.AutoDetect),this.registerInput("gradient",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(T.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));
`,this}};P("BABYLON.NLerpBlock",GR);var XT=class extends Z{constructor(e){super(e,w.Neutral),this.manhattanDistance=!1,this.registerInput("seed",T.Vector3),this.registerInput("jitter",T.Float),this.registerOutput("output",T.Vector2),this.registerOutput("x",T.Float),this.registerOutput("y",T.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t=`vec3 permute(vec3 x){
`;t+=`    return mod((34.0 * x + 1.0) * x, 289.0);
`,t+=`}

`,t+=`vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){
`,t+=`    return [manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z)];
`,t+=`}

`,t+=`vec2 worley(vec3 P, float jitter, bool manhattanDistance){
`,t+=`    float K = 0.142857142857; // 1/7
`,t+=`    float Ko = 0.428571428571; // 1/2-K/2
`,t+=`    float  K2 = 0.020408163265306; // 1/(7*7)
`,t+=`    float Kz = 0.166666666667; // 1/6
`,t+=`    float Kzo = 0.416666666667; // 1/2-1/6*2
`,t+=`
`,t+=`    vec3 Pi = mod(floor(P), 289.0);
`,t+=`    vec3 Pf = fract(P) - 0.5;
`,t+=`
`,t+=`    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);
`,t+=`    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);
`,t+=`    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);
`,t+=`
`,t+=`    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));
`,t+=`    vec3 p1 = permute(p + Pi.y - 1.0);
`,t+=`    vec3 p2 = permute(p + Pi.y);
`,t+=`    vec3 p3 = permute(p + Pi.y + 1.0);
`,t+=`
`,t+=`    vec3 p11 = permute(p1 + Pi.z - 1.0);
`,t+=`    vec3 p12 = permute(p1 + Pi.z);
`,t+=`    vec3 p13 = permute(p1 + Pi.z + 1.0);
`,t+=`
`,t+=`    vec3 p21 = permute(p2 + Pi.z - 1.0);
`,t+=`    vec3 p22 = permute(p2 + Pi.z);
`,t+=`    vec3 p23 = permute(p2 + Pi.z + 1.0);
`,t+=`
`,t+=`    vec3 p31 = permute(p3 + Pi.z - 1.0);
`,t+=`    vec3 p32 = permute(p3 + Pi.z);
`,t+=`    vec3 p33 = permute(p3 + Pi.z + 1.0);
`,t+=`
`,t+=`    vec3 ox11 = fract(p11*K) - Ko;
`,t+=`    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;
`,t+=`    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed
`,t+=`
`,t+=`    vec3 ox12 = fract(p12*K) - Ko;
`,t+=`    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;
`,t+=`    vec3 oz12 = floor(p12*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox13 = fract(p13*K) - Ko;
`,t+=`    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;
`,t+=`    vec3 oz13 = floor(p13*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox21 = fract(p21*K) - Ko;
`,t+=`    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;
`,t+=`    vec3 oz21 = floor(p21*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox22 = fract(p22*K) - Ko;
`,t+=`    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;
`,t+=`    vec3 oz22 = floor(p22*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox23 = fract(p23*K) - Ko;
`,t+=`    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;
`,t+=`    vec3 oz23 = floor(p23*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox31 = fract(p31*K) - Ko;
`,t+=`    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;
`,t+=`    vec3 oz31 = floor(p31*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox32 = fract(p32*K) - Ko;
`,t+=`    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;
`,t+=`    vec3 oz32 = floor(p32*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 ox33 = fract(p33*K) - Ko;
`,t+=`    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;
`,t+=`    vec3 oz33 = floor(p33*K2)*Kz - Kzo;
`,t+=`
`,t+=`    vec3 dx11 = Pfx + jitter*ox11;
`,t+=`    vec3 dy11 = Pfy.x + jitter*oy11;
`,t+=`    vec3 dz11 = Pfz.x + jitter*oz11;
`,t+=`
`,t+=`    vec3 dx12 = Pfx + jitter*ox12;
`,t+=`    vec3 dy12 = Pfy.x + jitter*oy12;
`,t+=`    vec3 dz12 = Pfz.y + jitter*oz12;
`,t+=`
`,t+=`    vec3 dx13 = Pfx + jitter*ox13;
`,t+=`    vec3 dy13 = Pfy.x + jitter*oy13;
`,t+=`    vec3 dz13 = Pfz.z + jitter*oz13;
`,t+=`
`,t+=`    vec3 dx21 = Pfx + jitter*ox21;
`,t+=`    vec3 dy21 = Pfy.y + jitter*oy21;
`,t+=`    vec3 dz21 = Pfz.x + jitter*oz21;
`,t+=`
`,t+=`    vec3 dx22 = Pfx + jitter*ox22;
`,t+=`    vec3 dy22 = Pfy.y + jitter*oy22;
`,t+=`    vec3 dz22 = Pfz.y + jitter*oz22;
`,t+=`
`,t+=`    vec3 dx23 = Pfx + jitter*ox23;
`,t+=`    vec3 dy23 = Pfy.y + jitter*oy23;
`,t+=`    vec3 dz23 = Pfz.z + jitter*oz23;
`,t+=`
`,t+=`    vec3 dx31 = Pfx + jitter*ox31;
`,t+=`    vec3 dy31 = Pfy.z + jitter*oy31;
`,t+=`    vec3 dz31 = Pfz.x + jitter*oz31;
`,t+=`
`,t+=`    vec3 dx32 = Pfx + jitter*ox32;
`,t+=`    vec3 dy32 = Pfy.z + jitter*oy32;
`,t+=`    vec3 dz32 = Pfz.y + jitter*oz32;
`,t+=`
`,t+=`    vec3 dx33 = Pfx + jitter*ox33;
`,t+=`    vec3 dy33 = Pfy.z + jitter*oy33;
`,t+=`    vec3 dz33 = Pfz.z + jitter*oz33;
`,t+=`
`,t+=`    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);
`,t+=`    vec3 d12 = dist(dx12, dy12, dz12, manhattanDistance);
`,t+=`    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);
`,t+=`    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);
`,t+=`    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);
`,t+=`    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);
`,t+=`    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);
`,t+=`    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);
`,t+=`    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);
`,t+=`
`,t+=`    vec3 d1a = min(d11, d12);
`,t+=`    d12 = max(d11, d12);
`,t+=`    d11 = min(d1a, d13); // Smallest now not in d12 or d13
`,t+=`    d13 = max(d1a, d13);
`,t+=`    d12 = min(d12, d13); // 2nd smallest now not in d13
`,t+=`    vec3 d2a = min(d21, d22);
`,t+=`    d22 = max(d21, d22);
`,t+=`    d21 = min(d2a, d23); // Smallest now not in d22 or d23
`,t+=`    d23 = max(d2a, d23);
`,t+=`    d22 = min(d22, d23); // 2nd smallest now not in d23
`,t+=`    vec3 d3a = min(d31, d32);
`,t+=`    d32 = max(d31, d32);
`,t+=`    d31 = min(d3a, d33); // Smallest now not in d32 or d33
`,t+=`    d33 = max(d3a, d33);
`,t+=`    d32 = min(d32, d33); // 2nd smallest now not in d33
`,t+=`    vec3 da = min(d11, d21);
`,t+=`    d21 = max(d11, d21);
`,t+=`    d11 = min(da, d31); // Smallest now in d11
`,t+=`    d31 = max(da, d31); // 2nd smallest now not in d31
`,t+=`    if (d11.x >= d11.y) { vec2 temp = d11.yx; d11.x = temp.x; d11.y = temp.y; }
`,t+=`    if (d11.x >= d11.z) { vec2 temp = d11.zx; d11.x = temp.x; d11.z = temp.y; }
`,t+=`    d12 = min(d12, d21); // 2nd smallest now not in d21
`,t+=`    d12 = min(d12, d22); // nor in d22
`,t+=`    d12 = min(d12, d31); // nor in d31
`,t+=`    d12 = min(d12, d32); // nor in d32
`,t+=`    vec2 temp2 = min(d11.yz, d12.xy); // nor in d12.yz
`,t+=`    d11.y = temp2.x;
`,t+=`    d11.z = temp2.y;
`,t+=`    d11.y = min(d11.y, d12.z); // Only two more to go
`,t+=`    d11.y = min(d11.y, d11.z); // Done! (Phew!)
`,t+=`    return sqrt(d11.xy); // F1, F2
`,t+=`}

`,e.shaderLanguage===pe.WGSL?t=e._babylonSLtoWGSL(t):t=e._babylonSLtoGLSL(t),e._emitFunction("worley3D",t,"// Worley3D");let i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`${e._declareLocalVar(i,T.Vector2)} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});
`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${i}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${i}.y;
`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};
`}serialize(){let e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}};v([de("Use Manhattan Distance",ue.Boolean,"PROPERTIES",{notifiers:{update:!1}})],XT.prototype,"manhattanDistance",void 0);P("BABYLON.WorleyNoise3DBlock",XT);var zR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("seed",T.Vector3),this.registerOutput("output",T.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t=`const float SKEWFACTOR = 1.0/3.0;
`;return t+=`const float UNSKEWFACTOR = 1.0/6.0;
`,t+=`const float SIMPLEX_CORNER_POS = 0.5;
`,t+=`const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;
`,t+=`float SimplexPerlin3D( vec3 source ){
`,t+=`    vec3 P = source;
`,t+=`    P.x = [P.x == 0. && P.y == 0. && P.z == 0. ? 0.00001 : P.x];
`,t+=`    P *= SIMPLEX_TETRAHADRON_HEIGHT;
`,t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+=`    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );
`,t+=`    vec3 g = step(x0.yzx, x0.xyz);
`,t+=`    vec3 l = 1.0 - g;
`,t+=`    vec3 Pi_1 = min( g.xyz, l.zxy );
`,t+=`    vec3 Pi_2 = max( g.xyz, l.zxy );
`,t+=`    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;
`,t+=`    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;
`,t+=`    vec3 x3 = x0 - SIMPLEX_CORNER_POS;
`,t+=`    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );
`,t+=`    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );
`,t+=`    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );
`,t+=`    Pi = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;
`,t+=`    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );
`,t+=`    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;
`,t+=`    Pt *= Pt;
`,t+=`    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );
`,t+=`    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );
`,t+=`    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );
`,t+=`    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );
`,t+=`    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );
`,t+=`    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );
`,t+=`    Pi_1 = [( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods];
`,t+=`    Pi_2 = [( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods];
`,t+=`    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;
`,t+=`    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;
`,t+=`    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;
`,t+=`    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );
`,t+=`    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;
`,t+=`    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;
`,t+=`    kernel_weights = max(0.5 - kernel_weights, vec4(0.));
`,t+=`    kernel_weights = kernel_weights*kernel_weights*kernel_weights;
`,t+=`    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;
`,t+=`}
`,e.shaderLanguage===pe.WGSL?t=e._babylonSLtoWGSL(t):t=e._babylonSLtoGLSL(t),e._emitFunction("SimplexPerlin3D",t,"// SimplexPerlin3D"),e.compilationString+=e._declareOutput(this._outputs[0])+` = SimplexPerlin3D(${this.seed.associatedVariableName});
`,this}};P("BABYLON.SimplexPerlin3DBlock",zR);var WR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("normalMap0",T.AutoDetect),this.registerInput("normalMap1",T.AutoDetect),this.registerOutput("output",T.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Color4|T.Vector3|T.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Color4|T.Vector3|T.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._inputs[0],r=this._inputs[1],n=e._getFreeVariableName("stepR"),o=e._getFreeVariableName("stepG");return e.compilationString+=`${e._declareLocalVar(n,T.Float)} = step(0.5, ${i.associatedVariableName}.r);
`,e.compilationString+=`${e._declareLocalVar(o,T.Float)} = step(0.5, ${i.associatedVariableName}.g);
`,e.compilationString+=e._declareOutput(t)+`;
`,e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${n}) * ${i.associatedVariableName}.r * ${r.associatedVariableName}.r * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${r.associatedVariableName}.r) * 2.0);
`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${o}) * ${i.associatedVariableName}.g * ${r.associatedVariableName}.g * 2.0 + ${o} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${r.associatedVariableName}.g) * 2.0);
`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${r.associatedVariableName}.b;
`,this}};P("BABYLON.NormalBlendBlock",WR);var HR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("input",T.Vector2),this.registerInput("angle",T.Float),this.registerOutput("output",T.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){let e=new Be("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this.angle,r=this.input;return e.compilationString+=e._declareOutput(t)+` = vec2(cos(${i.associatedVariableName}) * ${r.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${r.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${r.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${r.associatedVariableName}.y);
`,this}};P("BABYLON.Rotate2dBlock",HR);var XR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("incident",T.AutoDetect),this.registerInput("normal",T.AutoDetect),this.registerOutput("output",T.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Vector3|T.Vector4|T.Color3|T.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(T.Vector3|T.Vector4|T.Color3|T.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);
`,this}};P("BABYLON.ReflectBlock",XR);var YR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("incident",T.AutoDetect),this.registerInput("normal",T.AutoDetect),this.registerInput("ior",T.Float),this.registerOutput("output",T.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Vector3|T.Vector4|T.Color3|T.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(T.Vector3|T.Vector4|T.Color3|T.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});
`,this}};P("BABYLON.RefractBlock",YR);var $R=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("color",T.Color3),this.registerInput("level",T.Float),this.registerOutput("output",T.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],r=this.color.associatedVariableName,n=e._getFreeVariableName("colorMin"),o=e._getFreeVariableName("colorMax"),a=e._getFreeVariableName("colorMerge");return e.compilationString+=`${e._declareLocalVar(n,T.Float)} = min(min(${r}.x, ${r}.y), ${r}.z);
`,e.compilationString+=`${e._declareLocalVar(o,T.Float)} = max(max(${r}.x, ${r}.y), ${r}.z);
`,e.compilationString+=`${e._declareLocalVar(a,T.Float)} = 0.5 * (${n} + ${o});
`,e.compilationString+=e._declareOutput(t)+` = mix(${r}, ${e._getShaderType(T.Vector3)}(${a}, ${a}, ${a}), ${this.level.associatedVariableName});
`,this}};P("BABYLON.DesaturateBlock",$R);var Ch=class s extends Z{constructor(e){super(e,w.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",T.Float,!0,w.Fragment),this.registerInput("color",T.Color3,!0,w.Fragment),this.registerInput("roughness",T.Float,!0,w.Fragment),this.registerOutput("sheen",T.Object,w.Fragment,new Dt("sheen",this,xt.Output,s,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e){let t="",i=this.color.isConnected?this.color.associatedVariableName:"vec3(1.)",r=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",n=this.roughness.isConnected?this.roughness.associatedVariableName:"0.";return t=`#ifdef SHEEN
            sheenOutParams sheenOut;

            vec4 vSheenColor = vec4(${i}, ${r});

            sheenBlock(
                vSheenColor,
            #ifdef SHEEN_ROUGHNESS
                ${n},
            #endif
                roughness,
            #ifdef SHEEN_TEXTURE
                vec4(0.),
                1.0,
            #endif
                reflectance,
            #ifdef SHEEN_LINKWITHALBEDO
                baseColor,
                surfaceAlbedo,
            #endif
            #ifdef ENVIRONMENTBRDF
                NdotV,
                environmentBrdf,
            #endif
            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
                AARoughnessFactors,
                ${e?._vReflectionMicrosurfaceInfosName},
                ${e?._vReflectionInfosName},
                ${e?.reflectionColor},
                vLightingIntensity,
                #ifdef ${e?._define3DName}
                    ${e?._cubeSamplerName},
                #else
                    ${e?._2DSamplerName},
                #endif
                reflectionOut.reflectionCoords,
                NdotVUnclamped,
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${e?._define3DName}
                        ${e?._cubeSamplerName},
                        ${e?._cubeSamplerName},
                    #else
                        ${e?._2DSamplerName},
                        ${e?._2DSamplerName},
                    #endif
                #endif
                #if !defined(${e?._defineSkyboxName}) && defined(RADIANCEOCCLUSION)
                    seo,
                #endif
                #if !defined(${e?._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${e?._define3DName})
                    eho,
                #endif
            #endif
                sheenOut
            );

            #ifdef SHEEN_LINKWITHALBEDO
                surfaceAlbedo = sheenOut.surfaceAlbedo;
            #endif
        #endif
`,t}_buildBlock(e){return e.target===w.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};
`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};
`,e}serialize(){let e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}};v([de("Albedo scaling",ue.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Ch.prototype,"albedoScaling",void 0);v([de("Link sheen with albedo",ue.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Ch.prototype,"linkSheenWithAlbedo",void 0);P("BABYLON.SheenBlock",Ch);var zm=class s extends Z{constructor(e){super(e,w.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",T.Float,!0,w.Fragment),this.registerInput("direction",T.Vector2,!0,w.Fragment),this.registerInput("uv",T.Vector2,!0),this.registerInput("worldTangent",T.Vector4,!0),this.registerInput("TBN",T.Object,!0,w.VertexAndFragment,new Dt("TBN",this,xt.Input,al,"TBNBlock")),this.registerInput("roughness",T.Float,!0,w.Fragment),this.registerOutput("anisotropy",T.Object,w.Fragment,new Dt("anisotropy",this,xt.Output,s,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get roughness(){return this._inputs[5]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="",i=`//${this.name}`,r=this.uv,n=this.worldPositionConnectionPoint,o=this.worldNormalConnectionPoint,a=this.worldTangent;r.isConnected||F.Error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let l={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},c=this.TBN;return c.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            mat3 vTBN = ${c.associatedVariableName};
            #endif
            `:a.isConnected&&(t+=`vec3 tbnNormal = normalize(${o.associatedVariableName}.xyz);
`,t+=`vec3 tbnTangent = normalize(${a.associatedVariableName}.xyz);
`,t+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};
`,t+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);
`),t+=`
            #if defined(${a.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)
                mat3 TBN = vTBN;
            #else
                mat3 TBN = cotangent_frame(${o.associatedVariableName+".xyz"}, ${"v_"+n.associatedVariableName+".xyz"}, ${r.isConnected?r.associatedVariableName:"vec2(0.)"}, vec2(1., 1.));
            #endif
`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[l]}),t}getCode(e,t=!1){let i="";t&&(i+=this._generateTBNSpace(e));let r=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0",n=this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)",o=this.roughness.isConnected?this.roughness.associatedVariableName:"0.";return i+=`anisotropicOutParams anisotropicOut;
            anisotropicBlock(
                vec3(${n}, ${r}),
                ${o},
            #ifdef ANISOTROPIC_TEXTURE
                vec3(0.),
            #endif
                TBN,
                normalW,
                viewDirectionW,
                anisotropicOut
            );
`,i}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0),i.setValue("ANISOTROPIC_LEGACY",!this.roughness.isConnected)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_buildBlock(e){return e.target===w.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,T.Float)),this}};P("BABYLON.AnisotropyBlock",zm);var bh=class s extends ll{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,F.Error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?w.Fragment:w.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",T.AutoDetect,!1,w.Vertex),this.registerInput("world",T.Matrix,!1,w.Vertex),this.registerInput("color",T.Color3,!0,w.Fragment),this.registerOutput("reflection",T.Object,w.Fragment,new Dt("reflection",this,xt.Output,s,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Vector3|T.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);let r=this._getTexture(),n=r&&r.getTextureMatrix;i.setValue("REFLECTION",n,!0),n&&(i.setValue(this._defineLODReflectionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!r.invertZ:r.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",r.gammaSpace,!0),i.setValue("RGBDREFLECTION",r.isRGBD,!0),r&&r.coordinatesMode!==z.SKYBOX_MODE&&r.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,r){super.bind(e,t,i);let n=this._getTexture();if(!n||!r)return;n.isCube?e.setTexture(this._cubeSamplerName,n):e.setTexture(this._2DSamplerName,n);let o=n.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,o,n.lodGenerationScale,n.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,o,xe.Log2(o));let a=r.materialDefines,l=n.sphericalPolynomial;if(a.USESPHERICALFROMREFLECTIONMAP&&l)if(a.SPHERICAL_HARMONICS){let c=l.preScaledHarmonics;e.setVector3("vSphericalL00",c.l00),e.setVector3("vSphericalL1_1",c.l1_1),e.setVector3("vSphericalL10",c.l10),e.setVector3("vSphericalL11",c.l11),e.setVector3("vSphericalL2_2",c.l2_2),e.setVector3("vSphericalL2_1",c.l2_1),e.setVector3("vSphericalL20",c.l20),e.setVector3("vSphericalL21",c.l21),e.setVector3("vSphericalL22",c.l22)}else e.setFloat3("vSphericalX",l.x.x,l.x.y,l.x.z),e.setFloat3("vSphericalY",l.y.x,l.y.y,l.y.z),e.setFloat3("vSphericalZ",l.z.x,l.z.y,l.z.z),e.setFloat3("vSphericalXX_ZZ",l.xx.x-l.zz.x,l.xx.y-l.zz.y,l.xx.z-l.zz.z),e.setFloat3("vSphericalYY_ZZ",l.yy.x-l.zz.x,l.yy.y-l.zz.y,l.yy.z-l.zz.z),e.setFloat3("vSphericalZZ",l.zz.x,l.zz.y,l.zz.z),e.setFloat3("vSphericalXY",l.xy.x,l.xy.y,l.xy.z),e.setFloat3("vSphericalYZ",l.yz.x,l.yz.y,l.yz.z),e.setFloat3("vSphericalZX",l.zx.x,l.zx.y,l.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});let i=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,T.Vector3,"defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00",T.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1",T.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10",T.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11",T.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2",T.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1",T.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20",T.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21",T.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22",T.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX",T.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY",T.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ",T.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ",T.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ",T.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ",T.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY",T.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ",T.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX",T.Vector3,"SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
                vec3 ${i} = vec3(${this._reflectionMatrixName} * vec4(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;
                #ifdef ${this._defineOppositeZ}
                    ${i}.z *= -1.0;
                #endif
                ${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${i});
            #endif
`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e),e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),e._emitFunction("sampleReflection",`
            #ifdef ${this._define3DName}
                #define sampleReflection(s, c) textureCube(s, c)
            #else
                #define sampleReflection(s, c) texture2D(s, c)
            #endif
`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`
            #ifdef ${this._define3DName}
                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif
`,`//${this.name}`);let r=`
            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {
                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}
                return ${this._reflectionVectorName};
            }
`;return e._emitFunction("computeReflectionCoordsPBR",r,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,T.Vector3),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,T.Vector2),i+=`#ifdef REFLECTION
            vec2 ${this._vReflectionInfosName} = vec2(1., 0.);

            reflectionOutParams reflectionOut;

            reflectionBlock(
                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName}.xyz,
                ${t},
                alphaG,
                ${this._vReflectionMicrosurfaceInfosName},
                ${this._vReflectionInfosName},
                ${this.reflectionColor},
            #ifdef ANISOTROPIC
                anisotropicOut,
            #endif
            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})
                NdotVUnclamped,
            #endif
            #ifdef ${this._defineLinearSpecularReflection}
                roughness,
            #endif
            #ifdef ${this._define3DName}
                ${this._cubeSamplerName},
            #else
                ${this._2DSamplerName},
            #endif
            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)
                ${this._vEnvironmentIrradianceName},
            #endif
            #ifdef USESPHERICALFROMREFLECTIONMAP
                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                    ${this._reflectionMatrixName},
                #endif
            #endif
            #ifdef USEIRRADIANCEMAP
                irradianceSampler, // ** not handled **
            #endif
            #ifndef LODBASEDMICROSFURACE
                #ifdef ${this._define3DName}
                    ${this._cubeSamplerName},
                    ${this._cubeSamplerName},
                #else
                    ${this._2DSamplerName},
                    ${this._2DSamplerName},
                #endif
            #endif
            #ifdef REALTIME_FILTERING
                ${this._vReflectionFilteringInfoName},
            #endif
                reflectionOut
            );
        #endif
`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==w.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};
`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};
`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};
`,e}serialize(){let e=super.serialize();return e.useSphericalHarmonics=this.useSphericalHarmonics,e.forceIrradianceInFragment=this.forceIrradianceInFragment,e.gammaSpace=this.texture?.gammaSpace??!0,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}};v([de("Spherical Harmonics",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],bh.prototype,"useSphericalHarmonics",void 0);v([de("Force irradiance in fragment",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],bh.prototype,"forceIrradianceInFragment",void 0);P("BABYLON.ReflectionBlock",bh);var Sh=class s extends Z{constructor(e){super(e,w.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",T.Float,!1,w.Fragment),this.registerInput("roughness",T.Float,!0,w.Fragment),this.registerInput("indexOfRefraction",T.Float,!0,w.Fragment),this.registerInput("normalMapColor",T.Color3,!0,w.Fragment),this.registerInput("uv",T.Vector2,!0,w.Fragment),this.registerInput("tintColor",T.Color3,!0,w.Fragment),this.registerInput("tintAtDistance",T.Float,!0,w.Fragment),this.registerInput("tintThickness",T.Float,!0,w.Fragment),this.registerInput("worldTangent",T.Vector4,!0),this.registerInput("worldNormal",T.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(T.Color4|T.Vector4|T.Vector3),this.registerInput("TBN",T.Object,!0,w.VertexAndFragment,new Dt("TBN",this,xt.Input,al,"TBNBlock")),this.registerOutput("clearcoat",T.Object,w.Fragment,new Dt("clearcoat",this,xt.Output,s,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){let e=new Be("ClearCoat intensity",w.Fragment,T.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",this.indexOfRefraction.isConnected?this.indexOfRefraction.connectInputBlock.value===cr._DefaultIndexOfRefraction:!0,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){super.bind(e,t,i);let r=this.indexOfRefraction.connectInputBlock?.value??cr._DefaultIndexOfRefraction,n=1-r,o=1+r,a=Math.pow(-n/o,2),l=1/r;e.setFloat4("vClearCoatRefractionParams",a,l,n,o);let c=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,h=c?.perturbedNormal.isConnected?c.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",h?.invertX?1:-1,h?.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",h?.invertX?-1:1,h?.invertY?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,i.getWorldMatrix().determinant()<0?-1:1)}_generateTBNSpace(e,t,i){let r="",n=`//${this.name}`,o=this.worldTangent;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let a={search:/defined\(TANGENT\)/g,replace:o.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            mat3 vTBN = ${l.associatedVariableName};
            #endif
            `:o.isConnected&&(r+=`vec3 tbnNormal = normalize(${i}.xyz);
`,r+=`vec3 tbnTangent = normalize(${o.associatedVariableName}.xyz);
`,r+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};
`,r+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",n,{replaceStrings:[a]}),r}static GetCode(e,t,i,r,n,o,a){let l="",c=t?.intensity.isConnected?t.intensity.associatedVariableName:"1.",h=t?.roughness.isConnected?t.roughness.associatedVariableName:"0.",u=t?.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:"vec3(0.)",d=t?.uv.isConnected?t.uv.associatedVariableName:"vec2(0.)",f=t?.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",m=t?.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.",g=t?.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.",_="vec4(0.)";if(t){e._emitUniformFromString("vClearCoatRefractionParams",T.Vector4),e._emitUniformFromString("vClearCoatTangentSpaceParams",T.Vector2);let x=t.worldNormal;l+=`vec3 vGeometricNormaClearCoatW = ${x.isConnected?"normalize("+x.associatedVariableName+".xyz)":"geometricNormalW"};
`}else l+=`vec3 vGeometricNormaClearCoatW = geometricNormalW;
`;return n&&t&&(l+=t._generateTBNSpace(e,r,a),o=t.worldTangent.isConnected),l+=`clearcoatOutParams clearcoatOut;

        #ifdef CLEARCOAT
            vec2 vClearCoatParams = vec2(${c}, ${h});
            vec4 vClearCoatTintParams = vec4(${f}, ${m});

            clearcoatBlock(
                ${r}.xyz,
                vGeometricNormaClearCoatW,
                viewDirectionW,
                vClearCoatParams,
                specularEnvironmentR0,
            #ifdef CLEARCOAT_TEXTURE
                vec2(0.),
            #endif
            #ifdef CLEARCOAT_TINT
                vClearCoatTintParams,
                ${g},
                vClearCoatRefractionParams,
                #ifdef CLEARCOAT_TINT_TEXTURE
                    ${_},
                #endif
            #endif
            #ifdef CLEARCOAT_BUMP
                vec2(0., 1.),
                vec4(${u}, 0.),
                ${d},
                #if defined(${o?"TANGENT":"IGNORE"}) && defined(NORMAL)
                    vTBN,
                #else
                    vClearCoatTangentSpaceParams,
                #endif
                #ifdef OBJECTSPACE_NORMALMAP
                    normalMatrix,
                #endif
            #endif
            #if defined(FORCENORMALFORWARD) && defined(NORMAL)
                faceNormal,
            #endif
            #ifdef REFLECTION
                ${i?._vReflectionMicrosurfaceInfosName},
                ${i?._vReflectionInfosName},
                ${i?.reflectionColor},
                vLightingIntensity,
                #ifdef ${i?._define3DName}
                    ${i?._cubeSamplerName},
                #else
                    ${i?._2DSamplerName},
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${i?._define3DName}
                        ${i?._cubeSamplerName},
                        ${i?._cubeSamplerName},
                    #else
                        ${i?._2DSamplerName},
                        ${i?._2DSamplerName},
                    #endif
                #endif
            #endif
            #if defined(ENVIRONMENTBRDF) && !defined(${i?._defineSkyboxName})
                #ifdef RADIANCEOCCLUSION
                    ambientMonochrome,
                #endif
            #endif
            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
                (gl_FrontFacing ? 1. : -1.),
            #endif
                clearcoatOut
            );
        #else
            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;
        #endif
`,l}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===w.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,T.Float)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};
`,e}serialize(){let e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.remapF0OnInterfaceChange=e.remapF0OnInterfaceChange??!0}};v([de("Remap F0 on interface change",ue.Boolean,"ADVANCED")],Sh.prototype,"remapF0OnInterfaceChange",void 0);P("BABYLON.ClearCoatBlock",Sh);var Jd=class s extends Z{constructor(e){super(e,w.Fragment),this._isUnique=!0,this.registerInput("intensity",T.Float,!0,w.Fragment),this.registerInput("indexOfRefraction",T.Float,!0,w.Fragment),this.registerInput("thickness",T.Float,!0,w.Fragment),this.registerOutput("iridescence",T.Object,w.Fragment,new Dt("iridescence",this,xt.Output,s,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){let e=new Be("Iridescence intensity",w.Fragment,T.Float);e.value=1,e.output.connectTo(this.intensity);let t=new Be("Iridescence ior",w.Fragment,T.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);let i=new Be("Iridescence thickness",w.Fragment,T.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e){let t="",i=e?.intensity.isConnected?e.intensity.associatedVariableName:"1.",r=e?.indexOfRefraction.isConnected?e.indexOfRefraction.associatedVariableName:Kr._DefaultIndexOfRefraction,n=e?.thickness.isConnected?e.thickness.associatedVariableName:Kr._DefaultMaximumThickness;return t+=`iridescenceOutParams iridescenceOut;

        #ifdef IRIDESCENCE
            iridescenceBlock(
                vec4(${i}, ${r}, 1., ${n}),
                NdotV,
                specularEnvironmentR0,
                #ifdef CLEARCOAT
                    NdotVUnclamped,
                #endif
                iridescenceOut
            );

            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;
            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;
        #endif
`,t}_buildBlock(e){return e.target===w.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}};P("BABYLON.IridescenceBlock",Jd);var oc=class s extends Z{constructor(e){super(e,w.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",T.Float,!1,w.Fragment),this.registerInput("tintAtDistance",T.Float,!0,w.Fragment),this.registerInput("volumeIndexOfRefraction",T.Float,!0,w.Fragment),this.registerOutput("refraction",T.Object,w.Fragment,new Dt("refraction",this,xt.Output,s,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e,t=()=>!0){if(!this.intensity.isConnected){let i=new Be("Refraction intensity",w.Fragment,T.Float);i.value=1,i.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.View&&t(r));i||(i=new Be("view"),i.setAsSystemValue(qe.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);let r=this._getTexture(),n=r&&r.getTextureMatrix;i.setValue("SS_REFRACTION",n,!0),n&&(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLODRefractionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem&&r.isCube?!r.invertZ:r.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",r.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",r.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!r.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){let e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){super.bind(e,t,i);let r=this._getTexture();if(!r)return;r.isCube?e.setTexture(this._cubeSamplerName,r):e.setTexture(this._2DSamplerName,r),e.setMatrix(this._refractionMatrixName,r.getRefractionTextureMatrix());let n=1;r.isCube||r.depth&&(n=r.depth);let o=this.volumeIndexOfRefraction.connectInputBlock?.value??this.indexOfRefractionConnectionPoint.connectInputBlock?.value??1.5;e.setFloat4(this._vRefractionInfosName,r.level,1/o,n,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,r.getSize().width,r.lodGenerationScale,r.lodGenerationOffset,1/o);let a=r.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,a,xe.Log2(a)),r.boundingBoxSize){let l=r;e.setVector3("vRefractionPosition",l.boundingBoxPosition),e.setVector3("vRefractionSize",l.boundingBoxSize)}}getCode(e){let t="";return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),e._samplerDeclaration+=`#ifdef ${this._define3DName}
`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};
`,e._samplerDeclaration+=`#else
`,e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};
`,e._samplerDeclaration+=`#endif
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,T.Matrix),e._emitFunction("sampleRefraction",`
            #ifdef ${this._define3DName}
                #define sampleRefraction(s, c) textureCube(s, c)
            #else
                #define sampleRefraction(s, c) texture2D(s, c)
            #endif
`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`
            #ifdef ${this._define3DName}
                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif
`,`//${this.name}`),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,T.Vector4),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,T.Vector4),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,T.Vector2),e._emitUniformFromString("vRefractionPosition",T.Vector3),e._emitUniformFromString("vRefractionSize",T.Vector3),t}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(this.texture.isCube?e=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");
`:e=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};
`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};
`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};
`,e}serialize(){let e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=Hi.Parse(e.texture,t,i):this.texture=z.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}};v([de("Link refraction to transparency",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],oc.prototype,"linkRefractionWithTransparency",void 0);v([de("Invert refraction Y",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],oc.prototype,"invertRefractionY",void 0);v([de("Use thickness as depth",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],oc.prototype,"useThicknessAsDepth",void 0);P("BABYLON.RefractionBlock",oc);var ef=class s extends Z{constructor(e){super(e,w.Fragment),this._isUnique=!0,this.registerInput("thickness",T.Float,!1,w.Fragment),this.registerInput("tintColor",T.Color3,!0,w.Fragment),this.registerInput("translucencyIntensity",T.Float,!0,w.Fragment),this.registerInput("translucencyDiffusionDist",T.Color3,!0,w.Fragment),this.registerInput("refraction",T.Object,!0,w.Fragment,new Dt("refraction",this,xt.Input,oc,"RefractionBlock")),this.registerInput("dispersion",T.Float,!0,w.Fragment),this.registerOutput("subsurface",T.Object,w.Fragment,new Dt("subsurface",this,xt.Output,s,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vTranslucencyColor"),e._excludeVariableName("vSubSurfaceIntensity"),e._excludeVariableName("dispersion")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get dispersion(){return this._inputs[5]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){let e=new Be("SubSurface thickness",w.Fragment,T.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);let r=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",r||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",r,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0),i.setValue("SS_DISPERSION",this.dispersion.isConnected,!0)}static GetCode(e,t,i,r){let n="",o=t?.thickness.isConnected?t.thickness.associatedVariableName:"0.",a=t?.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",l=t?.translucencyIntensity.isConnected?t?.translucencyIntensity.associatedVariableName:"1.",c=t?.translucencyDiffusionDist.isConnected?t?.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",h=t?.refraction.isConnected?t?.refraction.connectedPoint?.ownerBlock:null,u=h?.tintAtDistance.isConnected?h.tintAtDistance.associatedVariableName:"1.",d=h?.intensity.isConnected?h.intensity.associatedVariableName:"1.",f=h?.view.isConnected?h.view.associatedVariableName:"",m=t?.dispersion.isConnected?t?.dispersion.associatedVariableName:"0.0";return n+=h?.getCode(e)??"",n+=`subSurfaceOutParams subSurfaceOut;

        #ifdef SUBSURFACE
            vec2 vThicknessParam = vec2(0., ${o});
            vec4 vTintColor = vec4(${a}, ${u});
            vec3 vSubSurfaceIntensity = vec3(${d}, ${l}, 0.);
            float dispersion = ${m};
            subSurfaceBlock(
                vSubSurfaceIntensity,
                vThicknessParam,
                vTintColor,
                normalW,
                specularEnvironmentReflectance,
            #ifdef SS_THICKNESSANDMASK_TEXTURE
                vec4(0.),
            #endif
            #ifdef REFLECTION
                #ifdef SS_TRANSLUCENCY
                    ${i?._reflectionMatrixName},
                    #ifdef USESPHERICALFROMREFLECTIONMAP
                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                            reflectionOut.irradianceVector,
                        #endif
                        #if defined(REALTIME_FILTERING)
                            ${i?._cubeSamplerName},
                            ${i?._vReflectionFilteringInfoName},
                        #endif
                        #endif
                    #ifdef USEIRRADIANCEMAP
                        irradianceSampler,
                    #endif
                #endif
            #endif
            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
                surfaceAlbedo,
            #endif
            #ifdef SS_REFRACTION
                ${r}.xyz,
                viewDirectionW,
                ${f},
                ${h?._vRefractionInfosName??""},
                ${h?._refractionMatrixName??""},
                ${h?._vRefractionMicrosurfaceInfosName??""},
                vLightingIntensity,
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha,
                #endif
                #ifdef ${h?._defineLODRefractionAlpha??"IGNORE"}
                    NdotVUnclamped,
                #endif
                #ifdef ${h?._defineLinearSpecularRefraction??"IGNORE"}
                    roughness,
                #endif
                alphaG,
                #ifdef ${h?._define3DName??"IGNORE"}
                    ${h?._cubeSamplerName??""},
                #else
                    ${h?._2DSamplerName??""},
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${h?._define3DName??"IGNORE"}
                        ${h?._cubeSamplerName??""},
                        ${h?._cubeSamplerName??""},
                    #else
                        ${h?._2DSamplerName??""},
                        ${h?._2DSamplerName??""},
                    #endif
                #endif
                #ifdef ANISOTROPIC
                    anisotropicOut,
                #endif
                #ifdef REALTIME_FILTERING
                    ${h?._vRefractionFilteringInfoName??""},
                #endif
                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
                    vRefractionPosition,
                    vRefractionSize,
                #endif
                #ifdef SS_DISPERSION
                    dispersion,
                #endif
            #endif
            #ifdef SS_TRANSLUCENCY
                ${c},
                vTintColor,
                #ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
                    vec4(0.),
                #endif
            #endif
                subSurfaceOut
            );

            #ifdef SS_REFRACTION
                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha = subSurfaceOut.alpha;
                #endif
            #endif
        #else
            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;
        #endif
`,n}_buildBlock(e){return e.target===w.Fragment&&e.sharedData.blocksWithDefines.push(this),this}};P("BABYLON.SubSurfaceBlock",ef);var pQ={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["aggShadow",""],alpha:["alpha",""]},Ji=class extends Z{static _OnGenerateOnlyFragmentCodeChanged(e,t){let i=e;return i.worldPosition.isConnected?(i.generateOnlyFragmentCode=!i.generateOnlyFragmentCode,F.Error("The worldPosition input must not be connected to be able to switch!"),!1):(i._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?w.Fragment:w.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?w.Fragment:w.Vertex}constructor(e){super(e,w.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=X.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",T.Vector4,!1,w.Vertex),this.registerInput("worldNormal",T.Vector4,!1,w.Fragment),this.registerInput("view",T.Matrix,!1),this.registerInput("cameraPosition",T.Vector3,!1,w.Fragment),this.registerInput("perturbedNormal",T.Vector4,!0,w.Fragment),this.registerInput("baseColor",T.Color3,!0,w.Fragment),this.registerInput("metallic",T.Float,!1,w.Fragment),this.registerInput("roughness",T.Float,!1,w.Fragment),this.registerInput("ambientOcc",T.Float,!0,w.Fragment),this.registerInput("opacity",T.Float,!0,w.Fragment),this.registerInput("indexOfRefraction",T.Float,!0,w.Fragment),this.registerInput("ambientColor",T.Color3,!0,w.Fragment),this.registerInput("reflection",T.Object,!0,w.Fragment,new Dt("reflection",this,xt.Input,bh,"ReflectionBlock")),this.registerInput("clearcoat",T.Object,!0,w.Fragment,new Dt("clearcoat",this,xt.Input,Sh,"ClearCoatBlock")),this.registerInput("sheen",T.Object,!0,w.Fragment,new Dt("sheen",this,xt.Input,Ch,"SheenBlock")),this.registerInput("subsurface",T.Object,!0,w.Fragment,new Dt("subsurface",this,xt.Input,ef,"SubSurfaceBlock")),this.registerInput("anisotropy",T.Object,!0,w.Fragment,new Dt("anisotropy",this,xt.Input,zm,"AnisotropyBlock")),this.registerInput("iridescence",T.Object,!0,w.Fragment,new Dt("iridescence",this,xt.Input,Jd,"IridescenceBlock")),this.registerOutput("ambientClr",T.Color3,w.Fragment),this.registerOutput("diffuseDir",T.Color3,w.Fragment),this.registerOutput("specularDir",T.Color3,w.Fragment),this.registerOutput("clearcoatDir",T.Color3,w.Fragment),this.registerOutput("sheenDir",T.Color3,w.Fragment),this.registerOutput("diffuseInd",T.Color3,w.Fragment),this.registerOutput("specularInd",T.Color3,w.Fragment),this.registerOutput("clearcoatInd",T.Color3,w.Fragment),this.registerOutput("sheenInd",T.Color3,w.Fragment),this.registerOutput("refraction",T.Color3,w.Fragment),this.registerOutput("lighting",T.Color3,w.Fragment),this.registerOutput("shadow",T.Float,w.Fragment),this.registerOutput("alpha",T.Float,w.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.CameraPosition&&t(r));i||(i=new Be("cameraPosition"),i.setAsSystemValue(qe.CameraPosition)),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let i=e.getInputBlockByPredicate(r=>r.systemValue===qe.View&&t(r));i||(i=new Be("view"),i.setAsSystemValue(qe.View)),i.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("DEBUGMODE_FORCERETURN",!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===Gt.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===Gt.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));let r=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",r.indexOf(".")<0?r+".":r,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);let n=e.getScene();if(n.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&ge.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),!!i._areLightsDirty)if(!this.light)co(n,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,Na(n,i);else{let a={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};zf(n,e,this.light,this._lightId,i,!0,a),a.needRebuild&&i.rebuild()}}updateUniformsAndSamples(e,t,i,r){for(let n=0;n<t.maxSimultaneousLights&&i["LIGHT"+n];n++){let o=e.uniforms.indexOf("vLightData"+n)>=0;Hf(n,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+n],r,o)}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){if(!i)return;let r=i.getScene();this.light?Gf(this.light,this._lightId,r,e,!0):lo(r,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);let n=this._scene.ambientColor;n&&e.setColor3("ambientFromScene",n);let o=r.useRightHandedSystem===(r._mirroredCameraPosition!=null);e.setFloat(this._invertNormalName,o?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);let a=1,l=this.indexOfRefraction.connectInputBlock?.value??1.5,c=Math.pow((l-a)/(l+a),2);this._metallicReflectanceColor.scaleToRef(c*this._metallicF0Factor,gt.Color3[0]);let h=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,gt.Color3[0],h),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){let t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));let r="v_"+t.associatedVariableName;e._emitVaryingFromString(r,T.Vector4)&&(e.compilationString+=`${r} = ${t.associatedVariableName};
`);let n=this.reflection.isConnected?this.reflection.connectedPoint?.ownerBlock:null;n&&(n.viewConnectionPoint=this.view),e.compilationString+=n?.handleVertexSide(e)??"",e._emitVaryingFromString("vClipSpacePosition",T.Vector4,"defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+=`#if DEBUGMODE > 0
`,e._injectAtEnd+=`vClipSpacePosition = gl_Position;
`,e._injectAtEnd+=`#endif
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${t.associatedVariableName};
`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(){let e=`albedoOpacityOutParams albedoOpacityOut;
`,t=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",i=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return e+=`albedoOpacityBlock(
                vec4(${t}, 1.),
            #ifdef ALBEDO
                vec4(1.),
                vec2(1., 1.),
            #endif
            #ifdef OPACITY
                vec4(${i}),
                vec2(1., 1.),
            #endif
                albedoOpacityOut
            );

            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;
            float alpha = albedoOpacityOut.alpha;
`,e}_getAmbientOcclusionCode(){let e=`ambientOcclusionOutParams aoOut;
`,t=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return e+=`ambientOcclusionBlock(
            #ifdef AMBIENT
                vec3(${t}),
                vec4(0., 1.0, 1.0, 0.),
            #endif
                aoOut
            );
`,e}_getReflectivityCode(e){let t=`reflectivityOutParams reflectivityOut;
`,i="1.";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,T.Vector4),t+=`vec3 baseColor = surfaceAlbedo;

            reflectivityBlock(
                vec4(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.),
            #ifdef METALLICWORKFLOW
                surfaceAlbedo,
                ${this._vMetallicReflectanceFactorsName},
            #endif
            #ifdef REFLECTIVITY
                vec3(0., 0., ${i}),
                vec4(1.),
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor,
            #endif
            #ifdef MICROSURFACEMAP
                microSurfaceTexel, <== not handled!
            #endif
                reflectivityOut
            );

            float microSurface = reflectivityOut.microSurface;
            float roughness = reflectivityOut.roughness;

            #ifdef METALLICWORKFLOW
                surfaceAlbedo = reflectivityOut.surfaceAlbedo;
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;
            #endif
`,t}_buildBlock(e){super._buildBlock(e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=Bd(this._scene));let t=this.reflection.isConnected?this.reflection.connectedPoint?.ownerBlock:null;if(t&&(t.worldPositionConnectionPoint=this.worldPosition,t.cameraPositionConnectionPoint=this.cameraPosition,t.worldNormalConnectionPoint=this.worldNormal,t.viewConnectionPoint=this.view),e.target!==w.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);let i=`//${this.name}`,r=this.perturbedNormal,n=this.worldPosition.associatedVariableName;this.generateOnlyFragmentCode?(n=e._getFreeVariableName("globalWorldPos"),e._emitFunction("pbr_globalworldpos",`vec3 ${n};
`,i),e.compilationString+=`${n} = ${this.worldPosition.associatedVariableName}.xyz;
`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+=`#if DEBUGMODE > 0
`,e.compilationString+=`vec4 vClipSpacePosition = vec4((vec2(gl_FragCoord.xy) / vec2(1.0)) * 2.0 - 1.0, 0.0, 1.0);
`,e.compilationString+=`#endif
`):n="v_"+n,this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode",T.Vector2,"defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene",T.Vector3),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",i),e._emitFunctionFromInclude("importanceSampling",i),e._emitFunctionFromInclude("pbrHelperFunctions",i),e._emitFunctionFromInclude("imageProcessingDeclaration",i),e._emitFunctionFromInclude("imageProcessingFunctions",i),e._emitFunctionFromInclude("shadowsFragmentFunctions",i),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",i,{replaceStrings:[{search:/vPositionW/g,replace:n+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",i),e._emitFunctionFromInclude("pbrBRDFFunctions",i,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:t?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",i),e._emitFunctionFromInclude("pbrDirectLightingFunctions",i,{replaceStrings:[{search:/vPositionW/g,replace:n+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",i),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",i),e._emitFunctionFromInclude("pbrBlockReflectivity",i),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",i),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",i),e._emitFunctionFromInclude("pbrBlockAnisotropic",i),e._emitUniformFromString("vLightingIntensity",T.Vector4),t?.generateOnlyFragmentCode&&(e.compilationString+=t.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`vec4 ${this._vNormalWName} = normalize(${this.worldNormal.associatedVariableName});
`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${n}.xyz);
`),e.compilationString+=`vec3 geometricNormalW = ${this._vNormalWName}.xyz;
`,e.compilationString+=`vec3 normalW = ${r.isConnected?"normalize("+r.associatedVariableName+".xyz)":"geometricNormalW"};
`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,T.Float),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",i,{replaceStrings:[{search:/vPositionW/g,replace:n+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",i),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",i),e.compilationString+=`#ifdef UNLIT
                vec3 diffuseBase = vec3(1., 1., 1.);
            #else
`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",i,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:t?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:t?._define3DName??"REFLECTIONMAP_3D"}]});let o=this.anisotropy.isConnected?this.anisotropy.connectedPoint?.ownerBlock:null;o&&(o.worldPositionConnectionPoint=this.worldPosition,o.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=o.getCode(e,!this.perturbedNormal.isConnected)),t&&t.hasTexture&&(e.compilationString+=t.getCode(e,o?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",i,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:t?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:t?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:t?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:t?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:t?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:t?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:t?._vReflectionFilteringInfoName??"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",i,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});let a=this.sheen.isConnected?this.sheen.connectedPoint?.ownerBlock:null;a&&(e.compilationString+=a.getCode(t)),e._emitFunctionFromInclude("pbrBlockSheen",i,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:t?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:t?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:t?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:t?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"}]});let l=this.iridescence.isConnected?this.iridescence.connectedPoint?.ownerBlock:null;e.compilationString+=Jd.GetCode(l),e._emitFunctionFromInclude("pbrBlockIridescence",i,{replaceStrings:[]});let c=this.clearcoat.isConnected?this.clearcoat.connectedPoint?.ownerBlock:null,h=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,u=this.perturbedNormal.isConnected&&(this.perturbedNormal.connectedPoint?.ownerBlock).worldTangent?.isConnected,d=this.anisotropy.isConnected&&(this.anisotropy.connectedPoint?.ownerBlock).worldTangent.isConnected,f=u||!this.perturbedNormal.isConnected&&d;e.compilationString+=Sh.GetCode(e,c,t,n,h,f,this.worldNormal.associatedVariableName),h&&(f=c?.worldTangent.isConnected??!1),e._emitFunctionFromInclude("pbrBlockClearcoat",i,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:t?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:t?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:t?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:t?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:t?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:t?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:f?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",i,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:t?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:t?._define3DName??"REFLECTIONMAP_3D"}]});let m=this.subsurface.isConnected?this.subsurface.connectedPoint?.ownerBlock:null,g=this.subsurface.isConnected?(this.subsurface.connectedPoint?.ownerBlock).refraction.connectedPoint?.ownerBlock:null;g&&(g.viewConnectionPoint=this.view,g.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=ef.GetCode(e,m,t,n),e._emitFunctionFromInclude("pbrBlockSubSurface",i,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:t?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:t?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:t?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:g?._define3DName??"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:g?._defineLODRefractionAlpha??"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:g?._defineLinearSpecularRefraction??"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:g?._defineOppositeZ??"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",i),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/vPositionW/g,replace:n+".xyz"}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",i,{repeatKey:"maxSimultaneousLights",substitutionVars:`vPositionW,${n}.xyz`}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",i),e.compilationString+=`#endif
`;let _=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)",x=Gt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();x.indexOf(".")===-1&&(x+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",i,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:_+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:x}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",i,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",i,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",i,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:n},{search:/albedoTexture\.rgb;/g,replace:`vec3(1.);
gl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);
`}]});for(let b of this._outputs)if(b.hasEndpoints){let C=pQ[b.name];if(C){let[R,E]=C;E&&(e.compilationString+=`#if ${E}
`),e.compilationString+=`${e._declareOutput(b)} = ${R};
`,E&&(e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(b)} = vec3(0.);
`,e.compilationString+=`#endif
`)}else F.Error(`There's no remapping for the ${b.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};
`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};
`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};
`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};
`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};
`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};
`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};
`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};
`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};
`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};
`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};
`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};
`,e+=`${this._codeVariableName}.unlit = ${this.unlit};
`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};
`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};
`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};
`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};
`,e}serialize(){let e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=e.lightFalloff??0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=e.realTimeFilteringQuality??8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}};v([de("Direct lights",ue.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Ji.prototype,"directIntensity",void 0);v([de("Environment lights",ue.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Ji.prototype,"environmentIntensity",void 0);v([de("Specular highlights",ue.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Ji.prototype,"specularIntensity",void 0);v([de("Light falloff",ue.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:Gt.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:Gt.LIGHTFALLOFF_GLTF},{label:"Standard",value:Gt.LIGHTFALLOFF_STANDARD}]})],Ji.prototype,"lightFalloff",void 0);v([de("Alpha Testing",ue.Boolean,"OPACITY")],Ji.prototype,"useAlphaTest",void 0);v([de("Alpha CutOff",ue.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],Ji.prototype,"alphaTestCutoff",void 0);v([de("Alpha blending",ue.Boolean,"OPACITY")],Ji.prototype,"useAlphaBlending",void 0);v([de("Radiance over alpha",ue.Boolean,"RENDERING",{notifiers:{update:!0}})],Ji.prototype,"useRadianceOverAlpha",void 0);v([de("Specular over alpha",ue.Boolean,"RENDERING",{notifiers:{update:!0}})],Ji.prototype,"useSpecularOverAlpha",void 0);v([de("Specular anti-aliasing",ue.Boolean,"RENDERING",{notifiers:{update:!0}})],Ji.prototype,"enableSpecularAntiAliasing",void 0);v([de("Realtime filtering",ue.Boolean,"RENDERING",{notifiers:{update:!0}})],Ji.prototype,"realTimeFiltering",void 0);v([de("Realtime filtering quality",ue.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],Ji.prototype,"realTimeFilteringQuality",void 0);v([de("Energy Conservation",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],Ji.prototype,"useEnergyConservation",void 0);v([de("Radiance occlusion",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],Ji.prototype,"useRadianceOcclusion",void 0);v([de("Horizon occlusion",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],Ji.prototype,"useHorizonOcclusion",void 0);v([de("Unlit",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],Ji.prototype,"unlit",void 0);v([de("Force normal forward",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],Ji.prototype,"forceNormalForward",void 0);v([de("Generate only fragment code",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:Ji._OnGenerateOnlyFragmentCodeChanged}})],Ji.prototype,"generateOnlyFragmentCode",void 0);v([de("Debug mode",ue.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87},{label:"Albedo color",value:88},{label:"Ambient occlusion color",value:89}]})],Ji.prototype,"debugMode",void 0);v([de("Split position",ue.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],Ji.prototype,"debugLimit",void 0);v([de("Output factor",ue.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],Ji.prototype,"debugFactor",void 0);P("BABYLON.PBRMetallicRoughnessBlock",Ji);var jR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("left",T.AutoDetect),this.registerInput("right",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[1].acceptedConnectionPointTypes.push(T.Float)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.shaderLanguage===pe.GLSL?e.compilationString+=e._declareOutput(t)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`:e.compilationString+=e._declareOutput(t)+` = (${this.left.associatedVariableName} % ${this.right.associatedVariableName});
`,this}};P("BABYLON.ModBlock",jR);var qR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("row0",T.Vector4),this.registerInput("row1",T.Vector4),this.registerInput("row2",T.Vector4),this.registerInput("row3",T.Vector4),this.registerOutput("output",T.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){let e=new Be("row0");e.value=new De(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){let e=new Be("row1");e.value=new De(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){let e=new Be("row2");e.value=new De(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){let e=new Be("row3");e.value=new De(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this.row0,r=this.row1,n=this.row2,o=this.row3,a=e.shaderLanguage===pe.WGSL?"mat4x4f":"mat4";return e.compilationString+=e._declareOutput(t)+` = ${a}(${i.associatedVariableName}, ${r.associatedVariableName}, ${n.associatedVariableName}, ${o.associatedVariableName});
`,this}};P("BABYLON.MatrixBuilder",qR);var Jn=function(s){return s[s.Equal=0]="Equal",s[s.NotEqual=1]="NotEqual",s[s.LessThan=2]="LessThan",s[s.GreaterThan=3]="GreaterThan",s[s.LessOrEqual=4]="LessOrEqual",s[s.GreaterOrEqual=5]="GreaterOrEqual",s[s.Xor=6]="Xor",s[s.Or=7]="Or",s[s.And=8]="And",s}(Jn||{}),QR=class extends Z{constructor(e){super(e,w.Neutral),this.condition=Jn.LessThan,this.registerInput("a",T.Float),this.registerInput("b",T.Float),this.registerInput("true",T.AutoDetect,!0),this.registerInput("false",T.AutoDetect,!0),this.registerOutput("output",T.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=T.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",r=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case Jn.Equal:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} == ${this.b.associatedVariableName}`)};
`;break}case Jn.NotEqual:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} != ${this.b.associatedVariableName}`)};
`;break}case Jn.LessThan:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} < ${this.b.associatedVariableName}`)};
`;break}case Jn.LessOrEqual:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} <= ${this.b.associatedVariableName}`)};
`;break}case Jn.GreaterThan:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} > ${this.b.associatedVariableName}`)};
`;break}case Jn.GreaterOrEqual:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} >= ${this.b.associatedVariableName}`)};
`;break}case Jn.Xor:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(((${this.a.associatedVariableName} + ${this.b.associatedVariableName}) % 2.0) > 0.0)`)};
`;break}case Jn.Or:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0)`)};
`;break}case Jn.And:{e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)`)};
`;break}}return this}serialize(){let e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${Jn[this.condition]};
`}};P("BABYLON.ConditionalBlock",QR);var YT=class extends Z{constructor(e){super(e,w.Neutral),this.octaves=6,this.registerInput("seed",T.AutoDetect),this.registerInput("chaos",T.AutoDetect,!0),this.registerInput("offsetX",T.Float,!0),this.registerInput("offsetY",T.Float,!0),this.registerInput("offsetZ",T.Float,!0),this.registerOutput("output",T.Float),this._inputs[0].acceptedConnectionPointTypes.push(T.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(T.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t=`

        float cloudRandom(float p) { 
            float temp = fract(p * 0.011); 
            temp *= temp + 7.5; 
            temp *= temp + temp; 
            return fract(temp); 
        }

        // Based on Morgan McGuire @morgan3d
        // https://www.shadertoy.com/view/4dS3Wd
        float cloudNoise2(vec2 x, vec2 chaos) {
            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);

            vec2 i = floor(x);
            vec2 f = fract(x);

            float n = dot(i, step);

            vec2 u = f * f * (3.0 - 2.0 * f);
            return mix(
                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),
                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),
                    u.y
                );
        }

        float cloudNoise3(vec3 x, vec3 chaos) {
            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);

            vec3 i = floor(x);
            vec3 f = fract(x);

            float n = dot(i, step);

            vec3 u = f * f * (3.0 - 2.0 * f);
            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),
                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);
        }`,i=`
        float fbm2(vec2 st, vec2 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = .5;
            float frequency = 0.;

            // Loop of octaves
            vec2 tempST = st;
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise2(tempST, chaos);
                tempST *= 2.0;
                amplitude *= 0.5;
            }
            return value;
        }

        float fbm3(vec3 x, vec3 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = 0.5;
            vec3 tempX = x;
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise3(tempX, chaos);
                tempX = tempX * 2.0;
                amplitude *= 0.5;
            }
            return value;
        }`;e.shaderLanguage===pe.WGSL&&(t=e._babylonSLtoWGSL(t),i=e._babylonSLtoWGSL(i));let r=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode",t,"// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,i.replace(/fbm/gi,r).replace(/OCTAVES/gi,(this.octaves|0).toString()),"// CloudBlockCode FBM");let n=e._getFreeVariableName("st"),o=this.seed.connectedPoint?.type||T.Vector3;e.compilationString+=`${e._declareLocalVar(n,o)} = ${this.seed.associatedVariableName};
`,this.offsetX.isConnected&&(e.compilationString+=`${n}.x += 0.1 * ${this.offsetX.associatedVariableName};
`),this.offsetY.isConnected&&(e.compilationString+=`${n}.y += 0.1 * ${this.offsetY.associatedVariableName};
`),this.offsetZ.isConnected&&o===T.Vector3&&(e.compilationString+=`${n}.z += 0.1 * ${this.offsetZ.associatedVariableName};
`);let a="";if(this.chaos.isConnected)a=this.chaos.associatedVariableName;else{let l=e.fSuffix;a=this.seed.connectedPoint?.type===T.Vector2?`vec2${l}(0., 0.)`:`vec3${l}(0., 0., 0.)`}return e.compilationString+=e._declareOutput(this._outputs[0])+` = ${r}${this.seed.connectedPoint?.type===T.Vector2?"2":"3"}(${n}, ${a});
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};
`}serialize(){let e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}};v([de("Octaves",ue.Int)],YT.prototype,"octaves",void 0);P("BABYLON.CloudBlock",YT);var KR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("seed",T.Vector2),this.registerInput("offset",T.Float),this.registerInput("density",T.Float),this.registerOutput("output",T.Float),this.registerOutput("cells",T.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t=`vec2 voronoiRandom(vec2 p){
            p = vec2(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3)));
            return fract(sin(p)*18.5453);
        }
        `;e.shaderLanguage===pe.WGSL&&(t=e._babylonSLtoWGSL(t)),e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t=`void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){
            vec2 n = floor(seed * density);
            vec2 f = fract(seed * density);
            vec3 m = vec3( 8.0 );
            for( int j=-1; j<=1; j++ ){
                for( int i=-1; i<=1; i++ ){
                    vec2  g = vec2( float(i), float(j) );
                    vec2  o = voronoiRandom( n + g);
                    vec2  r = g - f + (0.5+0.5*sin(offset+6.2831*o));
                    float d = dot( r, r );
                    if( d<m.x ){
                        m = vec3( d, o );
                        outValue = m.x;
                        cells = m.y;
                    }
                }
			}
        }
        `,e.shaderLanguage===pe.WGSL?t=e._babylonSLtoWGSL(t):t=e._babylonSLtoGLSL(t),e._emitFunction("voronoi",t,"// Voronoi");let i=e._getFreeVariableName("tempOutput"),r=e._getFreeVariableName("tempCells"),n=e.shaderLanguage===pe.WGSL?"&":"";return e.compilationString+=`${e._declareLocalVar(i,T.Float)} = 0.0;
`,e.compilationString+=`${e._declareLocalVar(r,T.Float)} = 0.0;
`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${n}${i}, ${n}${r});
`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};
`),this.cells.hasEndpoints&&(e.compilationString+=e._declareOutput(this.cells)+` = ${r};
`),this}};P("BABYLON.VoronoiNoiseBlock",KR);var ZR=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("input",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){let e=this._inputs[0];if(e.isConnected){let t=e.connectedPoint.ownerBlock;if(t.target!==w.VertexAndFragment)return t.target;if(e.connectedPoint.target!==w.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){this._target&e||(this._target=e)}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = ${i.associatedVariableName};
`,this}};P("BABYLON.ElbowBlock",ZR);var tf=class extends Z{get texture(){return this.source.isConnected?(this.source.connectedPoint?.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;let t=e?.getScene()??me.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(e))}get textureY(){return this.sourceY.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}get textureZ(){return this.sourceZ?.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}_getImageSourceBlock(e){return e?.isConnected?e.connectedPoint.ownerBlock:null}get samplerName(){let e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){return this._getImageSourceBlock(this.sourceY)?.samplerName??null}get samplerZName(){return this._getImageSourceBlock(this.sourceZ)?.samplerName??null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture&&(this.texture.getScene()??me.LastCreatedScene)?.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture)))}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture&&(this.texture.getScene()??me.LastCreatedScene)?.markAllMaterialsAsDirty(1,i=>i.hasTexture(this.texture)))}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,w.Neutral),this.projectAsCube=!1,this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",T.AutoDetect,!1),this.registerInput("normal",T.AutoDetect,!1),this.registerInput("sharpness",T.Float,!0),this.registerInput("source",T.Object,!0,w.VertexAndFragment,new Dt("source",this,xt.Input,Us,"ImageSourceBlock")),this.registerInput("sourceY",T.Object,!0,w.VertexAndFragment,new Dt("sourceY",this,xt.Input,Us,"ImageSourceBlock")),t||this.registerInput("sourceZ",T.Object,!0,w.VertexAndFragment,new Dt("sourceZ",this,xt.Input,Us,"ImageSourceBlock")),this.registerOutput("rgba",T.Color4,w.Neutral),this.registerOutput("rgb",T.Color3,w.Neutral),this.registerOutput("r",T.Float,w.Neutral),this.registerOutput("g",T.Float,w.Neutral),this.registerOutput("b",T.Float,w.Neutral),this.registerOutput("a",T.Float,w.Neutral),this.registerOutput("level",T.Float,w.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Vector3|T.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(T.Color3|T.Vector3|T.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;let r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,n=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,n,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){this.texture&&(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_samplerFunc(e){return e.shaderLanguage===pe.WGSL?"textureSample":"texture2D"}_generateTextureSample(e,t,i){return i.shaderLanguage===pe.WGSL?`${this._samplerFunc(i)}(${e},${e+"Sampler"}, ${t})`:`${this._samplerFunc(i)}(${e}, ${t})`}_generateTextureLookup(e){let t=this.samplerName,i=this.samplerYName??t,r=this.samplerZName??t,n=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",o=e._getFreeVariableName("x"),a=e._getFreeVariableName("y"),l=e._getFreeVariableName("z"),c=e._getFreeVariableName("w"),h=e._getFreeVariableName("n"),u=e._getFreeVariableName("uvx"),d=e._getFreeVariableName("uvy"),f=e._getFreeVariableName("uvz");e.compilationString+=`
            ${e._declareLocalVar(h,T.Vector3)} = ${this.normal.associatedVariableName}.xyz;

            ${e._declareLocalVar(u,T.Vector2)} = ${this.position.associatedVariableName}.yz;
            ${e._declareLocalVar(d,T.Vector2)} = ${this.position.associatedVariableName}.zx;
            ${e._declareLocalVar(f,T.Vector2)} = ${this.position.associatedVariableName}.xy;
        `,this.projectAsCube&&(e.compilationString+=`
                ${u}.xy = ${u}.yx;

                if (${h}.x >= 0.0) {
                    ${u}.x = -${u}.x;
                }
                if (${h}.y < 0.0) {
                    ${d}.y = -${d}.y;
                }
                if (${h}.z < 0.0) {
                    ${f}.x = -${f}.x;
                }
            `);let m=e.fSuffix;e.compilationString+=`
            ${e._declareLocalVar(o,T.Vector4)} = ${this._generateTextureSample(t,u,e)};
            ${e._declareLocalVar(a,T.Vector4)} = ${this._generateTextureSample(i,d,e)};
            ${e._declareLocalVar(l,T.Vector4)} = ${this._generateTextureSample(r,f,e)};
           
            // blend weights
            ${e._declareLocalVar(c,T.Vector3)} = pow(abs(${h}), vec3${m}(${n}));

            // blend and return
            ${e._declareLocalVar(this._tempTextureRead,T.Vector4)} = (${o}*${c}.x + ${a}*${c}.y + ${l}*${c}.z) / (${c}.x + ${c}.y + ${c}.z);        
        `}_generateConversionCode(e,t,i){let r="";e.shaderLanguage===pe.WGSL&&(t.type===T.Vector3||t.type===T.Color3)&&(r="Vec3"),i!=="a"&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace${r}(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = toLinearSpace${r}(${t.associatedVariableName});
                #endif
            `)}_writeOutput(e,t,i){let r="";this.disableLevelMultiplication||(r=` * ${e.shaderLanguage===pe.WGSL?"uniforms.":""}${this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${r};
`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=(e.shaderLanguage===pe.WGSL?"uniforms.":"")+this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString(this._textureInfoName,T.Float),this._generateTextureLookup(e);for(let i of this._outputs)i.hasEndpoints&&i.name!=="level"&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};
`,e+=`${this._codeVariableName}.projectAsCube = ${this.projectAsCube};
`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,e.projectAsCube=this.projectAsCube,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,this.projectAsCube=!!e.projectAsCube,e.texture&&!$i.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=z.Parse(e.texture,t,i))}};v([de("Project as cube",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],tf.prototype,"projectAsCube",void 0);P("BABYLON.TriPlanarBlock",tf);var JR=class extends tf{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_declareLocalVarAsVec3I(e,t){return t.shaderLanguage===pe.WGSL?`var ${e}: vec3<i32>`:`ivec3 ${e}`}_getTextureGrad(e,t){return e.shaderLanguage===pe.WGSL?`textureSampleGrad(${t},${t+"Sampler"}`:`textureGrad(${t}`}_generateTextureLookup(e){let t=this.samplerName,i=this.samplerYName??this.samplerName,r=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",n=e._getFreeVariableName("dxValue"),o=e._getFreeVariableName("dyValue"),a=e._getFreeVariableName("n"),l=e._getFreeVariableName("ma"),c=e._getFreeVariableName("mi"),h=e._getFreeVariableName("me"),u=e._getFreeVariableName("x"),d=e._getFreeVariableName("y"),f=e._getFreeVariableName("w"),m="ivec3",g="dFdx",_="dFdy",x=e.fSuffix;e.shaderLanguage===pe.WGSL&&(m="vec3<i32>",g="dpdx",_="dpdy"),e.compilationString+=`
            // grab coord derivatives for texturing
            ${e._declareLocalVar(n,T.Vector3)} = ${g}(${this.position.associatedVariableName}.xyz);
            ${e._declareLocalVar(o,T.Vector3)} = ${_}(${this.position.associatedVariableName}.xyz);
            ${e._declareLocalVar(a,T.Vector3)} = abs(${this.normal.associatedVariableName}.xyz);
        
            // determine major axis (in x; yz are following axis)
            ${this._declareLocalVarAsVec3I(l,e)} = ${e._generateTernary(`${m}(0,1,2)`,`${e._generateTernary(`${m}(1,2,0)`,`${m}(2,0,1)`,`(${a}.y>${a}.z)`)}`,`(${a}.x>${a}.y && ${a}.x>${a}.z)`)};                    

            // determine minor axis (in x; yz are following axis)
            ${this._declareLocalVarAsVec3I(c,e)} =  ${e._generateTernary(`${m}(0,1,2)`,`${e._generateTernary(`${m}(1,2,0)`,`${m}(2,0,1)`,`(${a}.y<${a}.z)`)}`,`(${a}.x<${a}.y && ${a}.x<${a}.z)`)};  
                              
            // determine median axis (in x;  yz are following axis)
            ${this._declareLocalVarAsVec3I(h,e)} = ${m}(3) - ${c} - ${l};
            
            // project+fetch
            ${e._declareLocalVar(u,T.Vector4)} = ${this._getTextureGrad(e,t)}, vec2${x}(${this.position.associatedVariableName}[${l}.y], ${this.position.associatedVariableName}[${l}.z]), 
                                    vec2${x}(${n}[${l}.y],${n}[${l}.z]), 
                                    vec2${x}(${o}[${l}.y],${o}[${l}.z]));
            ${e._declareLocalVar(d,T.Vector4)} = ${this._getTextureGrad(e,i)}, vec2${x}(${this.position.associatedVariableName}[${h}.y], ${this.position.associatedVariableName}[${h}.z]), 
                                    vec2${x}(${n}[${h}.y],${n}[${h}.z]),
                                    vec2${x}(${o}[${h}.y],${o}[${h}.z]));
            
            // blend factors
            ${e._declareLocalVar(f,T.Vector2)} = vec2${x}(${a}[${l}.x],${a}[${h}.x]);
            // make local support
            ${f} = clamp( (${f}-0.5773)/(1.0-0.5773), vec2${x}(0.0), vec2${x}(1.0) );
            // shape transition
            ${f} = pow( ${f}, vec2${x}(${r}/8.0) );
            // blend and return
            ${e._declareLocalVar(this._tempTextureRead,T.Vector4)} = (${u}*${f}.x + ${d}*${f}.y) / (${f}.x + ${f}.y);
        `}};P("BABYLON.BiPlanarBlock",JR);var eP=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("input",T.Matrix),this.registerOutput("output",T.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = determinant(${i.associatedVariableName});
`,this}};P("BABYLON.MatrixDeterminantBlock",eP);var tP=class extends Z{constructor(e){super(e,w.Neutral),this.registerInput("input",T.Matrix),this.registerOutput("output",T.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = transpose(${i.associatedVariableName});
`,this}};P("BABYLON.MatrixTransposeBlock",tP);var hi=function(s){return s[s.None=0]="None",s[s.Normal=1]="Normal",s[s.Tangent=2]="Tangent",s[s.VertexColor=3]="VertexColor",s[s.UV1=4]="UV1",s[s.UV2=5]="UV2",s[s.UV3=6]="UV3",s[s.UV4=7]="UV4",s[s.UV5=8]="UV5",s[s.UV6=9]="UV6",s}(hi||{}),$T=class extends Z{constructor(e){super(e,w.Neutral),this.attributeType=hi.None,this.registerInput("input",T.AutoDetect),this.registerInput("fallback",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].onConnectionObservable.add(t=>{if(this.attributeType)return;let i=t.ownerBlock;if(i instanceof Be&&i.isAttribute)switch(i.name){case"color":this.attributeType=hi.VertexColor;break;case"normal":this.attributeType=hi.Normal;break;case"tangent":this.attributeType=hi.Tangent;break;case"uv":this.attributeType=hi.UV1;break;case"uv2":this.attributeType=hi.UV2;break;case"uv3":this.attributeType=hi.UV3;break;case"uv4":this.attributeType=hi.UV4;break;case"uv5":this.attributeType=hi.UV5;break;case"uv6":this.attributeType=hi.UV6;break}else if(i instanceof Lm)switch(this.input.connectedPoint?.name){case"normalOutput":this.attributeType=hi.Normal;break;case"tangentOutput":this.attributeType=hi.Tangent;break;case"uvOutput":this.attributeType=hi.UV1;break}})}getClassName(){return"MeshAttributeExistsBlock"}get input(){return this._inputs[0]}get fallback(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.attributeType){case hi.VertexColor:t="VERTEXCOLOR_NME";break;case hi.Normal:t="NORMAL";break;case hi.Tangent:t="TANGENT";break;case hi.UV1:t="UV1";break;case hi.UV2:t="UV2";break;case hi.UV3:t="UV3";break;case hi.UV4:t="UV4";break;case hi.UV5:t="UV5";break;case hi.UV6:t="UV6";break}let i=e._declareOutput(this.output);return t&&(e.compilationString+=`#ifdef ${t}
`),e.compilationString+=`${i} = ${this.input.associatedVariableName};
`,t&&(e.compilationString+=`#else
`,e.compilationString+=`${i} = ${this.fallback.associatedVariableName};
`,e.compilationString+=`#endif
`),this}serialize(){let e=super.serialize();return e.attributeType=this.attributeType,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.attributeType=e.attributeType??hi.None}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.attributeType = ${this.attributeType};
`,e}};v([de("Attribute lookup",ue.List,void 0,{notifiers:{update:!0},options:[{label:"(None)",value:hi.None},{label:"Normal",value:hi.Normal},{label:"Tangent",value:hi.Tangent},{label:"Vertex Color",value:hi.VertexColor},{label:"UV1",value:hi.UV1},{label:"UV2",value:hi.UV2},{label:"UV3",value:hi.UV3},{label:"UV4",value:hi.UV4},{label:"UV5",value:hi.UV5},{label:"UV6",value:hi.UV6}]})],$T.prototype,"attributeType",void 0);P("BABYLON.MeshAttributeExistsBlock",$T);var bi=function(s){return s[s.EaseInSine=0]="EaseInSine",s[s.EaseOutSine=1]="EaseOutSine",s[s.EaseInOutSine=2]="EaseInOutSine",s[s.EaseInQuad=3]="EaseInQuad",s[s.EaseOutQuad=4]="EaseOutQuad",s[s.EaseInOutQuad=5]="EaseInOutQuad",s[s.EaseInCubic=6]="EaseInCubic",s[s.EaseOutCubic=7]="EaseOutCubic",s[s.EaseInOutCubic=8]="EaseInOutCubic",s[s.EaseInQuart=9]="EaseInQuart",s[s.EaseOutQuart=10]="EaseOutQuart",s[s.EaseInOutQuart=11]="EaseInOutQuart",s[s.EaseInQuint=12]="EaseInQuint",s[s.EaseOutQuint=13]="EaseOutQuint",s[s.EaseInOutQuint=14]="EaseInOutQuint",s[s.EaseInExpo=15]="EaseInExpo",s[s.EaseOutExpo=16]="EaseOutExpo",s[s.EaseInOutExpo=17]="EaseInOutExpo",s[s.EaseInCirc=18]="EaseInCirc",s[s.EaseOutCirc=19]="EaseOutCirc",s[s.EaseInOutCirc=20]="EaseInOutCirc",s[s.EaseInBack=21]="EaseInBack",s[s.EaseOutBack=22]="EaseOutBack",s[s.EaseInOutBack=23]="EaseInOutBack",s[s.EaseInElastic=24]="EaseInElastic",s[s.EaseOutElastic=25]="EaseOutElastic",s[s.EaseInOutElastic=26]="EaseInOutElastic",s}(bi||{}),iP=class extends Z{constructor(e){super(e,w.Neutral),this.type=bi.EaseInOutSine,this.registerInput("input",T.AutoDetect),this.registerOutput("output",T.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(T.Matrix),this._inputs[0].excludedConnectionPointTypes.push(T.Object),this._inputs[0].excludedConnectionPointTypes.push(T.Int)}getClassName(){return"CurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_duplicateEntry(e,t){return`ret.${t} = ${e.replace(/VAL/g,"v."+t)}`}_duplicateEntryDirect(e){return`return ${e.replace(/VAL/g,"v")}`}_duplicateVector(e,t,i){if(t==="float"||t==="f32")return this._duplicateEntryDirect(e);let r=parseInt(t.replace("vec","")),n=i?`
            var ret: vec${r}f = vec${r}f(0.0);
        `:`
            vec${r} ret = vec${r}(0.0);
        `;for(let o=1;o<=r;o++)n+=this._duplicateEntry(e,o===1?"x":o===2?"y":o===3?"z":"w")+`;
`;return n+=`return ret;
`,n}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i="",r="",n=e._getShaderType(this.input.type),o=e.shaderLanguage===pe.WGSL;switch(r=bi[this.type]+"_"+n.replace("<","").replace(">",""),this.type){case bi.EaseInSine:i="return 1.0 - cos((v * 3.1415) / 2.0)";break;case bi.EaseOutSine:i="return sin((v * 3.1415) / 2.0)";break;case bi.EaseInOutSine:i="return -(cos(v * 3.1415) - 1.0) / 2.0";break;case bi.EaseInQuad:i="return v * v";break;case bi.EaseOutQuad:i="return (1.0 - v) * (1.0 - v)";break;case bi.EaseInOutQuad:{let a=e._generateTernary("2.0 * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(a,n,o);break}case bi.EaseInCubic:i="return v * v * v";break;case bi.EaseOutCubic:{i=this._duplicateVector("1.0 - pow(1.0 - VAL, 3.0)",n,o);break}case bi.EaseInOutCubic:{let a=e._generateTernary("4.0 * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 3.0) / 2.0","VAL < 0.5");i=this._duplicateVector(a,n,o);break}case bi.EaseInQuart:i="return v * v * v * v";break;case bi.EaseOutQuart:{i=this._duplicateVector("1.0 - pow(1.0 - VAL, 4.0)",n,o);break}case bi.EaseInOutQuart:{let a=e._generateTernary("8.0 * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 4.0) / 2.0","VAL < 0.5");i=this._duplicateVector(a,n,o);break}case bi.EaseInQuint:i="return v * v * v * v * v";break;case bi.EaseOutQuint:{i=this._duplicateVector("1.0 - pow(1.0 - VAL, 5.0)",n,o);break}case bi.EaseInOutQuint:{let a=e._generateTernary("16.0 * VAL * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 5.0) / 2.0","VAL < 0.5");i=this._duplicateVector(a,n,o);break}case bi.EaseInExpo:{let a=e._generateTernary("0.0","pow(2.0, 10.0 * VAL - 10.0)","VAL == 0.0");i=this._duplicateVector(a,n,o);break}case bi.EaseOutExpo:{let a=e._generateTernary("1.0","1.0 - pow(2.0, -10.0 * VAL)","VAL == 1.0");i=this._duplicateVector(a,n,o);break}case bi.EaseInOutExpo:{let a=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("pow(2.0, 20.0 * VAL - 10.0) / 2.0","(2.0 - pow(2.0, -20.0 * VAL + 10.0)) / 2.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(a,n,o);break}case bi.EaseInCirc:{i=this._duplicateVector("1.0 - sqrt(1.0 - pow(VAL, 2.0))",n,o);break}case bi.EaseOutCirc:{i=this._duplicateVector("sqrt(1.0 - pow(VAL - 1.0, 2.0))",n,o);break}case bi.EaseInOutCirc:{let a=e._generateTernary("(1.0 - sqrt(1.0 - pow(2.0 * VAL, 2.0))) / 2.0","(sqrt(1.0 - pow(-2.0 * VAL + 2.0, 2.0)) + 1.0) / 2.0","VAL < 0.5");i=this._duplicateVector(a,n,o);break}case bi.EaseInBack:{i="return 2.70158 * v * v * v - 1.70158 * v * v";break}case bi.EaseOutBack:{i=this._duplicateVector("2.70158 * pow(VAL - 1.0, 3.0) + 1.70158 * pow(VAL - 1.0, 2.0)",n,o);break}case bi.EaseInOutBack:{let a=e._generateTernary("(pow(2.0 * VAL, 2.0) * ((3.5949095) * 2.0 * VAL - 2.5949095)) / 2.0","(pow(2.0 * VAL - 2.0, 2.0) * (3.5949095 * (VAL * 2.0 - 2.0) + 3.5949095) + 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(a,n,o);break}case bi.EaseInElastic:{let a=e._generateTernary("0.0",e._generateTernary("1.0","-pow(2.0, 10.0 * VAL - 10.0) * sin((VAL * 10.0 - 10.75) * ((2.0 * 3.1415) / 3.0))","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(a,n,o);break}case bi.EaseOutElastic:{let a=e._generateTernary("0.0",e._generateTernary("1.0","pow(2.0, -10.0 * VAL) * sin((VAL * 10.0 - 0.75) * ((2.0 * 3.1415) / 3.0)) + 1.0","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(a,n,o);break}case bi.EaseInOutElastic:{let a=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("-(pow(2.0, 20.0 * VAL - 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0","(pow(2.0, -20.0 * VAL + 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 + 1.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(a,n,o);break}}return o?e._emitFunction(r,`fn ${r}(v: ${n}) -> ${n}  {${i};}
`,""):e._emitFunction(r,`${n} ${r}(${n} v) {${i};}
`,""),e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});
`,this}serialize(){let e=super.serialize();return e.curveType=this.type,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.CurveBlockTypes.${bi[this.type]};
`}};P("BABYLON.CurveBlock",iP);var rP=class extends Qt{constructor(){super(...arguments),this.DECAL=!1,this.DECALDIRECTUV=0,this.DECAL_SMOOTHALPHA=!1,this.GAMMADECAL=!1}},cl=class extends Ti{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e,t=!0){super(e,"DecalMap",150,new rP,t),this._isEnabled=!1,this.isEnabled=!1,this._smoothAlpha=!1,this.smoothAlpha=!1,this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i,r){let n=r.getMesh().decalMap;return!this._isEnabled||!n?.texture||!ge.DecalMapEnabled||!t.texturesEnabled?!0:n.isReady()}prepareDefines(e,t,i){let r=i.decalMap;!this._isEnabled||!r?.texture||!ge.DecalMapEnabled||!t.texturesEnabled?(e.DECAL&&e.markAsTexturesDirty(),e.DECAL=!1):((!e.DECAL||e.GAMMADECAL!==r.texture.gammaSpace)&&e.markAsTexturesDirty(),e.DECAL=!0,e.GAMMADECAL=r.texture.gammaSpace,e.DECAL_SMOOTHALPHA=this._smoothAlpha,bt(r.texture,e,"DECAL"))}hardBindForSubMesh(e,t,i,r){let n=r.getMesh().decalMap;if(!this._isEnabled||!n?.texture||!ge.DecalMapEnabled||!t.texturesEnabled)return;let o=this._material.isFrozen,a=n.texture;(!e.useUbo||!o||!e.isSync)&&(e.updateFloat4("vDecalInfos",a.coordinatesIndex,0,0,0),It(a,e,"decal")),e.setTexture("decalSampler",a)}getClassName(){return"DecalMapConfiguration"}getSamplers(e){e.push("decalSampler")}getUniforms(){return{ubo:[{name:"vDecalInfos",size:4,type:"vec4"},{name:"decalMatrix",size:16,type:"mat4"}]}}};v([I(),Q("_markAllSubMeshesAsTexturesDirty")],cl.prototype,"isEnabled",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],cl.prototype,"smoothAlpha",void 0);P("BABYLON.DecalMapConfiguration",cl);var Js=function(s){return s[s.COLOR_MODE_SET=0]="COLOR_MODE_SET",s[s.COLOR_MODE_ADD=1]="COLOR_MODE_ADD",s[s.COLOR_MODE_MULTIPLY=2]="COLOR_MODE_MULTIPLY",s}(Js||{}),Sa=function(s){return s[s.COLOR_DISTRIBUTION_TYPE_SEGMENT=0]="COLOR_DISTRIBUTION_TYPE_SEGMENT",s[s.COLOR_DISTRIBUTION_TYPE_LINE=1]="COLOR_DISTRIBUTION_TYPE_LINE",s}(Sa||{});var rr=class{};rr.DEFAULT_COLOR=X.White();rr.DEFAULT_WIDTH_ATTENUATED=1;rr.DEFAULT_WIDTH=.1;var Si=class s{static ConvertPoints(e){if(e.length&&Array.isArray(e)&&typeof e[0]=="number")return[e];if(e.length&&Array.isArray(e[0])&&typeof e[0][0]=="number")return e;if(e.length&&!Array.isArray(e[0])&&e[0]instanceof p){let t=[];for(let i=0;i<e.length;i++){let r=e[i];t.push(r.x,r.y,r.z)}return[t]}else if(e.length>0&&Array.isArray(e[0])&&e[0].length>0&&e[0][0]instanceof p){let t=[];return e.forEach(r=>{t.push(r.flatMap(n=>[n.x,n.y,n.z]))}),t}else{if(e instanceof Float32Array)return[Array.from(e)];if(e.length&&e[0]instanceof Float32Array){let t=[];return e.forEach(i=>{t.push(Array.from(i))}),t}}return[]}static OmitZeroLengthPredicate(e,t,i){let r=[];return t.subtract(e).lengthSquared()>0&&r.push([e,t]),i.subtract(t).lengthSquared()>0&&r.push([t,i]),e.subtract(i).lengthSquared()>0&&r.push([i,e]),r.length===0?null:r}static OmitDuplicatesPredicate(e,t,i,r){let n=[];return s._SearchInPoints(e,t,r)||n.push([e,t]),s._SearchInPoints(t,i,r)||n.push([t,i]),s._SearchInPoints(i,e,r)||n.push([i,e]),n.length===0?null:n}static _SearchInPoints(e,t,i){for(let r of i)for(let n=0;n<r.length;n++)if(r[n]?.equals(e)&&(r[n+1]?.equals(t)||r[n-1]?.equals(t)))return!0;return!1}static MeshesToLines(e,t){let i=[];return e.forEach((r,n)=>{let o=r.getVerticesData(y.PositionKind),a=r.getIndices();if(o&&a)for(let l=0,c=0;l<a.length;l++){let h=a[c++]*3,u=a[c++]*3,d=a[c++]*3,f=new p(o[h],o[h+1],o[h+2]),m=new p(o[u],o[u+1],o[u+2]),g=new p(o[d],o[d+1],o[d+2]);if(t){let _=t(f,m,g,i,l,h,r,n,o,a);if(_)for(let x of _)i.push(x)}else i.push([f,m],[m,g],[g,f])}}),i}static ToVector3Array(e){if(Array.isArray(e[0])){let r=[],n=e;for(let o of n){let a=[];for(let l=0;l<o.length;l+=3)a.push(new p(o[l],o[l+1],o[l+2]));r.push(a)}return r}let t=e,i=[];for(let r=0;r<t.length;r+=3)i.push(new p(t[r],t[r+1],t[r+2]));return i}static ToNumberArray(e){return e.flatMap(t=>[t.x,t.y,t.z])}static GetPointsCountInfo(e){let t=new Array(e.length),i=0;for(let r=e.length;r--;)t[r]=e[r].length/3,i+=t[r];return{total:i,counts:t}}static GetLineLength(e){if(e.length===0)return 0;let t;typeof e[0]=="number"?t=s.ToVector3Array(e):t=e;let i=O.Vector3[0],r=0;for(let n=0;n<t.length-1;n++){let o=t[n],a=t[n+1];r+=a.subtractToRef(o,i).length()}return r}static GetLineLengthArray(e){let t=new Float32Array(e.length/3),i=0;for(let r=0,n=e.length/3-1;r<n;r++){let o=e[r*3+0],a=e[r*3+1],l=e[r*3+2];o-=e[r*3+3],a-=e[r*3+4],l-=e[r*3+5];let c=Math.sqrt(o*o+a*a+l*l);i+=c,t[r+1]=i}return t}static SegmentizeSegmentByCount(e,t,i){let r=[],n=t.subtract(e),o=O.Vector3[0];o.setAll(i);let a=O.Vector3[1];n.divideToRef(o,a);let l=e.clone();r.push(l);for(let c=0;c<i;c++)l=l.clone(),r.push(l.addInPlace(a));return r}static SegmentizeLineBySegmentLength(e,t){let i=e[0]instanceof p?s.GetLineSegments(e):typeof e[0]=="number"?s.GetLineSegments(s.ToVector3Array(e)):e,r=[];return i.forEach(n=>{n.length>t?s.SegmentizeSegmentByCount(n.point1,n.point2,Math.ceil(n.length/t)).forEach(a=>{r.push(a)}):(r.push(n.point1),r.push(n.point2))}),r}static SegmentizeLineBySegmentCount(e,t){let i=typeof e[0]=="number"?s.ToVector3Array(e):e,r=s.GetLineLength(i)/t;return s.SegmentizeLineBySegmentLength(i,r)}static GetLineSegments(e){let t=[];for(let i=0;i<e.length-1;i++){let r=e[i],n=e[i+1],o=n.subtract(r).length();t.push({point1:r,point2:n,length:o})}return t}static GetMinMaxSegmentLength(e){let i=s.GetLineSegments(e).sort(r=>r.length);return{min:i[0].length,max:i[i.length-1].length}}static GetPositionOnLineByVisibility(e,t,i,r=!1){let n=t*i,o=0,a=0,l=e.length;for(let h=0;h<l;h++){if(n<=o+e[h].length){a=h;break}o+=e[h].length}let c=(n-o)/e[a].length;return e[a].point2.subtractToRef(e[a].point1,O.Vector3[0]),O.Vector3[1]=O.Vector3[0].multiplyByFloats(c,c,c),r||O.Vector3[1].addInPlace(e[a].point1),O.Vector3[1].clone()}static GetCircleLinePoints(e,t,i=0,r=e,n=Math.PI*2/t){let o=[];for(let a=0;a<=t;a++)o.push(new p(Math.cos(a*n)*e,Math.sin(a*n)*r,i));return o}static GetBezierLinePoints(e,t,i,r){return cd.CreateQuadraticBezier(e,t,i,r).getPoints().flatMap(n=>[n.x,n.y,n.z])}static GetArrowCap(e,t,i,r,n,o=0,a=0){return{points:[e.clone(),e.add(t.multiplyByFloats(i,i,i))],widths:[r,n,o,a]}}static GetPointsFromText(e,t,i,r,n=0,o=!0){let a=[],l=IB(e,t,i,r);for(let c of l){for(let h of c.paths){let u=[],d=h.getPoints();for(let f of d)u.push(f.x,f.y,n);a.push(u)}if(o)for(let h of c.holes){let u=[],d=h.getPoints();for(let f of d)u.push(f.x,f.y,n);a.push(u)}}return a}static Color3toRGBAUint8(e){let t=new Uint8Array(e.length*4);for(let i=0,r=0;i<e.length;i++)t[r++]=e[i].r*255,t[r++]=e[i].g*255,t[r++]=e[i].b*255,t[r++]=255;return t}static CreateColorsTexture(e,t,i,r){let n=r.getEngine().getCaps().maxTextureSize??1,o=t.length>n?n:t.length,a=Math.ceil(t.length/n);a>1&&(t=[...t,...Array(o*a-t.length).fill(t[0])]);let l=s.Color3toRGBAUint8(t),c=new xi(l,o,a,K.TEXTUREFORMAT_RGBA,r,!1,!0,i);return c.name=e,c}static PrepareEmptyColorsTexture(e){if(!rr.EmptyColorsTexture){let t=new Uint8Array(4);rr.EmptyColorsTexture=new xi(t,1,1,K.TEXTUREFORMAT_RGBA,e,!1,!1,xi.NEAREST_NEAREST),rr.EmptyColorsTexture.name="grlEmptyColorsTexture"}return rr.EmptyColorsTexture}static DisposeEmptyColorsTexture(){rr.EmptyColorsTexture?.dispose(),rr.EmptyColorsTexture=null}static BooleanToNumber(e){return e?1:0}};var sP=class extends Qt{constructor(){super(...arguments),this.GREASED_LINE_HAS_COLOR=!1,this.GREASED_LINE_SIZE_ATTENUATION=!1,this.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=!1,this.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=!1,this.GREASED_LINE_CAMERA_FACING=!0}},Wm=(()=>{class s extends Ti{constructor(t,i,r){r=r||{color:rr.DEFAULT_COLOR};let n=new sP;n.GREASED_LINE_HAS_COLOR=!!r.color&&!r.useColors,n.GREASED_LINE_SIZE_ATTENUATION=r.sizeAttenuation??!1,n.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=r.colorDistributionType===Sa.COLOR_DISTRIBUTION_TYPE_LINE,n.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=(i??t.getScene()).useRightHandedSystem,n.GREASED_LINE_CAMERA_FACING=r.cameraFacing??!0,super(t,s.GREASED_LINE_MATERIAL_NAME,200,n),this.colorsTexture=null,this._scene=i??t.getScene(),this._engine=this._scene.getEngine(),this._cameraFacing=r.cameraFacing??!0,this.visibility=r.visibility??1,this.useDash=r.useDash??!1,this.dashRatio=r.dashRatio??.5,this.dashOffset=r.dashOffset??0,this.width=r.width?r.width:r.sizeAttenuation?rr.DEFAULT_WIDTH_ATTENUATED:rr.DEFAULT_WIDTH,this._sizeAttenuation=r.sizeAttenuation??!1,this.colorMode=r.colorMode??Js.COLOR_MODE_SET,this._color=r.color??null,this.useColors=r.useColors??!1,this._colorsDistributionType=r.colorDistributionType??Sa.COLOR_DISTRIBUTION_TYPE_SEGMENT,this.colorsSampling=r.colorsSampling??xi.NEAREST_NEAREST,this._colors=r.colors??null,this.dashCount=r.dashCount??1,this.resolution=r.resolution??new j(this._engine.getRenderWidth(),this._engine.getRenderHeight()),r.colorsTexture?this.colorsTexture=r.colorsTexture:this._colors?this.colorsTexture=Si.CreateColorsTexture(`${t.name}-colors-texture`,this._colors,this.colorsSampling,this._scene):(this._color=this._color??rr.DEFAULT_COLOR,Si.PrepareEmptyColorsTexture(this._scene)),this._engine.onDisposeObservable.add(()=>{Si.DisposeEmptyColorsTexture()}),this._enable(!0)}getAttributes(t){t.push("grl_offsets"),t.push("grl_widths"),t.push("grl_colorPointers"),t.push("grl_counters"),this._cameraFacing?(t.push("grl_previousAndSide"),t.push("grl_nextAndCounters")):t.push("grl_slopes")}getSamplers(t){t.push("grl_colors")}getActiveTextures(t){this.colorsTexture&&t.push(this.colorsTexture)}getUniforms(){let t=[{name:"grl_singleColor",size:3,type:"vec3"},{name:"grl_textureSize",size:2,type:"vec2"},{name:"grl_dashOptions",size:4,type:"vec4"},{name:"grl_colorMode_visibility_colorsWidth_useColors",size:4,type:"vec4"}];return this._cameraFacing&&t.push({name:"grl_projection",size:16,type:"mat4"},{name:"grl_aspect_resolution_lineWidth",size:4,type:"vec4"}),{ubo:t,vertex:this._cameraFacing?`
                uniform vec4 grl_aspect_resolution_lineWidth;
                uniform mat4 grl_projection;
                `:"",fragment:`
                uniform vec4 grl_dashOptions;
                uniform vec2 grl_textureSize;
                uniform vec4 grl_colorMode_visibility_colorsWidth_useColors;
                uniform vec3 grl_singleColor;
                `}}get isEnabled(){return!0}bindForSubMesh(t){if(this._cameraFacing){let o=this._scene.activeCamera;if(o){let l=o.getProjectionMatrix();t.updateMatrix("grl_projection",l)}else throw Error("GreasedLinePluginMaterial requires an active camera.");let a=O.Vector4[0];a.x=this._aspect,a.y=this._resolution.x,a.z=this._resolution.y,a.w=this.width,t.updateVector4("grl_aspect_resolution_lineWidth",a)}let i=O.Vector4[0];i.x=Si.BooleanToNumber(this.useDash),i.y=this._dashArray,i.z=this.dashOffset,i.w=this.dashRatio,t.updateVector4("grl_dashOptions",i);let r=O.Vector4[1];r.x=this.colorMode,r.y=this.visibility,r.z=this.colorsTexture?this.colorsTexture.getSize().width:0,r.w=Si.BooleanToNumber(this.useColors),t.updateVector4("grl_colorMode_visibility_colorsWidth_useColors",r),this._color&&t.updateColor3("grl_singleColor",this._color);let n=this.colorsTexture??rr.EmptyColorsTexture;t.setTexture("grl_colors",n),t.updateFloat2("grl_textureSize",n?.getSize().width??1,n?.getSize().height??1)}prepareDefines(t,i,r){t.GREASED_LINE_HAS_COLOR=!!this.color&&!this.useColors,t.GREASED_LINE_SIZE_ATTENUATION=this._sizeAttenuation,t.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=this._colorsDistributionType===Sa.COLOR_DISTRIBUTION_TYPE_LINE,t.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=i.useRightHandedSystem,t.GREASED_LINE_CAMERA_FACING=this._cameraFacing}getClassName(){return s.GREASED_LINE_MATERIAL_NAME}getCustomCode(t){if(t==="vertex"){let i={CUSTOM_VERTEX_DEFINITIONS:`
                attribute float grl_widths;
                attribute vec3 grl_offsets;
                attribute float grl_colorPointers;
                varying float grlCounters;
                varying float grlColorPointer;

                #ifdef GREASED_LINE_CAMERA_FACING
                    attribute vec4 grl_previousAndSide;
                    attribute vec4 grl_nextAndCounters;

                    vec2 grlFix( vec4 i, float aspect ) {
                        vec2 res = i.xy / i.w;
                        res.x *= aspect;
                        return res;
                    }
                #else
                    attribute vec3 grl_slopes;
                    attribute float grl_counters;
                #endif
                `,CUSTOM_VERTEX_UPDATE_POSITION:`
                #ifdef GREASED_LINE_CAMERA_FACING
                    vec3 grlPositionOffset = grl_offsets;
                    positionUpdated += grlPositionOffset;
                #else
                    positionUpdated = (positionUpdated + grl_offsets) + (grl_slopes * grl_widths);
                #endif
                `,CUSTOM_VERTEX_MAIN_END:`
                grlColorPointer = grl_colorPointers;

                #ifdef GREASED_LINE_CAMERA_FACING

                    float grlAspect = grl_aspect_resolution_lineWidth.x;
                    float grlBaseWidth = grl_aspect_resolution_lineWidth.w;


                    vec3 grlPrevious = grl_previousAndSide.xyz;
                    float grlSide = grl_previousAndSide.w;

                    vec3 grlNext = grl_nextAndCounters.xyz;
                    grlCounters = grl_nextAndCounters.w;

                    mat4 grlMatrix = viewProjection * finalWorld;
                    vec4 grlFinalPosition = grlMatrix * vec4( positionUpdated , 1.0 );
                    vec4 grlPrevPos = grlMatrix * vec4( grlPrevious + grlPositionOffset, 1.0 );
                    vec4 grlNextPos = grlMatrix * vec4( grlNext + grlPositionOffset, 1.0 );

                    vec2 grlCurrentP = grlFix( grlFinalPosition, grlAspect );
                    vec2 grlPrevP = grlFix( grlPrevPos, grlAspect );
                    vec2 grlNextP = grlFix( grlNextPos, grlAspect );

                    float grlWidth = grlBaseWidth * grl_widths;

                    vec2 grlDir;
                    if( grlNextP == grlCurrentP ) grlDir = normalize( grlCurrentP - grlPrevP );
                    else if( grlPrevP == grlCurrentP ) grlDir = normalize( grlNextP - grlCurrentP );
                    else {
                        vec2 grlDir1 = normalize( grlCurrentP - grlPrevP );
                        vec2 grlDir2 = normalize( grlNextP - grlCurrentP );
                        grlDir = normalize( grlDir1 + grlDir2 );
                    }
                    vec4 grlNormal = vec4( -grlDir.y, grlDir.x, 0., 1. );
                    #ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM
                        grlNormal.xy *= -.5 * grlWidth;
                    #else
                        grlNormal.xy *= .5 * grlWidth;
                    #endif

                    grlNormal *= grl_projection;

                    #ifdef GREASED_LINE_SIZE_ATTENUATION
                        grlNormal.xy *= grlFinalPosition.w;
                        grlNormal.xy /= ( vec4( grl_aspect_resolution_lineWidth.yz, 0., 1. ) * grl_projection ).xy;
                    #endif

                    grlFinalPosition.xy += grlNormal.xy * grlSide;
                    gl_Position = grlFinalPosition;

                    vPositionW = vec3(grlFinalPosition);
                #else
                    grlCounters = grl_counters;
                #endif
                `};return this._cameraFacing&&(i["!gl_Position\\=viewProjection\\*worldPos;"]="//"),i}return t==="fragment"?{CUSTOM_FRAGMENT_DEFINITIONS:`
                    varying float grlCounters;
                    varying float grlColorPointer;
                    uniform sampler2D grl_colors;
                `,CUSTOM_FRAGMENT_MAIN_END:`
                    float grlColorMode = grl_colorMode_visibility_colorsWidth_useColors.x;
                    float grlVisibility = grl_colorMode_visibility_colorsWidth_useColors.y;
                    float grlColorsWidth = grl_colorMode_visibility_colorsWidth_useColors.z;
                    float grlUseColors = grl_colorMode_visibility_colorsWidth_useColors.w;

                    float grlUseDash = grl_dashOptions.x;
                    float grlDashArray = grl_dashOptions.y;
                    float grlDashOffset = grl_dashOptions.z;
                    float grlDashRatio = grl_dashOptions.w;

                    gl_FragColor.a *= step(grlCounters, grlVisibility);
                    if( gl_FragColor.a == 0. ) discard;

                    if(grlUseDash == 1.){
                        gl_FragColor.a *= ceil(mod(grlCounters + grlDashOffset, grlDashArray) - (grlDashArray * grlDashRatio));
                        if (gl_FragColor.a == 0.) discard;
                    }

                    #ifdef GREASED_LINE_HAS_COLOR
                        if (grlColorMode == ${Js.COLOR_MODE_SET}.) {
                            gl_FragColor.rgb = grl_singleColor;
                        } else if (grlColorMode == ${Js.COLOR_MODE_ADD}.) {
                            gl_FragColor.rgb += grl_singleColor;
                        } else if (grlColorMode == ${Js.COLOR_MODE_MULTIPLY}.) {
                            gl_FragColor.rgb *= grl_singleColor;
                        }
                    #else
                        if (grlUseColors == 1.) {
                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE
                                vec4 grlColor = texture2D(grl_colors, vec2(grlCounters, 0.), 0.);
                            #else
                                vec2 lookup = vec2(fract(grlColorPointer / grl_textureSize.x), 1.0 - floor(grlColorPointer / grl_textureSize.x) / max(grl_textureSize.y - 1.0, 1.0));
                                vec4 grlColor = texture2D(grl_colors, lookup, 0.0);
                            #endif
                            if (grlColorMode == ${Js.COLOR_MODE_SET}.) {
                                gl_FragColor = grlColor;
                            } else if (grlColorMode == ${Js.COLOR_MODE_ADD}.) {
                                gl_FragColor += grlColor;
                            } else if (grlColorMode == ${Js.COLOR_MODE_MULTIPLY}.) {
                                gl_FragColor *= grlColor;
                            }
                        }
                    #endif

                `}:null}dispose(){this.colorsTexture?.dispose(),super.dispose()}get colors(){return this._colors}set colors(t){this.setColors(t)}setColors(t,i=!1,r=!1){let n=this._colors?.length??0;if(this._colors=t,t===null||t.length===0){this.colorsTexture?.dispose();return}if(!(i&&!r))if(this.colorsTexture&&n===t.length&&!r){let o=Si.Color3toRGBAUint8(t);this.colorsTexture.update(o)}else this.colorsTexture?.dispose(),this.colorsTexture=Si.CreateColorsTexture(`${this._material.name}-colors-texture`,t,this.colorsSampling,this._scene)}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get dashCount(){return this._dashCount}set dashCount(t){this._dashCount=t,this._dashArray=1/t}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(t){this._sizeAttenuation=t,this.markAllDefinesAsDirty()}get color(){return this._color}set color(t){this.setColor(t)}setColor(t,i=!1){this._color===null&&t!==null||this._color!==null&&t===null?(this._color=t,!i&&this.markAllDefinesAsDirty()):this._color=t}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(t){this._colorsDistributionType=t,this.markAllDefinesAsDirty()}get resolution(){return this._resolution}set resolution(t){this._aspect=t.x/t.y,this._resolution=t}serialize(){let t=super.serialize(),i={colorDistributionType:this._colorsDistributionType,colorsSampling:this.colorsSampling,colorMode:this.colorMode,dashCount:this._dashCount,dashOffset:this.dashOffset,dashRatio:this.dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this.useColors,useDash:this.useDash,visibility:this.visibility,width:this.width};return this._colors&&(i.colors=this._colors),this._color&&(i.color=this._color),t.greasedLineMaterialOptions=i,t}parse(t,i,r){super.parse(t,i,r);let n=t.greasedLineMaterialOptions;this.colorsTexture?.dispose(),n.color&&this.setColor(n.color,!0),n.colorDistributionType&&(this.colorsDistributionType=n.colorDistributionType),n.colors&&(this.colors=n.colors),n.colorsSampling&&(this.colorsSampling=n.colorsSampling),n.colorMode&&(this.colorMode=n.colorMode),n.useColors&&(this.useColors=n.useColors),n.visibility&&(this.visibility=n.visibility),n.useDash&&(this.useDash=n.useDash),n.dashCount&&(this.dashCount=n.dashCount),n.dashRatio&&(this.dashRatio=n.dashRatio),n.dashOffset&&(this.dashOffset=n.dashOffset),n.width&&(this.width=n.width),n.sizeAttenuation&&(this.sizeAttenuation=n.sizeAttenuation),n.resolution&&(this.resolution=n.resolution),this.colors?this.colorsTexture=Si.CreateColorsTexture(`${this._material.name}-colors-texture`,this.colors,this.colorsSampling,i):Si.PrepareEmptyColorsTexture(i),this.markAllDefinesAsDirty()}copyTo(t){let i=t;i.colorsTexture?.dispose(),this._colors&&(i.colorsTexture=Si.CreateColorsTexture(`${i._material.name}-colors-texture`,this._colors,i.colorsSampling,this._scene)),i.setColor(this.color,!0),i.colorsDistributionType=this.colorsDistributionType,i.colorsSampling=this.colorsSampling,i.colorMode=this.colorMode,i.useColors=this.useColors,i.visibility=this.visibility,i.useDash=this.useDash,i.dashCount=this.dashCount,i.dashRatio=this.dashRatio,i.dashOffset=this.dashOffset,i.width=this.width,i.sizeAttenuation=this.sizeAttenuation,i.resolution=this.resolution,i.markAllDefinesAsDirty()}}return s.GREASED_LINE_MATERIAL_NAME="GreasedLinePluginMaterial",s})();P(`BABYLON.${Wm.GREASED_LINE_MATERIAL_NAME}`,Wm);var mQ="greasedLinePixelShader",gQ=`precision highp float;uniform sampler2D grlColors;uniform float grlUseColors;uniform float grlUseDash;uniform float grlDashArray;uniform float grlDashOffset;uniform float grlDashRatio;uniform float grlVisibility;uniform float grlColorsWidth;uniform vec2 grl_colorModeAndColorDistributionType;uniform vec3 grlColor;varying float grlCounters;varying float grlColorPointer;void main() {float grlColorMode=grl_colorModeAndColorDistributionType.x;float grlColorDistributionType=grl_colorModeAndColorDistributionType.y;gl_FragColor=vec4(grlColor,1.);gl_FragColor.a=step(grlCounters,grlVisibility);if (gl_FragColor.a==0.) discard;if( grlUseDash==1. ){gl_FragColor.a=ceil(mod(grlCounters+grlDashOffset,grlDashArray)-(grlDashArray*grlDashRatio));if (gl_FragColor.a==0.) discard;}
if (grlUseColors==1.) {vec4 textureColor;if (grlColorDistributionType==COLOR_DISTRIBUTION_TYPE_LINE) { 
textureColor=texture2D(grlColors,vec2(grlCounters,0.),0.);} else {textureColor=texture2D(grlColors,vec2(grlColorPointer/grlColorsWidth,0.),0.);}
if (grlColorMode==COLOR_MODE_SET) {gl_FragColor=textureColor;} else if (grlColorMode==COLOR_MODE_ADD) {gl_FragColor+=textureColor;} else if (grlColorMode==COLOR_MODE_MULTIPLY) {gl_FragColor*=textureColor;}}}
`;D.ShadersStore[mQ]=gQ;var _Q="greasedLineVertexShader",xQ=`precision highp float;
#include<instancesDeclaration>
attribute float grl_widths;attribute vec3 grl_offsets;attribute float grl_colorPointers;attribute vec3 position;uniform mat4 viewProjection;uniform mat4 projection;varying float grlCounters;varying float grlColorPointer;
#ifdef GREASED_LINE_CAMERA_FACING
attribute vec4 grl_nextAndCounters;attribute vec4 grl_previousAndSide;uniform vec2 grlResolution;uniform float grlAspect;uniform float grlWidth;uniform float grlSizeAttenuation;vec2 grlFix( vec4 i,float aspect ) {vec2 res=i.xy/i.w;res.x*=aspect;return res;}
#else
attribute vec3 grl_slopes;attribute float grl_counters;
#endif
void main() {
#include<instancesVertex>
grlColorPointer=grl_colorPointers;mat4 grlMatrix=viewProjection*finalWorld ;
#ifdef GREASED_LINE_CAMERA_FACING
float grlBaseWidth=grlWidth;vec3 grlPrevious=grl_previousAndSide.xyz;float grlSide=grl_previousAndSide.w;vec3 grlNext=grl_nextAndCounters.xyz;grlCounters=grl_nextAndCounters.w;vec3 grlPositionOffset=grl_offsets;vec4 grlFinalPosition=grlMatrix*vec4( position+grlPositionOffset ,1.0 );vec4 grlPrevPos=grlMatrix*vec4( grlPrevious+grlPositionOffset,1.0 );vec4 grlNextPos=grlMatrix*vec4( grlNext+grlPositionOffset,1.0 );vec2 grlCurrentP=grlFix( grlFinalPosition,grlAspect );vec2 grlPrevP=grlFix( grlPrevPos,grlAspect );vec2 grlNextP=grlFix( grlNextPos,grlAspect );float grlWidth=grlBaseWidth*grl_widths;vec2 grlDir;if( grlNextP==grlCurrentP ) grlDir=normalize( grlCurrentP-grlPrevP );else if( grlPrevP==grlCurrentP ) grlDir=normalize( grlNextP-grlCurrentP );else {vec2 grlDir1=normalize( grlCurrentP-grlPrevP );vec2 grlDir2=normalize( grlNextP-grlCurrentP );grlDir=normalize( grlDir1+grlDir2 );}
vec4 grlNormal=vec4( -grlDir.y,grlDir.x,0.,1. );
#ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM
grlNormal.xy*=-.5*grlWidth;
#else
grlNormal.xy*=.5*grlWidth;
#endif
grlNormal*=projection;if (grlSizeAttenuation==1.) {grlNormal.xy*=grlFinalPosition.w;grlNormal.xy/=( vec4( grlResolution,0.,1. )*projection ).xy;}
grlFinalPosition.xy+=grlNormal.xy*grlSide;gl_Position=grlFinalPosition;
#else
grlCounters=grl_counters;vec4 grlFinalPosition=grlMatrix*vec4( (position+grl_offsets)+grl_slopes*grl_widths ,1.0 ) ;gl_Position=grlFinalPosition;
#endif
}
`;D.ShadersStore[_Q]=xQ;var Hm=class extends Fi{constructor(e,t,i){let r=[`COLOR_DISTRIBUTION_TYPE_LINE ${Sa.COLOR_DISTRIBUTION_TYPE_LINE}.`,`COLOR_DISTRIBUTION_TYPE_SEGMENT ${Sa.COLOR_DISTRIBUTION_TYPE_SEGMENT}.`,`COLOR_MODE_SET ${Js.COLOR_MODE_SET}.`,`COLOR_MODE_ADD ${Js.COLOR_MODE_ADD}.`,`COLOR_MODE_MULTIPLY ${Js.COLOR_MODE_MULTIPLY}.`],n=["position","grl_widths","grl_offsets","grl_colorPointers"];t.useRightHandedSystem&&r.push("GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM"),i.cameraFacing?(r.push("GREASED_LINE_CAMERA_FACING"),n.push("grl_previousAndSide","grl_nextAndCounters")):(n.push("grl_slopes"),n.push("grl_counters")),super(e,t,{vertex:"greasedLine",fragment:"greasedLine"},{attributes:n,uniforms:["world","viewProjection","view","projection","grlColorsWidth","grlUseColors","grlWidth","grlColor","grl_colorModeAndColorDistributionType","grlResolution","grlAspect","grlAizeAttenuation","grlDashArray","grlDashOffset","grlDashRatio","grlUseDash","grlVisibility"],samplers:["grlColors"],defines:r}),this._color=X.White(),this._colorsDistributionType=Sa.COLOR_DISTRIBUTION_TYPE_SEGMENT,this._colorsTexture=null,i=i||{color:rr.DEFAULT_COLOR};let o=t.getEngine();this.visibility=i.visibility??1,this.useDash=i.useDash??!1,this.dashRatio=i.dashRatio??.5,this.dashOffset=i.dashOffset??0,this.dashCount=i.dashCount??1,this.width=i.width?i.width:i.sizeAttenuation&&i.cameraFacing?rr.DEFAULT_WIDTH_ATTENUATED:rr.DEFAULT_WIDTH,this.sizeAttenuation=i.sizeAttenuation??!1,this.color=i.color??X.White(),this.useColors=i.useColors??!1,this.colorsDistributionType=i.colorDistributionType??Sa.COLOR_DISTRIBUTION_TYPE_SEGMENT,this.colorsSampling=i.colorsSampling??xi.NEAREST_NEAREST,this.colorMode=i.colorMode??Js.COLOR_MODE_SET,this._colors=i.colors??null,this._cameraFacing=i.cameraFacing??!0,this.resolution=i.resolution??new j(o.getRenderWidth(),o.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this.colorsTexture=Si.PrepareEmptyColorsTexture(t),this._colors&&this.setColors(this._colors),o.onDisposeObservable.add(()=>{Si.DisposeEmptyColorsTexture()})}dispose(){this._colorsTexture?.dispose(),super.dispose()}_setColorModeAndColorDistributionType(){this.setVector2("grl_colorModeAndColorDistributionType",new j(this._colorMode,this._colorsDistributionType))}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){let r=this._colors?.length??0;if(this._colors=e,e===null||e.length===0){this._colorsTexture?.dispose();return}if(!(t&&!i))if(this._colorsTexture&&r===e.length&&!i){let n=Si.Color3toRGBAUint8(e);this._colorsTexture.update(n)}else this._colorsTexture?.dispose(),this.colorsTexture=Si.CreateColorsTexture(`${this.name}-colors-texture`,e,this.colorsSampling,this.getScene())}get colorsTexture(){return this._colorsTexture??null}set colorsTexture(e){this._colorsTexture=e,this.setFloat("grlColorsWidth",this._colorsTexture.getSize().width),this.setTexture("grlColors",this._colorsTexture)}get width(){return this._width}set width(e){this._width=e,this.setFloat("grlWidth",e)}get useColors(){return this._useColors}set useColors(e){this._useColors=e,this.setFloat("grlUseColors",Si.BooleanToNumber(e))}get colorsSampling(){return this._colorsSampling}set colorsSampling(e){this._colorsSampling=e}get visibility(){return this._visibility}set visibility(e){this._visibility=e,this.setFloat("grlVisibility",e)}get useDash(){return this._useDash}set useDash(e){this._useDash=e,this.setFloat("grlUseDash",Si.BooleanToNumber(e))}get dashOffset(){return this._dashOffset}set dashOffset(e){this._dashOffset=e,this.setFloat("grlDashOffset",e)}get dashRatio(){return this._dashRatio}set dashRatio(e){this._dashRatio=e,this.setFloat("grlDashRatio",e)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e,this.setFloat("grlDashArray",this._dashArray)}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.setFloat("grlSizeAttenuation",Si.BooleanToNumber(e))}get color(){return this.color}set color(e){this.setColor(e)}setColor(e){e=e??rr.DEFAULT_COLOR,this._color=e,this.setColor3("grlColor",e)}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this._setColorModeAndColorDistributionType()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=e,this._setColorModeAndColorDistributionType()}get resolution(){return this._resolution}set resolution(e){this._resolution=e,this.setVector2("grlResolution",e),this.setFloat("grlAspect",e.x/e.y)}serialize(){let e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this._colorsSampling,colorMode:this._colorMode,color:this._color,dashCount:this._dashCount,dashOffset:this._dashOffset,dashRatio:this._dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this._useColors,useDash:this._useDash,visibility:this._visibility,width:this._width,cameraFacing:this._cameraFacing};return this._colors&&(t.colors=this._colors),e.greasedLineMaterialOptions=t,e}parse(e,t,i){let r=e.greasedLineMaterialOptions;this._colorsTexture?.dispose(),r.color&&(this.color=r.color),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),r.colors?this.colorsTexture=Si.CreateColorsTexture(`${this.name}-colors-texture`,r.colors,this.colorsSampling,this.getScene()):this.colorsTexture=Si.PrepareEmptyColorsTexture(t),this._cameraFacing=r.cameraFacing??!0,this.setDefine("GREASED_LINE_CAMERA_FACING",this._cameraFacing)}};var vQ=`#if defined(DBG_ENABLED)
attribute float dbg_initialPass;
varying vec3 dbg_vBarycentric;
flat varying vec3 dbg_vVertexWorldPos;
flat varying float dbg_vPass;
#endif`,TQ=`#if defined(DBG_ENABLED)
float dbg_vertexIndex = mod(float(gl_VertexID), 3.);
if (dbg_vertexIndex == 0.0) { 
    dbg_vBarycentric = vec3(1.,0.,0.); 
}
else if (dbg_vertexIndex == 1.0) { 
    dbg_vBarycentric = vec3(0.,1.,0.); 
}
else { 
    dbg_vBarycentric = vec3(0.,0.,1.); 
}

dbg_vVertexWorldPos = vPositionW;
dbg_vPass = dbg_initialPass;
#endif`,CQ=`#if defined(DBG_ENABLED)
uniform vec3 dbg_shadedDiffuseColor;
uniform vec4 dbg_shadedSpecularColorPower;
uniform vec3 dbg_thicknessRadiusScale;

#if DBG_MODE == 2 || DBG_MODE == 3
    uniform vec3 dbg_vertexColor;
#endif

#if DBG_MODE == 1
    uniform vec3 dbg_wireframeTrianglesColor;
#elif DBG_MODE == 3
    uniform vec3 dbg_wireframeVerticesColor;
#elif DBG_MODE == 4 || DBG_MODE == 5
    uniform vec3 dbg_uvPrimaryColor;
    uniform vec3 dbg_uvSecondaryColor;
#elif DBG_MODE == 7
    uniform vec3 dbg_materialColor;
#endif
#endif`,bQ=`#if defined(DBG_ENABLED)
varying vec3 dbg_vBarycentric;
flat varying vec3 dbg_vVertexWorldPos;
flat varying float dbg_vPass;

#if !defined(DBG_MULTIPLY)
    vec3 dbg_applyShading(vec3 color) {
        vec3 N = vNormalW.xyz;
        vec3 L = normalize(vEyePosition.xyz - vPositionW.xyz);
        vec3 H = normalize(L + L);
        float LdotN = clamp(dot(L,N), 0., 1.);
        float HdotN = clamp(dot(H,N), 0., 1.);
        float specTerm = pow(HdotN, dbg_shadedSpecularColorPower.w);
        color *= (LdotN / PI);
        color += dbg_shadedSpecularColorPower.rgb * (specTerm / PI);
        return color;
    }
#endif

#if DBG_MODE == 1 || DBG_MODE == 3
    float dbg_edgeFactor() {
        vec3 d = fwidth(dbg_vBarycentric);
        vec3 a3 = smoothstep(vec3(0.), d * dbg_thicknessRadiusScale.x, dbg_vBarycentric);
        return min(min(a3.x, a3.y), a3.z);
    }
#endif

#if DBG_MODE == 2 || DBG_MODE == 3
    float dbg_cornerFactor() {
        vec3 worldPos = vPositionW;
        float dist = length(worldPos - dbg_vVertexWorldPos);
        float camDist = length(worldPos - vEyePosition.xyz);
        float d = sqrt(camDist) * .001;
        return smoothstep((dbg_thicknessRadiusScale.y * d), ((dbg_thicknessRadiusScale.y * 1.01) * d), dist);
    }
#endif

#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))
    float dbg_checkerboardFactor(vec2 uv) {
        vec2 f = fract(uv * dbg_thicknessRadiusScale.z);
        f -= .5;
        return (f.x * f.y) > 0. ? 1. : 0.;
    }
#endif
#endif`,SQ=`#if defined(DBG_ENABLED)
vec3 dbg_color = vec3(1.);
#if DBG_MODE == 1
    dbg_color = mix(dbg_wireframeTrianglesColor, vec3(1.), dbg_edgeFactor());
#elif DBG_MODE == 2 || DBG_MODE == 3
    float dbg_cornerFactor = dbg_cornerFactor();
    if (dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;
    dbg_color = mix(dbg_vertexColor, vec3(1.), dbg_cornerFactor);
    #if DBG_MODE == 3
        dbg_color *= mix(dbg_wireframeVerticesColor, vec3(1.), dbg_edgeFactor());
    #endif
#elif DBG_MODE == 4 && defined(MAINUV1)
    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV1));
#elif DBG_MODE == 5 && defined(MAINUV2)
    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV2));
#elif DBG_MODE == 6 && defined(VERTEXCOLOR)
    dbg_color = vColor.rgb;
#elif DBG_MODE == 7
    dbg_color = dbg_materialColor;
#endif

#if defined(DBG_MULTIPLY)
    gl_FragColor *= vec4(dbg_color, 1.);
#else
    #if DBG_MODE != 6
        gl_FragColor = vec4(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);
    #else
        gl_FragColor = vec4(dbg_color, 1.);
    #endif
#endif
#endif`,DV=[new X(.98,.26,.38),new X(.47,.75,.3),new X(0,.26,.77),new X(.97,.6,.76),new X(.19,.63,.78),new X(.98,.8,.6),new X(.65,.43,.15),new X(.15,.47,.22),new X(.67,.71,.86),new X(.09,.46,.56),new X(.8,.98,.02),new X(.39,.29,.13),new X(.53,.63,.06),new X(.95,.96,.41),new X(1,.72,.94),new X(.63,.08,.31),new X(.66,.96,.95),new X(.22,.14,.19),new X(.14,.65,.59),new X(.93,1,.68),new X(.93,.14,.44),new X(.47,.86,.67),new X(.85,.07,.78),new X(.53,.64,.98),new X(.43,.37,.56),new X(.71,.65,.25),new X(.66,.19,.01),new X(.94,.53,.12),new X(.41,.44,.44),new X(.24,.71,.96),new X(.57,.28,.56),new X(.44,.98,.42)],Xm=function(s){return s[s.NONE=0]="NONE",s[s.TRIANGLES=1]="TRIANGLES",s[s.VERTICES=2]="VERTICES",s[s.TRIANGLES_VERTICES=3]="TRIANGLES_VERTICES",s[s.UV0=4]="UV0",s[s.UV1=5]="UV1",s[s.VERTEXCOLORS=6]="VERTEXCOLORS",s[s.MATERIALIDS=7]="MATERIALIDS",s}(Xm||{}),nP=class extends Qt{constructor(){super(...arguments),this.DBG_MODE=Xm.NONE,this.DBG_MULTIPLY=!0,this.DBG_ENABLED=!0}},wr=class s extends Ti{_markAllDefinesAsDirty(){this._enable(this._isEnabled),this.markAllDefinesAsDirty()}constructor(e,t={}){let i=new nP;i.DBG_MODE=t.mode??i.DBG_MODE,i.DBG_MULTIPLY=t.multiply??i.DBG_MULTIPLY,super(e,"MeshDebug",200,i,!0,!0),this._mode=i.DBG_MODE,this._multiply=i.DBG_MULTIPLY,this.shadedDiffuseColor=t.shadedDiffuseColor??new X(1,1,1),this.shadedSpecularColor=t.shadedSpecularColor??new X(.8,.8,.8),this.shadedSpecularPower=t.shadedSpecularPower??10,this.wireframeThickness=t.wireframeThickness??.7,this.wireframeTrianglesColor=t.wireframeTrianglesColor??new X(0,0,0),this.wireframeVerticesColor=t.wireframeVerticesColor??new X(.8,.8,.8),this.vertexColor=t.vertexColor??new X(0,0,0),this.vertexRadius=t.vertexRadius??1.2,this.uvScale=t.uvScale??20,this.uvPrimaryColor=t.uvPrimaryColor??new X(1,1,1),this.uvSecondaryColor=t.uvSecondaryColor??new X(.5,.5,.5),this._materialColor=s.MaterialColors[s._PluginCount++%s.MaterialColors.length],this.isEnabled=!0}getClassName(){return"MeshDebugPluginMaterial"}get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled!==e){if(!this._material.getScene().getEngine().isWebGPU&&this._material.getScene().getEngine().version==1){F.Error("MeshDebugPluginMaterial is not supported on WebGL 1.0."),this._isEnabled=!1;return}this._isEnabled=e,this._markAllDefinesAsDirty()}}prepareDefines(e,t,i){(this._mode==Xm.VERTICES||this._mode==Xm.TRIANGLES||this._mode==Xm.TRIANGLES_VERTICES)&&!i.isVerticesDataPresent("dbg_initialPass")&&F.Warn("For best results with TRIANGLES, TRIANGLES_VERTICES, or VERTICES modes, please use MeshDebugPluginMaterial.PrepareMeshForTrianglesAndVerticesMode() on mesh.",1),e.DBG_MODE=this._mode,e.DBG_MULTIPLY=this._multiply,e.DBG_ENABLED=this._isEnabled}getAttributes(e){e.push("dbg_initialPass")}getUniforms(){return{ubo:[{name:"dbg_shadedDiffuseColor",size:3,type:"vec3"},{name:"dbg_shadedSpecularColorPower",size:4,type:"vec4"},{name:"dbg_thicknessRadiusScale",size:3,type:"vec3"},{name:"dbg_wireframeTrianglesColor",size:3,type:"vec3"},{name:"dbg_wireframeVerticesColor",size:3,type:"vec3"},{name:"dbg_vertexColor",size:3,type:"vec3"},{name:"dbg_uvPrimaryColor",size:3,type:"vec3"},{name:"dbg_uvSecondaryColor",size:3,type:"vec3"},{name:"dbg_materialColor",size:3,type:"vec3"}],fragment:CQ}}bindForSubMesh(e){this._isEnabled&&(e.updateFloat3("dbg_shadedDiffuseColor",this.shadedDiffuseColor.r,this.shadedDiffuseColor.g,this.shadedDiffuseColor.b),e.updateFloat4("dbg_shadedSpecularColorPower",this.shadedSpecularColor.r,this.shadedSpecularColor.g,this.shadedSpecularColor.b,this.shadedSpecularPower),e.updateFloat3("dbg_thicknessRadiusScale",this.wireframeThickness,this.vertexRadius,this.uvScale),e.updateColor3("dbg_wireframeTrianglesColor",this.wireframeTrianglesColor),e.updateColor3("dbg_wireframeVerticesColor",this.wireframeVerticesColor),e.updateColor3("dbg_vertexColor",this.vertexColor),e.updateColor3("dbg_uvPrimaryColor",this.uvPrimaryColor),e.updateColor3("dbg_uvSecondaryColor",this.uvSecondaryColor),e.updateColor3("dbg_materialColor",this._materialColor))}getCustomCode(e){return e==="vertex"?{CUSTOM_VERTEX_DEFINITIONS:vQ,CUSTOM_VERTEX_MAIN_END:TQ}:{CUSTOM_FRAGMENT_DEFINITIONS:bQ,CUSTOM_FRAGMENT_MAIN_END:SQ}}static Reset(){this._PluginCount=0,this.MaterialColors=DV}static PrepareMeshForTrianglesAndVerticesMode(e,t=!1){let i=()=>{};if(e.getTotalIndices()==0)return i;if(t){let h=e.getVerticesDataKinds(),u=e.getIndices(),d={};for(let f of h)d[f]=e.getVerticesData(f);i=function(){e.setIndices(u);for(let f of h){let m=e.getVertexBuffer(f).getStrideSize();e.setVerticesData(f,d[f],void 0,m)}e.removeVerticesData("dbg_initialPass")}}let r=Array.from(e.getIndices()),n=[];for(let h=0;h<r.length;h+=3)n.push(r[h+1],r[h+2],r[h+0]);e.setIndices(r.concat(n)),e.convertToUnIndexedMesh(),e.isUnIndexed=!1,r=Array.from(e.getIndices());let o=[];for(let h=r.length/2;h<r.length;h+=3)o.push(r[h+1],r[h+2],r[h+0]);e.setIndices(r.concat(o));let a=e.getTotalVertices(),l=a/2,c=new Array(a).fill(1,0,l).fill(0,l,a);return e.setVerticesData("dbg_initialPass",c,!1,1),i}};wr._PluginCount=0;wr.MaterialColors=DV;v([At()],wr.prototype,"_materialColor",void 0);v([I()],wr.prototype,"_isEnabled",void 0);v([I(),Q("_markAllDefinesAsDirty")],wr.prototype,"mode",void 0);v([I(),Q("_markAllDefinesAsDirty")],wr.prototype,"multiply",void 0);v([At()],wr.prototype,"shadedDiffuseColor",void 0);v([At()],wr.prototype,"shadedSpecularColor",void 0);v([I()],wr.prototype,"shadedSpecularPower",void 0);v([I()],wr.prototype,"wireframeThickness",void 0);v([At()],wr.prototype,"wireframeTrianglesColor",void 0);v([At()],wr.prototype,"wireframeVerticesColor",void 0);v([At()],wr.prototype,"vertexColor",void 0);v([I()],wr.prototype,"vertexRadius",void 0);v([I()],wr.prototype,"uvScale",void 0);v([At()],wr.prototype,"uvPrimaryColor",void 0);v([At()],wr.prototype,"uvSecondaryColor",void 0);P("BABYLON.MeshDebugPluginMaterial",wr);var yQ="gaussianSplattingPixelShader",EQ=`#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
varying vec4 vColor;varying vec2 vPosition;void main () { 
#include<clipPlaneFragment>
float A=-dot(vPosition,vPosition);if (A<-4.0) discard;float B=exp(A)*vColor.a;
#include<logDepthFragment>
vec3 color=vColor.rgb;
#ifdef FOG
#include<fogFragment>
#endif
gl_FragColor=vec4(color,B);}
`;D.ShadersStore[yQ]=EQ;var AQ="gaussianSplattingVertexDeclaration",IQ=`uniform mat4 world;uniform mat4 view;uniform mat4 projection;
`;D.IncludesShadersStore[AQ]=IQ;var RQ="gaussianSplattingUboDeclaration",PQ=`#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;D.IncludesShadersStore[RQ]=PQ;var MQ="gaussianSplattingVertexShader",DQ=`#include<__decl__gaussianSplattingVertex>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
attribute vec2 position;attribute float splatIndex;uniform vec2 invViewport;uniform vec2 dataTextureSize;uniform vec2 focal;uniform sampler2D covariancesATexture;uniform sampler2D covariancesBTexture;uniform sampler2D centersTexture;uniform sampler2D colorsTexture;varying vec4 vColor;varying vec2 vPosition;
#if !defined(WEBGL2) && !defined(WEBGPU) && !defined(NATIVE)
mat3 transpose(mat3 matrix) {return mat3(matrix[0][0],matrix[1][0],matrix[2][0],
matrix[0][1],matrix[1][1],matrix[2][1],
matrix[0][2],matrix[1][2],matrix[2][2]);}
#endif
vec2 getDataUV(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return vec2((x+0.5)/textureSize.x,(y+0.5)/textureSize.y);}
void main () {vec2 splatUV=getDataUV(splatIndex,dataTextureSize);vec3 center=texture2D(centersTexture,splatUV).xyz;vec4 color=texture2D(colorsTexture,splatUV);vec3 covA=texture2D(covariancesATexture,splatUV).xyz;vec3 covB=texture2D(covariancesBTexture,splatUV).xyz;vec4 worldPos=world*vec4(center,1.0);mat4 modelView=view*world;vec4 camspace=view*worldPos;vec4 pos2d=projection*camspace;float bounds=1.2*pos2d.w;if (pos2d.z<-pos2d.w || pos2d.x<-bounds || pos2d.x>bounds
|| pos2d.y<-bounds || pos2d.y>bounds) {gl_Position=vec4(0.0,0.0,2.0,1.0);return;}
mat3 Vrk=mat3(
covA.x,covA.y,covA.z,
covA.y,covB.x,covB.y,
covA.z,covB.y,covB.z
);mat3 J=mat3(
focal.x/camspace.z,0.,-(focal.x*camspace.x)/(camspace.z*camspace.z),
0.,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),
0.,0.,0.
);mat3 invy=mat3(1,0,0,0,-1,0,0,0,1);mat3 T=invy*transpose(mat3(modelView))*J;mat3 cov2d=transpose(T)*Vrk*T;float mid=(cov2d[0][0]+cov2d[1][1])/2.0;float radius=length(vec2((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));float lambda1=mid+radius,lambda2=mid-radius;if (lambda2<0.0) return;vec2 diagonalVector=normalize(vec2(cov2d[0][1],lambda1-cov2d[0][0]));vec2 majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;vec2 minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2(diagonalVector.y,-diagonalVector.x);vColor=color;vPosition=position;vec2 vCenter=vec2(pos2d);gl_Position=vec4(
vCenter 
+ (position.x*majorAxis
+ position.y*minorAxis)*invViewport*pos2d.w,pos2d.zw);
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}
`;D.ShadersStore[MQ]=DQ;var oP=class extends Qt{constructor(){super(),this.FOG=!1,this.THIN_INSTANCES=!0,this.LOGARITHMICDEPTH=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.rebuild()}},jT=class s extends Xs{constructor(e,t){super(e,t),this.backFaceCulling=!1}get hasRenderTargetTextures(){return!1}needAlphaTesting(){return!1}needAlphaBlending(){return!0}isReadyForSubMesh(e,t){let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===!0)return!0;t.materialDefines||(t.materialDefines=new oP);let n=this.getScene(),o=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=n.getEngine();if(Da(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,!1,o),Oa(n,a,this,o,!0,null,!0),wa(e,o,!1,!1),o.isDirty){o.markAsProcessed(),n.resetCachedMaterial();let l=[y.PositionKind,"splatIndex"];Ma(l,o);let c=["world","view","projection","vFogInfos","vFogColor","logarithmicDepthConstant","invViewport","dataTextureSize","focal"],h=["covariancesATexture","covariancesBTexture","centersTexture","colorsTexture"],u=["Scene","Mesh"];Fa({uniformsNames:c,uniformBuffersNames:u,samplers:h,defines:o}),er(c);let d=o.toString(),f=n.getEngine().createEffect("gaussianSplatting",{attributes:l,uniformsNames:c,uniformBuffersNames:u,samplers:h,defines:d,onCompiled:this.onCompiled,onError:this.onError},a);t.setEffect(f,o,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(o._renderId=n.getRenderId(),r._wasPreviouslyReady=!0,r._wasPreviouslyUsingInstances=!0,!0)}bindForSubMesh(e,t,i){let r=this.getScene(),n=i.materialDefines;if(!n)return;let o=i.effect;if(!o)return;if(this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._mustRebind(r,o,i,t.visibility)){this.bindView(o),this.bindViewProjection(o);let l=r.getEngine(),c=this.getScene().activeCamera,h=l.getRenderWidth(),u=l.getRenderHeight(),d=c?.rigParent?.rigCameras.length||1;this._activeEffect.setFloat2("invViewport",1/(h/d),1/u);let f=1e3;if(c){let g=c.getProjectionMatrix().m[5];c.fovMode==Ce.FOVMODE_VERTICAL_FIXED?f=u*g/2:f=h*g/2}this._activeEffect.setFloat2("focal",f,f);let m=t;if(m.covariancesATexture){let g=m.covariancesATexture.getSize();o.setFloat2("dataTextureSize",g.width,g.height),o.setTexture("covariancesATexture",m.covariancesATexture),o.setTexture("covariancesBTexture",m.covariancesBTexture),o.setTexture("centersTexture",m.centersTexture),o.setTexture("colorsTexture",m.colorsTexture)}Yi(o,this,r)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);Ms(r,t,o),this.useLogarithmicDepth&&Br(n,o,r),this._afterBind(t,this._activeEffect,i)}clone(e){return ae.Clone(()=>new s(e,this.getScene()),this)}serialize(){let e=super.serialize();return e.customType="BABYLON.GaussianSplattingMaterial",e}getClassName(){return"GaussianSplattingMaterial"}static Parse(e,t,i){return ae.Parse(()=>new s(e.name,t),e,t,i)}};P("BABYLON.GaussianSplattingMaterial",jT);Object.defineProperty(Ee.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new cl(this)}return this._decalMap},enumerable:!0,configurable:!0});Object.defineProperty(Gt.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new cl(this)}return this._decalMap},enumerable:!0,configurable:!0});Object.defineProperty(lt.prototype,"decalMap",{get:function(){return this._decalMap},set:function(s){this._decalMap=s},enumerable:!0,configurable:!0});var qT=class{constructor(e,t=2,i=3,r=1,n=1){this._curIndex=0,this._sequence=[],this._numSamples=0,this.x=0,this.y=0,this._width=r,this._height=n,this._baseX=t,this._baseY=i,this._generateSequence(e),this.next()}regenerate(e){this._generateSequence(e),this.next()}setDimensions(e,t){this._width=e,this._height=t}next(){this.x=this._sequence[this._curIndex]/this._width,this.y=this._sequence[this._curIndex+1]/this._height,this._curIndex+=2,this._curIndex>=this._numSamples*2&&(this._curIndex=0)}_generateSequence(e){this._sequence=[],this._curIndex=0,this._numSamples=e;for(let t=1;t<=e;++t)this._sequence.push(this._halton(t,this._baseX)-.5,this._halton(t,this._baseY)-.5)}_halton(e,t){let i=1,r=0;for(;e>0;)i/=t,r+=i*(e%t),e=~~(e/t);return r}};function OV(s,e){return`{X: ${s.x.toFixed(e)} Y: ${s.y.toFixed(e)}}`}function wV(s,e){return`{X: ${s._x.toFixed(e)} Y: ${s._y.toFixed(e)} Z: ${s._z.toFixed(e)}}`}function NV(s,e){return`{X: ${s.x.toFixed(e)} Y: ${s.y.toFixed(e)} Z: ${s.z.toFixed(e)} W: ${s.w.toFixed(e)}}`}function QT(s,e,t,i,r){let n=null,o=null,a=null;try{n=new s.Decoder,o=new s.DecoderBuffer,o.Init(e,e.byteLength);let l,c=n.GetEncodedGeometryType(o);switch(c){case s.TRIANGULAR_MESH:{let d=new s.Mesh;if(l=n.DecodeBufferToMesh(o,d),!l.ok()||d.ptr===0)throw new Error(l.error_msg());let m=d.num_faces()*3,g=m*4,_=s._malloc(g);try{n.GetTrianglesUInt32Array(d,g,_);let x=new Uint32Array(m);x.set(new Uint32Array(s.HEAPF32.buffer,_,m)),i(x)}finally{s._free(_)}a=d;break}case s.POINT_CLOUD:{let d=new s.PointCloud;if(l=n.DecodeBufferToPointCloud(o,d),!l.ok()||!d.ptr)throw new Error(l.error_msg());a=d;break}default:throw new Error(`Invalid geometry type ${c}`)}let h=a.num_points(),u=(d,f,m,g)=>{let _=g.data_type(),x=g.num_components(),b=g.normalized(),C=g.byte_stride(),R=g.byte_offset(),S={[s.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:s.HEAPF32},[s.DT_INT8]:{typedArrayConstructor:Int8Array,heap:s.HEAP8},[s.DT_INT16]:{typedArrayConstructor:Int16Array,heap:s.HEAP16},[s.DT_INT32]:{typedArrayConstructor:Int32Array,heap:s.HEAP32},[s.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:s.HEAPU8},[s.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:s.HEAPU16},[s.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:s.HEAPU32}}[_];if(!S)throw new Error(`Invalid data type ${_}`);let A=h*x,L=A*S.typedArrayConstructor.BYTES_PER_ELEMENT,G=s._malloc(L);try{d.GetAttributeDataArrayForAllPoints(f,g,_,L,G);let W=new S.typedArrayConstructor(S.heap.buffer,G,A);r(m,W.slice(),x,R,C,b)}finally{s._free(G)}};if(t)for(let d in t){let f=t[d],m=n.GetAttributeByUniqueId(a,f);u(n,a,d,m)}else{let d={position:s.POSITION,normal:s.NORMAL,color:s.COLOR,uv:s.TEX_COORD};for(let f in d){let m=n.GetAttributeId(a,d[f]);if(m!==-1){let g=n.GetAttribute(a,m);u(n,a,f,g)}}}return h}finally{a&&s.destroy(a),o&&s.destroy(o),n&&s.destroy(n)}}function FV(){let s;onmessage=e=>{let t=e.data;switch(t.id){case"init":{let i=t.decoder;i.url&&importScripts(i.url);let r=i.wasmBinary?{wasmBinary:i.wasmBinary}:{};s=DracoDecoderModule(r),postMessage({id:"initDone"});break}case"decodeMesh":{if(!s)throw new Error("Draco decoder module is not available");s.then(i=>{let r=QT(i,t.dataView,t.attributes,n=>{postMessage({id:"indices",data:n},[n.buffer])},(n,o,a,l,c,h)=>{postMessage({id:"attribute",kind:n,data:o,size:a,byteOffset:l,byteStride:c,normalized:h},[o.buffer])});postMessage({id:"decodeMeshDone",totalVertices:r})});break}}}}function LV(s,e,t){return new Promise((i,r)=>{let n=a=>{s.removeEventListener("error",n),s.removeEventListener("message",o),r(a)},o=a=>{a.data.id==="initDone"&&(s.removeEventListener("error",n),s.removeEventListener("message",o),i(s))};if(s.addEventListener("error",n),s.addEventListener("message",o),!e)s.postMessage({id:"init",decoder:{url:t}});else{let a=e.slice(0);s.postMessage({id:"init",decoder:{url:t,wasmBinary:a}},[a])}})}function OQ(s,e){return new Promise(t=>{(e||DracoDecoderModule)({wasmBinary:s}).then(i=>{t({module:i})})})}var hl=class s{static get DecoderAvailable(){let e=s.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&typeof WebAssembly=="object"||e.fallbackUrl)}static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static get Default(){return s._Default||(s._Default=new s),s._Default}static ResetDefault(e){s._Default&&(e||s._Default.dispose(),s._Default=null)}constructor(e=s.DefaultNumWorkers){let t=s.Configuration.decoder;if(t.workerPool||typeof e=="object"&&e.workerPool)this._workerPoolPromise=Promise.resolve(t.workerPool||e.workerPool);else{let i=t.wasmBinary||typeof e=="object"&&e.wasmBinary,r=typeof e=="number"?e:e.numWorkers,n=r&&typeof Worker=="function"&&typeof URL=="function",o=n||!n&&!t.jsModule,a=t.wasmUrl&&t.wasmBinaryUrl&&typeof WebAssembly=="object"?{url:o?H.GetBabylonScriptURL(t.wasmUrl,!0):"",wasmBinaryPromise:i?Promise.resolve(i):H.LoadFileAsync(H.GetBabylonScriptURL(t.wasmBinaryUrl,!0))}:{url:o?H.GetBabylonScriptURL(t.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};n?this._workerPoolPromise=a.wasmBinaryPromise.then(l=>{let c=`${QT}(${FV})()`,h=URL.createObjectURL(new Blob([c],{type:"application/javascript"}));return new xT(r,()=>{let u=new Worker(h);return LV(u,l,a.url)})}):this._decoderModulePromise=a.wasmBinaryPromise.then(l=>$e(this,null,function*(){if(typeof DracoDecoderModule>"u"&&!t.jsModule){if(!a.url)throw new Error("Draco decoder module is not available");yield H.LoadBabylonScriptAsync(a.url)}return yield OQ(l,t.jsModule)}))}}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise}whenReadyAsync(){return $e(this,null,function*(){if(this._workerPoolPromise){yield this._workerPoolPromise;return}if(this._decoderModulePromise){yield this._decoderModulePromise;return}})}decodeMeshToMeshDataAsync(e,t,i){let r=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength),n=(o,a)=>i&&i[o]!==void 0?(a!==i[o]&&F.Warn(`Normalized flag from Draco data (${a}) does not match normalized flag from glTF accessor (${i[o]}). Using flag from glTF accessor.`),i[o]):a;if(this._workerPoolPromise)return this._workerPoolPromise.then(o=>new Promise((a,l)=>{o.push((c,h)=>{let u=null,d=[],f=_=>{c.removeEventListener("error",f),c.removeEventListener("message",m),l(_),h()},m=_=>{let x=_.data;switch(x.id){case"decodeMeshDone":{c.removeEventListener("error",f),c.removeEventListener("message",m),a({indices:u,attributes:d,totalVertices:x.totalVertices}),h();break}case"indices":{u=x.data;break}case"attribute":{d.push({kind:x.kind,data:x.data,size:x.size,byteOffset:x.byteOffset,byteStride:x.byteStride,normalized:n(x.kind,x.normalized)});break}}};c.addEventListener("error",f),c.addEventListener("message",m);let g=r.slice();c.postMessage({id:"decodeMesh",dataView:g,attributes:t},[g.buffer])})}));if(this._decoderModulePromise)return this._decoderModulePromise.then(o=>{let a=null,l=[],c=QT(o.module,r,t,h=>{a=h},(h,u,d,f,m,g)=>{l.push({kind:h,data:u,size:d,byteOffset:f,byteStride:m,normalized:g})});return{indices:a,attributes:l,totalVertices:c}});throw new Error("Draco decoder module is not available")}decodeMeshToGeometryAsync(e,t,i,r){return $e(this,null,function*(){let n=yield this.decodeMeshToMeshDataAsync(i,r),o=new nr(e,t);n.indices&&o.setIndices(n.indices);for(let a of n.attributes)o.setVerticesBuffer(new y(t.getEngine(),a.data,a.kind,!1,void 0,a.byteStride,void 0,a.byteOffset,a.size,void 0,a.normalized,!0),n.totalVertices);return o})}_decodeMeshToGeometryForGltfAsync(e,t,i,r,n){return $e(this,null,function*(){let o=yield this.decodeMeshToMeshDataAsync(i,r,n),a=new nr(e,t);o.indices&&a.setIndices(o.indices);for(let l of o.attributes)a.setVerticesBuffer(new y(t.getEngine(),l.data,l.kind,!1,void 0,l.byteStride,void 0,l.byteOffset,l.size,void 0,l.normalized,!0),o.totalVertices);return a})}decodeMeshAsync(e,t){return $e(this,null,function*(){let i=yield this.decodeMeshToMeshDataAsync(e,t),r=new le;i.indices&&(r.indices=i.indices);for(let n of i.attributes){let o=y.GetFloatData(n.data,n.size,y.GetDataType(n.data),n.byteOffset,n.byteStride,n.normalized,i.totalVertices);r.set(o,n.kind)}return r})}};hl.Configuration={decoder:{wasmUrl:`${H._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${H._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${H._DefaultCdnUrl}/draco_decoder_gltf.js`}};hl.DefaultNumWorkers=hl.GetDefaultNumWorkers();hl._Default=null;var rf=class s{static get Default(){return s._Default||(s._Default=new s),s._Default}constructor(){let e=s.Configuration.decoder;this._decoderModulePromise=H.LoadBabylonScriptAsync(e.url).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,i,r,n){return this._decoderModulePromise.then(()=>$e(this,null,function*(){MeshoptDecoder.useWorkers(1);let o=yield MeshoptDecoder.decodeGltfBufferAsync(t,i,e,r,n);return MeshoptDecoder.useWorkers(0),o}))}};rf.Configuration={decoder:{url:`${H._DefaultCdnUrl}/meshopt_decoder.js`}};rf._Default=null;var KT=0,ZT=class s{constructor(e,t,i,r){this.pos=e,this.normal=t,this.uv=i,this.vertColor=r}clone(){return new s(this.pos.clone(),this.normal.clone(),this.uv?.clone(),this.vertColor?.clone())}flip(){this.normal=this.normal.scale(-1)}interpolate(e,t){return new s(p.Lerp(this.pos,e.pos,t),p.Lerp(this.normal,e.normal,t),this.uv&&e.uv?j.Lerp(this.uv,e.uv,t):void 0,this.vertColor&&e.vertColor?oe.Lerp(this.vertColor,e.vertColor,t):void 0)}},wQ=(()=>{class s{constructor(t,i){this.normal=t,this.w=i}static FromPoints(t,i,r){let n=r.subtract(t),o=i.subtract(t);if(n.lengthSquared()===0||o.lengthSquared()===0)return null;let a=p.Normalize(p.Cross(n,o));return new s(a,p.Dot(a,t))}clone(){return new s(this.normal.clone(),this.w)}flip(){this.normal.scaleInPlace(-1),this.w=-this.w}splitPolygon(t,i,r,n,o){let u=0,d=[],f,m;for(f=0;f<t.vertices.length;f++){m=p.Dot(this.normal,t.vertices[f].pos)-this.w;let g=m<-s.EPSILON?2:m>s.EPSILON?1:0;u|=g,d.push(g)}switch(u){case 0:(p.Dot(this.normal,t.plane.normal)>0?i:r).push(t);break;case 1:n.push(t);break;case 2:o.push(t);break;case 3:{let g=[],_=[];for(f=0;f<t.vertices.length;f++){let b=(f+1)%t.vertices.length,C=d[f],R=d[b],E=t.vertices[f],S=t.vertices[b];if(C!==2&&g.push(E),C!==1&&_.push(C!==2?E.clone():E),(C|R)===3){m=(this.w-p.Dot(this.normal,E.pos))/p.Dot(this.normal,S.pos.subtract(E.pos));let A=E.interpolate(S,m);g.push(A),_.push(A.clone())}}let x;g.length>=3&&(x=new sf(g,t.shared),x.plane&&n.push(x)),_.length>=3&&(x=new sf(_,t.shared),x.plane&&o.push(x));break}}}}return s.EPSILON=1e-5,s})(),sf=class s{constructor(e,t){this.vertices=e,this.shared=t,this.plane=wQ.FromPoints(e[0].pos,e[1].pos,e[2].pos)}clone(){let e=this.vertices.map(t=>t.clone());return new s(e,this.shared)}flip(){this.vertices.reverse().map(e=>{e.flip()}),this.plane.flip()}},en=class s{constructor(e){this._plane=null,this._front=null,this._back=null,this._polygons=new Array,e&&this.build(e)}clone(){let e=new s;return e._plane=this._plane&&this._plane.clone(),e._front=this._front&&this._front.clone(),e._back=this._back&&this._back.clone(),e._polygons=this._polygons.map(t=>t.clone()),e}invert(){for(let t=0;t<this._polygons.length;t++)this._polygons[t].flip();this._plane&&this._plane.flip(),this._front&&this._front.invert(),this._back&&this._back.invert();let e=this._front;this._front=this._back,this._back=e}clipPolygons(e){if(!this._plane)return e.slice();let t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],t,i,t,i);return this._front&&(t=this._front.clipPolygons(t)),this._back?i=this._back.clipPolygons(i):i=[],t.concat(i)}clipTo(e){this._polygons=e.clipPolygons(this._polygons),this._front&&this._front.clipTo(e),this._back&&this._back.clipTo(e)}allPolygons(){let e=this._polygons.slice();return this._front&&(e=e.concat(this._front.allPolygons())),this._back&&(e=e.concat(this._back.allPolygons())),e}build(e){if(!e.length)return;this._plane||(this._plane=e[0].plane.clone());let t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],this._polygons,this._polygons,t,i);t.length&&(this._front||(this._front=new s),this._front.build(t)),i.length&&(this._back||(this._back=new s),this._back.build(i))}},Ym=class s{constructor(){this._polygons=new Array}static FromVertexData(e){let t,i,r,n=[],o=e.indices,a=e.positions,l=e.normals,c=e.uvs,h=e.colors;if(!o||!a)throw"BABYLON.CSG: VertexData must at least contain positions and indices";for(let d=0;d<o.length;d+=3){r=[];for(let f=0;f<3;f++){let m=d+f,g=o[m],_=l?p.FromArray(l,g*3):p.Zero(),x=c?j.FromArray(c,g*2):void 0,b=h?oe.FromArray(h,g*4):void 0,C=p.FromArray(a,g*3);t=new ZT(C,_,x,b),r.push(t)}i=new sf(r,{subMeshId:0,meshId:KT,materialIndex:0}),i.plane&&n.push(i)}let u=s._FromPolygons(n);return u.matrix=N.Identity(),u.position=p.Zero(),u.rotation=p.Zero(),u.scaling=p.One(),u.rotationQuaternion=q.Identity(),KT++,u}static FromMesh(e,t=!1){let i,r,n,o,a,l,c,h=[],u,d,f,m=null,g,_=!1;if(e instanceof k)e.computeWorldMatrix(!0),u=e.getWorldMatrix(),d=e.position.clone(),f=e.rotation.clone(),e.rotationQuaternion&&(m=e.rotationQuaternion.clone()),g=e.scaling.clone(),e.material&&t&&(_=e.material.sideOrientation===0);else throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";let x=e.getIndices(),b=e.getVerticesData(y.PositionKind),C=e.getVerticesData(y.NormalKind),R=e.getVerticesData(y.UVKind),E=e.getVerticesData(y.ColorKind),S=e.subMeshes;for(let L=0,G=S.length;L<G;L++)for(let W=S[L].indexStart,$=S[L].indexCount+S[L].indexStart;W<$;W+=3){c=[];for(let re=0;re<3;re++){let we=re===0?W+re:_?W+3-re:W+re,_e=new p(C[x[we]*3],C[x[we]*3+1],C[x[we]*3+2]);R&&(n=new j(R[x[we]*2],R[x[we]*2+1])),E&&(a=new oe(E[x[we]*4],E[x[we]*4+1],E[x[we]*4+2],E[x[we]*4+3]));let ce=new p(b[x[we]*3],b[x[we]*3+1],b[x[we]*3+2]);o=p.TransformCoordinates(ce,u),r=p.TransformNormal(_e,u),i=new ZT(o,r,n,a),c.push(i)}l=new sf(c,{subMeshId:L,meshId:KT,materialIndex:S[L].materialIndex}),l.plane&&h.push(l)}let A=s._FromPolygons(h);return A.matrix=t?N.Identity():u,A.position=t?p.Zero():d,A.rotation=t?p.Zero():f,A.scaling=t?p.One():g,A.rotationQuaternion=t&&m?q.Identity():m,KT++,A}static _FromPolygons(e){let t=new s;return t._polygons=e,t}clone(){let e=new s;return e._polygons=this._polygons.map(t=>t.clone()),e.copyTransformAttributes(this),e}union(e){let t=new en(this.clone()._polygons),i=new en(e.clone()._polygons);return t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),s._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}unionInPlace(e){let t=new en(this._polygons),i=new en(e._polygons);t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),this._polygons=t.allPolygons()}subtract(e){let t=new en(this.clone()._polygons),i=new en(e.clone()._polygons);return t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),s._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}subtractInPlace(e){let t=new en(this._polygons),i=new en(e._polygons);t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}intersect(e){let t=new en(this.clone()._polygons),i=new en(e.clone()._polygons);return t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),s._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}intersectInPlace(e){let t=new en(this._polygons),i=new en(e._polygons);t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}inverse(){let e=this.clone();return e.inverseInPlace(),e}inverseInPlace(){this._polygons.map(e=>{e.flip()})}copyTransformAttributes(e){return this.matrix=e.matrix,this.position=e.position,this.rotation=e.rotation,this.scaling=e.scaling,this.rotationQuaternion=e.rotationQuaternion,this}toVertexData(e=null,t=null){let i=this.matrix.clone();i.invert();let r=this._polygons,n=[],o=[],a=[],l=null,c=null,h=p.Zero(),u=p.Zero(),d=j.Zero(),f=new oe(0,0,0,0),m=[0,0,0],g={},_;for(let b=0,C=r.length;b<C;b++){let R=r[b];e&&e(R);for(let E=2,S=R.vertices.length;E<S;E++){m[0]=0,m[1]=E-1,m[2]=E;for(let A=0;A<3;A++){h.copyFrom(R.vertices[m[A]].pos),u.copyFrom(R.vertices[m[A]].normal),R.vertices[m[A]].uv&&(l||(l=[]),d.copyFrom(R.vertices[m[A]].uv)),R.vertices[m[A]].vertColor&&(c||(c=[]),f.copyFrom(R.vertices[m[A]].vertColor));let L=p.TransformCoordinates(h,i),G=p.TransformNormal(u,i);_=g[L.x+","+L.y+","+L.z];let W=!1;l&&!(l[_*2]===d.x||l[_*2+1]===d.y)&&(W=!0);let $=!1;c&&!(c[_*4]===f.r||c[_*4+1]===f.g||c[_*4+2]===f.b||c[_*4+3]===f.a)&&($=!0),(!(typeof _<"u"&&a[_*3]===G.x&&a[_*3+1]===G.y&&a[_*3+2]===G.z)||W||$)&&(n.push(L.x,L.y,L.z),l&&l.push(d.x,d.y),a.push(u.x,u.y,u.z),c&&c.push(f.r,f.g,f.b,f.a),_=g[L.x+","+L.y+","+L.z]=n.length/3-1),o.push(_),t&&t()}}}let x=new le;return x.positions=n,x.normals=a,l&&(x.uvs=l),c&&(x.colors=c),x.indices=o,x}buildMeshGeometry(e,t,i){let r=new k(e,t),n=this._polygons,o=0,a={},l;if(i&&n.sort((h,u)=>h.shared.meshId===u.shared.meshId?h.shared.subMeshId-u.shared.subMeshId:h.shared.meshId-u.shared.meshId),this.toVertexData(h=>{a[h.shared.meshId]||(a[h.shared.meshId]={}),a[h.shared.meshId][h.shared.subMeshId]||(a[h.shared.meshId][h.shared.subMeshId]={indexStart:1/0,indexEnd:-1/0,materialIndex:h.shared.materialIndex}),l=a[h.shared.meshId][h.shared.subMeshId]},()=>{l.indexStart=Math.min(o,l.indexStart),l.indexEnd=Math.max(o,l.indexEnd),o++}).applyToMesh(r),i){let h=0,u;r.subMeshes=[];for(let d in a){u=-1;for(let f in a[d])l=a[d][f],Wi.CreateFromIndices(l.materialIndex+h,l.indexStart,l.indexEnd-l.indexStart+1,r),u=Math.max(l.materialIndex,u);h+=++u}}return r}toMesh(e,t=null,i,r){let n=this.buildMeshGeometry(e,i,r);return n.material=t,n.position.copyFrom(this.position),n.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(n.rotationQuaternion=this.rotationQuaternion.clone()),n.scaling.copyFrom(this.scaling),n.computeWorldMatrix(!0),n}};var NQ="meshUVSpaceRendererVertexShader",FQ=`precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;uniform mat4 projMatrix;varying vec2 vDecalTC;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
void main(void) {vec3 positionUpdated=position;vec3 normalUpdated=normal;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);mat3 normWorldSM=mat3(finalWorld);vec3 vNormalW;
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vNormalW=normalize(normWorldSM*normalUpdated);
#endif
vec3 normalView=normalize((projMatrix*vec4(vNormalW,0.0)).xyz);vec3 decalTC=(projMatrix*worldPos).xyz;vDecalTC=decalTC.xy;gl_Position=vec4(uv*2.0-1.0,normalView.z>0.0 ? 2. : decalTC.z,1.0);}`;D.ShadersStore[NQ]=FQ;var LQ="meshUVSpaceRendererPixelShader",BQ=`precision highp float;varying vec2 vDecalTC;uniform sampler2D textureSampler;void main(void) {if (vDecalTC.x<0. || vDecalTC.x>1. || vDecalTC.y<0. || vDecalTC.y>1.) {discard;}
gl_FragColor=texture2D(textureSampler,vDecalTC);}
`;D.ShadersStore[LQ]=BQ;var VQ="meshUVSpaceRendererMaskerVertexShader",UQ="attribute vec2 uv;varying vec2 vUV;void main(void) {gl_Position=vec4(vec2(uv.x,uv.y)*2.0-1.0,0.,1.0);vUV=uv;}";D.ShadersStore[VQ]=UQ;var kQ="meshUVSpaceRendererMaskerPixelShader",GQ=`varying vec2 vUV;void main(void) {gl_FragColor=vec4(1.0,1.0,1.0,1.0);}
`;D.ShadersStore[kQ]=GQ;var zQ="meshUVSpaceRendererFinaliserPixelShader",WQ=`precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D maskTextureSampler;uniform vec2 textureSize;void main() {vec4 mask=texture2D(maskTextureSampler,vUV).rgba;if (mask.r>0.5) {gl_FragColor=texture2D(textureSampler,vUV);} else {vec2 texelSize=4.0/textureSize;vec2 uv_p01=vUV+vec2(-1.0,0.0)*texelSize;vec2 uv_p21=vUV+vec2(1.0,0.0)*texelSize;vec2 uv_p10=vUV+vec2(0.0,-1.0)*texelSize;vec2 uv_p12=vUV+vec2(0.0,1.0)*texelSize;float mask_p01=texture2D(maskTextureSampler,uv_p01).r;float mask_p21=texture2D(maskTextureSampler,uv_p21).r;float mask_p10=texture2D(maskTextureSampler,uv_p10).r;float mask_p12=texture2D(maskTextureSampler,uv_p12).r;vec4 col=vec4(0.0,0.0,0.0,0.0);float total_weight=0.0;if (mask_p01>0.5) {col+=texture2D(textureSampler,uv_p01);total_weight+=1.0;}
if (mask_p21>0.5) {col+=texture2D(textureSampler,uv_p21);total_weight+=1.0;}
if (mask_p10>0.5) {col+=texture2D(textureSampler,uv_p10);total_weight+=1.0;}
if (mask_p12>0.5) {col+=texture2D(textureSampler,uv_p12);total_weight+=1.0;}
if (total_weight>0.0) {gl_FragColor=col/total_weight;} else {gl_FragColor=col;}}}
`;D.ShadersStore[zQ]=WQ;var HQ="meshUVSpaceRendererFinaliserVertexShader",XQ=`precision highp float;attribute vec3 position;attribute vec2 uv;uniform mat4 worldViewProjection;varying vec2 vUV;void main() {gl_Position=worldViewProjection*vec4(position,1.0);vUV=uv;}
`;D.ShadersStore[HQ]=XQ;k._TrailMeshParser=(s,e)=>aP.Parse(s,e);var aP=class s extends k{constructor(e,t,i,r,n=60,o=!0){super(e,i),this._sectionPolygonPointsCount=4,this._running=!1,this._generator=t,typeof r=="object"&&r!==null?(this.diameter=r.diameter||1,this._length=r.length||60,this._segments=r.segments?r.segments>this._length?this._length:r.segments:this._length,this._sectionPolygonPointsCount=r.sections||4,this._doNotTaper=r.doNotTaper||!1,this._autoStart=r.autoStart||!0):(this.diameter=r||1,this._length=n,this._segments=this._length,this._doNotTaper=!1,this._autoStart=o),this._sectionVectors=[],this._sectionNormalVectors=[];for(let a=0;a<=this._sectionPolygonPointsCount;a++)this._sectionVectors[a]=p.Zero(),this._sectionNormalVectors[a]=p.Zero();this._createMesh()}getClassName(){return"TrailMesh"}_createMesh(){let e=new le,t=[],i=[],r=[],n=[],o=p.Zero();this._generator instanceof lt&&this._generator.hasBoundingInfo?o=this._generator.getBoundingInfo().boundingBox.centerWorld:o=this._generator.absolutePosition;let a=2*Math.PI/this._sectionPolygonPointsCount;for(let l=0;l<=this._sectionPolygonPointsCount;l++){let c=l!==this._sectionPolygonPointsCount?l*a:0;t.push(o.x+Math.cos(c)*this.diameter,o.y+Math.sin(c)*this.diameter,o.z),n.push(l/this._sectionPolygonPointsCount,0)}for(let l=1;l<=this._segments;l++){for(let h=0;h<=this._sectionPolygonPointsCount;h++){let u=h!==this._sectionPolygonPointsCount?h*a:0;t.push(o.x+Math.cos(u)*this.diameter,o.y+Math.sin(u)*this.diameter,o.z),n.push(h/this._sectionPolygonPointsCount,l/this._segments)}let c=t.length/3-2*(this._sectionPolygonPointsCount+1);for(let h=0;h<=this._sectionPolygonPointsCount;h++)r.push(c+h,c+h+this._sectionPolygonPointsCount,c+h+this._sectionPolygonPointsCount+1),r.push(c+h,c+h+this._sectionPolygonPointsCount+1,c+h+1)}le.ComputeNormals(t,r,i),e.positions=t,e.normals=i,e.indices=r,e.uvs=n,e.applyToMesh(this,!0),this._autoStart&&this.start()}start(){this._running||(this._running=!0,this._beforeRenderObserver=this.getScene().onBeforeRenderObservable.add(()=>{this.update()}))}stop(){this._beforeRenderObserver&&this._running&&(this._running=!1,this.getScene().onBeforeRenderObservable.remove(this._beforeRenderObserver))}update(){let e=this.getVerticesData(y.PositionKind),t=this.getVerticesData(y.NormalKind),i=this._generator.getWorldMatrix(),r=3*(this._sectionPolygonPointsCount+1);if(e&&t){if(this._doNotTaper)for(let a=r;a<e.length;a++)e[a-r]=xe.Lerp(e[a-r],e[a],this._segments/this._length);else for(let a=r;a<e.length;a++)e[a-r]=xe.Lerp(e[a-r],e[a],this._segments/this._length)-t[a]/this._length*this.diameter;for(let a=r;a<t.length;a++)t[a-r]=xe.Lerp(t[a-r],t[a],this._segments/this._length);let n=e.length-3*(this._sectionPolygonPointsCount+1),o=2*Math.PI/this._sectionPolygonPointsCount;for(let a=0;a<=this._sectionPolygonPointsCount;a++){let l=a!==this._sectionPolygonPointsCount?a*o:0;this._sectionVectors[a].copyFromFloats(Math.cos(l)*this.diameter,Math.sin(l)*this.diameter,0),this._sectionNormalVectors[a].copyFromFloats(Math.cos(l),Math.sin(l),0),p.TransformCoordinatesToRef(this._sectionVectors[a],i,this._sectionVectors[a]),p.TransformNormalToRef(this._sectionNormalVectors[a],i,this._sectionNormalVectors[a])}for(let a=0;a<=this._sectionPolygonPointsCount;a++)e[n+3*a]=this._sectionVectors[a].x,e[n+3*a+1]=this._sectionVectors[a].y,e[n+3*a+2]=this._sectionVectors[a].z,t[n+3*a]=this._sectionNormalVectors[a].x,t[n+3*a+1]=this._sectionNormalVectors[a].y,t[n+3*a+2]=this._sectionNormalVectors[a].z;this.updateVerticesData(y.PositionKind,e,!0,!1),this.updateVerticesData(y.NormalKind,t,!0,!1)}}clone(e="",t){let i={diameter:this.diameter,length:this._length,segments:this._segments,sections:this._sectionPolygonPointsCount,doNotTaper:this._doNotTaper,autoStart:this._autoStart};return new s(e,t??this._generator,this.getScene(),i)}serialize(e){super.serialize(e),e.generatorId=this._generator.id}static Parse(e,t){let i=t.getLastMeshById(e.generatorId)??t.getLastTransformNodeById(e.generatorId);if(!i)throw new Error("TrailMesh: generator not found with ID "+e.generatorId);let r={diameter:e.diameter??e._diameter,length:e._length,segments:e._segments,sections:e._sectionPolygonPointsCount,doNotTaper:e._doNotTaper,autoStart:e._autoStart};return new s(e.name,i,t,r)}};var JT=class{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){let e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)e.settings.forEach(t=>{this._getSimplifier(e).simplify(t,r=>{t.distance!==void 0&&e.mesh.addLODLevel(t.distance,r),r.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()})});else{let t=this._getSimplifier(e),i=(r,n)=>{t.simplify(r,o=>{r.distance!==void 0&&e.mesh.addLODLevel(r.distance,o),o.isVisible=!0,n()})};no.Run(e.settings.length,r=>{i(e.settings[r.index],()=>{r.executeNext()})},()=>{e.successCallback&&e.successCallback(),this.executeNext()})}}_getSimplifier(e){switch(e.simplificationType){case tC.QUADRATIC:default:return new uP(e.mesh)}}},tC=function(s){return s[s.QUADRATIC=0]="QUADRATIC",s}(tC||{}),lP=class{constructor(e){this._vertices=e,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}},cP=class{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new eC,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}},eC=class s{constructor(e){this.data=new Array(10);for(let t=0;t<10;++t)e&&e[t]?this.data[t]=e[t]:this.data[t]=0}det(e,t,i,r,n,o,a,l,c){return this.data[e]*this.data[n]*this.data[c]+this.data[i]*this.data[r]*this.data[l]+this.data[t]*this.data[o]*this.data[a]-this.data[i]*this.data[n]*this.data[a]-this.data[e]*this.data[o]*this.data[l]-this.data[t]*this.data[r]*this.data[c]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){let t=new s;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,r){return new s(s.DataFromNumbers(e,t,i,r))}static DataFromNumbers(e,t,i,r){return[e*e,e*t,e*i,e*r,t*t,t*i,t*r,i*i,i*r,r*r]}},hP=class{constructor(e,t){this.vertexId=e,this.triangleId=t}},uP=class{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=je}simplify(e,t){this._initDecimatedMesh(),no.Run(this._mesh.subMeshes.length,i=>{this._initWithMesh(i.index,()=>{this._runDecimation(e,i.index,()=>{i.executeNext()})},e.optimizeMesh)},()=>{setTimeout(()=>{t(this._reconstructedMesh)},0)})}_runDecimation(e,t,i){let r=~~(this._triangles.length*e.quality),n=0,o=this._triangles.length,a=(l,c)=>{setTimeout(()=>{l%5===0&&this._updateMesh(l===0);for(let d=0;d<this._triangles.length;++d)this._triangles[d].isDirty=!1;let h=1e-9*Math.pow(l+3,this.aggressiveness),u=d=>{let f=~~((this._triangles.length/2+d)%this._triangles.length),m=this._triangles[f];if(m&&!(m.error[3]>h||m.deleted||m.isDirty)){for(let g=0;g<3;++g)if(m.error[g]<h){let _=[],x=[],b=m._vertices[g],C=m._vertices[(g+1)%3];if(b.isBorder||C.isBorder)continue;let R=p.Zero();this._calculateError(b,C,R);let E=[];if(this._isFlipped(b,C,R,_,E)||this._isFlipped(C,b,R,x,E)||_.indexOf(!0)<0||x.indexOf(!0)<0)continue;let S=[];if(E.forEach(G=>{S.indexOf(G)===-1&&(G.deletePending=!0,S.push(G))}),S.length%2!==0)continue;b.q=C.q.add(b.q),b.updatePosition(R);let A=this._references.length;n=this._updateTriangles(b,b,_,n),n=this._updateTriangles(b,C,x,n);let L=this._references.length-A;if(L<=b.triangleCount){if(L)for(let G=0;G<L;G++)this._references[b.triangleStart+G]=this._references[A+G]}else b.triangleStart=A;b.triangleCount=L;break}}};no.SyncAsyncForLoop(this._triangles.length,this.syncIterations,u,c,()=>o-n<=r)},0)};no.Run(this.decimationIterations,l=>{o-n<=r?l.breakLoop():a(l.index,()=>{l.executeNext()})},()=>{setTimeout(()=>{this._reconstructMesh(t),i()},0)})}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];let r=this._mesh.getVerticesData(y.PositionKind),n=this._mesh.getIndices(),o=this._mesh.subMeshes[e],a=u=>{if(i){for(let d=0;d<this._vertices.length;++d)if(this._vertices[d].position.equalsWithEpsilon(u,1e-4))return this._vertices[d]}return null},l=[],c=u=>{if(!r)return;let d=u+o.verticesStart,f=p.FromArray(r,d*3),m=a(f)||new cP(f,this._vertices.length);m.originalOffsets.push(d),m.id===this._vertices.length&&this._vertices.push(m),l.push(m.id)},h=o.verticesCount;no.SyncAsyncForLoop(h,this.syncIterations/4>>0,c,()=>{let u=d=>{if(!n)return;let m=(o.indexStart/3+d)*3,g=n[m+0],_=n[m+1],x=n[m+2],b=this._vertices[l[g-o.verticesStart]],C=this._vertices[l[_-o.verticesStart]],R=this._vertices[l[x-o.verticesStart]],E=new lP([b,C,R]);E.originalOffset=m,this._triangles.push(E)};no.SyncAsyncForLoop(o.indexCount/3,this.syncIterations,u,()=>{this._init(t)})})}_init(e){let t=i=>{let r=this._triangles[i];r.normal=p.Cross(r._vertices[1].position.subtract(r._vertices[0].position),r._vertices[2].position.subtract(r._vertices[0].position)).normalize();for(let n=0;n<3;n++)r._vertices[n].q.addArrayInPlace(eC.DataFromNumbers(r.normal.x,r.normal.y,r.normal.z,-p.Dot(r.normal,r._vertices[0].position)))};no.SyncAsyncForLoop(this._triangles.length,this.syncIterations,t,()=>{let i=r=>{let n=this._triangles[r];for(let o=0;o<3;++o)n.error[o]=this._calculateError(n._vertices[o],n._vertices[(o+1)%3]);n.error[3]=Math.min(n.error[0],n.error[1],n.error[2])};no.SyncAsyncForLoop(this._triangles.length,this.syncIterations,i,()=>{e()})})}_reconstructMesh(e){let t=[],i;for(i=0;i<this._vertices.length;++i)this._vertices[i].triangleCount=0;let r,n;for(i=0;i<this._triangles.length;++i)if(!this._triangles[i].deleted){for(r=this._triangles[i],n=0;n<3;++n)r._vertices[n].triangleCount=1;t.push(r)}let o=this._reconstructedMesh.getVerticesData(y.PositionKind)||[],a=this._reconstructedMesh.getVerticesData(y.NormalKind)||[],l=this._reconstructedMesh.getVerticesData(y.UVKind)||[],c=this._reconstructedMesh.getVerticesData(y.ColorKind)||[],h=this._mesh.getVerticesData(y.NormalKind),u=this._mesh.getVerticesData(y.UVKind),d=this._mesh.getVerticesData(y.ColorKind),f=0;for(i=0;i<this._vertices.length;++i){let R=this._vertices[i];R.id=f,R.triangleCount&&R.originalOffsets.forEach(E=>{o.push(R.position.x),o.push(R.position.y),o.push(R.position.z),h&&h.length&&(a.push(h[E*3]),a.push(h[E*3+1]),a.push(h[E*3+2])),u&&u.length&&(l.push(u[E*2]),l.push(u[E*2+1])),d&&d.length&&(c.push(d[E*4]),c.push(d[E*4+1]),c.push(d[E*4+2]),c.push(d[E*4+3])),++f})}let m=this._reconstructedMesh.getTotalIndices(),g=this._reconstructedMesh.getTotalVertices(),_=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];let x=this._reconstructedMesh.getIndices(),b=this._mesh.getIndices();for(i=0;i<t.length;++i)r=t[i],[0,1,2].forEach(R=>{let E=b[r.originalOffset+R],S=r._vertices[R].originalOffsets.indexOf(E);S<0&&(S=0),x.push(r._vertices[R].id+S+g)});this._reconstructedMesh.setIndices(x),this._reconstructedMesh.setVerticesData(y.PositionKind,o),a.length>0&&this._reconstructedMesh.setVerticesData(y.NormalKind,a),l.length>0&&this._reconstructedMesh.setVerticesData(y.UVKind,l),c.length>0&&this._reconstructedMesh.setVerticesData(y.ColorKind,c);let C=this._mesh.subMeshes[e];e>0&&(this._reconstructedMesh.subMeshes=[],_.forEach(R=>{Wi.AddToMesh(R.materialIndex,R.verticesStart,R.verticesCount,R.indexStart,R.indexCount,R.getMesh())}),Wi.AddToMesh(C.materialIndex,g,f,m,t.length*3,this._reconstructedMesh))}_initDecimatedMesh(){this._reconstructedMesh=new k(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,r,n){for(let o=0;o<e.triangleCount;++o){let a=this._triangles[this._references[e.triangleStart+o].triangleId];if(a.deleted)continue;let l=this._references[e.triangleStart+o].vertexId,c=a._vertices[(l+1)%3],h=a._vertices[(l+2)%3];if(c===t||h===t){r[o]=!0,n.push(a);continue}let u=c.position.subtract(i);u=u.normalize();let d=h.position.subtract(i);if(d=d.normalize(),Math.abs(p.Dot(u,d))>.999)return!0;let f=p.Cross(u,d).normalize();if(r[o]=!1,p.Dot(f,a.normal)<.2)return!0}return!1}_updateTriangles(e,t,i,r){let n=r;for(let o=0;o<t.triangleCount;++o){let a=this._references[t.triangleStart+o],l=this._triangles[a.triangleId];if(!l.deleted){if(i[o]&&l.deletePending){l.deleted=!0,n++;continue}l._vertices[a.vertexId]=e,l.isDirty=!0,l.error[0]=this._calculateError(l._vertices[0],l._vertices[1])+l.borderFactor/2,l.error[1]=this._calculateError(l._vertices[1],l._vertices[2])+l.borderFactor/2,l.error[2]=this._calculateError(l._vertices[2],l._vertices[0])+l.borderFactor/2,l.error[3]=Math.min(l.error[0],l.error[1],l.error[2]),this._references.push(a)}}return n}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){let t=[],i=[],r=this._vertices[e],n;for(n=0;n<r.triangleCount;++n){let o=this._triangles[this._references[r.triangleStart+n].triangleId];for(let a=0;a<3;a++){let l=0,c=o._vertices[a];for(;l<t.length&&i[l]!==c.id;)++l;l===t.length?(t.push(1),i.push(c.id)):t[l]++}}for(n=0;n<t.length;++n)t[n]===1?this._vertices[i[n]].isBorder=!0:this._vertices[i[n]].isBorder=!1}}_updateMesh(e=!1){let t;if(!e){let l=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||l.push(this._triangles[t]);this._triangles=l}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;let i,r,n;for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)n=i._vertices[r],n.triangleCount++;let o=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=o,o+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;let a=new Array(this._triangles.length*3);for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],r=0;r<3;++r)n=i._vertices[r],a[n.triangleStart+n.triangleCount]=new hP(r,t),n.triangleCount++;this._references=a,e&&this._identifyBorder()}_vertexError(e,t){let i=t.x,r=t.y,n=t.z;return e.data[0]*i*i+2*e.data[1]*i*r+2*e.data[2]*i*n+2*e.data[3]*i+e.data[4]*r*r+2*e.data[5]*r*n+2*e.data[6]*r+e.data[7]*n*n+2*e.data[8]*n+e.data[9]}_calculateError(e,t,i){let r=e.q.add(t.q),n=e.isBorder&&t.isBorder,o=0,a=r.det(0,1,2,1,4,5,2,5,7);if(a!==0&&!n)i||(i=p.Zero()),i.x=-1/a*r.det(1,2,3,4,5,6,5,7,8),i.y=1/a*r.det(0,2,3,1,5,6,2,7,8),i.z=-1/a*r.det(0,1,3,1,4,6,2,5,8),o=this._vertexError(r,i);else{let l=e.position.add(t.position).divide(new p(2,2,2)),c=this._vertexError(r,e.position),h=this._vertexError(r,t.position),u=this._vertexError(r,l);o=Math.min(c,h,u),o===c?i&&i.copyFrom(e.position):o===h?i&&i.copyFrom(t.position):i&&i.copyFrom(l)}return o}};Object.defineProperty(Te.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new JT;let s=this._getComponent(ye.NAME_SIMPLIFICATIONQUEUE);s||(s=new dP(this),this._addComponent(s))}return this._simplificationQueue},set:function(s){this._simplificationQueue=s},enumerable:!0,configurable:!0});k.prototype.simplify=function(s,e=!0,t=tC.QUADRATIC,i){return this.getScene().simplificationQueue.addTask({settings:s,parallelProcessing:e,mesh:this,simplificationType:t,successCallback:i}),this};var dP=class{constructor(e){this.name=ye.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(ye.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}};var ya=function(s){return s[s.POINTS_MODE_POINTS=0]="POINTS_MODE_POINTS",s[s.POINTS_MODE_PATHS=1]="POINTS_MODE_PATHS",s}(ya||{}),iC=function(s){return s[s.FACES_MODE_SINGLE_SIDED=0]="FACES_MODE_SINGLE_SIDED",s[s.FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING=1]="FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING",s[s.FACES_MODE_DOUBLE_SIDED=2]="FACES_MODE_DOUBLE_SIDED",s}(iC||{}),ac=function(s){return s[s.AUTO_DIRECTIONS_FROM_FIRST_SEGMENT=0]="AUTO_DIRECTIONS_FROM_FIRST_SEGMENT",s[s.AUTO_DIRECTIONS_FROM_ALL_SEGMENTS=1]="AUTO_DIRECTIONS_FROM_ALL_SEGMENTS",s[s.AUTO_DIRECTIONS_ENHANCED=2]="AUTO_DIRECTIONS_ENHANCED",s[s.AUTO_DIRECTIONS_FACE_TO=3]="AUTO_DIRECTIONS_FACE_TO",s[s.AUTO_DIRECTIONS_NONE=99]="AUTO_DIRECTIONS_NONE",s}(ac||{}),nf=class extends k{constructor(e,t,i){super(e,t,null,null,!1,!1),this.name=e,this._options=i,this._lazy=!1,this._updatable=!1,this._engine=t.getEngine(),this._lazy=i.lazy??!1,this._updatable=i.updatable??!1,this._vertexPositions=[],this._indices=[],this._uvs=[],this._points=[],this._colorPointers=i.colorPointers??[],this._widths=i.widths??new Array(i.points.length).fill(1)}getClassName(){return"GreasedLineMesh"}_updateWidthsWithValue(e){let t=0;for(let r of this._points)t+=r.length;let i=t/3*2-this._widths.length;for(let r=0;r<i;r++)this._widths.push(e)}updateLazy(){this._setPoints(this._points),this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(this._options.ribbonOptions?.smoothShading),this.refreshBoundingInfo(),this.greasedLineMaterial?.updateLazy()}addPoints(e,t){for(let i of e)this._points.push(i);this._lazy||this.setPoints(this._points,t)}dispose(e,t=!1){super.dispose(e,t)}isLazy(){return this._lazy}get uvs(){return this._uvs}set uvs(e){this._uvs=e instanceof Float32Array?e:new Float32Array(e),this._createVertexBuffers()}get offsets(){return this._offsets}set offsets(e){this._offsets=e,this._offsetsBuffer?this._offsetsBuffer.update(e):this._createOffsetsBuffer(e)}get widths(){return this._widths}set widths(e){this._widths=e,this._lazy||this._widthsBuffer&&this._widthsBuffer.update(e)}get colorPointers(){return this._colorPointers}set colorPointers(e){this._colorPointers=e,this._lazy||this._colorPointersBuffer&&this._colorPointersBuffer.update(e)}get greasedLineMaterial(){if(this.material&&this.material instanceof Hm)return this.material;let e=this.material?.pluginManager?.getPlugin(Wm.GREASED_LINE_MATERIAL_NAME);if(e)return e}get points(){let e=[];return ei.DeepCopy(this._points,e),e}setPoints(e,t){this._points=e,this._updateWidths(),t?.colorPointers||this._updateColorPointers(),this._setPoints(e,t)}_initGreasedLine(){this._vertexPositions=[],this._indices=[],this._uvs=[]}_createLineOptions(){return{points:this._points,colorPointers:this._colorPointers,lazy:this._lazy,updatable:this._updatable,uvs:this._uvs,widths:this._widths,ribbonOptions:this._options.ribbonOptions}}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}_createVertexBuffers(e=!1){let t=new le;return t.positions=this._vertexPositions,t.indices=this._indices,t.uvs=this._uvs,e&&(t.normals=[],le.ComputeNormals(this._vertexPositions,this._indices,t.normals)),t.applyToMesh(this,this._options.updatable),t}_createOffsetsBuffer(e){let t=this._scene.getEngine(),i=new gi(t,e,this._updatable,3);this.setVerticesBuffer(i.createVertexBuffer("grl_offsets",0,3)),this._offsetsBuffer=i}};k._GreasedLineMeshParser=(s,e)=>lc.Parse(s,e);var lc=class s extends nf{constructor(e,t,i){super(e,t,i),this.name=e,this.intersectionThreshold=.1,this._previousAndSide=[],this._nextAndCounters=[],i.points&&this.addPoints(Si.ConvertPoints(i.points))}getClassName(){return"GreasedLineMesh"}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[],this._points.forEach(t=>{for(let i=0;i<t.length;i+=3)this._colorPointers.push(e),this._colorPointers.push(e++)})}_updateWidths(){}_setPoints(e){this._points=e,this._options.points=e,this._initGreasedLine();let t=0,i=0,r=0,n=0,o=0;e.forEach(x=>{i+=x.length*2,r+=(x.length-3)*2,n+=x.length*4/3,o+=x.length*8/3});let a=new Float32Array(i),l=i>65535?new Uint32Array(r):new Uint16Array(r),c=new Float32Array(n),h=new Float32Array(o),u=new Float32Array(o),d=0,f=0,m=0,g=0,_=0;e.forEach(x=>{let b=Si.GetLineLengthArray(x),C=b[b.length-1];for(let W=0,$=0;$<x.length;W++,$+=3){let re=d+$*2;if(a[re+0]=x[$+0],a[re+1]=x[$+1],a[re+2]=x[$+2],a[re+3]=x[$+0],a[re+4]=x[$+1],a[re+5]=x[$+2],$<x.length-3){let we=W*2+t,_e=f+$*2;l[_e+0]=we,l[_e+1]=we+1,l[_e+2]=we+2,l[_e+3]=we+2,l[_e+4]=we+1,l[_e+5]=we+3}}t+=x.length/3*2;let R=x.length*2,E=a.subarray(d,d+R);d+=R,f+=(x.length-3)*2;let S=new Float32Array(E.length),A=new Float32Array(E.length),L=E.length/6,G;s._CompareV3(0,L-1,E)?G=E.subarray((L-2)*6,(L-1)*6):G=E.subarray(0,6),S.set(G),S.set(E.subarray(0,E.length-6),6),A.set(E.subarray(6)),s._CompareV3(L-1,0,E)?G=E.subarray(6,12):G=E.subarray((L-1)*6,L*6),A.set(G,A.length-6);for(let W=0,$=E.length/3;W<$;W++)h[g++]=S[W*3],h[g++]=S[W*3+1],h[g++]=S[W*3+2],h[g++]=1-((W&1)<<1),u[_++]=A[W*3],u[_++]=A[W*3+1],u[_++]=A[W*3+2],u[_++]=b[W>>1]/C;if(this._options.uvs)for(let W=0;W<this._options.uvs.length;W++)c[m++]=this._options.uvs[W];else{for(let W=0;W<L;W++){let $=m+W*4;c[$+0]=W/(L-1),c[$+1]=0,c[$+2]=W/(L-1),c[$+3]=1}m+=L*4}}),this._vertexPositions=a,this._indices=l,this._uvs=c,this._previousAndSide=h,this._nextAndCounters=u,this._lazy||(this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(),this.refreshBoundingInfo())}clone(e=`${this.name}-cloned`,t){let i=this._createLineOptions(),r={};ei.DeepCopy(i,r,["instance"],void 0,!0);let n=new s(e,this._scene,r);return t&&(n.parent=t),n.material=this.material,n}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}static Parse(e,t){let i=e.lineOptions,r=e.name;return new s(r,t,i)}_initGreasedLine(){super._initGreasedLine(),this._previousAndSide=[],this._nextAndCounters=[]}intersects(e,t,i,r=!1,n,o=!1){let a=new oi,l=this.findAllIntersections(e,t,i,r,n,o,!0);if(l?.length===1){let c=l[0];a.hit=!0,a.distance=c.distance,a.ray=e,a.pickedMesh=this,a.pickedPoint=c.point}return a}findAllIntersections(e,t,i,r=!1,n,o=!1,a=!1){if(r&&!o&&e.intersectsSphere(this._boundingSphere,this.intersectionThreshold)===!1)return;let l=this.getIndices(),c=this.getVerticesData(y.PositionKind),h=this._widths,u=this.greasedLineMaterial?.width??1,d=[];if(l&&c&&h){let f=0,m=0;for(f=0,m=l.length-1;f<m;f+=3){let g=l[f],_=l[f+1];s._V_START.fromArray(c,g*3),s._V_END.fromArray(c,_*3),this._offsets&&(s._V_OFFSET_START.fromArray(this._offsets,g*3),s._V_OFFSET_END.fromArray(this._offsets,_*3),s._V_START.addInPlace(s._V_OFFSET_START),s._V_END.addInPlace(s._V_OFFSET_END));let x=Math.floor(f/3),b=h[x]!==void 0?h[x]:1,C=this.intersectionThreshold*(u*b)/2,R=e.intersectionSegment(s._V_START,s._V_END,C);if(R!==-1&&(d.push({distance:R,point:e.direction.normalize().multiplyByFloats(R,R,R).add(e.origin)}),a))return d}f=m}return d}get _boundingSphere(){return this.getBoundingInfo().boundingSphere}static _CompareV3(e,t,i){let r=e*6,n=t*6;return i[r]===i[n]&&i[r+1]===i[n+1]&&i[r+2]===i[n+2]}_createVertexBuffers(){let e=super._createVertexBuffers(),t=this._scene.getEngine(),i=new gi(t,this._previousAndSide,!1,4);this.setVerticesBuffer(i.createVertexBuffer("grl_previousAndSide",0,4));let r=new gi(t,this._nextAndCounters,!1,4);this.setVerticesBuffer(r.createVertexBuffer("grl_nextAndCounters",0,4));let n=new gi(t,this._widths,this._updatable,1);this.setVerticesBuffer(n.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=n;let o=new gi(t,this._colorPointers,this._updatable,1);return this.setVerticesBuffer(o.createVertexBuffer("grl_colorPointers",0,1)),this._colorPointersBuffer=o,e}};lc._V_START=new p;lc._V_END=new p;lc._V_OFFSET_START=new p;lc._V_OFFSET_END=new p;k._GreasedLineRibbonMeshParser=(s,e)=>wo.Parse(s,e);var wo=class s extends nf{constructor(e,t,i,r){if(super(e,t,i),this.name=e,!i.ribbonOptions)throw"'GreasedLineMeshOptions.ribbonOptions' is not set.";this._paths=[],this._counters=[],this._slopes=[],this._widths=i.widths??[],this._ribbonWidths=[],this._pathsOptions=r??[],i.points&&this.addPoints(Si.ConvertPoints(i.points),i,!!r)}addPoints(e,t,i=!1){if(!t.ribbonOptions)throw"addPoints() on GreasedLineRibbonMesh instance requires 'GreasedLineMeshOptions.ribbonOptions'.";i||this._pathsOptions.push({options:t,pathCount:e.length}),super.addPoints(e,t)}getClassName(){return"GreasedLineRibbonMesh"}get isFlatLine(){return this._paths.length<3}get slopes(){return this._slopes}set slopes(e){this._slopes=e}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[];for(let t=0;t<this._pathsOptions.length;t++){let{options:i,pathCount:r}=this._pathsOptions[t],n=this._points[t];if(i.ribbonOptions.pointsMode===ya.POINTS_MODE_POINTS)for(let o=0;o<r;o++)for(let a=0;a<n.length;a+=3)this._colorPointers.push(e),this._colorPointers.push(e++);else for(let o=0;o<n.length;o+=3){for(let a=0;a<r;a++)this._colorPointers.push(e);e++}}}_updateWidths(){super._updateWidthsWithValue(1)}_setPoints(e,t){if(!this._options.ribbonOptions)throw"No 'GreasedLineMeshOptions.ribbonOptions' provided.";this._points=e,this._options.points=e,this._initGreasedLine();let i=0,r;for(let n=0,o=0;n<this._pathsOptions.length;n++){let{options:a,pathCount:l}=this._pathsOptions[n],c=e.slice(o,o+l);if(o+=l,a.ribbonOptions?.pointsMode===ya.POINTS_MODE_PATHS)i=this._preprocess(Si.ToVector3Array(c),i,a);else{if(a.ribbonOptions?.directionsAutoMode===ac.AUTO_DIRECTIONS_NONE){if(!a.ribbonOptions.directions)throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_NONE 'GreasedLineMeshOptions.ribbonOptions.directions' must be defined.";r=s._GetDirectionPlanesFromDirectionsOption(c.length,a.ribbonOptions.directions)}c.forEach((h,u)=>{let d=s._ConvertToRibbonPath(h,a.ribbonOptions,this._scene.useRightHandedSystem,r&&r[u]);i=this._preprocess(d,i,a)})}}this._lazy||(this._createVertexBuffers(),this.refreshBoundingInfo())}static _GetDirectionPlanesFromDirectionsOption(e,t){return Array.isArray(t)?t:new Array(e).fill(t)}static _CreateRibbonVertexData(e,t){let i=e.length;if(i<2)throw"Minimum of two paths are required to create a GreasedLineRibbonMesh.";let r=[],n=[],o=e[0];for(let h=0;h<o.length;h++)for(let u=0;u<e.length;u++){let d=e[u][h];r.push(d.x,d.y,d.z)}let a=[1,0,i],l=t.ribbonOptions?.facesMode===iC.FACES_MODE_DOUBLE_SIDED,c=t.ribbonOptions?.pointsMode===ya.POINTS_MODE_PATHS&&t.ribbonOptions.closePath;if(i>2)for(let h=0;h<o.length-1;h++){a[0]=1+i*h,a[1]=i*h,a[2]=(h+1)*i;for(let u=0;u<(i-1)*2;u++)u%2!==0&&(a[2]+=1),u%2===0&&u>0&&(a[0]+=1,a[1]+=1),n.push(a[1]+(u%2!==0?i:0),a[0],a[2]),l&&n.push(a[0],a[1]+(u%2!==0?i:0),a[2])}else for(let h=0;h<r.length/3-3;h+=2)n.push(h,h+1,h+2),n.push(h+2,h+1,h+3),l&&(n.push(h+1,h,h+2),n.push(h+1,h+2,h+3));if(c){let h=i*(o.length-1);for(let u=0;u<i-1;u++)n.push(h,u+1,u),n.push(h+1,u+1,h),l&&(n.push(u,u+1,h),n.push(h,u+1,h+1)),h++}return{positions:r,indices:n}}_preprocess(e,t,i){this._paths=e;let r=s._CreateRibbonVertexData(e,i),n=r.positions;if(!this._options.widths)throw"No 'GreasedLineMeshOptions.widths' table is specified.";let o=Array.isArray(this._vertexPositions)?this._vertexPositions:Array.from(this._vertexPositions);this._vertexPositions=o;let a=Array.isArray(this._uvs)?this._uvs:Array.from(this._uvs);this._uvs=a;let l=Array.isArray(this._indices)?this._indices:Array.from(this._indices);this._indices=l;for(let f of n)o.push(f);let c=e;if(i.ribbonOptions?.pointsMode===ya.POINTS_MODE_PATHS&&i.ribbonOptions.closePath){c=[];for(let f=0;f<e.length;f++){let m=e[f].slice();m.push(e[f][0].clone()),c.push(m)}}this._calculateSegmentLengths(c);let h=c.length,u=new Array(h).fill(0);for(let f=0;f<c[0].length;f++){let m=0;for(let g=0;g<h;g++){let _=u[g]+this._vSegmentLengths[g][f]/this._vTotalLengths[g];this._counters.push(_),a.push(_,m),u[g]=_,m+=this._uSegmentLengths[f][g]/this._uTotalLengths[f]}}for(let f=0,m=0;f<c[0].length;f++){let g=this._uSegmentLengths[f][0]/2,_=this._uSegmentLengths[f][h-1]/2;this._ribbonWidths.push(((this._widths[m++]??1)-1)*g);for(let x=0;x<h-2;x++)this._ribbonWidths.push(0);this._ribbonWidths.push(((this._widths[m++]??1)-1)*_)}let d=i.ribbonOptions?.pointsMode===ya.POINTS_MODE_PATHS?new Array(c[0].length*c.length*6).fill(0):s._CalculateSlopes(c);for(let f of d)this._slopes.push(f);if(r.indices)for(let f=0;f<r.indices.length;f++)l.push(r.indices[f]+t);return t+=n.length/3,t}static _ConvertToRibbonPath(e,t,i,r){if(t.pointsMode===ya.POINTS_MODE_POINTS&&!t.width)throw"'GreasedLineMeshOptions.ribbonOptiosn.width' must be specified in GreasedLineRibbonPointsMode.POINTS_MODE_POINTS.";let n=[],o=[];if(t.pointsMode===ya.POINTS_MODE_POINTS){let a=t.width/2,l=Si.ToVector3Array(e),c=null,h=null;if(t.directionsAutoMode===ac.AUTO_DIRECTIONS_FROM_FIRST_SEGMENT&&(r=s._GetDirectionFromPoints(l[0],l[1],null)),t.directionsAutoMode===ac.AUTO_DIRECTIONS_FACE_TO&&!(t.directions instanceof p))throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_FACE_TO 'GreasedLineMeshOptions.ribbonOptions.directions' must be a Vector3.";O.Vector3[1]=t.directions instanceof p?t.directions:s.DIRECTION_XZ;for(let u=0;u<l.length-(r?0:1);u++){let d=l[u],f=l[u+1];if(r)c=r;else if(t.directionsAutoMode===ac.AUTO_DIRECTIONS_FACE_TO)f.subtractToRef(d,O.Vector3[0]),c=p.CrossToRef(O.Vector3[0],O.Vector3[1],O.Vector3[2]).normalize();else if(t.directionsAutoMode===ac.AUTO_DIRECTIONS_FROM_ALL_SEGMENTS)c=s._GetDirectionFromPoints(d,f,c);else{let m=f.subtract(d);m.applyRotationQuaternionInPlace(m.x>m.y&&m.x>m.z?i?s._RightHandedForwardReadOnlyQuaternion:s._LeftHandedForwardReadOnlyQuaternion:s._LeftReadOnlyQuaternion),c=m.normalize()}h=c.multiplyByFloats(a,a,a),n.push(d.add(h)),o.push(d.subtract(h))}r||(n.push(l[l.length-1].add(h)),o.push(l[l.length-1].subtract(h)))}return[n,o]}static _GetDirectionFromPoints(e,t,i){return e.x===t.x&&(!i||i?.x===1)?s.DIRECTION_YZ:e.y===t.y?s.DIRECTION_XZ:e.z===t.z?s.DIRECTION_XY:s.DIRECTION_XZ}clone(e=`${this.name}-cloned`,t){let i=this._createLineOptions(),r={},n=[];ei.DeepCopy(this._pathsOptions,n,void 0,void 0,!0),ei.DeepCopy(i,r,["instance"],void 0,!0);let o=new s(e,this._scene,r,n);return t&&(o.parent=t),o.material=this.material,o}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions(),e.pathsOptions=this._pathsOptions}static Parse(e,t){let i=e.lineOptions,r=e.name,n=e.pathOptions;return new s(r,t,i,n)}_initGreasedLine(){super._initGreasedLine(),this._paths=[],this._counters=[],this._slopes=[],this._ribbonWidths=[]}_calculateSegmentLengths(e){let t=e.length;this._vSegmentLengths=new Array(t),this._vTotalLengths=new Array(t);let i=0;for(let o=0;o<t;o++){let a=e[o];this._vSegmentLengths[o]=[0],i=0;for(let l=0;l<a.length-1;l++){let c=Math.abs(a[l].subtract(a[l+1]).lengthSquared());i+=c,this._vSegmentLengths[o].push(c)}this._vTotalLengths[o]=i}let r=e[0].length;this._uSegmentLengths=new Array(r).fill([]),this._uTotalLengths=new Array(r).fill([]);let n=new p;for(let o=0;o<r;o++){i=0;for(let a=1;a<t;a++){e[a][o].subtractToRef(e[a-1][o],n);let l=n.length();i+=l,this._uSegmentLengths[o].push(l)}this._uTotalLengths[o]=i}}static _CalculateSlopes(e){let t=e[0],i=e.length===2?e[1]:e[e.length-1],r=[],n=new p;for(let o=0;o<t.length;o++)for(let a=0;a<e.length;a++)a===0||a===e.length-1?(t[o].subtract(i[o]).normalizeToRef(n),r.push(n.x,n.y,n.z),r.push(-n.x,-n.y,-n.z)):r.push(0,0,0,0,0,0);return r}_createVertexBuffers(){this._uvs=this._options.uvs??this._uvs;let e=super._createVertexBuffers(this._options.ribbonOptions?.smoothShading),t=new gi(this._engine,this._counters,this._updatable,1);this.setVerticesBuffer(t.createVertexBuffer("grl_counters",0,1));let i=new gi(this._engine,this._colorPointers,this._updatable,1);this.setVerticesBuffer(i.createVertexBuffer("grl_colorPointers",0,1));let r=new gi(this._engine,this._slopes,this._updatable,3);this.setVerticesBuffer(r.createVertexBuffer("grl_slopes",0,3));let n=new gi(this._engine,this._ribbonWidths,this._updatable,1);return this.setVerticesBuffer(n.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=n,e}};wo.DEFAULT_WIDTH=.1;wo._RightHandedForwardReadOnlyQuaternion=q.RotationAxis(p.RightHandedForwardReadOnly,Math.PI/2);wo._LeftHandedForwardReadOnlyQuaternion=q.RotationAxis(p.LeftHandedForwardReadOnly,Math.PI/2);wo._LeftReadOnlyQuaternion=q.RotationAxis(p.LeftReadOnly,Math.PI/2);wo.DIRECTION_XY=p.LeftHandedForwardReadOnly;wo.DIRECTION_XZ=p.UpReadOnly;wo.DIRECTION_YZ=p.LeftReadOnly;k.prototype.thinInstanceAdd=function(s,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return F.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(s)?s.length:1);let t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(s))for(let i=0;i<s.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,s[i],i===s.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,s,e);return t};k.prototype.thinInstanceAddSelf=function(s=!0){return this.thinInstanceAdd(N.IdentityReadOnly,s)};k.prototype.thinInstanceRegisterAttribute=function(s,e){s===y.ColorKind&&(s=y.ColorInstanceKind),this.removeVerticesData(s),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[s]=e,this._userThinInstanceBuffersStorage.sizes[s]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[s]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[s]),this._userThinInstanceBuffersStorage.vertexBuffers[s]=new y(this.getEngine(),this._userThinInstanceBuffersStorage.data[s],s,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s])};k.prototype.thinInstanceSetMatrixAt=function(s,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||s>=this._thinInstanceDataStorage.instancesCount)return!1;let i=this._thinInstanceDataStorage.matrixData;return e.copyToArray(i,s*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[s]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};k.prototype.thinInstanceSetAttributeAt=function(s,e,t,i=!0){return s===y.ColorKind&&(s=y.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[s]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(s,0),this._userThinInstanceBuffersStorage.data[s].set(t,e*this._userThinInstanceBuffersStorage.strides[s]),i&&this.thinInstanceBufferUpdated(s),!0)};Object.defineProperty(k.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(s){let e=this._thinInstanceDataStorage.matrixData??this.source?._thinInstanceDataStorage.matrixData,t=e?e.length/16:0;s<=t&&(this._thinInstanceDataStorage.instancesCount=s)},enumerable:!0,configurable:!0});k.prototype._thinInstanceCreateMatrixBuffer=function(s,e,t=!0){let i=new gi(this.getEngine(),e,!t,16,!1,!0);for(let r=0;r<4;r++)this.setVerticesBuffer(i.createVertexBuffer(s+r,r*4,4));return i};k.prototype.thinInstanceSetBuffer=function(s,e,t=0,i=!0){t=t||16,s==="matrix"?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):s==="previousMatrix"?(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(s===y.ColorKind&&(s=y.ColorInstanceKind),e===null?this._userThinInstanceBuffersStorage?.data[s]&&(this.removeVerticesData(s),delete this._userThinInstanceBuffersStorage.data[s],delete this._userThinInstanceBuffersStorage.strides[s],delete this._userThinInstanceBuffersStorage.sizes[s],delete this._userThinInstanceBuffersStorage.vertexBuffers[s]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[s]=e,this._userThinInstanceBuffersStorage.strides[s]=t,this._userThinInstanceBuffersStorage.sizes[s]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[s]=new y(this.getEngine(),e,s,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s])))};k.prototype.thinInstanceBufferUpdated=function(s){s==="matrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(s),this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):s==="previousMatrix"?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(s),this._thinInstanceDataStorage.previousMatrixBuffer?.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):(s===y.ColorKind&&(s=y.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[s]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[s].isUpdatable()&&this._thinInstanceRecreateBuffer(s),this._userThinInstanceBuffersStorage.vertexBuffers[s].updateDirectly(this._userThinInstanceBuffersStorage.data[s],0)))};k.prototype.thinInstancePartialBufferUpdate=function(s,e,t){s==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(s===y.ColorKind&&(s=y.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[s]&&this._userThinInstanceBuffersStorage.vertexBuffers[s].updateDirectly(e,t))};k.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];let s=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=N.FromArray(s,e*16)}return this._thinInstanceDataStorage.worldMatrices};k.prototype.thinInstanceRefreshBoundingInfo=function(s=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;let i=this._thinInstanceDataStorage.boundingVectors;if(s||!this.rawBoundingInfo){i.length=0,this.refreshBoundingInfo(e,t);let o=this.getBoundingInfo();this.rawBoundingInfo=new dr(o.minimum,o.maximum)}let r=this.getBoundingInfo(),n=this._thinInstanceDataStorage.matrixData;if(i.length===0)for(let o=0;o<r.boundingBox.vectors.length;++o)i.push(r.boundingBox.vectors[o].clone());O.Vector3[0].setAll(Number.POSITIVE_INFINITY),O.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let o=0;o<this._thinInstanceDataStorage.instancesCount;++o){N.FromArrayToRef(n,o*16,O.Matrix[0]);for(let a=0;a<i.length;++a)p.TransformCoordinatesToRef(i[a],O.Matrix[0],O.Vector3[2]),O.Vector3[0].minimizeInPlace(O.Vector3[2]),O.Vector3[1].maximizeInPlace(O.Vector3[2])}r.reConstruct(O.Vector3[0],O.Vector3[1]),this._updateBoundingInfo()};k.prototype._thinInstanceRecreateBuffer=function(s,e=!0){s==="matrix"?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,e)):s==="previousMatrix"?this._scene.needsPreviousWorldMatrices&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,e)):(s===y.ColorKind&&(s=y.ColorInstanceKind),this._userThinInstanceBuffersStorage.vertexBuffers[s]?.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[s]=new y(this.getEngine(),this._userThinInstanceBuffersStorage.data[s],s,!e,!1,this._userThinInstanceBuffersStorage.strides[s],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s]))};k.prototype._thinInstanceUpdateBufferSize=function(s,e=1){s===y.ColorKind&&(s=y.ColorInstanceKind);let t=s==="matrix";if(!t&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[s]))return;let i=t?16:this._userThinInstanceBuffersStorage.strides[s],r=t?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[s],n=t?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[s],o=(this._thinInstanceDataStorage.instancesCount+e)*i,a=r;for(;a<o;)a*=2;if(!n||r!=a){if(!n)n=new Float32Array(a);else{let l=new Float32Array(a);l.set(n,0),n=l}t?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",n,!1),this._thinInstanceDataStorage.matrixData=n,this._thinInstanceDataStorage.matrixBufferSize=a,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",n,!1))):(this._userThinInstanceBuffersStorage.vertexBuffers[s]?.dispose(),this._userThinInstanceBuffersStorage.data[s]=n,this._userThinInstanceBuffersStorage.sizes[s]=a,this._userThinInstanceBuffersStorage.vertexBuffers[s]=new y(this.getEngine(),n,s,!0,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[s]))}};k.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};k.prototype._disposeThinInstanceSpecificData=function(){this._thinInstanceDataStorage?.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};var M=function(s){return s[s.Int=1]="Int",s[s.Float=2]="Float",s[s.Vector2=4]="Vector2",s[s.Vector3=8]="Vector3",s[s.Vector4=16]="Vector4",s[s.Matrix=32]="Matrix",s[s.Geometry=64]="Geometry",s[s.Texture=128]="Texture",s[s.AutoDetect=1024]="AutoDetect",s[s.BasedOnInput=2048]="BasedOnInput",s[s.Undefined=4096]="Undefined",s[s.All=4095]="All",s}(M||{});var yh=function(s){return s[s.Compatible=0]="Compatible",s[s.TypeIncompatible=1]="TypeIncompatible",s[s.HierarchyIssue=2]="HierarchyIssue",s}(yh||{}),jm=function(s){return s[s.Input=0]="Input",s[s.Output=1]="Output",s}(jm||{}),$m=class{get direction(){return this._direction}get type(){if(this._type===M.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===M.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}_resetCounters(){this._callCount=0,this._executionCount=0}get callCount(){return this._callCount}get executionCount(){return this._executionCount}getConnectedValue(e){return this.isConnected?this._connectedPoint?._storedFunction?(this._connectedPoint._callCount++,this._connectedPoint._executionCount++,this._connectedPoint._storedFunction(e)):(this._connectedPoint._callCount++,this._connectedPoint._executionCount=1,this._connectedPoint._storedValue):(this._callCount++,this._executionCount=1,this.value)}constructor(e,t,i){this._connectedPoint=null,this._storedValue=null,this._storedFunction=null,this._acceptedConnectionPointType=null,this._endpoints=new Array,this._type=M.Geometry,this._linkedConnectionSource=null,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new U,this.onDisconnectionObservable=new U,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this.defaultValue=null,this.value=null,this.valueMin=null,this.valueMax=null,this._callCount=0,this._executionCount=0,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeGeometryConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===yh.Compatible}checkCompatibilityState(e){let t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==M.AutoDetect)return e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1?yh.Compatible:yh.TypeIncompatible;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return yh.TypeIncompatible;let r=i,n=t;return this.direction===jm.Input&&(r=t,n=i),r.isAnAncestorOf(n)?yh.HierarchyIssue:yh.Compatible}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){let t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this),this)}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<M.All;)e&t||this.excludedConnectionPointTypes.push(t),t=t<<1}serialize(e=!0){let t={};return t.name=this.name,t.displayName=this.displayName,this.value!==void 0&&this.value!==null&&(this.value.asArray?(t.valueType="BABYLON."+this.value.getClassName(),t.value=this.value.asArray()):(t.valueType="number",t.value=this.value)),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear()}};var fe=class{get buildExecutionTime(){return this._buildExecutionTime}get inputs(){return this._inputs}get outputs(){return this._outputs}get name(){return this._name}set name(e){this._name=e}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isDebug(){return this._isDebug}get isUnique(){return this._isUnique}getClassName(){return"NodeGeometryBlock"}_inputRename(e){return e}_outputRename(e){return e}isAnAncestorOf(e){for(let t of this._outputs)if(t.hasEndpoints){for(let i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(let t of this._outputs)if(t.hasEndpoints){for(let i of t.endpoints)if(i.ownerBlock.isAnAncestorOfType(e))return!0}return!1}getDescendantOfPredicate(e){if(e(this))return this;for(let t of this._outputs)if(t.hasEndpoints)for(let i of t.endpoints){let r=i.ownerBlock.getDescendantOfPredicate(e);if(r)return r}return null}constructor(e){this._name="",this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._isDebug=!1,this._isUnique=!1,this._buildExecutionTime=0,this.onBuildObservable=new U,this._inputs=new Array,this._outputs=new Array,this._codeVariableName="",this.visibleOnFrame=!1,this._name=e,this.uniqueId=xu.UniqueId}registerInput(e,t,i=!1,r,n,o){let a=new $m(e,this,jm.Input);return a.type=t,a.isOptional=i,a.defaultValue=r,a.value=r,a.valueMin=n,a.valueMax=o,this._inputs.push(a),this}registerOutput(e,t,i){return i=i??new $m(e,this,jm.Output),i.type=t,this._outputs.push(i),this}_buildBlock(e){}_customBuildStep(e){}build(e){if(this._buildId===e.buildId)return!0;if(this._outputs.length>0){if(!this._outputs.some(i=>i.hasEndpoints)&&!this.isDebug)return!1;this.outputs.forEach(i=>i._resetCounters())}this._buildId=e.buildId;for(let i of this._inputs){if(!i.connectedPoint){i.isOptional||e.notConnectedNonOptionalInputs.push(i);continue}let r=i.connectedPoint.ownerBlock;r&&r!==this&&r.build(e)}this._customBuildStep(e),e.verbose&&F.Log(`Building ${this.name} [${this.getClassName()}]`);let t=Mi.Now;this._buildBlock(e),this._buildExecutionTime=Mi.Now-t;for(let i of this._outputs)for(let r of i.endpoints){let n=r.ownerBlock;n&&n.build(e)}return this.onBuildObservable.notifyObservers(this),!1}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}initialize(){}autoConfigure(){}getInputByName(e){let t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){let t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}serialize(){let e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.visibleOnFrame=this.visibleOnFrame,e.inputs=[],e.outputs=[];for(let t of this.inputs)e.inputs.push(t.serialize());for(let t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e){this._name=e.name,this.comments=e.comments,this.visibleOnFrame=!!e.visibleOnFrame,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){let t=e.inputs,i=e.outputs;t&&t.forEach(r=>{let n=this.inputs.find(o=>o.name===r.name);if(n&&(r.displayName&&(n.displayName=r.displayName),r.isExposedOnFrame&&(n.isExposedOnFrame=r.isExposedOnFrame,n.exposedPortPosition=r.exposedPortPosition),r.value!==void 0&&r.value!==null))if(r.valueType==="number")n.value=r.value;else{let o=Et(r.valueType);o&&(n.value=o.FromArray(r.value))}}),i&&i.forEach((r,n)=>{r.displayName&&(this.outputs[n].displayName=r.displayName),r.isExposedOnFrame&&(this.outputs[n].isExposedOnFrame=r.isExposedOnFrame,this.outputs[n].exposedPortPosition=r.exposedPortPosition)})}_dumpPropertiesCode(){return`${this._codeVariableName}.visibleOnFrame = ${this.visibleOnFrame};
`}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(let i of this.inputs){if(!i.isConnected)continue;let r=i.connectedPoint,n=r.ownerBlock;t+=n._dumpCodeForOutputConnections(e),t+=`${n._codeVariableName}.${n._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});
`}return t}_dumpCode(e,t){t.push(this);let i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let o=0;do o++,this._codeVariableName=i+o;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;this.comments&&(r+=`// ${this.comments}
`);let n=this.getClassName();if(n==="GeometryInputBlock"){let a=this.type;r+=`var ${this._codeVariableName} = new BABYLON.GeometryInputBlock("${this.name}", ${a});
`}else r+=`var ${this._codeVariableName} = new BABYLON.${n}("${this.name}");
`;r+=this._dumpPropertiesCode();for(let o of this.inputs){if(!o.isConnected)continue;let l=o.connectedPoint.ownerBlock;t.indexOf(l)===-1&&(r+=l._dumpCode(e,t))}for(let o of this.outputs)if(o.hasEndpoints)for(let a of o.endpoints){let l=a.ownerBlock;l&&t.indexOf(l)===-1&&(r+=l._dumpCode(e,t))}return r}clone(){let e=this.serialize(),t=Et(e.customType);if(t){let i=new t;return i._deserialize(e),i}return null}dispose(){for(let e of this.inputs)e.dispose();for(let e of this.outputs)e.dispose();this.onBuildObservable.clear()}};v([I("comment")],fe.prototype,"comments",void 0);var qm=class extends fe{get currentVertexData(){return this._vertexData}constructor(e){super(e),this._vertexData=null,this._isUnique=!0,this.registerInput("geometry",M.Geometry)}getClassName(){return"GeometryOutputBlock"}get geometry(){return this._inputs[0]}_buildBlock(e){e.vertexData=this.geometry.getConnectedValue(e),this._vertexData=e.vertexData}};P("BABYLON.GeometryOutputBlock",qm);var St=function(s){return s[s.None=0]="None",s[s.Positions=1]="Positions",s[s.Normals=2]="Normals",s[s.Tangents=3]="Tangents",s[s.UV=4]="UV",s[s.UV2=5]="UV2",s[s.UV3=6]="UV3",s[s.UV4=7]="UV4",s[s.UV5=8]="UV5",s[s.UV6=9]="UV6",s[s.Colors=10]="Colors",s[s.VertexID=11]="VertexID",s[s.FaceID=12]="FaceID",s[s.GeometryID=13]="GeometryID",s[s.CollectionID=14]="CollectionID",s[s.LoopID=15]="LoopID",s[s.InstanceID=16]="InstanceID",s}(St||{});var rC=class{constructor(){this._rotationMatrix=new N,this._scalingMatrix=new N,this._positionMatrix=new N,this._scalingRotationMatrix=new N,this._transformMatrix=new N,this._tempVector3=new p,this.notConnectedNonOptionalInputs=[],this.noContextualData=[],this.vertexData=null,this._geometryContext=null,this._executionContext=null,this._instancingContext=null,this._geometryContextStack=[],this._executionContextStack=[],this._instancingContextStack=[]}get geometryContext(){return this._geometryContext}get executionContext(){return this._executionContext}get instancingContext(){return this._instancingContext}pushGeometryContext(e){this._geometryContext=e,this._geometryContextStack.push(this._geometryContext)}pushExecutionContext(e){this._executionContext=e,this._executionContextStack.push(this._executionContext)}pushInstancingContext(e){this._instancingContext=e,this._instancingContextStack.push(this._instancingContext)}restoreGeometryContext(){this._geometryContextStack.pop(),this._geometryContext=this._geometryContextStack.length>0?this._geometryContextStack[this._geometryContextStack.length-1]:null}restoreExecutionContext(){this._executionContextStack.pop(),this._executionContext=this._executionContextStack.length>0?this._executionContextStack[this._executionContextStack.length-1]:null}restoreInstancingContext(){this._instancingContextStack.pop(),this._instancingContext=this._instancingContextStack.length>0?this._instancingContextStack[this._instancingContextStack.length-1]:null}getContextualValue(e,t=!1){if(!this.executionContext)return t||this.noContextualData.push(e),null;let i=this.executionContext.getExecutionIndex();switch(e){case St.Positions:return this.executionContext.getOverridePositionsContextualValue?this.executionContext.getOverridePositionsContextualValue():!this.geometryContext||!this.geometryContext.positions?p.Zero():p.FromArray(this.geometryContext.positions,i*3);case St.Normals:return this.executionContext.getOverrideNormalsContextualValue?this.executionContext.getOverrideNormalsContextualValue():!this.geometryContext||!this.geometryContext.normals?p.Zero():p.FromArray(this.geometryContext.normals,i*3);case St.Colors:return!this.geometryContext||!this.geometryContext.colors?De.Zero():De.FromArray(this.geometryContext.colors,i*4);case St.Tangents:return!this.geometryContext||!this.geometryContext.tangents?De.Zero():De.FromArray(this.geometryContext.tangents,i*4);case St.UV:return this.executionContext.getOverrideUVs1ContextualValue?this.executionContext.getOverrideUVs1ContextualValue():!this.geometryContext||!this.geometryContext.uvs?j.Zero():j.FromArray(this.geometryContext.uvs,i*2);case St.UV2:return!this.geometryContext||!this.geometryContext.uvs2?j.Zero():j.FromArray(this.geometryContext.uvs2,i*2);case St.UV3:return!this.geometryContext||!this.geometryContext.uvs3?j.Zero():j.FromArray(this.geometryContext.uvs3,i*2);case St.UV4:return!this.geometryContext||!this.geometryContext.uvs4?j.Zero():j.FromArray(this.geometryContext.uvs4,i*2);case St.UV5:return!this.geometryContext||!this.geometryContext.uvs5?j.Zero():j.FromArray(this.geometryContext.uvs5,i*2);case St.UV6:return!this.geometryContext||!this.geometryContext.uvs6?j.Zero():j.FromArray(this.geometryContext.uvs6,i*2);case St.VertexID:return i;case St.FaceID:return this.executionContext.getExecutionFaceIndex();case St.LoopID:return this.executionContext.getExecutionLoopIndex();case St.InstanceID:return this.instancingContext?this.instancingContext.getInstanceIndex():0;case St.GeometryID:return this.geometryContext?this.geometryContext.uniqueId:0;case St.CollectionID:return!this.geometryContext||!this.geometryContext.metadata?0:this.geometryContext.metadata.collectionId||0}return null}adapt(e,t){let i=e.getConnectedValue(this)||0;if(e.type===t)return i;switch(t){case M.Vector2:return new j(i,i);case M.Vector3:return new p(i,i,i);case M.Vector4:return new De(i,i,i,i)}return null}adaptInput(e,t,i){if(!e.isConnected)return e.value||i;let r=e.getConnectedValue(this);if(e._connectedPoint?.type===t)return r;switch(t){case M.Vector2:return new j(r,r);case M.Vector3:return new p(r,r,r);case M.Vector4:return new De(r,r,r,r)}return null}emitErrors(){let e="";for(let t of this.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.
`;for(let t of this.noContextualData)e+=`Contextual input ${St[t]} has no context to pull data from (must be connected to a setXXX block or a instantiateXXX block).
`;if(e)throw`Build of NodeGeometry failed:
`+e}_instantiate(e,t,i,r,n){N.ScalingToRef(r.x,r.y,r.z,this._scalingMatrix),N.RotationYawPitchRollToRef(i.y,i.x,i.z,this._rotationMatrix),N.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),this._scalingMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let o=0;o<e.positions.length;o+=3)this._tempVector3.fromArray(e.positions,o),p.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,o),e.normals&&(this._tempVector3.fromArray(e.normals,o),p.TransformNormalToRef(this._tempVector3,this._scalingRotationMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,o));n.push(e)}_instantiateWithMatrix(e,t,i){for(let r=0;r<e.positions.length;r+=3)this._tempVector3.fromArray(e.positions,r),p.TransformCoordinatesToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.positions,r),e.normals&&(this._tempVector3.fromArray(e.normals,r),p.TransformNormalToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.normals,r));i.push(e)}_instantiateWithPositionAndMatrix(e,t,i,r){N.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),i.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let n=0;n<e.positions.length;n+=3)this._tempVector3.fromArray(e.positions,n),p.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,n),e.normals&&(this._tempVector3.fromArray(e.normals,n),p.TransformNormalToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,n));r.push(e)}};var Vt=class extends fe{get type(){if(this._type===M.AutoDetect&&this.value!=null){if(!isNaN(this.value))return this._type=M.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=M.Vector2,this._type;case"Vector3":return this._type=M.Vector3,this._type;case"Vector4":return this._type=M.Vector4,this._type;case"Matrix":return this._type=M.Matrix,this._type}}return this._type}get isContextual(){return this._contextualSource!==St.None}get contextualValue(){return this._contextualSource}set contextualValue(e){switch(this._contextualSource=e,e){case St.Positions:case St.Normals:this._type=M.Vector3;break;case St.Colors:case St.Tangents:this._type=M.Vector4;break;case St.UV:case St.UV2:case St.UV3:case St.UV4:case St.UV5:case St.UV6:this._type=M.Vector2;break;case St.VertexID:case St.GeometryID:case St.CollectionID:case St.FaceID:case St.LoopID:case St.InstanceID:this._type=M.Int;break}this.output&&(this.output.type=this._type)}constructor(e,t=M.AutoDetect){super(e),this._type=M.Undefined,this._contextualSource=St.None,this.min=0,this.max=0,this.groupInInspector="",this.onValueChangedObservable=new U,this._type=t,this._isInput=!0,this.setDefaultValue(),this.registerOutput("output",t)}get value(){return this._storedValue}set value(e){this.type===M.Float&&this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e)),this._storedValue=e,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e}getClassName(){return"GeometryInputBlock"}get output(){return this._outputs[0]}setDefaultValue(){switch(this.contextualValue=St.None,this.type){case M.Int:case M.Float:this.value=0;break;case M.Vector2:this.value=j.Zero();break;case M.Vector3:this.value=p.Zero();break;case M.Vector4:this.value=De.Zero();break;case M.Matrix:this.value=N.Identity();break}}_buildBlock(e){super._buildBlock(e),this.isContextual?(this.output._storedValue=null,this.output._storedFunction=t=>t.getContextualValue(this._contextualSource)):(this.output._storedFunction=null,this.output._storedValue=this.value)}dispose(){this.onValueChangedObservable.clear(),super.dispose()}_dumpPropertiesCode(){let e=this._codeVariableName;if(this.isContextual)return super._dumpPropertiesCode()+`${e}.contextualValue = BABYLON.NodeGeometryContextualSources.${St[this._contextualSource]};
`;let t=[],i="";switch(this.type){case M.Float:case M.Int:i=`${this.value}`;break;case M.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case M.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case M.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break}return t.push(`${e}.value = ${i}`),(this.type===M.Float||this.type===M.Int)&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`),t.push(""),super._dumpPropertiesCode()+t.join(`;
`)}serialize(){let e=super.serialize();return e.type=this.type,e.contextualValue=this.contextualValue,e.min=this.min,e.max=this.max,e.groupInInspector=this.groupInInspector,this._storedValue!==null&&!this.isContextual&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e){if(super._deserialize(e),this._type=e.type,this.contextualValue=e.contextualValue,this.min=e.min||0,this.max=e.max||0,this.groupInInspector=e.groupInInspector||"",!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{let t=Et(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}};P("BABYLON.GeometryInputBlock",Vt);var of=class extends fe{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("size",M.Float,!0,1),this.registerInput("width",M.Float,!0,0),this.registerInput("height",M.Float,!0,0),this.registerInput("depth",M.Float,!0,0),this.registerInput("subdivisions",M.Int,!0,1),this.registerInput("subdivisionsX",M.Int,!0,0),this.registerInput("subdivisionsY",M.Int,!0,0),this.registerInput("subdivisionsZ",M.Int,!0,0),this.registerOutput("geometry",M.Geometry)}getClassName(){return"BoxBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get depth(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get subdivisionsX(){return this._inputs[5]}get subdivisionsY(){return this._inputs[6]}get subdivisionsZ(){return this._inputs[7]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected&&!this.depth.isConnected){let e=new Vt("Size");e.value=1,e.output.connectTo(this.size);return}if(!this.width.isConnected){let e=new Vt("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){let e=new Vt("Height");e.value=1,e.output.connectTo(this.height)}if(!this.depth.isConnected){let e=new Vt("Depth");e.value=1,e.output.connectTo(this.depth)}}}_buildBlock(e){let t={},i=r=>{t.size=this.size.getConnectedValue(r),t.width=this.width.getConnectedValue(r),t.height=this.height.getConnectedValue(r),t.depth=this.depth.getConnectedValue(r);let n=this.subdivisions.getConnectedValue(r),o=this.subdivisionsX.getConnectedValue(r),a=this.subdivisionsY.getConnectedValue(r),l=this.subdivisionsZ.getConnectedValue(r);return n&&(t.segments=n),o&&(t.widthSegments=o),a&&(t.heightSegments=a),l&&(t.depthSegments=l),pB(t)};if(this.evaluateContext)this.geometry._storedFunction=i;else{let r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],of.prototype,"evaluateContext",void 0);P("BABYLON.BoxBlock",of);var Eh=class s{_getGlobalNodeGeometryEditor(){if(typeof NODEGEOMETRYEDITOR<"u")return NODEGEOMETRYEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeGeometryEditor<"u")return BABYLON}get buildExecutionTime(){return this._buildExecutionTime}constructor(e){this._buildId=s._BuildIdGenerator++,this._buildWasSuccessful=!1,this._vertexData=null,this._buildExecutionTime=0,this.BJSNODEGEOMETRYEDITOR=this._getGlobalNodeGeometryEditor(),this.editorData=null,this.attachedBlocks=[],this.onBuildObservable=new U,this.outputBlock=null,this.name=e}getClassName(){return"NodeGeometry"}getBlockByName(e){let t=null;for(let i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return H.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(let t of this.attachedBlocks)if(e(t))return t;return null}getInputBlocks(){let e=[];for(let t of this.attachedBlocks)t.isInput&&e.push(t);return e}edit(e){return new Promise(t=>{if(this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),typeof this.BJSNODEGEOMETRYEDITOR>"u"){let i=e&&e.editorURL?e.editorURL:s.EditorURL;H.LoadBabylonScript(i,()=>{this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),this._createNodeEditor(e?.nodeGeometryEditorConfig),t()})}else this._createNodeEditor(e?.nodeGeometryEditorConfig),t()})}_createNodeEditor(e){let t=ie({nodeGeometry:this},e);this.BJSNODEGEOMETRYEDITOR.NodeGeometryEditor.Show(t)}build(e=!1,t=!0,i=!1){if(this._buildWasSuccessful=!1,!this.outputBlock)throw"You must define the outputBlock property before building the geometry";let r=Mi.Now;this._initializeBlock(this.outputBlock,i);let n=new rC;n.buildId=this._buildId,n.verbose=e,this.outputBlock.build(n),t&&(this._buildId=s._BuildIdGenerator++),this._buildExecutionTime=Mi.Now-r,n.emitErrors(),this._buildWasSuccessful=!0,this._vertexData=n.vertexData,this.onBuildObservable.notifyObservers(this)}createMesh(e,t=null){if(this._buildWasSuccessful||this.build(),!this._vertexData)return null;let i=new k(e,t);return this._vertexData.applyToMesh(i),i._internalMetadata=i._internalMetadata||{},i._internalMetadata.nodeGeometry=this,i}updateMesh(e){return this._buildWasSuccessful||this.build(),this._vertexData?(this._vertexData.applyToMesh(e),e._internalMetadata=e._internalMetadata||{},e._internalMetadata.nodeGeometry=this,e):!1}_initializeBlock(e,t=!0){e.initialize(),t&&e.autoConfigure(),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1&&this.attachedBlocks.push(e);for(let i of e.inputs){let r=i.connectedPoint;if(r){let n=r.ownerBlock;n!==e&&this._initializeBlock(n,t)}}}clear(){this.outputBlock=null,this.attachedBlocks.length=0}removeBlock(e){let t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e===this.outputBlock&&(this.outputBlock=null)}parseSerializedObject(e,t=!1){t||this.clear();let i={};for(let r of e.blocks){let n=Et(r.customType);if(n){let o=new n;o._deserialize(r),i[r.id]=o,this.attachedBlocks.push(o)}}for(let r of this.attachedBlocks)if(r.isTeleportOut){let n=r,o=n._tempEntryPointUniqueId;if(o){let a=i[o];a&&a.attachToEndpoint(n)}}for(let r=0;r<e.blocks.length;r++){let n=e.blocks[r],o=i[n.id];o&&(o.inputs.length&&n.inputs.some(a=>a.targetConnectionName)&&!t||this._restoreConnections(o,e,i))}if(e.outputNodeId&&(this.outputBlock=i[e.outputNodeId]),e.locations||e.editorData&&e.editorData.locations){let r=e.locations||e.editorData.locations;for(let o of r)i[o.blockId]&&(o.blockId=i[o.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&r.concat(this.editorData.locations),e.locations?this.editorData={locations:r}:(this.editorData=e.editorData,this.editorData.locations=r);let n=[];for(let o in i)n[o]=i[o].uniqueId;this.editorData.map=n}this.comment=e.comment}_restoreConnections(e,t,i){for(let r of e.outputs)for(let n of t.blocks){let o=i[n.id];if(o){for(let a of n.inputs)if(i[a.targetBlockId]===e&&a.targetConnectionName===r.name){let l=o.getInputByName(a.inputName);if(!l||l.isConnected)continue;r.connectTo(l,!0),this._restoreConnections(o,t,i);continue}}}}generateCode(){let e=[],t=[],i=["const","var","let"];this.outputBlock&&this._gatherBlocks(this.outputBlock,t);let r=`let nodeGeometry = new BABYLON.NodeGeometry("${this.name||"node geometry"}");
`;for(let n of t)n.isInput&&e.indexOf(n)===-1&&(r+=n._dumpCode(i,e));return this.outputBlock&&(e=[],r+=`// Connections
`,r+=this.outputBlock._dumpCodeForOutputConnections(e),r+=`// Output nodes
`,r+=`nodeGeometry.outputBlock = ${this.outputBlock._codeVariableName};
`,r+=`nodeGeometry.build();
`),r}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(let i of e.inputs){let r=i.connectedPoint;if(r){let n=r.ownerBlock;n!==e&&this._gatherBlocks(n,t)}}if(e.isTeleportOut){let i=e;i.entryPoint&&this._gatherBlocks(i.entryPoint,t)}}}setToDefault(){this.clear(),this.editorData=null;let e=new of("Box");e.autoConfigure();let t=new qm("Geometry Output");e.geometry.connectTo(t.geometry),this.outputBlock=t}clone(e){let t=this.serialize(),i=ae.Clone(()=>new s(e),this);return i.name=e,i.parseSerializedObject(t),i._buildId=this._buildId,i.build(!1),i}serialize(e){let t=e?{}:ae.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];e?i=e:(t.customType="BABYLON.NodeGeometry",this.outputBlock&&(t.outputNodeId=this.outputBlock.uniqueId)),t.blocks=[];for(let r of i)t.blocks.push(r.serialize());if(!e)for(let r of this.attachedBlocks)i.indexOf(r)===-1&&t.blocks.push(r.serialize());return t}dispose(){for(let e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this.onBuildObservable.clear()}static CreateDefault(e){let t=new s(e);return t.setToDefault(),t.build(),t}static Parse(e){let t=ae.Parse(()=>new s(e.name),e,null);return t.parseSerializedObject(e),t.build(),t}static ParseFromSnippetAsync(e,t,i=!1){return e==="_BLANK"?Promise.resolve(s.CreateDefault("blank")):new Promise((r,n)=>{let o=new gr;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){let a=JSON.parse(JSON.parse(o.responseText).jsonPayload),l=JSON.parse(a.nodeGeometry);t||(t=ae.Parse(()=>new s(e),l,null)),t.parseSerializedObject(l),t.snippetId=e;try{i||t.build(),r(t)}catch(c){n(c)}}else n("Unable to load the snippet "+e)}),o.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),o.send()})}};Eh._BuildIdGenerator=0;Eh.EditorURL=`${H._DefaultCdnUrl}/v${K.Version}/nodeGeometryEditor/babylon.nodeGeometryEditor.js`;Eh.SnippetUrl="https://snippet.babylonjs.com";v([I()],Eh.prototype,"name",void 0);v([I("comment")],Eh.prototype,"comment",void 0);var Qm=class extends fe{constructor(e){super(e),this.evaluateContext=!0,this.epsilon=je,this.registerInput("geometry",M.Geometry),this.registerOutput("output",M.Geometry)}getClassName(){return"GeometryOptimizeBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){let t=i=>{if(!this.geometry.isConnected)return null;let r=this.geometry.getConnectedValue(i),n=[],o={};for(let l=0;l<r.positions.length;l+=3){let c=r.positions[l],h=r.positions[l+1],u=r.positions[l+2],d=!1;for(let f=0;f<n.length;f+=3)if(xe.WithinEpsilon(c,n[f],this.epsilon)&&xe.WithinEpsilon(h,n[f+1],this.epsilon)&&xe.WithinEpsilon(u,n[f+2],this.epsilon)){o[l/3]=f/3,d=!0;continue}d||(o[l/3]=n.length/3,n.push(c,h,u))}let a=new le;return a.positions=n,a.indices=r.indices.map(l=>o[l]),a};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.epsilon = ${this.epsilon};
`,e}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e.epsilon=this.epsilon,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,this.epsilon=e.epsilon}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Qm.prototype,"evaluateContext",void 0);v([de("Epsilon",ue.Float,"ADVANCED",{notifiers:{rebuild:!0}})],Qm.prototype,"epsilon",void 0);P("BABYLON.GeometryOptimizeBlock",Qm);var sC=class extends fe{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("size",M.Float,!0,1),this.registerInput("width",M.Float,!0,0),this.registerInput("height",M.Float,!0,0),this.registerOutput("geometry",M.Geometry)}getClassName(){return"PlaneBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected){let e=new Vt("Size");e.value=1,e.output.connectTo(this.size);return}if(!this.width.isConnected){let e=new Vt("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){let e=new Vt("Height");e.value=1,e.output.connectTo(this.height)}}}_buildBlock(e){let t={},i=r=>(t.size=this.size.getConnectedValue(r),t.width=this.width.getConnectedValue(r),t.height=this.height.getConnectedValue(r),jx(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],sC.prototype,"evaluateContext",void 0);P("BABYLON.PlaneBlock",sC);var nC=class extends fe{get mesh(){return this._mesh}set mesh(e){this._mesh=e}constructor(e){super(e),this._cachedVertexData=null,this.reverseWindingOrder=!1,this.serializedCachedData=!1,this.registerOutput("geometry",M.Geometry)}getClassName(){return"MeshBlock"}get isUsingCachedData(){return!this.mesh&&!!this._cachedVertexData}get geometry(){return this._outputs[0]}cleanData(){this._mesh=null,this._cachedVertexData=null}_buildBlock(){if(!this._mesh){this._cachedVertexData?this.geometry._storedValue=this._cachedVertexData.clone():this.geometry._storedValue=null;return}let e=le.ExtractFromMesh(this._mesh,!1,!0);if(this._cachedVertexData=null,this.reverseWindingOrder&&e.indices)for(let t=0;t<e.indices.length;t+=3){let i=e.indices[t];e.indices[t]=e.indices[t+2],e.indices[t+2]=i}this.geometry._storedFunction=()=>e.clone()}serialize(){let e=super.serialize();return e.serializedCachedData=this.serializedCachedData,this.serializedCachedData&&(this._mesh?e.cachedVertexData=le.ExtractFromMesh(this._mesh,!1,!0).serialize():this._cachedVertexData&&(e.cachedVertexData=this._cachedVertexData.serialize())),e.reverseWindingOrder=this.reverseWindingOrder,e}_deserialize(e){super._deserialize(e),e.cachedVertexData&&(this._cachedVertexData=le.Parse(e.cachedVertexData)),this.serializedCachedData=!!e.serializedCachedData,this.reverseWindingOrder=e.reverseWindingOrder}};v([de("Serialize cached data",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],nC.prototype,"serializedCachedData",void 0);P("BABYLON.MeshBlock",nC);var oC=class extends fe{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",M.Float,!0,1),this.registerInput("radiusX",M.Float,!0,0),this.registerInput("radiusY",M.Float,!0,0),this.registerInput("radiusZ",M.Float,!0,0),this.registerInput("subdivisions",M.Int,!0,4),this.registerOutput("geometry",M.Geometry)}getClassName(){return"IcoSphereBlock"}get radius(){return this._inputs[0]}get radiusX(){return this._inputs[1]}get radiusY(){return this._inputs[2]}get radiusZ(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){let e=new Vt("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){let t={},i=r=>(t.radius=this.radius.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),t.radiusX=this.radiusX.getConnectedValue(r),t.radiusY=this.radiusY.getConnectedValue(r),t.radiusZ=this.radiusZ.getConnectedValue(r),Jx(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],oC.prototype,"evaluateContext",void 0);P("BABYLON.IcoSphereBlock",oC);var aC=class extends fe{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("segments",M.Int,!0,32),this.registerInput("diameter",M.Float,!0,1),this.registerInput("diameterX",M.Float,!0,0),this.registerInput("diameterY",M.Float,!0,0),this.registerInput("diameterZ",M.Float,!0,0),this.registerInput("arc",M.Float,!0,1),this.registerInput("slice",M.Float,!0,1),this.registerOutput("geometry",M.Geometry)}getClassName(){return"SphereBlock"}get segments(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterX(){return this._inputs[2]}get diameterY(){return this._inputs[3]}get diameterZ(){return this._inputs[4]}get arc(){return this._inputs[5]}get slice(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){let e=new Vt("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){let t={},i=r=>(t.segments=this.segments.getConnectedValue(r),t.diameter=this.diameter.getConnectedValue(r),t.diameterX=this.diameterX.getConnectedValue(r),t.diameterY=this.diameterY.getConnectedValue(r),t.diameterZ=this.diameterZ.getConnectedValue(r),t.arc=this.arc.getConnectedValue(r),t.slice=this.slice.getConnectedValue(r),bv(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],aC.prototype,"evaluateContext",void 0);P("BABYLON.SphereBlock",aC);var lC=class extends fe{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("width",M.Float,!0,1),this.registerInput("height",M.Float,!0,1),this.registerInput("subdivisions",M.Int,!0,1),this.registerInput("subdivisionsX",M.Int,!0,0),this.registerInput("subdivisionsY",M.Int,!0,0),this.registerOutput("geometry",M.Geometry)}getClassName(){return"GridBlock"}get width(){return this._inputs[0]}get height(){return this._inputs[1]}get subdivisions(){return this._inputs[2]}get subdivisionsX(){return this._inputs[3]}get subdivisionsY(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.width.isConnected){let e=new Vt("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){let e=new Vt("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){let t={},i=r=>(t.width=this.width.getConnectedValue(r),t.height=this.height.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),t.subdivisionsX=this.subdivisionsX.getConnectedValue(r),t.subdivisionsY=this.subdivisionsY.getConnectedValue(r),Ao(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],lC.prototype,"evaluateContext",void 0);P("BABYLON.GridBlock",lC);var cC=class extends fe{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("diameter",M.Float,!0,1),this.registerInput("thickness",M.Float,!0,.5),this.registerInput("tessellation",M.Int,!0,16),this.registerOutput("geometry",M.Geometry)}getClassName(){return"TorusBlock"}get diameter(){return this._inputs[0]}get thickness(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){let e=new Vt("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){let t={},i=r=>(t.thickness=this.thickness.getConnectedValue(r),t.diameter=this.diameter.getConnectedValue(r),t.tessellation=this.tessellation.getConnectedValue(r),gv(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],cC.prototype,"evaluateContext",void 0);P("BABYLON.TorusBlock",cC);var hC=class extends fe{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",M.Float,!0,25),this.registerInput("diameter",M.Float,!0,1),this.registerInput("diameterTop",M.Float,!0,-1),this.registerInput("diameterBottom",M.Float,!0,-1),this.registerInput("subdivisions",M.Int,!0,1),this.registerInput("tessellation",M.Int,!0,24),this.registerInput("arc",M.Float,!0,1),this.registerOutput("geometry",M.Geometry)}getClassName(){return"CylinderBlock"}get height(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterTop(){return this._inputs[2]}get diameterBottom(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get tessellation(){return this._inputs[5]}get arc(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){let e=new Vt("Diameter");e.value=1,e.output.connectTo(this.diameter)}if(!this.height.isConnected){let e=new Vt("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){let t={},i=r=>(t.height=this.height.getConnectedValue(r),t.diameter=this.diameter.getConnectedValue(r),t.diameterTop=this.diameterTop.getConnectedValue(r),t.diameterBottom=this.diameterBottom.getConnectedValue(r),t.diameterTop===-1&&(t.diameterTop=t.diameter),t.diameterBottom===-1&&(t.diameterBottom=t.diameter),t.tessellation=this.tessellation.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),t.arc=this.arc.getConnectedValue(r),Tv(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],hC.prototype,"evaluateContext",void 0);P("BABYLON.CylinderBlock",hC);var uC=class extends fe{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",M.Float,!0,1),this.registerInput("radius",M.Float,!0,.25),this.registerInput("tessellation",M.Int,!0,16),this.registerInput("subdivisions",M.Int,!0,2),this.registerOutput("geometry",M.Geometry)}getClassName(){return"CapsuleBlock"}get height(){return this._inputs[0]}get radius(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.height.isConnected){let e=new Vt("Height");e.value=1,e.output.connectTo(this.height)}if(!this.radius.isConnected){let e=new Vt("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){let t={},i=r=>(t.height=this.height.getConnectedValue(r),t.radius=this.radius.getConnectedValue(r),t.tessellation=this.tessellation.getConnectedValue(r),t.subdivisions=this.subdivisions.getConnectedValue(r),Sv(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],uC.prototype,"evaluateContext",void 0);P("BABYLON.CapsuleBlock",uC);var dC=class extends fe{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",M.Float,!0,.5),this.registerInput("tessellation",M.Int,!0,64),this.registerInput("arc",M.Float,!0,1),this.registerOutput("geometry",M.Geometry)}getClassName(){return"DiscBlock"}get radius(){return this._inputs[0]}get tessellation(){return this._inputs[1]}get arc(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){let e=new Vt("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){let t={},i=r=>(t.radius=this.radius.getConnectedValue(r),t.tessellation=this.tessellation.getConnectedValue(r),t.arc=this.arc.getConnectedValue(r),yv(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let r=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,r.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],dC.prototype,"evaluateContext",void 0);P("BABYLON.DiscBlock",dC);var fP=class extends fe{constructor(e){super(e),this.registerOutput("geometry",M.Geometry)}getClassName(){return"NullBlock"}get geometry(){return this._outputs[0]}_buildBlock(){this.geometry._storedValue=null}};P("BABYLON.NullBlock",fP);var fC=class extends fe{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",M.Geometry),this.registerInput("positions",M.Vector3),this.registerOutput("output",M.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetPositionsBlock"}get geometry(){return this._inputs[0]}get positions(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){let t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.positions.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}let r=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){let n=this.positions.getConnectedValue(i);n&&n.toArray(this._vertexData.positions,this._currentIndex*3)}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],fC.prototype,"evaluateContext",void 0);P("BABYLON.SetPositionsBlock",fC);var pC=class extends fe{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",M.Geometry),this.registerInput("normals",M.Vector3),this.registerOutput("output",M.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetNormalsBlock"}get geometry(){return this._inputs[0]}get normals(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){let t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.normals.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.normals||(this._vertexData.normals=[]);let r=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){let n=this.normals.getConnectedValue(i);n&&n.toArray(this._vertexData.normals,this._currentIndex*3)}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],pC.prototype,"evaluateContext",void 0);P("BABYLON.SetNormalsBlock",pC);var Km=class extends fe{constructor(e){super(e),this.evaluateContext=!0,this.textureCoordinateIndex=0,this.registerInput("geometry",M.Geometry),this.registerInput("uvs",M.Vector2),this.registerOutput("output",M.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetUVsBlock"}get geometry(){return this._inputs[0]}get uvs(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){let t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.uvs.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}let r=[],n=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<n;this._currentIndex++){let o=this.uvs.getConnectedValue(i);o&&o.toArray(r,this._currentIndex*2)}switch(this.textureCoordinateIndex){case 0:this._vertexData.uvs=r;break;case 1:this._vertexData.uvs2=r;break;case 2:this._vertexData.uvs3=r;break;case 3:this._vertexData.uvs4=r;break;case 4:this._vertexData.uvs5=r;break;case 5:this._vertexData.uvs6=r;break}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.textureCoordinateIndex};
`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`,e}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e.textureCoordinateIndex=this.textureCoordinateIndex,e}_deserialize(e){super._deserialize(e),this.textureCoordinateIndex=e.textureCoordinateIndex,e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Km.prototype,"evaluateContext",void 0);v([de("Texture coordinates index",ue.List,"ADVANCED",{notifiers:{update:!0},options:[{label:"UV1",value:0},{label:"UV2",value:1},{label:"UV3",value:2},{label:"UV4",value:3},{label:"UV5",value:4},{label:"UV6",value:5}]})],Km.prototype,"textureCoordinateIndex",void 0);P("BABYLON.SetUVsBlock",Km);var mC=class extends fe{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",M.Geometry),this.registerInput("colors",M.AutoDetect),this.registerOutput("output",M.Geometry),this._inputs[1].excludedConnectionPointTypes.push(M.Int),this._inputs[1].excludedConnectionPointTypes.push(M.Float),this._inputs[1].excludedConnectionPointTypes.push(M.Vector2),this._inputs[1].excludedConnectionPointTypes.push(M.Texture),this._inputs[1].excludedConnectionPointTypes.push(M.Texture)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetColorsBlock"}get geometry(){return this._inputs[0]}get colors(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){let t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.colors.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.colors||(this._vertexData.colors=[]);let r=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++)if(this.colors.connectedPoint?.type===M.Vector3){let n=this.colors.getConnectedValue(i);n&&(n.toArray(this._vertexData.colors,this._currentIndex*4),this._vertexData.colors[this._currentIndex*4+3]=1,this._vertexData.hasVertexAlpha=!1)}else{let n=this.colors.getConnectedValue(i);n&&(n.toArray(this._vertexData.colors,this._currentIndex*4),this._vertexData.hasVertexAlpha=!0)}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],mC.prototype,"evaluateContext",void 0);P("BABYLON.SetColorsBlock",mC);var gC=class extends fe{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",M.Geometry),this.registerInput("tangents",M.Vector4),this.registerOutput("output",M.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetTangentsBlock"}get geometry(){return this._inputs[0]}get tangents(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){let t=i=>{if(i.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(i),this._vertexData&&(this._vertexData=this._vertexData.clone()),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.tangents.isConnected){i.restoreGeometryContext(),i.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.tangents||(this._vertexData.tangents=[]);let r=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){let n=this.tangents.getConnectedValue(i);n&&n.toArray(this._vertexData.tangents,this._currentIndex*4)}return i.restoreGeometryContext(),i.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],gC.prototype,"evaluateContext",void 0);P("BABYLON.SetTangentsBlock",gC);var ks=function(s){return s[s.Add=0]="Add",s[s.Subtract=1]="Subtract",s[s.Multiply=2]="Multiply",s[s.Divide=3]="Divide",s[s.Max=4]="Max",s[s.Min=5]="Min",s}(ks||{}),_C=class extends fe{constructor(e){super(e),this.operation=ks.Add,this.registerInput("left",M.AutoDetect),this.registerInput("right",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this.output._typeConnectionSource=this.left;let t=[M.Matrix,M.Geometry,M.Texture];this.left.excludedConnectionPointTypes.push(...t),this.right.excludedConnectionPointTypes.push(...t),this._linkConnectionTypes(0,1),this._connectionObservers=[this.left.onConnectionObservable.add(()=>this._updateInputOutputTypes()),this.left.onDisconnectionObservable.add(()=>this._updateInputOutputTypes()),this.right.onConnectionObservable.add(()=>this._updateInputOutputTypes()),this.right.onDisconnectionObservable.add(()=>this._updateInputOutputTypes())]}getClassName(){return"MathBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){let e,t=this.left,i=this.right;if(!t.isConnected||!i.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let r=t.type===M.Float||t.type===M.Int,n=i.type===M.Float||i.type===M.Int,o=r&&n;switch(this.operation){case ks.Add:{o?e=a=>t.getConnectedValue(a)+i.getConnectedValue(a):r?e=a=>a.adapt(t,i.type).add(i.getConnectedValue(a)):e=a=>t.getConnectedValue(a).add(a.adapt(i,t.type));break}case ks.Subtract:{o?e=a=>t.getConnectedValue(a)-i.getConnectedValue(a):r?e=a=>a.adapt(t,i.type).subtract(i.getConnectedValue(a)):e=a=>t.getConnectedValue(a).subtract(a.adapt(i,t.type));break}case ks.Multiply:{o?e=a=>t.getConnectedValue(a)*i.getConnectedValue(a):r?e=a=>a.adapt(t,i.type).multiply(i.getConnectedValue(a)):e=a=>t.getConnectedValue(a).multiply(a.adapt(i,t.type));break}case ks.Divide:{o?e=a=>t.getConnectedValue(a)/i.getConnectedValue(a):r?e=a=>a.adapt(t,i.type).divide(i.getConnectedValue(a)):e=a=>t.getConnectedValue(a).divide(a.adapt(i,t.type));break}case ks.Min:{if(o)e=a=>Math.min(t.getConnectedValue(a),i.getConnectedValue(a));else{let[a,l]=r?[i,t]:[t,i];switch(a.type){case M.Vector2:{e=c=>j.Minimize(a.getConnectedValue(c),c.adapt(l,a.type));break}case M.Vector3:{e=c=>p.Minimize(a.getConnectedValue(c),c.adapt(l,a.type));break}case M.Vector4:{e=c=>De.Minimize(a.getConnectedValue(c),c.adapt(l,a.type));break}}}break}case ks.Max:if(o)e=a=>Math.max(t.getConnectedValue(a),i.getConnectedValue(a));else{let[a,l]=r?[i,t]:[t,i];switch(a.type){case M.Vector2:{e=c=>j.Maximize(a.getConnectedValue(c),c.adapt(l,a.type));break}case M.Vector3:{e=c=>p.Maximize(a.getConnectedValue(c),c.adapt(l,a.type));break}case M.Vector4:{e=c=>De.Maximize(a.getConnectedValue(c),c.adapt(l,a.type));break}}break}}this.output._storedFunction=a=>t.type===M.Int?e(a)|0:e(a)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.MathBlockOperations.${ks[this.operation]};
`}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===M.Int||this.left.type===M.Float&&this.right.type!==M.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(let[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[M.Int,M.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===M.Int||t.type===M.Float)&&e.acceptedConnectionPointTypes.push(M.Vector2,M.Vector3,M.Vector4))}dispose(){super.dispose(),this._connectionObservers.forEach(e=>e.remove()),this._connectionObservers.length=0}serialize(){let e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}};v([de("Operation",ue.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Add",value:ks.Add},{label:"Subtract",value:ks.Subtract},{label:"Multiply",value:ks.Multiply},{label:"Divide",value:ks.Divide},{label:"Max",value:ks.Max},{label:"Min",value:ks.Min}]})],_C.prototype,"operation",void 0);P("BABYLON.MathBlock",_C);var pP=class extends fe{constructor(e){super(e),this.registerInput("value",M.AutoDetect),this.registerInput("fromMin",M.Float,!0,0),this.registerInput("fromMax",M.Float,!0,1),this.registerInput("toMin",M.Float,!0,0),this.registerInput("toMax",M.Float,!0,1),this.registerOutput("output",M.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(M.Vector2),this._inputs[0].excludedConnectionPointTypes.push(M.Vector3),this._inputs[0].excludedConnectionPointTypes.push(M.Vector4),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"MapRangeBlock"}get value(){return this._inputs[0]}get fromMin(){return this._inputs[1]}get fromMax(){return this._inputs[2]}get toMin(){return this._inputs[3]}get toMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}this.output._storedFunction=e=>{let t=this.value.getConnectedValue(e),i=this.fromMin.getConnectedValue(e),r=this.fromMax.getConnectedValue(e),n=this.toMin.getConnectedValue(e),o=this.toMax.getConnectedValue(e),a=(t-i)/(r-i)*(o-n)+n;return this.output.type===M.Int?Math.floor(a):a}}};P("BABYLON.MapRangeBlock",pP);var Sr=function(s){return s[s.Equal=0]="Equal",s[s.NotEqual=1]="NotEqual",s[s.LessThan=2]="LessThan",s[s.GreaterThan=3]="GreaterThan",s[s.LessOrEqual=4]="LessOrEqual",s[s.GreaterOrEqual=5]="GreaterOrEqual",s[s.Xor=6]="Xor",s[s.Or=7]="Or",s[s.And=8]="And",s}(Sr||{}),xC=class extends fe{constructor(e){super(e),this.test=Sr.Equal,this.registerInput("left",M.Float),this.registerInput("right",M.Float,!0,0),this.registerInput("ifTrue",M.AutoDetect,!0,1),this.registerInput("ifFalse",M.AutoDetect,!0,0),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=M.Float,this._inputs[0].acceptedConnectionPointTypes.push(M.Int),this._inputs[1].acceptedConnectionPointTypes.push(M.Int),this._linkConnectionTypes(2,3)}getClassName(){return"ConditionBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get ifTrue(){return this._inputs[2]}get ifFalse(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=t=>{let i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),n=!1;switch(this.test){case Sr.Equal:n=xe.WithinEpsilon(i,r,je);break;case Sr.NotEqual:n=i!==r;break;case Sr.LessThan:n=i<r;break;case Sr.GreaterThan:n=i>r;break;case Sr.LessOrEqual:n=i<=r;break;case Sr.GreaterOrEqual:n=i>=r;break;case Sr.Xor:n=!!i&&!r||!i&&!!r;break;case Sr.Or:n=!!i||!!r;break;case Sr.And:n=!!i&&!!r;break}return n};this.output._storedFunction=t=>e(t)?this.ifTrue.getConnectedValue(t):this.ifFalse.getConnectedValue(t)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.test = BABYLON.ConditionBlockTests.${Sr[this.test]};
`}serialize(){let e=super.serialize();return e.test=this.test,e}_deserialize(e){super._deserialize(e),this.test=e.test}};v([de("Test",ue.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Equal",value:Sr.Equal},{label:"NotEqual",value:Sr.NotEqual},{label:"LessThan",value:Sr.LessThan},{label:"GreaterThan",value:Sr.GreaterThan},{label:"LessOrEqual",value:Sr.LessOrEqual},{label:"GreaterOrEqual",value:Sr.GreaterOrEqual},{label:"Xor",value:Sr.Xor},{label:"Or",value:Sr.Or},{label:"And",value:Sr.And}]})],xC.prototype,"test",void 0);P("BABYLON.ConditionBlock",xC);var Ea=function(s){return s[s.None=0]="None",s[s.LoopID=1]="LoopID",s[s.InstanceID=2]="InstanceID",s}(Ea||{}),vC=class extends fe{constructor(e){super(e),this._currentLockId=-1,this.lockMode=Ea.None,this.registerInput("min",M.AutoDetect),this.registerInput("max",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture),this._inputs[1].excludedConnectionPointTypes.push(M.Matrix),this._inputs[1].excludedConnectionPointTypes.push(M.Geometry),this._inputs[1].excludedConnectionPointTypes.push(M.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"RandomBlock"}get min(){return this._inputs[0]}get max(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.min.isConnected){let e=new Vt("Min");e.value=0,e.output.connectTo(this.min)}if(!this.max.isConnected){let e=new Vt("Max");e.value=1,e.output.connectTo(this.max)}}_buildBlock(){let e=null;switch(this._currentLockId=-1,this.min.type){case M.Int:case M.Float:{e=t=>{let i=this.min.getConnectedValue(t)||0,r=this.max.getConnectedValue(t)||0;return i+Math.random()*(r-i)};break}case M.Vector2:{e=t=>{let i=this.min.getConnectedValue(t)||j.Zero(),r=this.max.getConnectedValue(t)||j.Zero();return new j(i.x+Math.random()*(r.x-i.x),i.y+Math.random()*(r.y-i.y))};break}case M.Vector3:{e=t=>{let i=this.min.getConnectedValue(t)||p.Zero(),r=this.max.getConnectedValue(t)||p.Zero();return new p(i.x+Math.random()*(r.x-i.x),i.y+Math.random()*(r.y-i.y),i.z+Math.random()*(r.z-i.z))};break}case M.Vector4:{e=t=>{let i=this.min.getConnectedValue(t)||De.Zero(),r=this.max.getConnectedValue(t)||De.Zero();return new De(i.x+Math.random()*(r.x-i.x),i.y+Math.random()*(r.y-i.y),i.z+Math.random()*(r.z-i.z),i.w+Math.random()*(r.w-i.w))};break}}this.lockMode===Ea.None||!e?this.output._storedFunction=e:this.output._storedFunction=t=>{let i=0;switch(this.lockMode){case Ea.InstanceID:i=t.getContextualValue(St.InstanceID,!0)||0;break;case Ea.LoopID:i=t.getContextualValue(St.LoopID,!0)||0;break}return(this._currentLockId!==i||this.lockMode===Ea.None)&&(this._currentLockId=i,this.output._storedValue=e(t)),this.output._storedValue}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.lockMode = BABYLON.RandomBlockLocks.${Ea[this.lockMode]};
`}serialize(){let e=super.serialize();return e.lockMode=this.lockMode,e}_deserialize(e){super._deserialize(e),this.lockMode=e.lockMode}};v([de("LockMode",ue.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"None",value:Ea.None},{label:"LoopID",value:Ea.LoopID},{label:"InstanceID",value:Ea.InstanceID}]})],vC.prototype,"lockMode",void 0);P("BABYLON.RandomBlock",vC);var mP=class extends fe{constructor(e){super(e),this.registerInput("offset",M.Vector3,!0,p.Zero()),this.registerInput("scale",M.Float,!0,1),this.registerInput("octaves",M.Float,!0,2,0,16),this.registerInput("roughness",M.Float,!0,.5,0,1),this.registerOutput("output",M.Float)}getClassName(){return"NoiseBlock"}get offset(){return this._inputs[0]}get scale(){return this._inputs[1]}get octaves(){return this._inputs[2]}get roughness(){return this._inputs[3]}get output(){return this._outputs[0]}_negateIf(e,t){return t!==0?-e:e}_noiseGrad(e,t,i,r){let n=e&15,o=n<8?t:i,a=n===12||n==14?t:r,l=n<4?i:a;return this._negateIf(o,n&o)+this._negateIf(l,n&2)}_fade(e){return e*e*e*(e*(e*6-15)+10)}_hashBitRotate(e,t){return e<<t|e>>32-t}_hash(e,t,i){let r,n,o;return r=n=o=3735928584,o+=i,n+=t,r+=e,o^=n,o-=this._hashBitRotate(n,14),r^=o,r-=this._hashBitRotate(o,11),n^=r,n-=this._hashBitRotate(r,25),o^=n,o-=this._hashBitRotate(n,16),r^=o,r-=this._hashBitRotate(o,4),n^=r,n-=this._hashBitRotate(r,14),o^=n,o-=this._hashBitRotate(n,24),o}_mix(e,t,i,r,n,o,a,l,c,h,u){let d=1-c,f=1-h;return(1-u)*(f*(e*d+t*c)+h*(i*d+r*c))+u*(f*(n*d+o*c)+h*(a*d+l*c))}_perlinNoise(e){let t=(e.x|0)-(e.x<0?1:0),i=(e.y|0)-(e.y<0?1:0),r=(e.z|0)-(e.z<0?1:0),n=e.x-t,o=e.y-i,a=e.z-r,l=this._fade(n),c=this._fade(o),h=this._fade(a);return this._mix(this._noiseGrad(this._hash(t,i,r),n,o,a),this._noiseGrad(this._hash(t+1,i,r),n-1,o,a),this._noiseGrad(this._hash(t,i+1,r),n,o-1,a),this._noiseGrad(this._hash(t+1,i+1,r),n-1,o-1,a),this._noiseGrad(this._hash(t,i,r+1),n,o,a-1),this._noiseGrad(this._hash(t+1,i,r+1),n-1,o,a-1),this._noiseGrad(this._hash(t,i+1,r+1),n,o-1,a-1),this._noiseGrad(this._hash(t+1,i+1,r+1),n-1,o-1,a-1),l,c,h)}_perlinSigned(e){return this._perlinNoise(e)*.982}_perlin(e){return this._perlinSigned(e)/2+.5}noise(e,t,i,r,n){let o=new p(i.x*n+r.x,i.y*n+r.y,i.z*n+r.z),a=1,l=1,c=0,h=0;e=xe.Clamp(e,0,15);let u=e|0;for(let g=0;g<=u;g++){let _=this._perlin(o.scale(a));h+=_*l,c+=l,l*=xe.Clamp(t,0,1),a*=2}let d=e-Math.floor(e);if(d==0)return h/c;let f=this._perlin(o.scale(a)),m=h+f*l;return h/=c,m/=c+l,(1-d)*h+d*m}_buildBlock(){this.output._storedFunction=e=>{let t=e.getContextualValue(St.Positions),i=this.octaves.getConnectedValue(e),r=this.roughness.getConnectedValue(e),n=this.offset.getConnectedValue(e),o=this.scale.getConnectedValue(e);return this.noise(i,r,t,n,o)}}};P("BABYLON.NoiseBlock",mP);var TC=class extends fe{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("geometry0",M.Geometry),this.registerInput("geometry1",M.Geometry,!0),this.registerInput("geometry2",M.Geometry,!0),this.registerInput("geometry3",M.Geometry,!0),this.registerInput("geometry4",M.Geometry,!0),this.registerOutput("output",M.Geometry)}getClassName(){return"MergeGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){let t=i=>{let r=[];if(this.geometry0.isConnected){let a=this.geometry0.getConnectedValue(i);a&&r.push(a)}if(this.geometry1.isConnected){let a=this.geometry1.getConnectedValue(i);a&&r.push(a)}if(this.geometry2.isConnected){let a=this.geometry2.getConnectedValue(i);a&&r.push(a)}if(this.geometry3.isConnected){let a=this.geometry3.getConnectedValue(i);a&&r.push(a)}if(this.geometry4.isConnected){let a=this.geometry4.getConnectedValue(i);a&&r.push(a)}if(r.length===0)return null;let n=r[0].clone(),o=r.slice(1);return o.length&&n&&(n=n.merge(o,!0,!1,!0,!0)),n};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],TC.prototype,"evaluateContext",void 0);P("BABYLON.MergeGeometryBlock",TC);var CC=class extends fe{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry0",M.Geometry,!0),this.registerInput("geometry1",M.Geometry,!0),this.registerInput("geometry2",M.Geometry,!0),this.registerInput("geometry3",M.Geometry,!0),this.registerInput("geometry4",M.Geometry,!0),this.registerInput("geometry5",M.Geometry,!0),this.registerInput("geometry6",M.Geometry,!0),this.registerInput("geometry7",M.Geometry,!0),this.registerInput("geometry8",M.Geometry,!0),this.registerInput("geometry9",M.Geometry,!0),this.registerOutput("output",M.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"GeometryCollectionBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get geometry5(){return this._inputs[5]}get geometry6(){return this._inputs[6]}get geometry7(){return this._inputs[7]}get geometry8(){return this._inputs[8]}get geometry9(){return this._inputs[9]}get output(){return this._outputs[0]}_storeGeometry(e,t,i,r){if(e.isConnected){let n=e.getConnectedValue(t);if(!n)return;n.metadata=n.metadata||{},n.metadata.collectionId=i,r.push(n)}}_buildBlock(e){let t=i=>{let r=[];return this._storeGeometry(this.geometry0,i,0,r),this._storeGeometry(this.geometry1,i,1,r),this._storeGeometry(this.geometry2,i,2,r),this._storeGeometry(this.geometry3,i,3,r),this._storeGeometry(this.geometry4,i,4,r),this._storeGeometry(this.geometry5,i,5,r),this._storeGeometry(this.geometry6,i,6,r),this._storeGeometry(this.geometry7,i,7,r),this._storeGeometry(this.geometry8,i,8,r),this._storeGeometry(this.geometry9,i,9,r),r.length?r[Math.round(Math.random()*(r.length-1))]:null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],CC.prototype,"evaluateContext",void 0);P("BABYLON.GeometryCollectionBlock",CC);var gP=class extends fe{constructor(e){super(e),this.registerInput("input",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return 0}getClassName(){return"GeometryElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._inputs[0];t._storedFunction=r=>i.getConnectedValue(r)}};P("BABYLON.GeometryElbowBlock",gP);var _P=class extends fe{constructor(e){super(e),this.registerInput("geometry",M.Geometry),this.registerOutput("output",M.Geometry)}getClassName(){return"ComputeNormalsBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.geometry.isConnected)return null;let t=this.geometry.getConnectedValue(e);return t.normals||(t.normals=[]),le.ComputeNormals(t.positions,t.indices,t.normals),t}}};P("BABYLON.ComputeNormalsBlock",_P);var xP=class extends fe{constructor(e){super(e),this.registerInput("xyzw ",M.Vector4,!0),this.registerInput("xyz ",M.Vector3,!0),this.registerInput("xy ",M.Vector2,!0),this.registerInput("zw ",M.Vector2,!0),this.registerInput("x ",M.Float,!0),this.registerInput("y ",M.Float,!0),this.registerInput("z ",M.Float,!0),this.registerInput("w ",M.Float,!0),this.registerOutput("xyzw",M.Vector4),this.registerOutput("xyz",M.Vector3),this.registerOutput("xy",M.Vector2),this.registerOutput("zw",M.Vector2),this.registerOutput("x",M.Float),this.registerOutput("y",M.Float),this.registerOutput("z",M.Float),this.registerOutput("w",M.Float)}getClassName(){return"VectorConverterBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get xIn(){return this._inputs[4]}get yIn(){return this._inputs[5]}get zIn(){return this._inputs[6]}get wIn(){return this._inputs[7]}get xyzwOut(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xOut(){return this._outputs[4]}get yOut(){return this._outputs[5]}get zOut(){return this._outputs[6]}get wOut(){return this._outputs[7]}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e==="x "?"xIn":e==="y "?"yIn":e==="z "?"zIn":e==="w "?"wIn":e}_outputRename(e){switch(e){case"x":return"xOut";case"y":return"yOut";case"z":return"zOut";case"w":return"wOut";case"xy":return"xyOut";case"zw":return"zwOut";case"xyz":return"xyzOut";case"xyzw":return"xyzwOut";default:return e}}_buildBlock(e){super._buildBlock(e);let t=this.xIn,i=this.yIn,r=this.zIn,n=this.wIn,o=this.xyIn,a=this.zwIn,l=this.xyzIn,c=this.xyzwIn,h=this.xyzwOut,u=this.xyzOut,d=this.xyOut,f=this.zwOut,m=this.xOut,g=this.yOut,_=this.zOut,x=this.wOut,b=C=>{if(c.isConnected)return c.getConnectedValue(C);let R=0,E=0,S=0,A=0;if(t.isConnected&&(R=t.getConnectedValue(C)),i.isConnected&&(E=i.getConnectedValue(C)),r.isConnected&&(S=r.getConnectedValue(C)),n.isConnected&&(A=n.getConnectedValue(C)),o.isConnected){let L=o.getConnectedValue(C);L&&(R=L.x,E=L.y)}if(a.isConnected){let L=a.getConnectedValue(C);L&&(S=L.x,A=L.y)}if(l.isConnected){let L=l.getConnectedValue(C);L&&(R=L.x,E=L.y,S=L.z)}return new De(R,E,S,A)};h._storedFunction=C=>b(C),u._storedFunction=C=>{let R=b(C);return new p(R.x,R.y,R.z)},d._storedFunction=C=>{let R=b(C);return new j(R.x,R.y)},f._storedFunction=C=>{let R=b(C);return new j(R.z,R.w)},m._storedFunction=C=>b(C).x,g._storedFunction=C=>b(C).y,_._storedFunction=C=>b(C).z,x._storedFunction=C=>b(C).w}};P("BABYLON.VectorConverterBlock",xP);var vP=class extends fe{constructor(e){super(e),this.registerInput("input",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(M.Float),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NormalizeVectorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),this.output._storedFunction=null,!this.input.isConnected){this.output._storedValue=null;return}this.output._storedFunction=t=>this.input.getConnectedValue(t).normalize()}};P("BABYLON.NormalizeVectorBlock",vP);var bC=class extends fe{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",M.Geometry),this.registerInput("id",M.Int,!0,0),this.registerOutput("output",M.Geometry),this.id.acceptedConnectionPointTypes.push(M.Float)}getClassName(){return"SetMaterialIDBlock"}get geometry(){return this._inputs[0]}get id(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.geometry.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let t=i=>{let r=this.geometry.getConnectedValue(i);if(!r||!r.indices||!r.positions)return r;let n=new jc;return n.materialIndex=this.id.getConnectedValue(i)|0,n.indexStart=0,n.indexCount=r.indices.length,n.verticesStart=0,n.verticesCount=r.positions.length/3,r.materialInfos=[n],r};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],bC.prototype,"evaluateContext",void 0);P("BABYLON.SetMaterialIDBlock",bC);var yt=function(s){return s[s.Cos=0]="Cos",s[s.Sin=1]="Sin",s[s.Abs=2]="Abs",s[s.Exp=3]="Exp",s[s.Round=4]="Round",s[s.Floor=5]="Floor",s[s.Ceiling=6]="Ceiling",s[s.Sqrt=7]="Sqrt",s[s.Log=8]="Log",s[s.Tan=9]="Tan",s[s.ArcTan=10]="ArcTan",s[s.ArcCos=11]="ArcCos",s[s.ArcSin=12]="ArcSin",s[s.Sign=13]="Sign",s[s.Negate=14]="Negate",s[s.OneMinus=15]="OneMinus",s[s.Reciprocal=16]="Reciprocal",s[s.ToDegrees=17]="ToDegrees",s[s.ToRadians=18]="ToRadians",s[s.Fract=19]="Fract",s[s.Exp2=20]="Exp2",s}(yt||{}),SC=class extends fe{constructor(e){super(e),this.operation=yt.Cos,this.registerInput("input",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture)}getClassName(){return"GeometryTrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.operation){case yt.Cos:{t=i=>Math.cos(i);break}case yt.Sin:{t=i=>Math.sin(i);break}case yt.Abs:{t=i=>Math.abs(i);break}case yt.Exp:{t=i=>Math.exp(i);break}case yt.Exp2:{t=i=>Math.pow(2,i);break}case yt.Round:{t=i=>Math.round(i);break}case yt.Floor:{t=i=>Math.floor(i);break}case yt.Ceiling:{t=i=>Math.ceil(i);break}case yt.Sqrt:{t=i=>Math.sqrt(i);break}case yt.Log:{t=i=>Math.log(i);break}case yt.Tan:{t=i=>Math.tan(i);break}case yt.ArcTan:{t=i=>Math.atan(i);break}case yt.ArcCos:{t=i=>Math.acos(i);break}case yt.ArcSin:{t=i=>Math.asin(i);break}case yt.Sign:{t=i=>Math.sign(i);break}case yt.Negate:{t=i=>-i;break}case yt.OneMinus:{t=i=>1-i;break}case yt.Reciprocal:{t=i=>1/i;break}case yt.ToRadians:{t=i=>i*Math.PI/180;break}case yt.ToDegrees:{t=i=>i*180/Math.PI;break}case yt.Fract:{t=i=>i>=0?i-Math.floor(i):i-Math.ceil(i);break}}if(!t){this.output._storedFunction=null,this.output._storedValue=null;return}switch(this.input.type){case M.Int:case M.Float:{this.output._storedFunction=i=>{let r=this.input.getConnectedValue(i);return t(r)};break}case M.Vector2:{this.output._storedFunction=i=>{let r=this.input.getConnectedValue(i);return new j(t(r.x),t(r.y))};break}case M.Vector3:{this.output._storedFunction=i=>{let r=this.input.getConnectedValue(i);return new p(t(r.x),t(r.y),t(r.z))};break}case M.Vector4:{this.output._storedFunction=i=>{let r=this.input.getConnectedValue(i);return new De(t(r.x),t(r.y),t(r.z),t(r.w))};break}}return this}serialize(){let e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.GeometryTrigonometryBlockOperations.${yt[this.operation]};
`}};v([de("Operation",ue.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Cos",value:yt.Cos},{label:"Sin",value:yt.Sin},{label:"Abs",value:yt.Abs},{label:"Exp",value:yt.Exp},{label:"Exp2",value:yt.Exp2},{label:"Round",value:yt.Round},{label:"Floor",value:yt.Floor},{label:"Ceiling",value:yt.Ceiling},{label:"Sqrt",value:yt.Sqrt},{label:"Log",value:yt.Log},{label:"Tan",value:yt.Tan},{label:"ArcTan",value:yt.ArcTan},{label:"ArcCos",value:yt.ArcCos},{label:"ArcSin",value:yt.ArcSin},{label:"Sign",value:yt.Sign},{label:"Negate",value:yt.Negate},{label:"OneMinus",value:yt.OneMinus},{label:"Reciprocal",value:yt.Reciprocal},{label:"ToDegrees",value:yt.ToDegrees},{label:"ToRadians",value:yt.ToRadians},{label:"Fract",value:yt.Fract}]})],SC.prototype,"operation",void 0);P("BABYLON.GeometryTrigonometryBlock",SC);var yC=class extends fe{constructor(e){super(e),this._rotationMatrix=new N,this._scalingMatrix=new N,this._translationMatrix=new N,this._scalingRotationMatrix=new N,this._transformMatrix=new N,this.evaluateContext=!0,this.registerInput("value",M.AutoDetect),this.registerInput("matrix",M.Matrix,!0),this.registerInput("translation",M.Vector3,!0,p.Zero()),this.registerInput("rotation",M.Vector3,!0,p.Zero()),this.registerInput("scaling",M.Vector3,!0,p.One()),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(M.Float),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Texture)}getClassName(){return"GeometryTransformBlock"}get value(){return this._inputs[0]}get matrix(){return this._inputs[1]}get translation(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let t=i=>{let r=this.value.getConnectedValue(i);if(!r)return null;let n;if(this.matrix.isConnected)n=this.matrix.getConnectedValue(i);else{let o=this.scaling.getConnectedValue(i),a=this.rotation.getConnectedValue(i),l=this.translation.getConnectedValue(i);N.ScalingToRef(o.x,o.y,o.z,this._scalingMatrix),N.RotationYawPitchRollToRef(a.y,a.x,a.z,this._rotationMatrix),N.TranslationToRef(l.x,l.y,l.z,this._translationMatrix),this._scalingMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._translationMatrix,this._transformMatrix),n=this._transformMatrix}switch(this.value.type){case M.Geometry:{let o=r.clone();return o.transform(n),o}case M.Vector2:return j.Transform(r,n);case M.Vector3:return p.TransformCoordinates(r,n);case M.Vector4:return De.TransformCoordinates(r,n)}return null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],yC.prototype,"evaluateContext",void 0);P("BABYLON.GeometryTransformBlock",yC);var TP=class extends fe{constructor(e){super(e),this.registerInput("angle",M.Float,!1,0),this.registerOutput("matrix",M.Matrix)}getClassName(){return"RotationXBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){let e=new Vt("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>N.RotationX(this.angle.getConnectedValue(t))}};P("BABYLON.RotationXBlock",TP);var CP=class extends fe{constructor(e){super(e),this.registerInput("angle",M.Float,!1,0),this.registerOutput("matrix",M.Matrix)}getClassName(){return"RotationYBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){let e=new Vt("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>N.RotationY(this.angle.getConnectedValue(t))}};P("BABYLON.RotationYBlock",CP);var bP=class extends fe{constructor(e){super(e),this.registerInput("angle",M.Float,!1,0),this.registerOutput("matrix",M.Matrix)}getClassName(){return"RotationZBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){let e=new Vt("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>N.RotationZ(this.angle.getConnectedValue(t))}};P("BABYLON.RotationZBlock",bP);var SP=class extends fe{constructor(e){super(e),this.registerInput("scale",M.Vector3,!1,p.One()),this.registerOutput("matrix",M.Matrix)}getClassName(){return"ScalingBlock"}get scale(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.scale.isConnected){let e=new Vt("Scale");e.value=new p(1,1,1),e.output.connectTo(this.scale)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>{let i=this.scale.getConnectedValue(t);return N.Scaling(i.x,i.y,i.z)}}};P("BABYLON.ScalingBlock",SP);var yP=class extends fe{constructor(e){super(e),this.registerInput("source",M.Vector3,!0,p.Up()),this.registerInput("target",M.Vector3,!0,p.Left()),this.registerOutput("matrix",M.Matrix)}getClassName(){return"AlignBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>{let i=this.source.getConnectedValue(t).clone(),r=this.target.getConnectedValue(t).clone(),n=new N;return i.normalize(),r.normalize(),N.RotationAlignToRef(i,r,n,!0),n}}};P("BABYLON.AlignBlock",yP);var EP=class extends fe{constructor(e){super(e),this.registerInput("translation",M.Vector3,!1,p.Zero()),this.registerOutput("matrix",M.Matrix)}getClassName(){return"TranslationBlock"}get translation(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.translation.isConnected){let e=new Vt("Translation");e.value=new p(0,0,0),e.output.connectTo(this.translation)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=t=>{let i=this.translation.getConnectedValue(t);return N.Translation(i.x,i.y,i.z)}}};P("BABYLON.TranslationBlock",EP);var Zm=class extends fe{constructor(e){super(e),this._indexTranslation=null,this.evaluateContext=!0,this.removeDuplicatedPositions=!0,this.registerInput("geometry",M.Geometry),this.registerInput("instance",M.Geometry,!0),this.registerInput("density",M.Float,!0,1,0,1),this.registerInput("matrix",M.Matrix,!0),this.registerInput("rotation",M.Vector3,!0,p.Zero()),this.registerInput("scaling",M.Vector3,!0,p.One()),this.scaling.acceptedConnectionPointTypes.push(M.Float),this.registerOutput("output",M.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return this._indexTranslation?this._indexTranslation[this._currentIndex]:this._currentIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateOnVerticesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get density(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){let t=i=>{if(i.pushExecutionContext(this),i.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(i),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.instance.isConnected){i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this.output._storedValue=null;return}let r=this._vertexData.positions.length/3,n=[],o=new p,a=[],l=this._vertexData.positions;if(this._currentLoopIndex=0,this.removeDuplicatedPositions){for(this._indexTranslation={},this._currentIndex=0;this._currentIndex<r;this._currentIndex++){let c=l[this._currentIndex*3],h=l[this._currentIndex*3+1],u=l[this._currentIndex*3+2],d=!1;for(let f=0;f<a.length;f+=3)if(Math.abs(a[f]-c)<je&&Math.abs(a[f+1]-h)<je&&Math.abs(a[f+2]-u)<je){d=!0;break}d||(this._indexTranslation[a.length/3]=this._currentIndex,a.push(c,h,u))}l=a,r=l.length/3}else this._indexTranslation=null;for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){let c=this.instance.getConnectedValue(i);if(!c||!c.positions||c.positions.length===0)continue;let h=this.density.getConnectedValue(i);if(h<1&&Math.random()>h)continue;o.fromArray(l,this._currentIndex*3);let u=c.clone();if(this.matrix.isConnected){let d=this.matrix.getConnectedValue(i);i._instantiateWithPositionAndMatrix(u,o,d,n)}else{let d=i.adaptInput(this.scaling,M.Vector3,p.OneReadOnly),f=this.rotation.getConnectedValue(i)||p.ZeroReadOnly;i._instantiate(u,o,f,d,n)}this._currentLoopIndex++}if(i.restoreGeometryContext(),i.restoreExecutionContext(),i.restoreInstancingContext(),n.length)if(n.length===1)this._vertexData=n[0];else{let c=n.splice(0,1)[0];this._vertexData=c.merge(n,!0,!1,!0,!0)}else return null;return this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.removeDuplicatedPositions = ${this.removeDuplicatedPositions?"true":"false"};
`;return e+=`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`,e}serialize(){let e=super.serialize();return e.removeDuplicatedPositions=this.removeDuplicatedPositions,e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.removeDuplicatedPositions=e.removeDuplicatedPositions,e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Zm.prototype,"evaluateContext",void 0);v([de("Remove duplicated positions",ue.Boolean,"ADVANCED",{notifiers:{update:!0}})],Zm.prototype,"removeDuplicatedPositions",void 0);P("BABYLON.InstantiateOnVerticesBlock",Zm);var EC=class extends fe{constructor(e){super(e),this._currentPosition=new p,this._currentUV=new j,this._vertex0=new p,this._vertex1=new p,this._vertex2=new p,this._tempVector0=new p,this._tempVector1=new p,this._uv0=new j,this._uv1=new j,this._uv2=new j,this.evaluateContext=!0,this.registerInput("geometry",M.Geometry),this.registerInput("instance",M.Geometry,!0),this.registerInput("count",M.Int,!0,256),this.registerInput("matrix",M.Matrix,!0),this.registerInput("rotation",M.Vector3,!0,p.Zero()),this.registerInput("scaling",M.Vector3,!0,p.One()),this.scaling.acceptedConnectionPointTypes.push(M.Float),this.registerOutput("output",M.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return this._currentFaceIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getOverrideNormalsContextualValue(){return this._vertex1.subtractToRef(this._vertex0,this._tempVector0),this._vertex2.subtractToRef(this._vertex1,this._tempVector1),this._tempVector0.normalize(),this._tempVector1.normalize(),p.Cross(this._tempVector1,this._tempVector0)}getOverrideUVs1ContextualValue(){return this._currentUV}getClassName(){return"InstantiateOnFacesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){let t=i=>{if(i.pushExecutionContext(this),i.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(i),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this._vertexData.indices||!this.instance.isConnected){i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this.output._storedValue=null;return}let r=null,n=this.count.getConnectedValue(i),o=this._vertexData.indices.length/3,a=n/o,l=0,c=[],h=0;for(this._currentLoopIndex=0,this._currentFaceIndex=0;this._currentFaceIndex<o;this._currentFaceIndex++){l+=a;let u=(l|0)-h;if(u<1)continue;let d=this._vertexData.indices[this._currentFaceIndex*3],f=this._vertexData.indices[this._currentFaceIndex*3+1],m=this._vertexData.indices[this._currentFaceIndex*3+2];this._vertex0.fromArray(this._vertexData.positions,d*3),this._vertex1.fromArray(this._vertexData.positions,f*3),this._vertex2.fromArray(this._vertexData.positions,m*3),this._vertexData.uvs&&(this._uv0.fromArray(this._vertexData.uvs,d*2),this._uv1.fromArray(this._vertexData.uvs,f*2),this._uv2.fromArray(this._vertexData.uvs,m*2));for(let g=0;g<u&&!(h>=n);g++){let _=Math.random(),x=Math.random();if(_>x){let S=_;_=x,x=S}let b=_,C=x-_,R=1-b-C;if(this._currentPosition.set(b*this._vertex0.x+C*this._vertex1.x+R*this._vertex2.x,b*this._vertex0.y+C*this._vertex1.y+R*this._vertex2.y,b*this._vertex0.z+C*this._vertex1.z+R*this._vertex2.z),this._vertexData.uvs&&this._currentUV.set(b*this._uv0.x+C*this._uv1.x+R*this._uv2.x,b*this._uv0.y+C*this._uv1.y+R*this._uv2.y),r=this.instance.getConnectedValue(i),!r||!r.positions||r.positions.length===0){l-=a;continue}let E=r.clone();if(this.matrix.isConnected){let S=this.matrix.getConnectedValue(i);i._instantiateWithPositionAndMatrix(E,this._currentPosition,S,c)}else{let S=i.adaptInput(this.scaling,M.Vector3,p.OneReadOnly),A=this.rotation.getConnectedValue(i)||p.ZeroReadOnly;i._instantiate(E,this._currentPosition,A,S,c)}h++,this._currentLoopIndex++}}if(c.length)if(c.length===1)this._vertexData=c[0];else{let u=c.splice(0,1)[0];this._vertexData=u.merge(c,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],EC.prototype,"evaluateContext",void 0);P("BABYLON.InstantiateOnFacesBlock",EC);var Jm=class extends fe{constructor(e){super(e),this._currentPosition=new p,this._vertex0=new p,this._vertex1=new p,this._vertex2=new p,this.evaluateContext=!0,this.gridMode=!1,this.registerInput("geometry",M.Geometry),this.registerInput("instance",M.Geometry,!0),this.registerInput("count",M.Int,!0,256),this.registerInput("matrix",M.Matrix,!0),this.registerInput("rotation",M.Vector3,!0,p.Zero()),this.registerInput("scaling",M.Vector3,!0,p.One()),this.registerInput("gridSize",M.Int,!0,10),this.scaling.acceptedConnectionPointTypes.push(M.Float),this.registerOutput("output",M.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return 0}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getClassName(){return"InstantiateOnVolumeBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get gridSize(){return this._inputs[6]}get output(){return this._outputs[0]}_getValueOnGrid(e,t,i,r){let n=(r-i)/t;return i+n/2+e*n}_getIndexinGrid(e,t,i,r){return e+t*r+i*r*r}_buildBlock(e){let t=i=>{if(i.pushExecutionContext(this),i.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(i),i.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this._vertexData.indices||!this.instance.isConnected){i.restoreExecutionContext(),i.restoreInstancingContext(),i.restoreGeometryContext(),this.output._storedValue=null;return}let r=null,n=this.count.getConnectedValue(i),o=[],a=ja(this._vertexData.positions,0,this._vertexData.positions.length/3),l=a.minimum,c=a.maximum,h=new p(.5,.8,.2),u=this._vertexData.indices.length/3,d=this.gridSize.getConnectedValue(i);this._currentLoopIndex=0;let f;if(this.gridMode){f=[];for(let m=0;m<d*d*d;m++)f[m]=!1}for(let m=0;m<n;m++){if(this.gridMode){let b=Math.floor(Math.random()*d),C=Math.floor(Math.random()*d),R=Math.floor(Math.random()*d),E=this._getIndexinGrid(b,C,R,d);if(f[E]){let S=!1;for(let A=0;A<d*d*d;A++)if(!f[A]){R=Math.floor(A/(d*d)),C=Math.floor((A-R*d*d)/d),b=A-R*d*d-C*d,E=this._getIndexinGrid(b,C,R,d),S=!0;break}if(!S)break}if(!f[E]){let S=this._getValueOnGrid(b,d,l.x,c.x),A=this._getValueOnGrid(C,d,l.y,c.y),L=this._getValueOnGrid(R,d,l.z,c.z);this._currentPosition.set(S,A,L),f[E]=!0}}else this._currentPosition.set(Math.random()*(c.x-l.x)+l.x,Math.random()*(c.y-l.y)+l.y,Math.random()*(c.z-l.z)+l.z);let g=new pt(this._currentPosition,h),_=0;for(let b=0;b<u;b++){this._vertex0.fromArray(this._vertexData.positions,this._vertexData.indices[b*3]*3),this._vertex1.fromArray(this._vertexData.positions,this._vertexData.indices[b*3+1]*3),this._vertex2.fromArray(this._vertexData.positions,this._vertexData.indices[b*3+2]*3);let C=g.intersectsTriangle(this._vertex0,this._vertex1,this._vertex2);C&&C.distance>0&&_++}if(_%2===0){m--;continue}if(r=this.instance.getConnectedValue(i),!r||!r.positions||r.positions.length===0)continue;let x=r.clone();if(this.matrix.isConnected){let b=this.matrix.getConnectedValue(i);i._instantiateWithPositionAndMatrix(x,this._currentPosition,b,o)}else{let b=i.adaptInput(this.scaling,M.Vector3,p.OneReadOnly),C=this.rotation.getConnectedValue(i)||p.ZeroReadOnly;i._instantiate(x,this._currentPosition,C,b,o)}this._currentLoopIndex++}if(o.length)if(o.length===1)this._vertexData=o[0];else{let m=o.splice(0,1)[0];this._vertexData=m.merge(o,!0,!1,!0,!0)}return i.restoreGeometryContext(),i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.gridMode = ${this.gridMode?"true":"false"};
`,e}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e.gridMode=this.gridMode,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext),e.gridMode!==void 0&&(this.gridMode=e.gridMode)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],Jm.prototype,"evaluateContext",void 0);v([de("Grid mode",ue.Boolean,"MODES",{notifiers:{rebuild:!0}})],Jm.prototype,"gridMode",void 0);P("BABYLON.InstantiateOnVolumeBlock",Jm);var ul=class extends fe{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("instance",M.Geometry,!0),this.registerInput("count",M.Int,!0,1),this.registerOutput("output",M.Geometry)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBaseBlock"}get instance(){return this._inputs[0]}get count(){return this._inputs[1]}get output(){return this._outputs[0]}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),e.evaluateContext!==void 0&&(this.evaluateContext=e.evaluateContext)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],ul.prototype,"evaluateContext",void 0);var AP=class extends ul{constructor(e){super(e),this.registerInput("matrix",M.Matrix,!0),this.registerInput("position",M.Vector3,!0,p.Zero()),this.registerInput("rotation",M.Vector3,!0,p.Zero()),this.registerInput("scaling",M.Vector3,!0,p.One()),this.scaling.acceptedConnectionPointTypes.push(M.Float)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBlock"}get matrix(){return this._inputs[2]}get position(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}_buildBlock(e){let t=i=>{i.pushExecutionContext(this),i.pushInstancingContext(this);let r=this.count.getConnectedValue(i),n=[];for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){let o=this.instance.getConnectedValue(i);if(!o||!o.positions||o.positions.length===0)continue;let a=o.clone();if(this.matrix.isConnected){let l=this.matrix.getConnectedValue(i);i._instantiateWithMatrix(a,l,n)}else{let l=this.position.getConnectedValue(i)||p.ZeroReadOnly,c=i.adaptInput(this.scaling,M.Vector3,p.OneReadOnly),h=this.rotation.getConnectedValue(i)||p.ZeroReadOnly;i._instantiate(a,l,h,c,n)}}if(n.length)if(n.length===1)this._vertexData=n[0];else{let o=n.splice(0,1)[0];this._vertexData=o.merge(n,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}};P("BABYLON.InstantiateBlock",AP);var IP=class extends ul{constructor(e){super(e),this.registerInput("direction",M.Vector3,!0,new p(1,0,0)),this.registerInput("rotation",M.Vector3,!0,new p(0,0,0)),this.registerInput("scaling",M.Vector3,!0,new p(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(M.Float)}getClassName(){return"InstantiateLinearBlock"}get direction(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}_buildBlock(e){let t=i=>{i.pushExecutionContext(this),i.pushInstancingContext(this);let r=this.count.getConnectedValue(i),n=[],o=N.Identity(),a=p.Zero(),l=p.Zero(),c=p.Zero();for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){let h=this.instance.getConnectedValue(i);if(!h||!h.positions||h.positions.length===0)continue;let u=h.clone(),d=this.direction.getConnectedValue(i),f=this.rotation.getConnectedValue(i),m=i.adaptInput(this.scaling,M.Vector3,p.OneReadOnly);a.copyFrom(d.clone().scale(this._currentIndex)),l.copyFrom(f.clone().scale(this._currentIndex)),c.copyFrom(m.clone().scale(this._currentIndex)),c.addInPlaceFromFloats(1,1,1),N.ComposeToRef(c,q.FromEulerAngles(l.x,l.y,l.z),a,o),i._instantiateWithMatrix(u,o,n)}if(n.length)if(n.length===1)this._vertexData=n[0];else{let h=n.splice(0,1)[0];this._vertexData=h.merge(n,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}};P("BABYLON.InstantiateLinearBlock",IP);var RP=class extends ul{constructor(e){super(e),this.registerInput("radius",M.Int,!0,0,0),this.registerInput("angleStart",M.Float,!0,0),this.registerInput("angleEnd",M.Float,!0,Math.PI*2),this.registerInput("transform",M.Vector3,!0,new p(0,0,0)),this.registerInput("rotation",M.Vector3,!0,new p(0,0,0)),this.registerInput("scaling",M.Vector3,!0,new p(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(M.Float)}getClassName(){return"InstantiateRadialBlock"}get radius(){return this._inputs[2]}get angleStart(){return this._inputs[3]}get angleEnd(){return this._inputs[4]}get transform(){return this._inputs[5]}get rotation(){return this._inputs[6]}get scaling(){return this._inputs[7]}_buildBlock(e){let t=i=>{i.pushExecutionContext(this),i.pushInstancingContext(this);let r=this.count.getConnectedValue(i),n=[],o=N.Identity(),a=N.Identity(),l=N.Identity(),c=p.Zero(),h=p.Zero(),u=p.Zero();for(this._currentIndex=0;this._currentIndex<r;this._currentIndex++){let d=this.instance.getConnectedValue(i);if(!d||!d.positions||d.positions.length===0)continue;let f=d.clone(),m=this.radius.getConnectedValue(i),g=this.angleStart.getConnectedValue(i),_=this.angleEnd.getConnectedValue(i),x=this.transform.getConnectedValue(i),b=this.rotation.getConnectedValue(i),C=i.adaptInput(this.scaling,M.Vector3,p.OneReadOnly),E=(_-g)/r,S=g+E*this._currentIndex,A=q.FromEulerAngles(0,S,0);c.copyFrom(x.clone().scale(this._currentIndex)),h.copyFrom(b.clone().scale(this._currentIndex)),u.copyFrom(C.clone().scale(this._currentIndex)),u.addInPlaceFromFloats(1,1,1),N.RotationYawPitchRollToRef(h.y,h.x,h.z,o),a.setTranslationFromFloats(0,0,m),N.ComposeToRef(u,A,c,l),o.multiplyToRef(a,a),a.multiplyToRef(l,l),i._instantiateWithMatrix(f,l,n)}if(n.length)if(n.length===1)this._vertexData=n[0];else{let d=n.splice(0,1)[0];this._vertexData=d.merge(n,!0,!1,!0,!0)}return i.restoreExecutionContext(),i.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}};P("BABYLON.InstantiateRadialBlock",RP);var PP=class extends fe{constructor(e){super(e),this.registerInput("float ",M.Float,!0),this.registerInput("int ",M.Int,!0),this.registerOutput("float",M.Float),this.registerOutput("int",M.Int)}getClassName(){return"IntFloatConverterBlock"}get floatIn(){return this._inputs[0]}get intIn(){return this._inputs[1]}get floatOut(){return this._outputs[0]}get intOut(){return this._outputs[1]}_inputRename(e){return e==="float "?"floatIn":e==="int "?"intIn":e}_buildBlock(){this.floatOut._storedFunction=e=>this.floatIn.isConnected?this.floatIn.getConnectedValue(e):this.intIn.isConnected?this.intIn.getConnectedValue(e):0,this.intOut._storedFunction=e=>this.floatIn.isConnected?Math.floor(this.floatIn.getConnectedValue(e)):this.intIn.isConnected?Math.floor(this.intIn.getConnectedValue(e)):0}};P("BABYLON.IntFloatConverterBlock",PP);var MP=class extends fe{constructor(e){super(e),this.log=[],this._isDebug=!0,this.registerInput("input",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture)}get buildExecutionTime(){return 0}getClassName(){return"DebugBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}this.log=[];let t=i=>{let r=this.input.getConnectedValue(i);if(r==null)return this.log.push(["null",""]),r;switch(this.input.type){case M.Vector2:this.log.push([OV(r,4),r.toString()]);break;case M.Vector3:this.log.push([wV(r,4),r.toString()]);break;case M.Vector4:this.log.push([NV(r,4),r.toString()]);break;default:this.log.push([r.toString(),r.toString()]);break}return r};this.output.isConnected?this.output._storedFunction=t:this.output._storedValue=t(e)}};P("BABYLON.DebugBlock",MP);var DP=class extends fe{constructor(e){super(e),this.registerInput("geometry",M.Geometry),this.registerOutput("output",M.Geometry),this.registerOutput("id",M.Int),this.registerOutput("collectionId",M.Int),this.registerOutput("verticesCount",M.Int),this.registerOutput("facesCount",M.Int)}getClassName(){return"GeometryInfoBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}get id(){return this._outputs[1]}get collectionId(){return this._outputs[2]}get verticesCount(){return this._outputs[3]}get facesCount(){return this._outputs[4]}_buildBlock(){if(!this.geometry.isConnected){this.id._storedValue=0,this.collectionId._storedValue=0,this.verticesCount._storedValue=0,this.facesCount._storedValue=0,this.output._storedValue=0,this.id._storedFunction=null,this.collectionId._storedFunction=null,this.verticesCount._storedFunction=null,this.facesCount._storedFunction=null,this.output._storedFunction=null;return}this.output._storedFunction=e=>(this._currentVertexData=this.geometry.getConnectedValue(e),this._currentVertexData),this.id._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.uniqueId),this.collectionId._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.metadata?this._currentVertexData.metadata.collectionId:0),this.verticesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.positions?this._currentVertexData.positions.length/3:0),this.facesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.indices?this._currentVertexData.indices.length/3:0)}};P("BABYLON.GeometryInfoBlock",DP);var dl=function(s){return s[s.Spherical=0]="Spherical",s[s.Cylindrical=1]="Cylindrical",s[s.Cubic=2]="Cubic",s}(dl||{}),AC=class extends fe{constructor(e){super(e),this.mapping=dl.Spherical,this.registerInput("position",M.Vector3),this.registerInput("normal",M.Vector3),this.registerInput("center",M.Vector3,!0,p.Zero()),this.registerOutput("uv",M.Vector2)}getClassName(){return"MappingBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get center(){return this._inputs[2]}get uv(){return this._outputs[0]}_buildBlock(){if(!this.position.isConnected){this.uv._storedFunction=null,this.uv._storedValue=null;return}let e=p.Zero(),t=i=>{let r=this.position.getConnectedValue(i)||p.Zero(),n=this.normal.getConnectedValue(i)||p.Zero(),o=this.center.getConnectedValue(i),a=j.Zero();switch(this.mapping){case dl.Spherical:{r.subtractToRef(o,e);let l=e.length();l>0&&(a.x=Math.acos(e.y/l)/Math.PI,(e.x!==0||e.z!==0)&&(a.y=Math.atan2(e.x,e.z)/(Math.PI*2)));break}case dl.Cylindrical:{r.subtractToRef(o,e);let l=e.length();l>0&&(a.x=Math.atan2(e.x/l,e.z/l)/(Math.PI*2),a.y=(e.y+1)/2);break}case dl.Cubic:{let l=Math.abs(n.x),c=Math.abs(n.y),h=Math.abs(n.z),u=Math.max(Math.abs(r.x),Math.abs(r.y),Math.abs(r.z)),d=0,f=0;l>=c&&l>=h?(d=r.y/u-o.y,f=r.z/u-o.z):c>=l&&c>=h?(d=r.x/u-o.x,f=r.z/u-o.z):(d=r.x/u-o.x,f=r.y/u-o.y),a.x=(d+1)/2,a.y=(f+1)/2}}return a};this.uv._storedFunction=i=>t(i)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.mapping = BABYLON.MappingTypes.${dl[this.mapping]};
`}serialize(){let e=super.serialize();return e.mapping=this.mapping,e}_deserialize(e){super._deserialize(e),this.mapping=e.mapping}};v([de("Mapping",ue.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Spherical",value:dl.Spherical},{label:"Cylindrical",value:dl.Cylindrical},{label:"Cubic",value:dl.Cubic}]})],AC.prototype,"mapping",void 0);P("BABYLON.MappingBlock",AC);var OP=class extends fe{constructor(e){super(e),this.registerInput("matrix0",M.Matrix),this.registerInput("matrix1",M.Matrix),this.registerOutput("output",M.Matrix)}getClassName(){return"MatrixComposeBlock"}get matrix0(){return this._inputs[0]}get matrix1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.matrix0.isConnected||!this.matrix1.isConnected)return null;let t=this.matrix0.getConnectedValue(e),i=this.matrix1.getConnectedValue(e);return!t||!i?null:t.multiply(i)}}};P("BABYLON.MatrixComposeBlock",OP);var wP=class extends fe{get endpoints(){return this._endpoints}constructor(e){super(e),this._endpoints=[],this._isTeleportIn=!0,this.registerInput("input",M.AutoDetect)}getClassName(){return"TeleportInBlock"}get input(){return this._inputs[0]}_dumpCode(e,t){let i=super._dumpCode(e,t);for(let r of this.endpoints)t.indexOf(r)===-1&&(i+=r._dumpCode(e,t));return i}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(let t of this.endpoints)if(t.isAnAncestorOfType(e))return!0;return!1}isAnAncestorOf(e){for(let t of this.endpoints)if(t===e||t.isAnAncestorOf(e))return!0;return!1}getDescendantOfPredicate(e){if(e(this))return this;for(let t of this.endpoints){let i=t.getDescendantOfPredicate(e);if(i)return i}return null}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){let t=this._endpoints.indexOf(e);t!==-1&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}_buildBlock(){for(let e of this._endpoints)e.output._storedFunction=t=>this.input.getConnectedValue(t)}};P("BABYLON.TeleportInBlock",wP);var NP=class extends fe{constructor(e){super(e),this._entryPoint=null,this._tempEntryPointUniqueId=null,this._isTeleportOut=!0,this.registerOutput("output",M.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"TeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}_dumpCode(e,t){let i="";return this.entryPoint&&t.indexOf(this.entryPoint)===-1&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}clone(){let e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});
`),e}serialize(){let e=super.serialize();return e.entryPoint=this.entryPoint?.uniqueId??"",e}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}};P("BABYLON.TeleportOutBlock",NP);var IC=class extends fe{get textureData(){return this._data}get textureWidth(){return this._width}get textureHeight(){return this._height}constructor(e){super(e),this._data=null,this.serializedCachedData=!1,this.registerOutput("texture",M.Texture)}getClassName(){return"GeometryTextureBlock"}get texture(){return this._outputs[0]}_prepareImgToLoadAsync(e){return new Promise((t,i)=>{let r=new Image,n=document.createElement("canvas"),o=n.getContext("2d");r.onload=()=>{n.width=r.width,n.height=r.height,o.drawImage(r,0,0);let l=o.getImageData(0,0,r.width,r.height).data,c=new Float32Array(l.length);for(let h=0;h<l.length;h++)c[h]=l[h]/255;this._data=c,this._width=r.width,this._height=r.height,t()},r.onerror=()=>{this._data=null,i()},r.src=e})}cleanData(){this._data=null}loadTextureFromFileAsync(e){return this._prepareImgToLoadAsync(URL.createObjectURL(e))}loadTextureFromUrlAsync(e){return this._prepareImgToLoadAsync(e)}extractFromTextureAsync(e){return new Promise((t,i)=>{if(!e.isReady()){e.onLoadObservable.addOnce(()=>this.extractFromTextureAsync(e).then(t).catch(i));return}let r=e.getSize();DB.GetTextureDataAsync(e,r.width,r.height).then(n=>$e(this,null,function*(){let o=new Float32Array(n.length);for(let a=0;a<n.length;a++)o[a]=n[a]/255;this._data=o,this._width=r.width,this._height=r.height,t()})).catch(i)})}_buildBlock(){if(!this._data){this.texture._storedValue=null;return}let e={data:this._data,width:this._width,height:this._height};this.texture._storedValue=e}serialize(){let e=super.serialize();return e.width=this._width,e.height=this._height,e.serializedCachedData=this.serializedCachedData,this._data&&this.serializedCachedData&&(e.data=Array.from(this._data)),e}_deserialize(e){super._deserialize(e),this._width=e.width,this._height=e.height,e.data?(this._data=new Float32Array(e.data),this.serializedCachedData=!0):this.serializedCachedData=!!e.serializedCachedData}};v([de("Serialize cached data",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],IC.prototype,"serializedCachedData",void 0);P("BABYLON.GeometryTextureBlock",IC);var RC=class extends fe{constructor(e){super(e),this.clampCoordinates=!0,this.registerInput("texture",M.Texture),this.registerInput("coordinates",M.Vector2),this.registerOutput("rgba",M.Vector4),this.registerOutput("rgb",M.Vector3),this.registerOutput("r",M.Float),this.registerOutput("g",M.Float),this.registerOutput("b",M.Float),this.registerOutput("a",M.Float)}getClassName(){return"GeometryTextureFetchBlock"}get texture(){return this.inputs[0]}get coordinates(){return this.inputs[1]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}_repeatClamp(e){return e>=0?e%1:1-Math.abs(e)%1}_buildBlock(){let e=t=>{let i=this.texture.getConnectedValue(t);if(!i||!i.data)return null;let r=this.coordinates.getConnectedValue(t);if(!r)return null;let n=this.clampCoordinates?Math.max(0,Math.min(r.x,1)):this._repeatClamp(r.x),o=this.clampCoordinates?Math.max(0,Math.min(r.y,1)):this._repeatClamp(r.y),a=Math.floor(n*(i.width-1)),l=Math.floor(o*(i.height-1)),c=a+i.width*l;return De.FromArray(i.data,c*4)};this.rgba._storedFunction=t=>e(t),this.rgb._storedFunction=t=>{let i=e(t);return i?i.toVector3():null},this.r._storedFunction=t=>{let i=e(t);return i?i.x:null},this.g._storedFunction=t=>{let i=e(t);return i?i.y:null},this.b._storedFunction=t=>{let i=e(t);return i?i.z:null},this.a._storedFunction=t=>{let i=e(t);return i?i.w:null}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.clampCoordinates = ${this.clampCoordinates};
`}serialize(){let e=super.serialize();return e.clampCoordinates=this.clampCoordinates,e}_deserialize(e){super._deserialize(e),this.clampCoordinates=e.clampCoordinates}};v([de("Clamp Coordinates",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],RC.prototype,"clampCoordinates",void 0);P("BABYLON.GeometryTextureFetchBlock",RC);var FP=class extends fe{constructor(e){super(e),this.registerInput("geometry",M.Geometry),this.registerOutput("min",M.Vector3),this.registerOutput("max",M.Vector3)}getClassName(){return"BoundingBlock"}get geometry(){return this._inputs[0]}get min(){return this._outputs[0]}get max(){return this._outputs[1]}_buildBlock(){this.min._storedFunction=e=>{let t=this.geometry.getConnectedValue(e);return t?ja(t.positions,0,t.positions.length/3).minimum:null},this.max._storedFunction=e=>{let t=this.geometry.getConnectedValue(e);return t?ja(t.positions,0,t.positions.length/3).maximum:null}}};P("BABYLON.BoundingBlock",FP);var fl=function(s){return s[s.Intersect=0]="Intersect",s[s.Subtract=1]="Subtract",s[s.Union=2]="Union",s}(fl||{}),eg=class extends fe{constructor(e){super(e),this.evaluateContext=!1,this.operation=fl.Intersect,this.registerInput("geometry0",M.Geometry),this.registerInput("geometry1",M.Geometry),this.registerOutput("output",M.Geometry)}getClassName(){return"BooleanGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){let t=i=>{let r=this.geometry0.getConnectedValue(i),n=this.geometry1.getConnectedValue(i);if(!r||!n)return null;let o=r.positions.length/3;!r.normals&&n.normals&&(r.normals=new Array(r.positions.length)),!n.normals&&r.normals&&(n.normals=new Array(n.positions.length)),!r.uvs&&n.uvs&&(r.uvs=new Array(o*2)),!n.uvs&&r.uvs&&(n.uvs=new Array(o*2)),!r.colors&&n.colors&&(r.colors=new Array(o*4)),!n.colors&&r.colors&&(n.colors=new Array(o*4));let a=Ym.FromVertexData(r),l=Ym.FromVertexData(n),c;switch(this.operation){case fl.Intersect:c=a.intersect(l);break;case fl.Subtract:c=a.subtract(l);break;case fl.Union:c=a.union(l);break}return c.toVertexData()};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`;return e+=`${this._codeVariableName}.operation = BABYLON.BooleanGeometryOperations.${fl[this.operation]};
`,e}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,e.operation&&(this.operation=e.operation)}};v([de("Evaluate context",ue.Boolean,"ADVANCED",{notifiers:{rebuild:!0}})],eg.prototype,"evaluateContext",void 0);v([de("Operation",ue.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Intersect",value:fl.Intersect},{label:"Subtract",value:fl.Subtract},{label:"Union",value:fl.Union}]})],eg.prototype,"operation",void 0);P("BABYLON.BooleanGeometryBlock",eg);var LP=class extends fe{constructor(e){super(e),this.registerInput("x",M.AutoDetect),this.registerInput("y",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture)}getClassName(){return"GeometryArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.x.isConnected||!this.y.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(t,i)=>Math.atan2(t,i);this.output._storedFunction=t=>{let i=this.x.getConnectedValue(t),r=this.y.getConnectedValue(t);switch(this.x.type){case M.Int:case M.Float:return e(i,r);case M.Vector2:return new j(e(i.x,r.x),e(i.y,r.y));case M.Vector3:return new p(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case M.Vector4:return new De(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0}}};P("BABYLON.GeometryArcTan2Block",LP);var BP=class extends fe{constructor(e){super(e),this.registerInput("left",M.AutoDetect),this.registerInput("right",M.AutoDetect),this.registerInput("gradient",M.Float),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture)}getClassName(){return"GeometryLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected||!this.gradient.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(t,i,r)=>(1-t)*i+t*r;return this.output._storedFunction=t=>{let i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),n=this.gradient.getConnectedValue(t);switch(this.left.type){case M.Int:case M.Float:return e(n,i,r);case M.Vector2:return new j(e(n,i.x,r.x),e(n,i.y,r.y));case M.Vector3:return new p(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z));case M.Vector4:return new De(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z),e(n,i.w,r.w))}return 0},this}};P("BABYLON.GeometryLerpBlock",BP);var VP=class extends fe{constructor(e){super(e),this.registerInput("left",M.AutoDetect),this.registerInput("right",M.AutoDetect),this.registerInput("gradient",M.Float),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture)}getClassName(){return"GeometryNLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected||!this.gradient.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(t,i,r)=>(1-t)*i+t*r;return this.output._storedFunction=t=>{let i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),n=this.gradient.getConnectedValue(t);switch(this.left.type){case M.Int:case M.Float:return e(n,i,r);case M.Vector2:{let o=new j(e(n,i.x,r.x),e(n,i.y,r.y));return o.normalize(),o}case M.Vector3:{let o=new p(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z));return o.normalize(),o}case M.Vector4:{let o=new De(e(n,i.x,r.x),e(n,i.y,r.y),e(n,i.z,r.z),e(n,i.w,r.w));return o.normalize(),o}}return 0},this}};P("BABYLON.GeometryNLerpBlock",VP);var UP=class extends fe{constructor(e){super(e),this.registerInput("value",M.AutoDetect),this.registerInput("edge",M.Float),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture)}getClassName(){return"GeometryStepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.edge.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(t,i)=>t<i?0:1;return this.output._storedFunction=t=>{let i=this.value.getConnectedValue(t),r=this.edge.getConnectedValue(t);switch(this.value.type){case M.Int:case M.Float:return e(i,r);case M.Vector2:return new j(e(i.x,r),e(i.y,r));case M.Vector3:return new p(e(i.x,r),e(i.y,r),e(i.z,r));case M.Vector4:return new De(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}};P("BABYLON.GeometryStepBlock",UP);var kP=class extends fe{constructor(e){super(e),this.registerInput("value",M.AutoDetect),this.registerInput("edge0",M.Float),this.registerInput("edge1",M.Float),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture)}getClassName(){return"GeometrySmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.edge0.isConnected||!this.edge1.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(t,i,r)=>{let n=Math.max(0,Math.min((t-i)/(r-i),1));return n*n*(3-2*n)};return this.output._storedFunction=t=>{let i=this.value.getConnectedValue(t),r=this.edge0.getConnectedValue(t),n=this.edge1.getConnectedValue(t);switch(this.value.type){case M.Int:case M.Float:return e(i,r,n);case M.Vector2:return new j(e(i.x,r,n),e(i.y,r,n));case M.Vector3:return new p(e(i.x,r,n),e(i.y,r,n),e(i.z,r,n));case M.Vector4:return new De(e(i.x,r,n),e(i.y,r,n),e(i.z,r,n),e(i.w,r,n))}return 0},this}};P("BABYLON.GeometrySmoothStepBlock",kP);var GP=class extends fe{constructor(e){super(e),this.registerInput("left",M.AutoDetect),this.registerInput("right",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture)}getClassName(){return"GeometryModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(t,i)=>t-Math.floor(t/i)*i;return this.output._storedFunction=t=>{let i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t);switch(this.left.type){case M.Int:case M.Float:return e(i,r);case M.Vector2:return new j(e(i.x,r.x),e(i.y,r.y));case M.Vector3:return new p(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case M.Vector4:return new De(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0},this}};P("BABYLON.GeometryModBlock",GP);var zP=class extends fe{constructor(e){super(e),this.registerInput("value",M.AutoDetect),this.registerInput("power",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture)}getClassName(){return"GeometryPowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.power.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(t,i)=>Math.pow(t,i);return this.output._storedFunction=t=>{let i=this.value.getConnectedValue(t),r=this.power.getConnectedValue(t);switch(this.value.type){case M.Int:case M.Float:return e(i,r);case M.Vector2:return new j(e(i.x,r),e(i.y,r));case M.Vector3:return new p(e(i.x,r),e(i.y,r),e(i.z,r));case M.Vector4:return new De(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}};P("BABYLON.GeometryPowBlock",zP);var tg=class extends fe{constructor(e){super(e),this.minimum=0,this.maximum=1,this.registerInput("value",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Geometry),this._inputs[0].excludedConnectionPointTypes.push(M.Texture)}getClassName(){return"GeometryClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=t=>Math.max(this.minimum,Math.min(t,this.maximum));return this.output._storedFunction=t=>{let i=this.value.getConnectedValue(t);switch(this.value.type){case M.Int:case M.Float:return e(i);case M.Vector2:return new j(e(i.x),e(i.y));case M.Vector3:return new p(e(i.x),e(i.y),e(i.z));case M.Vector4:return new De(e(i.x),e(i.y),e(i.z),e(i.w))}return 0},this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};
`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};
`,e}serialize(){let e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e){super._deserialize(e),this.minimum=e.minimum,this.maximum=e.maximum}};v([de("Minimum",ue.Float)],tg.prototype,"minimum",void 0);v([de("Maximum",ue.Float)],tg.prototype,"maximum",void 0);P("BABYLON.GeometryClampBlock",tg);var WP=class extends fe{constructor(e){super(e),this.registerInput("left",M.AutoDetect),this.registerInput("right",M.AutoDetect),this.registerOutput("output",M.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(M.Int),this._inputs[0].excludedConnectionPointTypes.push(M.Float),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Vector2),this._inputs[1].excludedConnectionPointTypes.push(M.Int),this._inputs[1].excludedConnectionPointTypes.push(M.Float),this._inputs[1].excludedConnectionPointTypes.push(M.Matrix),this._inputs[1].excludedConnectionPointTypes.push(M.Vector2)}getClassName(){return"GeometryCrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);switch(this.left.type){case M.Vector3:return p.Cross(t,i);case M.Vector4:return p.Cross(t.toVector3(),i.toVector3())}return 0},this}};P("BABYLON.GeometryCrossBlock",WP);var nt=function(s){return s[s.EaseInSine=0]="EaseInSine",s[s.EaseOutSine=1]="EaseOutSine",s[s.EaseInOutSine=2]="EaseInOutSine",s[s.EaseInQuad=3]="EaseInQuad",s[s.EaseOutQuad=4]="EaseOutQuad",s[s.EaseInOutQuad=5]="EaseInOutQuad",s[s.EaseInCubic=6]="EaseInCubic",s[s.EaseOutCubic=7]="EaseOutCubic",s[s.EaseInOutCubic=8]="EaseInOutCubic",s[s.EaseInQuart=9]="EaseInQuart",s[s.EaseOutQuart=10]="EaseOutQuart",s[s.EaseInOutQuart=11]="EaseInOutQuart",s[s.EaseInQuint=12]="EaseInQuint",s[s.EaseOutQuint=13]="EaseOutQuint",s[s.EaseInOutQuint=14]="EaseInOutQuint",s[s.EaseInExpo=15]="EaseInExpo",s[s.EaseOutExpo=16]="EaseOutExpo",s[s.EaseInOutExpo=17]="EaseInOutExpo",s[s.EaseInCirc=18]="EaseInCirc",s[s.EaseOutCirc=19]="EaseOutCirc",s[s.EaseInOutCirc=20]="EaseInOutCirc",s[s.EaseInBack=21]="EaseInBack",s[s.EaseOutBack=22]="EaseOutBack",s[s.EaseInOutBack=23]="EaseInOutBack",s[s.EaseInElastic=24]="EaseInElastic",s[s.EaseOutElastic=25]="EaseOutElastic",s[s.EaseInOutElastic=26]="EaseInOutElastic",s}(nt||{}),PC=class extends fe{constructor(e){super(e),this.type=nt.EaseInOutSine,this.registerInput("input",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[0].excludedConnectionPointTypes.push(M.Int)}getClassName(){return"GeometryCurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e;switch(this.type){case nt.EaseInSine:e=t=>1-Math.cos(t*3.1415/2);break;case nt.EaseOutSine:e=t=>Math.sin(t*3.1415/2);break;case nt.EaseInOutSine:e=t=>-(Math.cos(t*3.1415)-1)/2;break;case nt.EaseInQuad:e=t=>t*t;break;case nt.EaseOutQuad:e=t=>(1-t)*(1-t);break;case nt.EaseInOutQuad:{e=t=>t<.5?2*t*t:1-Math.pow(-2*t+2,2)/2;break}case nt.EaseInCubic:e=t=>t*t*t;break;case nt.EaseOutCubic:{e=t=>1-Math.pow(1-t,3);break}case nt.EaseInOutCubic:{e=t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2;break}case nt.EaseInQuart:e=t=>t*t*t*t;break;case nt.EaseOutQuart:{e=t=>1-Math.pow(1-t,4);break}case nt.EaseInOutQuart:{e=t=>t<.5?8*t*t*t*t:1-Math.pow(-2*t+2,4)/2;break}case nt.EaseInQuint:e=t=>t*t*t*t*t;break;case nt.EaseOutQuint:{e=t=>1-Math.pow(1-t,5);break}case nt.EaseInOutQuint:{e=t=>t<.5?16*t*t*t*t*t:1-Math.pow(-2*t+2,5)/2;break}case nt.EaseInExpo:{e=t=>t===0?0:Math.pow(2,10*t-10);break}case nt.EaseOutExpo:{e=t=>t===1?1:1-Math.pow(2,-10*t);break}case nt.EaseInOutExpo:{e=t=>t===0?0:t===1?1:t<.5?Math.pow(2,20*t-10)/2:(2-Math.pow(2,-20*t+10))/2;break}case nt.EaseInCirc:{e=t=>1-Math.sqrt(1-Math.pow(t,2));break}case nt.EaseOutCirc:{e=t=>Math.sqrt(1-Math.pow(t-1,2));break}case nt.EaseInOutCirc:{e=t=>t<.5?(1-Math.sqrt(1-Math.pow(2*t,2)))/2:(Math.sqrt(1-Math.pow(-2*t+2,2))+1)/2;break}case nt.EaseInBack:{e=t=>2.70158*t*t*t-1.70158*t*t;break}case nt.EaseOutBack:{e=t=>2.70158*Math.pow(t-1,3)+1.70158*Math.pow(t-1,2);break}case nt.EaseInOutBack:{e=t=>t<.5?Math.pow(2*t,2)*(3.5949095*2*t-2.5949095)/2:(Math.pow(2*t-2,2)*(3.5949095*(t*2-2)+3.5949095)+2)/2;break}case nt.EaseInElastic:{e=t=>t===0?0:t===1?1:-Math.pow(2,10*t-10)*Math.sin((t*10-10.75)*(2*3.1415/3));break}case nt.EaseOutElastic:{e=t=>t===0?0:t===1?1:Math.pow(2,-10*t)*Math.sin((t*10-.75)*(2*3.1415/3))+1;break}case nt.EaseInOutElastic:{e=t=>t===0?0:t==1?1:t<.5?-(Math.pow(2,20*t-10)*Math.sin((20*t-11.125)*(2*3.1415/4.5)))/2:Math.pow(2,-20*t+10)*Math.sin((20*t-11.125)*(2*3.1415/4.5))/2+1;break}}return this.output._storedFunction=t=>{let i=this.input.getConnectedValue(t);switch(this.input.type){case M.Float:return e(i);case M.Vector2:return new j(e(i.x),e(i.y));case M.Vector3:return new p(e(i.x),e(i.y),e(i.z));case M.Vector4:return new De(e(i.x),e(i.y),e(i.z),e(i.w))}return 0},this}serialize(){let e=super.serialize();return e.curveType=this.type,e}_deserialize(e){super._deserialize(e),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.GeometryCurveBlockTypes.${nt[this.type]};
`}};v([de("Type",ue.List,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"EaseInSine",value:nt.EaseInSine},{label:"EaseOutSine",value:nt.EaseOutSine},{label:"EaseInOutSine",value:nt.EaseInOutSine},{label:"EaseInQuad",value:nt.EaseInQuad},{label:"EaseOutQuad",value:nt.EaseOutQuad},{label:"EaseInOutQuad",value:nt.EaseInOutQuad},{label:"EaseInCubic",value:nt.EaseInCubic},{label:"EaseOutCubic",value:nt.EaseOutCubic},{label:"EaseInOutCubic",value:nt.EaseInOutCubic},{label:"EaseInQuart",value:nt.EaseInQuart},{label:"EaseOutQuart",value:nt.EaseOutQuart},{label:"EaseInOutQuart",value:nt.EaseInOutQuart},{label:"EaseInQuint",value:nt.EaseInQuint},{label:"EaseOutQuint",value:nt.EaseOutQuint},{label:"EaseInOutQuint",value:nt.EaseInOutQuint},{label:"EaseInExpo",value:nt.EaseInExpo},{label:"EaseOutExpo",value:nt.EaseOutExpo},{label:"EaseInOutExpo",value:nt.EaseInOutExpo},{label:"EaseInCirc",value:nt.EaseInCirc},{label:"EaseOutCirc",value:nt.EaseOutCirc},{label:"EaseInOutCirc",value:nt.EaseInOutCirc},{label:"EaseInBack",value:nt.EaseInBack},{label:"EaseOutBack",value:nt.EaseOutBack},{label:"EaseInOutBack",value:nt.EaseInOutBack},{label:"EaseInElastic",value:nt.EaseInElastic},{label:"EaseOutElastic",value:nt.EaseOutElastic},{label:"EaseInOutElastic",value:nt.EaseInOutElastic}]})],PC.prototype,"type",void 0);P("BABYLON.GeometryCurveBlock",PC);var HP=class extends fe{constructor(e){super(e),this.registerInput("color",M.Vector3),this.registerInput("level",M.Float,!0,0),this.registerOutput("output",M.Vector3)}getClassName(){return"GeometryDesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.color.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.color.getConnectedValue(e),i=this.level.getConnectedValue(e),r=Math.min(t.x,t.y,t.z),n=Math.max(t.x,t.y,t.z),o=.5*(r+n);return new p(t.x*(1-i)+o*i,t.y*(1-i)+o*i,t.z*(1-i)+o*i)},this}};P("BABYLON.GeometryDesaturateBlock",HP);var XP=class extends fe{constructor(e){super(e),this.registerInput("value",M.AutoDetect),this.registerInput("steps",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[1].excludedConnectionPointTypes.push(M.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(M.Float)}getClassName(){return"GeometryPosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.steps.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.value.getConnectedValue(e),i=this.steps.getConnectedValue(e),r=i;if(this.steps.type===M.Float)switch(this.value.type){case M.Vector2:r=new j(i,i);break;case M.Vector3:r=new p(i,i,i);break;case M.Vector4:r=new De(i,i,i,i);break}switch(this.value.type){case M.Vector2:return new j(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y));case M.Vector3:return new p(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z));case M.Vector4:return new De(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z),t.w/(1/r.w)*(1/r.w));default:return Math.floor(t/(1/i)*(1/i))}},this}};P("BABYLON.GeometryPosterizeBlock",XP);var YP=class extends fe{constructor(e){super(e),this.registerInput("value",M.AutoDetect),this.registerInput("reference",M.AutoDetect),this.registerInput("distance",M.Float),this.registerInput("replacement",M.AutoDetect),this.registerOutput("output",M.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(M.Float),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[1].excludedConnectionPointTypes.push(M.Float),this._inputs[1].excludedConnectionPointTypes.push(M.Matrix),this._inputs[3].excludedConnectionPointTypes.push(M.Float),this._inputs[3].excludedConnectionPointTypes.push(M.Matrix)}getClassName(){return"GeometryReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.reference.isConnected||!this.distance.isConnected||!this.replacement.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.value.getConnectedValue(e),i=this.reference.getConnectedValue(e),r=this.distance.getConnectedValue(e),n=this.replacement.getConnectedValue(e);return t.subtract(i).length()<r?n:t},this}};P("BABYLON.GeometryReplaceColorBlock",YP);var $P=class extends fe{constructor(e){super(e),this.registerInput("left",M.AutoDetect),this.registerInput("right",M.AutoDetect),this.registerOutput("output",M.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(M.Int),this._inputs[0].excludedConnectionPointTypes.push(M.Float),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[1].excludedConnectionPointTypes.push(M.Float),this._inputs[1].excludedConnectionPointTypes.push(M.Matrix)}getClassName(){return"GeometryDistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.subtract(i).length()},this}};P("BABYLON.GeometryDistanceBlock",$P);var jP=class extends fe{constructor(e){super(e),this.registerInput("left",M.AutoDetect),this.registerInput("right",M.AutoDetect),this.registerOutput("output",M.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(M.Int),this._inputs[0].excludedConnectionPointTypes.push(M.Float),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix),this._inputs[1].excludedConnectionPointTypes.push(M.Float),this._inputs[1].excludedConnectionPointTypes.push(M.Matrix)}getClassName(){return"GeometryDotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.dot(i)},this}};P("BABYLON.GeometryDotBlock",jP);var qP=class extends fe{constructor(e){super(e),this.registerInput("value",M.AutoDetect),this.registerOutput("output",M.Float),this._inputs[0].excludedConnectionPointTypes.push(M.Int),this._inputs[0].excludedConnectionPointTypes.push(M.Float),this._inputs[0].excludedConnectionPointTypes.push(M.Matrix)}getClassName(){return"GeometryLengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>this.value.getConnectedValue(e).length(),this}};P("BABYLON.GeometryLengthBlock",qP);var QP=class extends fe{constructor(e){super(e),this.registerInput("input",M.Vector2),this.registerInput("angle",M.Float),this.registerOutput("output",M.Vector2)}getClassName(){return"GeometryRotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.angle.isConnected||!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.input.getConnectedValue(e),i=this.angle.getConnectedValue(e);return new j(Math.cos(i)*t.x-Math.sin(i)*t.y,Math.sin(i)*t.x+Math.cos(i)*t.y)},this}};P("BABYLON.GeometryRotate2dBlock",QP);K.OfflineProviderFactory=(s,e,t=!1)=>new YQ(s,e,t);var YQ=(()=>{class s{get enableSceneOffline(){return this._enableSceneOffline}get enableTexturesOffline(){return this._enableTexturesOffline}constructor(t,i,r=!1){this._idbFactory=typeof indexedDB<"u"?indexedDB:void 0,this._currentSceneUrl=s._ReturnFullUrlLocation(t),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,s.IDBStorageEnabled?r?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,H.SetImmediate(()=>{i(!0)})):this._checkManifestFile(i):i(!0)}_checkManifestFile(t){let i=()=>{this._enableSceneOffline=!1,this._enableTexturesOffline=!1,t(!1)},r=()=>{try{if(typeof URL=="function"&&this._currentSceneUrl.indexOf("http")===0){let l=new URL(this._currentSceneUrl);return l.pathname+=".manifest",l.toString()}}catch{}return`${this._currentSceneUrl}.manifest`},n=!1,o=r(),a=new gr;navigator.onLine&&(n=!0,o=o+(o.match(/\?/)==null?"?":"&")+Date.now()),a.open("GET",o),a.addEventListener("load",()=>{if(a.status===200||s._ValidateXHRData(a,1))try{let l=JSON.parse(a.response);this._enableSceneOffline=l.enableSceneOffline,this._enableTexturesOffline=l.enableTexturesOffline&&s._IsUASupportingBlobStorage,l.version&&!isNaN(parseInt(l.version))&&(this._manifestVersionFound=l.version),t(!0)}catch{i()}else i()},!1),a.addEventListener("error",()=>{if(n){n=!1;let l=r();a.open("GET",l),a.send()}else i()},!1);try{a.send()}catch{F.Error("Error on XHR send request."),t(!1)}}open(t,i){let r=()=>{this._isSupported=!1,i&&i()};if(!this._idbFactory||!(this._enableSceneOffline||this._enableTexturesOffline))this._isSupported=!1,i&&i();else if(this._db)t&&t();else{this._hasReachedQuota=!1,this._isSupported=!0;let n=this._idbFactory.open("babylonjs",1);n.onerror=()=>{r()},n.onblocked=()=>{F.Error("IDB request blocked. Please reload the page."),r()},n.onsuccess=()=>{this._db=n.result,t()},n.onupgradeneeded=o=>{if(this._db=o.target.result,this._db)try{this._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),this._db.createObjectStore("versions",{keyPath:"sceneUrl"}),this._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(a){F.Error("Error while creating object stores. Exception: "+a.message),r()}}}}loadImage(t,i){let r=s._ReturnFullUrlLocation(t),n=()=>{!this._hasReachedQuota&&this._db!==null?this._saveImageIntoDBAsync(r,i):i.src=t};this._mustUpdateRessources?n():this._loadImageFromDBAsync(r,i,n)}_loadImageFromDBAsync(t,i,r){if(this._isSupported&&this._db!==null){let n,o=this._db.transaction(["textures"]);o.onabort=()=>{i.src=t},o.oncomplete=()=>{let l;n&&typeof URL=="function"?(l=URL.createObjectURL(n.data),i.onerror=()=>{F.Error("Error loading image from blob URL: "+l+" switching back to web url: "+t),i.src=t},i.src=l):r()};let a=o.objectStore("textures").get(t);a.onsuccess=l=>{n=l.target.result},a.onerror=()=>{F.Error("Error loading texture "+t+" from DB."),i.src=t}}else F.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i.src=t}_saveImageIntoDBAsync(t,i){let r;if(this._isSupported){let n=()=>{let o;if(r&&typeof URL=="function")try{o=URL.createObjectURL(r)}catch{o=URL.createObjectURL(r)}o&&(i.src=o)};if(s._IsUASupportingBlobStorage){let o=new gr;o.open("GET",t),o.responseType="blob",o.addEventListener("load",()=>{if(o.status===200&&this._db){r=o.response;let a=this._db.transaction(["textures"],"readwrite");a.onabort=c=>{try{let u=c.target.error;u&&u.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}n()},a.oncomplete=()=>{n()};let l={textureUrl:t,data:r};try{let c=a.objectStore("textures").put(l);c.onsuccess=()=>{},c.onerror=()=>{n()}}catch(c){c.code===25&&(s._IsUASupportingBlobStorage=!1,this._enableTexturesOffline=!1),i.src=t}}else i.src=t},!1),o.addEventListener("error",()=>{F.Error("Error in XHR request in BABYLON.Database."),i.src=t},!1),o.send()}else i.src=t}else F.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),i.src=t}_checkVersionFromDB(t,i){let r=()=>{this._saveVersionIntoDBAsync(t,i)};this._loadVersionFromDBAsync(t,i,r)}_loadVersionFromDBAsync(t,i,r){if(this._isSupported&&this._db){let n;try{let o=this._db.transaction(["versions"]);o.oncomplete=()=>{n?this._manifestVersionFound!==n.data?(this._mustUpdateRessources=!0,r()):i(n.data):(this._mustUpdateRessources=!0,r())},o.onabort=()=>{i(-1)};let a=o.objectStore("versions").get(t);a.onsuccess=l=>{n=l.target.result},a.onerror=()=>{F.Error("Error loading version for scene "+t+" from DB."),i(-1)}}catch(o){F.Error("Error while accessing 'versions' object store (READ OP). Exception: "+o.message),i(-1)}}else F.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),i(-1)}_saveVersionIntoDBAsync(t,i){if(this._isSupported&&!this._hasReachedQuota&&this._db)try{let r=this._db.transaction(["versions"],"readwrite");r.onabort=a=>{try{let l=a.target.error;l&&l.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}i(-1)},r.oncomplete=()=>{i(this._manifestVersionFound)};let n={sceneUrl:t,data:this._manifestVersionFound},o=r.objectStore("versions").put(n);o.onsuccess=()=>{},o.onerror=()=>{F.Error("Error in DB add version request in BABYLON.Database.")}}catch(r){F.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+r.message),i(-1)}else i(-1)}loadFile(t,i,r,n,o){let a=s._ReturnFullUrlLocation(t),l=()=>{this._saveFileAsync(a,i,r,o,n)};this._checkVersionFromDB(a,c=>{c!==-1?this._mustUpdateRessources?this._saveFileAsync(a,i,r,o,n):this._loadFileAsync(a,i,l):n&&n()})}_loadFileAsync(t,i,r){if(this._isSupported&&this._db){let n;t.indexOf(".babylon")!==-1?n="scenes":n="textures";let o,a=this._db.transaction([n]);a.oncomplete=()=>{o?i(o.data):r()},a.onabort=()=>{r()};let l=a.objectStore(n).get(t);l.onsuccess=c=>{o=c.target.result},l.onerror=()=>{F.Error("Error loading file "+t+" from DB."),r()}}else F.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),i()}_saveFileAsync(t,i,r,n,o){if(this._isSupported){let a;t.indexOf(".babylon")!==-1?a="scenes":a="textures";let l=new gr,c;l.open("GET",t+(t.match(/\?/)==null?"?":"&")+Date.now()),n&&(l.responseType="arraybuffer"),r&&(l.onprogress=r),l.addEventListener("load",()=>{if(l.status===200||l.status<400&&s._ValidateXHRData(l,n?6:1))if(c=n?l.response:l.responseText,!this._hasReachedQuota&&this._db){let h=this._db.transaction([a],"readwrite");h.onabort=d=>{try{let f=d.target.error;f&&f.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}i(c)},h.oncomplete=()=>{i(c)};let u;a==="scenes"?u={sceneUrl:t,data:c,version:this._manifestVersionFound}:u={textureUrl:t,data:c};try{let d=h.objectStore(a).put(u);d.onsuccess=()=>{},d.onerror=()=>{F.Error("Error in DB add file request in BABYLON.Database.")}}catch{i(c)}}else i(c);else l.status>=400&&o?o(l):i()},!1),l.addEventListener("error",()=>{F.Error("error on XHR request."),o&&o()},!1),l.send()}else F.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),o&&o()}static _ValidateXHRData(t,i=7){try{if(i&1){if(t.responseText&&t.responseText.length>0)return!0;if(i===1)return!1}if(i&2){let r=Qd(t.response);if(r.width&&r.height&&r.width>0&&r.height>0)return!0;if(i===2)return!1}if(i&4){let r=new Uint8Array(t.response,0,3);return r[0]===68&&r[1]===68&&r[2]===83}}catch{}return!1}}return s._IsUASupportingBlobStorage=!0,s.IDBStorageEnabled=!1,s._ParseURL=e=>{let t=document.createElement("a");t.href=e;let i=e.substring(0,e.lastIndexOf("#")),r=e.substring(i.lastIndexOf("/")+1,e.length);return e.substring(0,e.indexOf(r,0))},s._ReturnFullUrlLocation=e=>e.indexOf("http:/")===-1&&e.indexOf("https:/")===-1&&typeof window<"u"?s._ParseURL(window.location.href)+e:e,s})();var No=class s{constructor(){this.direction1=new p(0,1,0),this.direction2=new p(0,1,0),this.minEmitBox=new p(-.5,-.5,-.5),this.maxEmitBox=new p(.5,.5,.5)}startDirectionFunction(e,t,i,r){let n=ls(this.direction1.x,this.direction2.x),o=ls(this.direction1.y,this.direction2.y),a=ls(this.direction1.z,this.direction2.z);if(r){t.x=n,t.y=o,t.z=a;return}p.TransformNormalFromFloatsToRef(n,o,a,e,t)}startPositionFunction(e,t,i,r){let n=ls(this.minEmitBox.x,this.maxEmitBox.x),o=ls(this.minEmitBox.y,this.maxEmitBox.y),a=ls(this.minEmitBox.z,this.maxEmitBox.z);if(r){t.x=n,t.y=o,t.z=a;return}p.TransformCoordinatesFromFloatsToRef(n,o,a,e,t)}clone(){let e=new s;return ei.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){p.FromArrayToRef(e.direction1,0,this.direction1),p.FromArrayToRef(e.direction2,0,this.direction2),p.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),p.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}};var Ah=class s{get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1}constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}startDirectionFunction(e,t,i,r){r?O.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),O.Vector3[0]).normalize();let n=xe.RandomRange(0,this.directionRandomizer),o=xe.RandomRange(0,this.directionRandomizer),a=xe.RandomRange(0,this.directionRandomizer);t.x=O.Vector3[0].x+n,t.y=O.Vector3[0].y+o,t.z=O.Vector3[0].z+a,t.normalize()}startPositionFunction(e,t,i,r){let n=xe.RandomRange(0,Math.PI*2),o;this.emitFromSpawnPointOnly?o=1e-4:(o=xe.RandomRange(0,this.heightRange),o=1-o*o);let a=this._radius-xe.RandomRange(0,this._radius*this.radiusRange);a=a*o;let l=a*Math.sin(n),c=a*Math.cos(n),h=o*this._height;if(r){t.x=l,t.y=h,t.z=c;return}p.TransformCoordinatesFromFloatsToRef(l,h,c,e,t)}clone(){let e=new s(this._radius,this._angle,this.directionRandomizer);return ei.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+=`
#define CONEEMITTERSPAWNPOINT`),e}getClassName(){return"ConeParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=e.radiusRange!==void 0?e.radiusRange:1,this.heightRange=e.radiusRange!==void 0?e.heightRange:1,this.emitFromSpawnPointOnly=e.emitFromSpawnPointOnly!==void 0?e.emitFromSpawnPointOnly:!1}},af=class s extends Ah{constructor(e=1,t=Math.PI,i=new p(0,1,0),r=new p(0,1,0)){super(e,t),this.direction1=i,this.direction2=r}startDirectionFunction(e,t){let i=xe.RandomRange(this.direction1.x,this.direction2.x),r=xe.RandomRange(this.direction1.y,this.direction2.y),n=xe.RandomRange(this.direction1.z,this.direction2.z);p.TransformNormalFromFloatsToRef(i,r,n,e,t)}clone(){let e=new s(this.radius,this.angle,this.direction1,this.direction2);return ei.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CONEEMITTER
#define DIRECTEDCONEEMITTER`}getClassName(){return"ConeDirectedParticleEmitter"}serialize(){let e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}};var Ih=class s{constructor(e=1,t=1,i=1,r=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=r,this._tempVector=p.Zero()}startDirectionFunction(e,t,i,r,n){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),p.TransformNormalToRef(this._tempVector,n,this._tempVector);let o=xe.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2),a=Math.atan2(this._tempVector.x,this._tempVector.z);if(a+=xe.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=o,this._tempVector.x=Math.sin(a),this._tempVector.z=Math.cos(a),this._tempVector.normalize(),r){t.copyFrom(this._tempVector);return}p.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,r){let n=xe.RandomRange(-this.height/2,this.height/2),o=xe.RandomRange(0,2*Math.PI),a=xe.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(a)*this.radius,c=l*Math.cos(o),h=l*Math.sin(o);if(r){t.copyFromFloats(c,n,h);return}p.TransformCoordinatesFromFloatsToRef(c,n,h,e,t)}clone(){let e=new s(this.radius,this.directionRandomizer);return ei.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}},lf=class s extends Ih{constructor(e=1,t=1,i=1,r=new p(0,1,0),n=new p(0,1,0)){super(e,t,i),this.direction1=r,this.direction2=n}startDirectionFunction(e,t,i,r){let n=xe.RandomRange(this.direction1.x,this.direction2.x),o=xe.RandomRange(this.direction1.y,this.direction2.y),a=xe.RandomRange(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(n,o,a);return}p.TransformNormalFromFloatsToRef(n,o,a,e,t)}clone(){let e=new s(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return ei.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){let e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),p.FromArrayToRef(e.direction1,0,this.direction1),p.FromArrayToRef(e.direction2,0,this.direction2)}};var cf=class s{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){let n=i.position.subtract(e.getTranslation()).normalize(),o=xe.RandomRange(0,this.directionRandomizer),a=xe.RandomRange(0,this.directionRandomizer),l=xe.RandomRange(0,this.directionRandomizer);if(n.x+=o,n.y+=a,n.z+=l,n.normalize(),r){t.copyFrom(n);return}p.TransformNormalFromFloatsToRef(n.x,n.y,n.z,e,t)}startPositionFunction(e,t,i,r){let n=this.radius-xe.RandomRange(0,this.radius*this.radiusRange),o=xe.RandomRange(0,1),a=xe.RandomRange(0,2*Math.PI),l=Math.acos(2*o-1),c=n*Math.cos(a)*Math.sin(l),h=n*Math.cos(l),u=n*Math.sin(a)*Math.sin(l);if(r){t.copyFromFloats(c,Math.abs(h),u);return}p.TransformCoordinatesFromFloatsToRef(c,Math.abs(h),u,e,t)}clone(){let e=new s(this.radius,this.directionRandomizer);return ei.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}};var hf=class s{constructor(){this.direction1=new p(0,1,0),this.direction2=new p(0,1,0)}startDirectionFunction(e,t,i,r){let n=xe.RandomRange(this.direction1.x,this.direction2.x),o=xe.RandomRange(this.direction1.y,this.direction2.y),a=xe.RandomRange(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(n,o,a);return}p.TransformNormalFromFloatsToRef(n,o,a,e,t)}startPositionFunction(e,t,i,r){if(r){t.copyFromFloats(0,0,0);return}p.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){let e=new s;return ei.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){p.FromArrayToRef(e.direction1,0,this.direction1),p.FromArrayToRef(e.direction2,0,this.direction2)}};var Rh=class s{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,r){let n=i.position.subtract(e.getTranslation()).normalize(),o=xe.RandomRange(0,this.directionRandomizer),a=xe.RandomRange(0,this.directionRandomizer),l=xe.RandomRange(0,this.directionRandomizer);if(n.x+=o,n.y+=a,n.z+=l,n.normalize(),r){t.copyFrom(n);return}p.TransformNormalFromFloatsToRef(n.x,n.y,n.z,e,t)}startPositionFunction(e,t,i,r){let n=this.radius-xe.RandomRange(0,this.radius*this.radiusRange),o=xe.RandomRange(0,1),a=xe.RandomRange(0,2*Math.PI),l=Math.acos(2*o-1),c=n*Math.cos(a)*Math.sin(l),h=n*Math.cos(l),u=n*Math.sin(a)*Math.sin(l);if(r){t.copyFromFloats(c,h,u);return}p.TransformCoordinatesFromFloatsToRef(c,h,u,e,t)}clone(){let e=new s(this.radius,this.directionRandomizer);return ei.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}},uf=class s extends Rh{constructor(e=1,t=new p(0,1,0),i=new p(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){let i=xe.RandomRange(this.direction1.x,this.direction2.x),r=xe.RandomRange(this.direction1.y,this.direction2.y),n=xe.RandomRange(this.direction1.z,this.direction2.z);p.TransformNormalFromFloatsToRef(i,r,n,e,t)}clone(){let e=new s(this.radius,this.direction1,this.direction2);return ei.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){let e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}};var Fo=class s{constructor(){this.particlePositionGenerator=()=>{},this.particleDestinationGenerator=()=>{}}startDirectionFunction(e,t,i,r){let n=O.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,n);let o=O.Vector3[1];n.subtractToRef(i.position,o),o.scaleToRef(1/i.lifeTime,n)}else n.set(0,0,0);if(r){t.copyFrom(n);return}p.TransformNormalToRef(n,e,t)}startPositionFunction(e,t,i,r){let n=O.Vector3[0];if(this.particlePositionGenerator?this.particlePositionGenerator(-1,i,n):n.set(0,0,0),r){t.copyFrom(n);return}p.TransformCoordinatesToRef(n,e,t)}clone(){let e=new s;return ei.DeepCopy(this,e),e}applyToShader(e){}buildUniformLayout(e){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.particlePositionGenerator=this.particlePositionGenerator,e.particleDestinationGenerator=this.particleDestinationGenerator,e}parse(e){e.particlePositionGenerator&&(this.particlePositionGenerator=e.particlePositionGenerator),e.particleDestinationGenerator&&(this.particleDestinationGenerator=e.particleDestinationGenerator)}};var MC=class s{get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(y.PositionKind),this._normals=e.getVerticesData(y.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=p.Zero(),this._mesh=null,this.direction1=new p(0,1,0),this.direction2=new p(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}startDirectionFunction(e,t,i,r){if(this.useMeshNormalsForDirection&&this._normals){p.TransformNormalToRef(this._storedNormal,e,t);return}let n=xe.RandomRange(this.direction1.x,this.direction2.x),o=xe.RandomRange(this.direction1.y,this.direction2.y),a=xe.RandomRange(this.direction1.z,this.direction2.z);if(r){t.copyFromFloats(n,o,a);return}p.TransformNormalFromFloatsToRef(n,o,a,e,t)}startPositionFunction(e,t,i,r){if(!this._indices||!this._positions)return;let n=3*Math.random()*(this._indices.length/3)|0,o=Math.random(),a=Math.random()*(1-o),l=1-o-a,c=this._indices[n],h=this._indices[n+1],u=this._indices[n+2],d=O.Vector3[0],f=O.Vector3[1],m=O.Vector3[2],g=O.Vector3[3];p.FromArrayToRef(this._positions,c*3,d),p.FromArrayToRef(this._positions,h*3,f),p.FromArrayToRef(this._positions,u*3,m),g.x=o*d.x+a*f.x+l*m.x,g.y=o*d.y+a*f.y+l*m.y,g.z=o*d.z+a*f.z+l*m.z,r?t.copyFromFloats(g.x,g.y,g.z):p.TransformCoordinatesFromFloatsToRef(g.x,g.y,g.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(p.FromArrayToRef(this._normals,c*3,d),p.FromArrayToRef(this._normals,h*3,f),p.FromArrayToRef(this._normals,u*3,m),this._storedNormal.x=o*d.x+a*f.x+l*m.x,this._storedNormal.y=o*d.y+a*f.y+l*m.y,this._storedNormal.z=o*d.z+a*f.z+l*m.z)}clone(){let e=new s(this.mesh);return ei.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){let e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.meshId=this.mesh?.id,e.useMeshNormalsForDirection=this.useMeshNormalsForDirection,e}parse(e,t){p.FromArrayToRef(e.direction1,0,this.direction1),p.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}};var df=class{_isUbo(e){return e.addUniform!==void 0}constructor(e){this._isUbo(e)?(this.setMatrix3x3=e.updateMatrix3x3.bind(e),this.setMatrix2x2=e.updateMatrix2x2.bind(e),this.setFloat=e.updateFloat.bind(e),this.setFloat2=e.updateFloat2.bind(e),this.setFloat3=e.updateFloat3.bind(e),this.setFloat4=e.updateFloat4.bind(e),this.setFloatArray=e.updateFloatArray.bind(e),this.setArray=e.updateArray.bind(e),this.setIntArray=e.updateIntArray.bind(e),this.setMatrix=e.updateMatrix.bind(e),this.setMatrices=e.updateMatrices.bind(e),this.setVector3=e.updateVector3.bind(e),this.setVector4=e.updateVector4.bind(e),this.setColor3=e.updateColor3.bind(e),this.setColor4=e.updateColor4.bind(e),this.setDirectColor4=e.updateDirectColor4.bind(e),this.setInt=e.updateInt.bind(e),this.setInt2=e.updateInt2.bind(e),this.setInt3=e.updateInt3.bind(e),this.setInt4=e.updateInt4.bind(e)):(this.setMatrix3x3=e.setMatrix3x3.bind(e),this.setMatrix2x2=e.setMatrix2x2.bind(e),this.setFloat=e.setFloat.bind(e),this.setFloat2=e.setFloat2.bind(e),this.setFloat3=e.setFloat3.bind(e),this.setFloat4=e.setFloat4.bind(e),this.setFloatArray=e.setFloatArray.bind(e),this.setArray=e.setArray.bind(e),this.setIntArray=e.setIntArray.bind(e),this.setMatrix=e.setMatrix.bind(e),this.setMatrices=e.setMatrices.bind(e),this.setVector3=e.setVector3.bind(e),this.setVector4=e.setVector4.bind(e),this.setColor3=e.setColor3.bind(e),this.setColor4=e.setColor4.bind(e),this.setDirectColor4=e.setDirectColor4.bind(e),this.setInt=e.setInt.bind(e),this.setInt2=e.setInt2.bind(e),this.setInt3=e.setInt3.bind(e),this.setInt4=e.setInt4.bind(e))}};var $Q="gpuUpdateParticlesPixelShader",jQ=`#version 300 es
void main() {discard;}
`;D.ShadersStore[$Q]=jQ;var qQ="gpuUpdateParticlesVertexShader",QQ=`#version 300 es
#define PI 3.14159
uniform float currentCount;uniform float timeDelta;uniform float stopFactor;
#ifndef LOCAL
uniform mat4 emitterWM;
#endif
uniform vec2 lifeTime;uniform vec2 emitPower;uniform vec2 sizeRange;uniform vec4 scaleRange;
#ifndef COLORGRADIENTS
uniform vec4 color1;uniform vec4 color2;
#endif
uniform vec3 gravity;uniform sampler2D randomSampler;uniform sampler2D randomSampler2;uniform vec4 angleRange;
#ifdef BOXEMITTER
uniform vec3 direction1;uniform vec3 direction2;uniform vec3 minEmitBox;uniform vec3 maxEmitBox;
#endif
#ifdef POINTEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#endif
#ifdef HEMISPHERICEMITTER
uniform float radius;uniform float radiusRange;uniform float directionRandomizer;
#endif
#ifdef SPHEREEMITTER
uniform float radius;uniform float radiusRange;
#ifdef DIRECTEDSPHEREEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CYLINDEREMITTER
uniform float radius;uniform float height;uniform float radiusRange;
#ifdef DIRECTEDCYLINDEREMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CONEEMITTER
uniform vec2 radius;uniform float coneAngle;uniform vec2 height;
#ifdef DIRECTEDCONEEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
in vec3 position;
#ifdef CUSTOMEMITTER
in vec3 initialPosition;
#endif
in float age;in float life;in vec4 seed;in vec3 size;
#ifndef COLORGRADIENTS
in vec4 color;
#endif
in vec3 direction;
#ifndef BILLBOARD
in vec3 initialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
in float angle;
#else
in vec2 angle;
#endif
#ifdef ANIMATESHEET
in float cellIndex;
#ifdef ANIMATESHEETRANDOMSTART
in float cellStartOffset;
#endif
#endif
#ifdef NOISE
in vec3 noiseCoordinates1;in vec3 noiseCoordinates2;
#endif
out vec3 outPosition;
#ifdef CUSTOMEMITTER
out vec3 outInitialPosition;
#endif
out float outAge;out float outLife;out vec4 outSeed;out vec3 outSize;
#ifndef COLORGRADIENTS
out vec4 outColor;
#endif
out vec3 outDirection;
#ifndef BILLBOARD
out vec3 outInitialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
out float outAngle;
#else
out vec2 outAngle;
#endif
#ifdef ANIMATESHEET
out float outCellIndex;
#ifdef ANIMATESHEETRANDOMSTART
out float outCellStartOffset;
#endif
#endif
#ifdef NOISE
out vec3 outNoiseCoordinates1;out vec3 outNoiseCoordinates2;
#endif
#ifdef SIZEGRADIENTS
uniform sampler2D sizeGradientSampler;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
uniform sampler2D angularSpeedGradientSampler;
#endif 
#ifdef VELOCITYGRADIENTS
uniform sampler2D velocityGradientSampler;
#endif
#ifdef LIMITVELOCITYGRADIENTS
uniform sampler2D limitVelocityGradientSampler;uniform float limitVelocityDamping;
#endif
#ifdef DRAGGRADIENTS
uniform sampler2D dragGradientSampler;
#endif
#ifdef NOISE
uniform vec3 noiseStrength;uniform sampler2D noiseSampler;
#endif
#ifdef ANIMATESHEET
uniform vec4 cellInfos;
#endif
vec3 getRandomVec3(float offset) {return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;}
vec4 getRandomVec4(float offset) {return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));}
void main() {float newAge=age+timeDelta; 
if (newAge>=life && stopFactor != 0.) {vec3 newPosition;vec3 newDirection;vec4 randoms=getRandomVec4(seed.x);outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;outAge=newAge-life;outSeed=seed;
#ifdef SIZEGRADIENTS 
outSize.x=texture(sizeGradientSampler,vec2(0,0)).r;
#else
outSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;
#endif
outSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; 
#ifndef COLORGRADIENTS
outColor=color1+(color2-color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
outAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#else
outAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#endif 
#ifdef POINTEMITTER
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=vec3(0,0,0);newDirection=direction1+(direction2-direction1)*randoms3;
#elif defined(BOXEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;newDirection=direction1+(direction2-direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);newDirection=newPosition+directionRandomizer*randoms3; 
#elif defined(SPHEREEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(direction1+(direction2-direction1)*randoms3);
#else
newDirection=normalize(newPosition+directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float yPos=(randoms2.x-0.5)*height;float angle=randoms2.y*PI*2.;float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));float xPos=positionRadius*cos(angle);float zPos=positionRadius*sin(angle);newPosition=vec3(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
angle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;newDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
vec3 randoms2=getRandomVec3(seed.y);float s=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
float h=0.0001;
#else
float h=randoms2.y*height.y;h=1.-h*h; 
#endif
float lRadius=radius.x-radius.x*randoms2.z*radius.y;lRadius=lRadius*h;float randX=lRadius*sin(s);float randZ=lRadius*cos(s);float randY=h *height.x;newPosition=vec3(randX,randY,randZ); 
vec3 randoms3=getRandomVec3(seed.z);
#ifdef DIRECTEDCONEEMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
if (abs(cos(coneAngle))==1.0) {newDirection=vec3(0.,1.0,0.);} else {newDirection=normalize(newPosition+directionRandomizer*randoms3); }
#endif
#elif defined(CUSTOMEMITTER)
newPosition=initialPosition;outInitialPosition=initialPosition;
#else 
newPosition=vec3(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));
#endif
float power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;
#ifdef LOCAL
outPosition=newPosition;
#else
outPosition=(emitterWM*vec4(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#ifndef BILLBOARD 
outInitialDirection=direction;
#endif
#else
#ifdef LOCAL
vec3 initial=newDirection;
#else 
vec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;
#endif
outDirection=initial*power;
#ifndef BILLBOARD 
outInitialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
outCellIndex=cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;
#endif
} else {float directionScale=timeDelta;outAge=newAge;float ageGradient=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;
#endif
#ifdef DRAGGRADIENTS
directionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;
#endif
#if defined(CUSTOMEMITTER)
outPosition=position+(direction-position)*ageGradient; 
outInitialPosition=initialPosition;
#else
outPosition=position+direction*directionScale;
#endif
outLife=life;outSeed=seed;
#ifndef COLORGRADIENTS 
outColor=color;
#endif
#ifdef SIZEGRADIENTS
outSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;outSize.yz=size.yz;
#else
outSize=size;
#endif 
#ifndef BILLBOARD 
outInitialDirection=initialDirection;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#else
vec3 updatedDirection=direction+gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
float limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;float currentVelocity=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*limitVelocityDamping;}
#endif
outDirection=updatedDirection;
#ifdef NOISE
float fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;outDirection=outDirection+force*timeDelta;outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
float angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;outAngle=angle+angularSpeed*timeDelta;
#else
outAngle=vec2(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
float offsetAge=outAge;float dist=cellInfos.y-cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=cellStartOffset;offsetAge+=cellStartOffset;
#else
float cellStartOffset=0.;
#endif 
float ratio=0.;if (cellInfos.w==1.0) {ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);}
else {ratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);}
outCellIndex=float(int(cellInfos.x+ratio*dist));
#endif
}}`;D.ShadersStore[qQ]=QQ;var KP=class{constructor(e,t){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=e,this._engine=t,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}contextLost(){this._updateEffect=void 0,this._renderVAO.length=0,this._updateVAO.length=0}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){return this._updateEffect?.isReady()??!1}createUpdateBuffer(e){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof Fo&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=e,this._updateEffect=new $t("gpuUpdateParticles",this._updateEffectOptions,this._engine),new df(this._updateEffect)}createVertexBuffers(e,t){this._updateVAO.push(this._createUpdateVAO(e)),this._renderVAO.push(this._engine.recordVertexArrayObject(t,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null),this._renderVertexBuffers=t}createParticleBuffer(e){return e}bindDrawBuffers(e,t,i){i?this._engine.bindBuffers(this._renderVertexBuffers,i,t):this._engine.bindVertexArrayObject(this._renderVAO[e],null)}preUpdateParticleBuffer(){let e=this._engine;if(this._engine.enableEffect(this._updateEffect),!e.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(e,t,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[e],null);let r=this._engine;r.bindTransformFeedbackBuffer(t.getBuffer()),r.setRasterizerState(!1),r.beginTransformFeedback(!0),r.drawArraysType(3,0,i),r.endTransformFeedback(),r.setRasterizerState(!0),r.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO.length=0;for(let e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO.length=0}_createUpdateVAO(e){let t={};t.position=e.createVertexBuffer("position",0,3);let i=3;t.age=e.createVertexBuffer("age",i,1),i+=1,t.size=e.createVertexBuffer("size",i,3),i+=3,t.life=e.createVertexBuffer("life",i,1),i+=1,t.seed=e.createVertexBuffer("seed",i,4),i+=4,t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof Fo&&(t.initialPosition=e.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1));let r=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),r}};P("BABYLON.WebGL2ParticleSystem",KP);var KQ="gpuUpdateParticlesComputeShader",ZQ=`struct Particle {position : vec3<f32>,
age : f32,
size : vec3<f32>,
life : f32,
seed : vec4<f32>,
direction : vec3<f32>,
dummy0: f32,
#ifdef CUSTOMEMITTER
initialPosition : vec3<f32>,
dummy1: f32,
#endif
#ifndef COLORGRADIENTS
color : vec4<f32>,
#endif
#ifndef BILLBOARD
initialDirection : vec3<f32>,
dummy2: f32,
#endif
#ifdef NOISE
noiseCoordinates1 : vec3<f32>,
dummy3: f32,
noiseCoordinates2 : vec3<f32>,
dummy4: f32,
#endif
#ifdef ANGULARSPEEDGRADIENTS
angle : f32,
#else
angle : vec2<f32>,
#endif
#ifdef ANIMATESHEET
cellIndex : f32,
#ifdef ANIMATESHEETRANDOMSTART
cellStartOffset : f32,
#endif
#endif
};struct Particles {particles : array<Particle>,};struct SimParams {currentCount : f32,
timeDelta : f32,
stopFactor : f32,
randomTextureSize: i32,
lifeTime : vec2<f32>,
emitPower : vec2<f32>,
#ifndef COLORGRADIENTS
color1 : vec4<f32>,
color2 : vec4<f32>,
#endif
sizeRange : vec2<f32>,
scaleRange : vec4<f32>,
angleRange : vec4<f32>,
gravity : vec3<f32>,
#ifdef LIMITVELOCITYGRADIENTS
limitVelocityDamping : f32,
#endif
#ifdef ANIMATESHEET
cellInfos : vec4<f32>,
#endif
#ifdef NOISE
noiseStrength : vec3<f32>,
#endif
#ifndef LOCAL
emitterWM : mat4x4<f32>,
#endif
#ifdef BOXEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
minEmitBox : vec3<f32>,
maxEmitBox : vec3<f32>,
#endif
#ifdef CONEEMITTER
radius : vec2<f32>,
coneAngle : f32,
height : vec2<f32>,
#ifdef DIRECTEDCONEEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef CYLINDEREMITTER
radius : f32,
height : f32,
radiusRange : f32,
#ifdef DIRECTEDCYLINDEREMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef HEMISPHERICEMITTER
radius : f32,
radiusRange : f32,
directionRandomizer : f32,
#endif
#ifdef POINTEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#endif
#ifdef SPHEREEMITTER
radius : f32,
radiusRange : f32,
#ifdef DIRECTEDSPHEREEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
};@binding(0) @group(0) var<uniform> params : SimParams;@binding(1) @group(0) var<storage,read> particlesIn : Particles;@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;@binding(3) @group(0) var randomTexture : texture_2d<f32>;@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;
#ifdef SIZEGRADIENTS
@binding(0) @group(1) var sizeGradientSampler : sampler;@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
@binding(2) @group(1) var angularSpeedGradientSampler : sampler;@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;
#endif 
#ifdef VELOCITYGRADIENTS
@binding(4) @group(1) var velocityGradientSampler : sampler;@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;
#endif
#ifdef LIMITVELOCITYGRADIENTS
@binding(6) @group(1) var limitVelocityGradientSampler : sampler;@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;
#endif
#ifdef DRAGGRADIENTS
@binding(8) @group(1) var dragGradientSampler : sampler;@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;
#endif
#ifdef NOISE
@binding(10) @group(1) var noiseSampler : sampler;@binding(11) @group(1) var noiseTexture : texture_2d<f32>;
#endif
fn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {return textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;}
fn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {return textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);}
@compute @workgroup_size(64)
fn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {let index : u32=GlobalInvocationID.x;let vertexID : f32=f32(index);if (index>=u32(params.currentCount)) {return;}
let PI : f32=3.14159;let timeDelta : f32=params.timeDelta;let newAge : f32=particlesIn.particles[index].age+timeDelta;let life : f32=particlesIn.particles[index].life;let seed : vec4<f32>=particlesIn.particles[index].seed;let direction : vec3<f32>=particlesIn.particles[index].direction;if (newAge>=life && params.stopFactor != 0.) {var newPosition : vec3<f32>;var newDirection : vec3<f32>;let randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);let outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;particlesOut.particles[index].life=outLife;particlesOut.particles[index].age=newAge-life;particlesOut.particles[index].seed=seed;var sizex : f32;
#ifdef SIZEGRADIENTS 
sizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;
#else
sizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;
#endif
particlesOut.particles[index].size=vec3<f32>(
sizex,
params.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,
params.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);
#ifndef COLORGRADIENTS
particlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
particlesOut.particles[index].angle=vec2<f32>(
params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,
params.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);
#else
particlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;
#endif 
#if defined(POINTEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=vec3<f32>(0.,0.,0.);newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#elif defined(BOXEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;newDirection=params.direction1+(params.direction2-params.direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#elif defined(SPHEREEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);
#else
newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let yPos : f32=(-0.5+randoms2.x)*params.height;var angle : f32=randoms2.y*PI*2.;let inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);let positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));let xPos : f32=positionRadius*cos(angle);let zPos : f32=positionRadius*sin(angle);newPosition=vec3<f32>(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
angle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;newDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let s : f32=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
let h : f32=0.0001;
#else
var h : f32=randoms2.y*params.height.y;h=1.-h*h; 
#endif
var lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;lRadius=lRadius*h;let randX : f32=lRadius*sin(s);let randZ : f32=lRadius*cos(s);let randY : f32=h *params.height.x;newPosition=vec3<f32>(randX,randY,randZ); 
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
#ifdef DIRECTEDCONEEMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
if (abs(cos(params.coneAngle))==1.0) {newDirection=vec3<f32>(0.,1.0,0.);} else {newDirection=normalize(newPosition+params.directionRandomizer*randoms3); }
#endif
#elif defined(CUSTOMEMITTER)
newPosition=particlesIn.particles[index].initialPosition;particlesOut.particles[index].initialPosition=newPosition;
#else 
newPosition=vec3<f32>(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));
#endif
let power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;
#ifdef LOCAL
particlesOut.particles[index].position=newPosition;
#else
particlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=direction;
#endif
#else
#ifdef LOCAL
let initial : vec3<f32>=newDirection;
#else 
let initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;
#endif
particlesOut.particles[index].direction=initial*power;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
particlesOut.particles[index].cellIndex=params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
particlesOut.particles[index].cellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
particlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;
#endif
} else {var directionScale : f32=timeDelta;particlesOut.particles[index].age=newAge;let ageGradient : f32=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;
#endif
#ifdef DRAGGRADIENTS
directionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);
#endif
let position : vec3<f32>=particlesIn.particles[index].position;
#if defined(CUSTOMEMITTER)
particlesOut.particles[index].position=position+(direction-position)*ageGradient; 
particlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;
#else
particlesOut.particles[index].position=position+direction*directionScale;
#endif
particlesOut.particles[index].life=life;particlesOut.particles[index].seed=seed;
#ifndef COLORGRADIENTS 
particlesOut.particles[index].color=particlesIn.particles[index].color;
#endif
#ifdef SIZEGRADIENTS
particlesOut.particles[index].size=vec3<f32>(
textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,
particlesIn.particles[index].size.yz);
#else
particlesOut.particles[index].size=particlesIn.particles[index].size;
#endif 
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#else
var updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
let limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;let currentVelocity : f32=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*params.limitVelocityDamping;}
#endif
particlesOut.particles[index].direction=updatedDirection;
#ifdef NOISE
let noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;let noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;let fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;particlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;particlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
let angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;particlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;
#else
let angle : vec2<f32>=particlesIn.particles[index].angle;particlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
var offsetAge : f32=particlesOut.particles[index].age;let dist : f32=params.cellInfos.y-params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
let cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;particlesOut.particles[index].cellStartOffset=cellStartOffset;offsetAge=offsetAge+cellStartOffset;
#else
let cellStartOffset : f32=0.;
#endif 
var ratio : f32;if (params.cellInfos.w==1.0) {ratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);}
else {ratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);}
particlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));
#endif
}}
`;D.ShadersStoreWGSL[KQ]=ZQ;var ZP=class{constructor(e,t){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=e,this._engine=t}contextLost(){this._updateComputeShader=void 0,this._bufferComputeShader.length=0,this._renderVertexBuffers.length=0}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){return this._updateComputeShader?.isReady()??!1}createUpdateBuffer(e){let t={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(t.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(t.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(t.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(t.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(t.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(t.noiseTexture={group:1,binding:11}),this._updateComputeShader=new XO("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:t,defines:e.split(`
`)}),this._simParamsComputeShader?.dispose(),this._simParamsComputeShader=new _r(this._engine,void 0,void 0,"ComputeShaderParticleSystemUBO"),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new df(this._simParamsComputeShader)}createVertexBuffers(e,t){this._renderVertexBuffers.push(t)}createParticleBuffer(e){let t=new HO(this._engine,e.length*4,11,"ComputeShaderParticleSystemBuffer");return t.update(e),this._bufferComputeShader.push(t),t.getBuffer()}bindDrawBuffers(e,t,i){this._engine.bindBuffers(this._renderVertexBuffers[e],i,t)}preUpdateParticleBuffer(){}updateParticleBuffer(e,t,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[e]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[e^1]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){for(let e=0;e<this._bufferComputeShader.length;++e)this._bufferComputeShader[e].dispose();this._bufferComputeShader.length=0,this._simParamsComputeShader?.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}};P("BABYLON.ComputeShaderParticleSystem",ZP);var ff=class{constructor(e,t,i){this.gradient=e,this.color1=t,this.color2=i}getColorToRef(e){if(!this.color2){e.copyFrom(this.color1);return}oe.LerpToRef(this.color1,this.color2,Math.random(),e)}},DC=class{constructor(e,t){this.gradient=e,this.color=t}},pf=class{constructor(e,t,i){this.gradient=e,this.factor1=t,this.factor2=i}getFactor(){return this.factor2===void 0||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}},Zr=class{static GetCurrentGradient(e,t,i){if(t[0].gradient>e){i(t[0],t[0],1);return}for(let n=0;n<t.length-1;n++){let o=t[n],a=t[n+1];if(e>=o.gradient&&e<=a.gradient){let l=(e-o.gradient)/(a.gradient-o.gradient);i(o,a,l);return}}let r=t.length-1;i(t[r],t[r],1)}};var BV=(()=>{class s{constructor(t){this.particleSystem=t,this.position=p.Zero(),this.direction=p.Zero(),this.color=new oe(0,0,0,0),this.colorStep=new oe(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new j(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new oe(0,0,0,0),this._currentColor2=new oe(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=s._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let t=this.age,i=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),i===0?(i=1,t=this._randomCellOffset):t+=this._randomCellOffset);let r=this._initialEndSpriteCellID-this._initialStartSpriteCellID+1,n;this._initialSpriteCellLoop?n=Ff(t*i%this.lifeTime/this.lifeTime):n=Ff(t*i/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+n*r|0}_inheritParticleInfoToSubEmitter(t){if(t.particleSystem.emitter.position){let i=t.particleSystem.emitter;if(i.position.copyFrom(this.position),t.inheritDirection){let r=O.Vector3[0];this.direction.normalizeToRef(r),i.setDirection(r,0,Math.PI/2)}}else t.particleSystem.emitter.copyFrom(this.position);this.direction.scaleToRef(t.inheritedVelocityAmount/2,O.Vector3[0]),t.particleSystem._inheritedVelocityOffset.copyFrom(O.Vector3[0])}_inheritParticleInfoToSubEmitters(){this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(t=>{this._inheritParticleInfoToSubEmitter(t)})}_reset(){this.age=0,this.id=s._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(t){t.position.copyFrom(this.position),this._initialDirection?t._initialDirection?t._initialDirection.copyFrom(this._initialDirection):t._initialDirection=this._initialDirection.clone():t._initialDirection=null,t.direction.copyFrom(this.direction),this._localPosition&&(t._localPosition?t._localPosition.copyFrom(this._localPosition):t._localPosition=this._localPosition.clone()),t.color.copyFrom(this.color),t.colorStep.copyFrom(this.colorStep),t.lifeTime=this.lifeTime,t.age=this.age,t._randomCellOffset=this._randomCellOffset,t.size=this.size,t.scale.copyFrom(this.scale),t.angle=this.angle,t.angularSpeed=this.angularSpeed,t.particleSystem=this.particleSystem,t.cellIndex=this.cellIndex,t.id=this.id,t._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(t._currentColorGradient=this._currentColorGradient,t._currentColor1.copyFrom(this._currentColor1),t._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(t._currentSizeGradient=this._currentSizeGradient,t._currentSize1=this._currentSize1,t._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(t._currentAngularSpeedGradient=this._currentAngularSpeedGradient,t._currentAngularSpeed1=this._currentAngularSpeed1,t._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(t._currentVelocityGradient=this._currentVelocityGradient,t._currentVelocity1=this._currentVelocity1,t._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(t._currentLimitVelocityGradient=this._currentLimitVelocityGradient,t._currentLimitVelocity1=this._currentLimitVelocity1,t._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(t._currentDragGradient=this._currentDragGradient,t._currentDrag1=this._currentDrag1,t._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this._initialStartSpriteCellID,t._initialEndSpriteCellID=this._initialEndSpriteCellID,t._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(t.remapData&&this.remapData?t.remapData.copyFrom(this.remapData):t.remapData=new De(0,0,0,0)),this._randomNoiseCoordinates1&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),t._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(t._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),t._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}return s._Count=0,s})();var JQ="particlesPixelShader",e7=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec2 vUV;varying vec4 vColor;uniform vec4 textureMask;uniform sampler2D diffuseSampler;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying vec4 remapRanges;uniform sampler2D rampSampler;
#endif
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec4 textureColor=texture2D(diffuseSampler,vUV);vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;
#ifdef RAMPGRADIENT
float alpha=baseColor.a;float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));baseColor.rgb*=rampColor.rgb;float finalAlpha=baseColor.a;baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
float sourceAlpha=vColor.a*textureColor.a;baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);
#endif
#include<logDepthFragment>
#include<fogFragment>(color,baseColor)
#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor.rgb=toLinearSpace(baseColor.rgb);
#else
#ifdef IMAGEPROCESSING
baseColor.rgb=toLinearSpace(baseColor.rgb);baseColor=applyImageProcessing(baseColor);
#endif
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;D.ShadersStore[JQ]=e7;var t7="particlesVertexShader",i7=`attribute vec3 position;attribute vec4 color;attribute float angle;attribute vec2 size;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
#ifndef BILLBOARD
attribute vec3 direction;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
#ifdef RAMPGRADIENT
attribute vec4 remapData;
#endif
attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;
#ifdef ANIMATESHEET
uniform vec3 particlesInfos; 
#endif
varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
#ifdef BILLBOARDSTRETCHED_LOCAL
vec3 row1=direction;
#else
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
#endif
mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 cornerPos;cornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size;
#ifdef BILLBOARD
vec3 rotatedCorner;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=position-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=position-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;vPositionW=(invView*vec4(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
remapRanges=remapData;
#endif
gl_Position=projection*vec4(viewPos,1.0);
#else
vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(direction);vPositionW=rotate(yaxis,rotatedCorner);gl_Position=projection*view*vec4(vPositionW,1.0);
#endif
vColor=color;
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex*particlesInfos.z);float columnOffset=cellIndex-rowOffset/particlesInfos.z;vec2 uvScale=particlesInfos.xy;vec2 uvOffset=vec2(offset.x ,1.0-offset.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=offset;
#endif
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[t7]=i7;var OC=class s extends Wr{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get useRampGradients(){return this._useRampGradients}set useRampGradients(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())}get particles(){return this._particles}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(e=0){return this._customWrappers[e]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new Xt(this._engine),this._customWrappers[t].effect=e,this._customWrappers[t].drawContext&&(this._customWrappers[t].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new U),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(e,t,i,r=null,n=!1,o=.01){super(e),this._emitterInverseWorldMatrix=N.Identity(),this._inheritedVelocityOffset=new p,this.onDisposeObservable=new U,this.onStoppedObservable=new U,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new oe(0,0,0,0),this._colorDiff=new oe(0,0,0,0),this._scaledDirection=p.Zero(),this._scaledGravity=p.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this.updateInAnimate=!0,this._rawTextureWidth=256,this._useRampGradients=!1,this.isLocal=!1,this.isGPU=!1,this._onBeforeDrawParticlesObservable=null,this._emitFromParticle=l=>{},this.recycleParticle=l=>{let c=this._particles.pop();c!==l&&c.copyTo(l),this._stockParticles.push(c)},this._createParticle=()=>{let l;return this._stockParticles.length!==0?(l=this._stockParticles.pop(),l._reset()):l=new BV(this),this._prepareParticle(l),l},this._capacity=t,this._epsilon=o,this._isAnimationSheetEnabled=n,!i||i.getClassName()==="Scene"?(this._scene=i||me.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=i,this.defaultProjectionMatrix=N.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._attachImageProcessingConfiguration(null),this._customWrappers={0:new Xt(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new No;let a=null;this.updateFunction=l=>{let c=null;this.noiseTexture&&(c=this.noiseTexture.getSize(),this.noiseTexture.getContent()?.then(u=>{a=u}));let h=l===this._particles;for(let u=0;u<l.length;u++){let d=l[u],f=this._scaledUpdateSpeed,m=d.age;if(d.age+=f,d.age>d.lifeTime){let x=d.age-m;f=(d.lifeTime-m)*f/x,d.age=d.lifeTime}let g=d.age/d.lifeTime;this._colorGradients&&this._colorGradients.length>0?Zr.GetCurrentGradient(g,this._colorGradients,(x,b,C)=>{x!==d._currentColorGradient&&(d._currentColor1.copyFrom(d._currentColor2),b.getColorToRef(d._currentColor2),d._currentColorGradient=x),oe.LerpToRef(d._currentColor1,d._currentColor2,C,d.color)}):(d.colorStep.scaleToRef(f,this._scaledColorStep),d.color.addInPlace(this._scaledColorStep),d.color.a<0&&(d.color.a=0)),this._angularSpeedGradients&&this._angularSpeedGradients.length>0&&Zr.GetCurrentGradient(g,this._angularSpeedGradients,(x,b,C)=>{x!==d._currentAngularSpeedGradient&&(d._currentAngularSpeed1=d._currentAngularSpeed2,d._currentAngularSpeed2=b.getFactor(),d._currentAngularSpeedGradient=x),d.angularSpeed=rn(d._currentAngularSpeed1,d._currentAngularSpeed2,C)}),d.angle+=d.angularSpeed*f;let _=f;if(this._velocityGradients&&this._velocityGradients.length>0&&Zr.GetCurrentGradient(g,this._velocityGradients,(x,b,C)=>{x!==d._currentVelocityGradient&&(d._currentVelocity1=d._currentVelocity2,d._currentVelocity2=b.getFactor(),d._currentVelocityGradient=x),_*=rn(d._currentVelocity1,d._currentVelocity2,C)}),d.direction.scaleToRef(_,this._scaledDirection),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&Zr.GetCurrentGradient(g,this._limitVelocityGradients,(x,b,C)=>{x!==d._currentLimitVelocityGradient&&(d._currentLimitVelocity1=d._currentLimitVelocity2,d._currentLimitVelocity2=b.getFactor(),d._currentLimitVelocityGradient=x);let R=rn(d._currentLimitVelocity1,d._currentLimitVelocity2,C);d.direction.length()>R&&d.direction.scaleInPlace(this.limitVelocityDamping)}),this._dragGradients&&this._dragGradients.length>0&&Zr.GetCurrentGradient(g,this._dragGradients,(x,b,C)=>{x!==d._currentDragGradient&&(d._currentDrag1=d._currentDrag2,d._currentDrag2=b.getFactor(),d._currentDragGradient=x);let R=rn(d._currentDrag1,d._currentDrag2,C);this._scaledDirection.scaleInPlace(1-R)}),this.isLocal&&d._localPosition?(d._localPosition.addInPlace(this._scaledDirection),p.TransformCoordinatesToRef(d._localPosition,this._emitterWorldMatrix,d.position)):d.position.addInPlace(this._scaledDirection),a&&c&&d._randomNoiseCoordinates1){let x=this._fetchR(d._randomNoiseCoordinates1.x,d._randomNoiseCoordinates1.y,c.width,c.height,a),b=this._fetchR(d._randomNoiseCoordinates1.z,d._randomNoiseCoordinates2.x,c.width,c.height,a),C=this._fetchR(d._randomNoiseCoordinates2.y,d._randomNoiseCoordinates2.z,c.width,c.height,a),R=O.Vector3[0],E=O.Vector3[1];R.copyFromFloats((2*x-1)*this.noiseStrength.x,(2*b-1)*this.noiseStrength.y,(2*C-1)*this.noiseStrength.z),R.scaleToRef(f,E),d.direction.addInPlace(E)}if(this.gravity.scaleToRef(f,this._scaledGravity),d.direction.addInPlace(this._scaledGravity),this._sizeGradients&&this._sizeGradients.length>0&&Zr.GetCurrentGradient(g,this._sizeGradients,(x,b,C)=>{x!==d._currentSizeGradient&&(d._currentSize1=d._currentSize2,d._currentSize2=b.getFactor(),d._currentSizeGradient=x),d.size=rn(d._currentSize1,d._currentSize2,C)}),this._useRampGradients&&(this._colorRemapGradients&&this._colorRemapGradients.length>0&&Zr.GetCurrentGradient(g,this._colorRemapGradients,(x,b,C)=>{let R=rn(x.factor1,b.factor1,C),E=rn(x.factor2,b.factor2,C);d.remapData.x=R,d.remapData.y=E-R}),this._alphaRemapGradients&&this._alphaRemapGradients.length>0&&Zr.GetCurrentGradient(g,this._alphaRemapGradients,(x,b,C)=>{let R=rn(x.factor1,b.factor1,C),E=rn(x.factor2,b.factor2,C);d.remapData.z=R,d.remapData.w=E-R})),this._isAnimationSheetEnabled&&d.updateCellIndex(),d._inheritParticleInfoToSubEmitters(),d.age>=d.lifeTime){this._emitFromParticle(d),d._attachedSubEmitters&&(d._attachedSubEmitters.forEach(x=>{x.particleSystem.disposeOnStop=!0,x.particleSystem.stop()}),d._attachedSubEmitters=null),this.recycleParticle(d),h&&u--;continue}}}}serialize(e){throw new Error("Method not implemented.")}clone(e,t,i=!1){throw new Error("Method not implemented.")}_addFactorGradient(e,t,i,r){let n=new pf(t,i,r);e.push(n),e.sort((o,a)=>o.gradient<a.gradient?-1:o.gradient>a.gradient?1:0)}_removeFactorGradient(e,t){if(!e)return;let i=0;for(let r of e){if(r.gradient===t){e.splice(i,1);break}i++}}addLifeTimeGradient(e,t,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,t,i),this}removeLifeTimeGradient(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this}addSizeGradient(e,t,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t,i),this}removeSizeGradient(e){return this._removeFactorGradient(this._sizeGradients,e),this}addColorRemapGradient(e,t,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,t,i),this}removeColorRemapGradient(e){return this._removeFactorGradient(this._colorRemapGradients,e),this}addAlphaRemapGradient(e,t,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,t,i),this}removeAlphaRemapGradient(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this}addAngularSpeedGradient(e,t,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t,i),this}removeAngularSpeedGradient(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this}addVelocityGradient(e,t,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t,i),this}removeVelocityGradient(e){return this._removeFactorGradient(this._velocityGradients,e),this}addLimitVelocityGradient(e,t,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t,i),this}removeLimitVelocityGradient(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this}addDragGradient(e,t,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t,i),this}removeDragGradient(e){return this._removeFactorGradient(this._dragGradients,e),this}addEmitRateGradient(e,t,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,t,i),this}removeEmitRateGradient(e){return this._removeFactorGradient(this._emitRateGradients,e),this}addStartSizeGradient(e,t,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,t,i),this}removeStartSizeGradient(e){return this._removeFactorGradient(this._startSizeGradients,e),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;let e=new Uint8Array(this._rawTextureWidth*4),t=gt.Color3[0];for(let i=0;i<this._rawTextureWidth;i++){let r=i/this._rawTextureWidth;Zr.GetCurrentGradient(r,this._rampGradients,(n,o,a)=>{X.LerpToRef(n.color,o.color,a,t),e[i*4]=t.r*255,e[i*4+1]=t.g*255,e[i*4+2]=t.b*255,e[i*4+3]=255})}this._rampGradientsTexture=xi.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){this._rampGradients&&(this._rampGradients.sort((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(e,t){this._rampGradients||(this._rampGradients=[]);let i=new DC(e,t);return this._rampGradients.push(i),this._syncRampGradientTexture(),this}removeRampGradient(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(e,t,i){this._colorGradients||(this._colorGradients=[]);let r=new ff(e,t,i);return this._colorGradients.push(r),this._colorGradients.sort((n,o)=>n.gradient<o.gradient?-1:n.gradient>o.gradient?1:0),this}removeColorGradient(e){if(!this._colorGradients)return this;let t=0;for(let i of this._colorGradients){if(i.gradient===e){this._colorGradients.splice(t,1);break}t++}return this}resetDrawCache(){for(let e of this._drawWrappers)if(e)for(let t of e)t?.dispose();this._drawWrappers=[]}_fetchR(e,t,i,r,n){e=Math.abs(e)*.5+.5,t=Math.abs(t)*.5+.5;let o=e*i%i|0,a=t*r%r|0,l=(o+a*i)*4;return n[l]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===8||this.billboardMode===9)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);let e=this._engine,t=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*t),this._vertexBuffer=new gi(e,this._vertexData,!0,t);let i=0,r=this._vertexBuffer.createVertexBuffer(y.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[y.PositionKind]=r,i+=3;let n=this._vertexBuffer.createVertexBuffer(y.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[y.ColorKind]=n,i+=4;let o=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=o,i+=1;let a=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=a,i+=2,this._isAnimationSheetEnabled){let c=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=c,i+=1}if(!this._isBillboardBased||this.billboardMode===8||this.billboardMode===9){let c=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=c,i+=3}if(this._useRampGradients){let c=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=c,i+=4}let l;if(this._useInstancing){let c=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new gi(e,c,!1,2),l=this._spriteBuffer.createVertexBuffer("offset",0,2)}else l=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=l,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]));return}let e=[],t=[],i=0;for(let r=0;r<this._capacity;r++)e.push(i),e.push(i+1),e.push(i+2),e.push(i),e.push(i+2),e.push(i+3),t.push(i,i+1,i+1,i+2,i+2,i+3,i+3,i,i,i+3),i+=4;this._indexBuffer=this._engine.createIndexBuffer(e),this._linesIndexBuffer=this._engine.createIndexBuffer(t)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_preStart(){}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}if(this._started=!0,this._stopped=!1,this._actualFrame=0,this._preStart(),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){this.emitter?.getClassName().indexOf("Mesh")!==-1&&this.emitter.computeWorldMatrix(!0);let t=this.noiseTexture;if(t&&t.onGeneratedObservable)t.onGeneratedObservable.addOnce(()=>{setTimeout(()=>{for(let i=0;i<this.preWarmCycles;i++)this.animate(!0),t.render()})});else for(let i=0;i<this.preWarmCycles;i++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(e=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,this._postStop(e))}_postStop(e){}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(e,t,i,r){let n=e*this._vertexBufferSize;if(this._vertexData[n++]=t.position.x+this.worldOffset.x,this._vertexData[n++]=t.position.y+this.worldOffset.y,this._vertexData[n++]=t.position.z+this.worldOffset.z,this._vertexData[n++]=t.color.r,this._vertexData[n++]=t.color.g,this._vertexData[n++]=t.color.b,this._vertexData[n++]=t.color.a,this._vertexData[n++]=t.angle,this._vertexData[n++]=t.scale.x*t.size,this._vertexData[n++]=t.scale.y*t.size,this._isAnimationSheetEnabled&&(this._vertexData[n++]=t.cellIndex),this._isBillboardBased)(this.billboardMode===8||this.billboardMode===9)&&(this._vertexData[n++]=t.direction.x,this._vertexData[n++]=t.direction.y,this._vertexData[n++]=t.direction.z);else if(t._initialDirection){let o=t._initialDirection;this.isLocal&&(p.TransformNormalToRef(o,this._emitterWorldMatrix,O.Vector3[0]),o=O.Vector3[0]),o.x===0&&o.z===0&&(o.x=.001),this._vertexData[n++]=o.x,this._vertexData[n++]=o.y,this._vertexData[n++]=o.z}else{let o=t.direction;this.isLocal&&(p.TransformNormalToRef(o,this._emitterWorldMatrix,O.Vector3[0]),o=O.Vector3[0]),o.x===0&&o.z===0&&(o.x=.001),this._vertexData[n++]=o.x,this._vertexData[n++]=o.y,this._vertexData[n++]=o.z}this._useRampGradients&&t.remapData&&(this._vertexData[n++]=t.remapData.x,this._vertexData[n++]=t.remapData.y,this._vertexData[n++]=t.remapData.z,this._vertexData[n++]=t.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),r===0?r=this._epsilon:r===1&&(r=1-this._epsilon)),this._vertexData[n++]=i,this._vertexData[n++]=r)}_prepareParticle(e){}_update(e){if(this._alive=this._particles.length>0,this.emitter.position){let i=this.emitter;this._emitterWorldMatrix=i.getWorldMatrix()}else{let i=this.emitter;this._emitterWorldMatrix=N.Translation(i.x,i.y,i.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);let t;for(let i=0;i<e&&this._particles.length!==this._capacity;i++){if(t=this._createParticle(),this._particles.push(t),this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){let n=Ff(this._actualFrame/this.targetStopDuration);Zr.GetCurrentGradient(n,this._lifeTimeGradients,(o,a)=>{let l=o,c=a,h=l.getFactor(),u=c.getFactor(),d=(n-l.gradient)/(c.gradient-l.gradient);t.lifeTime=rn(h,u,d)})}else t.lifeTime=ls(this.minLifeTime,this.maxLifeTime);let r=ls(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction?this.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal):this.particleEmitterType.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal),this.isLocal&&(t._localPosition?t._localPosition.copyFrom(t.position):t._localPosition=t.position.clone(),p.TransformCoordinatesToRef(t._localPosition,this._emitterWorldMatrix,t.position)),this.startDirectionFunction?this.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal):this.particleEmitterType.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal,this._emitterInverseWorldMatrix),r===0?t._initialDirection?t._initialDirection.copyFrom(t.direction):t._initialDirection=t.direction.clone():t._initialDirection=null,t.direction.scaleInPlace(r),!this._sizeGradients||this._sizeGradients.length===0?t.size=ls(this.minSize,this.maxSize):(t._currentSizeGradient=this._sizeGradients[0],t._currentSize1=t._currentSizeGradient.getFactor(),t.size=t._currentSize1,this._sizeGradients.length>1?t._currentSize2=this._sizeGradients[1].getFactor():t._currentSize2=t._currentSize1),t.scale.copyFromFloats(ls(this.minScaleX,this.maxScaleX),ls(this.minScaleY,this.maxScaleY)),this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){let n=this._actualFrame/this.targetStopDuration;Zr.GetCurrentGradient(n,this._startSizeGradients,(o,a,l)=>{o!==this._currentStartSizeGradient&&(this._currentStartSize1=this._currentStartSize2,this._currentStartSize2=a.getFactor(),this._currentStartSizeGradient=o);let c=rn(this._currentStartSize1,this._currentStartSize2,l);t.scale.scaleInPlace(c)})}if(!this._angularSpeedGradients||this._angularSpeedGradients.length===0?t.angularSpeed=ls(this.minAngularSpeed,this.maxAngularSpeed):(t._currentAngularSpeedGradient=this._angularSpeedGradients[0],t.angularSpeed=t._currentAngularSpeedGradient.getFactor(),t._currentAngularSpeed1=t.angularSpeed,this._angularSpeedGradients.length>1?t._currentAngularSpeed2=this._angularSpeedGradients[1].getFactor():t._currentAngularSpeed2=t._currentAngularSpeed1),t.angle=ls(this.minInitialRotation,this.maxInitialRotation),this._velocityGradients&&this._velocityGradients.length>0&&(t._currentVelocityGradient=this._velocityGradients[0],t._currentVelocity1=t._currentVelocityGradient.getFactor(),this._velocityGradients.length>1?t._currentVelocity2=this._velocityGradients[1].getFactor():t._currentVelocity2=t._currentVelocity1),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&(t._currentLimitVelocityGradient=this._limitVelocityGradients[0],t._currentLimitVelocity1=t._currentLimitVelocityGradient.getFactor(),this._limitVelocityGradients.length>1?t._currentLimitVelocity2=this._limitVelocityGradients[1].getFactor():t._currentLimitVelocity2=t._currentLimitVelocity1),this._dragGradients&&this._dragGradients.length>0&&(t._currentDragGradient=this._dragGradients[0],t._currentDrag1=t._currentDragGradient.getFactor(),this._dragGradients.length>1?t._currentDrag2=this._dragGradients[1].getFactor():t._currentDrag2=t._currentDrag1),!this._colorGradients||this._colorGradients.length===0){let n=ls(0,1);oe.LerpToRef(this.color1,this.color2,n,t.color),this.colorDead.subtractToRef(t.color,this._colorDiff),this._colorDiff.scaleToRef(1/t.lifeTime,t.colorStep)}else t._currentColorGradient=this._colorGradients[0],t._currentColorGradient.getColorToRef(t.color),t._currentColor1.copyFrom(t.color),this._colorGradients.length>1?this._colorGradients[1].getColorToRef(t._currentColor2):t._currentColor2.copyFrom(t.color);this._isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this.startSpriteCellID,t._initialEndSpriteCellID=this.endSpriteCellID,t._initialSpriteCellLoop=this.spriteCellLoop),t.direction.addInPlace(this._inheritedVelocityOffset),this._useRampGradients&&(t.remapData=new De(0,1,0,1)),this.noiseTexture&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(t._randomNoiseCoordinates1=new p(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2=new p(Math.random(),Math.random(),Math.random()))),t._inheritParticleInfoToSubEmitters()}}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1){let r=[y.PositionKind,y.ColorKind,"angle","offset","size"];return e&&r.push("cellIndex"),t||r.push("direction"),i&&r.push("remapData"),r}static _GetEffectCreationOptions(e=!1,t=!1,i=!1){let r=["invView","view","projection","textureMask","translationPivot","eyePosition"];return er(r),e&&r.push("particlesInfos"),t&&r.push("logarithmicDepthConstant"),i&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t,i=!0){if(this._scene&&(cs(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&this._scene.fogMode!==0&&e.push("#define FOG")),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),t===Wr.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case 2:e.push("#define BILLBOARDY");break;case 8:case 9:e.push("#define BILLBOARDSTRETCHED"),this.billboardMode===9&&e.push("#define BILLBOARDSTRETCHED_LOCAL");break;case 7:e.push("#define BILLBOARDMODE_ALL");break;default:break}i&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...s._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==8&&this.billboardMode!==9,this._useRampGradients)),e.push(...s._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),i.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(gx(e,this._imageProcessingConfigurationDefines),_x(i,this._imageProcessingConfigurationDefines))}_getWrapper(e){let t=this._getCustomDrawWrapper(e);if(t?.effect)return t;let i=[];this.fillDefines(i,e);let r=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0,n=this._drawWrappers[r];n||(n=this._drawWrappers[r]=[]);let o=n[e];o||(o=new Xt(this._engine),o.drawContext&&(o.drawContext.useInstancing=this._useInstancing),n[e]=o);let a=i.join(`
`);if(o.defines!==a){let l=[],c=[],h=[];this.fillUniformsAttributesAndSamplerNames(c,l,h),o.setEffect(this._engine.createEffect("particles",l,c,h,a),a)}return o}animate(e=!1){if(!this._started)return;if(!e&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1);let t;if(this.manualEmitCount>-1)t=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let i=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){let r=this._actualFrame/this.targetStopDuration;Zr.GetCurrentGradient(r,this._emitRateGradients,(n,o,a)=>{n!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=o.getFactor(),this._currentEmitRateGradient=n),i=rn(this._currentEmitRate1,this._currentEmitRate2,a)})}t=i*this._scaledUpdateSpeed>>0,this._newPartsExcess+=i*this._scaledUpdateSpeed-t}if(this._newPartsExcess>1&&(t+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?t=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(t),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!e){let i=0;for(let r=0;r<this._particles.length;r++){let n=this._particles[r];this._appendParticleVertices(i,n),i+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}_appendParticleVertices(e,t){this._appendParticleVertex(e++,t,0,0),this._useInstancing||(this._appendParticleVertex(e++,t,1,0),this._appendParticleVertex(e++,t,1,1),this._appendParticleVertex(e++,t,0,1))}rebuild(){this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),this._spriteBuffer?._rebuild(),this._createVertexBuffers(),this.resetDrawCache()}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==Wr.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(Wr.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(Wr.BLENDMODE_ADD).effect.isReady())return!1;return!0}_render(e){let t=this._getWrapper(e),i=t.effect,r=this._engine;r.enableEffect(t);let n=this.defaultViewMatrix??this._scene.getViewMatrix();if(i.setTexture("diffuseSampler",this.particleTexture),i.setMatrix("view",n),i.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){let a=this.particleTexture.getBaseSize();i.setFloat3("particlesInfos",this.spriteCellWidth/a.width,this.spriteCellHeight/a.height,this.spriteCellWidth/a.width)}if(i.setVector2("translationPivot",this.translationPivot),i.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){let a=this._scene.activeCamera;i.setVector3("eyePosition",a.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),i.setTexture("rampSampler",this._rampGradientsTexture));let o=i.defines;switch(this._scene&&(Yi(i,this,this._scene),this.applyFog&&Ms(this._scene,void 0,i)),o.indexOf("#define BILLBOARDMODE_ALL")>=0&&(n.invertToRef(O.Matrix[0]),i.setMatrix("invView",O.Matrix[0])),this._vertexArrayObject!==void 0?this._scene?.forceWireframe?r.bindBuffers(this._vertexBuffers,this._linesIndexBufferUseInstancing,i):(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,null,i)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:this._indexBuffer)):this._indexBuffer?r.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBuffer:this._indexBuffer,i):r.bindBuffers(this._vertexBuffers,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null,i),this.useLogarithmicDepth&&this._scene&&Br(o,i,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(i),e){case Wr.BLENDMODE_ADD:r.setAlphaMode(1);break;case Wr.BLENDMODE_ONEONE:r.setAlphaMode(6);break;case Wr.BLENDMODE_STANDARD:r.setAlphaMode(2);break;case Wr.BLENDMODE_MULTIPLY:r.setAlphaMode(4);break}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(i),this._useInstancing?this._scene?.forceWireframe?r.drawElementsType(6,0,10,this._particles.length):r.drawArraysType(7,0,4,this._particles.length):this._scene?.forceWireframe?r.drawElementsType(1,0,this._particles.length*10):r.drawElementsType(0,0,this._particles.length*6),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;let e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));let t=0;return this.blendMode===Wr.BLENDMODE_MULTIPLYADD?t=this._render(Wr.BLENDMODE_MULTIPLY)+this._render(Wr.BLENDMODE_ADD):t=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),t}_onDispose(e=!1,t=!1){}dispose(e=!0,t=!1,i=!1){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._linesIndexBuffer&&(this._engine._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null),this._linesIndexBufferUseInstancing&&(this._engine._releaseBuffer(this._linesIndexBufferUseInstancing),this._linesIndexBufferUseInstancing=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._onDispose(t,i),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){let r=this._scene.particleSystems.indexOf(this);r>-1&&this._scene.particleSystems.splice(r,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()}};var ig=function(s){return s[s.ATTACHED=0]="ATTACHED",s[s.END=1]="END",s}(ig||{}),Ph=class s{constructor(e){if(this.particleSystem=e,this.type=ig.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){let t=Et("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}clone(){let e=this.particleSystem.emitter;if(!e)e=new p;else if(e instanceof p)e=e.clone();else if(e.getClassName().indexOf("Mesh")!==-1){let i=Et("BABYLON.Mesh");e=new i("",e.getScene()),e.isVisible=!1}let t=new s(this.particleSystem.clone(this.particleSystem.name,e));return t.particleSystem.name+="Clone",t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem._disposeEmitterOnDispose=!0,t.particleSystem.disposeOnStop=!0,t}serialize(e=!1){let t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t}static _ParseParticleSystem(e,t,i,r=!1){throw We("ParseParticle")}static Parse(e,t,i){let r=e.particleSystem,n=new s(s._ParseParticleSystem(r,t,i,!0));return n.type=e.type,n.inheritDirection=e.inheritDirection,n.inheritedVelocityAmount=e.inheritedVelocityAmount,n.particleSystem._isSubEmitter=!0,n}dispose(){this.particleSystem.dispose()}};function wC(s,e){let t=new hf;return t.direction1=s,t.direction2=e,t}function NC(s=1,e=1){return new cf(s,e)}function FC(s=1,e=1){return new Rh(s,e)}function LC(s=1,e=new p(0,1,0),t=new p(0,1,0)){return new uf(s,e,t)}function BC(s=1,e=1,t=1,i=0){return new Ih(s,e,t,i)}function VC(s=1,e=1,t=1,i=new p(0,1,0),r=new p(0,1,0)){return new lf(s,e,t,i,r)}function UC(s=1,e=Math.PI/4){return new Ah(s,e)}function kC(s=1,e=Math.PI/4,t=new p(0,1,0),i=new p(0,1,0)){return new af(s,e,t,i)}var yi=(()=>{class s extends OC{constructor(){super(...arguments),this._disposeEmitterOnDispose=!1,this._emitFromParticle=t=>{if(!this._subEmitters||this._subEmitters.length===0)return;let i=Math.floor(Math.random()*this._subEmitters.length);this._subEmitters[i].forEach(r=>{if(r.type===ig.END){let n=r.clone();t._inheritParticleInfoToSubEmitter(n),n.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(n.particleSystem),n.particleSystem.start()}})}}createPointEmitter(t,i){let r=wC(t,i);return this.particleEmitterType=r,r}createHemisphericEmitter(t=1,i=1){let r=NC(t,i);return this.particleEmitterType=r,r}createSphereEmitter(t=1,i=1){let r=FC(t,i);return this.particleEmitterType=r,r}createDirectedSphereEmitter(t=1,i=new p(0,1,0),r=new p(0,1,0)){let n=LC(t,i,r);return this.particleEmitterType=n,n}createCylinderEmitter(t=1,i=1,r=1,n=0){let o=BC(t,i,r,n);return this.particleEmitterType=o,o}createDirectedCylinderEmitter(t=1,i=1,r=1,n=new p(0,1,0),o=new p(0,1,0)){let a=VC(t,i,r,n,o);return this.particleEmitterType=a,a}createConeEmitter(t=1,i=Math.PI/4){let r=UC(t,i);return this.particleEmitterType=r,r}createDirectedConeEmitter(t=1,i=Math.PI/4,r=new p(0,1,0),n=new p(0,1,0)){let o=kC(t,i,r,n);return this.particleEmitterType=o,o}createBoxEmitter(t,i,r,n){let o=new No;return this.particleEmitterType=o,this.direction1=t,this.direction2=i,this.minEmitBox=r,this.maxEmitBox=n,o}_prepareSubEmitterInternalArray(){this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(t=>{t instanceof s?this._subEmitters.push([new Ph(t)]):t instanceof Ph?this._subEmitters.push([t]):t instanceof Array&&this._subEmitters.push(t)})}_stopSubEmitters(){this.activeSubSystems&&(this.activeSubSystems.forEach(t=>{t.stop(!0)}),this.activeSubSystems=[])}_removeFromRoot(){if(!this._rootParticleSystem)return;let t=this._rootParticleSystem.activeSubSystems.indexOf(this);t!==-1&&this._rootParticleSystem.activeSubSystems.splice(t,1),this._rootParticleSystem=null}_preStart(){this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=[])}_postStop(t){t&&this._stopSubEmitters()}_prepareParticle(t){if(this._subEmitters&&this._subEmitters.length>0){let i=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];t._attachedSubEmitters=[],i.forEach(r=>{if(r.type===ig.ATTACHED){let n=r.clone();t._attachedSubEmitters.push(n),n.particleSystem.start()}})}}_onDispose(t=!1,i=!1){if(this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),t&&this.particles?.forEach(r=>{if(r._attachedSubEmitters)for(let n=r._attachedSubEmitters.length-1;n>=0;n-=1)r._attachedSubEmitters[n].dispose()}),i&&this.activeSubSystems)for(let r=this.activeSubSystems.length-1;r>=0;r-=1)this.activeSubSystems[r].dispose();if(this._subEmitters&&this._subEmitters.length){for(let r=0;r<this._subEmitters.length;r++)for(let n of this._subEmitters[r])n.dispose();this._subEmitters=[],this.subEmitters=[]}this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0)}static _Parse(t,i,r,n){let o;r instanceof Se?o=null:o=r;let a=Et("BABYLON.Texture");if(a&&o&&(t.texture?i.particleTexture=a.Parse(t.texture,o,n):t.textureName&&(i.particleTexture=new a(n+t.textureName,o,!1,t.invertY!==void 0?t.invertY:!0),i.particleTexture.name=t.textureName)),!t.emitterId&&t.emitterId!==0&&t.emitter===void 0?i.emitter=p.Zero():t.emitterId&&o?i.emitter=o.getLastMeshById(t.emitterId):i.emitter=p.FromArray(t.emitter),i.isLocal=!!t.isLocal,t.renderingGroupId!==void 0&&(i.renderingGroupId=t.renderingGroupId),t.isBillboardBased!==void 0&&(i.isBillboardBased=t.isBillboardBased),t.billboardMode!==void 0&&(i.billboardMode=t.billboardMode),t.useLogarithmicDepth!==void 0&&(i.useLogarithmicDepth=t.useLogarithmicDepth),t.animations){for(let c=0;c<t.animations.length;c++){let h=t.animations[c],u=Et("BABYLON.Animation");u&&i.animations.push(u.Parse(h))}i.beginAnimationOnStart=t.beginAnimationOnStart,i.beginAnimationFrom=t.beginAnimationFrom,i.beginAnimationTo=t.beginAnimationTo,i.beginAnimationLoop=t.beginAnimationLoop}if(t.autoAnimate&&o&&o.beginAnimation(i,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),i.startDelay=t.startDelay|0,i.minAngularSpeed=t.minAngularSpeed,i.maxAngularSpeed=t.maxAngularSpeed,i.minSize=t.minSize,i.maxSize=t.maxSize,t.minScaleX&&(i.minScaleX=t.minScaleX,i.maxScaleX=t.maxScaleX,i.minScaleY=t.minScaleY,i.maxScaleY=t.maxScaleY),t.preWarmCycles!==void 0&&(i.preWarmCycles=t.preWarmCycles,i.preWarmStepOffset=t.preWarmStepOffset),t.minInitialRotation!==void 0&&(i.minInitialRotation=t.minInitialRotation,i.maxInitialRotation=t.maxInitialRotation),i.minLifeTime=t.minLifeTime,i.maxLifeTime=t.maxLifeTime,i.minEmitPower=t.minEmitPower,i.maxEmitPower=t.maxEmitPower,i.emitRate=t.emitRate,i.gravity=p.FromArray(t.gravity),t.noiseStrength&&(i.noiseStrength=p.FromArray(t.noiseStrength)),i.color1=oe.FromArray(t.color1),i.color2=oe.FromArray(t.color2),i.colorDead=oe.FromArray(t.colorDead),i.updateSpeed=t.updateSpeed,i.targetStopDuration=t.targetStopDuration,i.blendMode=t.blendMode,t.colorGradients)for(let c of t.colorGradients)i.addColorGradient(c.gradient,oe.FromArray(c.color1),c.color2?oe.FromArray(c.color2):void 0);if(t.rampGradients){for(let c of t.rampGradients)i.addRampGradient(c.gradient,X.FromArray(c.color));i.useRampGradients=t.useRampGradients}if(t.colorRemapGradients)for(let c of t.colorRemapGradients)i.addColorRemapGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.alphaRemapGradients)for(let c of t.alphaRemapGradients)i.addAlphaRemapGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.sizeGradients)for(let c of t.sizeGradients)i.addSizeGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.angularSpeedGradients)for(let c of t.angularSpeedGradients)i.addAngularSpeedGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.velocityGradients)for(let c of t.velocityGradients)i.addVelocityGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.dragGradients)for(let c of t.dragGradients)i.addDragGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.emitRateGradients)for(let c of t.emitRateGradients)i.addEmitRateGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.startSizeGradients)for(let c of t.startSizeGradients)i.addStartSizeGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.lifeTimeGradients)for(let c of t.lifeTimeGradients)i.addLifeTimeGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);if(t.limitVelocityGradients){for(let c of t.limitVelocityGradients)i.addLimitVelocityGradient(c.gradient,c.factor1!==void 0?c.factor1:c.factor,c.factor2);i.limitVelocityDamping=t.limitVelocityDamping}if(t.noiseTexture&&o){let c=Et("BABYLON.ProceduralTexture");i.noiseTexture=c.Parse(t.noiseTexture,o,n)}let l;if(t.particleEmitterType){switch(t.particleEmitterType.type){case"SphereParticleEmitter":l=new Rh;break;case"SphereDirectedParticleEmitter":l=new uf;break;case"ConeEmitter":case"ConeParticleEmitter":l=new Ah;break;case"ConeDirectedParticleEmitter":l=new af;break;case"CylinderParticleEmitter":l=new Ih;break;case"CylinderDirectedParticleEmitter":l=new lf;break;case"HemisphericParticleEmitter":l=new cf;break;case"PointParticleEmitter":l=new hf;break;case"MeshParticleEmitter":l=new MC;break;case"CustomParticleEmitter":l=new Fo;break;case"BoxEmitter":case"BoxParticleEmitter":default:l=new No;break}l.parse(t.particleEmitterType,o)}else l=new No,l.parse(t,o);i.particleEmitterType=l,i.startSpriteCellID=t.startSpriteCellID,i.endSpriteCellID=t.endSpriteCellID,i.spriteCellLoop=t.spriteCellLoop??!0,i.spriteCellWidth=t.spriteCellWidth,i.spriteCellHeight=t.spriteCellHeight,i.spriteCellChangeSpeed=t.spriteCellChangeSpeed,i.spriteRandomStartCell=t.spriteRandomStartCell,i.disposeOnStop=t.disposeOnStop??!1,i.manualEmitCount=t.manualEmitCount??-1}static Parse(t,i,r,n=!1,o){let a=t.name,l=null,c=null,h,u;if(i instanceof Se?h=i:(u=i,h=u.getEngine()),t.customShader&&h.createEffectForParticles){c=t.customShader;let f=c.shaderOptions.defines.length>0?c.shaderOptions.defines.join(`
`):"";l=h.createEffectForParticles(c.shaderPath.fragmentElement,c.shaderOptions.uniforms,c.shaderOptions.samplers,f)}let d=new s(a,o||t.capacity,i,l,t.isAnimationSheetEnabled);if(d.customShader=c,d._rootUrl=r,t.id&&(d.id=t.id),t.subEmitters){d.subEmitters=[];for(let f of t.subEmitters){let m=[];for(let g of f)m.push(Ph.Parse(g,i,r));d.subEmitters.push(m)}}return s._Parse(t,d,i,r),t.textureMask&&(d.textureMask=oe.FromArray(t.textureMask)),t.worldOffset&&(d.worldOffset=p.FromArray(t.worldOffset)),t.preventAutoStart&&(d.preventAutoStart=t.preventAutoStart),!n&&!d.preventAutoStart&&d.start(),d}serialize(t=!1){let i={};if(s._Serialize(i,this,t),i.textureMask=this.textureMask.asArray(),i.customShader=this.customShader,i.preventAutoStart=this.preventAutoStart,i.worldOffset=this.worldOffset.asArray(),this.subEmitters){i.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(let r of this._subEmitters){let n=[];for(let o of r)n.push(o.serialize(t));i.subEmitters.push(n)}}return i}static _Serialize(t,i,r){if(t.name=i.name,t.id=i.id,t.capacity=i.getCapacity(),t.disposeOnStop=i.disposeOnStop,t.manualEmitCount=i.manualEmitCount,i.emitter.position){let x=i.emitter;t.emitterId=x.id}else{let x=i.emitter;t.emitter=x.asArray()}i.particleEmitterType&&(t.particleEmitterType=i.particleEmitterType.serialize()),i.particleTexture&&(r?t.texture=i.particleTexture.serialize():(t.textureName=i.particleTexture.name,t.invertY=!!i.particleTexture._invertY)),t.isLocal=i.isLocal,ae.AppendSerializedAnimations(i,t),t.beginAnimationOnStart=i.beginAnimationOnStart,t.beginAnimationFrom=i.beginAnimationFrom,t.beginAnimationTo=i.beginAnimationTo,t.beginAnimationLoop=i.beginAnimationLoop,t.startDelay=i.startDelay,t.renderingGroupId=i.renderingGroupId,t.isBillboardBased=i.isBillboardBased,t.billboardMode=i.billboardMode,t.minAngularSpeed=i.minAngularSpeed,t.maxAngularSpeed=i.maxAngularSpeed,t.minSize=i.minSize,t.maxSize=i.maxSize,t.minScaleX=i.minScaleX,t.maxScaleX=i.maxScaleX,t.minScaleY=i.minScaleY,t.maxScaleY=i.maxScaleY,t.minEmitPower=i.minEmitPower,t.maxEmitPower=i.maxEmitPower,t.minLifeTime=i.minLifeTime,t.maxLifeTime=i.maxLifeTime,t.emitRate=i.emitRate,t.gravity=i.gravity.asArray(),t.noiseStrength=i.noiseStrength.asArray(),t.color1=i.color1.asArray(),t.color2=i.color2.asArray(),t.colorDead=i.colorDead.asArray(),t.updateSpeed=i.updateSpeed,t.targetStopDuration=i.targetStopDuration,t.blendMode=i.blendMode,t.preWarmCycles=i.preWarmCycles,t.preWarmStepOffset=i.preWarmStepOffset,t.minInitialRotation=i.minInitialRotation,t.maxInitialRotation=i.maxInitialRotation,t.startSpriteCellID=i.startSpriteCellID,t.spriteCellLoop=i.spriteCellLoop,t.endSpriteCellID=i.endSpriteCellID,t.spriteCellChangeSpeed=i.spriteCellChangeSpeed,t.spriteCellWidth=i.spriteCellWidth,t.spriteCellHeight=i.spriteCellHeight,t.spriteRandomStartCell=i.spriteRandomStartCell,t.isAnimationSheetEnabled=i.isAnimationSheetEnabled,t.useLogarithmicDepth=i.useLogarithmicDepth;let n=i.getColorGradients();if(n){t.colorGradients=[];for(let x of n){let b={gradient:x.gradient,color1:x.color1.asArray()};x.color2?b.color2=x.color2.asArray():b.color2=x.color1.asArray(),t.colorGradients.push(b)}}let o=i.getRampGradients();if(o){t.rampGradients=[];for(let x of o){let b={gradient:x.gradient,color:x.color.asArray()};t.rampGradients.push(b)}t.useRampGradients=i.useRampGradients}let a=i.getColorRemapGradients();if(a){t.colorRemapGradients=[];for(let x of a){let b={gradient:x.gradient,factor1:x.factor1};x.factor2!==void 0?b.factor2=x.factor2:b.factor2=x.factor1,t.colorRemapGradients.push(b)}}let l=i.getAlphaRemapGradients();if(l){t.alphaRemapGradients=[];for(let x of l){let b={gradient:x.gradient,factor1:x.factor1};x.factor2!==void 0?b.factor2=x.factor2:b.factor2=x.factor1,t.alphaRemapGradients.push(b)}}let c=i.getSizeGradients();if(c){t.sizeGradients=[];for(let x of c){let b={gradient:x.gradient,factor1:x.factor1};x.factor2!==void 0?b.factor2=x.factor2:b.factor2=x.factor1,t.sizeGradients.push(b)}}let h=i.getAngularSpeedGradients();if(h){t.angularSpeedGradients=[];for(let x of h){let b={gradient:x.gradient,factor1:x.factor1};x.factor2!==void 0?b.factor2=x.factor2:b.factor2=x.factor1,t.angularSpeedGradients.push(b)}}let u=i.getVelocityGradients();if(u){t.velocityGradients=[];for(let x of u){let b={gradient:x.gradient,factor1:x.factor1};x.factor2!==void 0?b.factor2=x.factor2:b.factor2=x.factor1,t.velocityGradients.push(b)}}let d=i.getDragGradients();if(d){t.dragGradients=[];for(let x of d){let b={gradient:x.gradient,factor1:x.factor1};x.factor2!==void 0?b.factor2=x.factor2:b.factor2=x.factor1,t.dragGradients.push(b)}}let f=i.getEmitRateGradients();if(f){t.emitRateGradients=[];for(let x of f){let b={gradient:x.gradient,factor1:x.factor1};x.factor2!==void 0?b.factor2=x.factor2:b.factor2=x.factor1,t.emitRateGradients.push(b)}}let m=i.getStartSizeGradients();if(m){t.startSizeGradients=[];for(let x of m){let b={gradient:x.gradient,factor1:x.factor1};x.factor2!==void 0?b.factor2=x.factor2:b.factor2=x.factor1,t.startSizeGradients.push(b)}}let g=i.getLifeTimeGradients();if(g){t.lifeTimeGradients=[];for(let x of g){let b={gradient:x.gradient,factor1:x.factor1};x.factor2!==void 0?b.factor2=x.factor2:b.factor2=x.factor1,t.lifeTimeGradients.push(b)}}let _=i.getLimitVelocityGradients();if(_){t.limitVelocityGradients=[];for(let x of _){let b={gradient:x.gradient,factor1:x.factor1};x.factor2!==void 0?b.factor2=x.factor2:b.factor2=x.factor1,t.limitVelocityGradients.push(b)}t.limitVelocityDamping=i.limitVelocityDamping}i.noiseTexture&&(t.noiseTexture=i.noiseTexture.serialize())}clone(t,i,r=!1){let n=ie({},this._customWrappers),o=null,a=this._engine;if(a.createEffectForParticles&&this.customShader!=null){o=this.customShader;let h=o.shaderOptions.defines.length>0?o.shaderOptions.defines.join(`
`):"",u=a.createEffectForParticles(o.shaderPath.fragmentElement,o.shaderOptions.uniforms,o.shaderOptions.samplers,h);n[0]?n[0].effect=u:this.setCustomEffect(u,0)}let l=this.serialize(r),c=s.Parse(l,this._scene||this._engine,this._rootUrl);return c.name=t,c.customShader=o,c._customWrappers=n,i===void 0&&(i=this.emitter),this.noiseTexture&&(c.noiseTexture=this.noiseTexture.clone()),c.emitter=i,this.preventAutoStart||c.start(),c}}return s.BILLBOARDMODE_Y=2,s.BILLBOARDMODE_ALL=7,s.BILLBOARDMODE_STRETCHED=8,s.BILLBOARDMODE_STRETCHED_LOCAL=9,s})();Ph._ParseParticleSystem=yi.Parse;var r7="clipPlaneFragmentDeclaration2",s7=`#ifdef CLIPPLANE
in float fClipDistance;
#endif
#ifdef CLIPPLANE2
in float fClipDistance2;
#endif
#ifdef CLIPPLANE3
in float fClipDistance3;
#endif
#ifdef CLIPPLANE4
in float fClipDistance4;
#endif
#ifdef CLIPPLANE5
in float fClipDistance5;
#endif
#ifdef CLIPPLANE6
in float fClipDistance6;
#endif
`;D.IncludesShadersStore[r7]=s7;var n7="gpuRenderParticlesPixelShader",o7=`precision highp float;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform sampler2D diffuseSampler;varying vec2 vUV;varying vec4 vColor;
#include<clipPlaneFragmentDeclaration2> 
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#include<fogFragmentDeclaration>
void main() {
#include<clipPlaneFragment> 
vec4 textureColor=texture2D(diffuseSampler,vUV);gl_FragColor=textureColor*vColor;
#ifdef BLENDMULTIPLYMODE
float alpha=vColor.a*textureColor.a;gl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);
#endif 
#include<logDepthFragment>
#include<fogFragment>(color,gl_FragColor)
#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);
#else
#ifdef IMAGEPROCESSING
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);gl_FragColor=applyImageProcessing(gl_FragColor);
#endif
#endif
}
`;D.ShadersStore[n7]=o7;var a7="clipPlaneVertexDeclaration2",l7=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;out float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;out float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;out float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;out float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;out float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;out float fClipDistance6;
#endif
`;D.IncludesShadersStore[a7]=l7;var c7="gpuRenderParticlesVertexShader",h7=`precision highp float;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;uniform vec3 worldOffset;
#ifdef LOCAL
uniform mat4 emitterWM;
#endif
attribute vec3 position;attribute float age;attribute float life;attribute vec3 size;
#ifndef BILLBOARD
attribute vec3 initialDirection;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
attribute float angle;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
attribute vec2 offset;attribute vec2 uv;varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration2>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef COLORGRADIENTS
uniform sampler2D colorGradientSampler;
#else
uniform vec4 colorDead;attribute vec4 color;
#endif
#ifdef ANIMATESHEET
uniform vec3 sheetInfos;
#endif
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#endif
void main() {
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex/sheetInfos.z);float columnOffset=cellIndex-rowOffset*sheetInfos.z;vec2 uvScale=sheetInfos.xy;vec2 uvOffset=vec2(uv.x ,1.0-uv.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=uv;
#endif
float ratio=age/life;
#ifdef COLORGRADIENTS
vColor=texture2D(colorGradientSampler,vec2(ratio,0));
#else
vColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);
#endif
vec2 cornerPos=(offset-translationPivot)*size.yz*size.x;
#ifdef BILLBOARD
vec4 rotatedCorner;rotatedCorner.w=0.;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=(position+worldOffset)-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=(position+worldOffset)-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;
#ifdef LOCAL
vec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;
#else
vec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;
#endif
vPositionW=(invView*viewPosition).xyz;
#endif
#else
vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=0.;rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(initialDirection);vPositionW=rotate(yaxis,rotatedCorner);vec4 viewPosition=view*vec4(vPositionW,1.0);
#endif
gl_Position=projection*viewPosition;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}`;D.ShadersStore[c7]=h7;var Lo=class s extends Wr{static get IsSupported(){if(!me.LastCreatedEngine)return!1;let e=me.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders}_createIndexBuffer(){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]),void 0,"GPUParticleSystemLinesIndexBuffer")}getCapacity(){return this._capacity}get maxActiveParticleCount(){return this._maxActiveParticleCount}set maxActiveParticleCount(e){this._maxActiveParticleCount=Math.min(e,this._capacity)}get activeParticleCount(){return this.maxActiveParticleCount}set activeParticleCount(e){this.maxActiveParticleCount=e}createPointEmitter(e,t){let i=wC(e,t);return this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){let i=NC(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){let i=FC(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new p(0,1,0),i=new p(0,1,0)){let r=LC(e,t,i);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,i=1,r=0){let n=BC(e,t,i,r);return this.particleEmitterType=n,n}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new p(0,1,0),n=new p(0,1,0)){let o=VC(e,t,i,r,n);return this.particleEmitterType=o,o}createConeEmitter(e=1,t=Math.PI/4){let i=UC(e,t);return this.particleEmitterType=i,i}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new p(0,1,0),r=new p(0,1,0)){let n=kC(e,t,i,r);return this.particleEmitterType=n,n}createBoxEmitter(e,t,i,r){let n=new No;return this.particleEmitterType=n,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,n}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady()||this._rebuildingAfterContextLost)return!1;if(this.blendMode!==yi.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(yi.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(yi.BLENDMODE_ADD).effect.isReady())return!1;return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(){this._stopped||(this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(e=0){return this._customWrappers[e]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new Xt(this._engine),this._customWrappers[t].effect=e}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new U),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this._renderVertexBuffers[this._targetIndex^1]}get indexBuffer(){return null}_removeGradientAndTexture(e,t,i){return super._removeGradientAndTexture(e,t,i),this._releaseBuffers(),this}addColorGradient(e,t){this._colorGradients||(this._colorGradients=[]);let i=new ff(e,t);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(e=!1){this._colorGradients&&(e&&this._colorGradients.sort((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){for(let e in this._drawWrappers)this._drawWrappers[e].drawContext?.reset()}_addFactorGradient(e,t,i){let r=new pf(t,i);e.push(r),this._releaseBuffers()}addSizeGradient(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(e,t,i=!1){if(!e)return;i&&e.sort((n,o)=>n.gradient<o.gradient?-1:n.gradient>o.gradient?1:0);let r=this;r[t]&&(r[t].dispose(),r[t]=null)}addAngularSpeedGradient(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(e){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}constructor(e,t,i,r=null,n=!1){if(super(e),this.layerMask=268435455,this._accumulatedCount=0,this._renderVertexBuffers=[],this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this.updateInAnimate=!1,this._actualFrame=0,this._rawTextureWidth=256,this._rebuildingAfterContextLost=!1,this.onDisposeObservable=new U,this.onStoppedObservable=new U,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this.isGPU=!0,this._onBeforeDrawParticlesObservable=null,!i||i.getClassName()==="Scene"?(this._scene=i||me.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=i,this.defaultProjectionMatrix=N.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().supportComputeShaders){if(!Et("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new(Et("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!Et("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new(Et("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new Xt(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers={0:new Xt(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._createIndexBuffer(),this._attachImageProcessingConfiguration(null),t=t??{},t.randomTextureSize||delete t.randomTextureSize;let o=ie({capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize},t),a=t;isFinite(a)&&(o.capacity=a),this._capacity=o.capacity,this._maxActiveParticleCount=o.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=n,this.particleEmitterType=new No;let l=Math.min(this._engine.getCaps().maxTextureSize,o.randomTextureSize),c=[];for(let h=0;h<l;++h)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture=new xi(new Float32Array(c),l,1,5,i,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,c=[];for(let h=0;h<l;++h)c.push(Math.random()),c.push(Math.random()),c.push(Math.random()),c.push(Math.random());this._randomTexture2=new xi(new Float32Array(c),l,1,5,i,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=l}_reset(){this._releaseBuffers()}_createVertexBuffers(e,t,i){let r={};r.position=t.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let n=3;r.age=t.createVertexBuffer("age",n,1,this._attributesStrideSize,!0),n+=1,r.size=t.createVertexBuffer("size",n,3,this._attributesStrideSize,!0),n+=3,r.life=t.createVertexBuffer("life",n,1,this._attributesStrideSize,!0),n+=1,n+=4,this.billboardMode===yi.BILLBOARDMODE_STRETCHED&&(r.direction=t.createVertexBuffer("direction",n,3,this._attributesStrideSize,!0)),n+=3,this._platform.alignDataInBuffer&&(n+=1),this.particleEmitterType instanceof Fo&&(n+=3,this._platform.alignDataInBuffer&&(n+=1)),this._colorGradientsTexture||(r.color=t.createVertexBuffer("color",n,4,this._attributesStrideSize,!0),n+=4),this._isBillboardBased||(r.initialDirection=t.createVertexBuffer("initialDirection",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1)),this.noiseTexture&&(r.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1),r.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",n,3,this._attributesStrideSize,!0),n+=3,this._platform.alignDataInBuffer&&(n+=1)),r.angle=t.createVertexBuffer("angle",n,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?n++:n+=2,this._isAnimationSheetEnabled&&(r.cellIndex=t.createVertexBuffer("cellIndex",n,1,this._attributesStrideSize,!0),n+=1,this.spriteRandomStartCell&&(r.cellStartOffset=t.createVertexBuffer("cellStartOffset",n,1,this._attributesStrideSize,!0),n+=1)),r.offset=i.createVertexBuffer("offset",0,2),r.uv=i.createVertexBuffer("uv",2,2),this._renderVertexBuffers.push(r),this._platform.createVertexBuffers(e,r),this.resetDrawCache()}_initialize(e=!1){if(this._buffer0&&!e)return;let t=this._engine,i=[];this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof Fo&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));let r=this.particleEmitterType instanceof Fo,n=O.Vector3[0],o=0;for(let h=0;h<this._capacity;h++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),r?(this.particleEmitterType.particleDestinationGenerator(h,null,n),i.push(n.x),i.push(n.y),i.push(n.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),o+=16,r&&(this.particleEmitterType.particlePositionGenerator(h,null,n),i.push(n.x),i.push(n.y),i.push(n.z),this._platform.alignDataInBuffer&&i.push(0),o+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),o+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),o+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),o+=8),i.push(0),o+=1,this._angularSpeedGradientsTexture||(i.push(0),o+=1),this._isAnimationSheetEnabled&&(i.push(0),o+=1,this.spriteRandomStartCell&&(i.push(0),o+=1)),this._platform.alignDataInBuffer){let u=3-(o+3&3);for(o+=u;u-- >0;)i.push(0)}let a=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),l=this._platform.createParticleBuffer(i),c=this._platform.createParticleBuffer(i);this._buffer0=new gi(t,l,!1,this._attributesStrideSize),this._buffer1=new gi(t,c,!1,this._attributesStrideSize),this._spriteBuffer=new gi(t,a,!1,4),this._renderVertexBuffers=[],this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture();let e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this._isBillboardBased&&(e+=`
#define BILLBOARD`),this._colorGradientsTexture&&(e+=`
#define COLORGRADIENTS`),this._sizeGradientsTexture&&(e+=`
#define SIZEGRADIENTS`),this._angularSpeedGradientsTexture&&(e+=`
#define ANGULARSPEEDGRADIENTS`),this._velocityGradientsTexture&&(e+=`
#define VELOCITYGRADIENTS`),this._limitVelocityGradientsTexture&&(e+=`
#define LIMITVELOCITYGRADIENTS`),this._dragGradientsTexture&&(e+=`
#define DRAGGRADIENTS`),this.isAnimationSheetEnabled&&(e+=`
#define ANIMATESHEET`,this.spriteRandomStartCell&&(e+=`
#define ANIMATESHEETRANDOMSTART`)),this.noiseTexture&&(e+=`
#define NOISE`),this.isLocal&&(e+=`
#define LOCAL`),this._platform.isUpdateBufferCreated()&&this._cachedUpdateDefines===e?this._platform.isUpdateBufferReady():(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e),this._platform.isUpdateBufferReady())}_getWrapper(e){let t=this._getCustomDrawWrapper(e);if(t?.effect)return t;let i=[];this.fillDefines(i,e);let r=this._drawWrappers[e];r||(r=new Xt(this._engine),r.drawContext&&(r.drawContext.useInstancing=!0),this._drawWrappers[e]=r);let n=i.join(`
`);if(r.defines!==n){let o=[],a=[],l=[];this.fillUniformsAttributesAndSamplerNames(a,o,l),r.setEffect(this._engine.createEffect("gpuRenderParticles",o,a,l,n),n)}return r}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1,r=!1){let n=[y.PositionKind,"age","life","size","angle"];return e||n.push(y.ColorKind),t&&n.push("cellIndex"),i||n.push("initialDirection"),r&&n.push("direction"),n.push("offset",y.UVKind),n}static _GetEffectCreationOptions(e=!1,t=!1,i=!1){let r=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return er(r),e&&r.push("sheetInfos"),t&&r.push("logarithmicDepthConstant"),i&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t=0,i=!0){if(this._scene&&(cs(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&this._scene.fogMode!==Te.FOGMODE_NONE&&e.push("#define FOG")),t===yi.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case yi.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case yi.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case yi.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break;default:break}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),i&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...s._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===yi.BILLBOARDMODE_STRETCHED)),e.push(...s._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),i.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(rt.PrepareUniforms(e,this._imageProcessingConfigurationDefines),rt.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}animate(e=!1){this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this._update()}_createFactorGradientTexture(e,t){let i=this[t];if(!e||!e.length||i)return;let r=new Float32Array(this._rawTextureWidth);for(let n=0;n<this._rawTextureWidth;n++){let o=n/this._rawTextureWidth;Zr.GetCurrentGradient(o,e,(a,l,c)=>{r[n]=xe.Lerp(a.factor1,l.factor1,c)})}this[t]=xi.CreateRTexture(r,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1),this[t].name=t.substring(1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;let e=new Uint8Array(this._rawTextureWidth*4),t=gt.Color4[0];for(let i=0;i<this._rawTextureWidth;i++){let r=i/this._rawTextureWidth;Zr.GetCurrentGradient(r,this._colorGradients,(n,o,a)=>{oe.LerpToRef(n.color1,o.color1,a,t),e[i*4]=t.r*255,e[i*4+1]=t.g*255,e[i*4+2]=t.b*255,e[i*4+3]=t.a*255})}this._colorGradientsTexture=xi.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1),this._colorGradientsTexture.name="colorGradients"}_render(e,t){let i=this._getWrapper(e),r=i.effect;this._engine.enableEffect(i);let n=this._scene?.getViewMatrix()||N.IdentityReadOnly;if(r.setMatrix("view",n),r.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),r.setTexture("diffuseSampler",this.particleTexture),r.setVector2("translationPivot",this.translationPivot),r.setVector3("worldOffset",this.worldOffset),this.isLocal&&r.setMatrix("emitterWM",t),this._colorGradientsTexture?r.setTexture("colorGradientSampler",this._colorGradientsTexture):r.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){let a=this.particleTexture.getBaseSize();r.setFloat3("sheetInfos",this.spriteCellWidth/a.width,this.spriteCellHeight/a.height,a.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){let a=this._scene.activeCamera;r.setVector3("eyePosition",a.globalPosition)}let o=r.defines;if(this._scene&&(Yi(r,this,this._scene),this.applyFog&&Ms(this._scene,void 0,r)),o.indexOf("#define BILLBOARDMODE_ALL")>=0){let a=n.clone();a.invert(),r.setMatrix("invView",a)}switch(this.useLogarithmicDepth&&this._scene&&Br(o,r,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(r),e){case yi.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case yi.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case yi.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case yi.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4);break}return this._platform.bindDrawBuffers(this._targetIndex,r,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(r),this._scene?.forceWireframe?this._engine.drawElementsType(6,0,10,this._currentActiveCount):this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._scene?.forceWireframe&&this._engine.unbindInstanceAttributes(),this._currentActiveCount}_update(e){if(!this.emitter||!this._targetBuffer||!this._recreateUpdateEffect()||this._rebuildingAfterContextLost)return;if(!e)if(this.emitter.position)e=this.emitter.getWorldMatrix();else{let i=this.emitter;e=O.Matrix[0],N.TranslationToRef(i.x,i.y,i.z,e)}this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",e),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount),this._targetIndex++,this._targetIndex===2&&(this._targetIndex=0);let t=this._sourceBuffer;this._sourceBuffer=this._targetBuffer,this._targetBuffer=t}render(e=!1,t=!1){if(!this._started||!this.isReady())return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let o=0;o<this.preWarmCycles;o++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getRenderId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getRenderId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){let o=this._accumulatedCount|0;this._accumulatedCount-=o,this._currentActiveCount+=o}if(this._currentActiveCount=Math.min(this._maxActiveParticleCount,this._currentActiveCount),!this._currentActiveCount)return 0;let i;if(this.emitter.position)i=this.emitter.getWorldMatrix();else{let o=this.emitter;i=O.Matrix[0],N.TranslationToRef(o.x,o.y,o.z,i)}let r=this._engine;this.updateInAnimate||this._update(i);let n=0;return!e&&!t&&(r.setState(!1),this.forceDepthWrite&&r.setDepthWrite(!0),this.blendMode===yi.BLENDMODE_MULTIPLYADD?n=this._render(yi.BLENDMODE_MULTIPLY,i)+this._render(yi.BLENDMODE_ADD,i):n=this._render(this.blendMode,i),this._engine.setAlphaMode(0)),n}rebuild(){let e=()=>{!this._recreateUpdateEffect()||!this._platform.isUpdateBufferReady()?setTimeout(e,10):(this._initialize(!0),this._rebuildingAfterContextLost=!1)};this._createIndexBuffer(),this._cachedUpdateDefines="",this._platform.contextLost(),this._rebuildingAfterContextLost=!0,e()}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(e=!0){for(let t in this._drawWrappers)this._drawWrappers[t].dispose();if(this._drawWrappers={},this._scene){let t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers();for(let t=0;t<this._renderVertexBuffers.length;++t){let i=this._renderVertexBuffers[t];for(let r in i)i[r].dispose()}this._renderVertexBuffers=[],this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(e,t,i=!1){let r=ie({},this._customWrappers),n=null,o=this._engine;if(o.createEffectForParticles&&this.customShader!=null){n=this.customShader;let c=n.shaderOptions.defines.length>0?n.shaderOptions.defines.join(`
`):"";r[0]=o.createEffectForParticles(n.shaderPath.fragmentElement,n.shaderOptions.uniforms,n.shaderOptions.samplers,c,void 0,void 0,void 0,this)}let a=this.serialize(i),l=s.Parse(a,this._scene||this._engine,this._rootUrl);return l.name=e,l.customShader=n,l._customWrappers=r,t===void 0&&(t=this.emitter),this.noiseTexture&&(l.noiseTexture=this.noiseTexture.clone()),l.emitter=t,l}serialize(e=!1){let t={};return yi._Serialize(t,this,e),t.activeParticleCount=this.activeParticleCount,t.randomTextureSize=this._randomTextureSize,t.customShader=this.customShader,t}static Parse(e,t,i,r=!1,n){let o=e.name,a,l;t instanceof Se?a=t:(l=t,a=l.getEngine());let c=new s(o,{capacity:n||e.capacity,randomTextureSize:e.randomTextureSize},t,null,e.isAnimationSheetEnabled);if(c._rootUrl=i,e.customShader&&a.createEffectForParticles){let h=e.customShader,u=h.shaderOptions.defines.length>0?h.shaderOptions.defines.join(`
`):"",d=a.createEffectForParticles(h.shaderPath.fragmentElement,h.shaderOptions.uniforms,h.shaderOptions.samplers,u,void 0,void 0,void 0,c);c.setCustomEffect(d,0),c.customShader=h}return e.id&&(c.id=e.id),e.activeParticleCount&&(c.activeParticleCount=e.activeParticleCount),yi._Parse(e,c,t,i),e.preventAutoStart&&(c.preventAutoStart=e.preventAutoStart),!r&&!c.preventAutoStart&&c.start(),c}};var GC=(()=>{class s{constructor(){this._emitterNodeIsOwned=!0,this.systems=[]}get emitterNode(){return this._emitterNode}set emitterNode(t){this._emitterNodeIsOwned&&this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!1);for(let i of this.systems)i.emitter=t;this._emitterNode=t}setEmitterAsSphere(t,i,r){this._emitterNodeIsOwned&&this._emitterNode&&this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!0,this._emitterCreationOptions={kind:"Sphere",options:t,renderingGroupId:i};let n=pr("emitterSphere",{diameter:t.diameter,segments:t.segments},r);n.renderingGroupId=i;let o=new Ee("emitterSphereMaterial",r);o.emissiveColor=t.color,n.material=o;for(let a of this.systems)a.emitter=n;this._emitterNode=n}start(t){for(let i of this.systems)t&&(i.emitter=t),i.start()}dispose(){for(let t of this.systems)t.dispose();this.systems.length=0,this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNode=null)}serialize(t=!1){let i={};i.systems=[];for(let r of this.systems)i.systems.push(r.serialize(t));return this._emitterNode&&(i.emitter=this._emitterCreationOptions),i}static Parse(t,i,r=!1,n){let o=new s,a=this.BaseAssetsUrl+"/textures/";i=i||me.LastCreatedScene;for(let l of t.systems)o.systems.push(r?Lo.Parse(l,i,a,!0,n):yi.Parse(l,i,a,!0,n));if(t.emitter){let l=t.emitter.options;switch(t.emitter.kind){case"Sphere":o.setEmitterAsSphere({diameter:l.diameter,segments:l.segments,color:X.FromArray(l.color)},t.emitter.renderingGroupId,i);break}}return o}}return s.BaseAssetsUrl="https://assets.babylonjs.com/particles",s})();var mf=class s{static CreateDefault(e,t=500,i,r=!1){let n;return r?n=new Lo("default system",{capacity:t},i):n=new yi("default system",t,i),n.emitter=e,n.particleTexture=new z("https://assets.babylonjs.com/textures/flare.png",n.getScene()),n.createConeEmitter(.1,Math.PI/4),n.color1=new oe(1,1,1,1),n.color2=new oe(1,1,1,1),n.colorDead=new oe(1,1,1,0),n.minSize=.1,n.maxSize=.1,n.minEmitPower=2,n.maxEmitPower=2,n.updateSpeed=1/60,n.emitRate=30,n}static CreateAsync(e,t,i=!1,r){t||(t=me.LastCreatedScene);let n={};return t.addPendingData(n),new Promise((o,a)=>{if(i&&!Lo.IsSupported)return t.removePendingData(n),a("Particle system with GPU is not supported.");H.LoadFile(`${s.BaseAssetsUrl}/systems/${e}.json`,l=>{t.removePendingData(n);let c=JSON.parse(l.toString());return o(GC.Parse(c,t,i,r))},void 0,void 0,void 0,()=>(t.removePendingData(n),a(`An error occurred with the creation of your particle system. Check if your type '${e}' exists.`)))})}static ExportSet(e){let t=new GC;for(let i of e)t.systems.push(i);return t}static ParseFromFileAsync(e,t,i,r=!1,n="",o){return new Promise((a,l)=>{let c=new gr;c.addEventListener("readystatechange",()=>{if(c.readyState==4)if(c.status==200){let h=JSON.parse(c.responseText),u;r?u=Lo.Parse(h,i,n,!1,o):u=yi.Parse(h,i,n,!1,o),e&&(u.name=e),a(u)}else l("Unable to load the particle system")}),c.open("GET",t),c.send()})}static ParseFromSnippetAsync(e,t,i=!1,r="",n){if(e==="_BLANK"){let o=this.CreateDefault(null);return o.start(),Promise.resolve(o)}return new Promise((o,a)=>{let l=new gr;l.addEventListener("readystatechange",()=>{if(l.readyState==4)if(l.status==200){let c=JSON.parse(JSON.parse(l.responseText).jsonPayload),h=JSON.parse(c.particleSystem),u;i?u=Lo.Parse(h,t,r,!1,n):u=yi.Parse(h,t,r,!1,n),u.snippetId=e,o(u)}else a("Unable to load the snippet "+e)}),l.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),l.send()})}};mf.BaseAssetsUrl=GC.BaseAssetsUrl;mf.SnippetUrl="https://snippet.babylonjs.com";mf.CreateFromSnippetAsync=mf.ParseFromSnippetAsync;Jt.AddParser(ye.NAME_PARTICLESYSTEM,(s,e,t,i)=>{let r=Jt.GetIndividualParser(ye.NAME_PARTICLESYSTEM);if(r&&s.particleSystems!==void 0&&s.particleSystems!==null)for(let n=0,o=s.particleSystems.length;n<o;n++){let a=s.particleSystems[n];t.particleSystems.push(r(a,e,i))}});Jt.AddIndividualParser(ye.NAME_PARTICLESYSTEM,(s,e,t)=>s.activeParticleCount?Lo.Parse(s,e,t):yi.Parse(s,e,t));Se.prototype.createEffectForParticles=function(s,e=[],t=[],i="",r,n,o,a,l=pe.GLSL){let c=[],h=[],u=[];return a?a.fillUniformsAttributesAndSamplerNames(h,c,u):(c=yi._GetAttributeNamesOrOptions(),h=yi._GetEffectCreationOptions()),i.indexOf(" BILLBOARD")===-1&&(i+=`
#define BILLBOARD
`),a?.isAnimationSheetEnabled&&i.indexOf(" ANIMATESHEET")===-1&&(i+=`
#define ANIMATESHEET
`),t.indexOf("diffuseSampler")===-1&&t.push("diffuseSampler"),this.createEffect({vertex:a?.vertexShaderName??"particles",fragmentElement:s},c,h.concat(e),u.concat(t),i,r,n,o,void 0,l)};k.prototype.getEmittedParticleSystems=function(){let s=[];for(let e=0;e<this.getScene().particleSystems.length;e++){let t=this.getScene().particleSystems[e];t.emitter===this&&s.push(t)}return s};k.prototype.getHierarchyEmittedParticleSystems=function(){let s=[],e=this.getDescendants();e.push(this);for(let t=0;t<this.getScene().particleSystems.length;t++){let i=this.getScene().particleSystems[t],r=i.emitter;r.position&&e.indexOf(r)!==-1&&s.push(i)}return s};Object.defineProperty(lt.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(s){this._physicsImpostor!==s&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=s,s&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)})))},enumerable:!0,configurable:!0});lt.prototype.getPhysicsImpostor=function(){return this.physicsImpostor};lt.prototype.applyImpulse=function(s,e){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(s,e),this):this};lt.prototype.setPhysicsLinkWith=function(s,e,t,i){return!this.physicsImpostor||!s.physicsImpostor?this:(this.physicsImpostor.createJoint(s.physicsImpostor,zt.HingeJoint,{mainPivot:e,connectedPivot:t,nativeParams:i}),this)};var rg=class s{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw We("")}constructor(e,t=s.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new p(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}setVelocityLimits(e,t){this._physicsPlugin.setVelocityLimits(e,t)}getMaxLinearVelocity(){return this._physicsPlugin.getMaxLinearVelocity()}getMaxAngularVelocity(){return this._physicsPlugin.getMaxAngularVelocity()}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){let t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i,r){this._physicsPlugin.raycast(e,t,i,r)}raycast(e,t,i){let r=new ba;return this._physicsPlugin.raycast(e,t,r,i),r}};var Mh=function(s){return s[s.STATIC=0]="STATIC",s[s.ANIMATED=1]="ANIMATED",s[s.DYNAMIC=2]="DYNAMIC",s}(Mh||{});Te.prototype.getPhysicsEngine=function(){return this._physicsEngine};Te.prototype.enablePhysics=function(s=null,e){if(this._physicsEngine)return!0;let t=this._getComponent(ye.NAME_PHYSICSENGINE);t||(t=new eM(this),this._addComponent(t));try{if(!e||e?.getPluginVersion()===1)this._physicsEngine=new Xd(s,e);else if(e?.getPluginVersion()===2)this._physicsEngine=new rg(s,e);else throw new Error("Unsupported Physics plugin version.");return this._physicsTimeAccumulator=0,!0}catch(i){return F.Error(i.message),!1}};Te.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)};Te.prototype.isPhysicsEnabled=function(){return this._physicsEngine!==void 0};Te.prototype.deleteCompoundImpostor=function(s){let e=s.parts[0].mesh;e.physicsImpostor&&(e.physicsImpostor.dispose(),e.physicsImpostor=null)};Te.prototype._advancePhysicsEngineStep=function(s){if(this._physicsEngine){let e=this._physicsEngine.getSubTimeStep();if(e>0)for(this._physicsTimeAccumulator+=s;this._physicsTimeAccumulator>e;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=e;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(s/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};var eM=class{constructor(e){this.name=ye.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new U,this.scene.onAfterPhysicsObservable=new U,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?this.scene._physicsEngine.getTimeStep()*1e3:1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}};Object.defineProperty(Ze.prototype,"physicsBody",{get:function(){return this._physicsBody},set:function(s){this._physicsBody!==s&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsBody=s,s&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsBody&&(this.physicsBody.dispose(),this.physicsBody=null)})))},enumerable:!0,configurable:!0});Ze.prototype.getPhysicsBody=function(){return this.physicsBody};Ze.prototype.applyImpulse=function(s,e){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyImpulse(s,e),this};Ze.prototype.applyAngularImpulse=function(s){if(!this.physicsBody)throw new Error("No Physics Body for TransformNode");return this.physicsBody.applyAngularImpulse(s),this};var Dh=class{static GetContactPointToRef(e,t,i,r,n){let a=e.getScene().getPhysicsEngine()?.getPluginVersion();if(a===1){let c=new pt(t,i).intersectsMesh(e);if(c.hit&&c.pickedPoint)return r.copyFrom(c.pickedPoint),!0}else if(a===2)return e.physicsBody.getObjectCenterWorldToRef(r,n),!0;return!1}static HasAppliedForces(e,t){return e.getMotionType(t)===Mh.STATIC||(e.getMassProperties(t)?.mass??0)===0||e.transformNode?.getTotalVertices()===0}static IsInsideCylinder(e,t,i,r){let n=O.Vector3[0];return e.subtractToRef(t,n),Math.abs(n.x)<=i&&Math.abs(n.z)<=i&&n.y>=0&&n.y<=r}};var tM=class s{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=p.Zero(),this._originDirection=p.Zero(),this._cylinderPosition=p.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options=ie(ie({},new iM),this._options),this._origin.addToRef(new p(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new p(0,this._options.height,0),this._originTop),this._options.updraftMode===WC.Perpendicular&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=()=>this._tick(),this._physicsEngine.getPluginVersion()===1&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?(this._cylinder.dispose(),this._cylinder=void 0):setTimeout(()=>{!this._dataFetched&&this._cylinder&&(this._cylinder.dispose(),this._cylinder=void 0)},0))}_getHitData(e,t){let i;this._options.updraftMode===WC.Perpendicular?i=this._originDirection:i=e.subtract(this._originTop);let r=p.Distance(this._origin,e),n=this._options.strength*-1,o=i.multiplyByFloats(n,n,n);t.force.copyFrom(o),t.contactPoint.copyFrom(e),t.distanceFromOrigin=r}_getBodyHitData(e,t,i){if(Dh.HasAppliedForces(e))return!1;let r=e.getObjectCenterWorld(i);return Dh.IsInsideCylinder(r,this._origin,this._options.radius,this._options.height)?(t.instanceIndex=i,this._getHitData(r,t),!0):!1}_getImpostorHitData(e,t){if(e.mass===0)return!1;let i=e.object;if(!this._intersectsWithCylinder(i))return!1;let r=e.getObjectCenter();return this._getHitData(r,t),!0}_tick(){let e=s._HitData;this._physicsEngine.getPluginVersion()===1?this._physicsEngine.getImpostors().forEach(t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)}):this._physicsEngine.getBodies().forEach(t=>{t.iterateOverAllInstances((i,r)=>{this._getBodyHitData(i,e,r)&&i.applyForce(e.force,e.contactPoint,e.instanceIndex)})})}_prepareCylinder(){this._cylinder||(this._cylinder=qs("updraftEventCylinder",{height:this._options.height,diameter:this._options.radius*2},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return this._cylinder?(this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)):!1}};tM._HitData={force:new p,contactPoint:new p,distanceFromOrigin:0};var zC=class s{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=p.Zero(),this._cylinderPosition=p.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options=ie(ie({},new rM),this._options),this._origin.addToRef(new p(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new p(0,this._options.height,0),this._originTop),this._tickCallback=()=>this._tick(),this._physicsEngine.getPluginVersion()===1&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?this._cylinder.dispose():setTimeout(()=>{this._dataFetched||this._cylinder.dispose()},0))}_getHitData(e,t,i){let r=s._OriginOnPlane;r.set(this._origin.x,t.y,this._origin.z);let n=O.Vector3[0];t.subtractToRef(r,n);let o=O.Vector3[1];if(!Dh.GetContactPointToRef(e,r,n,o,i.instanceIndex))return!1;let c=p.Distance(o,r)/this._options.radius,h=O.Vector3[2];o.normalizeToRef(h),c>this._options.centripetalForceThreshold&&h.negateInPlace();let u,d,f;if(c>this._options.centripetalForceThreshold)u=h.x*this._options.centripetalForceMultiplier,d=h.y*this._options.updraftForceMultiplier,f=h.z*this._options.centripetalForceMultiplier;else{let g=p.Cross(r,t).normalize();u=(g.x+h.x)*this._options.centrifugalForceMultiplier,d=this._originTop.y*this._options.updraftForceMultiplier,f=(g.z+h.z)*this._options.centrifugalForceMultiplier}let m=O.Vector3[3];return m.set(u,d,f),m.scaleInPlace(this._options.strength),i.force.copyFrom(m),i.contactPoint.copyFrom(t),i.distanceFromOrigin=c,!0}_getBodyHitData(e,t,i){if(Dh.HasAppliedForces(e,i))return!1;let r=e.transformNode,n=e.getObjectCenterWorld(i);return Dh.IsInsideCylinder(n,this._origin,this._options.radius,this._options.height)?(t.instanceIndex=i,this._getHitData(r,n,t)):!1}_getImpostorHitData(e,t){if(e.mass===0||e.object.getClassName()!=="Mesh"&&e.object.getClassName()!=="InstancedMesh")return!1;let i=e.object;if(!this._intersectsWithCylinder(i))return!1;let r=e.getObjectCenter();return this._getHitData(i,r,t),!0}_tick(){let e=s._HitData;this._physicsEngine.getPluginVersion()===1?this._physicsEngine.getImpostors().forEach(t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)}):this._physicsEngine.getBodies().forEach(t=>{t.iterateOverAllInstances((i,r)=>{this._getBodyHitData(i,e,r)&&i.applyForce(e.force,e.contactPoint,e.instanceIndex)})})}_prepareCylinder(){this._cylinder||(this._cylinder=qs("vortexEventCylinder",{height:this._options.height,diameter:this._options.radius*2},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)}};zC._OriginOnPlane=p.Zero();zC._HitData={force:new p,contactPoint:new p,distanceFromOrigin:0};var iM=class{constructor(){this.radius=5,this.strength=10,this.height=10,this.updraftMode=WC.Center}},rM=class{constructor(){this.radius=5,this.strength=10,this.height=10,this.centripetalForceThreshold=.7,this.centripetalForceMultiplier=5,this.centrifugalForceMultiplier=.5,this.updraftForceMultiplier=.02}};var WC=function(s){return s[s.Center=0]="Center",s[s.Perpendicular=1]="Perpendicular",s}(WC||{});var f7="blackAndWhitePixelShader",p7=`varying vec2 vUV;uniform sampler2D textureSampler;uniform float degree;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec3 color=texture2D(textureSampler,vUV).rgb;float luminance=dot(color,vec3(0.3,0.59,0.11)); 
vec3 blackAndWhite=vec3(luminance,luminance,luminance);gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);}`;D.ShadersStore[f7]=p7;var HC=class s extends ve{getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,i,r,n,o){super(e,"blackAndWhite",["degree"],null,t,i,r,n,o),this.degree=1,this.onApplyObservable.add(a=>{a.setFloat("degree",this.degree)})}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}};v([I()],HC.prototype,"degree",void 0);P("BABYLON.BlackAndWhitePostProcess",HC);var ot=class{constructor(e,t,i,r){this._name=t,this._singleInstance=r||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(let e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){let t=this._postProcesses[e];for(let i=0;i<t.length;i++)if(!t[i].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t,i=H.MakeArray(e||this._cameras);if(i)for(let r=0;r<i.length;r++){let n=i[r];if(!n)continue;let o=n.name;if(this._singleInstance?t=0:t=o,!this._postProcesses[t]){let a=this._getPostProcesses();a&&(this._postProcesses[t]=Array.isArray(a)?a:[a])}this._indicesForCamera[o]||(this._indicesForCamera[o]=[]),this._postProcesses[t].forEach(a=>{let l=n.attachPostProcess(a);this._indicesForCamera[o].push(l)}),this._cameras[o]||(this._cameras[o]=n)}}_detachCameras(e){let t=H.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){let r=t[i],n=r.name,o=this._postProcesses[this._singleInstance?0:n];o&&o.forEach(a=>{r.detachPostProcess(a)}),this._cameras[n]&&(this._cameras[n]=null),delete this._indicesForCamera[n]}}_enable(e){let t=H.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){let r=t[i],n=r.name,o=this._singleInstance?0:n;for(let a=0;a<this._indicesForCamera[n].length;a++){let l=this._indicesForCamera[n][a],c=r._postProcesses[l];c==null&&t[i].attachPostProcess(this._postProcesses[o][a],l)}}}_disable(e){let t=H.MakeArray(e||this._cameras);if(t)for(let i=0;i<t.length;i++){let r=t[i],n=r.name;this._postProcesses[this._singleInstance?0:n].forEach(o=>{r.detachPostProcess(o)})}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}};var m7="extractHighlightsPixelShader",g7=`#include<helperFunctions>
varying vec2 vUV;uniform sampler2D textureSampler;uniform float threshold;uniform float exposure;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=texture2D(textureSampler,vUV);float luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;}`;D.ShadersStore[m7]=g7;var gf=class extends ve{getClassName(){return"ExtractHighlightsPostProcess"}constructor(e,t,i,r,n,o,a=0,l=!1){super(e,"extractHighlights",["threshold","exposure"],null,t,i,r,n,o,null,a,void 0,null,l),this.threshold=.9,this._exposure=1,this._inputPostProcess=null,this.onApplyObservable.add(c=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&c.setTextureFromPostProcess("textureSampler",this._inputPostProcess),c.setFloat("threshold",Math.pow(this.threshold,pu)),c.setFloat("exposure",this._exposure)})}};v([I()],gf.prototype,"threshold",void 0);P("BABYLON.ExtractHighlightsPostProcess",gf);var _7="bloomMergePixelShader",x7=`uniform sampler2D textureSampler;uniform sampler2D bloomBlur;varying vec2 vUV;uniform float bloomWeight;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(textureSampler,vUV);vec3 blurred=texture2D(bloomBlur,vUV).rgb;gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); }
`;D.ShadersStore[_7]=x7;var _f=class extends ve{getClassName(){return"BloomMergePostProcess"}constructor(e,t,i,r,n,o,a,l,c,h=0,u=!1){super(e,"bloomMerge",["bloomWeight"],["bloomBlur"],n,o,a,l,c,null,h,void 0,null,!0),this.weight=1,this.weight=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(d=>{d.setTextureFromPostProcess("textureSampler",t),d.setTextureFromPostProcessOutput("bloomBlur",i),d.setFloat("bloomWeight",this.weight)}),u||this.updateEffect()}};v([I()],_f.prototype,"weight",void 0);P("BABYLON.BloomMergePostProcess",_f);var sg=class extends ot{get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this._bloomScale}set kernel(e){this._blurX.kernel=e*this._bloomScale,this._blurY.kernel=e*this._bloomScale}constructor(e,t,i,r,n=0,o=!1){super(e.getEngine(),"bloom",()=>this._effects,!0),this._bloomScale=t,this._effects=[],this._downscale=new gf("highlights",1,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,o),this._blurX=new Ci("horizontal blur",new j(1,0),10,t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,void 0,o),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new Ci("vertical blur",new j(0,1),10,t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,void 0,o),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=r,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new _f("bloomMerge",this._downscale,this._blurY,i,t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,n,o),this._merge.autoClear=!1,this._effects.push(this._merge)}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}};var v7="chromaticAberrationPixelShader",T7=`uniform sampler2D textureSampler; 
uniform float chromatic_aberration;uniform float radialIntensity;uniform vec2 direction;uniform vec2 centerPosition;uniform float screen_width;uniform float screen_height;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);vec2 directionOfEffect=direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}
float radius2=centered_screen_pos.x*centered_screen_pos.x
+ centered_screen_pos.y*centered_screen_pos.y;float radius=sqrt(radius2);vec4 original=texture2D(textureSampler,vUV);vec3 ref_indices=vec3(-0.3,0.0,0.3);float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);original.r=texture2D(textureSampler,ref_coords_r).r;original.g=texture2D(textureSampler,ref_coords_g).g;original.b=texture2D(textureSampler,ref_coords_b).b;original.a=clamp(texture2D(textureSampler,ref_coords_r).a+texture2D(textureSampler,ref_coords_g).a+texture2D(textureSampler,ref_coords_b).a,0.,1.);gl_FragColor=original;}`;D.ShadersStore[v7]=T7;var Bo=class s extends ve{getClassName(){return"ChromaticAberrationPostProcess"}constructor(e,t,i,r,n,o,a,l,c=0,h=!1){super(e,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],r,n,o,a,l,null,c,void 0,null,h),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new j(.707,.707),this.centerPosition=new j(.5,.5),this.screenWidth=t,this.screenHeight=i,this.onApplyObservable.add(u=>{u.setFloat("chromatic_aberration",this.aberrationAmount),u.setFloat("screen_width",t),u.setFloat("screen_height",i),u.setFloat("radialIntensity",this.radialIntensity),u.setFloat2("direction",this.direction.x,this.direction.y),u.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)})}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,r)}};v([I()],Bo.prototype,"aberrationAmount",void 0);v([I()],Bo.prototype,"radialIntensity",void 0);v([I()],Bo.prototype,"direction",void 0);v([I()],Bo.prototype,"centerPosition",void 0);v([I()],Bo.prototype,"screenWidth",void 0);v([I()],Bo.prototype,"screenHeight",void 0);P("BABYLON.ChromaticAberrationPostProcess",Bo);var C7="circleOfConfusionPixelShader",b7=`uniform sampler2D depthSampler;varying vec2 vUV;uniform vec2 cameraMinMaxZ;uniform float focusDistance;uniform float cocPrecalculation;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float depth=texture2D(depthSampler,vUV).r;
#define CUSTOM_COC_DEPTH
float pixelDistance=(cameraMinMaxZ.x+cameraMinMaxZ.y*depth)*1000.0; 
#define CUSTOM_COC_PIXELDISTANCE
float coc=abs(cocPrecalculation*((focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);gl_FragColor=vec4(coc,coc,coc,1.0);}
`;D.ShadersStore[C7]=b7;var pl=class extends ve{getClassName(){return"CircleOfConfusionPostProcess"}constructor(e,t,i,r,n,o,a,l=0,c=!1){super(e,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],i,r,n,o,a,null,l,void 0,null,c),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50,this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add(h=>{if(!this._depthTexture){F.Warn("No depth texture set on CircleOfConfusionPostProcess");return}h.setTexture("depthSampler",this._depthTexture);let d=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);h.setFloat("focusDistance",this.focusDistance),h.setFloat("cocPrecalculation",d);let f=this._depthTexture.activeCamera;h.setFloat2("cameraMinMaxZ",f.minZ,f.maxZ-f.minZ)})}set depthTexture(e){this._depthTexture=e}};v([I()],pl.prototype,"lensSize",void 0);v([I()],pl.prototype,"fStop",void 0);v([I()],pl.prototype,"focusDistance",void 0);v([I()],pl.prototype,"focalLength",void 0);P("BABYLON.CircleOfConfusionPostProcess",pl);var S7="colorCorrectionPixelShader",y7=`uniform sampler2D textureSampler; 
uniform sampler2D colorTable; 
varying vec2 vUV;const float SLICE_COUNT=16.0; 
vec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {float sliceSize=1.0/width; 
float slicePixelSize=sliceSize/width; 
float sliceInnerSize=slicePixelSize*(width-1.0); 
float zSlice0=min(floor(uv.z*width),width-1.0);float zSlice1=min(zSlice0+1.0,width-1.0);float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;float s0=xOffset+(zSlice0*sliceSize);float s1=xOffset+(zSlice1*sliceSize);vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));float zOffset=mod(uv.z*width,1.0);vec4 result=mix(slice0Color,slice1Color,zOffset);return result;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 screen_color=texture2D(textureSampler,vUV);gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);}`;D.ShadersStore[S7]=y7;var XC=class s extends ve{getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,i,r,n,o,a){super(e,"colorCorrection",null,["colorTable"],i,r,n,o,a);let l=r?.getScene()||null;this._colorTableTexture=new z(t,l,!0,!1,z.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=z.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=z.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=c=>{c.setTexture("colorTable",this._colorTableTexture)}}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}};v([I()],XC.prototype,"colorTableUrl",void 0);P("BABYLON.ColorCorrectionPostProcess",XC);var E7="convolutionPixelShader",A7=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform float kernel[9];
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 colorSum =
texture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +
texture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +
texture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +
texture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +
texture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +
texture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +
texture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];float kernelWeight =
kernel[0] +
kernel[1] +
kernel[2] +
kernel[3] +
kernel[4] +
kernel[5] +
kernel[6] +
kernel[7] +
kernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}
gl_FragColor=vec4((colorSum/kernelWeight).rgb,1);}`;D.ShadersStore[E7]=A7;var Aa=class s extends ve{getClassName(){return"ConvolutionPostProcess"}constructor(e,t,i,r,n,o,a,l=0){super(e,"convolution",["kernel","screenSize"],null,i,r,n,o,a,null,l),this.kernel=t,this.onApply=c=>{c.setFloat2("screenSize",this.width,this.height),c.setArray("kernel",this.kernel)}}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType),e,i,r)}};Aa.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1];Aa.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0];Aa.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1];Aa.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0];Aa.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2];Aa.GaussianKernel=[0,1,0,1,1,1,0,1,0];v([I()],Aa.prototype,"kernel",void 0);P("BABYLON.ConvolutionPostProcess",Aa);var Oh=class extends Ci{getClassName(){return"DepthOfFieldBlurPostProcess"}constructor(e,t,i,r,n,o,a,l=null,c=z.BILINEAR_SAMPLINGMODE,h,u,d=0,f=!1,m=5){super(e,i,r,n,o,c=2,h,u,d,`#define DOF 1
`,f,m),this.direction=i,this.externalTextureSamplerBinding=!!l,this.onApplyObservable.add(g=>{l!=null&&g.setTextureFromPostProcess("textureSampler",l),g.setTextureFromPostProcessOutput("circleOfConfusionSampler",a)})}};v([I()],Oh.prototype,"direction",void 0);P("BABYLON.DepthOfFieldBlurPostProcess",Oh);var I7="depthOfFieldMergePixelShader",R7=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)
#else
#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)
#endif
uniform sampler2D textureSampler;varying vec2 vUV;uniform sampler2D circleOfConfusionSampler;uniform sampler2D blurStep0;
#if BLUR_LEVEL>0
uniform sampler2D blurStep1;
#endif
#if BLUR_LEVEL>1
uniform sampler2D blurStep2;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float coc=TEXTUREFUNC(circleOfConfusionSampler,vUV,0.0).r;
#if BLUR_LEVEL==0
vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);gl_FragColor=mix(original,blurred0,coc);
#endif
#if BLUR_LEVEL==1
if(coc<0.5){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(original,blurred1,coc/0.5);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);}
#endif
#if BLUR_LEVEL==2
if(coc<0.33){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(original,blurred2,coc/0.33);}else if(coc<0.66){vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);}
#endif
}
`;D.ShadersStore[I7]=R7;var YC=class extends ve{getClassName(){return"DepthOfFieldMergePostProcess"}constructor(e,t,i,r,n,o,a,l,c,h=0,u=!1){super(e,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],n,o,a,l,c,null,h,void 0,null,!0),this._blurSteps=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(d=>{d.setTextureFromPostProcess("textureSampler",t),d.setTextureFromPostProcessOutput("circleOfConfusionSampler",i),r.forEach((f,m)=>{d.setTextureFromPostProcessOutput("blurStep"+(r.length-m-1),f)})}),u||this.updateEffect()}updateEffect(e=null,t=null,i=null,r,n,o){e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+`
`),super.updateEffect(e,t,i,r,n,o)}};var xf=function(s){return s[s.Low=0]="Low",s[s.Medium=1]="Medium",s[s.High=2]="High",s}(xf||{}),ng=class extends ot{set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}constructor(e,t,i=xf.Low,r=0,n=!1){super(e.getEngine(),"depth of field",()=>this._effects,!0),this._effects=[];let o=e.getEngine(),a=o.isWebGPU||o.version>1?6:5;this._circleOfConfusion=new pl("circleOfConfusion",t,1,null,z.BILINEAR_SAMPLINGMODE,o,!1,r,n),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];let l=1,c=15;switch(i){case xf.High:{l=3,c=51;break}case xf.Medium:{l=2,c=31;break}default:{c=15,l=1;break}}let h=c/Math.pow(2,l-1),u=1;for(let d=0;d<l;d++){let f=new Oh("vertical blur",e,new j(0,1),h,u,null,this._circleOfConfusion,d==0?this._circleOfConfusion:null,z.BILINEAR_SAMPLINGMODE,o,!1,r,n,d==0?a:5);f.autoClear=!1,u=.75/Math.pow(2,d);let m=new Oh("horizontal blur",e,new j(1,0),h,u,null,this._circleOfConfusion,null,z.BILINEAR_SAMPLINGMODE,o,!1,r,n);m.autoClear=!1,this._depthOfFieldBlurY.push(f),this._depthOfFieldBlurX.push(m)}this._effects=[this._circleOfConfusion];for(let d=0;d<this._depthOfFieldBlurX.length;d++)this._effects.push(this._depthOfFieldBlurY[d]),this._effects.push(this._depthOfFieldBlurX[d]);this._dofMerge=new YC("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,u,null,z.BILINEAR_SAMPLINGMODE,o,!1,r,n),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}};var P7="displayPassPixelShader",M7=`varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D passSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(passSampler,vUV);}`;D.ShadersStore[P7]=M7;var sM=class s extends ve{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,r,n,o){super(e,"displayPass",["passSampler"],["passSampler"],t,i,r,n,o)}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}};P("BABYLON.DisplayPassPostProcess",sM);var D7="filterPixelShader",O7=`varying vec2 vUV;uniform sampler2D textureSampler;uniform mat4 kernelMatrix;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec3 baseColor=texture2D(textureSampler,vUV).rgb;vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;gl_FragColor=vec4(updatedColor,1.0);}`;D.ShadersStore[D7]=O7;var $C=class s extends ve{getClassName(){return"FilterPostProcess"}constructor(e,t,i,r,n,o,a){super(e,"filter",["kernelMatrix"],null,i,r,n,o,a),this.kernelMatrix=t,this.onApply=l=>{l.setMatrix("kernelMatrix",this.kernelMatrix)}}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}};v([Lf()],$C.prototype,"kernelMatrix",void 0);P("BABYLON.FilterPostProcess",$C);var w7="fxaaPixelShader",N7=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
uniform sampler2D textureSampler;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const float fxaaQualitySubpix=1.0;const float fxaaQualityEdgeThreshold=0.166;const float fxaaQualityEdgeThresholdMin=0.0833;const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);
#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)
void main(){vec2 posM;posM.x=vUV.x;posM.y=vUV.y;vec4 rgbyM=TEXTUREFUNC(textureSampler,vUV,0.0);float lumaM=FxaaLuma(rgbyM);float lumaS=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordS,0.0));float lumaE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordE,0.0));float lumaN=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordN,0.0));float lumaW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordW,0.0));float maxSM=max(lumaS,lumaM);float minSM=min(lumaS,lumaM);float maxESM=max(lumaE,maxSM);float minESM=min(lumaE,minSM);float maxWN=max(lumaN,lumaW);float minWN=min(lumaN,lumaW);float rangeMax=max(maxWN,maxESM);float rangeMin=min(minWN,minESM);float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;float range=rangeMax-rangeMin;float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);
#ifndef MALI
if(range<rangeMaxClamped) 
{gl_FragColor=rgbyM;return;}
#endif
float lumaNW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNW,0.0));float lumaSE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSE,0.0));float lumaNE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNE,0.0));float lumaSW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSW,0.0));float lumaNS=lumaN+lumaS;float lumaWE=lumaW+lumaE;float subpixRcpRange=1.0/range;float subpixNSWE=lumaNS+lumaWE;float edgeHorz1=(-2.0*lumaM)+lumaNS;float edgeVert1=(-2.0*lumaM)+lumaWE;float lumaNESE=lumaNE+lumaSE;float lumaNWNE=lumaNW+lumaNE;float edgeHorz2=(-2.0*lumaE)+lumaNESE;float edgeVert2=(-2.0*lumaN)+lumaNWNE;float lumaNWSW=lumaNW+lumaSW;float lumaSWSE=lumaSW+lumaSE;float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);float edgeHorz3=(-2.0*lumaW)+lumaNWSW;float edgeVert3=(-2.0*lumaS)+lumaSWSE;float edgeHorz=abs(edgeHorz3)+edgeHorz4;float edgeVert=abs(edgeVert3)+edgeVert4;float subpixNWSWNESE=lumaNWSW+lumaNESE;float lengthSign=texelSize.x;bool horzSpan=edgeHorz>=edgeVert;float subpixA=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)
{lumaN=lumaW;}
if (!horzSpan) 
{lumaS=lumaE;}
if (horzSpan) 
{lengthSign=texelSize.y;}
float subpixB=(subpixA*(1.0/12.0))-lumaM;float gradientN=lumaN-lumaM;float gradientS=lumaS-lumaM;float lumaNN=lumaN+lumaM;float lumaSS=lumaS+lumaM;bool pairN=abs(gradientN)>=abs(gradientS);float gradient=max(abs(gradientN),abs(gradientS));if (pairN)
{lengthSign=-lengthSign;}
float subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);vec2 posB;posB.x=posM.x;posB.y=posM.y;vec2 offNP;offNP.x=(!horzSpan) ? 0.0 : texelSize.x;offNP.y=(horzSpan) ? 0.0 : texelSize.y;if (!horzSpan) 
{posB.x+=lengthSign*0.5;}
if (horzSpan)
{posB.y+=lengthSign*0.5;}
vec2 posN;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;vec2 posP;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;float subpixD=((-2.0)*subpixC)+3.0;float lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN,0.0));float subpixE=subpixC*subpixC;float lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP,0.0));if (!pairN) 
{lumaNN=lumaSS;}
float gradientScaled=gradient*1.0/4.0;float lumaMM=lumaM-lumaNN*0.5;float subpixF=subpixD*subpixE;bool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;bool doneN=abs(lumaEndN)>=gradientScaled;bool doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) 
{posN.x-=offNP.x*3.0;}
if (!doneN) 
{posN.y-=offNP.y*3.0;}
bool doneNP=(!doneN) || (!doneP);if (!doneP) 
{posP.x+=offNP.x*3.0;}
if (!doneP)
{posP.y+=offNP.y*3.0;}
if (doneNP)
{if (!doneN) lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN.xy,0.0));if (!doneP) lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP.xy,0.0));if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) posN.x-=offNP.x*12.0;if (!doneN) posN.y-=offNP.y*12.0;doneNP=(!doneN) || (!doneP);if (!doneP) posP.x+=offNP.x*12.0;if (!doneP) posP.y+=offNP.y*12.0;}
float dstN=posM.x-posN.x;float dstP=posP.x-posM.x;if (!horzSpan)
{dstN=posM.y-posN.y;}
if (!horzSpan) 
{dstP=posP.y-posM.y;}
bool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;float spanLength=(dstP+dstN);bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;float spanLengthRcp=1.0/spanLength;bool directionN=dstN<dstP;float dst=min(dstN,dstP);bool goodSpan=directionN ? goodSpanN : goodSpanP;float subpixG=subpixF*subpixF;float pixelOffset=(dst*(-spanLengthRcp))+0.5;float subpixH=subpixG*fxaaQualitySubpix;float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if (!horzSpan)
{posM.x+=pixelOffsetSubpix*lengthSign;}
if (horzSpan)
{posM.y+=pixelOffsetSubpix*lengthSign;}
#ifdef MALI
if(range<rangeMaxClamped) 
{gl_FragColor=rgbyM;}
else
{gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);}
#else
gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);
#endif
}`;D.ShadersStore[w7]=N7;var F7="fxaaVertexShader",L7=`attribute vec2 position;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd);sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[F7]=L7;var ml=class s extends ve{getClassName(){return"FxaaPostProcess"}constructor(e,t,i=null,r,n,o,a=0){super(e,"fxaa",["texelSize"],null,t,i,r||z.BILINEAR_SAMPLINGMODE,n,o,null,a,"fxaa",void 0,!0);let l=this._getDefines();this.updateEffect(l),this.onApplyObservable.add(c=>{let h=this.texelSize;c.setFloat2("texelSize",h.x,h.y)})}_getDefines(){let e=this.getEngine();return e&&e.extractDriverInfo().toLowerCase().indexOf("mali")>-1?`#define MALI 1
`:null}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}};P("BABYLON.FxaaPostProcess",ml);var B7="grainPixelShader",V7=`#include<helperFunctions>
uniform sampler2D textureSampler; 
uniform float intensity;uniform float animatedSeed;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(textureSampler,vUV);vec2 seed=vUV*(animatedSeed);float grain=dither(seed,intensity);float lum=getLuminance(gl_FragColor.rgb);float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;gl_FragColor.rgb+=grain*grainAmount;gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);}`;D.ShadersStore[B7]=V7;var wh=class s extends ve{getClassName(){return"GrainPostProcess"}constructor(e,t,i,r,n,o,a=0,l=!1){super(e,"grain",["intensity","animatedSeed"],[],t,i,r,n,o,null,a,void 0,null,l),this.intensity=30,this.animated=!1,this.onApplyObservable.add(c=>{c.setFloat("intensity",this.intensity),c.setFloat("animatedSeed",this.animated?Math.random()+1:1)})}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}};v([I()],wh.prototype,"intensity",void 0);v([I()],wh.prototype,"animated",void 0);P("BABYLON.GrainPostProcess",wh);var U7="highlightsPixelShader",k7=`varying vec2 vUV;uniform sampler2D textureSampler;const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec4 tex=texture2D(textureSampler,vUV);vec3 c=tex.rgb;float luma=dot(c.rgb,RGBLuminanceCoefficients);gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); }`;D.ShadersStore[U7]=k7;var G7="imageProcessingPixelShader",z7=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 result=texture2D(textureSampler,vUV);
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE
result.rgb=toLinearSpace(result.rgb);
#endif
result=applyImageProcessing(result);
#else
#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
gl_FragColor=result;}`;D.ShadersStore[G7]=z7;var Nh=class extends ve{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let i=null,r=this.getEngine(),n=this.getCamera();if(n)i=n.getScene();else if(r&&r.scenes){let o=r.scenes;i=o[o.length-1]}else i=me.LastCreatedScene;i?this._imageProcessingConfiguration=i.imageProcessingConfiguration:this._imageProcessingConfiguration=new rt}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateParameters()})),t||this._updateParameters()}}get isSupported(){let e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,t,i=null,r,n,o,a=0,l){super(e,"imageProcessing",[],[],t,i,r,n,o,null,a,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:0,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},l?(l.applyByPostProcess=!0,this._attachImageProcessingConfiguration(l,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=c=>{this.imageProcessingConfiguration.bind(c,this.aspectRatio)}}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(let r in this._defines){let n=this._defines[r];switch(typeof n){case"number":case"string":e+=`#define ${r} ${n};
`;break;default:n&&(e+=`#define ${r};
`);break}}let t=["textureSampler"],i=["scale"];rt&&(rt.PrepareSamplers(t,this._defines),rt.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}};v([I()],Nh.prototype,"_fromLinearSpace",void 0);var W7="mrtFragmentDeclaration",H7=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
layout(location=0) out vec4 glFragData[{X}];
#endif
`;D.IncludesShadersStore[W7]=H7;var X7="geometryPixelShader",Y7=`#extension GL_EXT_draw_buffers : require
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
precision highp float;
#ifdef BUMP
varying mat4 vWorldView;varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#ifdef NEED_UV
varying vec2 vUV;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#if defined(REFLECTIVITY)
#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
uniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;
#endif
#ifdef ALBEDOTEXTURE
varying vec2 vAlbedoUV;uniform sampler2D albedoSampler;
#endif
#ifdef REFLECTIVITYCOLOR
uniform vec3 reflectivityColor;
#endif
#ifdef ALBEDOCOLOR
uniform vec3 albedoColor;
#endif
#ifdef METALLIC
uniform float metallic;
#endif
#if defined(ROUGHNESS) || defined(GLOSSINESS)
uniform float glossiness;
#endif
#endif
#if defined(ALPHATEST) && defined(NEED_UV)
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<mrtFragmentDeclaration>[RENDER_TARGET_COUNT]
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<helperFunctions>
void main() {
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
vec3 normalOutput;
#ifdef BUMP
vec3 normalW=normalize(vNormalW);
#include<bumpFragment>
#ifdef NORMAL_WORLDSPACE
normalOutput=normalW;
#else
normalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));
#endif
#else
normalOutput=normalize(vNormalV);
#endif
#ifdef ENCODE_NORMAL
normalOutput=normalOutput*0.5+0.5;
#endif
#ifdef PREPASS
#ifdef PREPASS_DEPTH
gl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef PREPASS_NORMAL
gl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);
#endif
#else
gl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);gl_FragData[1]=vec4(normalOutput,1.0);
#endif
#ifdef POSITION
gl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);
#endif
#ifdef VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
vec4 reflectivity=vec4(0.0,0.0,0.0,1.0);
#ifdef METALLICWORKFLOW
float metal=1.0;float roughness=1.0;
#ifdef ORMTEXTURE
metal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;
#endif
#ifdef METALLIC
metal*=metallic;
#endif
#ifdef ROUGHNESS
roughness*=(1.0-glossiness); 
#endif
reflectivity.a-=roughness;vec3 color=vec3(1.0);
#ifdef ALBEDOTEXTURE
color=texture2D(albedoSampler,vAlbedoUV).rgb;
#ifdef GAMMAALBEDO
color=toLinearSpace(color);
#endif
#endif
#ifdef ALBEDOCOLOR
color*=albedoColor.xyz;
#endif
reflectivity.rgb=mix(vec3(0.04),color,metal);
#else
#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
reflectivity=texture2D(reflectivitySampler,vReflectivityUV);
#ifdef GAMMAREFLECTIVITYTEXTURE
reflectivity.rgb=toLinearSpace(reflectivity.rgb);
#endif
#else 
#ifdef REFLECTIVITYCOLOR
reflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;
#endif
#endif
#ifdef GLOSSINESSS
reflectivity.a*=glossiness; 
#endif
#endif
gl_FragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
}
`;D.ShadersStore[X7]=Y7;var $7="geometryVertexDeclaration",j7="uniform mat4 viewProjection;uniform mat4 view;";D.IncludesShadersStore[$7]=j7;var q7="geometryUboDeclaration",Q7=`#include<sceneUboDeclaration>
`;D.IncludesShadersStore[q7]=Q7;var K7="geometryVertexShader",Z7=`precision highp float;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<__decl__geometryVertex>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;attribute vec3 normal;
#ifdef NEED_UV
varying vec2 vUV;
#ifdef ALPHATEST
uniform mat4 diffuseMatrix;
#endif
#ifdef BUMP
uniform mat4 bumpMatrix;varying vec2 vBumpUV;
#endif
#ifdef REFLECTIVITY
uniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef BUMP
varying mat4 vWorldView;
#endif
#ifdef BUMP
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));
#ifdef BUMP
vWorldView=view*finalWorld;vNormalW=normalUpdated;
#else
#ifdef NORMAL_WORLDSPACE
vNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));
#else
vNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));
#endif
#endif
vViewPos=view*worldPos;
#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vPositionW=worldPos.xyz/worldPos.w;
#endif
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#else
vUV=uv;
#endif
#ifdef BUMP_UV1
vBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV1
vReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef ALBEDO_UV1
vAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#else
vUV=uv2;
#endif
#ifdef BUMP_UV2
vBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV2
vReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef ALBEDO_UV2
vAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#endif
#include<bumpVertex>
}
`;D.ShadersStore[K7]=Z7;var UV=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];er(UV);var Xr=(()=>{class s{get normalsAreUnsigned(){return this._normalsAreUnsigned}_linkPrePassRenderer(t){this._linkedWithPrePass=!0,this._prePassRenderer=t,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add(()=>{}))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._attachmentsFromPrePass=[]}_forceTextureType(t,i){t===s.POSITION_TEXTURE_TYPE?(this._positionIndex=i,this._enablePosition=!0):t===s.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=i,this._enableVelocity=!0):t===s.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=i,this._enableReflectivity=!0):t===s.DEPTH_TEXTURE_TYPE?this._depthIndex=i:t===s.NORMAL_TEXTURE_TYPE&&(this._normalIndex=i)}_setAttachments(t){this._attachmentsFromPrePass=t}_linkInternalTexture(t){this._multiRenderTarget.setInternalTexture(t,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(t){this._multiRenderTarget.renderList=t}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(t){switch(t){case s.POSITION_TEXTURE_TYPE:return this._positionIndex;case s.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case s.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case s.DEPTH_TEXTURE_TYPE:return this._linkedWithPrePass?this._depthIndex:0;case s.NORMAL_TEXTURE_TYPE:return this._linkedWithPrePass?this._normalIndex:1;default:return-1}}get enablePosition(){return this._enablePosition}set enablePosition(t){this._enablePosition=t,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(t){this._enableVelocity=t,t||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=t}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(t){this._enableReflectivity=t,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return typeof this._ratioOrDimensions=="object"?1:this._ratioOrDimensions}constructor(t,i=1,r=15,n){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.generateNormalsInWorldSpace=!1,this._normalsAreUnsigned=!1,this._resizeObserver=null,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._clearColor=new oe(0,0,0,0),this._clearDepthColor=new oe(1e8,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._scene=t,this._ratioOrDimensions=i,this._useUbo=t.getEngine().supportsUniformBuffers,this._depthFormat=r,this._textureTypesAndFormats=n||{},s._SceneComponentInitialization(this._scene),this._createRenderTargets()}isReady(t,i){let r=t.getMaterial();if(r&&r.disableDepthWrite)return!1;let n=[],o=[y.PositionKind,y.NormalKind],a=t.getMesh();if(r){let m=!1;if(r.needAlphaTesting()&&r.getAlphaTestTexture()&&(n.push("#define ALPHATEST"),n.push(`#define ALPHATEST_UV${r.getAlphaTestTexture().coordinatesIndex+1}`),m=!0),r.bumpTexture&&ge.BumpTextureEnabled&&(n.push("#define BUMP"),n.push(`#define BUMP_UV${r.bumpTexture.coordinatesIndex+1}`),m=!0),this._enableReflectivity){let g=!1;r.getClassName()==="PBRMetallicRoughnessMaterial"?(r.metallicRoughnessTexture&&(n.push("#define ORMTEXTURE"),n.push(`#define REFLECTIVITY_UV${r.metallicRoughnessTexture.coordinatesIndex+1}`),n.push("#define METALLICWORKFLOW"),m=!0,g=!0),r.metallic!=null&&(n.push("#define METALLIC"),n.push("#define METALLICWORKFLOW"),g=!0),r.roughness!=null&&(n.push("#define ROUGHNESS"),n.push("#define METALLICWORKFLOW"),g=!0),g&&(r.baseTexture&&(n.push("#define ALBEDOTEXTURE"),n.push(`#define ALBEDO_UV${r.baseTexture.coordinatesIndex+1}`),r.baseTexture.gammaSpace&&n.push("#define GAMMAALBEDO"),m=!0),r.baseColor&&n.push("#define ALBEDOCOLOR"))):r.getClassName()==="PBRSpecularGlossinessMaterial"?(r.specularGlossinessTexture?(n.push("#define SPECULARGLOSSINESSTEXTURE"),n.push(`#define REFLECTIVITY_UV${r.specularGlossinessTexture.coordinatesIndex+1}`),m=!0,r.specularGlossinessTexture.gammaSpace&&n.push("#define GAMMAREFLECTIVITYTEXTURE")):r.specularColor&&n.push("#define REFLECTIVITYCOLOR"),r.glossiness!=null&&n.push("#define GLOSSINESS")):r.getClassName()==="PBRMaterial"?(r.metallicTexture&&(n.push("#define ORMTEXTURE"),n.push(`#define REFLECTIVITY_UV${r.metallicTexture.coordinatesIndex+1}`),n.push("#define METALLICWORKFLOW"),m=!0,g=!0),r.metallic!=null&&(n.push("#define METALLIC"),n.push("#define METALLICWORKFLOW"),g=!0),r.roughness!=null&&(n.push("#define ROUGHNESS"),n.push("#define METALLICWORKFLOW"),g=!0),g?(r.albedoTexture&&(n.push("#define ALBEDOTEXTURE"),n.push(`#define ALBEDO_UV${r.albedoTexture.coordinatesIndex+1}`),r.albedoTexture.gammaSpace&&n.push("#define GAMMAALBEDO"),m=!0),r.albedoColor&&n.push("#define ALBEDOCOLOR")):(r.reflectivityTexture?(n.push("#define SPECULARGLOSSINESSTEXTURE"),n.push(`#define REFLECTIVITY_UV${r.reflectivityTexture.coordinatesIndex+1}`),r.reflectivityTexture.gammaSpace&&n.push("#define GAMMAREFLECTIVITYTEXTURE"),m=!0):r.reflectivityColor&&n.push("#define REFLECTIVITYCOLOR"),r.microSurface!=null&&n.push("#define GLOSSINESS"))):r.getClassName()==="StandardMaterial"&&(r.specularTexture&&(n.push("#define REFLECTIVITYTEXTURE"),n.push(`#define REFLECTIVITY_UV${r.specularTexture.coordinatesIndex+1}`),r.specularTexture.gammaSpace&&n.push("#define GAMMAREFLECTIVITYTEXTURE"),m=!0),r.specularColor&&n.push("#define REFLECTIVITYCOLOR"))}m&&(n.push("#define NEED_UV"),a.isVerticesDataPresent(y.UVKind)&&(o.push(y.UVKind),n.push("#define UV1")),a.isVerticesDataPresent(y.UV2Kind)&&(o.push(y.UV2Kind),n.push("#define UV2")))}this._linkedWithPrePass&&(n.push("#define PREPASS"),this._depthIndex!==-1&&(n.push("#define DEPTH_INDEX "+this._depthIndex),n.push("#define PREPASS_DEPTH")),this._normalIndex!==-1&&(n.push("#define NORMAL_INDEX "+this._normalIndex),n.push("#define PREPASS_NORMAL"))),this._enablePosition&&(n.push("#define POSITION"),n.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(n.push("#define VELOCITY"),n.push("#define VELOCITY_INDEX "+this._velocityIndex),this.excludedSkinnedMeshesFromVelocity.indexOf(a)===-1&&n.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(n.push("#define REFLECTIVITY"),n.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this.generateNormalsInWorldSpace&&n.push("#define NORMAL_WORLDSPACE"),this._normalsAreUnsigned&&n.push("#define ENCODE_NORMAL"),a.useBones&&a.computeBonesUsingShaders&&a.skeleton?(o.push(y.MatricesIndicesKind),o.push(y.MatricesWeightsKind),a.numBoneInfluencers>4&&(o.push(y.MatricesIndicesExtraKind),o.push(y.MatricesWeightsExtraKind)),n.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),n.push("#define BONETEXTURE "+a.skeleton.isUsingTextureForMatrices),n.push("#define BonesPerMesh "+(a.skeleton.bones.length+1))):(n.push("#define NUM_BONE_INFLUENCERS 0"),n.push("#define BONETEXTURE false"),n.push("#define BonesPerMesh 0"));let l=a.morphTargetManager,c=0;l&&(c=l.numMaxInfluencers||l.numInfluencers,c>0&&(n.push("#define MORPHTARGETS"),n.push("#define NUM_MORPH_INFLUENCERS "+c),l.isUsingTextureForTargets&&n.push("#define MORPHTARGETS_TEXTURE"),oo(o,a,c))),i&&(n.push("#define INSTANCES"),Ds(o,this._enableVelocity),t.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES")),this._linkedWithPrePass?n.push("#define RENDER_TARGET_COUNT "+this._attachmentsFromPrePass.length):n.push("#define RENDER_TARGET_COUNT "+this._multiRenderTarget.textures.length),cs(r,this._scene,n);let h=this._scene.getEngine(),u=t._getDrawWrapper(void 0,!0),d=u.defines,f=n.join(`
`);return d!==f&&u.setEffect(h.createEffect("geometry",{attributes:o,uniformsNames:UV,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:f,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:c}},h),f),u.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(t){this._multiRenderTarget.samples=t}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){let t=[],i=[],r=2;return t.push("gBuffer_Depth","gBuffer_Normal"),i.push(this._textureTypesAndFormats[s.DEPTH_TEXTURE_TYPE]),i.push(this._textureTypesAndFormats[s.NORMAL_TEXTURE_TYPE]),this._enablePosition&&(this._positionIndex=r,r++,t.push("gBuffer_Position"),i.push(this._textureTypesAndFormats[s.POSITION_TEXTURE_TYPE])),this._enableVelocity&&(this._velocityIndex=r,r++,t.push("gBuffer_Velocity"),i.push(this._textureTypesAndFormats[s.VELOCITY_TEXTURE_TYPE])),this._enableReflectivity&&(this._reflectivityIndex=r,r++,t.push("gBuffer_Reflectivity"),i.push(this._textureTypesAndFormats[s.REFLECTIVITY_TEXTURE_TYPE])),[r,t,i]}_createRenderTargets(){let t=this._scene.getEngine(),[i,r,n]=this._assignRenderTargetIndices(),o=0;t._caps.textureFloat&&t._caps.textureFloatLinearFiltering?o=1:t._caps.textureHalfFloat&&t._caps.textureHalfFloatLinearFiltering&&(o=2);let a=this._ratioOrDimensions.width!==void 0?this._ratioOrDimensions:{width:t.getRenderWidth()*this._ratioOrDimensions,height:t.getRenderHeight()*this._ratioOrDimensions},l=[],c=[];for(let x of n)x?(l.push(x.textureType),c.push(x.textureFormat)):(l.push(o),c.push(5));if(this._normalsAreUnsigned=l[s.NORMAL_TEXTURE_TYPE]===11||l[s.NORMAL_TEXTURE_TYPE]===13,this._multiRenderTarget=new Rn("gBuffer",a,i,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,types:l,formats:c,depthTextureFormat:this._depthFormat},r.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=z.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=z.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;let h=[!0],u=[!1],d=[!0];for(let x=1;x<i;++x)h.push(!0),d.push(!1),u.push(!0);let f=t.buildTextureLayout(h),m=t.buildTextureLayout(u),g=t.buildTextureLayout(d);this._multiRenderTarget.onClearObservable.add(x=>{x.bindAttachments(this.useSpecificClearForDepthTexture?m:f),x.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(x.bindAttachments(g),x.clear(this._clearDepthColor,!0,!0,!0)),x.bindAttachments(f)}),this._resizeObserver=t.onResizeObservable.add(()=>{if(this._multiRenderTarget){let x=this._ratioOrDimensions.width!==void 0?this._ratioOrDimensions:{width:t.getRenderWidth()*this._ratioOrDimensions,height:t.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(x)}});let _=x=>{let b=x.getRenderingMesh(),C=x.getEffectiveMesh(),R=this._scene,E=R.getEngine(),S=x.getMaterial();if(!S)return;if(C._internalAbstractMeshDataInfo._isActiveIntermediate=!1,this._enableVelocity&&!this._previousTransformationMatrices[C.uniqueId]&&(this._previousTransformationMatrices[C.uniqueId]={world:N.Identity(),viewProjection:R.getTransformMatrix()},b.skeleton)){let W=b.skeleton.getTransformMatrices(b);this._previousBonesTransformationMatrices[b.uniqueId]=this._copyBonesTransformationMatrices(W,new Float32Array(W.length))}let A=b._getInstancesRenderList(x._id,!!x.getReplacementMesh());if(A.mustReturn)return;let L=E.getCaps().instancedArrays&&(A.visibleInstances[x._id]!==null||b.hasThinInstances),G=C.getWorldMatrix();if(this.isReady(x,L)){let W=x._getDrawWrapper();if(!W)return;let $=W.effect;E.enableEffect(W),L||b._bind(x,$,S.fillMode),this._useUbo?(Pa($,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):($.setMatrix("viewProjection",R.getTransformMatrix()),$.setMatrix("view",R.getViewMatrix()));let re,we=b._instanceDataStorage;if(!we.isFrozen&&(S.backFaceCulling||S.sideOrientation!==null)){let _e=C._getWorldMatrixDeterminant();re=S._getEffectiveOrientation(b),_e<0&&(re=re===se.ClockWiseSideOrientation?se.CounterClockWiseSideOrientation:se.ClockWiseSideOrientation)}else re=we.sideOrientation;if(S._preBind(W,re),S.needAlphaTesting()){let _e=S.getAlphaTestTexture();_e&&($.setTexture("diffuseSampler",_e),$.setMatrix("diffuseMatrix",_e.getTextureMatrix()))}if(S.bumpTexture&&R.getEngine().getCaps().standardDerivatives&&ge.BumpTextureEnabled&&($.setFloat3("vBumpInfos",S.bumpTexture.coordinatesIndex,1/S.bumpTexture.level,S.parallaxScaleBias),$.setMatrix("bumpMatrix",S.bumpTexture.getTextureMatrix()),$.setTexture("bumpSampler",S.bumpTexture),$.setFloat2("vTangentSpaceParams",S.invertNormalMapX?-1:1,S.invertNormalMapY?-1:1)),this._enableReflectivity&&(S.getClassName()==="PBRMetallicRoughnessMaterial"?(S.metallicRoughnessTexture!==null&&($.setTexture("reflectivitySampler",S.metallicRoughnessTexture),$.setMatrix("reflectivityMatrix",S.metallicRoughnessTexture.getTextureMatrix())),S.metallic!==null&&$.setFloat("metallic",S.metallic),S.roughness!==null&&$.setFloat("glossiness",1-S.roughness),S.baseTexture!==null&&($.setTexture("albedoSampler",S.baseTexture),$.setMatrix("albedoMatrix",S.baseTexture.getTextureMatrix())),S.baseColor!==null&&$.setColor3("albedoColor",S.baseColor)):S.getClassName()==="PBRSpecularGlossinessMaterial"?(S.specularGlossinessTexture!==null?($.setTexture("reflectivitySampler",S.specularGlossinessTexture),$.setMatrix("reflectivityMatrix",S.specularGlossinessTexture.getTextureMatrix())):S.specularColor!==null&&$.setColor3("reflectivityColor",S.specularColor),S.glossiness!==null&&$.setFloat("glossiness",S.glossiness)):S.getClassName()==="PBRMaterial"?(S.metallicTexture!==null&&($.setTexture("reflectivitySampler",S.metallicTexture),$.setMatrix("reflectivityMatrix",S.metallicTexture.getTextureMatrix())),S.metallic!==null&&$.setFloat("metallic",S.metallic),S.roughness!==null&&$.setFloat("glossiness",1-S.roughness),S.roughness!==null||S.metallic!==null||S.metallicTexture!==null?(S.albedoTexture!==null&&($.setTexture("albedoSampler",S.albedoTexture),$.setMatrix("albedoMatrix",S.albedoTexture.getTextureMatrix())),S.albedoColor!==null&&$.setColor3("albedoColor",S.albedoColor)):(S.reflectivityTexture!==null?($.setTexture("reflectivitySampler",S.reflectivityTexture),$.setMatrix("reflectivityMatrix",S.reflectivityTexture.getTextureMatrix())):S.reflectivityColor!==null&&$.setColor3("reflectivityColor",S.reflectivityColor),S.microSurface!==null&&$.setFloat("glossiness",S.microSurface))):S.getClassName()==="StandardMaterial"&&(S.specularTexture!==null&&($.setTexture("reflectivitySampler",S.specularTexture),$.setMatrix("reflectivityMatrix",S.specularTexture.getTextureMatrix())),S.specularColor!==null&&$.setColor3("reflectivityColor",S.specularColor))),Yi($,S,this._scene),b.useBones&&b.computeBonesUsingShaders&&b.skeleton){let _e=b.skeleton;if(_e.isUsingTextureForMatrices&&$.getUniformIndex("boneTextureWidth")>-1){let ce=_e.getTransformMatrixTexture(b);$.setTexture("boneSampler",ce),$.setFloat("boneTextureWidth",4*(_e.bones.length+1))}else $.setMatrices("mBones",b.skeleton.getTransformMatrices(b));this._enableVelocity&&$.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[b.uniqueId])}Vr(b,$),b.morphTargetManager&&b.morphTargetManager.isUsingTextureForTargets&&b.morphTargetManager._bind($),this._enableVelocity&&($.setMatrix("previousWorld",this._previousTransformationMatrices[C.uniqueId].world),$.setMatrix("previousViewProjection",this._previousTransformationMatrices[C.uniqueId].viewProjection)),L&&b.hasThinInstances&&$.setMatrix("world",G),b._processRendering(C,x,$,S.fillMode,A,L,(_e,ce)=>{_e||$.setMatrix("world",ce)})}this._enableVelocity&&(this._previousTransformationMatrices[C.uniqueId].world=G.clone(),this._previousTransformationMatrices[C.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),b.skeleton&&this._copyBonesTransformationMatrices(b.skeleton.getTransformMatrices(b),this._previousBonesTransformationMatrices[C.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(x,b,C)=>{if((C||b===0)&&x.subMeshes)for(let R=0;R<x.subMeshes.length;++R){let E=x.subMeshes[R],S=E.getMaterial(),A=E.getRenderingMesh();if(!S)continue;let L=A._getInstancesRenderList(E._id,!!E.getReplacementMesh()),G=t.getCaps().instancedArrays&&(L.visibleInstances[E._id]!==null||A.hasThinInstances);if(!this.isReady(E,G))return!1}return!0},this._multiRenderTarget.customRenderFunction=(x,b,C,R)=>{let E;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(R.length){for(t.setColorWrite(!1),E=0;E<R.length;E++)_(R.data[E]);t.setColorWrite(!0)}for(E=0;E<x.length;E++)_(x.data[E]);for(t.setDepthWrite(!1),E=0;E<b.length;E++)_(b.data[E]);if(this.renderTransparentMeshes)for(E=0;E<C.length;E++)_(C.data[E]);t.setDepthWrite(!0)}}_copyBonesTransformationMatrices(t,i){for(let r=0;r<t.length;r++)i[r]=t[r];return i}}return s.DEPTH_TEXTURE_TYPE=0,s.NORMAL_TEXTURE_TYPE=1,s.POSITION_TEXTURE_TYPE=2,s.VELOCITY_TEXTURE_TYPE=3,s.REFLECTIVITY_TEXTURE_TYPE=4,s._SceneComponentInitialization=e=>{throw We("GeometryBufferRendererSceneComponent")},s})();var jC=class{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}};Object.defineProperty(Te.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(s){s&&s.isSupported&&(this._geometryBufferRenderer=s)},enumerable:!0,configurable:!0});Te.prototype.enableGeometryBufferRenderer=function(s=1,e=15,t){return this._geometryBufferRenderer?this._geometryBufferRenderer:(this._geometryBufferRenderer=new Xr(this,s,e,t),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null),this._geometryBufferRenderer)};Te.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};var nM=class{constructor(e){this.name=ye.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(ye.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}};Xr._SceneComponentInitialization=s=>{let e=s._getComponent(ye.NAME_GEOMETRYBUFFERRENDERER);e||(e=new nM(s),s._addComponent(e))};var J7="motionBlurPixelShader",e9=`varying vec2 vUV;uniform sampler2D textureSampler;uniform float motionStrength;uniform float motionScale;uniform vec2 screenSize;
#ifdef OBJECT_BASED
uniform sampler2D velocitySampler;
#else
uniform sampler2D depthSampler;uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform mat4 projection;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#ifdef GEOMETRY_SUPPORTED
#ifdef OBJECT_BASED
vec2 texelSize=1.0/screenSize;vec4 velocityColor=texture2D(velocitySampler,vUV);velocityColor.rg=velocityColor.rg*2.0-vec2(1.0);vec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;velocity*=motionScale*motionStrength;float speed=length(velocity/texelSize);int samplesCount=int(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;float hlim=float(-samplesCount)*0.5+0.5;vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i)
{if (i>=samplesCount)
break;vec2 offset=vUV+velocity*(hlim+float(i));
#if defined(WEBGPU)
result+=texture2DLodEXT(textureSampler,offset,0.0);
#else
result+=texture2D(textureSampler,offset);
#endif
}
gl_FragColor=result/float(samplesCount);gl_FragColor.a=1.0;
#else
vec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;depth=projection[2].z+projection[3].z/depth; 
vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=inverseViewProjection*cpos;cpos/=cpos.w;vec4 ppos=prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i) {if (i>=nSamples)
break;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);
#if defined(WEBGPU)
result+=texture2DLodEXT(textureSampler,offset1,0.0);
#else
result+=texture2D(textureSampler,offset1);
#endif
}
gl_FragColor=result/float(nSamples);
#endif
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;D.ShadersStore[J7]=e9;var cc=class s extends ve{get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}constructor(e,t,i,r,n,o,a,l=0,c=!1,h=!1){super(e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"],["velocitySampler","depthSampler"],i,r,n,o,a,`#define GEOMETRY_SUPPORTED
#define SAMPLES 64.0
#define OBJECT_BASED`,l,void 0,null,c),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this._forceGeometryBuffer=!1,this._invViewProjection=null,this._previousViewProjection=null,this._forceGeometryBuffer=h,this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new jC)),this._applyMode()}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)t=this._prePassRenderer.excludedSkinnedMesh;else return;t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)t=this._prePassRenderer.excludedSkinnedMesh;else return;let i=t.indexOf(e);i!==-1&&t.splice(i,1)}}dispose(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer)return F.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased),this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._invViewProjection=N.Identity(),this._previousViewProjection=this._scene.getTransformMatrix().clone(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(e.setVector2("screenSize",new j(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){let t=this._geometryBufferRenderer.getTextureIndex(Xr.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){let t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){let t=O.Matrix[0];if(t.copyFrom(this._scene.getTransformMatrix()),t.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection.copyFrom(t),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setVector2("screenSize",new j(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){let i=this._geometryBufferRenderer.getTextureIndex(Xr.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[i])}else if(this._prePassRenderer){let i=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[i])}}_updateEffect(){if(this._geometryBufferRenderer||this._prePassRenderer){let e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join(`
`))}}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,r)}};v([I()],cc.prototype,"motionStrength",void 0);v([I()],cc.prototype,"motionBlurSamples",null);v([I()],cc.prototype,"isObjectBased",null);P("BABYLON.MotionBlurPostProcess",cc);var t9="refractionPixelShader",i9="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D refractionSampler;uniform vec3 baseColor;uniform float depth;uniform float colorLevel;void main() {float ref=1.0-texture2D(refractionSampler,vUV).r;vec2 uv=vUV-vec2(0.5);vec2 offset=uv*depth*ref;vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);}";D.ShadersStore[t9]=i9;var Fh=class s extends ve{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,i,r,n,o,a,l,c,h){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],o,a,l,c,h),this._ownRefractionTexture=!0,this.color=i,this.depth=r,this.colorLevel=n,this.refractionTextureUrl=t,this.onActivateObservable.add(u=>{this._refTexture=this._refTexture||new z(t,u.getScene())}),this.onApplyObservable.add(u=>{u.setColor3("baseColor",this.color),u.setFloat("depth",this.depth),u.setFloat("colorLevel",this.colorLevel),u.setTexture("refractionSampler",this._refTexture)})}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}};v([I()],Fh.prototype,"color",void 0);v([I()],Fh.prototype,"depth",void 0);v([I()],Fh.prototype,"colorLevel",void 0);v([I()],Fh.prototype,"refractionTextureUrl",void 0);P("BABYLON.RefractionPostProcess",Fh);var r9="sharpenPixelShader",s9=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 sharpnessAmounts;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 color=texture2D(textureSampler,vUV);vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(0,1)) -
color*4.0;gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);}`;D.ShadersStore[r9]=s9;var Lh=class s extends ve{getClassName(){return"SharpenPostProcess"}constructor(e,t,i,r,n,o,a=0,l=!1){super(e,"sharpen",["sharpnessAmounts","screenSize"],null,t,i,r,n,o,null,a,void 0,null,l),this.colorAmount=1,this.edgeAmount=.3,this.onApply=c=>{c.setFloat2("screenSize",this.width,this.height),c.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}};v([I()],Lh.prototype,"colorAmount",void 0);v([I()],Lh.prototype,"edgeAmount",void 0);P("BABYLON.SharpenPostProcess",Lh);var ys=class{get name(){return this._name}get cameras(){return this._cameras}constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(let e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){let i=this._renderEffects[e];i&&i._enable(H.MakeArray(t||this._cameras))}_disableEffect(e,t){let i=this._renderEffects[e];i&&i._disable(H.MakeArray(t||this._cameras))}_attachCameras(e,t){let i=H.MakeArray(e||this._cameras);if(!i)return;let r=[],n;for(n=0;n<i.length;n++){let o=i[n];o&&(this._cameras.indexOf(o)===-1?this._cameras.push(o):t&&r.push(n))}for(n=0;n<r.length;n++)i.splice(r[n],1);for(let o in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,o)&&this._renderEffects[o]._attachCameras(i)}_detachCameras(e){let t=H.MakeArray(e||this._cameras);if(t){for(let i in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,i)&&this._renderEffects[i]._detachCameras(t);for(let i=0;i<t.length;i++)this._cameras.splice(this._cameras.indexOf(t[i]),1)}}_update(){for(let e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;let t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;let t=Object.keys(this._renderEffects);if(t.length>0){let i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}_adaptPostProcessesToViewPort(){let e=Object.keys(this._renderEffects);for(let t of e){let i=this._renderEffects[t].getPostProcesses();if(i)for(let r of i)r.adaptScaleToCurrentViewport=!0}}setPrePassRenderer(e){return!1}dispose(){}};v([I()],ys.prototype,"_name",void 0);var qC=class{constructor(){this._renderPipelines={}}get supportedPipelines(){let e=[];for(let t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){let i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this._renderPipelines[e._name]=e}removePipeline(e){delete this._renderPipelines[e]}attachCamerasToRenderPipeline(e,t,i=!1){let r=this._renderPipelines[e];r&&r._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){let i=this._renderPipelines[e];i&&i._detachCameras(t)}enableEffectInPipeline(e,t,i){let r=this._renderPipelines[e];r&&r._enableEffect(t,i)}disableEffectInPipeline(e,t,i){let r=this._renderPipelines[e];r&&r._disableEffect(t,i)}update(){for(let e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){let t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(let e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(let e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}};Object.defineProperty(Te.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let s=this._getComponent(ye.NAME_POSTPROCESSRENDERPIPELINEMANAGER);s||(s=new oM(this),this._addComponent(s)),this._postProcessRenderPipelineManager=new qC}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});var oM=class{constructor(e){this.name=ye.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(ye.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}};var Nr=class s extends ys{get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){let e=this.bloom;this.bloom=new sg(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;let t=this.depthOfField;this.depthOfField=new ng(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let i=0;i<this._cameras.length;i++)t.disposeEffects(this._cameras[i]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new Zn("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return this._glowLayer!=null}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",t=!0,i=me.LastCreatedScene,r,n=!0){super(i.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=xf.Low,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new U,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=r||i.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=n,this._scene=i;let o=this._scene.getEngine().getCaps();this._hdr=t&&(o.textureHalfFloatRender||o.textureFloatRender),this._hdr?o.textureHalfFloatRender?this._defaultPipelineTextureType=2:o.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,i.postProcessRenderPipelineManager.addPipeline(this);let a=this._scene.getEngine();this.sharpen=new Lh("sharpen",1,null,z.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new ot(a,this.SharpenPostProcessId,()=>this.sharpen,!0),this.depthOfField=new ng(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=a.getHardwareScalingLevel(),this._resizeObserver=a.onResizeObservable.add(()=>{this._hardwareScaleLevel=a.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel}),this.bloom=new sg(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new Bo("ChromaticAberration",a.getRenderWidth(),a.getRenderHeight(),1,null,z.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new ot(a,this.ChromaticAberrationPostProcessId,()=>this.chromaticAberration,!0),this.grain=new wh("Grain",1,null,z.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new ot(a,this.GrainPostProcessId,()=>this.grain,!0);let l=!0;this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add(()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,l?H.SetImmediate(()=>{this._buildPipeline()}):this._buildPipeline())}),this._buildPipeline(),l=!1}getClassName(){return"DefaultRenderingPipeline"}prepare(){let e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;let e=this._scene.getEngine();if(this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(let t of this._cameras){let i=this._scene.enableDepthRenderer(t);i.useOnlyInActiveCamera=!0}this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add(t=>{this._cameras.indexOf(t.activeCamera)>-1&&(this.depthOfField.depthTexture=t.enableDepthRenderer(t.activeCamera).getDepthMap())})}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);let t=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=t.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new Nh("imageProcessing",1,null,z.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new ot(e,this.ImageProcessingPostProcessId,()=>this.imageProcessing,!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,(!this._cameras||this._cameras.length===0)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new ml("fxaa",1,null,z.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new ot(e,this.FxaaPostProcessId,()=>this.fxaa,!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&this._cameras.indexOf(this._scene.activeCamera)===-1)&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add(()=>{this._scene.activeCamera&&this._cameras.indexOf(this._scene.activeCamera)===-1&&(this._scene.autoClear=!0)})),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add(()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)})),this._adaptPostProcessesToViewPort(),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&F.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){let i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){let t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene._postProcessRenderPipelineManager.removePipeline(this.name),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){let e=ae.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return ae.Parse(()=>new s(e._name,e._name._hdr,t),e,t,i)}};v([I()],Nr.prototype,"sharpenEnabled",null);v([I()],Nr.prototype,"bloomKernel",null);v([I()],Nr.prototype,"_bloomWeight",void 0);v([I()],Nr.prototype,"_bloomThreshold",void 0);v([I()],Nr.prototype,"_hdr",void 0);v([I()],Nr.prototype,"bloomWeight",null);v([I()],Nr.prototype,"bloomThreshold",null);v([I()],Nr.prototype,"bloomScale",null);v([I()],Nr.prototype,"bloomEnabled",null);v([I()],Nr.prototype,"depthOfFieldEnabled",null);v([I()],Nr.prototype,"depthOfFieldBlurLevel",null);v([I()],Nr.prototype,"fxaaEnabled",null);v([I()],Nr.prototype,"samples",null);v([I()],Nr.prototype,"imageProcessingEnabled",null);v([I()],Nr.prototype,"glowLayerEnabled",null);v([I()],Nr.prototype,"chromaticAberrationEnabled",null);v([I()],Nr.prototype,"grainEnabled",null);P("BABYLON.DefaultRenderingPipeline",Nr);var n9="lensHighlightsPixelShader",o9=`uniform sampler2D textureSampler; 
uniform float gain;uniform float threshold;uniform float screen_width;uniform float screen_height;varying vec2 vUV;vec4 highlightColor(vec4 color) {vec4 highlight=color;float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));float lum_threshold;if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }
else { lum_threshold=0.5+0.44*threshold; }
luminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);highlight*=luminance*gain;highlight.a=1.0;return highlight;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 original=texture2D(textureSampler,vUV);if (gain==-1.0) {gl_FragColor=vec4(0.0,0.0,0.0,1.0);return;}
float w=2.0/screen_width;float h=2.0/screen_height;float weight=1.0;vec4 blurred=vec4(0.0,0.0,0.0,0.0);
#ifdef PENTAGON
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));
#else
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));
#endif
blurred/=39.0;gl_FragColor=blurred;}`;D.ShadersStore[n9]=o9;var a9="depthOfFieldPixelShader",l9=`uniform sampler2D textureSampler;uniform sampler2D highlightsSampler;uniform sampler2D depthSampler;uniform sampler2D grainSampler;uniform float grain_amount;uniform bool blur_noise;uniform float screen_width;uniform float screen_height;uniform float distortion;uniform bool dof_enabled;uniform float screen_distance; 
uniform float aperture;uniform float darken;uniform float edge_blur;uniform bool highlights;uniform float near;uniform float far;varying vec2 vUV;
#define PI 3.14159265
#define TWOPI 6.28318530
#define inverse_focal_length 0.1 
vec2 centered_screen_pos;vec2 distorted_coords;float radius2;float radius;vec2 rand(vec2 co)
{float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));return clamp(vec2(noise1,noise2),0.0,1.0);}
vec2 getDistortedCoords(vec2 coords) {if (distortion==0.0) { return coords; }
vec2 direction=1.0*normalize(centered_screen_pos);vec2 dist_coords=vec2(0.5,0.5);dist_coords.x=0.5+direction.x*radius2*1.0;dist_coords.y=0.5+direction.y*radius2*1.0;float dist_amount=clamp(distortion*0.23,0.0,1.0);dist_coords=mix(coords,dist_coords,dist_amount);return dist_coords;}
float sampleScreen(inout vec4 color,in vec2 offset,in float weight) {vec2 coords=distorted_coords;float angle=rand(coords*100.0).x*TWOPI;coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));color+=texture2D(textureSampler,coords)*weight;return weight;}
float getBlurLevel(float size) {return min(3.0,ceil(size/1.0));}
vec4 getBlurColor(float size) {vec4 col=texture2D(textureSampler,distorted_coords);float blur_level=getBlurLevel(size);float w=(size/screen_width);float h=(size/screen_height);float total_weight=1.0;vec2 sample_coords;total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);if (blur_level>1.0) {total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);}
if (blur_level>2.0) {total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);}
col/=total_weight; 
if (darken>0.0) {col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);}
return col;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;radius=sqrt(radius2);distorted_coords=getDistortedCoords(vUV); 
vec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); 
float depth=texture2D(depthSampler,distorted_coords).r; 
float distance=near+(far-near)*depth; 
vec4 color=texture2D(textureSampler,vUV); 
float coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));if (dof_enabled==false || coc<0.07) { coc=0.0; }
float edge_blur_amount=0.0;if (edge_blur>0.0) {edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;}
float blur_amount=max(edge_blur_amount,coc);if (blur_amount==0.0) {gl_FragColor=texture2D(textureSampler,distorted_coords);}
else {gl_FragColor=getBlurColor(blur_amount*1.7);if (highlights) {gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;}
if (blur_noise) {vec2 noise=rand(distorted_coords)*0.01*blur_amount;vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;}}
if (grain_amount>0.0) {vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;}}
`;D.ShadersStore[a9]=l9;var QC=class{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}};var c9="ssao2PixelShader",h9=`precision highp float;uniform sampler2D textureSampler;varying vec2 vUV;
#ifdef SSAO
float scales[16]=float[16](
0.1,
0.11406250000000001,
0.131640625,
0.15625,
0.187890625,
0.2265625,
0.272265625,
0.325,
0.384765625,
0.4515625,
0.525390625,
0.60625,
0.694140625,
0.7890625,
0.891015625,
1.0
);uniform float near;uniform float radius;uniform sampler2D depthSampler;uniform sampler2D randomSampler;uniform sampler2D normalSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float base;uniform float xViewport;uniform float yViewport;uniform mat3 depthProjection;uniform float maxZ;uniform float minZAspect;uniform vec2 texelSize;uniform mat4 projection;void main()
{vec3 random=textureLod(randomSampler,vUV*randTextureTiles,0.0).rgb;float depth=textureLod(depthSampler,vUV,0.0).r;float depthSign=sign(depth);depth=depth*depthSign;vec3 normal=textureLod(normalSampler,vUV,0.0).rgb;float occlusion=0.0;float correctedRadius=min(radius,minZAspect*depth/near);vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);vec3 origin=vViewRay*vDepthFactor;vec3 rvec=random*2.0-1.0;rvec.z=0.0;float dotProduct=dot(rvec,normal);rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);vec3 tangent=normalize(rvec-normal*dot(rvec,normal));vec3 bitangent=cross(normal,tangent);mat3 tbn=mat3(tangent,bitangent,normal);float difference;for (int i=0; i<SAMPLES; ++i) {vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;vec4 offset=vec4(samplePosition,1.0);offset=projection*offset;offset.xyz/=offset.w;offset.xy=offset.xy*0.5+0.5;if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}
float sampleDepth=abs(textureLod(depthSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}
occlusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor=vec4(vec3(result),1.0);}
#endif
#ifdef BLUR
uniform float outSize;uniform float soften;uniform float tolerance;uniform int samples;
#ifndef BLUR_BYPASS
uniform sampler2D depthSampler;
#ifdef BLUR_LEGACY
#define inline
float blur13Bilateral(sampler2D image,vec2 uv,vec2 step) {float result=0.0;vec2 off1=vec2(1.411764705882353)*step;vec2 off2=vec2(3.2941176470588234)*step;vec2 off3=vec2(5.176470588235294)*step;float compareDepth=abs(textureLod(depthSampler,uv,0.0).r);float sampleDepth;float weight;float weightSum=30.0;result+=textureLod(image,uv,0.0).r*30.0;sampleDepth=abs(textureLod(depthSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv+off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv-off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off3,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off3,0.0).r*weight;return result/weightSum;}
#endif
#endif
void main()
{float result=0.0;
#ifdef BLUR_BYPASS
result=textureLod(textureSampler,vUV,0.0).r;
#else
#ifdef BLUR_H
vec2 step=vec2(1.0/outSize,0.0);
#else
vec2 step=vec2(0.0,1.0/outSize);
#endif
#ifdef BLUR_LEGACY
result=blur13Bilateral(textureSampler,vUV,step);
#else
float compareDepth=abs(textureLod(depthSampler,vUV,0.0).r);float weightSum=0.0;for (int i=-samples; i<samples; i+=2)
{vec2 samplePos=vUV+step*(float(i)+0.5);float sampleDepth=abs(textureLod(depthSampler,samplePos,0.0).r);float falloff=smoothstep(0.0,
float(samples),
float(samples)-abs(float(i))*soften);float minDivider=tolerance*0.5+0.003;float weight=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureLod(textureSampler,samplePos,0.0).r*weight;weightSum+=weight;}
result/=weightSum;
#endif
#endif
gl_FragColor.rgb=vec3(result);gl_FragColor.a=1.0;}
#endif
`;D.ShadersStore[c9]=h9;var u9="ssaoCombinePixelShader",d9=`uniform sampler2D textureSampler;uniform sampler2D originalColor;uniform vec4 viewport;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);vec4 sceneColor=texture2D(originalColor,vUV);gl_FragColor=sceneColor*ssaoColor;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;D.ShadersStore[u9]=d9;var yr=class s extends ys{set epsilon(e){this._epsilon=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO())}get epsilon(){return this._epsilon}set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set bypassBlur(e){let t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this._blurHPostProcess.updateEffect(t.h,null,i),this._blurVPostProcess.updateEffect(t.v,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){let t=this._getDefinesForBlur(e,this._bypassBlur);this._blurHPostProcess.updateEffect(t.h),this._blurVPostProcess.updateEffect(t.v),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){let e=me.LastCreatedEngine;return e?e._features.supportSSAO2:!1}get scene(){return this._scene}constructor(e,t,i,r,n=!1,o=0){if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._epsilon=.02,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this.radius=2,this.base=0,this._bypassBlur=!1,this._expensiveBlur=!0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._textureType=o,this._forceGeometryBuffer=n,!this.isSupported){F.Error("The current engine does not support SSAO 2.");return}let a=this._ratio.ssaoRatio||i,l=this._ratio.blurRatio||i;this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),t.geometryBufferRenderer?.generateNormalsInWorldSpace&&F.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!")):(t.enablePrePassRenderer(),t.prePassRenderer?.generateNormalsInWorldSpace&&F.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!")),this._createRandomTexture(),this._originalColorPostProcess=new qr("SSAOOriginalSceneColor",1,null,z.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,o),this._createBlurPostProcess(a,l,this._textureType),this._createSSAOCombinePostProcess(l,this._textureType),this.addEffect(new ot(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new ot(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new ot(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new ot(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new ot(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let t=0;t<this._scene.cameras.length;t++){let i=this._scene.cameras[t];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_rebuild(){super._rebuild()}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i=`#define BLUR
`;return t&&(i+=`#define BLUR_BYPASS
`),e||(i+=`#define BLUR_LEGACY
`),{h:i+`#define BLUR_H
`,v:i}}_createBlurPostProcess(e,t,i){let r=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),n=this._getSamplersForBlur(this.bypassBlur);this._blurHPostProcess=this._createBlurFilter("BlurH",n,e,r.h,i,!0),this._blurVPostProcess=this._createBlurFilter("BlurV",n,t,r.v,i,!1)}_createBlurFilter(e,t,i,r,n,o){let a=new ve(e,"ssao2",["outSize","samples","soften","tolerance"],t,i,null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,r,n);return a.onApply=l=>{if(!this._scene.activeCamera)return;let c=o?this._ssaoCombinePostProcess.width:this._ssaoCombinePostProcess.height,h=o?this._originalColorPostProcess.width:this._originalColorPostProcess.height;l.setFloat("outSize",c>0?c:h),l.setInt("samples",this.bilateralSamples),l.setFloat("soften",this.bilateralSoften),l.setFloat("tolerance",this.bilateralTolerance),this._geometryBufferRenderer?l.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&l.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)])},a.samples=this.textureSamples,a.autoClear=!1,a}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(this._bits[0]&1431655765)<<1|(this._bits[0]&2863311530)>>>1>>>0,this._bits[0]=(this._bits[0]&858993459)<<2|(this._bits[0]&3435973836)>>>2>>>0,this._bits[0]=(this._bits[0]&252645135)<<4|(this._bits[0]&4042322160)>>>4>>>0,this._bits[0]=(this._bits[0]&16711935)<<8|(this._bits[0]&4278255360)>>>8>>>0,this._bits[0]*23283064365386963e-26}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){let i=t*2*Math.PI,r=1-e*.85,n=Math.sqrt(1-r*r);return new p(Math.cos(i)*n,Math.sin(i)*n,r)}_generateHemisphere(){let e=this.samples,t=[],i,r=0;for(;r<e;){if(e<16)i=this._hemisphereSample_uniform(Math.random(),Math.random());else{let n=this._hammersley(r,e);i=this._hemisphereSample_uniform(n[0],n[1])}t.push(i.x,i.y,i.z),r++}return t}_getDefinesForSSAO(){return`#define SSAO
#define SAMPLES ${this.samples}
#define EPSILON ${this.epsilon.toFixed(4)}`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();let i=this._getDefinesForSSAO(),r=["randomSampler","depthSampler","normalSampler"];this._ssaoPostProcess=new ve("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],r,e,null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i,t),this._ssaoPostProcess.autoClear=!1,this._ssaoPostProcess.onApply=n=>{if(this._scene.activeCamera){if(n.setArray3("sampleSphere",this._sampleSphere),n.setFloat("randTextureTiles",32),n.setFloat("samplesFactor",1/this.samples),n.setFloat("totalStrength",this.totalStrength),n.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),n.setFloat("radius",this.radius),n.setFloat("maxZ",this.maxZ),n.setFloat("minZAspect",this.minZAspect),n.setFloat("base",this.base),n.setFloat("near",this._scene.activeCamera.minZ),this._scene.activeCamera.mode===Ce.PERSPECTIVE_CAMERA)n.setMatrix3x3("depthProjection",s.PERSPECTIVE_DEPTH_PROJECTION),n.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),n.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{let o=this._scene.getEngine().getRenderWidth()/2,a=this._scene.getEngine().getRenderHeight()/2,l=this._scene.activeCamera.orthoLeft??-o,c=this._scene.activeCamera.orthoRight??o,h=this._scene.activeCamera.orthoBottom??-a,u=this._scene.activeCamera.orthoTop??a;n.setMatrix3x3("depthProjection",s.ORTHO_DEPTH_PROJECTION),n.setFloat("xViewport",(c-l)*.5),n.setFloat("yViewport",(u-h)*.5)}n.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(n.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),n.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(n.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),n.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),n.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new QC)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new ve("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t),this._ssaoCombinePostProcess.onApply=i=>{let r=this._scene.activeCamera.viewport;i.setVector4("viewport",O.Vector4[0].copyFromFloats(r.x,r.y,r.width,r.height)),i.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.autoClear=!1,this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){let t=new Uint8Array(65536),i=j.Zero();for(let n=0;n<t.length;)i.set(xe.RandomRange(0,1),xe.RandomRange(0,1)).normalize().scaleInPlace(255),t[n++]=Math.floor(i.x),t[n++]=Math.floor(i.y),t[n++]=0,t[n++]=255;let r=xi.CreateRGBATexture(t,128,128,this._scene,!1,!1,2);r.name="SSAORandomTexture",r.wrapU=z.WRAP_ADDRESSMODE,r.wrapV=z.WRAP_ADDRESSMODE,this._randomTexture=r}serialize(){let e=ae.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return ae.Parse(()=>new s(e._name,t,e._ratio,void 0,e._forceGeometryBuffer,e._textureType),e,t,i)}};yr.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1];yr.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1];v([I()],yr.prototype,"totalStrength",void 0);v([I()],yr.prototype,"maxZ",void 0);v([I()],yr.prototype,"minZAspect",void 0);v([I("epsilon")],yr.prototype,"_epsilon",void 0);v([I("samples")],yr.prototype,"_samples",void 0);v([I("textureSamples")],yr.prototype,"_textureSamples",void 0);v([I()],yr.prototype,"_forceGeometryBuffer",void 0);v([I()],yr.prototype,"_ratio",void 0);v([I()],yr.prototype,"_textureType",void 0);v([I()],yr.prototype,"radius",void 0);v([I()],yr.prototype,"base",void 0);v([I("bypassBlur")],yr.prototype,"_bypassBlur",void 0);v([I("expensiveBlur")],yr.prototype,"_expensiveBlur",void 0);v([I()],yr.prototype,"bilateralSamples",void 0);v([I()],yr.prototype,"bilateralSoften",void 0);v([I()],yr.prototype,"bilateralTolerance",void 0);P("BABYLON.SSAO2RenderingPipeline",yr);var f9="ssaoPixelShader",p9=`uniform sampler2D textureSampler;varying vec2 vUV;
#ifdef SSAO
uniform sampler2D randomSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float radius;uniform float area;uniform float fallOff;uniform float base;vec3 normalFromDepth(float depth,vec2 coords)
{vec2 offset1=vec2(0.0,radius);vec2 offset2=vec2(radius,0.0);float depth1=texture2D(textureSampler,coords+offset1).r;float depth2=texture2D(textureSampler,coords+offset2).r;vec3 p1=vec3(offset1,depth1-depth);vec3 p2=vec3(offset2,depth2-depth);vec3 normal=cross(p1,p2);normal.z=-normal.z;return normalize(normal);}
void main()
{vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);float depth=texture2D(textureSampler,vUV).r;vec3 position=vec3(vUV,depth);vec3 normal=normalFromDepth(depth,vUV);float radiusDepth=radius/depth;float occlusion=0.0;vec3 ray;vec3 hemiRay;float occlusionDepth;float difference;for (int i=0; i<SAMPLES; i++)
{ray=radiusDepth*reflect(sampleSphere[i],random);hemiRay=position+sign(dot(ray,normal))*ray;occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;difference=depth-occlusionDepth;occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));}
float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor.r=result;gl_FragColor.g=result;gl_FragColor.b=result;gl_FragColor.a=1.0;}
#endif
`;D.ShadersStore[f9]=p9;var Bh=class extends ys{get scene(){return this._scene}constructor(e,t,i,r){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();let n=i.ssaoRatio||i,o=i.combineRatio||i;this._originalColorPostProcess=new qr("SSAOOriginalSceneColor",o,null,z.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(n),this._createBlurPostProcess(n),this._createSSAOCombinePostProcess(o),this.addEffect(new ot(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new ot(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new ot(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new ot(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new ot(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}_attachCameras(e,t){super._attachCameras(e,t);for(let i of this._cameras)this._scene.enableDepthRenderer(i).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let t=0;t<this._scene.cameras.length;t++){let i=this._scene.cameras[t];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new Ci("BlurH",new j(1,0),16,e,null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new Ci("BlurV",new j(0,1),16,e,null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add(()=>{let i=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*i}),this._blurVPostProcess.onActivateObservable.add(()=>{let i=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*i})}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){let i=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271],r=1/16;this._ssaoPostProcess=new ve("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define SAMPLES 16
#define SSAO`),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=n=>{this._firstUpdate&&(n.setArray3("sampleSphere",i),n.setFloat("samplesFactor",r),n.setFloat("randTextureTiles",4)),n.setFloat("totalStrength",this.totalStrength),n.setFloat("radius",this.radius),n.setFloat("area",this.area),n.setFloat("fallOff",this.fallOff),n.setFloat("base",this.base),n.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),n.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new ve("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,z.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=t=>{t.setVector4("viewport",O.Vector4[0].copyFromFloats(0,0,1,1)),t.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){let t=new Uint8Array(1048576);for(let r=0;r<t.length;)t[r++]=Math.floor(Math.max(0,xe.RandomRange(-1,1))*255),t[r++]=Math.floor(Math.max(0,xe.RandomRange(-1,1))*255),t[r++]=Math.floor(Math.max(0,xe.RandomRange(-1,1))*255),t[r++]=255;let i=xi.CreateRGBATexture(t,512,512,this._scene,!1,!1,2);i.name="SSAORandomTexture",i.wrapU=z.WRAP_ADDRESSMODE,i.wrapV=z.WRAP_ADDRESSMODE,this._randomTexture=i}};v([I()],Bh.prototype,"totalStrength",void 0);v([I()],Bh.prototype,"radius",void 0);v([I()],Bh.prototype,"area",void 0);v([I()],Bh.prototype,"fallOff",void 0);v([I()],Bh.prototype,"base",void 0);var KC=class{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}};var m9="screenSpaceReflectionPixelShader",g9=`uniform sampler2D textureSampler;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;
#endif
uniform mat4 view;uniform mat4 projection;uniform float stepSize;uniform float strength;uniform float threshold;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;varying vec2 vUV;
#ifdef SSR_SUPPORTED
struct ReflectionInfo {vec3 color;vec4 coords;};/**
* According to specular,see https:
*/
vec3 fresnelSchlick(float cosTheta,vec3 F0)
{return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);}
/**
* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit
* by sampling multiple reflection pixels.
*/
ReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)
{ReflectionInfo info;info.color=vec3(0.0);vec4 projectedCoord;float sampledDepth;for(int i=0; i<SMOOTH_STEPS; i++)
{projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;dir*=0.5;if(depth>0.0)
hitCoord-=dir;else
hitCoord+=dir;info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;}
projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;info.color/=float(SMOOTH_STEPS+1);return info;}
/**
* Tests the given world position (hitCoord) according to the given reflection vector (dir)
* until it finds a collision (means that depth is enough close to say "it's the pixel to sample!").
*/
ReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)
{ReflectionInfo info;vec4 projectedCoord;float sampledDepth;dir*=stepSize;for(int i=0; i<REFLECTION_SAMPLES; i++)
{hitCoord+=dir;projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;
#ifdef RIGHT_HANDED_SCENE
depth*=-1.0;
#endif
if(((depth-dir.z)<threshold) && depth<=0.0)
{
#ifdef ENABLE_SMOOTH_REFLECTIONS
return smoothReflectionInfo(dir,hitCoord);
#else
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;
#endif
}}
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;}
vec3 hash(vec3 a)
{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}
#endif
void main()
{
#ifdef SSR_SUPPORTED
vec4 albedoFull=texture2D(textureSampler,vUV);vec3 albedo=albedoFull.rgb;float spec=texture2D(reflectivitySampler,vUV).r;if (spec==0.0) {gl_FragColor=albedoFull;return;}
vec3 normal=(texture2D(normalSampler,vUV)).xyz;vec3 position=(view*texture2D(positionSampler,vUV)).xyz;vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));float roughness=1.0-texture2D(reflectivitySampler,vUV).a;vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;ReflectionInfo info=getReflectionInfo(jitt+reflected,position);vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);vec3 F0=vec3(0.04);F0 =mix(F0,albedo,spec);vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);
#ifdef RIGHT_HANDED_SCENE
reflected.z*=-1.0;
#endif
float reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);float albedoMultiplier=1.0-reflectionMultiplier;vec3 SSR=info.color*fresnel;gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;D.ShadersStore[m9]=g9;var Pn=class s extends ve{get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}constructor(e,t,i,r,n,o,a,l=0,c=!1,h=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],i,r,n,o,a,`#define SSR_SUPPORTED
#define REFLECTION_SAMPLES 64
#define SMOOTH_STEPS 5
`,l,void 0,null,c),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=h,this._forceGeometryBuffer){let u=t.enableGeometryBufferRenderer();u&&u.isSupported&&(u.enablePosition=!0,u.enableReflectivity=!0,u.generateNormalsInWorldSpace&&F.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"))}else{let u=t.enablePrePassRenderer();u?.markAsDirty(),u?.generateNormalsInWorldSpace&&F.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the prepass renderer!"),this._prePassEffectConfiguration=new KC}this._updateEffectDefines(),this.onApply=u=>{let d=this._geometryBufferRenderer,f=this._prePassRenderer;if(!f&&!d)return;if(d){let x=d.getTextureIndex(Xr.POSITION_TEXTURE_TYPE),b=d.getTextureIndex(Xr.REFLECTIVITY_TEXTURE_TYPE);u.setTexture("normalSampler",d.getGBuffer().textures[1]),u.setTexture("positionSampler",d.getGBuffer().textures[x]),u.setTexture("reflectivitySampler",d.getGBuffer().textures[b])}else if(f){let x=f.getIndex(1),b=f.getIndex(3),C=f.getIndex(6);u.setTexture("normalSampler",f.getRenderTarget().textures[C]),u.setTexture("positionSampler",f.getRenderTarget().textures[x]),u.setTexture("reflectivitySampler",f.getRenderTarget().textures[b])}let m=t.activeCamera;if(!m)return;let g=m.getViewMatrix(!0),_=m.getProjectionMatrix(!0);u.setMatrix("projection",_),u.setMatrix("view",g),u.setFloat("threshold",this.threshold),u.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),u.setFloat("strength",this.strength),u.setFloat("stepSize",this.step),u.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){let e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples>>0)),e.push("#define SMOOTH_STEPS "+(this._smoothSteps>>0)),this.updateEffect(e.join(`
`))}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}};v([I()],Pn.prototype,"threshold",void 0);v([I()],Pn.prototype,"strength",void 0);v([I()],Pn.prototype,"reflectionSpecularFalloffExponent",void 0);v([I()],Pn.prototype,"step",void 0);v([I()],Pn.prototype,"roughnessFactor",void 0);v([I()],Pn.prototype,"enableSmoothReflections",null);v([I()],Pn.prototype,"reflectionSamples",null);v([I()],Pn.prototype,"smoothSteps",null);P("BABYLON.ScreenSpaceReflectionPostProcess",Pn);var _9="standardPixelShader",x9=`uniform sampler2D textureSampler;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
#if defined(PASS_POST_PROCESS)
void main(void)
{vec4 color=texture2D(textureSampler,vUV);gl_FragColor=color;}
#endif
#if defined(DOWN_SAMPLE_X4)
uniform vec2 dsOffsets[16];void main(void)
{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+dsOffsets[0]);average+=texture2D(textureSampler,vUV+dsOffsets[1]);average+=texture2D(textureSampler,vUV+dsOffsets[2]);average+=texture2D(textureSampler,vUV+dsOffsets[3]);average+=texture2D(textureSampler,vUV+dsOffsets[4]);average+=texture2D(textureSampler,vUV+dsOffsets[5]);average+=texture2D(textureSampler,vUV+dsOffsets[6]);average+=texture2D(textureSampler,vUV+dsOffsets[7]);average+=texture2D(textureSampler,vUV+dsOffsets[8]);average+=texture2D(textureSampler,vUV+dsOffsets[9]);average+=texture2D(textureSampler,vUV+dsOffsets[10]);average+=texture2D(textureSampler,vUV+dsOffsets[11]);average+=texture2D(textureSampler,vUV+dsOffsets[12]);average+=texture2D(textureSampler,vUV+dsOffsets[13]);average+=texture2D(textureSampler,vUV+dsOffsets[14]);average+=texture2D(textureSampler,vUV+dsOffsets[15]);average/=16.0;gl_FragColor=average;}
#endif
#if defined(BRIGHT_PASS)
uniform vec2 dsOffsets[4];uniform float brightThreshold;void main(void)
{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));average*=0.25;float luminance=length(average.rgb);if (luminance<brightThreshold) {average=vec4(0.0,0.0,0.0,1.0);}
gl_FragColor=average;}
#endif
#if defined(TEXTURE_ADDER)
uniform sampler2D otherSampler;uniform sampler2D lensSampler;uniform float exposure;void main(void)
{vec3 colour=texture2D(textureSampler,vUV).rgb;colour*=exposure;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;colour+=colour*texture2D(lensSampler,vUV).rgb;vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);gl_FragColor=finalColor;}
#endif
#if defined(VLS)
#define PI 3.1415926535897932384626433832795
uniform mat4 shadowViewProjection;uniform mat4 lightWorld;uniform vec3 cameraPosition;uniform vec3 sunDirection;uniform vec3 sunColor;uniform vec2 depthValues;uniform float scatteringCoefficient;uniform float scatteringPower;uniform sampler2D shadowMapSampler;uniform sampler2D positionSampler;float computeScattering(float lightDotView)
{float result=1.0-scatteringCoefficient*scatteringCoefficient;result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));return result;}
void main(void)
{vec3 worldPos=texture2D(positionSampler,vUV).rgb;vec3 startPosition=cameraPosition;vec3 rayVector=worldPos-startPosition;float rayLength=length(rayVector);vec3 rayDirection=rayVector/rayLength;float stepLength=rayLength/NB_STEPS;vec3 stepL=rayDirection*stepLength;vec3 currentPosition=startPosition;vec3 accumFog=vec3(0.0);for (int i=0; i<int(NB_STEPS); i++)
{vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);float depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depthMetric,0.0,1.0);worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;if (shadowMapValue>shadowPixelDepth)
accumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));currentPosition+=stepL;}
accumFog/=NB_STEPS;vec3 color=accumFog*scatteringPower;gl_FragColor=vec4(color*exp(color) ,1.0);}
#endif
#if defined(VLSMERGE)
uniform sampler2D originalSampler;void main(void)
{gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);}
#endif
#if defined(LUMINANCE)
uniform vec2 lumOffsets[4];void main()
{float average=0.0;vec4 color=vec4(0.0);float maximum=-1e20;vec3 weight=vec3(0.299,0.587,0.114);for (int i=0; i<4; i++)
{color=texture2D(textureSampler,vUV+ lumOffsets[i]);float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));
#ifdef WEIGHTED_AVERAGE
float GreyValue=dot(color.rgb,weight);
#endif
#ifdef BRIGHTNESS
float GreyValue=max(color.r,max(color.g,color.b));
#endif
#ifdef HSL_COMPONENT
float GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));
#endif
#ifdef MAGNITUDE
float GreyValue=length(color.rgb);
#endif
maximum=max(maximum,GreyValue);average+=(0.25*log(1e-5+GreyValue));}
average=exp(average);gl_FragColor=vec4(average,maximum,0.0,1.0);}
#endif
#if defined(LUMINANCE_DOWN_SAMPLE)
uniform vec2 dsOffsets[9];uniform float halfDestPixelSize;
#ifdef FINAL_DOWN_SAMPLER
#include<packingFunctions>
#endif
void main()
{vec4 color=vec4(0.0);float average=0.0;for (int i=0; i<9; i++)
{color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);average+=color.r;}
average/=9.0;
#ifdef FINAL_DOWN_SAMPLER
gl_FragColor=pack(average);
#else
gl_FragColor=vec4(average,average,0.0,1.0);
#endif
}
#endif
#if defined(HDR)
uniform sampler2D textureAdderSampler;uniform float averageLuminance;void main()
{vec4 color=texture2D(textureAdderSampler,vUV);
#ifndef AUTO_EXPOSURE
vec4 adjustedColor=color/averageLuminance;color=adjustedColor;color.a=1.0;
#endif
gl_FragColor=color;}
#endif
#if defined(LENS_FLARE)
#define GHOSTS 3
uniform sampler2D lensColorSampler;uniform float strength;uniform float ghostDispersal;uniform float haloWidth;uniform vec2 resolution;uniform float distortionStrength;float hash(vec2 p)
{float h=dot(p,vec2(127.1,311.7));return -1.0+2.0*fract(sin(h)*43758.5453123);}
float noise(in vec2 p)
{vec2 i=floor(p);vec2 f=fract(p);vec2 u=f*f*(3.0-2.0*f);return mix(mix(hash(i+vec2(0.0,0.0)),
hash(i+vec2(1.0,0.0)),u.x),
mix(hash(i+vec2(0.0,1.0)),
hash(i+vec2(1.0,1.0)),u.x),u.y);}
float fbm(vec2 p)
{float f=0.0;f+=0.5000*noise(p); p*=2.02;f+=0.2500*noise(p); p*=2.03;f+=0.1250*noise(p); p*=2.01;f+=0.0625*noise(p); p*=2.04;f/=0.9375;return f;}
vec3 pattern(vec2 uv)
{vec2 p=-1.0+2.0*uv;float p2=dot(p,p);float f=fbm(vec2(15.0*p2))/2.0;float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));return (1.0-f)*vec3(r,g,b);}
float luminance(vec3 color)
{return dot(color.rgb,vec3(0.2126,0.7152,0.0722));}
vec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)
{return vec4(
texture2D(tex,texcoord+direction*distortion.r).r,
texture2D(tex,texcoord+direction*distortion.g).g,
texture2D(tex,texcoord+direction*distortion.b).b,
1.0
);}
void main(void)
{vec2 uv=-vUV+vec2(1.0);vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;vec2 texelSize=1.0/resolution;vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);vec4 result=vec4(0.0);float ghostIndice=1.0;for (int i=0; i<GHOSTS; ++i)
{vec2 offset=fract(uv+ghostDir*ghostIndice);float weight=length(vec2(0.5)-offset)/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;ghostIndice+=1.0;}
vec2 haloVec=normalize(ghostDir)*haloWidth;float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));gl_FragColor=result;}
#endif
#if defined(LENS_FLARE_COMPOSE)
uniform sampler2D otherSampler;uniform sampler2D lensDirtSampler;uniform sampler2D lensStarSampler;uniform mat4 lensStarMatrix;void main(void)
{vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;vec4 lensMod=texture2D(lensDirtSampler,vUV);lensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);vec4 result=texture2D(textureSampler,vUV)*lensMod;gl_FragColor=texture2D(otherSampler,vUV)+result;}
#endif
#if defined(DEPTH_OF_FIELD)
uniform sampler2D otherSampler;uniform sampler2D depthSampler;uniform float distance;void main(void)
{vec4 sharp=texture2D(otherSampler,vUV);vec4 blur=texture2D(textureSampler,vUV);float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);float factor=0.0;if (dist<0.05)
factor=1.0;else if (dist<0.1)
factor=20.0*(0.1-dist);else if (dist<0.5)
factor=0.0;else
factor=2.0*(dist-0.5);factor=clamp(factor,0.0,0.90);gl_FragColor=mix(sharp,blur,factor);}
#endif
#if defined(MOTION_BLUR)
uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform vec2 screenSize;uniform float motionScale;uniform float motionStrength;uniform sampler2D depthSampler;void main(void)
{vec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=cpos*inverseViewProjection;vec4 ppos=cpos*prevViewProjection;ppos.xyz/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {if (i>=nSamples)
break;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);result+=texture2D(textureSampler,offset1);}
gl_FragColor=result/float(nSamples);}
#endif
`;D.ShadersStore[_9]=x9;var Wt=class s extends ys{get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){let t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join(`
`))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){let t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer()){F.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");return}this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect(`#define VLS
#define NB_STEPS `+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect(`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,i,r=null,n){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=n||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=r,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){let e=this._ratio,t=this._scene;this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new Pn("HDRPass",t,e,null,z.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess}),this.addEffect(new ot(t.getEngine(),"HDRScreenSpaceReflections",()=>this.screenSpaceReflectionPostProcess,!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new ve("HDRPass","standard",[],[],e,null,z.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.originalPostProcess}),this.addEffect(new ot(t.getEngine(),"HDRPassPostProcess",()=>this.originalPostProcess,!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new ve("HDRDepthOfFieldSource","standard",[],[],e,null,z.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new ot(t.getEngine(),"HDRBaseDepthOfFieldSource",()=>this.textureAdderFinalPostProcess,!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new ve("HDRVLSFinal","standard",[],[],e,null,z.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new ot(t.getEngine(),"HDRVLSFinal",()=>this.volumetricLightFinalPostProcess,!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new ve("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,z.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new ot(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",()=>this.lensFlareFinalPostProcess,!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new ve("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,z.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new ot(t.getEngine(),"HDRPostHDReDepthOfFieldSource",()=>this.hdrFinalPostProcess,!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new ml("fxaa",1,null,z.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new ot(t.getEngine(),"HDRFxaa",()=>this.fxaaPostProcess,!0))),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&F.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){let i=new Array(32);this.downSampleX4PostProcess=new ve("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=r=>{let n=0,o=this.downSampleX4PostProcess.width,a=this.downSampleX4PostProcess.height;for(let l=-2;l<2;l++)for(let c=-2;c<2;c++)i[n]=(l+.5)*(1/o),i[n+1]=(c+.5)*(1/a),n+=2;r.setArray2("dsOffsets",i)},this.addEffect(new ot(e.getEngine(),"HDRDownSampleX4",()=>this.downSampleX4PostProcess,!0))}_createBrightPassPostProcess(e,t){let i=new Array(8);this.brightPassPostProcess=new ve("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=r=>{let n=1/this.brightPassPostProcess.width,o=1/this.brightPassPostProcess.height;i[0]=-.5*n,i[1]=.5*o,i[2]=.5*n,i[3]=.5*o,i[4]=-.5*n,i[5]=-.5*o,i[6]=.5*n,i[7]=-.5*o,r.setArray2("dsOffsets",i),r.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new ot(e.getEngine(),"HDRBrightPass",()=>this.brightPassPostProcess,!0))}_createBlurPostProcesses(e,t,i,r="blurWidth"){let n=e.getEngine(),o=new Ci("HDRBlurH_"+i,new j(1,0),this[r],t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),a=new Ci("HDRBlurV_"+i,new j(0,1),this[r],t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);o.onActivateObservable.add(()=>{let l=o.width/n.getRenderWidth();o.kernel=this[r]*l}),a.onActivateObservable.add(()=>{let l=a.height/n.getRenderHeight();a.kernel=this.horizontalBlur?64*l:this[r]*l}),this.addEffect(new ot(e.getEngine(),"HDRBlurH"+i,()=>o,!0)),this.addEffect(new ot(e.getEngine(),"HDRBlurV"+i,()=>a,!0)),this.blurHPostProcesses.push(o),this.blurVPostProcesses.push(a)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new ve("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=i=>{i.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),i.setTexture("lensSampler",this.lensTexture),i.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new ot(e.getEngine(),"HDRTextureAdder",()=>this.textureAdderPostProcess,!0))}_createVolumetricLightPostProcess(e,t){let i=e.enableGeometryBufferRenderer();i.enablePosition=!0;let r=i.getGBuffer();this.volumetricLightPostProcess=new ve("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,`#define VLS
#define NB_STEPS `+this._volumetricLightStepsCount.toFixed(1));let n=j.Zero();this.volumetricLightPostProcess.onApply=o=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){let a=this.sourceLight.getShadowGenerator();o.setTexture("shadowMapSampler",a.getShadowMap()),o.setTexture("positionSampler",r.textures[2]),o.setColor3("sunColor",this.sourceLight.diffuse),o.setVector3("sunDirection",this.sourceLight.getShadowDirection()),o.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),o.setMatrix("shadowViewProjection",a.getTransformMatrix()),o.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),o.setFloat("scatteringPower",this.volumetricLightPower),n.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),n.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),o.setVector2("depthValues",n)}},this.addEffect(new ot(e.getEngine(),"HDRVLS",()=>this.volumetricLightPostProcess,!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new ve("HDRVLSMerge","standard",[],["originalSampler"],t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=o=>{o.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new ot(e.getEngine(),"HDRVLSMerge",()=>this.volumetricLightMergePostProces,!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,s.LuminanceSteps);this.luminancePostProcess=new ve("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);let r=[];this.luminancePostProcess.onApply=o=>{let a=1/this.luminancePostProcess.width,l=1/this.luminancePostProcess.height;r[0]=-.5*a,r[1]=.5*l,r[2]=.5*a,r[3]=.5*l,r[4]=-.5*a,r[5]=-.5*l,r[6]=.5*a,r[7]=-.5*l,o.setArray2("lumOffsets",r)},this.addEffect(new ot(e.getEngine(),"HDRLuminance",()=>this.luminancePostProcess,!0));for(let o=s.LuminanceSteps-1;o>=0;o--){i=Math.pow(3,o);let a=`#define LUMINANCE_DOWN_SAMPLE
`;o===0&&(a+="#define FINAL_DOWN_SAMPLER");let l=new ve("HDRLuminanceDownSample"+o,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,a,t);this.luminanceDownSamplePostProcesses.push(l)}let n=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach((o,a)=>{let l=new Array(18);o.onApply=c=>{if(!n)return;let h=0;for(let u=-1;u<2;u++)for(let d=-1;d<2;d++)l[h]=u/n.width,l[h+1]=d/n.height,h+=2;c.setArray2("dsOffsets",l),c.setFloat("halfDestPixelSize",.5/n.width),a===this.luminanceDownSamplePostProcesses.length-1?n=this.luminancePostProcess:n=o},a===this.luminanceDownSamplePostProcesses.length-1&&(o.onAfterRender=()=>{let c=e.getEngine().readPixels(0,0,1,1),h=new De(1/(255*255*255),1/(255*255),1/255,1);c.then(u=>{let d=new Uint8Array(u.buffer);this._hdrCurrentLuminance=(d[0]*h.x+d[1]*h.y+d[2]*h.z+d[3]*h.w)/100})}),this.addEffect(new ot(e.getEngine(),"HDRLuminanceDownSample"+a,()=>o,!0))})}_createHdrPostProcess(e,t){let i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new ve("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join(`
`),0);let r=1,n=0,o=0;this.hdrPostProcess.onApply=a=>{if(a.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),n+=e.getEngine().getDeltaTime(),r<0)r=this._hdrCurrentLuminance;else{let l=(o-n)/1e3;this._hdrCurrentLuminance<r+this.hdrDecreaseRate*l?r+=this.hdrDecreaseRate*l:this._hdrCurrentLuminance>r-this.hdrIncreaseRate*l?r-=this.hdrIncreaseRate*l:r=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/r:(r=xe.Clamp(r,this.hdrMinimumLuminance,1e20),a.setFloat("averageLuminance",r)),o=n,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new ot(e.getEngine(),"HDR",()=>this.hdrPostProcess,!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new ve("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new ot(e.getEngine(),"HDRLensFlare",()=>this.lensFlarePostProcess,!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new ve("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new ot(e.getEngine(),"HDRLensFlareCompose",()=>this.lensFlareComposePostProcess,!0));let i=new j(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=o=>{o.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),o.setTexture("lensColorSampler",this.lensColorTexture),o.setFloat("strength",this.lensFlareStrength),o.setFloat("ghostDispersal",this.lensFlareGhostDispersal),o.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,o.setVector2("resolution",i),o.setFloat("distortionStrength",this.lensFlareDistortionStrength)};let r=N.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),n=N.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=o=>{if(!this._scene.activeCamera)return;o.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),o.setTexture("lensDirtSampler",this.lensFlareDirtTexture),o.setTexture("lensStarSampler",this.lensStarTexture);let a=this._scene.activeCamera.getViewMatrix().getRow(0),l=this._scene.activeCamera.getViewMatrix().getRow(2),c=p.Dot(a.toVector3(),new p(1,0,0))+p.Dot(l.toVector3(),new p(0,0,1));c*=4;let h=N.FromValues(Math.cos(c)*.5,-Math.sin(c),0,0,Math.sin(c),Math.cos(c)*.5,0,0,0,0,1,0,0,0,0,1),u=n.multiply(h).multiply(r);o.setMatrix("lensStarMatrix",u),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new ve("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=i=>{i.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),i.setTexture("depthSampler",this._getDepthTexture()),i.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new ot(e.getEngine(),"HDRDepthOfField",()=>this.depthOfFieldPostProcess,!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){let i=new cc("HDRMotionBlur",e,t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new ve("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,z.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+this.motionBlurSamples.toFixed(1),0);let i=0,r=N.Identity(),n=N.Identity(),o=N.Identity(),a=j.Zero();this.motionBlurPostProcess.onApply=l=>{o=e.getProjectionMatrix().multiply(e.getViewMatrix()),o.invertToRef(n),l.setMatrix("inverseViewProjection",n),l.setMatrix("prevViewProjection",r),r=o,a.x=this.motionBlurPostProcess.width,a.y=this.motionBlurPostProcess.height,l.setVector2("screenSize",a),i=e.getEngine().getFps()/60,l.setFloat("motionScale",i),l.setFloat("motionStrength",this.motionStrength),l.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new ot(e.getEngine(),"HDRMotionBlur",()=>this.motionBlurPostProcess,!0))}_getDepthTexture(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){let t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let i=0;i<this.luminanceDownSamplePostProcesses.length;i++)this.luminanceDownSamplePostProcesses[i].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let i=0;i<this.blurHPostProcesses.length;i++)this.blurHPostProcesses[i].dispose(t);for(let i=0;i<this.blurVPostProcesses.length;i++)this.blurVPostProcesses[i].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){let e=ae.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=ae.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){let r=ae.Parse(()=>new s(e._name,t,e._ratio),e,t,i);return e.sourceLightId&&(r.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&ae.Parse(()=>r.screenSpaceReflectionPostProcess,e.screenSpaceReflectionPostProcess,t,i),r}};Wt.LuminanceSteps=6;v([I()],Wt.prototype,"brightThreshold",void 0);v([I()],Wt.prototype,"blurWidth",void 0);v([I()],Wt.prototype,"horizontalBlur",void 0);v([I()],Wt.prototype,"exposure",null);v([Qe("lensTexture")],Wt.prototype,"lensTexture",void 0);v([I()],Wt.prototype,"volumetricLightCoefficient",void 0);v([I()],Wt.prototype,"volumetricLightPower",void 0);v([I()],Wt.prototype,"volumetricLightBlurScale",void 0);v([I()],Wt.prototype,"hdrMinimumLuminance",void 0);v([I()],Wt.prototype,"hdrDecreaseRate",void 0);v([I()],Wt.prototype,"hdrIncreaseRate",void 0);v([I()],Wt.prototype,"hdrAutoExposure",null);v([Qe("lensColorTexture")],Wt.prototype,"lensColorTexture",void 0);v([I()],Wt.prototype,"lensFlareStrength",void 0);v([I()],Wt.prototype,"lensFlareGhostDispersal",void 0);v([I()],Wt.prototype,"lensFlareHaloWidth",void 0);v([I()],Wt.prototype,"lensFlareDistortionStrength",void 0);v([I()],Wt.prototype,"lensFlareBlurWidth",void 0);v([Qe("lensStarTexture")],Wt.prototype,"lensStarTexture",void 0);v([Qe("lensFlareDirtTexture")],Wt.prototype,"lensFlareDirtTexture",void 0);v([I()],Wt.prototype,"depthOfFieldDistance",void 0);v([I()],Wt.prototype,"depthOfFieldBlurWidth",void 0);v([I()],Wt.prototype,"motionStrength",null);v([I()],Wt.prototype,"objectBasedMotionBlur",null);v([I()],Wt.prototype,"_ratio",void 0);v([I()],Wt.prototype,"BloomEnabled",null);v([I()],Wt.prototype,"DepthOfFieldEnabled",null);v([I()],Wt.prototype,"LensFlareEnabled",null);v([I()],Wt.prototype,"HDREnabled",null);v([I()],Wt.prototype,"VLSEnabled",null);v([I()],Wt.prototype,"MotionBlurEnabled",null);v([I()],Wt.prototype,"fxaaEnabled",null);v([I()],Wt.prototype,"screenSpaceReflectionsEnabled",null);v([I()],Wt.prototype,"volumetricLightStepsCount",null);v([I()],Wt.prototype,"motionBlurSamples",null);v([I()],Wt.prototype,"samples",null);P("BABYLON.StandardRenderingPipeline",Wt);var ZC=class{constructor(){this.enabled=!1,this.name="screenSpaceReflections2",this.texturesRequired=[6,3,5]}};var v9="screenSpaceRayTrace",T9=`float distanceSquared(vec2 a,vec2 b) { a-=b; return dot(a,a); }
/**
param csOrigin Camera-space ray origin,which must be 
within the view volume and must have z>0.01 and project within the valid screen rectangle
param csDirection Unit length camera-space ray direction
param projectToPixelMatrix A projection matrix that maps to **pixel** coordinates 
(**not** [-1,+1] normalized device coordinates).
param csZBuffer The camera-space Z buffer
param csZBufferSize Dimensions of csZBuffer
param csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer
param nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value
for clipping rays headed towards the camera
param stride Step in horizontal or vertical pixels between samples. This is a float
because integer math is slow on GPUs,but should be set to an integer>=1
param jitterFraction Number between 0 and 1 for how far to bump the ray in stride units
to conceal banding artifacts,plus the stride ray offset.
param maxSteps Maximum number of iterations. Higher gives better images but may be slow
param maxRayTraceDistance Maximum camera-space distance to trace before returning a miss
param selfCollisionNumSkip Number of steps to skip at start when raytracing to avoid self collisions.
1 is a reasonable value,depending on the scene you may need to set this value to 2
param hitPixel Pixel coordinates of the first intersection with the scene
param numIterations number of iterations performed
param csHitPoint Camera space location of the ray hit
*/
#define inline
bool traceScreenSpaceRay1(
vec3 csOrigin,
vec3 csDirection,
mat4 projectToPixelMatrix,
sampler2D csZBuffer,
vec2 csZBufferSize,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
sampler2D csZBackBuffer,
float csZBackSizeFactor,
#endif
float csZThickness,
float nearPlaneZ,
float stride,
float jitterFraction,
float maxSteps,
float maxRayTraceDistance,
float selfCollisionNumSkip,
out vec2 startPixel,
out vec2 hitPixel,
out vec3 csHitPoint,
out float numIterations
#ifdef SSRAYTRACE_DEBUG
,out vec3 debugColor
#endif
)
{
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
float rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ ? (-nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;
#else
float rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ ? (nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;
#endif
vec3 csEndPoint=csOrigin+csDirection*rayLength;hitPixel=vec2(-1.0,-1.0);vec4 H0=projectToPixelMatrix*vec4(csOrigin,1.0);vec4 H1=projectToPixelMatrix*vec4(csEndPoint,1.0);float k0=1.0/H0.w;float k1=1.0/H1.w;vec3 Q0=csOrigin*k0;vec3 Q1=csEndPoint*k1;vec2 P0=H0.xy*k0;vec2 P1=H1.xy*k1;
#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM
float xMax=csZBufferSize.x-0.5,xMin=0.5,yMax=csZBufferSize.y-0.5,yMin=0.5;float alpha=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-((P1.y>yMax) ? yMax : yMin))/(P1.y-P0.y);}
if ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-((P1.x>xMax) ? xMax : xMin))/(P1.x-P0.x));}
P1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);
#endif
P1+=vec2((distanceSquared(P0,P1)<0.0001) ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) { 
permute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }
float stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=vec2(stepDirection,delta.y*invdx);vec3 dQ=(Q1-Q0)*invdx;float dk=(k1-k0)*invdx;float zMin=min(csEndPoint.z,csOrigin.z);float zMax=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;vec4 pqk=vec4(P0,Q0.z,k0);vec4 dPQK=vec4(dP,dQ.z,dk);startPixel=permute ? P0.yx : P0.xy;float prevZMaxEstimate=csOrigin.z;float rayZMin=prevZMaxEstimate,rayZMax=prevZMaxEstimate;float sceneZMax=rayZMax+1e4;float end=P1.x*stepDirection;bool hit=false;float stepCount;for (stepCount=0.0;stepCount<=selfCollisionNumSkip ||
(pqk.x*stepDirection)<=end &&
stepCount<maxSteps &&
!hit &&
sceneZMax != 0.0; 
pqk+=dPQK,++stepCount)
{hitPixel=permute ? pqk.yx : pqk.xy;rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { 
float t=rayZMin; rayZMin=rayZMax; rayZMax=t;}
sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
float sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;hit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);
#else
hit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);
#endif
#else
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
float sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;hit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);
#else
hit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);
#endif
#endif
}
pqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}
#ifdef SSRAYTRACE_ENABLE_REFINEMENT
if (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;float invStride=1.0/stride;dPQK*=invStride;float refinementStepCount=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||
(refinementStepCount<=stride*1.4) &&
(rayZMax<sceneZMax) && (sceneZMax != 0.0);pqk+=dPQK,refinementStepCount+=1.0)
{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);hitPixel=permute ? pqk.yx : pqk.xy;sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;}
pqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}
#endif
Q0.xy+=dQ.xy*stepCount;Q0.z=pqk.z;csHitPoint=Q0/pqk.w;numIterations=stepCount+1.0;
#ifdef SSRAYTRACE_DEBUG
if (((pqk.x+dPQK.x)*stepDirection)>end) {debugColor=vec3(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {debugColor=vec3(1,0,0);} else if (sceneZMax==0.0) {debugColor=vec3(1,1,0);} else {debugColor=vec3(0,stepCount/maxSteps,0);}
#endif
return hit;}
/**
texCoord: in the [0,1] range
depth: depth in view space (range [znear,zfar]])
*/
vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth,mat4 projection,mat4 invProjectionMatrix) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef ORTHOGRAPHIC_CAMERA
ndc.z=-projection[2].z*depth+projection[3].z;
#else
ndc.z=-projection[2].z-projection[3].z/depth;
#endif
#else
#ifdef ORTHOGRAPHIC_CAMERA
ndc.z=projection[2].z*depth+projection[3].z;
#else
ndc.z=projection[2].z+projection[3].z/depth;
#endif
#endif
ndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}
`;D.IncludesShadersStore[v9]=T9;var C9="screenSpaceReflection2PixelShader",b9=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)
#define TEXTURECUBEFUNC(s,c,lod) textureLod(s,c,lod)
#else
#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)
#define TEXTURECUBEFUNC(s,c,bias) textureCube(s,c,bias)
#endif
uniform sampler2D textureSampler;varying vec2 vUV;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D depthSampler;
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
uniform sampler2D backDepthSampler;uniform float backSizeFactor;
#endif
#ifdef SSR_USE_ENVIRONMENT_CUBE
uniform samplerCube envCubeSampler;
#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;
#endif
#endif
uniform mat4 view;uniform mat4 invView;uniform mat4 projection;uniform mat4 invProjectionMatrix;uniform mat4 projectionPixel;uniform float nearPlaneZ;uniform float stepSize;uniform float maxSteps;uniform float strength;uniform float thickness;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;uniform float maxDistance;uniform float selfCollisionNumSkip;uniform float reflectivityThreshold;
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<screenSpaceRayTrace>
vec3 hash(vec3 a)
{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}
float computeAttenuationForIntersection(ivec2 hitPixel,vec2 hitUV,vec3 vsRayOrigin,vec3 vsHitPoint,vec3 reflectionVector,float maxRayDistance,float numIterations) {float attenuation=1.0;
#ifdef SSR_ATTENUATE_SCREEN_BORDERS
vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);
#endif
#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE
attenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);
#endif
#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS
attenuation*=1.0-(numIterations/maxSteps);
#endif
#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION
vec3 reflectionNormal=texelFetch(normalSampler,hitPixel,0).xyz;float directionBasedAttenuation=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;
#endif
return attenuation;}
#endif
void main()
{
#ifdef SSR_SUPPORTED
vec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);vec3 color=colorFull.rgb;vec4 reflectivity=TEXTUREFUNC(reflectivitySampler,vUV,0.0);
#ifndef SSR_DISABLE_REFLECTIVITY_TEST
if (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {
#ifdef SSR_USE_BLUR
gl_FragColor=vec4(0.);
#else
gl_FragColor=colorFull;
#endif
return;}
#endif
#ifdef SSR_INPUT_IS_GAMMA_SPACE
color=toLinearSpace(color);
#endif
vec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz; 
#ifdef SSR_DECODE_NORMAL
csNormal=csNormal*2.0-1.0;
#endif
#ifdef SSR_NORMAL_IS_IN_WORLDSPACE
csNormal=(view*vec4(csNormal,0.0)).xyz;
#endif
float depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;vec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);
#ifdef ORTHOGRAPHIC_CAMERA
vec3 csViewDirection=vec3(0.,0.,1.);
#else
vec3 csViewDirection=normalize(csPosition);
#endif
vec3 csReflectedVector=reflect(csViewDirection,csNormal);
#ifdef SSR_USE_ENVIRONMENT_CUBE
vec3 wReflectedVector=vec3(invView*vec4(csReflectedVector,0.0));
#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC
vec4 worldPos=invView*vec4(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),vReflectionSize,vReflectionPosition);
#endif
#ifdef SSR_INVERTCUBICMAP
wReflectedVector.y*=-1.0;
#endif
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
wReflectedVector.z*=-1.0;
#endif
vec3 envColor=TEXTURECUBEFUNC(envCubeSampler,wReflectedVector,0.0).xyz;
#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE
envColor=toLinearSpace(envColor);
#endif
#else
vec3 envColor=color;
#endif
float reflectionAttenuation=1.0;bool rayHasHit=false;vec2 startPixel;vec2 hitPixel;vec3 hitPoint;float numIterations;
#ifdef SSRAYTRACE_DEBUG
vec3 debugColor;
#endif
#ifdef SSR_ATTENUATE_FACING_CAMERA
reflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));
#endif
if (reflectionAttenuation>0.0) {
#ifdef SSR_USE_BLUR
vec3 jitt=vec3(0.);
#else
float roughness=1.0-reflectivity.a;vec3 jitt=mix(vec3(0.0),hash(csPosition)-vec3(0.5),roughness)*roughnessFactor; 
#endif
vec2 uv2=vUV*texSize;float c=(uv2.x+uv2.y)*0.25;float jitter=mod(c,1.0); 
rayHasHit=traceScreenSpaceRay1(
csPosition,
normalize(csReflectedVector+jitt),
projectionPixel,
depthSampler,
texSize,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
backDepthSampler,
backSizeFactor,
#endif
thickness,
nearPlaneZ,
stepSize,
jitter,
maxSteps,
maxDistance,
selfCollisionNumSkip,
startPixel,
hitPixel,
hitPoint,
numIterations
#ifdef SSRAYTRACE_DEBUG
,debugColor
#endif
);}
#ifdef SSRAYTRACE_DEBUG
gl_FragColor=vec4(debugColor,1.);return;
#endif
vec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 SSR=envColor;if (rayHasHit) {vec3 reflectedColor=texelFetch(textureSampler,ivec2(hitPixel),0).rgb;
#ifdef SSR_INPUT_IS_GAMMA_SPACE
reflectedColor=toLinearSpace(reflectedColor);
#endif
reflectionAttenuation*=computeAttenuationForIntersection(ivec2(hitPixel),hitPixel/texSize,csPosition,hitPoint,csReflectedVector,maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}
#ifndef SSR_BLEND_WITH_FRESNEL
SSR*=fresnel;
#endif
#ifdef SSR_USE_BLUR
float blur_radius=0.0;float roughness=1.0-reflectivity.a*(1.0-roughnessFactor);if (roughness>0.001) {float cone_angle=min(roughness,0.999)*3.14159265*0.5;float cone_len=distance(startPixel,hitPixel);float op_len=2.0*tan(cone_angle)*cone_len; 
float a=op_len;float h=cone_len;float a2=a*a;float fh2=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}
gl_FragColor=vec4(SSR,blur_radius/255.0); 
#else
#ifdef SSR_BLEND_WITH_FRESNEL
vec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#else
vec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#endif
vec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color*colorMultiplier)+(SSR*reflectionMultiplier);
#ifdef SSR_OUTPUT_IS_GAMMA_SPACE
finalColor=toGammaSpace(finalColor);
#endif
gl_FragColor=vec4(finalColor,colorFull.a);
#endif
#else
gl_FragColor=TEXTUREFUNC(textureSampler,vUV,0.0);
#endif
}
`;D.ShadersStore[C9]=b9;var S9="screenSpaceReflection2BlurPixelShader",y9=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)
#else
#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)
#endif
uniform sampler2D textureSampler;varying vec2 vUV;uniform vec2 texelOffsetScale;const float weights[8]=float[8] (0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);void processSample(vec2 uv,float i,vec2 stepSize,inout vec4 accumulator,inout float denominator)
{vec2 offsetUV=stepSize*i+uv;float coefficient=weights[int(2.0-abs(i))];accumulator+=TEXTUREFUNC(textureSampler,offsetUV,0.0)*coefficient;denominator+=coefficient;}
void main()
{vec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);if (dot(colorFull,vec4(1.0))==0.0) {gl_FragColor=colorFull;return;}
float blurRadius=colorFull.a*255.0; 
vec2 stepSize=texelOffsetScale.xy*blurRadius;vec4 accumulator=TEXTUREFUNC(textureSampler,vUV,0.0)*0.214607;float denominator=0.214607;processSample(vUV,1.0,stepSize,accumulator,denominator);processSample(vUV,1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,1.0*2.0,stepSize,accumulator,denominator);processSample(vUV,-1.0,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*2.0,stepSize,accumulator,denominator);gl_FragColor=vec4(accumulator.rgb/denominator,colorFull.a);}
`;D.ShadersStore[S9]=y9;var E9="screenSpaceReflection2BlurCombinerPixelShader",A9=`uniform sampler2D textureSampler; 
uniform sampler2D mainSampler;uniform sampler2D reflectivitySampler;uniform float strength;uniform float reflectionSpecularFalloffExponent;uniform float reflectivityThreshold;varying vec2 vUV;
#include<helperFunctions>
#ifdef SSR_BLEND_WITH_FRESNEL
#include<pbrBRDFFunctions>
#include<screenSpaceRayTrace>
uniform mat4 projection;uniform mat4 invProjectionMatrix;uniform sampler2D normalSampler;uniform sampler2D depthSampler;
#endif
void main()
{
#ifdef SSRAYTRACE_DEBUG
gl_FragColor=texture2D(textureSampler,vUV);
#else
vec3 SSR=texture2D(textureSampler,vUV).rgb;vec4 color=texture2D(mainSampler,vUV);vec4 reflectivity=texture2D(reflectivitySampler,vUV);
#ifndef SSR_DISABLE_REFLECTIVITY_TEST
if (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {gl_FragColor=color;return;}
#endif
#ifdef SSR_INPUT_IS_GAMMA_SPACE
color=toLinearSpace(color);
#endif
#ifdef SSR_BLEND_WITH_FRESNEL
vec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz;float depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;vec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);vec3 csViewDirection=normalize(csPosition);vec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#else
vec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#endif
vec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);
#ifdef SSR_OUTPUT_IS_GAMMA_SPACE
finalColor=toGammaSpace(finalColor);
#endif
gl_FragColor=vec4(finalColor,color.a);
#endif
}
`;D.ShadersStore[E9]=A9;var I9=N.Compose(new p(.5,.5,.5),q.Identity(),new p(.5,.5,.5)),R9=N.Compose(new p(.5,.5,1),q.Identity(),new p(.5,.5,0)),ui=class s extends ys{set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(e===0&&this._reflectivityThreshold!==0||e!==0&&this._reflectivityThreshold===0?(this._reflectivityThreshold=e,this._buildPipeline()):this._reflectivityThreshold=e)}get ssrDownsample(){return this._ssrDownsample}set ssrDownsample(e){e!==this._ssrDownsample&&(this._ssrDownsample=e,this._buildPipeline())}get blurDispersionStrength(){return this._blurDispersionStrength}set blurDispersionStrength(e){if(e===this._blurDispersionStrength)return;let t=e===0&&this._blurDispersionStrength!==0||e!==0&&this._blurDispersionStrength===0;this._blurDispersionStrength=e,t&&this._buildPipeline()}_useBlur(){return this._blurDispersionStrength>0}get blurDownsample(){return this._blurDownsample}set blurDownsample(e){e!==this._blurDownsample&&(this._blurDownsample=e,this._buildPipeline())}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateIntersectionIterations(){return this._attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._attenuateIntersectionIterations!==e&&(this._attenuateIntersectionIterations=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._buildPipeline())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._buildPipeline())}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureDownsample(){return this._backfaceDepthTextureDownsample}set backfaceDepthTextureDownsample(e){this._backfaceDepthTextureDownsample!==e&&(this._backfaceDepthTextureDownsample=e,this._resizeDepthRenderer())}get backfaceForceDepthWriteTransparentMeshes(){return this._backfaceForceDepthWriteTransparentMeshes}set backfaceForceDepthWriteTransparentMeshes(e){this._backfaceForceDepthWriteTransparentMeshes!==e&&(this._backfaceForceDepthWriteTransparentMeshes=e,this._depthRenderer&&(this._depthRenderer.forceDepthWriteTransparentMeshes=e))}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._buildPipeline())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._buildPipeline())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._buildPipeline())}getScene(){return this._scene}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}get isSupported(){let e=this._scene.getEngine().getCaps();return e.drawBuffersExtension&&e.texelFetch}constructor(e,t,i,r=!1,n=0){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._reflectivityThreshold=.04,this._ssrDownsample=0,this._blurDispersionStrength=.03,this._blurDownsample=0,this._enableSmoothReflections=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateIntersectionIterations=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._useFresnel=!1,this._enableAutomaticThicknessComputation=!1,this._backfaceDepthTextureDownsample=0,this._backfaceForceDepthWriteTransparentMeshes=!0,this._isEnabled=!0,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=n,this._forceGeometryBuffer=r,this.isSupported){if(t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){let o=t.enableGeometryBufferRenderer();o&&(o.enableReflectivity=!0,o.useSpecificClearForDepthTexture=!0)}else{let o=t.enablePrePassRenderer();o&&(o.useSpecificClearForDepthTexture=!0,o.markAsDirty())}this._buildPipeline()}}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){let t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposePostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}_getTextureSize(){let e=this._scene.getEngine(),t=this._prePassRenderer,i={width:e.getRenderWidth(),height:e.getRenderHeight()};if(t&&this._scene.activeCamera?._getFirstPostProcess()===this._ssrPostProcess){let r=t.getRenderTarget();r&&r.textures&&(i=r.textures[t.getIndex(4)].getSize())}else this._ssrPostProcess?.inputTexture&&(i.width=this._ssrPostProcess.inputTexture.width,i.height=this._ssrPostProcess.inputTexture.height);return i}_updateEffectDefines(){let e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&e.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._environmentTexture&&(e.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&e.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC"),this._environmentTexture.gammaSpace&&e.push("#define SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE")),this._environmentTextureIsProbe&&e.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&e.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&e.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&e.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateIntersectionIterations&&e.push("#define SSR_ATTENUATE_INTERSECTION_NUMITERATIONS"),this._attenuateFacingCamera&&e.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&e.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&e.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this._useBlur()&&e.push("#define SSR_USE_BLUR"),this._debug&&e.push("#define SSRAYTRACE_DEBUG"),this._inputTextureColorIsInGammaSpace&&e.push("#define SSR_INPUT_IS_GAMMA_SPACE"),this._generateOutputInGammaSpace&&e.push("#define SSR_OUTPUT_IS_GAMMA_SPACE"),this._useFresnel&&e.push("#define SSR_BLEND_WITH_FRESNEL"),this._reflectivityThreshold===0&&e.push("#define SSR_DISABLE_REFLECTIVITY_TEST"),(this._geometryBufferRenderer?.generateNormalsInWorldSpace??this._prePassRenderer?.generateNormalsInWorldSpace)&&e.push("#define SSR_NORMAL_IS_IN_WORLDSPACE"),this._geometryBufferRenderer?.normalsAreUnsigned&&e.push("#define SSR_DECODE_NORMAL");let t=this._cameras?.[0];t&&t.mode===1&&e.push("#define ORTHOGRAPHIC_CAMERA"),this._ssrPostProcess?.updateEffect(e.join(`
`))}_buildPipeline(){if(!this.isSupported)return;if(!this._isEnabled){this._isDirty=!0;return}this._isDirty=!1;let e=this._scene.getEngine();if(this._disposeDepthRenderer(),this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._enableAutomaticThicknessComputation){let t=this._cameras?.[0];t&&(this._depthRendererCamera=t,this._depthRenderer=new mh(this._scene,void 0,void 0,void 0,1,!0,"SSRBackDepth"),this._depthRenderer.clearColor.r=1e8,this._depthRenderer.reverseCulling=!0,this._depthRenderer.forceDepthWriteTransparentMeshes=this._backfaceForceDepthWriteTransparentMeshes,this._resizeDepthRenderer(),t.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this._createSSRPostProcess(),this.addEffect(new ot(e,this.SSRRenderEffect,()=>this._ssrPostProcess,!0)),this._useBlur()&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new ot(e,this.SSRBlurRenderEffect,()=>[this._blurPostProcessX,this._blurPostProcessY],!0)),this.addEffect(new ot(e,this.SSRCombineRenderEffect,()=>this._blurCombinerPostProcess,!0))),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;let e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),i=Math.floor(e.width/(this._backfaceDepthTextureDownsample+1)),r=Math.floor(e.height/(this._backfaceDepthTextureDownsample+1));(t.width!==i||t.height!==r)&&this._depthRenderer.getDepthMap().resize({width:i,height:r})}_disposeDepthRenderer(){if(this._depthRenderer){if(this._depthRendererCamera){let e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap())??-1;e!==-1&&this._depthRendererCamera.customRenderTargets.splice(e,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){let t=this._cameras[e];this._ssrPostProcess?.dispose(t),this._blurPostProcessX?.dispose(t),this._blurPostProcessY?.dispose(t),this._blurCombinerPostProcess?.dispose(t)}this._ssrPostProcess=null,this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new ve("ssr","screenSpaceReflection2",["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor","reflectivityThreshold"],["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"],1,null,this._textureType,this._scene.getEngine(),!1,"",this._textureType),this._updateEffectDefines(),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();let t=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!t)return;if(t){let l=t.getTextureIndex(Xr.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",t.getGBuffer().textures[1]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[l]),e.setTexture("depthSampler",t.getGBuffer().textures[0])}else if(i){let l=i.getIndex(5),c=i.getIndex(3),h=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[h]),e.setTexture("depthSampler",i.getRenderTarget().textures[l]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[c])}this._enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this._backfaceDepthTextureDownsample+1));let r=this._scene.activeCamera;if(!r)return;let n=r.getViewMatrix(),o=r.getProjectionMatrix();o.invertToRef(O.Matrix[0]),n.invertToRef(O.Matrix[1]),e.setMatrix("projection",o),e.setMatrix("view",n),e.setMatrix("invView",O.Matrix[1]),e.setMatrix("invProjectionMatrix",O.Matrix[0]),e.setFloat("thickness",this.thickness),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("maxSteps",this.maxSteps),e.setFloat("roughnessFactor",this.roughnessFactor),e.setFloat("nearPlaneZ",r.minZ),e.setFloat("maxDistance",this.maxDistance),e.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip),e.setFloat("reflectivityThreshold",this._reflectivityThreshold);let a=this._getTextureSize();N.ScalingToRef(a.width,a.height,1,O.Matrix[2]),o.multiplyToRef(this._scene.getEngine().isWebGPU?R9:I9,O.Matrix[3]),O.Matrix[3].multiplyToRef(O.Matrix[2],O.Matrix[4]),e.setMatrix("projectionPixel",O.Matrix[4]),this._environmentTexture&&(e.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(e.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),e.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new ZC)}_createBlurAndCombinerPostProcesses(){let e=this._scene.getEngine();this._blurPostProcessX=new ve("SSRblurX","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._ssrDownsample+1):1,null,2,e,!1,"",this._textureType),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add(n=>{let o=this._blurPostProcessX?.inputTexture.width??this._scene.getEngine().getRenderWidth();n.setFloat2("texelOffsetScale",this._blurDispersionStrength/o,0)}),this._blurPostProcessY=new ve("SSRblurY","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._blurDownsample+1):1,null,2,e,!1,"",this._textureType),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add(n=>{let o=this._blurPostProcessY?.inputTexture.height??this._scene.getEngine().getRenderHeight();n.setFloat2("texelOffsetScale",0,this._blurDispersionStrength/o)});let t=["strength","reflectionSpecularFalloffExponent","reflectivityThreshold"],i=["textureSampler","mainSampler","reflectivitySampler"],r="";this._debug&&(r+=`#define SSRAYTRACE_DEBUG
`),this._inputTextureColorIsInGammaSpace&&(r+=`#define SSR_INPUT_IS_GAMMA_SPACE
`),this._generateOutputInGammaSpace&&(r+=`#define SSR_OUTPUT_IS_GAMMA_SPACE
`),this.useFresnel&&(r+=`#define SSR_BLEND_WITH_FRESNEL
`,t.push("projection","invProjectionMatrix"),i.push("depthSampler","normalSampler")),this._reflectivityThreshold===0&&(r+="#define SSR_DISABLE_REFLECTIVITY_TEST"),this._blurCombinerPostProcess=new ve("SSRblurCombiner","screenSpaceReflection2BlurCombiner",t,i,this._useBlur()?1/(this._blurDownsample+1):1,null,1,e,!1,r,this._textureType),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add(n=>{let o=this._geometryBufferRenderer,a=this._prePassRenderer;if(!(!a&&!o)){if(a&&this._scene.activeCamera?._getFirstPostProcess()===this._ssrPostProcess){let l=a.getRenderTarget();l&&l.textures&&n.setTexture("mainSampler",l.textures[a.getIndex(4)])}else n.setTextureFromPostProcess("mainSampler",this._ssrPostProcess);if(o){let l=o.getTextureIndex(Xr.REFLECTIVITY_TEXTURE_TYPE);n.setTexture("reflectivitySampler",o.getGBuffer().textures[l]),this.useFresnel&&(n.setTexture("normalSampler",o.getGBuffer().textures[1]),n.setTexture("depthSampler",o.getGBuffer().textures[0]))}else if(a){let l=a.getIndex(3);if(n.setTexture("reflectivitySampler",a.getRenderTarget().textures[l]),this.useFresnel){let c=a.getIndex(5),h=a.getIndex(6);n.setTexture("normalSampler",a.getRenderTarget().textures[h]),n.setTexture("depthSampler",a.getRenderTarget().textures[c])}}if(n.setFloat("strength",this.strength),n.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),n.setFloat("reflectivityThreshold",this._reflectivityThreshold),this.useFresnel){let l=this._scene.activeCamera;if(l){let c=l.getProjectionMatrix();c.invertToRef(O.Matrix[0]),n.setMatrix("projection",c),n.setMatrix("invProjectionMatrix",O.Matrix[0])}}}})}serialize(){let e=ae.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,i){return ae.Parse(()=>new s(e._name,t,e._ratio),e,t,i)}};v([I()],ui.prototype,"samples",null);v([I()],ui.prototype,"maxDistance",void 0);v([I()],ui.prototype,"step",void 0);v([I()],ui.prototype,"thickness",void 0);v([I()],ui.prototype,"strength",void 0);v([I()],ui.prototype,"reflectionSpecularFalloffExponent",void 0);v([I()],ui.prototype,"maxSteps",void 0);v([I()],ui.prototype,"roughnessFactor",void 0);v([I()],ui.prototype,"selfCollisionNumSkip",void 0);v([I()],ui.prototype,"_reflectivityThreshold",void 0);v([I("_ssrDownsample")],ui.prototype,"_ssrDownsample",void 0);v([I()],ui.prototype,"ssrDownsample",null);v([I("blurDispersionStrength")],ui.prototype,"_blurDispersionStrength",void 0);v([I("blurDownsample")],ui.prototype,"_blurDownsample",void 0);v([I("enableSmoothReflections")],ui.prototype,"_enableSmoothReflections",void 0);v([I("environmentTexture")],ui.prototype,"_environmentTexture",void 0);v([I("environmentTextureIsProbe")],ui.prototype,"_environmentTextureIsProbe",void 0);v([I("attenuateScreenBorders")],ui.prototype,"_attenuateScreenBorders",void 0);v([I("attenuateIntersectionDistance")],ui.prototype,"_attenuateIntersectionDistance",void 0);v([I("attenuateIntersectionIterations")],ui.prototype,"_attenuateIntersectionIterations",void 0);v([I("attenuateFacingCamera")],ui.prototype,"_attenuateFacingCamera",void 0);v([I("attenuateBackfaceReflection")],ui.prototype,"_attenuateBackfaceReflection",void 0);v([I("clipToFrustum")],ui.prototype,"_clipToFrustum",void 0);v([I("useFresnel")],ui.prototype,"_useFresnel",void 0);v([I("enableAutomaticThicknessComputation")],ui.prototype,"_enableAutomaticThicknessComputation",void 0);v([I("backfaceDepthTextureDownsample")],ui.prototype,"_backfaceDepthTextureDownsample",void 0);v([I("backfaceForceDepthWriteTransparentMeshes")],ui.prototype,"_backfaceForceDepthWriteTransparentMeshes",void 0);v([I("isEnabled")],ui.prototype,"_isEnabled",void 0);v([I("inputTextureColorIsInGammaSpace")],ui.prototype,"_inputTextureColorIsInGammaSpace",void 0);v([I("generateOutputInGammaSpace")],ui.prototype,"_generateOutputInGammaSpace",void 0);v([I("debug")],ui.prototype,"_debug",void 0);P("BABYLON.SSRRenderingPipeline",ui);var P9="taaPixelShader",M9=`varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D historySampler;uniform float factor;void main() {vec4 c=texelFetch(textureSampler,ivec2(gl_FragCoord.xy),0);vec4 h=texelFetch(historySampler,ivec2(gl_FragCoord.xy),0);gl_FragColor=mix(h,c,factor);}
`;D.ShadersStore[P9]=M9;var hc=class s extends ys{set samples(e){this._samples!==e&&(this._samples=e,this._hs.regenerate(e))}get samples(){return this._samples}set msaaSamples(e){this._msaaSamples!==e&&(this._msaaSamples=e,this._taaPostProcess&&(this._taaPostProcess.samples=e))}get msaaSamples(){return this._msaaSamples}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():this._cameras!==null&&(this._firstUpdate=!0,this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras))):this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get scene(){return this._scene}get isSupported(){return this._scene.getEngine().getCaps().texelFetch}constructor(e,t,i,r=0){let n=t.getEngine();super(n,e),this.TAARenderEffect="TAARenderEffect",this.TAAPassEffect="TAAPassEffect",this._samples=8,this._msaaSamples=1,this.factor=.05,this.disableOnCameraMove=!0,this._isEnabled=!0,this._isDirty=!1,this._camerasToBeAttached=[],this._pingpong=0,this._firstUpdate=!0,this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=r,this._hs=new qT(this.samples),this.isSupported&&(this._createPingPongTextures(n.getRenderWidth(),n.getRenderHeight()),t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline())}getClassName(){return"TAARenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){let t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._ping.dispose(),this._pong.dispose(),super.dispose()}_createPingPongTextures(e,t){let i=this._scene.getEngine();this._ping?.dispose(),this._pong?.dispose(),this._ping=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:1}),this._pong=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:1}),this._hs.setDimensions(e/2,t/2),this._firstUpdate=!0}_updateEffectDefines(){let e=[];this._taaPostProcess?.updateEffect(e.join(`
`))}_buildPipeline(){if(!this.isSupported)return;if(!this._isEnabled){this._isDirty=!0;return}this._isDirty=!1;let e=this._scene.getEngine();this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._createTAAPostProcess(),this.addEffect(new ot(e,this.TAARenderEffect,()=>this._taaPostProcess,!0)),this._createPassPostProcess(),this.addEffect(new ot(e,this.TAAPassEffect,()=>this._passPostProcess,!0)),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){let t=this._cameras[e];this._taaPostProcess?.dispose(t),this._passPostProcess?.dispose(t),t.getProjectionMatrix(!0)}this._taaPostProcess=null,this._passPostProcess=null}_createTAAPostProcess(){this._taaPostProcess=new ve("TAA","taa",{uniforms:["factor"],samplers:["historySampler"],size:1,engine:this._scene.getEngine(),textureType:this._textureType}),this._taaPostProcess.samples=this._msaaSamples,this._updateEffectDefines(),this._taaPostProcess.onActivateObservable.add(()=>{let e=this._scene.activeCamera;if(this._taaPostProcess?.width!==this._ping.width||this._taaPostProcess?.height!==this._ping.height){let t=this._scene.getEngine();this._createPingPongTextures(t.getRenderWidth(),t.getRenderHeight())}if(e&&!e.hasMoved)if(e.mode===Ce.PERSPECTIVE_CAMERA){let t=e.getProjectionMatrix();t.setRowFromFloats(2,this._hs.x,this._hs.y,t.m[10],t.m[11])}else{let t=e.getProjectionMatrix(!0);t.setRowFromFloats(3,this._hs.x+t.m[12],this._hs.y+t.m[13],t.m[14],t.m[15])}this._passPostProcess&&(this._passPostProcess.inputTexture=this._pingpong?this._ping:this._pong),this._pingpong=this._pingpong^1,this._hs.next()}),this._taaPostProcess.onApplyObservable.add(e=>{let t=this._scene.activeCamera;e._bindTexture("historySampler",this._pingpong?this._ping.texture:this._pong.texture),e.setFloat("factor",t?.hasMoved&&this.disableOnCameraMove||this._firstUpdate?1:this.factor),this._firstUpdate=!1})}_createPassPostProcess(){let e=this._scene.getEngine();this._passPostProcess=new qr("TAAPass",1,null,1,e),this._passPostProcess.inputTexture=this._ping,this._passPostProcess.autoClear=!1}serialize(){let e=ae.Serialize(this);return e.customType="TAARenderingPipeline",e}static Parse(e,t,i){return ae.Parse(()=>new s(e._name,t,e._ratio),e,t,i)}};v([I("samples")],hc.prototype,"_samples",void 0);v([I("msaaSamples")],hc.prototype,"_msaaSamples",void 0);v([I()],hc.prototype,"factor",void 0);v([I()],hc.prototype,"disableOnCameraMove",void 0);v([I("isEnabled")],hc.prototype,"_isEnabled",void 0);P("BABYLON.TAARenderingPipeline",hc);var D9="tonemapPixelShader",O9=`varying vec2 vUV;uniform sampler2D textureSampler;uniform float _ExposureAdjustment;
#if defined(HABLE_TONEMAPPING)
const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;const float W=11.2;
#endif
float Luminance(vec3 c)
{return dot(c,vec3(0.22,0.707,0.071));}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec3 colour=texture2D(textureSampler,vUV).rgb;
#if defined(REINHARD_TONEMAPPING)
float lum=Luminance(colour.rgb); 
float lumTm=lum*_ExposureAdjustment;float scale=lumTm/(1.0+lumTm); 
colour*=scale/lum;
#elif defined(HABLE_TONEMAPPING)
colour*=_ExposureAdjustment;const float ExposureBias=2.0;vec3 x=ExposureBias*colour;vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x=vec3(W,W,W);vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;
#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)
colour*=_ExposureAdjustment;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;
#elif defined(PHOTOGRAPHIC_TONEMAPPING)
colour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);
#endif
gl_FragColor=vec4(colour.rgb,1.0);}`;D.ShadersStore[D9]=O9;var w9="volumetricLightScatteringPixelShader",N9=`uniform sampler2D textureSampler;uniform sampler2D lightScatteringSampler;uniform float decay;uniform float exposure;uniform float weight;uniform float density;uniform vec2 meshPositionOnScreen;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec2 tc=vUV;vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;float illuminationDecay=1.0;vec4 color=texture2D(lightScatteringSampler,tc)*0.4;for(int i=0; i<NUM_SAMPLES; i++) {tc-=deltaTexCoord;vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;dataSample*=illuminationDecay*weight;color+=dataSample;illuminationDecay*=decay;}
vec4 realColor=texture2D(textureSampler,vUV);gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));
#define CUSTOM_FRAGMENT_MAIN_END
}
`;D.ShadersStore[w9]=N9;var F9="volumetricLightScatteringPassVertexShader",L9=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;D.ShadersStore[F9]=L9;var B9="volumetricLightScatteringPassPixelShader",V9=`#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
#endif
#if defined(ALPHATEST)
uniform sampler2D diffuseSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#if defined(ALPHATEST)
vec4 diffuseColor=texture2D(diffuseSampler,vUV);if (diffuseColor.a<0.4)
discard;
#endif
gl_FragColor=vec4(0.0,0.0,0.0,1.0);}
`;D.ShadersStore[B9]=V9;var Mn=class s extends ve{get useDiffuseColor(){return F.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){F.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,r,n=100,o=z.BILINEAR_SAMPLINGMODE,a,l,c){super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,o,a,l,"#define NUM_SAMPLES "+n),this._screenCoordinates=j.Zero(),this.customMeshPosition=p.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=[],this.includedMeshes=[],this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,c=i?.getScene()??c??this._scene,a=c.getEngine(),this._viewPort=new Dr(0,0,1,1).toGlobal(a.getRenderWidth(),a.getRenderHeight()),this.mesh=r??s.CreateDefaultMesh("VolumetricLightScatteringMesh",c),this._createPass(c,t.passRatio||t),this.onActivate=h=>{this.isSupported||this.dispose(h),this.onActivate=null},this.onApplyObservable.add(h=>{this._updateMeshScreenCoordinates(c),h.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),h.setFloat("exposure",this.exposure),h.setFloat("decay",this.decay),h.setFloat("weight",this.weight),h.setFloat("density",this.density),h.setVector2("meshPositionOnScreen",this._screenCoordinates)})}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){let i=e.getMesh();if(i===this.mesh&&i.material)return i.material.isReady(i);let r=i._internalAbstractMeshDataInfo._materialForRenderPass?.[this._scene.getEngine().currentRenderPassId];if(r)return r.isReadyForSubMesh(i,e,t);let n=[],o=[y.PositionKind],a=e.getMaterial();a&&(a.needAlphaTesting()&&n.push("#define ALPHATEST"),i.isVerticesDataPresent(y.UVKind)&&(o.push(y.UVKind),n.push("#define UV1")),i.isVerticesDataPresent(y.UV2Kind)&&(o.push(y.UV2Kind),n.push("#define UV2"))),i.useBones&&i.computeBonesUsingShaders?(o.push(y.MatricesIndicesKind),o.push(y.MatricesWeightsKind),n.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),n.push("#define BonesPerMesh "+(i.skeleton?i.skeleton.bones.length+1:0))):n.push("#define NUM_BONE_INFLUENCERS 0"),t&&(n.push("#define INSTANCES"),Ds(o),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES"));let l=e._getDrawWrapper(void 0,!0),c=l.defines,h=n.join(`
`);return c!==h&&l.setEffect(i.getScene().getEngine().createEffect("volumetricLightScatteringPass",o,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],h,void 0,void 0,void 0,{maxSimultaneousMorphTargets:i.numBoneInfluencers}),h),l.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){let t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);t!==-1&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&this.includedMeshes.indexOf(e)===-1||this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1}_createPass(e,t){let i=e.getEngine();this._volumetricLightScatteringRTT=new vt("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=z.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=z.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;let r=this.getCamera();r?r.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);let n=l=>{let c=l.getRenderingMesh(),h=l.getEffectiveMesh();if(this._meshExcluded(c))return;h._internalAbstractMeshDataInfo._isActiveIntermediate=!1;let u=l.getMaterial();if(!u)return;let d=c.getScene(),f=d.getEngine();f.setState(u.backFaceCulling,void 0,void 0,void 0,u.cullBackFaces);let m=c._getInstancesRenderList(l._id,!!l.getReplacementMesh());if(m.mustReturn)return;let g=f.getCaps().instancedArrays&&(m.visibleInstances[l._id]!==null||c.hasThinInstances);if(this._isReady(l,g)){let _=h._internalAbstractMeshDataInfo._materialForRenderPass?.[f.currentRenderPassId],x=l._getDrawWrapper();if(c===this.mesh&&!x&&(x=u._getDrawWrapper()),!x)return;let b=x.effect;if(f.enableEffect(x),g||c._bind(l,b,u.fillMode),c===this.mesh)u.bind(h.getWorldMatrix(),c);else if(_)_.bindForSubMesh(h.getWorldMatrix(),h,l);else{if(b.setMatrix("viewProjection",d.getTransformMatrix()),u&&u.needAlphaTesting()){let C=u.getAlphaTestTexture();b.setTexture("diffuseSampler",C),C&&b.setMatrix("diffuseMatrix",C.getTextureMatrix())}c.useBones&&c.computeBonesUsingShaders&&c.skeleton&&b.setMatrices("mBones",c.skeleton.getTransformMatrices(c))}g&&c.hasThinInstances&&b.setMatrix("world",h.getWorldMatrix()),c._processRendering(h,l,b,se.TriangleFillMode,m,g,(C,R)=>{C||b.setMatrix("world",R)})}},o,a=new oe(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(()=>{o=e.clearColor,e.clearColor=a}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(()=>{e.clearColor=o}),this._volumetricLightScatteringRTT.customIsReadyFunction=(l,c,h)=>{if((h||c===0)&&l.subMeshes)for(let u=0;u<l.subMeshes.length;++u){let d=l.subMeshes[u],f=d.getMaterial(),m=d.getRenderingMesh();if(!f)continue;let g=m._getInstancesRenderList(d._id,!!d.getReplacementMesh()),_=i.getCaps().instancedArrays&&(g.visibleInstances[d._id]!==null||m.hasThinInstances);if(!this._isReady(d,_))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(l,c,h,u)=>{let d=e.getEngine(),f;if(u.length){for(d.setColorWrite(!1),f=0;f<u.length;f++)n(u.data[f]);d.setColorWrite(!0)}for(f=0;f<l.length;f++)n(l.data[f]);for(f=0;f<c.length;f++)n(c.data[f]);if(h.length){for(f=0;f<h.length;f++){let g=h.data[f],_=g.getBoundingInfo();_&&e.activeCamera&&(g._alphaIndex=g.getMesh().alphaIndex,g._distanceToCamera=_.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}let m=h.data.slice(0,h.length);for(m.sort((g,_)=>g._alphaIndex>_._alphaIndex?1:g._alphaIndex<_._alphaIndex?-1:g._distanceToCamera<_._distanceToCamera?1:g._distanceToCamera>_._distanceToCamera?-1:0),d.setAlphaMode(2),f=0;f<m.length;f++)n(m[f]);d.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){let t=e.getTransformMatrix(),i;this.useCustomMeshPosition?i=this.customMeshPosition:this.attachedNode?i=this.attachedNode.position:i=this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;let r=p.Project(i,N.Identity(),t,this._viewPort);this._screenCoordinates.x=r.x/this._viewPort.width,this._screenCoordinates.y=r.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){let i=Yn(e,{size:1},t);i.billboardMode=lt.BILLBOARDMODE_ALL;let r=new Ee(e+"Material",t);return r.emissiveColor=new X(1,1,1),i.material=r,i}};v([mi()],Mn.prototype,"customMeshPosition",void 0);v([I()],Mn.prototype,"useCustomMeshPosition",void 0);v([I()],Mn.prototype,"invert",void 0);v([Go()],Mn.prototype,"mesh",void 0);v([I()],Mn.prototype,"excludedMeshes",void 0);v([I()],Mn.prototype,"includedMeshes",void 0);v([I()],Mn.prototype,"exposure",void 0);v([I()],Mn.prototype,"decay",void 0);v([I()],Mn.prototype,"weight",void 0);v([I()],Mn.prototype,"density",void 0);P("BABYLON.VolumetricLightScatteringPostProcess",Mn);var U9="screenSpaceCurvaturePixelShader",k9=`precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform float curvature_ridge;uniform float curvature_valley;
#ifndef CURVATURE_OFFSET
#define CURVATURE_OFFSET 1
#endif
float curvature_soft_clamp(float curvature,float control)
{if (curvature<0.5/control)
return curvature*(1.0-curvature*control);return 0.25/control;}
float calculate_curvature(ivec2 texel,float ridge,float valley)
{vec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;vec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;vec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;vec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));if (normal_diff<0.0)
return -2.0*curvature_soft_clamp(-normal_diff,valley);return 2.0*curvature_soft_clamp(normal_diff,ridge);}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{ivec2 texel=ivec2(gl_FragCoord.xy);vec4 baseColor=texture2D(textureSampler,vUV);float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);baseColor.rgb*=curvature+1.0;gl_FragColor=baseColor;}`;D.ShadersStore[U9]=k9;var og=class s extends ve{getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,i,r,n,o,a,l=0,c=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],i,r,n,o,a,void 0,l,void 0,null,c),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?(this._geometryBufferRenderer.generateNormalsInWorldSpace&&F.Error("ScreenSpaceCurvaturePostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"),this.onApply=h=>{h.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),h.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));let u=this._geometryBufferRenderer.getGBuffer().textures[1];h.setTexture("normalSampler",u)}):F.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){let e=me.LastCreatedEngine;return e?e.getCaps().drawBuffersExtension:!1}static _Parse(e,t,i,r){return ae.Parse(()=>new s(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}};v([I()],og.prototype,"ridge",void 0);v([I()],og.prototype,"valley",void 0);P("BABYLON.ScreenSpaceCurvaturePostProcess",og);var G9="boundingBoxRendererFragmentDeclaration",z9=`uniform vec4 color;
`;D.IncludesShadersStore[G9]=z9;var W9="boundingBoxRendererUboDeclaration",H9=`#ifdef WEBGL2
uniform vec4 color;uniform mat4 world;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#else
layout(std140,column_major) uniform;uniform BoundingBoxRenderer {vec4 color;mat4 world;mat4 viewProjection;mat4 viewProjectionR;};
#endif
`;D.IncludesShadersStore[W9]=H9;var X9="boundingBoxRendererPixelShader",Y9=`#include<__decl__boundingBoxRendererFragment>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;D.ShadersStore[X9]=Y9;var $9="boundingBoxRendererVertexDeclaration",j9=`uniform mat4 world;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
`;D.IncludesShadersStore[$9]=j9;var q9="boundingBoxRendererVertexShader",Q9=`attribute vec3 position;
#include<__decl__boundingBoxRendererVertex>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec4 worldPos=world*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;D.ShadersStore[q9]=Q9;Object.defineProperty(Te.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(s){this._forceShowBoundingBoxes=s,s&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0});Te.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new aM(this)),this._boundingBoxRenderer};Object.defineProperty(lt.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(s){this._showBoundingBox=s,s&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});var aM=class{constructor(e){this.name=ye.NAME_BOUNDINGBOXRENDERER,this.frontColor=new X(1,1,1),this.backColor=new X(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new U,this.onAfterBoxRenderingObservable=new U,this.onResourcesReadyObservable=new U,this.enabled=!0,this.renderList=new _i(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=e,e._addComponent(this),this._uniformBufferFront=new _r(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new _r(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(ye.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(ye.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(ye.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(ye.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){let i=t.getBoundingInfo();i!=null&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){let t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new Fi("colorShader",this.scene,"boundingBoxRenderer",{attributes:[y.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!1),this._colorShader.doNotSerialize=!0,this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new Fi("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[y.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!0),this._colorShaderForOcclusionQuery.doNotSerialize=!0,this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};let e=this.scene.getEngine(),t=Cv({size:1});this._vertexBuffers[y.PositionKind]=new y(e,t.positions,y.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){let e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){let e=this._vertexBuffers[y.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}reset(){this.renderList.reset()}render(e){if(this.renderList.length===0||!this.enabled||(this._prepareResources(),!this._colorShader.isReady()))return;let t=this.scene.getEngine();t.setDepthWrite(!1);let i=this.scene.getTransformMatrix();for(let r=0;r<this.renderList.length;r++){let n=this.renderList.data[r];if(n._tag!==e)continue;this._createWrappersForBoundingBox(n),this.onBeforeBoxRenderingObservable.notifyObservers(n);let o=n.minimum,l=n.maximum.subtract(o),c=o.add(l.scale(.5)),h=N.Scaling(l.x,l.y,l.z).multiply(N.Translation(c.x,c.y,c.z)).multiply(n.getWorldMatrix()),u=t.useReverseDepthBuffer;if(this.showBackLines){let f=n._drawWrapperBack??this._colorShader._getDrawWrapper();this._colorShader._preBind(f),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),u?t.setDepthFunctionToLessOrEqual():t.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(f.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateColor4("color",this.backColor,1),this._uniformBufferBack.updateMatrix("world",h),this._uniformBufferBack.updateMatrix("viewProjection",i),this._uniformBufferBack.update(),t.drawElementsType(se.LineListDrawMode,0,24)}let d=n._drawWrapperFront??this._colorShader._getDrawWrapper();this._colorShader._preBind(d),t.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),u?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateColor4("color",this.frontColor,1),this._uniformBufferFront.updateMatrix("world",h),this._uniformBufferFront.updateMatrix("viewProjection",i),this._uniformBufferFront.update(),t.drawElementsType(se.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(n)}this._colorShader.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){let t=this.scene.getEngine();e._drawWrapperFront=new Xt(t),e._drawWrapperBack=new Xt(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){let t=this.scene.getEngine();this._renderPassIdForOcclusionQuery===void 0&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));let i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();let r=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,r)||!e.hasBoundingInfo){t.currentRenderPassId=i;return}this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));let n=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);let o=e.getBoundingInfo().boundingBox,a=o.minimum,c=o.maximum.subtract(a),h=a.add(c.scale(.5)),u=N.Scaling(c.x,c.y,c.z).multiply(N.Translation(h.x,h.y,h.z)).multiply(o.getWorldMatrix()),d=r._drawWrapper;this._colorShaderForOcclusionQuery._preBind(d),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,d.effect),n?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",u),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(se.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}dispose(){if(this._renderPassIdForOcclusionQuery!==void 0&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();let e=this._vertexBuffers[y.PositionKind];e&&(e.dispose(),this._vertexBuffers[y.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}};Te.prototype.enableDepthRenderer=function(s,e=!1,t=!1,i=3,r=!1){if(s=s||this.activeCamera,!s)throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[s.id]){let n=!!this.getEngine().getCaps().textureFloatRender,o=0;this.getEngine().getCaps().textureHalfFloatRender&&(!t||!n)?o=2:n?o=1:o=0,this._depthRenderer[s.id]=new mh(this,o,s,e,i,r)}return this._depthRenderer[s.id]};Te.prototype.disableDepthRenderer=function(s){s=s||this.activeCamera,!(!s||!this._depthRenderer||!this._depthRenderer[s.id])&&this._depthRenderer[s.id].dispose()};var lM=class{constructor(e){this.name=ye.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(ye.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(ye.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(let e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(let t in this.scene._depthRenderer){let i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(let t in this.scene._depthRenderer){let i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}};mh._SceneComponentInitialization=s=>{let e=s._getComponent(ye.NAME_DEPTHRENDERER);e||(e=new lM(s),s._addComponent(e))};var K9="oitFinalPixelShader",Z9=`precision highp float;uniform sampler2D uFrontColor;uniform sampler2D uBackColor;void main() {ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec4 frontColor=texelFetch(uFrontColor,fragCoord,0);vec4 backColor=texelFetch(uBackColor,fragCoord,0);float alphaMultiplier=1.0-frontColor.a;glFragColor=vec4(
frontColor.rgb+alphaMultiplier*backColor.rgb,
frontColor.a+backColor.a
);}`;D.ShadersStore[K9]=Z9;var J9="oitBackBlendPixelShader",eK=`precision highp float;uniform sampler2D uBackColor;void main() {glFragColor=texelFetch(uBackColor,ivec2(gl_FragCoord.xy),0);if (glFragColor.a==0.0) { 
discard;}}`;D.ShadersStore[J9]=eK;var cM=class{constructor(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}},kV=(()=>{class s{get passCount(){return this._passCount}set passCount(t){this._passCount!==t&&(this._passCount=t,this._createRenderPassIds())}get useRenderPasses(){return this._useRenderPasses}set useRenderPasses(t){this._useRenderPasses!==t&&(this._useRenderPasses=t,this._createRenderPassIds())}addExcludedMesh(t){this._excludedMeshes.indexOf(t.uniqueId)===-1&&this._excludedMeshes.push(t.uniqueId)}removeExcludedMesh(t){let i=this._excludedMeshes.indexOf(t.uniqueId);i!==-1&&this._excludedMeshes.splice(i,1)}constructor(t,i=5){if(this._thinTextures=[],this._currentPingPongState=0,this._layoutCacheFormat=[[!0],[!0,!0],[!0,!0,!0]],this._layoutCache=[],this._candidateSubMeshes=new _i(10),this._excludedSubMeshes=new _i(10),this._excludedMeshes=[],this._colorCache=[new oe(s._DEPTH_CLEAR_VALUE,s._DEPTH_CLEAR_VALUE,0,0),new oe(-s._MIN_DEPTH,s._MAX_DEPTH,0,0),new oe(0,0,0,0)],this._scene=t,this._engine=t.getEngine(),this._passCount=i,!t.enablePrePassRenderer()){F.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.");return}for(let r=0;r<this._layoutCacheFormat.length;++r)this._layoutCache[r]=this._engine.buildTextureLayout(this._layoutCacheFormat[r]);this._renderPassIds=[],this.useRenderPasses=!1,this._prePassEffectConfiguration=new cM,this._createTextures(),this._createEffects()}_createRenderPassIds(){if(this._releaseRenderPassIds(),this._useRenderPasses)for(let t=0;t<this._passCount+1;++t)this._renderPassIds[t]||(this._renderPassIds[t]=this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${t}`))}_releaseRenderPassIds(){for(let t=0;t<this._renderPassIds.length;++t)this._engine.releaseRenderPassId(this._renderPassIds[t]);this._renderPassIds=[]}_createTextures(){let t={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()};this._depthMrts=[new Rn("depthPeelingDepth0MRT",t,3,this._scene,void 0,["depthPeelingDepth0MRT_depth","depthPeelingDepth0MRT_frontColor","depthPeelingDepth0MRT_backColor"]),new Rn("depthPeelingDepth1MRT",t,3,this._scene,void 0,["depthPeelingDepth1MRT_depth","depthPeelingDepth1MRT_frontColor","depthPeelingDepth1MRT_backColor"])],this._colorMrts=[new Rn("depthPeelingColor0MRT",t,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor0MRT_frontColor","depthPeelingColor0MRT_backColor"]),new Rn("depthPeelingColor1MRT",t,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor1MRT_frontColor","depthPeelingColor1MRT_backColor"])],this._blendBackMrt=new Rn("depthPeelingBackMRT",t,1,this._scene,{generateDepthBuffer:!1},["depthPeelingBackMRT_blendBack"]),this._outputRT=new vt("depthPeelingOutputRTT",t,this._scene,!1);let i=[{format:7,samplingMode:1,type:this._engine.getCaps().textureFloatLinearFiltering?1:2,label:"DepthPeelingRenderer-DepthTexture"},{format:5,samplingMode:1,type:2,label:"DepthPeelingRenderer-ColorTexture"}];for(let r=0;r<2;r++){let n=this._engine._createInternalTexture(t,i[0],!1),o=this._engine._createInternalTexture(t,i[1],!1),a=this._engine._createInternalTexture(t,i[1],!1);this._depthMrts[r].setInternalTexture(n,0),this._depthMrts[r].setInternalTexture(o,1),this._depthMrts[r].setInternalTexture(a,2),this._colorMrts[r].setInternalTexture(o,0),this._colorMrts[r].setInternalTexture(a,1),this._thinTextures.push(new vu(n),new vu(o),new vu(a))}}_disposeTextures(){for(let t=0;t<this._thinTextures.length;t++)t!==6&&this._thinTextures[t].dispose();for(let t=0;t<2;t++)this._depthMrts[t].dispose(!0),this._colorMrts[t].dispose(!0),this._blendBackMrt.dispose(!0);this._outputRT.dispose(),this._thinTextures=[],this._colorMrts=[],this._depthMrts=[]}_updateTextures(){return(this._depthMrts[0].getSize().width!==this._engine.getRenderWidth()||this._depthMrts[0].getSize().height!==this._engine.getRenderHeight())&&(this._disposeTextures(),this._createTextures()),this._updateTextureReferences()}_updateTextureReferences(){let t=this._scene.prePassRenderer;if(!t)return!1;let i=t.getIndex(4),r=t.defaultRT.textures?.length?t.defaultRT.textures[i].getInternalTexture():null;return r?(this._blendBackTexture!==r&&(this._blendBackTexture=r,this._blendBackMrt.setInternalTexture(this._blendBackTexture,0),this._thinTextures[6]&&this._thinTextures[6].dispose(),this._thinTextures[6]=new vu(this._blendBackTexture),t.defaultRT.renderTarget.shareDepth(this._depthMrts[0].renderTarget)),!0):!1}_createEffects(){this._blendBackEffectWrapper=new os({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._blendBackEffectWrapperPingPong=new os({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._finalEffectWrapper=new os({fragmentShader:"oitFinal",useShaderStore:!0,engine:this._engine,samplerNames:["uFrontColor","uBackColor"],uniformNames:[]}),this._effectRenderer=new sa(this._engine)}setPrePassRenderer(t){t.addEffectConfiguration(this._prePassEffectConfiguration)}bind(t){t.setTexture("oitDepthSampler",this._thinTextures[this._currentPingPongState*3]),t.setTexture("oitFrontColorSampler",this._thinTextures[this._currentPingPongState*3+1])}_renderSubMeshes(t){let i;this._useRenderPasses&&(i={});for(let r=0;r<t.length;r++){let n=t.data[r].getMaterial(),o=!0,a=!1,l=t.data[r],c,h=!1;if(this._useRenderPasses&&(c=l._getDrawWrapper(),h=!c),n&&(o=n.allowShaderHotSwapping,a=n.backFaceCulling,n.allowShaderHotSwapping=!1,n.backFaceCulling=!1),l.render(!1),h&&(c=l._getDrawWrapper(),c.materialContext)){let u=i[c.materialContext.uniqueId];u||(u=i[c.materialContext.uniqueId]=this._engine.createMaterialContext()),l._getDrawWrapper().materialContext=u}n&&(n.allowShaderHotSwapping=o,n.backFaceCulling=a)}}_finalCompose(t){this._scene.prePassRenderer?.setCustomOutput(this._outputRT)?this._engine.bindFramebuffer(this._outputRT.renderTarget):this._engine.restoreDefaultFramebuffer(),this._engine.setAlphaMode(0),this._engine.applyStates(),this._engine.enableEffect(this._finalEffectWrapper._drawWrapper),this._finalEffectWrapper.effect.setTexture("uFrontColor",this._thinTextures[t*3+1]),this._finalEffectWrapper.effect.setTexture("uBackColor",this._thinTextures[6]),this._effectRenderer.render(this._finalEffectWrapper)}isReady(){return this._blendBackEffectWrapper.effect.isReady()&&this._blendBackEffectWrapperPingPong.effect.isReady()&&this._finalEffectWrapper.effect.isReady()&&this._updateTextures()}render(t){if(this._candidateSubMeshes.length=0,this._excludedSubMeshes.length=0,!this.isReady())return this._excludedSubMeshes;this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport);for(let o=0;o<t.length;o++){let a=t.data[o],l=a.getMaterial(),c=l&&a.getRenderingMesh()._getRenderingFillMode(l.fillMode);l&&(c===se.TriangleFanDrawMode||c===se.TriangleFillMode||c===se.TriangleStripDrawMode)&&this._excludedMeshes.indexOf(a.getMesh().uniqueId)===-1?this._candidateSubMeshes.push(a):this._excludedSubMeshes.push(a)}if(!this._candidateSubMeshes.length)return this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._finalCompose(1),this._excludedSubMeshes;let i=this._engine.currentRenderPassId;this._scene.prePassRenderer._enabled=!1,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[0]),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[1],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthMask=!1,this._engine.depthCullingState.depthTest=!0,this._engine.applyStates(),this._currentPingPongState=1,this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._scene.resetCachedMaterial();let r=0,n=0;for(let o=0;o<this._passCount;o++){r=o%2,n=1-r,this._currentPingPongState=r,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[o+1]),this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport),this._engine.bindFramebuffer(this._depthMrts[n].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[n].renderTarget),this._engine.bindFramebuffer(this._colorMrts[n].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[n].renderTarget),this._engine.bindFramebuffer(this._depthMrts[n].renderTarget),this._engine.bindAttachments(this._layoutCache[2]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthTest=!1,this._engine.applyStates(),this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[n].renderTarget),this._scene.resetCachedMaterial(),this._engine.bindFramebuffer(this._blendBackMrt.renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaEquation(0),this._engine.setAlphaMode(17),this._engine.applyStates();let a=n===0||!this._useRenderPasses?this._blendBackEffectWrapper:this._blendBackEffectWrapperPingPong;this._engine.enableEffect(a._drawWrapper),a.effect.setTexture("uBackColor",this._thinTextures[n*3+2]),this._effectRenderer.render(a),this._engine.unBindFramebuffer(this._blendBackMrt.renderTarget)}return this._engine.currentRenderPassId=i,this._finalCompose(n),this._scene.prePassRenderer._enabled=!0,this._engine.depthCullingState.depthMask=!0,this._engine.depthCullingState.depthTest=!0,this._excludedSubMeshes}dispose(){this._disposeTextures(),this._blendBackEffectWrapper.dispose(),this._finalEffectWrapper.dispose(),this._effectRenderer.dispose(),this._releaseRenderPassIds()}}return s._DEPTH_CLEAR_VALUE=-99999,s._MIN_DEPTH=0,s._MAX_DEPTH=1,s})();Object.defineProperty(Te.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){let s=this._getComponent(ye.NAME_DEPTHPEELINGRENDERER);s||(s=new hM(this),this._addComponent(s))}return this._depthPeelingRenderer},set:function(s){this._depthPeelingRenderer=s},enumerable:!0,configurable:!0});Object.defineProperty(Te.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(s){this._useOrderIndependentTransparency!==s&&(this._useOrderIndependentTransparency=s,this.markAllMaterialsAsDirty(63),this.prePassRenderer?.markAsDirty())},enumerable:!0,configurable:!0});var hM=class{constructor(e){this.name=ye.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new kV(e)}register(){}rebuild(){}dispose(){this.scene.depthPeelingRenderer?.dispose(),this.scene.depthPeelingRenderer=null}};var tK="linePixelShader",iK=`#include<clipPlaneFragmentDeclaration>
uniform vec4 color;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<logDepthFragment>
#include<clipPlaneFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;D.ShadersStore[tK]=iK;var rK="lineVertexDeclaration",sK=`uniform mat4 viewProjection;
#define ADDITIONAL_VERTEX_DECLARATION
`;D.IncludesShadersStore[rK]=sK;var nK="lineUboDeclaration",oK=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;D.IncludesShadersStore[nK]=oK;var aK="lineVertexShader",lK=`#include<__decl__lineVertex>
#include<instancesDeclaration>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;attribute vec4 normal;uniform float width;uniform float aspectRatio;
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
mat4 worldViewProjection=viewProjection*finalWorld;vec4 viewPosition=worldViewProjection*vec4(position,1.0);vec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);vec2 currentScreen=viewPosition.xy/viewPosition.w;vec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;currentScreen.x*=aspectRatio;nextScreen.x*=aspectRatio;vec2 dir=normalize(nextScreen-currentScreen);vec2 normalDir=vec2(-dir.y,dir.x);normalDir*=width/2.0;normalDir.x/=aspectRatio;vec4 offset=vec4(normalDir*normal.w,0.0,0.0);gl_Position=viewPosition+offset;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=finalWorld*vec4(position,1.0);
#include<clipPlaneVertex>
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[aK]=lK;lt.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this};lt.prototype.enableEdgesRendering=function(s=.95,e=!1,t){return this.disableEdgesRendering(),this._edgesRenderer=new JC(this,s,e,!0,t),this};Object.defineProperty(lt.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0});Ka.prototype.enableEdgesRendering=function(s=.95,e=!1){return this.disableEdgesRendering(),this._edgesRenderer=new dM(this,s,e),this};mm.prototype.enableEdgesRendering=function(s=.95,e=!1){return Ka.prototype.enableEdgesRendering.apply(this,arguments),this};var uM=class{constructor(){this.edges=[],this.edgesConnectedCount=0}},JC=class s{get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e){if(!e._edgeRenderLineShader){let t=new Fi("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"],uniformBuffers:["Scene","Mesh"]},!1);t.disableDepthWrite=!0,t.backFaceCulling=!1,t.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=t}return e._edgeRenderLineShader}constructor(e,t=.95,i=!1,r=!0,n){this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new _i(32),this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=n??null,this._epsilon=t,this._source.getScene().getEngine().isWebGPU&&(this._drawWrapper=new Xt(e.getEngine())),this._prepareRessources(),r&&(n?.useAlternateEdgeFinder??!0?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add(()=>{this._rebuild()}),this._meshDisposeObserver=this._source.onDisposeObservable.add(()=>{this.dispose()})}_prepareRessources(){this._lineShader||(this._lineShader=s._GetShader(this._source.getScene()))}_rebuild(){let e=this._buffers[y.PositionKind];e&&e._rebuild(),e=this._buffers[y.NormalKind],e&&e._rebuild();let i=this._source.getScene().getEngine();this._ib=i.createIndexBuffer(this._linesIndices)}dispose(){this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let e=this._buffers[y.PositionKind];e&&(e.dispose(),this._buffers[y.PositionKind]=null),e=this._buffers[y.NormalKind],e&&(e.dispose(),this._buffers[y.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose(),this._drawWrapper?.dispose()}_processEdgeForAdjacencies(e,t,i,r,n){return e===i&&t===r||e===r&&t===i?0:e===r&&t===n||e===n&&t===r?1:e===n&&t===i||e===i&&t===n?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,r,n){return e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(r,1e-10)||e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(i,1e-10)?0:e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(n,1e-10)||e.equalsWithEpsilon(n,1e-10)&&t.equalsWithEpsilon(r,1e-10)?1:e.equalsWithEpsilon(n,1e-10)&&t.equalsWithEpsilon(i,1e-10)||e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(n,1e-10)?2:-1}_checkEdge(e,t,i,r,n){let o;t===void 0?o=!0:o=p.Dot(i[e],i[t])<this._epsilon,o&&this.createLine(r,n,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,r){let n=(L,G,W)=>{W>=0&&G.push(W);for(let $=0;$<L.length;++$)G.push(L[$][0])},o=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?o=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(o=2);for(let L=0;L<3;++L)L===o?e[L].sort((G,W)=>G[1]<W[1]?-1:G[1]>W[1]?1:0):e[L].sort((G,W)=>G[1]>W[1]?-1:G[1]<W[1]?1:0);let a=[],l=[];n(e[o],a,-1);let c=a.length;for(let L=o+2;L>=o+1;--L)n(e[L%3],l,L!==o+2?r[i[t+(L+1)%3]]:-1);let h=l.length,u=0,d=0;i.push(r[i[t+o]],a[0],l[0]),i.push(r[i[t+(o+1)%3]],l[h-1],a[c-1]);let f=c<=h,m=f?c:h,g=f?h:c,_=f?c-1:h-1,x=f?0:1,b=c+h-2,C=f?u:d,R=f?d:u,E=f?a:l,S=f?l:a,A=0;for(;b-- >0;){x?i.push(E[C],S[R]):i.push(S[R],E[C]),A+=m;let L;A>=g&&C<_?(L=E[++C],A-=g):L=S[++R],i.push(L)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){let e=this._source.getVerticesData(y.PositionKind),t=this._source.getIndices();if(!t||!e)return;Array.isArray(t)||(t=Array.from(t));let i=this._options?.useFastVertexMerger??!0,r=i?Math.round(-Math.log(this._options?.epsilonVertexMerge??1e-6)/Math.log(10)):this._options?.epsilonVertexMerge??1e-6,n=[],o=[];if(i){let c={};for(let h=0;h<e.length;h+=3){let u=e[h+0],d=e[h+1],f=e[h+2],m=u.toFixed(r)+"|"+d.toFixed(r)+"|"+f.toFixed(r);if(c[m]!==void 0)n.push(c[m]);else{let g=h/3;c[m]=g,n.push(g),o.push(g)}}}else for(let c=0;c<e.length;c+=3){let h=e[c+0],u=e[c+1],d=e[c+2],f=!1;for(let m=0;m<c&&!f;m+=3){let g=e[m+0],_=e[m+1],x=e[m+2];if(Math.abs(h-g)<r&&Math.abs(u-_)<r&&Math.abs(d-x)<r){n.push(m/3),f=!0;break}}f||(n.push(c/3),o.push(c/3))}if(this._options?.applyTessellation){let c=this._options?.epsilonVertexAligned??1e-6,h=[];for(let u=0;u<t.length;u+=3){let d;for(let f=0;f<3;++f){let m=n[t[u+f]],g=n[t[u+(f+1)%3]],_=n[t[u+(f+2)%3]];if(m===g)continue;let x=e[m*3+0],b=e[m*3+1],C=e[m*3+2],R=e[g*3+0],E=e[g*3+1],S=e[g*3+2],A=Math.sqrt((R-x)*(R-x)+(E-b)*(E-b)+(S-C)*(S-C));for(let L=0;L<o.length-1;L++){let G=o[L];if(G===m||G===g||G===_)continue;let W=e[G*3+0],$=e[G*3+1],re=e[G*3+2],we=Math.sqrt((W-x)*(W-x)+($-b)*($-b)+(re-C)*(re-C)),_e=Math.sqrt((W-R)*(W-R)+($-E)*($-E)+(re-S)*(re-S));Math.abs(we+_e-A)<c&&(d||(d={index:u,edgesPoints:[[],[],[]]},h.push(d)),d.edgesPoints[f].push([G,we]))}}}for(let u=0;u<h.length;++u){let d=h[u];this._tessellateTriangle(d.edgesPoints,d.index,t,n)}h.length=0}let a={};for(let c=0;c<t.length;c+=3){let h;for(let u=0;u<3;++u){let d=n[t[c+u]],f=n[t[c+(u+1)%3]],m=n[t[c+(u+2)%3]];if(d===f||(d===m||f===m)&&this._options?.removeDegeneratedTriangles)continue;if(O.Vector3[0].copyFromFloats(e[d*3+0],e[d*3+1],e[d*3+2]),O.Vector3[1].copyFromFloats(e[f*3+0],e[f*3+1],e[f*3+2]),O.Vector3[2].copyFromFloats(e[m*3+0],e[m*3+1],e[m*3+2]),h||(O.Vector3[1].subtractToRef(O.Vector3[0],O.Vector3[3]),O.Vector3[2].subtractToRef(O.Vector3[1],O.Vector3[4]),h=p.Cross(O.Vector3[3],O.Vector3[4]),h.normalize()),d>f){let x=d;d=f,f=x}let g=d+"_"+f,_=a[g];_?_.done||(p.Dot(h,_.normal)<this._epsilon&&this.createLine(O.Vector3[0],O.Vector3[1],this._linesPositions.length/3),_.done=!0):a[g]={normal:h,done:!1,index:c,i:u}}}for(let c in a){let h=a[c];if(!h.done){let u=n[t[h.index+h.i]],d=n[t[h.index+(h.i+1)%3]];O.Vector3[0].copyFromFloats(e[u*3+0],e[u*3+1],e[u*3+2]),O.Vector3[1].copyFromFloats(e[d*3+0],e[d*3+1],e[d*3+2]),this.createLine(O.Vector3[0],O.Vector3[1],this._linesPositions.length/3)}}let l=this._source.getScene().getEngine();this._buffers[y.PositionKind]=new y(l,this._linesPositions,y.PositionKind,!1),this._buffers[y.NormalKind]=new y(l,this._linesNormals,y.NormalKind,!1,!1,4),this._buffersForInstances[y.PositionKind]=this._buffers[y.PositionKind],this._buffersForInstances[y.NormalKind]=this._buffers[y.NormalKind],this._ib=l.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){let e=this._source.getVerticesData(y.PositionKind),t=this._source.getIndices();if(!t||!e)return;let i=[],r=[],n,o;for(n=0;n<t.length;n+=3){o=new uM;let l=t[n],c=t[n+1],h=t[n+2];o.p0=new p(e[l*3],e[l*3+1],e[l*3+2]),o.p1=new p(e[c*3],e[c*3+1],e[c*3+2]),o.p2=new p(e[h*3],e[h*3+1],e[h*3+2]);let u=p.Cross(o.p1.subtract(o.p0),o.p2.subtract(o.p1));u.normalize(),r.push(u),i.push(o)}for(n=0;n<i.length;n++){o=i[n];for(let l=n+1;l<i.length;l++){let c=i[l];if(o.edgesConnectedCount===3)break;if(c.edgesConnectedCount===3)continue;let h=t[l*3],u=t[l*3+1],d=t[l*3+2];for(let f=0;f<3;f++){let m=0;if(o.edges[f]===void 0){switch(f){case 0:this._checkVerticesInsteadOfIndices?m=this._processEdgeForAdjacenciesWithVertices(o.p0,o.p1,c.p0,c.p1,c.p2):m=this._processEdgeForAdjacencies(t[n*3],t[n*3+1],h,u,d);break;case 1:this._checkVerticesInsteadOfIndices?m=this._processEdgeForAdjacenciesWithVertices(o.p1,o.p2,c.p0,c.p1,c.p2):m=this._processEdgeForAdjacencies(t[n*3+1],t[n*3+2],h,u,d);break;case 2:this._checkVerticesInsteadOfIndices?m=this._processEdgeForAdjacenciesWithVertices(o.p2,o.p0,c.p0,c.p1,c.p2):m=this._processEdgeForAdjacencies(t[n*3+2],t[n*3],h,u,d);break}if(m!==-1&&(o.edges[f]=l,c.edges[m]=n,o.edgesConnectedCount++,c.edgesConnectedCount++,o.edgesConnectedCount===3))break}}}}for(n=0;n<i.length;n++){let l=i[n];this._checkEdge(n,l.edges[0],r,l.p0,l.p1),this._checkEdge(n,l.edges[1],r,l.p1,l.p2),this._checkEdge(n,l.edges[2],r,l.p2,l.p0)}let a=this._source.getScene().getEngine();this._buffers[y.PositionKind]=new y(a,this._linesPositions,y.PositionKind,!1),this._buffers[y.NormalKind]=new y(a,this._linesNormals,y.NormalKind,!1,!1,4),this._buffersForInstances[y.PositionKind]=this._buffers[y.PositionKind],this._buffersForInstances[y.NormalKind]=this._buffers[y.NormalKind],this._ib=a.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){let e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera){this._lineShader._setDrawWrapper(t);return}let i=this._source.hasInstances&&this.customInstances.length>0,r=i||this._source.hasThinInstances,n=0;if(r)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){let a=this._source._instanceDataStorage;if(n=this.customInstances.length,!a.instancesData){this._source.getScene()._activeMeshesFrozen||this.customInstances.reset();return}if(!a.isFrozen){let l=0;for(let c=0;c<n;++c)this.customInstances.data[c].copyToArray(a.instancesData,l),l+=16;a.instancesBuffer.updateDirectly(a.instancesData,0,n)}}else n=this._source.thinInstanceCount;let o=e.getEngine();this._lineShader._preBind(),this._source.edgesColor.a!==1?o.setAlphaMode(2):o.setAlphaMode(0),o.bindBuffers(r?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===Ce.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",o.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix(),this._source),o.drawElementsType(se.TriangleFillMode,0,this._indicesCount,n),this._lineShader.unbind(),r&&o.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)}},dM=class extends JC{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){let e=this._source.getVerticesData(y.PositionKind),t=this._source.getIndices();if(!t||!e)return;let i=O.Vector3[0],r=O.Vector3[1],n=t.length-1;for(let a=0,l=0;a<n;a+=2,l+=4)p.FromArrayToRef(e,3*t[a],i),p.FromArrayToRef(e,3*t[a+1],r),this.createLine(i,r,l);let o=this._source.getScene().getEngine();this._buffers[y.PositionKind]=new y(o,this._linesPositions,y.PositionKind,!1),this._buffers[y.NormalKind]=new y(o,this._linesNormals,y.NormalKind,!1,!1,4),this._ib=o.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}};var eb=class extends Rn{constructor(e,t,i,r,n,o){super(e,i,r,n,o),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=t}_createCompositionEffect(){this.imageProcessingPostProcess=new Nh("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()}_checkSize(){let e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),r=this.getRenderHeight();(i!==e||r!==t)&&(this.resize({width:e,height:t}),this._internalTextureDirty=!0)}updateCount(e,t,i){super.updateCount(e,t,i),this._internalTextureDirty=!0}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0}dispose(){let e=this._scene;if(super.dispose(),e&&e.prePassRenderer){let t=e.prePassRenderer.renderTargets.indexOf(this);t!==-1&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())}};var fM=(()=>{class s{get generateNormalsInWorldSpace(){return this._generateNormalsInWorldSpace}set generateNormalsInWorldSpace(t){this._generateNormalsInWorldSpace!==t&&(this._generateNormalsInWorldSpace=t,this._markAllMaterialsAsPrePassDirty())}getIndex(t){return this._textureIndices[t]}get samples(){return this.defaultRT.samples}set samples(t){this.defaultRT.samples=t}get useSpecificClearForDepthTexture(){return this._useSpecificClearForDepthTexture}set useSpecificClearForDepthTexture(t){this._useSpecificClearForDepthTexture!==t&&(this._useSpecificClearForDepthTexture=t,this._isDirty=!0)}getRenderTarget(){return this._currentTarget}_setRenderTarget(t){t?this._currentTarget=t:(this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=this._scene.activeCamera?.renderPassId??this._currentTarget.renderPassId)}get currentRTisSceneRT(){return this._currentTarget===this.defaultRT}_refreshGeometryBufferRendererLink(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer){this.doNotUseGeometryRendererFallback=!0;return}this._geometryBuffer._linkPrePassRenderer(this)}}get enabled(){return this._enabled}constructor(t){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtTypes=[],this._mrtFormats=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._generateNormalsInWorldSpace=!1,this._useSpecificClearForDepthTexture=!1,this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this._clearColor=new oe(0,0,0,0),this._clearDepthColor=new oe(1e8,0,0,1),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=t,this._engine=t.getEngine();let i=0;this._engine._caps.textureFloat&&this._engine._caps.textureFloatLinearFiltering?i=1:this._engine._caps.textureHalfFloat&&this._engine._caps.textureHalfFloatLinearFiltering&&(i=2);for(let r=0;r<s.TextureFormats.length;++r){let n=s.TextureFormats[r].format;s.TextureFormats[r].type===1&&(s.TextureFormats[5].type=i,(n===6||n===7||n===5)&&!this._engine._caps.supportFloatTexturesResolve&&(s.TextureFormats[5].type=2))}s._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT}_createRenderTarget(t,i){let r=new eb(t,i,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(r),this._enabled&&this._update(),r}get isSupported(){return this._scene.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(t,i){let r=i.getMaterial(),n=r&&r.isPrePassCapable,o=r&&this.excludedMaterials.indexOf(r)!==-1;this.enabled&&this._currentTarget.enabled&&(t._multiTarget&&n&&!o?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!o&&this._geometryBuffer.renderList.push(i.getRenderingMesh())))}_reinitializeAttachments(){let t=[],i=[!1],r=[!1],n=[!0];for(let o=0;o<this.mrtCount;o++)t.push(!0),o>0&&(this._useSpecificClearForDepthTexture&&this._mrtLayout[o]===5?(i.push(!1),r.push(!0)):(i.push(!0),r.push(!1)),n.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(t),this._clearAttachments=this._engine.buildTextureLayout(i),this._clearDepthAttachments=this._engine.buildTextureLayout(r),this._defaultAttachments=this._engine.buildTextureLayout(n)}_resetLayout(){for(let t=0;t<s.TextureFormats.length;t++)this._textureIndices[s.TextureFormats[t].purpose]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtTypes=[s.TextureFormats[4].type],this._mrtFormats=[s.TextureFormats[4].format],this._mrtNames=[s.TextureFormats[4].name],this.mrtCount=1}_updateGeometryBufferLayout(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();let t=[];for(let r=0;r<this._mrtLayout.length;r++)t.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());let i=[{prePassConstant:5,geometryBufferConstant:Xr.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:Xr.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:Xr.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:Xr.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:Xr.VELOCITY_TEXTURE_TYPE}];for(let r=0;r<i.length;r++){let n=this._mrtLayout.indexOf(i[r].prePassConstant);n!==-1&&(this._geometryBuffer._forceTextureType(i[r].geometryBufferConstant,n),t[n]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(t))}}restoreAttachments(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment())}_beforeDraw(t,i,r){this._isDirty&&this._update(),!(!this._enabled||!this._currentTarget.enabled)&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,t))}_prepareFrame(t,i,r){t.renderTargetTexture?t.renderTargetTexture._prepareFrame(this._scene,i,r,t.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()}setCustomOutput(t){let i=this._postProcessesSourceForThisPass[0];return i?(i.inputTexture=t.renderTarget,!0):!1}_renderPostProcesses(t,i){let r=this._postProcessesSourceForThisPass[0],n=r?r.inputTexture:t.renderTargetTexture?t.renderTargetTexture.renderTarget:null,o=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(o=o.concat([this._currentTarget.imageProcessingPostProcess])),o.length&&(this._scene.postProcessManager._prepareFrame(this._currentTarget.renderTarget?.texture,o),this._scene.postProcessManager.directRender(o,n,!1,i))}_afterDraw(t,i){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,t,i),this._renderPostProcesses(this._currentTarget,t))}_clear(){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._useSpecificClearForDepthTexture&&(this._engine.bindAttachments(this._clearDepthAttachments),this._engine.clear(this._clearDepthColor,!0,!1,!1)),this._engine.bindAttachments(this._defaultAttachments))}_bindFrameBuffer(){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();let t=this._currentTarget.renderTarget;t&&this._engine.bindFramebuffer(t)}}_setEnabled(t){this._enabled=t}_setRenderTargetEnabled(t,i){t.enabled=i,i||this._unlinkInternalTexture(t)}addEffectConfiguration(t){for(let i=0;i<this._effectConfigurations.length;i++)if(this._effectConfigurations[i].name===t.name)return this._effectConfigurations[i];return this._effectConfigurations.push(t),t}getEffectConfiguration(t){for(let i=0;i<this._effectConfigurations.length;i++)if(this._effectConfigurations[i].name===t)return this._effectConfigurations[i];return null}_enable(){let t=this.mrtCount;for(let i=0;i<this._effectConfigurations.length;i++)this._effectConfigurations[i].enabled&&this._enableTextures(this._effectConfigurations[i].texturesRequired);for(let i=0;i<this.renderTargets.length;i++){(this.mrtCount!==t||this.renderTargets[i].count!==this.mrtCount)&&this.renderTargets[i].updateCount(this.mrtCount,{types:this._mrtTypes,formats:this._mrtFormats},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[i]._resetPostProcessChain();for(let r=0;r<this._effectConfigurations.length;r++)this._effectConfigurations[r].enabled&&(!this._effectConfigurations[r].postProcess&&this._effectConfigurations[r].createPostProcess&&this._effectConfigurations[r].createPostProcess(),this._effectConfigurations[r].postProcess&&this.renderTargets[i]._beforeCompositionPostProcesses.push(this._effectConfigurations[r].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()}_disable(){this._setEnabled(!1);for(let t=0;t<this.renderTargets.length;t++)this._setRenderTargetEnabled(this.renderTargets[t],!1);this._resetLayout();for(let t=0;t<this._effectConfigurations.length;t++)this._effectConfigurations[t].enabled=!1}_getPostProcessesSource(t,i){if(i)return i._postProcesses;if(t.renderTargetTexture)if(t.renderTargetTexture.useCameraPostProcesses){let r=t.renderTargetTexture.activeCamera?t.renderTargetTexture.activeCamera:this._scene.activeCamera;return r?r._postProcesses:[]}else return t.renderTargetTexture.postProcesses?t.renderTargetTexture.postProcesses:[];else return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]}_setupOutputForThisPass(t,i){let r=i&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&this._scene.activeCameras.indexOf(i)!==0;this._postProcessesSourceForThisPass=this._getPostProcessesSource(t,i),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter(c=>c!=null),this._scene.autoClear=!0;let n=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!n&&!this.disableGammaTransform&&this._needsImageProcessing()&&!r;let o=this._getFirstPostProcess(this._postProcessesSourceForThisPass),a=t._beforeCompositionPostProcesses&&t._beforeCompositionPostProcesses[0],l=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||n,this._needsCompositionForThisPass&&!t.imageProcessingPostProcess&&t._createCompositionEffect(),a?l=a:this._needsCompositionForThisPass?l=t.imageProcessingPostProcess:o&&(l=o),this._bindFrameBuffer(),this._linkInternalTexture(t,l)}_linkInternalTexture(t,i){i&&(i.autoClear=!1,i.inputTexture=t.renderTarget),t._outputPostProcess!==i&&(t._outputPostProcess&&this._unlinkInternalTexture(t),t._outputPostProcess=i),t._internalTextureDirty&&(this._updateGeometryBufferLayout(),t._internalTextureDirty=!1)}_unlinkInternalTexture(t){t._outputPostProcess&&(t._outputPostProcess.autoClear=!0,t._outputPostProcess.restoreDefaultInputTexture(),t._outputPostProcess=null)}_needsImageProcessing(){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].enabled&&this._effectConfigurations[t].needsImageProcessing)return!0;return!1}_hasImageProcessing(t){let i=!1;if(t){for(let r=0;r<t.length;r++)if(t[r]?.getClassName()==="ImageProcessingPostProcess"){i=!0;break}}return i}_getFirstPostProcess(t){for(let i=0;i<t.length;i++)if(t[i]!==null)return t[i];return null}markAsDirty(){this._isDirty=!0}_enableTextures(t){this._scene.needsPreviousWorldMatrices=!1;for(let i=0;i<t.length;i++){let r=t[i];this._textureIndices[r]===-1&&(this._textureIndices[r]=this._mrtLayout.length,this._mrtLayout.push(r),this._mrtTypes.push(s.TextureFormats[r].type),this._mrtFormats.push(s.TextureFormats[r].format),this._mrtNames.push(s.TextureFormats[r].name),this.mrtCount++),r===2&&(this._scene.needsPreviousWorldMatrices=!0)}}update(){this._isDirty&&this._update()}_update(){this._disable();let t=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),t=!0);for(let r=0;r<this._scene.materials.length;r++)this._scene.materials[r].setPrePassRenderer(this)&&(t=!0);t&&this._setRenderTargetEnabled(this.defaultRT,!0);let i;for(let r=0;r<this.renderTargets.length;r++){if(this.renderTargets[r].renderTargetTexture)i=this._getPostProcessesSource(this.renderTargets[r]);else{let n=this._scene.activeCamera;if(!n)continue;i=n._postProcesses}if(i&&(i=i.filter(n=>n!=null),i)){for(let n=0;n<i.length;n++)i[n].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[r],!0),t=!0);this._hasImageProcessing(i)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,t&&this._enable()}_markAllMaterialsAsPrePassDirty(){let t=this._scene.materials;for(let i=0;i<t.length;i++)t[i].markAsDirty(se.PrePassDirtyFlag)}dispose(){for(let t=this.renderTargets.length-1;t>=0;t--)this.renderTargets[t].dispose();for(let t=0;t<this._effectConfigurations.length;t++)this._effectConfigurations[t].dispose&&this._effectConfigurations[t].dispose()}}return s._SceneComponentInitialization=e=>{throw We("PrePassRendererSceneComponent")},s.TextureFormats=[{purpose:0,type:2,format:5,name:"prePass_Irradiance"},{purpose:1,type:2,format:5,name:"prePass_Position"},{purpose:2,type:0,format:5,name:"prePass_Velocity"},{purpose:3,type:0,format:5,name:"prePass_Reflectivity"},{purpose:4,type:2,format:5,name:"prePass_Color"},{purpose:5,type:1,format:6,name:"prePass_Depth"},{purpose:6,type:2,format:5,name:"prePass_Normal"},{purpose:7,type:0,format:5,name:"prePass_Albedo"}],s})();Object.defineProperty(Te.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(s){s&&s.isSupported&&(this._prePassRenderer=s)},enumerable:!0,configurable:!0});Te.prototype.enablePrePassRenderer=function(){return this._prePassRenderer?this._prePassRenderer:(this._prePassRenderer=new fM(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,F.Error(`PrePassRenderer needs WebGL 2 support.
Maybe you tried to use the following features that need the PrePassRenderer :
 + Subsurface Scattering`)),this._prePassRenderer)};Te.prototype.disablePrePassRenderer=function(){this._prePassRenderer&&(this._prePassRenderer.dispose(),this._prePassRenderer=null)};var pM=class{constructor(e){this.name=ye.NAME_PREPASSRENDERER,this.scene=e}register(){this.scene._beforeCameraDrawStage.registerStep(ye.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(ye.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(ye.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(ye.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(ye.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(ye.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(ye.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(ye.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)}_beforeRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))}_afterRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())}_beforeRenderingMeshStage(e,t,i,r){if(!r)return;let n=e.getScene();n.prePassRenderer&&n.prePassRenderer.bindAttachmentsForEffect(r,t)}_afterRenderingMeshStage(e){let t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()}rebuild(){}dispose(){this.scene.disablePrePassRenderer()}};fM._SceneComponentInitialization=s=>{let e=s._getComponent(ye.NAME_PREPASSRENDERER);e||(e=new pM(s),s._addComponent(e))};var cK="fibonacci",hK=`#define rcp(x) 1./x
#define GOLDEN_RATIO 1.618033988749895
#define TWO_PI 6.2831855
vec2 Golden2dSeq(int i,float n)
{return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));}
vec2 SampleDiskGolden(int i,int sampleCount)
{vec2 f=Golden2dSeq(i,float(sampleCount));return vec2(sqrt(f.x),TWO_PI*f.y);}`;D.IncludesShadersStore[cK]=hK;var uK="diffusionProfile",dK="uniform vec3 diffusionS[5];uniform float diffusionD[5];uniform float filterRadii[5];";D.IncludesShadersStore[uK]=dK;var fK="subSurfaceScatteringPixelShader",pK=`#include<fibonacci>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<diffusionProfile>
varying vec2 vUV;uniform vec2 texelSize;uniform sampler2D textureSampler;uniform sampler2D irradianceSampler;uniform sampler2D depthSampler;uniform sampler2D albedoSampler;uniform vec2 viewportSize;uniform float metersPerUnit;const float LOG2_E=1.4426950408889634;const float SSS_PIXELS_PER_SAMPLE=4.;const int _SssSampleBudget=40;
#define rcp(x) 1./x
#define Sq(x) x*x
#define SSS_BILATERAL_FILTER true
vec3 EvalBurleyDiffusionProfile(float r,vec3 S)
{vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); 
vec3 expSum=exp_13*(1.+exp_13*exp_13); 
return (S*rcp(8.*PI))*expSum; }
vec2 SampleBurleyDiffusionProfile(float u,float rcpS)
{u=1.-u; 
float g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));float n=exp2(log2(g)*(-1.0/3.0)); 
float p=(g*n)*n; 
float c=1.+p+n; 
float d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); 
float x=(3./LOG2_E)*log2(c)-d; 
float rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));float r=x*rcpS;float rcpPdf=(8.*PI*rcpS)*rcpExp; 
return vec2(r,rcpPdf);}
vec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)
{
#ifndef SSS_BILATERAL_FILTER
z=0.;
#endif
float r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));float area=rcpPdf;
#if SSS_CLAMP_ARTIFACT
return clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);
#else
return EvalBurleyDiffusionProfile(r,S)*area;
#endif
}
void EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,
float phase,inout vec3 totalIrradiance,inout vec3 totalWeight)
{float scale =rcp(float(n));float offset=rcp(float(n))*0.5;float sinPhase,cosPhase;sinPhase=sin(phase);cosPhase=cos(phase);vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);float r=bdp.x;float rcpPdf=bdp.y;float phi=SampleDiskGolden(i,n).y;float sinPhi,cosPhi;sinPhi=sin(phi);cosPhi=cos(phi);float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; 
float cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; 
vec2 vec=r*vec2(cosPsi,sinPsi);vec2 position; 
float xy2;position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;xy2 =r*r;vec4 textureSample=texture2D(irradianceSampler,position);float viewZ=texture2D(depthSampler,position).r;vec3 irradiance =textureSample.rgb;if (testLightingForSSS(textureSample.a))
{float relZ=viewZ-centerPosVS.z;vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);totalIrradiance+=weight*irradiance;totalWeight +=weight;}
else
{}}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));float centerDepth =0.;vec4 inputColor=texture2D(textureSampler,vUV);bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);if (passedStencilTest)
{centerDepth=texture2D(depthSampler,vUV).r;}
if (!passedStencilTest) { 
gl_FragColor=inputColor;return;}
float distScale =1.;vec3 S =diffusionS[diffusionProfileIndex];float d =diffusionD[diffusionProfileIndex];float filterRadius=filterRadii[diffusionProfileIndex];vec2 centerPosNDC=vUV;vec2 cornerPosNDC=vUV+0.5*texelSize;vec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; 
vec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; 
float mmPerUnit =1000.*(metersPerUnit*rcp(distScale));float unitsPerMm=rcp(mmPerUnit);float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);float pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;float filterArea =PI*Sq(filterRadius*pixelsPerMm);int sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));int sampleBudget=_SssSampleBudget;int texturingMode=0;vec3 albedo =texture2D(albedoSampler,vUV).rgb;if (distScale==0. || sampleCount<1)
{
#ifdef DEBUG_SSS_SAMPLES
vec3 green=vec3(0.,1.,0.);gl_FragColor=vec4(green,1.0);return;
#endif
gl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);return;}
#ifdef DEBUG_SSS_SAMPLES
vec3 red =vec3(1.,0.,0.);vec3 blue=vec3(0.,0.,1.);gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);return;
#endif
float phase=0.;int n=min(sampleCount,sampleBudget);vec3 centerWeight =vec3(0.); 
vec3 totalIrradiance=vec3(0.);vec3 totalWeight =vec3(0.);for (int i=0; i<n; i++)
{EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,
phase,totalIrradiance,totalWeight);}
totalWeight=max(totalWeight,HALF_MIN);gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);}`;D.ShadersStore[fK]=pK;var tb=class extends ve{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,i,r=null,n,o,a,l=0){super(e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],i,r,n||z.BILINEAR_SAMPLINGMODE,o,a,null,l,"postprocess",void 0,!0),this._scene=t,this.updateEffect(),this.onApplyObservable.add(c=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration){F.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");return}let h=this.texelSize;c.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),c.setFloat2("texelSize",h.x,h.y),c.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),c.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),c.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),c.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),c.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),c.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),c.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)})}};var mM=(()=>{class s{get ssDiffusionS(){return this._ssDiffusionS}get ssDiffusionD(){return this._ssDiffusionD}get ssFilterRadii(){return this._ssFilterRadii}constructor(t){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=ye.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new X(1,1,1)),this._scene=t,s._SceneComponentInitialization(this._scene)}addDiffusionProfile(t){if(this.ssDiffusionD.length>=5)return F.Error("You already reached the maximum number of diffusion profiles."),0;for(let i=0;i<this._ssDiffusionS.length/3;i++)if(this._ssDiffusionS[i*3]===t.r&&this._ssDiffusionS[i*3+1]===t.g&&this._ssDiffusionS[i*3+2]===t.b)return i;return this._ssDiffusionS.push(t.r,t.b,t.g),this._ssDiffusionD.push(Math.max(Math.max(t.r,t.b),t.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(t)),this.ssDiffusionProfileColors.push(t),this._ssDiffusionD.length-1}createPostProcess(){return this.postProcess=new tb("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(t){let r=Math.max(t.r,t.g,t.b);return this._sampleBurleyDiffusionProfile(.997,r)}_sampleBurleyDiffusionProfile(t,i){t=1-t;let r=1+4*t*(2*t+Math.sqrt(1+4*t*t)),n=Math.pow(r,-1/3),a=1+r*n*n+n;return 3*Math.log(a/(4*t))*i}}return s._SceneComponentInitialization=e=>{throw We("SubSurfaceSceneComponent")},s})();Jt.AddParser(ye.NAME_SUBSURFACE,(s,e)=>{if(s.ssDiffusionProfileColors!==void 0&&s.ssDiffusionProfileColors!==null&&(e.enableSubSurfaceForPrePass(),e.subSurfaceConfiguration))for(let t=0,i=s.ssDiffusionProfileColors.length;t<i;t++){let r=s.ssDiffusionProfileColors[t];e.subSurfaceConfiguration.addDiffusionProfile(new X(r.r,r.g,r.b))}});Object.defineProperty(Te.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(s){s&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=s)},enumerable:!0,configurable:!0});Te.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;let s=this.enablePrePassRenderer();return s?(this._subSurfaceConfiguration=new mM(this),s.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null};Te.prototype.disableSubSurfaceForPrePass=function(){this._subSurfaceConfiguration&&(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};var gM=class{constructor(e){this.name=ye.NAME_PREPASSRENDERER,this.scene=e}register(){}serialize(e){if(!this.scene.subSurfaceConfiguration)return;let t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(let i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}addFromContainer(){}removeFromContainer(){this.scene.prePassRenderer&&this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}};mM._SceneComponentInitialization=s=>{let e=s._getComponent(ye.NAME_SUBSURFACE);e||(e=new gM(s),s._addComponent(e))};var mK="outlinePixelShader",gK=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform vec4 color;
#ifdef ALPHATEST
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#include<logDepthFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;D.ShadersStore[mK]=gK;var _K="outlineVertexShader",xK=`attribute vec3 position;attribute vec3 normal;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
uniform float offset;
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef ALPHATEST
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
vec3 offsetPosition=positionUpdated+(normalUpdated*offset);
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(offsetPosition,1.0);gl_Position=viewProjection*worldPos;
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
}
`;D.ShadersStore[_K]=xK;Te.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new vK(this)),this._outlineRenderer};Object.defineProperty(k.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(s){s&&this.getScene().getOutlineRenderer(),this._renderOutline=s},enumerable:!0,configurable:!0});Object.defineProperty(k.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(s){s&&this.getScene().getOutlineRenderer(),this._renderOverlay=s},enumerable:!0,configurable:!0});var vK=(()=>{class s{constructor(t){this.name=ye.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this.scene=t,this._engine=t.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let i=0;i<4;++i)this._passIdForDrawWrapper[i]=this._engine.createRenderPassId(`Outline Renderer (${i})`)}register(){this.scene._beforeRenderingMeshStage.registerStep(ye.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(ye.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let t=0;t<this._passIdForDrawWrapper.length;++t)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[t])}render(t,i,r=!1,n){n=n??this._passIdForDrawWrapper[0];let o=this.scene,a=o.getEngine(),l=a.getCaps().instancedArrays&&(i.visibleInstances[t._id]!==null&&i.visibleInstances[t._id]!==void 0||t.getRenderingMesh().hasThinInstances);if(!this.isReady(t,l,n))return;let c=t.getMesh(),h=c._internalAbstractMeshDataInfo._actAsRegularMesh?c:null,u=t.getRenderingMesh(),d=h||u,f=t.getMaterial();if(!f||!o.activeCamera)return;let m=t._getDrawWrapper(n),g=Xt.GetEffect(m);if(a.enableEffect(m),f.useLogarithmicDepth&&g.setFloat("logarithmicDepthConstant",2/(Math.log(o.activeCamera.maxZ+1)/Math.LN2)),g.setFloat("offset",r?0:u.outlineWidth),g.setColor4("color",r?u.overlayColor:u.outlineColor,r?u.overlayAlpha:f.alpha),g.setMatrix("viewProjection",o.getTransformMatrix()),g.setMatrix("world",d.getWorldMatrix()),u.useBones&&u.computeBonesUsingShaders&&u.skeleton&&g.setMatrices("mBones",u.skeleton.getTransformMatrices(u)),u.morphTargetManager&&u.morphTargetManager.isUsingTextureForTargets&&u.morphTargetManager._bind(g),Vr(u,g),l||u._bind(t,g,f.fillMode),f&&f.needAlphaTesting()){let _=f.getAlphaTestTexture();_&&(g.setTexture("diffuseSampler",_),g.setMatrix("diffuseMatrix",_.getTextureMatrix()))}Yi(g,f,o),a.setZOffset(-this.zOffset),a.setZOffsetUnits(-this.zOffsetUnits),u._processRendering(d,t,g,f.fillMode,i,l,(_,x)=>{g.setMatrix("world",x)}),a.setZOffset(0),a.setZOffsetUnits(0)}isReady(t,i,r){r=r??this._passIdForDrawWrapper[0];let n=[],o=[y.PositionKind,y.NormalKind],a=t.getMesh(),l=t.getMaterial();if(!l)return!1;let c=a.getScene();l.needAlphaTesting()&&(n.push("#define ALPHATEST"),a.isVerticesDataPresent(y.UVKind)&&(o.push(y.UVKind),n.push("#define UV1")),a.isVerticesDataPresent(y.UV2Kind)&&(o.push(y.UV2Kind),n.push("#define UV2"))),l.useLogarithmicDepth&&n.push("#define LOGARITHMICDEPTH"),cs(l,c,n),a.useBones&&a.computeBonesUsingShaders?(o.push(y.MatricesIndicesKind),o.push(y.MatricesWeightsKind),a.numBoneInfluencers>4&&(o.push(y.MatricesIndicesExtraKind),o.push(y.MatricesWeightsExtraKind)),n.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),n.push("#define BonesPerMesh "+(a.skeleton?a.skeleton.bones.length+1:0))):n.push("#define NUM_BONE_INFLUENCERS 0");let h=a.morphTargetManager,u=0;h&&(u=h.numMaxInfluencers||h.numInfluencers,u>0&&(n.push("#define MORPHTARGETS"),n.push("#define NUM_MORPH_INFLUENCERS "+u),h.isUsingTextureForTargets&&n.push("#define MORPHTARGETS_TEXTURE"),oo(o,a,u))),i&&(n.push("#define INSTANCES"),Ds(o),t.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES"));let d=t._getDrawWrapper(r,!0),f=d.defines,m=n.join(`
`);if(f!==m){let g=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices"];er(g),d.setEffect(this.scene.getEngine().createEffect("outline",o,g,["diffuseSampler","morphTargets"],m,void 0,void 0,void 0,{maxSimultaneousMorphTargets:u}),m)}return d.effect.isReady()}_beforeRenderingMesh(t,i,r){if(this._savedDepthWrite=this._engine.getDepthWrite(),t.renderOutline){let n=i.getMaterial();n&&n.needAlphaBlendingForMesh(t)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(s._StencilReference),this._engine.setStencilFunctionReference(s._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(i,r,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(i,r,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),n&&n.needAlphaBlendingForMesh(t)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(t,i,r){if(t.renderOverlay){let n=this._engine.getAlphaMode(),o=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(i,r,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(n),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=o}t.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(i,r,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}}return s._StencilReference=4,s})();var vf=class{get particleSize(){return this._particleSize}set particleSize(e){e!==this._particleSize&&(this._particleSize=e,this.onParticleSizeChanged.notifyObservers(this))}get useInstancing(){return!this.indexBuffer}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity===e||!this._hasVelocity()||(this._useVelocity=e,this._effectsAreDirty=!0)}_hasVelocity(){return!!this.vertexBuffers?.velocity}get indexBuffer(){return null}getClassName(){return"FluidRenderingObject"}constructor(e){this.priority=0,this._particleSize=.1,this.onParticleSizeChanged=new U,this.particleThicknessAlpha=.05,this._useVelocity=!1,this._scene=e,this._engine=e.getEngine(),this._effectsAreDirty=!0,this._depthEffectWrapper=null,this._thicknessEffectWrapper=null}_createEffects(){let e=["view","projection","particleRadius","size"],t=["position","offset"],i=[];this._effectsAreDirty=!1,this.useVelocity&&(t.push("velocity"),i.push("#define FLUIDRENDERING_VELOCITY")),this._scene.useRightHandedSystem&&i.push("#define FLUIDRENDERING_RHS"),this._depthEffectWrapper=new os({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDepth",fragmentShader:"fluidRenderingParticleDepth",attributeNames:t,uniformNames:e,samplerNames:[],defines:i}),e.push("particleAlpha"),this._thicknessEffectWrapper=new os({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleThickness",fragmentShader:"fluidRenderingParticleThickness",attributeNames:["position","offset"],uniformNames:e,samplerNames:[]})}isReady(){if(this._effectsAreDirty&&this._createEffects(),!this._depthEffectWrapper||!this._thicknessEffectWrapper)return!1;let e=this._depthEffectWrapper._drawWrapper.effect,t=this._thicknessEffectWrapper._drawWrapper.effect;return e.isReady()&&t.isReady()}renderDepthTexture(){let e=this.numParticles;if(!this._depthEffectWrapper||e===0)return;let t=this._depthEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat2("size",this._particleSize,this._particleSize),i.setFloat("particleRadius",this._particleSize/2),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}renderThicknessTexture(){let e=this.numParticles;if(!this._thicknessEffectWrapper||e===0)return;let t=this._thicknessEffectWrapper._drawWrapper,i=t.effect;this._engine.setAlphaMode(6),this._engine.setDepthWrite(!1),this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat("particleAlpha",this.particleThicknessAlpha),i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0)}renderDiffuseTexture(){}dispose(){this._depthEffectWrapper?.dispose(!1),this._thicknessEffectWrapper?.dispose(!1)}};var ib=class extends vf{get particleSystem(){return this._particleSystem}getClassName(){return"FluidRenderingObjectParticleSystem"}get useTrueRenderingForDiffuseTexture(){return this._useTrueRenderingForDiffuseTexture}set useTrueRenderingForDiffuseTexture(e){this._useTrueRenderingForDiffuseTexture!==e&&(this._useTrueRenderingForDiffuseTexture=e,e?(this._particleSystem.blendMode=this._blendMode,this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null):(this._particleSystem.blendMode=-1,this._onBeforeDrawParticleObserver=this._particleSystem.onBeforeDrawParticlesObservable.add(()=>{this._engine.setAlphaMode(2)})))}get vertexBuffers(){return this._particleSystem.vertexBuffers}get indexBuffer(){return this._particleSystem.indexBuffer}constructor(e,t){super(e),this._useTrueRenderingForDiffuseTexture=!0,this._particleSystem=t,this._originalRender=t.render.bind(t),this._blendMode=t.blendMode,this._onBeforeDrawParticleObserver=null,this._updateInAnimate=this._particleSystem.updateInAnimate,this._particleSystem.updateInAnimate=!0,this._particleSystem.render=()=>0,this.particleSize=(t.minSize+t.maxSize)/2,this.useTrueRenderingForDiffuseTexture=!1}isReady(){return super.isReady()&&this._particleSystem.isReady()}get numParticles(){return this._particleSystem.getActiveCount()}renderDiffuseTexture(){this._originalRender()}dispose(){super.dispose(),this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null,this._particleSystem.render=this._originalRender,this._particleSystem.blendMode=this._blendMode,this._particleSystem.updateInAnimate=this._updateInAnimate}};var Tf=class{get blurNumIterations(){return this._blurNumIterations}set blurNumIterations(e){if(this._blurNumIterations!==e&&(this._blurNumIterations=e,this._blurPostProcesses!==null)){let t=this._blurPostProcesses[0],i=this._blurPostProcesses[1];this._blurPostProcesses=[];for(let r=0;r<this._blurNumIterations*2;++r)this._blurPostProcesses[r]=r&1?i:t}}get renderTarget(){return this._rt}get renderTargetBlur(){return this._rtBlur}get texture(){return this._texture}get textureBlur(){return this._textureBlurred}constructor(e,t,i,r,n,o,a=1,l=6,c=1,h=6,u=!1,d=null,f=!0,m=1){this.enableBlur=!0,this.blurSizeDivisor=1,this.blurFilterSize=7,this._blurNumIterations=3,this.blurMaxFilterSize=100,this.blurDepthScale=10,this.particleSize=.02,this.onDisposeObservable=new U,this._name=e,this._scene=t,this._camera=d,this._engine=t.getEngine(),this._width=i,this._height=r,this._blurTextureSizeX=n,this._blurTextureSizeY=o,this._textureType=a,this._textureFormat=l,this._blurTextureType=c,this._blurTextureFormat=h,this._useStandardBlur=u,this._generateDepthBuffer=f,this._samples=m,this._postProcessRunningIndex=0,this.enableBlur=n!==0&&o!==0,this._rt=null,this._texture=null,this._rtBlur=null,this._textureBlurred=null,this._blurPostProcesses=null}initialize(){if(this.dispose(),this._createRenderTarget(),this.enableBlur&&this._texture){let[e,t,i]=this._createBlurPostProcesses(this._texture,this._blurTextureType,this._blurTextureFormat,this.blurSizeDivisor,this._name,this._useStandardBlur);this._rtBlur=e,this._textureBlurred=t,this._blurPostProcesses=i}}applyBlurPostProcesses(){this.enableBlur&&this._blurPostProcesses&&(this._postProcessRunningIndex=0,this._scene.postProcessManager.directRender(this._blurPostProcesses,this._rtBlur,!0),this._engine.unBindFramebuffer(this._rtBlur))}_createRenderTarget(){this._rt=this._engine.createRenderTargetTexture({width:this._width,height:this._height},{generateMipMaps:!1,type:this._textureType,format:this._textureFormat,samplingMode:1,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTT-${this._name}`});let e=this._rt.texture;e.incrementReferences(),this._texture=new z(null,this._scene),this._texture.name="rtt"+this._name,this._texture._texture=e,this._texture.wrapU=z.CLAMP_ADDRESSMODE,this._texture.wrapV=z.CLAMP_ADDRESSMODE,this._texture.anisotropicFilteringLevel=1}_createBlurPostProcesses(e,t,i,r,n,o=!1){let a=this._scene.getEngine(),l=new j(Math.floor(this._blurTextureSizeX/r),Math.floor(this._blurTextureSizeY/r)),c=t===1&&a.getCaps().textureFloatLinearFiltering||t===2&&a.getCaps().textureHalfFloatLinearFiltering,h=this._engine.createRenderTargetTexture({width:l.x,height:l.y},{generateMipMaps:!1,type:t,format:i,samplingMode:c?2:1,generateDepthBuffer:!1,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTTBlur-${n}`}),u=h.texture;u.incrementReferences();let d=new z(null,this._scene);if(d.name="rttBlurred"+n,d._texture=u,d.wrapU=z.CLAMP_ADDRESSMODE,d.wrapV=z.CLAMP_ADDRESSMODE,d.anisotropicFilteringLevel=1,o){let f=new ve("BilateralBlurX","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);f.samples=this._samples,f.externalTextureSamplerBinding=!0,f.onApplyObservable.add(_=>{this._postProcessRunningIndex===0?_.setTexture("textureSampler",e):_._bindTexture("textureSampler",f.inputTexture.texture),_.setInt("filterSize",this.blurFilterSize),_.setFloat2("blurDir",1/this._blurTextureSizeX,0),this._postProcessRunningIndex++}),f.onSizeChangedObservable.add(()=>{f._textures.forEach(_=>{_.texture.wrapU=z.CLAMP_ADDRESSMODE,_.texture.wrapV=z.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(f);let m=new ve("BilateralBlurY","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);m.samples=this._samples,m.onApplyObservable.add(_=>{_.setInt("filterSize",this.blurFilterSize),_.setFloat2("blurDir",0,1/this._blurTextureSizeY),this._postProcessRunningIndex++}),m.onSizeChangedObservable.add(()=>{m._textures.forEach(_=>{_.texture.wrapU=z.CLAMP_ADDRESSMODE,_.texture.wrapV=z.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(m),f.autoClear=!1,m.autoClear=!1;let g=[];for(let _=0;_<this._blurNumIterations*2;++_)g[_]=_&1?m:f;return[h,d,g]}else{let f=["maxFilterSize","blurDir","projectedParticleConstant","depthThreshold"],m=new ve("BilateralBlurX","fluidRenderingBilateralBlur",f,null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);m.samples=this._samples,m.externalTextureSamplerBinding=!0,m.onApplyObservable.add(x=>{this._postProcessRunningIndex===0?x.setTexture("textureSampler",e):x._bindTexture("textureSampler",m.inputTexture.texture),x.setInt("maxFilterSize",this.blurMaxFilterSize),x.setFloat2("blurDir",1/this._blurTextureSizeX,0),x.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),x.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),m.onSizeChangedObservable.add(()=>{m._textures.forEach(x=>{x.texture.wrapU=z.CLAMP_ADDRESSMODE,x.texture.wrapV=z.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(m);let g=new ve("BilateralBlurY","fluidRenderingBilateralBlur",f,null,1,null,1,a,!0,null,t,void 0,void 0,void 0,i);g.samples=this._samples,g.onApplyObservable.add(x=>{x.setInt("maxFilterSize",this.blurMaxFilterSize),x.setFloat2("blurDir",0,1/this._blurTextureSizeY),x.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),x.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),g.onSizeChangedObservable.add(()=>{g._textures.forEach(x=>{x.texture.wrapU=z.CLAMP_ADDRESSMODE,x.texture.wrapV=z.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(g),m.autoClear=!1,g.autoClear=!1;let _=[];for(let x=0;x<this._blurNumIterations*2;++x)_[x]=x&1?g:m;return[h,d,_]}}_fixReusablePostProcess(e){e.isReusable()&&(e.onActivateObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}),e.onApplyObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}))}_getProjectedParticleConstant(){return this.blurFilterSize*this.particleSize*.05*(this._height/2)/Math.tan((this._camera?.fov??45*Math.PI/180)/2)}_getDepthThreshold(){return this.particleSize/2*this.blurDepthScale}dispose(){this.onDisposeObservable.hasObservers()&&this.onDisposeObservable.notifyObservers(this),this._rt?.dispose(),this._rt=null,this._texture?.dispose(),this._texture=null,this._rtBlur?.dispose(),this._rtBlur=null,this._textureBlurred?.dispose(),this._textureBlurred=null,this._blurPostProcesses&&(this._blurPostProcesses[0].dispose(),this._blurPostProcesses[1].dispose()),this._blurPostProcesses=null}};var eo=function(s){return s[s.DepthTexture=0]="DepthTexture",s[s.DepthBlurredTexture=1]="DepthBlurredTexture",s[s.ThicknessTexture=2]="ThicknessTexture",s[s.ThicknessBlurredTexture=3]="ThicknessBlurredTexture",s[s.DiffuseTexture=4]="DiffuseTexture",s[s.Normals=5]="Normals",s[s.DiffuseRendering=6]="DiffuseRendering",s}(eo||{}),ag=class{get needInitialization(){return this._needInitialization}get generateDiffuseTexture(){return this._generateDiffuseTexture}set generateDiffuseTexture(e){this._generateDiffuseTexture!==e&&(this._generateDiffuseTexture=e,this._needInitialization=!0)}get debugFeature(){return this._debugFeature}set debugFeature(e){this._debugFeature!==e&&(this._needInitialization=!0,this._debugFeature=e)}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._needInitialization=!0)}get environmentMap(){return this._environmentMap}set environmentMap(e){this._environmentMap!==e&&(this._needInitialization=!0,this._environmentMap=e)}get enableBlurDepth(){return this._enableBlurDepth}set enableBlurDepth(e){this._enableBlurDepth!==e&&(this._enableBlurDepth=e,this._needInitialization=!0)}get blurDepthSizeDivisor(){return this._blurDepthSizeDivisor}set blurDepthSizeDivisor(e){this._blurDepthSizeDivisor!==e&&(this._blurDepthSizeDivisor=e,this._needInitialization=!0)}get blurDepthFilterSize(){return this._blurDepthFilterSize}set blurDepthFilterSize(e){this._blurDepthFilterSize!==e&&(this._blurDepthFilterSize=e,this._setBlurParameters())}get blurDepthNumIterations(){return this._blurDepthNumIterations}set blurDepthNumIterations(e){this._blurDepthNumIterations!==e&&(this._blurDepthNumIterations=e,this._setBlurParameters())}get blurDepthMaxFilterSize(){return this._blurDepthMaxFilterSize}set blurDepthMaxFilterSize(e){this._blurDepthMaxFilterSize!==e&&(this._blurDepthMaxFilterSize=e,this._setBlurParameters())}get blurDepthDepthScale(){return this._blurDepthDepthScale}set blurDepthDepthScale(e){this._blurDepthDepthScale!==e&&(this._blurDepthDepthScale=e,this._setBlurParameters())}get enableBlurThickness(){return this._enableBlurThickness}set enableBlurThickness(e){this._enableBlurThickness!==e&&(this._enableBlurThickness=e,this._needInitialization=!0)}get blurThicknessSizeDivisor(){return this._blurThicknessSizeDivisor}set blurThicknessSizeDivisor(e){this._blurThicknessSizeDivisor!==e&&(this._blurThicknessSizeDivisor=e,this._needInitialization=!0)}get blurThicknessFilterSize(){return this._blurThicknessFilterSize}set blurThicknessFilterSize(e){this._blurThicknessFilterSize!==e&&(this._blurThicknessFilterSize=e,this._setBlurParameters())}get blurThicknessNumIterations(){return this._blurThicknessNumIterations}set blurThicknessNumIterations(e){this._blurThicknessNumIterations!==e&&(this._blurThicknessNumIterations=e,this._setBlurParameters())}get useFixedThickness(){return this._useFixedThickness}set useFixedThickness(e){this._useFixedThickness!==e&&(this._useFixedThickness=e,this._needInitialization=!0)}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&(this._useVelocity=e,this._needInitialization=!0,this._onUseVelocityChanged.notifyObservers(this))}get depthMapSize(){return this._depthMapSize}set depthMapSize(e){this._depthMapSize!==e&&(this._depthMapSize=e,this._needInitialization=!0)}get thicknessMapSize(){return this._thicknessMapSize}set thicknessMapSize(e){this._thicknessMapSize!==e&&(this._thicknessMapSize=e,this._needInitialization=!0)}get diffuseMapSize(){return this._diffuseMapSize}set diffuseMapSize(e){this._diffuseMapSize!==e&&(this._diffuseMapSize=e,this._needInitialization=!0)}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._needInitialization=!0)}get compositeMode(){return this._compositeMode}set compositeMode(e){this._compositeMode!==e&&(this._compositeMode=e,this._needInitialization=!0)}get camera(){return this._camera}constructor(e,t){this._generateDiffuseTexture=!1,this.fluidColor=new X(.085,.6375,.765),this.density=2,this.refractionStrength=.1,this.fresnelClamp=1,this.specularPower=250,this.minimumThickness=0,this.dirLight=new p(-2,-1,1).normalize(),this._debugFeature=eo.DepthBlurredTexture,this._debug=!1,this._enableBlurDepth=!0,this._blurDepthSizeDivisor=1,this._blurDepthFilterSize=7,this._blurDepthNumIterations=3,this._blurDepthMaxFilterSize=100,this._blurDepthDepthScale=10,this._enableBlurThickness=!0,this._blurThicknessSizeDivisor=1,this._blurThicknessFilterSize=5,this._blurThicknessNumIterations=1,this._useFixedThickness=!1,this._onUseVelocityChanged=new U,this._useVelocity=!1,this._depthMapSize=null,this._thicknessMapSize=null,this._diffuseMapSize=null,this._samples=1,this._compositeMode=!1,this._scene=e,this._engine=e.getEngine(),this._camera=t??e.activeCamera,this._needInitialization=!0,this._bgDepthTexture=null,this._invProjectionMatrix=new N,this._depthClearColor=new oe(1e6,1e6,1e6,1),this._thicknessClearColor=new oe(0,0,0,1),this._depthRenderTarget=null,this._diffuseRenderTarget=null,this._thicknessRenderTarget=null,this._renderPostProcess=null}_initialize(){this.dispose(),this._needInitialization=!1;let e=this._depthMapSize??this._engine.getRenderWidth(),t=this._depthMapSize!==null?Math.round(this._depthMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();if(this._depthRenderTarget=new Tf("Depth",this._scene,e,t,e,t,1,7,1,7,!1,this._camera,!0,this._samples),this._initializeRenderTarget(this._depthRenderTarget),this.generateDiffuseTexture){let n=this._diffuseMapSize??this._engine.getRenderWidth(),o=this._diffuseMapSize!==null?Math.round(this._diffuseMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._diffuseRenderTarget=new Tf("Diffuse",this._scene,n,o,0,0,0,5,0,5,!0,this._camera,!0,this._samples),this._initializeRenderTarget(this._diffuseRenderTarget)}let i=this._thicknessMapSize??this._engine.getRenderWidth(),r=this._thicknessMapSize!==null?Math.round(this._thicknessMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._useFixedThickness||(this._thicknessRenderTarget=new Tf("Thickness",this._scene,i,r,i,r,2,6,2,6,!0,this._camera,!1,this._samples),this._initializeRenderTarget(this._thicknessRenderTarget)),this._createLiquidRenderingPostProcess()}_setBlurParameters(e=null){(e===null||e===this._depthRenderTarget)&&this._setBlurDepthParameters(),(e===null||e===this._thicknessRenderTarget)&&this._setBlurThicknessParameters()}_setBlurDepthParameters(){this._depthRenderTarget&&(this._depthRenderTarget.blurFilterSize=this.blurDepthFilterSize,this._depthRenderTarget.blurMaxFilterSize=this.blurDepthMaxFilterSize,this._depthRenderTarget.blurNumIterations=this.blurDepthNumIterations,this._depthRenderTarget.blurDepthScale=this.blurDepthDepthScale)}_setBlurThicknessParameters(){this._thicknessRenderTarget&&(this._thicknessRenderTarget.blurFilterSize=this.blurThicknessFilterSize,this._thicknessRenderTarget.blurNumIterations=this.blurThicknessNumIterations)}_initializeRenderTarget(e){e!==this._diffuseRenderTarget&&(e.enableBlur=e===this._depthRenderTarget?this.enableBlurDepth:this.enableBlurThickness,e.blurSizeDivisor=e===this._depthRenderTarget?this.blurDepthSizeDivisor:this.blurThicknessSizeDivisor),this._setBlurParameters(e),e.initialize()}_createLiquidRenderingPostProcess(){let e=this._scene.getEngine(),t=["viewMatrix","projectionMatrix","invProjectionMatrix","texelSize","dirLight","cameraFar","density","refractionStrength","fresnelClamp","specularPower"],i=["depthSampler"],r=[];if(this.dispose(!0),!this._camera)return;let n=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture,o=new j(1/n.getSize().width,1/n.getSize().height);this._scene.useRightHandedSystem&&r.push("#define FLUIDRENDERING_RHS"),this._environmentMap!==null&&(this._environmentMap??this._scene.environmentTexture)&&(i.push("reflectionSampler"),r.push("#define FLUIDRENDERING_ENVIRONMENT")),this._diffuseRenderTarget?(i.push("diffuseSampler"),r.push("#define FLUIDRENDERING_DIFFUSETEXTURE")):t.push("diffuseColor"),this._useVelocity&&(i.push("velocitySampler"),r.push("#define FLUIDRENDERING_VELOCITY")),this._useFixedThickness?(t.push("thickness"),i.push("bgDepthSampler"),r.push("#define FLUIDRENDERING_FIXED_THICKNESS")):(t.push("minimumThickness"),i.push("thicknessSampler")),this._compositeMode&&r.push("#define FLUIDRENDERING_COMPOSITE_MODE"),this._debug&&(r.push("#define FLUIDRENDERING_DEBUG"),this._debugFeature===eo.Normals?r.push("#define FLUIDRENDERING_DEBUG_SHOWNORMAL"):this._debugFeature===eo.DiffuseRendering?r.push("#define FLUIDRENDERING_DEBUG_DIFFUSERENDERING"):(r.push("#define FLUIDRENDERING_DEBUG_TEXTURE"),i.push("debugSampler"),(this._debugFeature===eo.DepthTexture||this._debugFeature===eo.DepthBlurredTexture)&&r.push("#define FLUIDRENDERING_DEBUG_DEPTH"))),this._renderPostProcess=new ve("FluidRendering","fluidRenderingRender",t,i,1,null,2,e,!1,null,0,void 0,void 0,!0,void 0),this._renderPostProcess.updateEffect(r.join(`
`)),this._renderPostProcess.samples=this._samples;let a=e,l=a.setTextureSampler;this._renderPostProcess.onApplyObservable.add(c=>{if(this._invProjectionMatrix.copyFrom(this._scene.getProjectionMatrix()),this._invProjectionMatrix.invert(),l&&l.call(a,"textureSamplerSampler",this._renderPostProcess.inputTexture.texture),this._depthRenderTarget.enableBlur?(c.setTexture("depthSampler",this._depthRenderTarget.textureBlur),l&&l.call(a,"depthSamplerSampler",this._depthRenderTarget.textureBlur?.getInternalTexture()??null)):(c.setTexture("depthSampler",this._depthRenderTarget.texture),l&&l.call(a,"depthSamplerSampler",this._depthRenderTarget.texture?.getInternalTexture()??null)),this._diffuseRenderTarget?this._diffuseRenderTarget.enableBlur?(c.setTexture("diffuseSampler",this._diffuseRenderTarget.textureBlur),l&&l.call(a,"diffuseSamplerSampler",this._diffuseRenderTarget.textureBlur?.getInternalTexture()??null)):(c.setTexture("diffuseSampler",this._diffuseRenderTarget.texture),l&&l.call(a,"diffuseSamplerSampler",this._diffuseRenderTarget.texture?.getInternalTexture()??null)):c.setColor3("diffuseColor",this.fluidColor),this._useFixedThickness?(c.setFloat("thickness",this.minimumThickness),c._bindTexture("bgDepthSampler",this._bgDepthTexture),l&&l.call(a,"bgDepthSamplerSampler",this._bgDepthTexture??null)):(this._thicknessRenderTarget.enableBlur?(c.setTexture("thicknessSampler",this._thicknessRenderTarget.textureBlur),l&&l.call(a,"thicknessSamplerSampler",this._thicknessRenderTarget.textureBlur?.getInternalTexture()??null)):(c.setTexture("thicknessSampler",this._thicknessRenderTarget.texture),l&&l.call(a,"thicknessSamplerSampler",this._thicknessRenderTarget.texture?.getInternalTexture()??null)),c.setFloat("minimumThickness",this.minimumThickness)),this._environmentMap!==null){let h=this._environmentMap??this._scene.environmentTexture;h&&(c.setTexture("reflectionSampler",h),l&&l.call(a,"reflectionSamplerSampler",h?.getInternalTexture()??null))}if(c.setMatrix("viewMatrix",this._scene.getViewMatrix()),c.setMatrix("invProjectionMatrix",this._invProjectionMatrix),c.setMatrix("projectionMatrix",this._scene.getProjectionMatrix()),c.setVector2("texelSize",o),c.setFloat("density",this.density),c.setFloat("refractionStrength",this.refractionStrength),c.setFloat("fresnelClamp",this.fresnelClamp),c.setFloat("specularPower",this.specularPower),c.setVector3("dirLight",this.dirLight),c.setFloat("cameraFar",this._camera.maxZ),this._debug){let h=null;switch(this._debugFeature){case eo.DepthTexture:h=this._depthRenderTarget.texture;break;case eo.DepthBlurredTexture:h=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture;break;case eo.ThicknessTexture:h=this._thicknessRenderTarget?.texture??null;break;case eo.ThicknessBlurredTexture:h=this._thicknessRenderTarget?.enableBlur?this._thicknessRenderTarget?.textureBlur??null:this._thicknessRenderTarget?.texture??null;break;case eo.DiffuseTexture:this._diffuseRenderTarget&&(h=this._diffuseRenderTarget.texture);break}this._debugFeature!==eo.Normals&&(c.setTexture("debugSampler",h),l&&l.call(a,"debugSamplerSampler",h?.getInternalTexture()??null))}})}_clearTargets(){this._depthRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),this._engine.clear(this._depthClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),this._diffuseRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),this._thicknessRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget))}_render(e){if(this._needInitialization||!e.isReady())return;let t=this._engine._currentRenderTarget;this._engine.setState(!1,void 0,void 0,void 0,!0),this._engine.setDepthBuffer(!0),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0),this._depthRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),e.renderDepthTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),this._diffuseRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),e.renderDiffuseTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),this._thicknessRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),e.renderThicknessTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget)),this._depthRenderTarget?.applyBlurPostProcesses(),this._diffuseRenderTarget?.applyBlurPostProcesses(),this._thicknessRenderTarget?.applyBlurPostProcesses(),t&&this._engine.bindFramebuffer(t)}dispose(e=!1){e||(this._depthRenderTarget?.dispose(),this._depthRenderTarget=null,this._diffuseRenderTarget?.dispose(),this._diffuseRenderTarget=null,this._thicknessRenderTarget?.dispose(),this._thicknessRenderTarget=null),this._renderPostProcess&&this._camera&&this._camera.detachPostProcess(this._renderPostProcess),this._renderPostProcess?.dispose(),this._renderPostProcess=null,this._needInitialization=!1}};var rb=class extends vf{getClassName(){return"FluidRenderingObjectCustomParticles"}get vertexBuffers(){return this._vertexBuffers}constructor(e,t,i){super(e),this._numParticles=i,this._diffuseEffectWrapper=null,this._vertexBuffers={},this.addBuffers(t)}addBuffers(e){for(let t in e){let i,r=!0;switch(t){case"velocity":i=3;break;case"offset":r=!1;break}this._vertexBuffers[t]=new y(this._engine,e[t],t,!0,!1,i,r)}}_createEffects(){super._createEffects();let e=["view","projection","size"],t=["position","offset","color"];this._diffuseEffectWrapper=new os({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDiffuse",fragmentShader:"fluidRenderingParticleDiffuse",attributeNames:t,uniformNames:e,samplerNames:[]})}isReady(){return this._vertexBuffers.offset||(this._vertexBuffers.offset=new y(this._engine,[0,0,1,0,0,1,1,1],"offset",!1,!1,2)),super.isReady()&&(this._diffuseEffectWrapper?.effect.isReady()??!1)}get numParticles(){return this._numParticles}setNumParticles(e){this._numParticles=e}renderDiffuseTexture(){let e=this.numParticles;if(!this._diffuseEffectWrapper||e===0)return;let t=this._diffuseEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),this._particleSize!==null&&i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}dispose(){super.dispose(),this._diffuseEffectWrapper?.dispose();for(let e in this._vertexBuffers)this._vertexBuffers[e].dispose();this._vertexBuffers={}}};var TK="copyTextureToTexturePixelShader",CK=`uniform float conversion;uniform sampler2D textureSampler;varying vec2 vUV;
#include<helperFunctions>
void main(void) 
{vec4 color=texture2D(textureSampler,vUV);
#ifdef DEPTH_TEXTURE
gl_FragDepth=color.r;
#else
if (conversion==1.) {color=toLinearSpace(color);} else if (conversion==2.) {color=toGammaSpace(color);}
gl_FragColor=color;
#endif
}
`;D.ShadersStore[TK]=CK;var GV=function(s){return s[s.None=0]="None",s[s.ToLinearSpace=1]="ToLinearSpace",s[s.ToGammaSpace=2]="ToGammaSpace",s}(GV||{}),sb=class{_textureIsInternal(e){return e.getInternalTexture===void 0}constructor(e,t=!1){this._engine=e,this._isDepthTexture=t,this._renderer=new sa(e),this._effectWrapper=new os({engine:e,name:"CopyTextureToTexture",fragmentShader:"copyTextureToTexture",useShaderStore:!0,uniformNames:["conversion"],samplerNames:["textureSampler"],defines:t?["#define DEPTH_TEXTURE"]:[]}),this._effectWrapper.onApplyObservable.add(()=>{t&&(e.setState(!1),e.setDepthBuffer(!0),e.depthCullingState.depthMask=!0,e.depthCullingState.depthFunc=519),this._textureIsInternal(this._source)?this._effectWrapper.effect._bindTexture("textureSampler",this._source):this._effectWrapper.effect.setTexture("textureSampler",this._source),this._effectWrapper.effect.setFloat("conversion",this._conversion)})}isReady(){return this._effectWrapper.effect.isReady()}copy(e,t,i=GV.None){if(!this.isReady())return!1;this._source=e,this._conversion=i;let r=this._engine.depthCullingState.depthFunc;return this._renderer.render(this._effectWrapper,t),this._isDepthTexture&&r&&(this._engine.depthCullingState.depthFunc=r),!0}dispose(){this._effectWrapper.dispose(),this._renderer.dispose()}};var nb=class{get depthRTWrapper(){return this._depthRTWrapper}constructor(e,t,i,r=1){this._engine=e,this._copyTextureToTexture=new sb(e,!0),this._depthRTWrapper=this._engine.createRenderTargetTexture({width:t,height:i},{generateMipMaps:!1,type:0,format:6,samplingMode:1,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:r,noColorAttachment:!0,label:"FluidRenderingDepthTextureCopyRTT"});let n=this._depthRTWrapper.createDepthStencilTexture(0,!1,!1,1,void 0,"FluidRenderingDepthTextureCopyRTTDepthStencil");n.label=`FluidDepthTextureCopy${t}x${i}x${r}`}copy(e){return this._copyTextureToTexture.copy(e,this._depthRTWrapper)}dispose(){this._depthRTWrapper.dispose(),this._copyTextureToTexture.dispose()}};var bK="fluidRenderingParticleDepthVertexShader",SK=`attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;
#ifdef FLUIDRENDERING_VELOCITY
attribute vec3 velocity;varying float velocityNorm;
#endif
void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;viewPos=(view*vec4(position,1.0)).xyz;gl_Position=projection*vec4(viewPos+cornerPos,1.0);uv=offset;sphereRadius=size.x/2.0;
#ifdef FLUIDRENDERING_VELOCITY
velocityNorm=length(velocity);
#endif
}
`;D.ShadersStore[bK]=SK;var yK="fluidRenderingParticleDepthPixelShader",EK=`uniform mat4 projection;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;
#ifdef FLUIDRENDERING_VELOCITY
varying float velocityNorm;
#endif
void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;normal.z=sqrt(1.0-r2);
#ifndef FLUIDRENDERING_RHS
normal.z=-normal.z;
#endif
vec4 realViewPos=vec4(viewPos+normal*sphereRadius,1.0);vec4 clipSpacePos=projection*realViewPos;
#ifdef WEBGPU
gl_FragDepth=clipSpacePos.z/clipSpacePos.w;
#else
gl_FragDepth=(clipSpacePos.z/clipSpacePos.w)*0.5+0.5;
#endif
#ifdef FLUIDRENDERING_RHS
realViewPos.z=-realViewPos.z;
#endif
#ifdef FLUIDRENDERING_VELOCITY
glFragColor=vec4(realViewPos.z,velocityNorm,0.,1.);
#else
glFragColor=vec4(realViewPos.z,0.,0.,1.);
#endif
}
`;D.ShadersStore[yK]=EK;var AK="fluidRenderingParticleThicknessVertexShader",IK=`attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;}
`;D.ShadersStore[AK]=IK;var RK="fluidRenderingParticleThicknessPixelShader",PK=`uniform float particleAlpha;varying vec2 uv;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;float thickness=sqrt(1.0-r2);glFragColor=vec4(vec3(particleAlpha*thickness),1.0);}
`;D.ShadersStore[RK]=PK;var MK="fluidRenderingParticleDiffuseVertexShader",DK=`attribute vec3 position;attribute vec2 offset;attribute vec4 color;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;diffuseColor=color.rgb;}
`;D.ShadersStore[MK]=DK;var OK="fluidRenderingParticleDiffusePixelShader",wK=`uniform float particleAlpha;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;glFragColor=vec4(diffuseColor,1.0);}
`;D.ShadersStore[OK]=wK;var NK="fluidRenderingBilateralBlurPixelShader",FK=`uniform sampler2D textureSampler;uniform int maxFilterSize;uniform vec2 blurDir;uniform float projectedParticleConstant;uniform float depthThreshold;varying vec2 vUV;void main(void) {float depth=textureLod(textureSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(vec3(depth),1.);return;}
int filterSize=min(maxFilterSize,int(ceil(projectedParticleConstant/depth)));float sigma=float(filterSize)/3.0;float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold/3.0;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sum=0.;float wsum=0.;float sumVel=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec2 sampleDepthVel=textureLod(textureSampler,vUV+coords*blurDir,0.).rg;float r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepthVel.r-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);sum+=sampleDepthVel.r*w*wd;sumVel+=sampleDepthVel.g*w*wd;wsum+=w*wd;}
glFragColor=vec4(sum/wsum,sumVel/wsum,0.,1.);}
`;D.ShadersStore[NK]=FK;var LK="fluidRenderingStandardBlurPixelShader",BK=`uniform sampler2D textureSampler;uniform int filterSize;uniform vec2 blurDir;varying vec2 vUV;void main(void) {vec4 s=textureLod(textureSampler,vUV,0.);if (s.r==0.) {glFragColor=vec4(0.,0.,0.,1.);return;}
float sigma=float(filterSize)/3.0;float twoSigma2=2.0*sigma*sigma;vec4 sum=vec4(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec4 sampl=textureLod(textureSampler,vUV+coords*blurDir,0.);float w=exp(-coords.x*coords.x/twoSigma2);sum+=sampl*w;wsum+=w;}
sum/=wsum;glFragColor=vec4(sum.rgb,1.);}
`;D.ShadersStore[LK]=BK;var VK="fluidRenderingRenderPixelShader",UK=`#define DISABLE_UNIFORMITY_ANALYSIS
#define IOR 1.333
#define ETA 1.0/IOR
#define F0 0.02
uniform sampler2D textureSampler;uniform sampler2D depthSampler;
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
uniform sampler2D diffuseSampler;
#else
uniform vec3 diffuseColor;
#endif
#ifdef FLUIDRENDERING_FIXED_THICKNESS
uniform float thickness;uniform sampler2D bgDepthSampler;
#else
uniform float minimumThickness;uniform sampler2D thicknessSampler;
#endif
#ifdef FLUIDRENDERING_ENVIRONMENT
uniform samplerCube reflectionSampler;
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
uniform sampler2D debugSampler;
#endif
uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform mat4 invProjectionMatrix;uniform vec2 texelSize;uniform vec3 dirLight;uniform float cameraFar;uniform float density;uniform float refractionStrength;uniform float fresnelClamp;uniform float specularPower;varying vec2 vUV;vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;
#ifdef FLUIDRENDERING_RHS
ndc.z=-projectionMatrix[2].z+projectionMatrix[3].z/depth;
#else
ndc.z=projectionMatrix[2].z+projectionMatrix[3].z/depth;
#endif
ndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}
vec3 getViewPosFromTexCoord(vec2 texCoord) {float depth=textureLod(depthSampler,texCoord,0.).x;return computeViewPosFromUVDepth(texCoord,depth);}
void main(void) {vec2 texCoord=vUV;
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
vec4 color=texture2D(debugSampler,texCoord);
#ifdef FLUIDRENDERING_DEBUG_DEPTH
glFragColor=vec4(color.rgb/vec3(2.0),1.);if (color.r>0.999 && color.g>0.999) {glFragColor=texture2D(textureSampler,texCoord);}
#else
glFragColor=vec4(color.rgb,1.);if (color.r<0.001 && color.g<0.001 && color.b<0.001) {glFragColor=texture2D(textureSampler,texCoord);}
#endif
return;
#endif
vec2 depthVel=textureLod(depthSampler,texCoord,0.).rg;float depth=depthVel.r;
#ifndef FLUIDRENDERING_FIXED_THICKNESS
float thickness=texture2D(thicknessSampler,texCoord).x;
#else
float bgDepth=texture2D(bgDepthSampler,texCoord).x;float depthNonLinear=projectionMatrix[2].z+projectionMatrix[3].z/depth;depthNonLinear=depthNonLinear*0.5+0.5;
#endif
vec4 backColor=texture2D(textureSampler,texCoord);
#ifndef FLUIDRENDERING_FIXED_THICKNESS
if (depth>=cameraFar || depth<=0. || thickness<=minimumThickness) {
#else
if (depth>=cameraFar || depth<=0. || bgDepth<=depthNonLinear) {
#endif
#ifdef FLUIDRENDERING_COMPOSITE_MODE
glFragColor.rgb=backColor.rgb*backColor.a;glFragColor.a=backColor.a;
#else
glFragColor=backColor;
#endif
return;}
vec3 viewPos=computeViewPosFromUVDepth(texCoord,depth);vec3 ddx=getViewPosFromTexCoord(texCoord+vec2(texelSize.x,0.))-viewPos;vec3 ddy=getViewPosFromTexCoord(texCoord+vec2(0.,texelSize.y))-viewPos;vec3 ddx2=viewPos-getViewPosFromTexCoord(texCoord+vec2(-texelSize.x,0.));if (abs(ddx.z)>abs(ddx2.z)) {ddx=ddx2;}
vec3 ddy2=viewPos-getViewPosFromTexCoord(texCoord+vec2(0.,-texelSize.y));if (abs(ddy.z)>abs(ddy2.z)) {ddy=ddy2;}
vec3 normal=normalize(cross(ddy,ddx));
#ifdef FLUIDRENDERING_RHS
normal=-normal;
#endif
#ifndef WEBGPU
if(isnan(normal.x) || isnan(normal.y) || isnan(normal.z) || isinf(normal.x) || isinf(normal.y) || isinf(normal.z)) {normal=vec3(0.,0.,-1.);}
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)
glFragColor=vec4(normal*0.5+0.5,1.0);return;
#endif
vec3 rayDir=normalize(viewPos); 
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
vec3 diffuseColor=textureLod(diffuseSampler,texCoord,0.0).rgb;
#endif
vec3 lightDir=normalize(vec3(viewMatrix*vec4(-dirLight,0.)));vec3 H =normalize(lightDir-rayDir);float specular=pow(max(0.0,dot(H,normal)),specularPower);
#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING
float diffuse =max(0.0,dot(lightDir,normal))*1.0;glFragColor=vec4(vec3(0.1) /*ambient*/+vec3(0.42,0.50,1.00)*diffuse+vec3(0,0,0.2)+specular,1.);return;
#endif
vec3 refractionDir=refract(rayDir,normal,ETA);vec4 transmitted=textureLod(textureSampler,vec2(texCoord+refractionDir.xy*thickness*refractionStrength),0.0);
#ifdef FLUIDRENDERING_COMPOSITE_MODE
if (transmitted.a==0.) transmitted.a=thickness;
#endif
vec3 transmittance=exp(-density*thickness*(1.0-diffuseColor)); 
vec3 refractionColor=transmitted.rgb*transmittance;
#ifdef FLUIDRENDERING_ENVIRONMENT
vec3 reflectionDir=reflect(rayDir,normal);vec3 reflectionColor=(textureCube(reflectionSampler,reflectionDir).rgb);float fresnel=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,fresnelClamp);vec3 finalColor=mix(refractionColor,reflectionColor,fresnel)+specular;
#else
vec3 finalColor=refractionColor+specular;
#endif
#ifdef FLUIDRENDERING_VELOCITY
float velocity=depthVel.g;finalColor=mix(finalColor,vec3(1.0),smoothstep(0.3,1.0,velocity/6.0));
#endif
glFragColor=vec4(finalColor,transmitted.a);}
`;D.ShadersStore[VK]=UK;Object.defineProperty(Te.prototype,"fluidRenderer",{get:function(){return this._fluidRenderer},set:function(s){this._fluidRenderer=s},enumerable:!0,configurable:!0});Te.prototype.enableFluidRenderer=function(){return this._fluidRenderer?this._fluidRenderer:(this._fluidRenderer=new xM(this),this._fluidRenderer)};Te.prototype.disableFluidRenderer=function(){this._fluidRenderer?.dispose(),this._fluidRenderer=null};function kK(s){return!!s.particleSystem}function GK(s){return!!s.addBuffers}var _M=class{constructor(e){this.name=ye.NAME_FLUIDRENDERER,this.scene=e}register(){this.scene._gatherActiveCameraRenderTargetsStage.registerStep(ye.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER,this,this._gatherActiveCameraRenderTargets),this.scene._afterCameraDrawStage.registerStep(ye.STEP_AFTERCAMERADRAW_FLUIDRENDERER,this,this._afterCameraDraw)}_gatherActiveCameraRenderTargets(e){this.scene.fluidRenderer?._prepareRendering()}_afterCameraDraw(e){this.scene.fluidRenderer?._render(e)}rebuild(){let e=this.scene.fluidRenderer;if(!e)return;let t=new Set;for(let i=0;i<e.renderObjects.length;++i){let r=e.renderObjects[i].object;if(GK(r)){let n=r.vertexBuffers;for(let o in n)t.add(n[o].getWrapperBuffer())}}t.forEach(i=>{i._rebuild()})}dispose(){this.scene.disableFluidRenderer()}},xM=class s{static _SceneComponentInitialization(e){let t=e._getComponent(ye.NAME_FLUIDRENDERER);t||(t=new _M(e),e._addComponent(t))}constructor(e){this._scene=e,this._engine=e.getEngine(),this._onEngineResizeObserver=null,this.renderObjects=[],this.targetRenderers=[],this._cameras=new Map,s._SceneComponentInitialization(this._scene),this._onEngineResizeObserver=this._engine.onResizeObservable.add(()=>{this._initialize()})}recreate(){this._sortRenderingObjects(),this._initialize()}getRenderObjectFromParticleSystem(e){let t=this._getParticleSystemIndex(e);return t!==-1?this.renderObjects[t]:null}addParticleSystem(e,t,i,r){let n=new ib(this._scene,e);n.onParticleSizeChanged.add(()=>this._setParticleSizeForRenderTargets()),i||(i=new ag(this._scene,r),this.targetRenderers.push(i)),i._onUseVelocityChanged.hasObservers()||i._onUseVelocityChanged.add(()=>this._setUseVelocityForRenderObject()),t!==void 0&&(i.generateDiffuseTexture=t);let o={object:n,targetRenderer:i};return this.renderObjects.push(o),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),o}addCustomParticles(e,t,i,r,n){let o=new rb(this._scene,e,t);o.onParticleSizeChanged.add(()=>this._setParticleSizeForRenderTargets()),r||(r=new ag(this._scene,n),this.targetRenderers.push(r)),r._onUseVelocityChanged.hasObservers()||r._onUseVelocityChanged.add(()=>this._setUseVelocityForRenderObject()),i!==void 0&&(r.generateDiffuseTexture=i);let a={object:o,targetRenderer:r};return this.renderObjects.push(a),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),a}removeRenderObject(e,t=!0){let i=this.renderObjects.indexOf(e);return i===-1?!1:(e.object.dispose(),this.renderObjects.splice(i,1),t&&this._removeUnusedTargetRenderers()?this._initialize():this._setParticleSizeForRenderTargets(),!0)}_sortRenderingObjects(){this.renderObjects.sort((e,t)=>e.object.priority<t.object.priority?-1:e.object.priority>t.object.priority?1:0)}_removeUnusedTargetRenderers(){let e={};for(let r=0;r<this.renderObjects.length;++r){let n=this.renderObjects[r].targetRenderer;e[this.targetRenderers.indexOf(n)]=!0}let t=!1,i=[];for(let r=0;r<this.targetRenderers.length;++r)e[r]?i.push(this.targetRenderers[r]):(this.targetRenderers[r].dispose(),t=!0);return t&&(this.targetRenderers.length=0,this.targetRenderers.push(...i)),t}_getParticleSystemIndex(e){for(let t=0;t<this.renderObjects.length;++t){let i=this.renderObjects[t].object;if(kK(i)&&i.particleSystem===e)return t}return-1}_initialize(){for(let i=0;i<this.targetRenderers.length;++i)this.targetRenderers[i].dispose();let e=new Map;for(let i=0;i<this.targetRenderers.length;++i){let r=this.targetRenderers[i];if(r._initialize(),r.camera&&r._renderPostProcess){let n=e.get(r.camera);n||(n=[[],{}],e.set(r.camera,n)),n[0].push(r),r.camera.attachPostProcess(r._renderPostProcess,i)}}let t=e.keys();for(let i=t.next();i.done!==!0;i=t.next()){let r=i.value,n=e.get(r),o=r._getFirstPostProcess();if(!o)continue;let[a,l]=n;o.onSizeChangedObservable.add(()=>{o.inputTexture.depthStencilTexture||o.inputTexture.createDepthStencilTexture(0,!0,this._engine.isStencilEnable,a[0].samples,this._engine.isStencilEnable?13:14,`PostProcessRTTDepthStencil-${o.name}`);for(let c of a){let h=c._thicknessRenderTarget?.renderTarget,u=h?.texture;if(h&&u){let d=u.width+"_"+u.height,f=l[d];f||(f=l[d]=new nb(this._engine,u.width,u.height)),f.depthRTWrapper.shareDepth(h)}}})}t=this._cameras.keys();for(let i=t.next();i.done!==!0;i=t.next()){let r=i.value,o=this._cameras.get(r)[1],a=e.get(r);if(a)for(let l in o)a[1][l]||o[l].dispose();else for(let l in o)o[l].dispose()}this._cameras.clear(),this._cameras=e,this._setParticleSizeForRenderTargets()}_setParticleSizeForRenderTargets(){let e=new Map;for(let t=0;t<this.renderObjects.length;++t){let i=this.renderObjects[t],r=e.get(i.targetRenderer);r===void 0&&(r=0),e.set(i.targetRenderer,Math.max(r,i.object.particleSize))}e.forEach((t,i)=>{i._depthRenderTarget&&(i._depthRenderTarget.particleSize=t)})}_setUseVelocityForRenderObject(){for(let e of this.renderObjects)e.object.useVelocity=e.targetRenderer.useVelocity}_prepareRendering(){for(let e of this.targetRenderers)if(e.needInitialization){this._initialize();return}}_render(e){for(let i=0;i<this.targetRenderers.length;++i)(!e||this.targetRenderers[i].camera===e)&&this.targetRenderers[i]._clearTargets();let t=this._cameras.keys();for(let i=t.next();i.done!==!0;i=t.next()){let r=i.value,n=this._cameras.get(r);if(e&&r!==e)continue;let o=r._getFirstPostProcess();if(!o)continue;let a=o.inputTexture?.depthStencilTexture;if(a){let[l,c]=n;for(let h of l)h._bgDepthTexture=a;for(let h in c)c[h].copy(a)}}for(let i=0;i<this.renderObjects.length;++i){let r=this.renderObjects[i];(!e||r.targetRenderer.camera===e)&&r.targetRenderer._render(r.object)}}dispose(){this._engine.onResizeObservable.remove(this._onEngineResizeObserver),this._onEngineResizeObserver=null;for(let e=0;e<this.renderObjects.length;++e)this.renderObjects[e].object.dispose();for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();this._cameras.forEach(e=>{let t=e[1];for(let i in t)t[i].dispose()}),this.renderObjects=[],this.targetRenderers=[],this._cameras.clear()}};var vM=class extends Qt{constructor(){super(...arguments),this.RSMCREATE=!1,this.RSMCREATE_PROJTEXTURE=!1,this.RSMCREATE_LIGHT_IS_SPOT=!1}},Cf=class s extends Ti{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e){super(e,s.Name,300,new vM),this._lightColor=new X,this._hasProjectionTexture=!1,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._varAlbedoName=e instanceof Gt?"surfaceAlbedo":"baseColor.rgb"}prepareDefines(e){e.RSMCREATE=this._isEnabled,this._hasProjectionTexture=!1;let t=this.light.getTypeID()===tt.LIGHTTYPEID_SPOTLIGHT;if(t){let i=this.light;this._hasProjectionTexture=i.projectionTexture?i.projectionTexture.isReady():!1}e.RSMCREATE_PROJTEXTURE=this._hasProjectionTexture,e.RSMCREATE_LIGHT_IS_SPOT=t}getClassName(){return"RSMCreatePluginMaterial"}getUniforms(){return{ubo:[{name:"rsmTextureProjectionMatrix",size:16,type:"mat4"},{name:"rsmSpotInfo",size:4,type:"vec4"},{name:"rsmLightColor",size:3,type:"vec3"},{name:"rsmLightPosition",size:3,type:"vec3"}],fragment:`#ifdef RSMCREATE
                    uniform mat4 rsmTextureProjectionMatrix;
                    uniform vec4 rsmSpotInfo;
                    uniform vec3 rsmLightColor;
                    uniform vec3 rsmLightPosition;
                #endif`}}getSamplers(e){e.push("rsmTextureProjectionSampler")}bindForSubMesh(e){if(this._isEnabled&&(this.light.diffuse.scaleToRef(this.light.getScaledIntensity(),this._lightColor),e.updateColor3("rsmLightColor",this._lightColor),this.light.getTypeID()===tt.LIGHTTYPEID_SPOTLIGHT)){let t=this.light;this._hasProjectionTexture&&(e.updateMatrix("rsmTextureProjectionMatrix",t.projectionTextureMatrix),e.setTexture("rsmTextureProjectionSampler",t.projectionTexture));let i=O.Vector3[0];t.computeTransformedInformation()?(e.updateFloat3("rsmLightPosition",this.light.transformedPosition.x,this.light.transformedPosition.y,this.light.transformedPosition.z),t.transformedDirection.normalizeToRef(i)):(e.updateFloat3("rsmLightPosition",this.light.position.x,this.light.position.y,this.light.position.z),t.direction.normalizeToRef(i)),e.updateFloat4("rsmSpotInfo",i.x,i.y,i.z,Math.cos(t.angle*.5))}}getCustomCode(e){return e==="vertex"?null:{CUSTOM_FRAGMENT_BEGIN:`
                #ifdef RSMCREATE
                    #extension GL_EXT_draw_buffers : require
                #endif
            `,CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RSMCREATE
                    #ifdef RSMCREATE_PROJTEXTURE
                        uniform highp sampler2D rsmTextureProjectionSampler;                    
                    #endif
                    layout(location = 0) out highp vec4 glFragData[3];
                    vec4 glFragColor;
                #endif
            `,CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`
                #ifdef RSMCREATE
                    vec3 rsmColor = ${this._varAlbedoName} * rsmLightColor;
                    #ifdef RSMCREATE_PROJTEXTURE
                    {
                        vec4 strq = rsmTextureProjectionMatrix * vec4(vPositionW, 1.0);
                        strq /= strq.w;
                        rsmColor *= texture2D(rsmTextureProjectionSampler, strq.xy).rgb;
                    }
                    #endif
                    #ifdef RSMCREATE_LIGHT_IS_SPOT
                    {
                        float cosAngle = max(0., dot(rsmSpotInfo.xyz, normalize(vPositionW - rsmLightPosition)));
                        rsmColor = sign(cosAngle - rsmSpotInfo.w) * rsmColor;
                    }
                    #endif
                    glFragData[0] = vec4(vPositionW, 1.);
                    glFragData[1] = vec4(normalize(normalW) * 0.5 + 0.5, 1.);
                    glFragData[2] = vec4(rsmColor, 1.);
                #endif
            `}}};Cf.Name="RSMCreate";v([I()],Cf.prototype,"light",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],Cf.prototype,"isEnabled",void 0);P("BABYLON.RSMCreatePluginMaterial",Cf);var zK="bilateralBlurPixelShader",WK=`uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform int filterSize;uniform vec2 blurDir;uniform float depthThreshold;uniform float normalThreshold;varying vec2 vUV;void main(void) {vec3 color=textureLod(textureSampler,vUV,0.).rgb;float depth=textureLod(depthSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(color,1.);return;}
vec3 normal=textureLod(normalSampler,vUV,0.).rgb;
#ifdef DECODE_NORMAL
normal=normal*2.0-1.0;
#endif
float sigma=float(filterSize);float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sigmaNormal=normalThreshold;float two_sigmaNormal2=2.0*sigmaNormal*sigmaNormal;vec3 sum=vec3(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec3 sampleColor=textureLod(textureSampler,vUV+coords*blurDir,0.).rgb;float sampleDepth=textureLod(depthSampler,vUV+coords*blurDir,0.).r;vec3 sampleNormal=textureLod(normalSampler,vUV+coords*blurDir,0.).rgb;
#ifdef DECODE_NORMAL
sampleNormal=sampleNormal*2.0-1.0;
#endif
float r=dot(coords,coords);float w=exp(-r/two_sigma2);float depthDelta=abs(sampleDepth-depth);float wd=step(depthDelta,depthThreshold);vec3 normalDelta=abs(sampleNormal-normal);float wn=step(normalDelta.x+normalDelta.y+normalDelta.z,normalThreshold);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}
glFragColor=vec4(sum/wsum,1.);}
`;D.ShadersStore[zK]=WK;var XK="bilateralBlurQualityPixelShader",YK=`uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform int filterSize;uniform vec2 blurDir;uniform float depthThreshold;uniform float normalThreshold;varying vec2 vUV;void main(void) {vec3 color=textureLod(textureSampler,vUV,0.).rgb;float depth=textureLod(depthSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(color,1.);return;}
vec3 normal=textureLod(normalSampler,vUV,0.).rgb;
#ifdef DECODE_NORMAL
normal=normal*2.0-1.0;
#endif
float sigma=float(filterSize);float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sigmaNormal=normalThreshold;float two_sigmaNormal2=2.0*sigmaNormal*sigmaNormal;vec3 sum=vec3(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {for (int y=-filterSize; y<=filterSize; ++y) {vec2 coords=vec2(x,y)*blurDir;vec3 sampleColor=textureLod(textureSampler,vUV+coords,0.).rgb;float sampleDepth=textureLod(depthSampler,vUV+coords,0.).r;vec3 sampleNormal=textureLod(normalSampler,vUV+coords,0.).rgb;
#ifdef DECODE_NORMAL
sampleNormal=sampleNormal*2.0-1.0;
#endif
float r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepth-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);float rNormal=abs(sampleNormal.x-normal.x)+abs(sampleNormal.y-normal.y)+abs(sampleNormal.z-normal.z);float wn=exp(-rNormal*rNormal/two_sigmaNormal2);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}}
glFragColor=vec4(sum/wsum,1.);}
`;D.ShadersStore[XK]=YK;var $K="rsmGlobalIlluminationPixelShader",jK=`/**
* The implementation is an application of the formula found in http:
* For better results,it also adds a random (noise) rotation to the RSM samples (the noise artifacts are easier to remove than the banding artifacts).
*/
precision highp float;varying vec2 vUV;uniform mat4 rsmLightMatrix;uniform vec4 rsmInfo;uniform vec4 rsmInfo2;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform sampler2D rsmPositionW;uniform sampler2D rsmNormalW;uniform sampler2D rsmFlux;uniform sampler2D rsmSamples;
#ifdef TRANSFORM_NORMAL
uniform mat4 invView;
#endif
float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}
vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}
vec4 perm(vec4 x){return mod289(((x*34.0)+1.0)*x);}
float noise(vec3 p){vec3 a=floor(p);vec3 d=p-a;d=d*d*(3.0-2.0*d);vec4 b=a.xxyy+vec4(0.0,1.0,0.0,1.0);vec4 k1=perm(b.xyxy);vec4 k2=perm(k1.xyxy+b.zzww);vec4 c=k2+a.zzzz;vec4 k3=perm(c);vec4 k4=perm(c+1.0);vec4 o1=fract(k3*(1.0/41.0));vec4 o2=fract(k4*(1.0/41.0));vec4 o3=o2*d.z+o1*(1.0-d.z);vec2 o4=o3.yw*d.x+o3.xz*(1.0-d.x);return o4.y*d.y+o4.x*(1.0-d.y);}
vec3 computeIndirect(vec3 p,vec3 n) {vec3 indirectDiffuse=vec3(0.);int numSamples=int(rsmInfo.x);float radius=rsmInfo.y;float intensity=rsmInfo.z;float edgeArtifactCorrection=rsmInfo.w;vec4 texRSM=rsmLightMatrix*vec4(p,1.);texRSM.xy/=texRSM.w;texRSM.xy=texRSM.xy*0.5+0.5;float angle=noise(p*rsmInfo2.x);float c=cos(angle);float s=sin(angle);for (int i=0; i<numSamples; i++) {vec3 rsmSample=texelFetch(rsmSamples,ivec2(i,0),0).xyz;float weightSquare=rsmSample.z;if (rsmInfo2.y==1.0) rsmSample.xy=vec2(rsmSample.x*c+rsmSample.y*s,-rsmSample.x*s+rsmSample.y*c);vec2 uv=texRSM.xy+rsmSample.xy*radius;if (uv.x<0. || uv.x>1. || uv.y<0. || uv.y>1.) continue;vec3 vplPositionW=textureLod(rsmPositionW,uv,0.).xyz;vec3 vplNormalW=textureLod(rsmNormalW,uv,0.).xyz*2.0-1.0;vec3 vplFlux=textureLod(rsmFlux,uv,0.).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; 
float dist2=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*weightSquare*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}
return clamp(indirectDiffuse*intensity,0.0,1.0);}
void main(void) 
{vec3 positionW=texture2D(textureSampler,vUV).xyz;vec3 normalW=texture2D(normalSampler,vUV).xyz;
#ifdef DECODE_NORMAL
normalW=normalW*2.0-1.0;
#endif
#ifdef TRANSFORM_NORMAL
normalW=(invView*vec4(normalW,0.)).xyz;
#endif
gl_FragColor.rgb=computeIndirect(positionW,normalW);gl_FragColor.a=1.0;}
`;D.ShadersStore[$K]=jK;var qK="rsmFullGlobalIlluminationPixelShader",QK=`/**
* The implementation is a direct application of the formula found in http:
*/
precision highp float;varying vec2 vUV;uniform mat4 rsmLightMatrix;uniform vec4 rsmInfo;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform sampler2D rsmPositionW;uniform sampler2D rsmNormalW;uniform sampler2D rsmFlux;
#ifdef TRANSFORM_NORMAL
uniform mat4 invView;
#endif
vec3 computeIndirect(vec3 p,vec3 n) {vec3 indirectDiffuse=vec3(0.);float intensity=rsmInfo.z;float edgeArtifactCorrection=rsmInfo.w;vec4 texRSM=rsmLightMatrix*vec4(p,1.);texRSM.xy/=texRSM.w;texRSM.xy=texRSM.xy*0.5+0.5;int width=int(rsmInfo.x);int height=int(rsmInfo.y);for (int j=0; j<height; j++) {for (int i=0; i<width; i++) {ivec2 uv=ivec2(i,j);vec3 vplPositionW=texelFetch(rsmPositionW,uv,0).xyz;vec3 vplNormalW=texelFetch(rsmNormalW,uv,0).xyz*2.0-1.0;vec3 vplFlux=texelFetch(rsmFlux,uv,0).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; 
float dist2=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}}
return clamp(indirectDiffuse*intensity,0.0,1.0);}
void main(void) 
{vec3 positionW=texture2D(textureSampler,vUV).xyz;vec3 normalW=texture2D(normalSampler,vUV).xyz;
#ifdef DECODE_NORMAL
normalW=normalW*2.0-1.0;
#endif
#ifdef TRANSFORM_NORMAL
normalW=(invView*vec4(normalW,0.)).xyz;
#endif
gl_FragColor.rgb=computeIndirect(positionW,normalW);gl_FragColor.a=1.0;}
`;D.ShadersStore[qK]=QK;var TM=class extends Qt{constructor(){super(...arguments),this.RENDER_WITH_GIRSM=!1,this.RSMCREATE_PROJTEXTURE=!1}},uc=class s extends Ti{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}constructor(e){super(e,s.Name,310,new TM),this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._isPBR=e instanceof Gt}prepareDefines(e){e.RENDER_WITH_GIRSM=this._isEnabled}getClassName(){return"GIRSMRenderPluginMaterial"}getUniforms(){return{ubo:[{name:"girsmTextureOutputSize",size:2,type:"vec2"}],fragment:`#ifdef RENDER_WITH_GIRSM
                    uniform vec2 girsmTextureOutputSize;
                #endif`}}getSamplers(e){e.push("girsmTextureGIContrib")}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("girsmTextureGIContrib",this.textureGIContrib),e.updateFloat2("girsmTextureOutputSize",this.outputTextureWidth,this.outputTextureHeight))}getCustomCode(e){let t={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_GIRSM
                    uniform sampler2D girsmTextureGIContrib;

                    vec3 computeIndirect() {
                        vec2 uv = gl_FragCoord.xy / girsmTextureOutputSize;
                        return texture2D(girsmTextureGIContrib, uv).rgb;
                    }
                #endif
            `,CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION:`
                #ifdef RENDER_WITH_GIRSM
                    finalDiffuse += computeIndirect() * surfaceAlbedo.rgb;
                #endif
            `};return this._isPBR||(t.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_GIRSM
                    color.rgb += computeIndirect() * baseColor.rgb;
                #endif
            `),e==="vertex"?null:t}};uc.Name="GIRSMRender";v([I()],uc.prototype,"textureGIContrib",void 0);v([I()],uc.prototype,"outputTextureWidth",void 0);v([I()],uc.prototype,"outputTextureHeight",void 0);v([I(),Q("_markAllSubMeshesAsTexturesDirty")],uc.prototype,"isEnabled",void 0);P("BABYLON.GIRSMRenderPluginMaterial",uc);var KK="spriteMapPixelShader",ZK=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
precision highp float;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform float spriteCount;uniform sampler2D spriteSheet;uniform vec2 spriteMapSize;uniform vec2 outputSize;uniform vec2 stageSize;uniform sampler2D frameMap;uniform sampler2D tileMaps[LAYERS];uniform sampler2D animationMap;uniform vec3 colorMul;float mt;const float fdStep=1./4.;const float aFrameSteps=1./MAX_ANIMATION_FRAMES;mat4 getFrameData(float frameID){float fX=frameID/spriteCount;return mat4(
texture2D(frameMap,vec2(fX,0.),0.),
texture2D(frameMap,vec2(fX,fdStep*1.),0.),
texture2D(frameMap,vec2(fX,fdStep*2.),0.),
vec4(0.)
);}
void main(){vec4 color=vec4(0.);vec2 tileUV=fract(tUV);
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
vec2 tileID=floor(tUV);vec2 sheetUnits=1./spriteMapSize;float spriteUnits=1./spriteCount;vec2 stageUnits=1./stageSize;for(int i=0; i<LAYERS; i++) {float frameID;
#define LAYER_ID_SWITCH
vec4 animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,0.),0.);if(animationData.y>0.) {mt=mod(time*animationData.z,1.0);for(float f=0.; f<MAX_ANIMATION_FRAMES; f++){if(animationData.y>mt){frameID=animationData.x;break;}
animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.);}}
mat4 frameData=getFrameData(frameID+0.5);vec2 frameSize=(frameData[0].zw)/spriteMapSize;vec2 offset=frameData[0].xy*sheetUnits;vec2 ratio=frameData[2].xy/frameData[0].zw;if (frameData[2].z==1.){tileUV.xy=tileUV.yx;}
vec4 nc=texture2D(spriteSheet,tileUV*frameSize+offset);if (i==0){color=nc;} else {float alpha=min(color.a+nc.a,1.0);vec3 mixed=mix(color.xyz,nc.xyz,nc.a);color=vec4(mixed,alpha);}}
color.xyz*=colorMul;gl_FragColor=color;}`;D.ShadersStore[KK]=ZK;var JK="spriteMapVertexShader",eZ=`precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;varying vec2 stageUnits;varying vec2 levelUnits;varying vec2 tileID;uniform float time;uniform mat4 worldViewProjection;uniform vec2 outputSize;uniform vec2 stageSize;uniform vec2 spriteMapSize;uniform float stageScale;void main() {vec4 p=vec4( position,1. );vPosition=p.xyz;vUV=uv;tUV=uv*stageSize; 
gl_Position=worldViewProjection*p;}`;D.ShadersStore[JK]=eZ;var gl=class{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}};U.prototype.notifyObserversWithPromise=function(s,e=-1,t,i,r){return $e(this,null,function*(){let n=Promise.resolve(s);if(!this.observers.length)return n;let o=this._eventState;return o.mask=e,o.target=t,o.currentTarget=i,o.skipNextObservers=!1,o.userInfo=r,this.observers.forEach(a=>{o.skipNextObservers||a._willBeUnregistered||a.mask&e&&(a.scope?n=n.then(l=>(o.lastReturnValue=l,a.callback.apply(a.scope,[s,o]))):n=n.then(l=>(o.lastReturnValue=l,a.callback(s,o))),a.unregisterOnNextCall&&this._deferUnregister(a))}),yield n,s})};var dc=null;function zV(s,e,t,i,r="image/png",n=!1,o){let{height:a,width:l}=WV(s,e,t);if(!(a&&l)){F.Error("Invalid 'size' parameter !");return}dc||(dc=document.createElement("canvas")),dc.width=l,dc.height=a;let c=dc.getContext("2d"),h=s.getRenderWidth()/s.getRenderHeight(),u=l,d=u/h;d>a&&(d=a,u=d*h);let f=Math.max(0,l-u)/2,m=Math.max(0,a-d)/2;e.getScene().activeCamera!==e?CM(s,e,t,_=>{if(n){let x=new Blob([_]);H.DownloadBlob(x),i&&i("")}else i&&i(_)},r,1,s.getCreationOptions().antialias,void 0,void 0,void 0,void 0,o):s.onEndFrameObservable.addOnce(()=>{let _=s.getRenderingCanvas();c&&_&&c.drawImage(_,f,m,u,d),dc&&(n?(H.EncodeScreenshotCanvasData(dc,void 0,r,void 0,o),i&&i("")):H.EncodeScreenshotCanvasData(dc,i,r,void 0,o))})}function tZ(s,e,t,i="image/png",r){return new Promise((n,o)=>{zV(s,e,t,a=>{typeof a<"u"?n(a):o(new Error("Data is undefined"))},i,void 0,r)})}function CM(s,e,t,i,r="image/png",n=1,o=!1,a,l=!1,c=!1,h=!0,u,d){let{height:f,width:m,finalWidth:g,finalHeight:_}=WV(s,e,t),x={width:m,height:f};if(!(f&&m)){F.Error("Invalid 'size' parameter !");return}let b={width:s.getRenderWidth(),height:s.getRenderHeight()};s.setSize(m,f);let C=e.getScene(),R=new vt("screenShot",x,C,!1,!1,0,!1,z.BILINEAR_SAMPLINGMODE,void 0,c,void 0,void 0,void 0,n);R.renderList=C.meshes.slice(),R.samples=n,R.renderSprites=l,R.activeCamera=e,R.forceLayerMaskCheck=h,d?.(R);let E=()=>{R.isReadyForRendering()&&e.isReady(!0)?(s.onEndFrameObservable.addOnce(()=>{g===m&&_===f?R.readPixels(void 0,void 0,void 0,!1).then(A=>{$n.DumpData(m,f,A,i,r,a,!0,void 0,u),R.dispose()}):_m("pass",R.getInternalTexture(),C,void 0,void 0,void 0,g,_).then(A=>{s._readTexturePixels(A,g,_,-1,0,null,!0,!1,0,0).then(L=>{$n.DumpData(g,_,L,i,r,a,!0,void 0,u),A.dispose()})})}),R.render(!0),C.incrementRenderId(),C.resetCachedMaterial(),s.setSize(b.width,b.height),e.getProjectionMatrix(!0),C.render()):setTimeout(E,16)},S=()=>{C.incrementRenderId(),C.resetCachedMaterial(),E()};if(o){let A=new ml("antialiasing",1,C.activeCamera);R.addPostProcess(A),A.getEffect().isReady()?S():A.getEffect().onCompiled=()=>{S()}}else S()}function iZ(s,e,t,i="image/png",r=1,n=!1,o,a=!1,l=!1,c=!0,h){return new Promise((u,d)=>{CM(s,e,t,f=>{typeof f<"u"?u(f):d(new Error("Data is undefined"))},i,r,n,o,a,l,c,h)})}function WV(s,e,t){let i=0,r=0,n=0,o=0;if(typeof t=="object"){let a=t.precision?Math.abs(t.precision):1;t.width&&t.height?(i=t.height*a,r=t.width*a):t.width&&!t.height?(r=t.width*a,i=Math.round(r/s.getAspectRatio(e))):t.height&&!t.width?(i=t.height*a,r=Math.round(i*s.getAspectRatio(e))):(r=Math.round(s.getRenderWidth()*a),i=Math.round(r/s.getAspectRatio(e))),t.finalWidth&&t.finalHeight?(o=t.finalHeight,n=t.finalWidth):t.finalWidth&&!t.finalHeight?(n=t.finalWidth,o=Math.round(n/s.getAspectRatio(e))):t.finalHeight&&!t.finalWidth?(o=t.finalHeight,n=Math.round(o*s.getAspectRatio(e))):(n=r,o=i)}else isNaN(t)||(i=t,r=t,n=t,o=t);return r&&(r=Math.floor(r)),i&&(i=Math.floor(i)),n&&(n=Math.floor(n)),o&&(o=Math.floor(o)),{height:i|0,width:r|0,finalWidth:n|0,finalHeight:o|0}}var rZ=()=>{H.CreateScreenshot=zV,H.CreateScreenshotAsync=tZ,H.CreateScreenshotUsingRenderTarget=CM,H.CreateScreenshotUsingRenderTargetAsync=iZ};rZ();var Vh=class{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then(t=>{this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0})}readUint32(){let e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){let t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return PO(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}};var ob=class{static _GetStorage(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch{let e={};return{getItem:t=>{let i=e[t];return i===void 0?null:i},setItem:(t,i)=>{e[t]=i}}}}static ReadString(e,t){let i=this._Storage.getItem(e);return i!==null?i:t}static WriteString(e,t){this._Storage.setItem(e,t)}static ReadBoolean(e,t){let i=this._Storage.getItem(e);return i!==null?i==="true":t}static WriteBoolean(e,t){this._Storage.setItem(e,t?"true":"false")}static ReadNumber(e,t){let i=this._Storage.getItem(e);return i!==null?parseFloat(i):t}static WriteNumber(e,t){this._Storage.setItem(e,t.toString())}};ob._Storage=ob._GetStorage();var HV;(function(s){class e{serialize(){let r={},n=new Array(this._characterToIdx.size);return this._characterToIdx.forEach((o,a)=>{n[o]=a}),r.characters=n,r.insertionCosts=this._insertionCosts,r.deletionCosts=this._deletionCosts,r.substitutionCosts=this._substitutionCosts,JSON.stringify(r)}static Deserialize(r){let n=JSON.parse(r),o=new e(n.characters);return o._insertionCosts=n.insertionCosts,o._deletionCosts=n.deletionCosts,o._substitutionCosts=n.substitutionCosts,o}constructor(r,n=null,o=null,a=null){n=n??(()=>1),o=o??(()=>1),a=a??((c,h)=>c===h?0:1),this._characterToIdx=new Map,this._insertionCosts=new Array(r.length),this._deletionCosts=new Array(r.length),this._substitutionCosts=new Array(r.length);let l;for(let c=0;c<r.length;++c){l=r[c],this._characterToIdx.set(l,c),this._insertionCosts[c]=n(l),this._deletionCosts[c]=o(l),this._substitutionCosts[c]=new Array(r.length);for(let h=c;h<r.length;++h)this._substitutionCosts[c][h]=a(l,r[h])}}getCharacterIdx(r){return this._characterToIdx.get(r)}getInsertionCost(r){return this._insertionCosts[r]}getDeletionCost(r){return this._deletionCosts[r]}getSubstitutionCost(r,n){let o=Math.min(r,n),a=Math.max(r,n);return this._substitutionCosts[o][a]}}s.Alphabet=e;class t{serialize(){return JSON.stringify(this._characters)}static Deserialize(r,n){let o=new t([],n);return o._characters=JSON.parse(r),o}constructor(r,n){if(r.length>t._MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+t._MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=n,this._characters=r.map(o=>this._alphabet.getCharacterIdx(o))}distance(r){return t._Distance(this,r)}static _Distance(r,n){let o=r._alphabet;if(o!==n._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");let a=r._characters,l=n._characters,c=a.length,h=l.length,u=t._CostMatrix;u[0][0]=0;for(let d=0;d<c;++d)u[d+1][0]=u[d][0]+o.getInsertionCost(a[d]);for(let d=0;d<h;++d)u[0][d+1]=u[0][d]+o.getInsertionCost(l[d]);for(let d=0;d<c;++d)for(let f=0;f<h;++f)t._InsertionCost=u[d+1][f]+o.getInsertionCost(l[f]),t._DeletionCost=u[d][f+1]+o.getDeletionCost(a[d]),t._SubstitutionCost=u[d][f]+o.getSubstitutionCost(a[d],l[f]),u[d+1][f+1]=Math.min(t._InsertionCost,t._DeletionCost,t._SubstitutionCost);return u[c][h]}}t._MAX_SEQUENCE_LENGTH=256,t._CostMatrix=[...Array(t._MAX_SEQUENCE_LENGTH+1)].map(()=>new Array(t._MAX_SEQUENCE_LENGTH+1)),s.Sequence=t})(HV||(HV={}));var Uh=class s{serialize(){return JSON.stringify(this)}static Deserialize(e){let t=JSON.parse(e),i=new s(t._segmentLength);return i._points=t._points.map(r=>new p(r._x,r._y,r._z)),i}constructor(e=.01){this._points=[],this._segmentLength=e}getLength(){return this._points.length*this._segmentLength}add(e){let t=this._points.length;if(t===0)this._points.push(e.clone());else{let i=()=>this._segmentLength/p.Distance(this._points[t-1],e);for(let r=i();r<=1;r=i()){let n=this._points[t-1].scale(1-r);e.scaleAndAddToRef(r,n),this._points.push(n),++t}}}resampleAtTargetResolution(e){let t=new s(this.getLength()/e);return this._points.forEach(i=>{t.add(i)}),t}tokenize(e){let t=[],i=new p;for(let r=2;r<this._points.length;++r)s._TransformSegmentDirToRef(this._points[r-2],this._points[r-1],this._points[r],i)&&t.push(s._TokenizeSegment(i,e));return t}static _TransformSegmentDirToRef(e,t,i,r){return t.subtractToRef(e,s._ForwardDir),s._ForwardDir.normalize(),t.scaleToRef(-1,s._InverseFromVec),s._InverseFromVec.normalize(),Math.abs(p.Dot(s._ForwardDir,s._InverseFromVec))>.98?!1:(p.CrossToRef(s._ForwardDir,s._InverseFromVec,s._UpDir),s._UpDir.normalize(),N.LookAtLHToRef(e,t,s._UpDir,s._LookMatrix),i.subtractToRef(t,s._FromToVec),s._FromToVec.normalize(),p.TransformNormalToRef(s._FromToVec,s._LookMatrix,r),!0)}static _TokenizeSegment(e,t){s._BestMatch=0,s._Score=p.Dot(e,t[0]),s._BestScore=s._Score;for(let i=1;i<t.length;++i)s._Score=p.Dot(e,t[i]),s._Score>s._BestScore&&(s._BestMatch=i,s._BestScore=s._Score);return s._BestMatch}};Uh._ForwardDir=new p;Uh._InverseFromVec=new p;Uh._UpDir=new p;Uh._FromToVec=new p;Uh._LookMatrix=new N;var Vo=class{constructor(e){this._view=new Float32Array(e),this._itemLength=0}get itemLength(){return this._itemLength}at(e){return e<0||e>=this._itemLength?NaN:this._view[e]}subarray(e,t){return e>=t||e<0?new Float32Array(0):(t>this._itemLength&&(t=this._itemLength),this._view.subarray(e,t))}push(e){this._view[this._itemLength]=e,this._itemLength++,this._itemLength>=this._view.length&&this._growArray()}_growArray(){let e=Math.floor(this._view.length*1.5),t=new Float32Array(e);t.set(this._view),this._view=t}};var fc=1800,nZ=24,oZ="0",XV="timestamp",YV="numPoints",aZ=/\r/g,bM="@",ab=class s{static get SliceDataOffset(){return 2}static get NumberOfPointsOffset(){return 1}constructor(e,t){this._scene=e,this._collectDataAtFrame=()=>{let i=Mi.Now-this._startingTimestamp,r=this.datasets.ids.length,n=this.datasets.startingIndices.itemLength,o=0;if(n>0){let a=this.datasets.startingIndices.at(n-1);o=a+this.datasets.data.at(a+s.NumberOfPointsOffset)+s.SliceDataOffset}if(this.datasets.startingIndices.push(o),this.datasets.data.push(i),this.datasets.data.push(r),this.datasets.ids.forEach(a=>{let l=this._strategies.get(a);l&&this.datasets.data.push(l.getData())}),this.datasetObservable.hasObservers()){let a=[i,r];for(let l=0;l<r;l++)a.push(this.datasets.data.at(o+s.SliceDataOffset+l));this.datasetObservable.notifyObservers(a)}},this.datasets={ids:[],data:new Vo(fc),startingIndices:new Vo(fc)},this._strategies=new Map,this._datasetMeta=new Map,this._eventRestoreSet=new Set,this._customEventObservable=new U,this.datasetObservable=new U,this.metadataObservable=new U(i=>i.callback(this._datasetMeta,new yO(0))),t&&this.addCollectionStrategies(...t)}registerEvent(e,t,i){if(this._strategies.has(e)&&!t)return;this._strategies.has(e)&&t&&(this._strategies.get(e)?.dispose(),this._strategies.delete(e));let r=o=>{let a=0,l=0,c=o.onAfterRenderObservable.add(()=>{l=a,a=0}),h=this._customEventObservable.add(u=>{e===u.name&&(u.value!==void 0?a=u.value:a++)});return{id:e,getData:()=>l,dispose:()=>{o.onAfterRenderObservable.remove(c),this._customEventObservable.remove(h)}}},n={name:e};return this._eventRestoreSet.add(e),this.addCollectionStrategies({strategyCallback:r,category:i}),n}sendEvent(e){this._customEventObservable.notifyObservers(e)}_restoreStringEvents(){this._eventRestoreSet.size!==this._customEventObservable.observers.length&&this._eventRestoreSet.forEach(e=>{this.registerEvent(e,!0)})}addCollectionStrategies(...e){for(let{strategyCallback:t,category:i,hidden:r}of e){let n=t(this._scene);if(this._strategies.has(n.id)){n.dispose();continue}this.datasets.ids.push(n.id),i&&(i=i.replace(new RegExp(bM,"g"),"")),this._datasetMeta.set(n.id,{color:this._getHexColorFromId(n.id),category:i,hidden:r}),this._strategies.set(n.id,n)}this.metadataObservable.notifyObservers(this._datasetMeta)}_getHexColorFromId(e){let t=0;for(let r=0;r<e.length;r++)t=e.charCodeAt(r)+((t<<5)-t);let i="#";for(let r=0;r<nZ;r+=8){let n=t>>r&255;i+=(oZ+n.toString(16)).substr(-2)}return i}getCurrentSlice(){let e=Mi.Now-this._startingTimestamp,t=this.datasets.ids.length,i=[e,t];this.datasets.ids.forEach(r=>{let n=this._strategies.get(r);n&&this.datasetObservable.hasObservers()&&i.push(n.getData())}),this.datasetObservable.hasObservers()&&this.datasetObservable.notifyObservers(i)}updateMetadata(e,t,i){let r=this._datasetMeta.get(e);r&&(r[t]=i,this.metadataObservable.notifyObservers(this._datasetMeta))}clear(e){this.datasets.data=new Vo(fc),this.datasets.ids.length=0,this.datasets.startingIndices=new Vo(fc),this._datasetMeta.clear(),this._strategies.forEach(t=>t.dispose()),this._strategies.clear(),e||this._eventRestoreSet.clear(),this._hasLoadedData=!1}get hasLoadedData(){return this._hasLoadedData}loadFromFileData(e,t){let i=e.replace(aZ,"").split(`
`).map(u=>u.split(",").filter(d=>d.length>0)).filter(u=>u.length>0),r=0,n=s.NumberOfPointsOffset;if(i.length<2)return!1;let o={ids:[],data:new Vo(fc),startingIndices:new Vo(fc)},[a,...l]=i;if(a.length<2||a[r]!==XV||a[n]!==YV)return!1;let c=new Map;for(let u=s.SliceDataOffset;u<a.length;u++){let[d,f]=a[u].split(bM);o.ids.push(d),c.set(d,f)}let h=0;for(let u of l){if(u.length<2)return!1;let d=parseFloat(u[r]),f=parseInt(u[n]);if(isNaN(f)||isNaN(d)||(o.data.push(d),o.data.push(f),f+s.SliceDataOffset!==u.length))return!1;for(let m=s.SliceDataOffset;m<u.length;m++){let g=parseFloat(u[m]);if(isNaN(g))return!1;o.data.push(g)}o.startingIndices.push(h),h+=u.length}if(this.datasets.ids=o.ids,this.datasets.data=o.data,this.datasets.startingIndices=o.startingIndices,t||this._datasetMeta.clear(),this._strategies.forEach(u=>u.dispose()),this._strategies.clear(),!t)for(let u of this.datasets.ids){let d=c.get(u);this._datasetMeta.set(u,{category:d,color:this._getHexColorFromId(u)})}return this.metadataObservable.notifyObservers(this._datasetMeta),this._hasLoadedData=!0,!0}exportDataToCsv(){let e="";e+=`${XV},${YV}`;for(let i=0;i<this.datasets.ids.length;i++)if(e+=`,${this.datasets.ids[i]}`,this._datasetMeta){let r=this._datasetMeta.get(this.datasets.ids[i]);r?.category&&(e+=`${bM}${r.category}`)}e+=`
`;for(let i=0;i<this.datasets.startingIndices.itemLength;i++){let r=this.datasets.startingIndices.at(i),n=this.datasets.data.at(r),o=this.datasets.data.at(r+s.NumberOfPointsOffset);e+=`${n},${o}`;for(let a=0;a<o;a++)e+=`,${this.datasets.data.at(r+s.SliceDataOffset+a)}`;for(let a=0;a<this.datasets.ids.length-o;a++)e+=",";e+=`
`}let t=`${new Date().toISOString()}-perfdata.csv`;H.Download(new Blob([e],{type:"text/csv"}),t)}start(e){e?this._startingTimestamp===void 0&&(this._startingTimestamp=Mi.Now):(this.datasets.data=new Vo(fc),this.datasets.startingIndices=new Vo(fc),this._startingTimestamp=Mi.Now),this._scene.onAfterRenderObservable.add(this._collectDataAtFrame),this._restoreStringEvents(),this._isStarted=!0}stop(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._isStarted=!1}get isStarted(){return this._isStarted}dispose(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._datasetMeta.clear(),this._strategies.forEach(e=>{e.dispose()}),this.datasetObservable.clear(),this.metadataObservable.clear(),this._isStarted=!1,this.datasets=null}};Te.prototype.getPerfCollector=function(){return this._perfCollector||(this._perfCollector=new ab(this)),this._perfCollector};function lZ(s){let e=new Array,t=new Array,i=new Array,r=s.add(()=>{let o=e.length;for(let a=0;a<o;a++)Xp(e.shift(),t.shift(),i.shift())});return{scheduler:(o,a,l)=>{e.push(o),t.push(a),i.push(l)},dispose:()=>{s.remove(r)}}}U.prototype.runCoroutineAsync=function(s){if(!this._coroutineScheduler){let e=lZ(this);this._coroutineScheduler=e.scheduler,this._coroutineSchedulerDispose=e.dispose}return wx(s,this._coroutineScheduler)};U.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};var cZ="equirectangularPanoramaPixelShader",hZ=`#ifdef GL_ES
precision highp float;
#endif
#define M_PI 3.1415926535897932384626433832795
varying vec2 vUV;uniform samplerCube cubeMap;void main(void) {vec2 uv=vUV;float longitude=uv.x*2.*M_PI-M_PI+M_PI/2.;float latitude=(1.-uv.y)*M_PI;vec3 dir=vec3(
- sin( longitude )*sin( latitude ),
cos( latitude ),
- cos( longitude )*sin( latitude )
);normalize( dir );gl_FragColor=textureCube( cubeMap,dir );}`;D.ShadersStore[cZ]=hZ;var kh=class s extends Ct{constructor(e,t={}){super(e),this.options=t,this._direction=new p(0,0,-1),this._mat=new N,this._onSelectEnabled=!1,this._origin=new p(0,0,0),this.lastNativeXRHitResults=[],this.onHitTestResultObservable=new U,this._onHitTestResults=i=>{let r=i.map(n=>{let o=N.FromArray(n.hitMatrix);return this._xrSessionManager.scene.useRightHandedSystem||o.toggleModelMatrixHandInPlace(),this.options.worldParentNode&&o.multiplyToRef(this.options.worldParentNode.getWorldMatrix(),o),{xrHitResult:n,transformationMatrix:o}});this.lastNativeXRHitResults=i,this.onHitTestResultObservable.notifyObservers(r)},this._onSelect=i=>{this._onSelectEnabled&&s.XRHitTestWithSelectEvent(i,this._xrSessionManager.referenceSpace)},this.xrNativeFeatureName="hit-test",H.Warn("A newer version of this plugin is available")}static XRHitTestWithRay(e,t,i,r){return e.requestHitTest(t,i).then(n=>{let o=r||(a=>!!a.hitMatrix);return n.filter(o)})}static XRHitTestWithSelectEvent(e,t){let i=e.frame.getPose(e.inputSource.targetRaySpace,t);if(!i)return Promise.resolve([]);let r=new XRRay(i.transform);return this.XRHitTestWithRay(e.frame.session,r,t)}attach(){return super.attach()?(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0):!1}detach(){return super.detach()?(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0):!1}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!this.attached||this.options.testOnPointerDownOnly)return;let t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;N.FromArrayToRef(t.transform.matrix,0,this._mat),p.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),p.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();let i=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});s.XRHitTestWithRay(this._xrSessionManager.session,i,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}};kh.Name=ct.HIT_TEST;kh.Version=1;mt.AddWebXRFeature(kh.Name,(s,e)=>()=>new kh(s,e),kh.Version,!1);var uZ=0,Gh=class extends Ct{set referenceSpaceForFrameAnchors(e){this._referenceSpaceForFrameAnchors=e}constructor(e,t={}){super(e),this._options=t,this._lastFrameDetected=new Set,this._trackedAnchors=[],this._futureAnchors=[],this.onAnchorAddedObservable=new U,this.onAnchorRemovedObservable=new U,this.onAnchorUpdatedObservable=new U,this._tmpVector=new p,this._tmpQuaternion=new q,this.xrNativeFeatureName="anchors"}_populateTmpTransformation(e,t){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(t),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}}addAnchorPointUsingHitTestResultAsync(r){return $e(this,arguments,function*(e,t=new p,i=new q){this._populateTmpTransformation(t,i);let n=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w});if(e.xrHitResult.createAnchor)try{let o=yield e.xrHitResult.createAnchor(n);return new Promise((a,l)=>{this._futureAnchors.push({nativeAnchor:o,resolved:!1,submitted:!0,xrTransformation:n,resolve:a,reject:l})})}catch(o){throw new Error(o)}else throw this.detach(),new Error("Anchors not enabled in this environment/browser")})}addAnchorAtPositionAndRotationAsync(r){return $e(this,arguments,function*(e,t=new q,i=!1){this._populateTmpTransformation(e,t);let n=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),o=i&&this.attached&&this._xrSessionManager.currentFrame?yield this._createAnchorAtTransformation(n,this._xrSessionManager.currentFrame):void 0;return new Promise((a,l)=>{this._futureAnchors.push({nativeAnchor:o,resolved:!1,submitted:!1,xrTransformation:n,resolve:a,reject:l})})})}get anchors(){return this._trackedAnchors}detach(){if(!super.detach())return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){let e=this._trackedAnchors.pop();if(e){try{e.remove()}catch{}this.onAnchorRemovedObservable.notifyObservers(e)}}return!0}dispose(){this._futureAnchors.length=0,super.dispose(),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()}_onXRFrame(e){if(!this.attached||!e)return;let t=e.trackedAnchors;if(t){let i=this._trackedAnchors.filter(n=>!t.has(n.xrAnchor)).map(n=>this._trackedAnchors.indexOf(n)),r=0;i.forEach(n=>{let o=this._trackedAnchors.splice(n-r,1)[0];this.onAnchorRemovedObservable.notifyObservers(o),r++}),t.forEach(n=>{if(this._lastFrameDetected.has(n)){let o=this._findIndexInAnchorArray(n),a=this._trackedAnchors[o];try{this._updateAnchorWithXRFrame(n,a,e),a.attachedNode&&(a.attachedNode.rotationQuaternion=a.attachedNode.rotationQuaternion||new q,a.transformationMatrix.decompose(a.attachedNode.scaling,a.attachedNode.rotationQuaternion,a.attachedNode.position)),this.onAnchorUpdatedObservable.notifyObservers(a)}catch{H.Warn("Anchor could not be updated")}}else{let o={id:uZ++,xrAnchor:n,remove:()=>n.delete()},a=this._updateAnchorWithXRFrame(n,o,e);this._trackedAnchors.push(a),this.onAnchorAddedObservable.notifyObservers(a);let c=this._futureAnchors.filter(h=>h.nativeAnchor===n)[0];c&&(c.resolve(a),c.resolved=!0)}}),this._lastFrameDetected=t}this._futureAnchors.forEach(i=>{!i.resolved&&!i.submitted&&(this._createAnchorAtTransformation(i.xrTransformation,e).then(r=>{i.nativeAnchor=r},r=>{i.resolved=!0,i.reject(r)}),i.submitted=!0)})}_findIndexInAnchorArray(e){for(let t=0;t<this._trackedAnchors.length;++t)if(this._trackedAnchors[t].xrAnchor===e)return t;return-1}_updateAnchorWithXRFrame(e,t,i){let r=i.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(r){let n=t.transformationMatrix||new N;N.FromArrayToRef(r.transform.matrix,0,n),this._xrSessionManager.scene.useRightHandedSystem||n.toggleModelMatrixHandInPlace(),t.transformationMatrix=n,this._options.worldParentNode&&n.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),n)}return t}_createAnchorAtTransformation(e,t){return $e(this,null,function*(){if(t.createAnchor)try{return t.createAnchor(e,this._referenceSpaceForFrameAnchors??this._xrSessionManager.referenceSpace)}catch(i){throw new Error(i)}else throw this.detach(),new Error("Anchors are not enabled in your browser")})}};Gh.Name=ct.ANCHOR_SYSTEM;Gh.Version=1;mt.AddWebXRFeature(Gh.Name,(s,e)=>()=>new Gh(s,e),Gh.Version);var dZ=0,zh=class extends Ct{constructor(e,t={}){super(e),this._options=t,this._detectedPlanes=[],this._enabled=!1,this._lastFrameDetected=new Set,this.onPlaneAddedObservable=new U,this.onPlaneRemovedObservable=new U,this.onPlaneUpdatedObservable=new U,this.xrNativeFeatureName="plane-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){if(!super.detach())return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){let e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0}dispose(){super.dispose(),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()}isCompatible(){return typeof XRPlane<"u"}initiateRoomCapture(){return $e(this,null,function*(){return this._xrSessionManager.session.initiateRoomCapture?this._xrSessionManager.session.initiateRoomCapture():Promise.reject("initiateRoomCapture is not supported on this session")})}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;let t=e.detectedPlanes||e.worldInformation?.detectedPlanes;if(t){for(let i=0;i<this._detectedPlanes.length;i++){let r=this._detectedPlanes[i];t.has(r.xrPlane)||(this._detectedPlanes.splice(i--,1),this.onPlaneRemovedObservable.notifyObservers(r))}t.forEach(i=>{if(this._lastFrameDetected.has(i)){if(i.lastChangedTime===this._xrSessionManager.currentTimestamp){let r=this._findIndexInPlaneArray(i),n=this._detectedPlanes[r];this._updatePlaneWithXRPlane(i,n,e),this.onPlaneUpdatedObservable.notifyObservers(n)}}else{let r={id:dZ++,xrPlane:i,polygonDefinition:[]},n=this._updatePlaneWithXRPlane(i,r,e);this._detectedPlanes.push(n),this.onPlaneAddedObservable.notifyObservers(n)}}),this._lastFrameDetected=t}}_init(){let e=()=>{this._enabled=!0,this._detectedPlanes.length&&(this._detectedPlanes.length=0)};if(this._xrSessionManager.isNative&&this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),!this._xrSessionManager.session.updateWorldTrackingState){e();return}this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),e()}_updatePlaneWithXRPlane(e,t,i){t.polygonDefinition=e.polygon.map(n=>{let o=this._xrSessionManager.scene.useRightHandedSystem?1:-1;return new p(n.x,n.y,n.z*o)});let r=i.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(r){let n=t.transformationMatrix||new N;N.FromArrayToRef(r.transform.matrix,0,n),this._xrSessionManager.scene.useRightHandedSystem||n.toggleModelMatrixHandInPlace(),t.transformationMatrix=n,this._options.worldParentNode&&n.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),n)}return t}_findIndexInPlaneArray(e){for(let t=0;t<this._detectedPlanes.length;++t)if(this._detectedPlanes[t].xrPlane===e)return t;return-1}};zh.Name=ct.PLANE_DETECTION;zh.Version=1;mt.AddWebXRFeature(zh.Name,(s,e)=>()=>new zh(s,e),zh.Version);var Wh=class extends Ct{constructor(e,t={}){super(e),this.options=t,this.onBackgroundStateChangedObservable=new U}attach(){return this._setBackgroundState(!1),super.attach()}detach(){return this._setBackgroundState(!0),super.detach()}dispose(){super.dispose(),this.onBackgroundStateChangedObservable.clear()}_onXRFrame(e){}_setBackgroundState(e){let t=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){let i=t.getMeshByName("BackgroundSkybox");i&&i.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){let i=t.getMeshByName("BackgroundPlane");i&&i.setEnabled(e)}}else{let i=t.getMeshByName("BackgroundHelper");i&&i.setEnabled(e)}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach(i=>i.setEnabled(e)),this.onBackgroundStateChangedObservable.notifyObservers(e)}};Wh.Name=ct.BACKGROUND_REMOVER;Wh.Version=1;mt.AddWebXRFeature(Wh.Name,(s,e)=>()=>new Wh(s,e),Wh.Version,!0);var Hh=class extends Ct{_createPhysicsImpostor(e){let t=this._options.physicsProperties.impostorType||He.SphereImpostor,i=this._options.physicsProperties.impostorSize||.1,r=pr("impostor-mesh-"+e.uniqueId,{diameterX:typeof i=="number"?i:i.width,diameterY:typeof i=="number"?i:i.height,diameterZ:typeof i=="number"?i:i.depth});r.isVisible=this._debugMode,r.isPickable=!1,r.rotationQuaternion=new q;let n=e.grip||e.pointer;r.position.copyFrom(n.position),r.rotationQuaternion.copyFrom(n.rotationQuaternion);let o=new He(r,t,ie({mass:0},this._options.physicsProperties));this._controllers[e.uniqueId]={xrController:e,impostor:o,impostorMesh:r}}constructor(e,t){super(e),this._options=t,this._attachController=i=>{this._controllers[i.uniqueId]||(this._xrSessionManager.scene.isPhysicsEnabled()||F.Warn("physics engine not enabled, skipped. Please add this controller manually."),this._options.physicsProperties.useControllerMesh&&i.inputSource.gamepad?i.onMotionControllerInitObservable.addOnce(r=>{r._doNotLoadControllerMesh?this._createPhysicsImpostor(i):r.onModelLoadedObservable.addOnce(()=>{let n=new He(r.rootMesh,He.MeshImpostor,ie({mass:0},this._options.physicsProperties)),o=i.grip||i.pointer;this._controllers[i.uniqueId]={xrController:i,impostor:n,oldPos:o.position.clone(),oldRotation:o.rotationQuaternion.clone()}})}):this._createPhysicsImpostor(i))},this._controllers={},this._debugMode=!1,this._delta=0,this._lastTimestamp=0,this._tmpQuaternion=new q,this._tmpVector=new p,this._options.physicsProperties||(this._options.physicsProperties={})}_enablePhysicsDebug(){this._debugMode=!0,Object.keys(this._controllers).forEach(e=>{let t=this._controllers[e];t.impostorMesh&&(t.impostorMesh.isVisible=!0)})}addController(e){this._attachController(e)}attach(){if(!super.attach())return!1;if(!this._options.xrInput)return!0;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._options.enableHeadsetImpostor){let e=this._options.headsetImpostorParams||{impostorType:He.SphereImpostor,restitution:.8,impostorSize:.3},t=e.impostorSize||.3;this._headsetMesh=pr("headset-mesh",{diameterX:typeof t=="number"?t:t.width,diameterY:typeof t=="number"?t:t.height,diameterZ:typeof t=="number"?t:t.depth}),this._headsetMesh.rotationQuaternion=new q,this._headsetMesh.isVisible=!1,this._headsetImpostor=new He(this._headsetMesh,e.impostorType,ie({mass:0},e))}return!0}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._headsetMesh&&this._headsetMesh.dispose(),!0):!1}getHeadsetImpostor(){return this._headsetImpostor}getImpostorForController(e){let t=typeof e=="string"?e:e.uniqueId;return this._controllers[t]?this._controllers[t].impostor:null}setPhysicsProperties(e){this._options.physicsProperties=ie(ie({},this._options.physicsProperties),e)}_onXRFrame(e){if(this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&this._headsetImpostor){if(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.globalPosition),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.absoluteRotation),this._options.xrInput.xrCamera._lastXRViewerPose?.linearVelocity){let t=this._options.xrInput.xrCamera._lastXRViewerPose.linearVelocity;this._tmpVector.set(t.x,t.y,t.z),this._headsetImpostor.setLinearVelocity(this._tmpVector)}if(this._options.xrInput.xrCamera._lastXRViewerPose?.angularVelocity){let t=this._options.xrInput.xrCamera._lastXRViewerPose.angularVelocity;this._tmpVector.set(t.x,t.y,t.z),this._headsetImpostor.setAngularVelocity(this._tmpVector)}}Object.keys(this._controllers).forEach(t=>{let i=this._controllers[t],r=i.xrController.grip||i.xrController.pointer,n=i.oldPos||i.impostorMesh.position;if(i.xrController._lastXRPose?.linearVelocity){let a=i.xrController._lastXRPose.linearVelocity;this._tmpVector.set(a.x,a.y,a.z),i.impostor.setLinearVelocity(this._tmpVector)}else r.position.subtractToRef(n,this._tmpVector),this._tmpVector.scaleInPlace(1e3/this._delta),i.impostor.setLinearVelocity(this._tmpVector);n.copyFrom(r.position),this._debugMode&&F.Log([this._tmpVector,"linear"]);let o=i.oldRotation||i.impostorMesh.rotationQuaternion;if(i.xrController._lastXRPose?.angularVelocity){let a=i.xrController._lastXRPose.angularVelocity;this._tmpVector.set(a.x,a.y,a.z),i.impostor.setAngularVelocity(this._tmpVector)}else if(!o.equalsWithEpsilon(r.rotationQuaternion)){o.conjugateInPlace().multiplyToRef(r.rotationQuaternion,this._tmpQuaternion);let a=Math.sqrt(this._tmpQuaternion.x*this._tmpQuaternion.x+this._tmpQuaternion.y*this._tmpQuaternion.y+this._tmpQuaternion.z*this._tmpQuaternion.z);if(this._tmpVector.set(this._tmpQuaternion.x,this._tmpQuaternion.y,this._tmpQuaternion.z),a<.001)this._tmpVector.scaleInPlace(2);else{let l=2*Math.atan2(a,this._tmpQuaternion.w);this._tmpVector.scaleInPlace(l/(a*(this._delta/1e3)))}i.impostor.setAngularVelocity(this._tmpVector)}o.copyFrom(r.rotationQuaternion),this._debugMode&&F.Log([this._tmpVector,this._tmpQuaternion,"angular"])})}_detachController(e){let t=this._controllers[e];t&&(t.impostorMesh&&t.impostorMesh.dispose(),delete this._controllers[e])}};Hh.Name=ct.PHYSICS_CONTROLLERS;Hh.Version=1;mt.AddWebXRFeature(Hh.Name,(s,e)=>()=>new Hh(s,e),Hh.Version,!0);var Xh=class extends Ct{constructor(e,t={}){super(e),this.options=t,this._tmpMat=new N,this._tmpPos=new p,this._tmpQuat=new q,this._initHitTestSource=i=>{if(!i)return;let r=new XRRay(this.options.offsetRay||{}),n={space:this.options.useReferenceSpace?i:this._xrSessionManager.viewerReferenceSpace,offsetRay:r};if(this.options.entityTypes&&(n.entityTypes=this.options.entityTypes),!n.space){H.Warn("waiting for viewer reference space to initialize");return}this._xrSessionManager.session.requestHitTestSource(n).then(o=>{this._xrHitTestSource&&this._xrHitTestSource.cancel(),this._xrHitTestSource=o})},this.autoCloneTransformation=!1,this.onHitTestResultObservable=new U,this.paused=!1,this.xrNativeFeatureName="hit-test",H.Warn("Hit test is an experimental and unstable feature.")}attach(){if(!super.attach()||!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this._initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this._initHitTestSource)),this.options.enableTransientHitTest){let e=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:this.options.transientHitTestProfile||"generic-touchscreen",offsetRay:e,entityTypes:this.options.entityTypes}).then(t=>{this._transientXrHitTestSource=t})}return!0}detach(){return super.detach()?(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this._initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0):!1}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!(!this.attached||this.paused)){if(this._xrHitTestSource){let t=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(t)}this._transientXrHitTestSource&&e.getHitTestResultsForTransientInput(this._transientXrHitTestSource).forEach(i=>{this._processWebXRHitTestResult(i.results,i.inputSource)})}}_processWebXRHitTestResult(e,t){let i=[];e.forEach(r=>{let n=r.getPose(this._xrSessionManager.referenceSpace);if(!n)return;let o=n.transform.position,a=n.transform.orientation;this._tmpPos.set(o.x,o.y,o.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._tmpQuat.set(a.x,a.y,a.z,a.w),N.FromFloat32ArrayToRefScaled(n.transform.matrix,0,1,this._tmpMat),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpPos.z*=-1,this._tmpQuat.z*=-1,this._tmpQuat.w*=-1,this._tmpMat.toggleModelMatrixHandInPlace());let l={position:this.autoCloneTransformation?this._tmpPos.clone():this._tmpPos,rotationQuaternion:this.autoCloneTransformation?this._tmpQuat.clone():this._tmpQuat,transformationMatrix:this.autoCloneTransformation?this._tmpMat.clone():this._tmpMat,inputSource:t,isTransient:!!t,xrHitResult:r};i.push(l)}),this.onHitTestResultObservable.notifyObservers(i)}};Xh.Name=ct.HIT_TEST;Xh.Version=2;mt.AddWebXRFeature(Xh.Name,(s,e)=>()=>new Xh(s,e),Xh.Version,!1);var Yh=class extends Ct{get featurePointCloud(){return this._featurePointCloud}constructor(e){super(e),this._enabled=!1,this._featurePointCloud=[],this.onFeaturePointsAddedObservable=new U,this.onFeaturePointsUpdatedObservable=new U,this.xrNativeFeatureName="bjsfeature-points",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){return super.detach()?(this.featurePointCloud.length=0,!0):!1}dispose(){super.dispose(),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;let t=e.featurePointCloud;if(!(!t||t.length===0)){if(t.length%5!==0)throw new Error("Received malformed feature point cloud of length: "+t.length);let i=t.length/5,r=[],n=[];for(let o=0;o<i;o++){let a=o*5,l=t[a+4];this._featurePointCloud[l]?r.push(l):(this._featurePointCloud[l]={position:new p,confidenceValue:0},n.push(l)),this._featurePointCloud[l].position.x=t[a],this._featurePointCloud[l].position.y=t[a+1],this._featurePointCloud[l].position.z=t[a+2],this._featurePointCloud[l].confidenceValue=t[a+3]}n.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(n),r.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(r)}}_init(){!this._xrSessionManager.session.trySetFeaturePointCloudEnabled||!this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)||(this._enabled=!0)}};Yh.Name=ct.FEATURE_POINTS;Yh.Version=1;mt.AddWebXRFeature(Yh.Name,s=>()=>new Yh(s),Yh.Version);var fZ=0,$h=class extends Ct{constructor(e,t={}){super(e),this._options=t,this._detectedMeshes=new Map,this.onMeshAddedObservable=new U,this.onMeshRemovedObservable=new U,this.onMeshUpdatedObservable=new U,this.xrNativeFeatureName="mesh-detection",this._options.generateMeshes&&(this._options.convertCoordinateSystems=!0),this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){return super.detach()?(this._xrSessionManager.isNative&&this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach(e=>{this.onMeshRemovedObservable.notifyObservers(e)}),this._detectedMeshes.clear()),!0):!1}dispose(){super.dispose(),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()}_onXRFrame(e){try{if(!this.attached||!e)return;let t=e.detectedMeshes||e.worldInformation?.detectedMeshes;if(t){let i=new Set;this._detectedMeshes.forEach((r,n)=>{t.has(n)||i.add(n)}),i.forEach(r=>{let n=this._detectedMeshes.get(r);n&&(this.onMeshRemovedObservable.notifyObservers(n),this._detectedMeshes.delete(r))}),t.forEach(r=>{if(this._detectedMeshes.has(r)){if(r.lastChangedTime===this._xrSessionManager.currentTimestamp){let n=this._detectedMeshes.get(r);n&&(this._updateVertexDataWithXRMesh(r,n,e),this.onMeshUpdatedObservable.notifyObservers(n))}}else{let n={id:fZ++,xrMesh:r},o=this._updateVertexDataWithXRMesh(r,n,e);this._detectedMeshes.set(r,o),this.onMeshAddedObservable.notifyObservers(o)}})}}catch(t){F.Log(t.stack)}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))}_updateVertexDataWithXRMesh(e,t,i){t.xrMesh=e,t.worldParentNode=this._options.worldParentNode;let r=e.vertices||e.positions;if(this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)t.positions=r,t.normals=e.normals;else{t.positions=new Float32Array(r.length);for(let o=0;o<r.length;o+=3)t.positions[o]=r[o],t.positions[o+1]=r[o+1],t.positions[o+2]=-1*r[o+2];if(e.normals){t.normals=new Float32Array(e.normals.length);for(let o=0;o<e.normals.length;o+=3)t.normals[o]=e.normals[o],t.normals[o+1]=e.normals[o+1],t.normals[o+2]=-1*e.normals[o+2]}}t.indices=e.indices;let n=i.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(n){let o=t.transformationMatrix||new N;N.FromArrayToRef(n.transform.matrix,0,o),this._xrSessionManager.scene.useRightHandedSystem||o.toggleModelMatrixHandInPlace(),t.transformationMatrix=o,this._options.worldParentNode&&o.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),o)}if(this._options.generateMeshes){if(t.mesh){let o=t.mesh;o.updateVerticesData(y.PositionKind,t.positions),t.normals?o.updateVerticesData(y.NormalKind,t.normals):o.createNormals(!0),o.updateIndices(t.indices)}else{let o=new k("xr mesh "+t.id,this._xrSessionManager.scene);o.rotationQuaternion=new q,o.setVerticesData(y.PositionKind,t.positions),t.normals?o.setVerticesData(y.NormalKind,t.normals):o.createNormals(!0),o.setIndices(t.indices,void 0,!0),t.mesh=o}t.transformationMatrix?.decompose(t.mesh.scaling,t.mesh.rotationQuaternion,t.mesh.position)}}return t}};$h.Name=ct.MESH_DETECTION;$h.Version=1;mt.AddWebXRFeature($h.Name,(s,e)=>()=>new $h(s,e),$h.Version,!1);var _l=function(s){return s[s.NotReceived=0]="NotReceived",s[s.Waiting=1]="Waiting",s[s.Received=2]="Received",s}(_l||{}),jh=class extends Ct{constructor(e,t){super(e),this.options=t,this.onUntrackableImageFoundObservable=new U,this.onTrackableImageFoundObservable=new U,this.onTrackedImageUpdatedObservable=new U,this._trackableScoreStatus=_l.NotReceived,this._trackedImages=[],this.xrNativeFeatureName="image-tracking"}attach(){return super.attach()}detach(){return super.detach()}getTrackedImageById(e){return this._trackedImages[e]||null}dispose(){super.dispose(),this._trackedImages.forEach(e=>{e.originalBitmap.close()}),this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()}getXRSessionInitExtension(){return $e(this,null,function*(){if(!this.options.images||!this.options.images.length)return{};let e=this.options.images.map(t=>typeof t.src=="string"?this._xrSessionManager.scene.getEngine()._createImageBitmapFromSource(t.src):Promise.resolve(t.src));try{let t=yield Promise.all(e);return this._originalTrackingRequest=t.map((i,r)=>({image:i,widthInMeters:this.options.images[r].estimatedRealWorldWidth})),{trackedImages:this._originalTrackingRequest}}catch{return H.Error("Error loading images for tracking, WebXRImageTracking disabled for this session."),{}}})}_onXRFrame(e){if(!e.getImageTrackingResults||this._trackableScoreStatus===_l.Waiting)return;if(this._trackableScoreStatus===_l.NotReceived){this._checkScoresAsync();return}let t=e.getImageTrackingResults();for(let i of t){let r=!1,n=i.index,o=this._trackedImages[n];if(!o)continue;o.xrTrackingResult=i,o.realWorldWidth!==i.measuredWidthInMeters&&(o.realWorldWidth=i.measuredWidthInMeters,r=!0);let a=e.getPose(i.imageSpace,this._xrSessionManager.referenceSpace);if(a){let h=o.transformationMatrix;N.FromArrayToRef(a.transform.matrix,0,h),this._xrSessionManager.scene.useRightHandedSystem||h.toggleModelMatrixHandInPlace(),r=!0}let c=i.trackingState==="emulated";o.emulated!==c&&(o.emulated=c,r=!0),r&&this.onTrackedImageUpdatedObservable.notifyObservers(o)}}_checkScoresAsync(){return $e(this,null,function*(){if(!this._xrSessionManager.session.getTrackedImageScores||this._trackableScoreStatus!==_l.NotReceived)return;this._trackableScoreStatus=_l.Waiting;let e=yield this._xrSessionManager.session.getTrackedImageScores();if(!e||e.length===0){this._trackableScoreStatus=_l.NotReceived;return}for(let t=0;t<e.length;++t)if(e[t]=="untrackable")this.onUntrackableImageFoundObservable.notifyObservers(t);else{let i=this._originalTrackingRequest[t].image,r={id:t,originalBitmap:i,transformationMatrix:new N,ratio:i.width/i.height};this._trackedImages[t]=r,this.onTrackableImageFoundObservable.notifyObservers(r)}this._trackableScoreStatus=e.length>0?_l.Received:_l.NotReceived})}};jh.Name=ct.IMAGE_TRACKING;jh.Version=1;mt.AddWebXRFeature(jh.Name,(s,e)=>()=>new jh(s,e),jh.Version,!1);var qh=class extends Ct{constructor(e,t){super(e),this.options=t,this._domOverlayType=null,this._beforeXRSelectListener=null,this._element=null,this.xrNativeFeatureName="dom-overlay",H.Warn("dom-overlay is an experimental and unstable feature.")}attach(){return!super.attach()||!this._xrSessionManager.session.domOverlayState||this._xrSessionManager.session.domOverlayState.type===null?!1:(this._domOverlayType=this._xrSessionManager.session.domOverlayState.type,this._element!==null&&this.options.supressXRSelectEvents===!0&&(this._beforeXRSelectListener=e=>{e.preventDefault()},this._element.addEventListener("beforexrselect",this._beforeXRSelectListener)),!0)}get domOverlayType(){return this._domOverlayType}dispose(){super.dispose(),this._element!==null&&this._beforeXRSelectListener&&this._element.removeEventListener("beforexrselect",this._beforeXRSelectListener)}_onXRFrame(e){}getXRSessionInitExtension(){return $e(this,null,function*(){if(this.options.element===void 0)return H.Warn('"element" option must be provided to attach xr-dom-overlay feature.'),{};if(typeof this.options.element=="string"){let e=document.querySelector(this.options.element);if(e===null)return H.Warn(`element not found '${this.options.element}' (not requesting xr-dom-overlay)`),{};this._element=e}else this._element=this.options.element;return{domOverlay:{root:this._element}}})}};qh.Name=ct.DOM_OVERLAY;qh.Version=1;mt.AddWebXRFeature(qh.Name,(s,e)=>()=>new qh(s,e),qh.Version,!1);var pc=class s extends Ct{get movementDirection(){return this._movementDirection}get movementEnabled(){return this._featureContext.movementEnabled}set movementEnabled(e){this._featureContext.movementEnabled=e}get movementOrientationFollowsViewerPose(){return this._featureContext.movementOrientationFollowsViewerPose}set movementOrientationFollowsViewerPose(e){this._featureContext.movementOrientationFollowsViewerPose=e}get movementSpeed(){return this._featureContext.movementSpeed}set movementSpeed(e){this._featureContext.movementSpeed=e}get movementThreshold(){return this._featureContext.movementThreshold}set movementThreshold(e){this._featureContext.movementThreshold=e}get rotationEnabled(){return this._featureContext.rotationEnabled}set rotationEnabled(e){this._featureContext.rotationEnabled=e}get rotationSpeed(){return this._featureContext.rotationSpeed}set rotationSpeed(e){this._featureContext.rotationSpeed=e}get rotationThreshold(){return this._featureContext.rotationThreshold}set rotationThreshold(e){this._featureContext.rotationThreshold=e}constructor(e,t){if(super(e),this._controllers={},this._currentRegistrationConfigurations=[],this._movementDirection=new q,this._tmpRotationMatrix=N.Identity(),this._tmpTranslationDirection=new p,this._tmpMovementTranslation=new p,this._tempCacheQuaternion=new q,this._attachController=i=>{if(this._controllers[i.uniqueId])return;this._controllers[i.uniqueId]={xrController:i,registeredComponents:[]};let r=this._controllers[i.uniqueId];if(r.xrController.inputSource.targetRayMode==="tracked-pointer"&&r.xrController.inputSource.gamepad){let n=()=>{if(i.motionController)for(let o of this._currentRegistrationConfigurations){let a=null;if(o.allowedComponentTypes)for(let c of o.allowedComponentTypes){let h=i.motionController.getComponentOfType(c);if(h!==null){a=h;break}}if(o.mainComponentOnly){let c=i.motionController.getMainComponent();if(c===null)continue;a=c}if(typeof o.componentSelectionPredicate=="function"&&(a=o.componentSelectionPredicate(i)),a&&o.forceHandedness&&i.inputSource.handedness!==o.forceHandedness||a===null)continue;let l={registrationConfiguration:o,component:a};r.registeredComponents.push(l),"axisChangedHandler"in o&&(l.onAxisChangedObserver=a.onAxisValueChangedObservable.add(c=>{o.axisChangedHandler(c,this._movementState,this._featureContext,this._xrInput)})),"buttonChangedHandler"in o&&(l.onButtonChangedObserver=a.onButtonStateChangedObservable.add(c=>{c.changes.pressed&&o.buttonChangedHandler(c.changes.pressed,this._movementState,this._featureContext,this._xrInput)}))}};i.motionController?n():i.onMotionControllerInitObservable.addOnce(()=>{n()})}},!t||t.xrInput===void 0){H.Error('WebXRControllerMovement feature requires "xrInput" option.');return}Array.isArray(t.customRegistrationConfigurations)?this._currentRegistrationConfigurations=t.customRegistrationConfigurations:this._currentRegistrationConfigurations=s.REGISTRATIONS.default,this._featureContext={movementEnabled:t.movementEnabled||!0,movementOrientationFollowsViewerPose:t.movementOrientationFollowsViewerPose??!0,movementOrientationFollowsController:t.movementOrientationFollowsController??!1,orientationPreferredHandedness:t.orientationPreferredHandedness,movementSpeed:t.movementSpeed??1,movementThreshold:t.movementThreshold??.25,rotationEnabled:t.rotationEnabled??!0,rotationSpeed:t.rotationSpeed??1,rotationThreshold:t.rotationThreshold??.25},this._movementState={moveX:0,moveY:0,rotateX:0,rotateY:0},this._xrInput=t.xrInput}attach(){return super.attach()?(this._xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._controllers={},!0):!1}_onXRFrame(e){if(this.attached){if(this._movementState.rotateX!==0&&this._featureContext.rotationEnabled){let i=this._xrSessionManager.scene.getEngine().getDeltaTime()*.001*this._featureContext.rotationSpeed*this._movementState.rotateX*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);if(this._featureContext.movementOrientationFollowsViewerPose)this._xrInput.xrCamera.cameraRotation.y+=i,q.RotationYawPitchRollToRef(i,0,0,this._tempCacheQuaternion),this._xrInput.xrCamera.rotationQuaternion.multiplyToRef(this._tempCacheQuaternion,this._movementDirection);else if(this._featureContext.movementOrientationFollowsController){this._xrInput.xrCamera.cameraRotation.y+=i;let r=this._featureContext.orientationPreferredHandedness||"right",n=Object.keys(this._controllers).find(a=>this._controllers[a]?.xrController?.inputSource.handedness===r)||Object.keys(this._controllers)[0],o=this._controllers[n];q.RotationYawPitchRollToRef(i,0,0,this._tempCacheQuaternion),(o?.xrController.pointer.rotationQuaternion||q.Identity()).multiplyToRef(this._tempCacheQuaternion,this._movementDirection)}else q.RotationYawPitchRollToRef(i*3,0,0,this._tempCacheQuaternion),this._movementDirection.multiplyInPlace(this._tempCacheQuaternion)}else if(this._featureContext.movementOrientationFollowsViewerPose)this._movementDirection.copyFrom(this._xrInput.xrCamera.rotationQuaternion);else if(this._featureContext.movementOrientationFollowsController){let t=this._featureContext.orientationPreferredHandedness||"right",i=Object.keys(this._controllers).find(n=>this._controllers[n]?.xrController.inputSource.handedness===t)||Object.keys(this._controllers)[0],r=this._controllers[i];this._movementDirection.copyFrom(r?.xrController.pointer.rotationQuaternion||q.Identity())}(this._movementState.moveX||this._movementState.moveY)&&this._featureContext.movementEnabled&&(N.FromQuaternionToRef(this._movementDirection,this._tmpRotationMatrix),this._tmpTranslationDirection.set(this._movementState.moveX,0,this._movementState.moveY*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),p.TransformCoordinatesToRef(this._tmpTranslationDirection,this._tmpRotationMatrix,this._tmpMovementTranslation),this._tmpMovementTranslation.scaleInPlace(this._xrInput.xrCamera._computeLocalCameraSpeed()*this._featureContext.movementSpeed),this._xrInput.xrCamera.cameraDirection.addInPlace(this._tmpMovementTranslation))}}_detachController(e){let t=this._controllers[e];if(t){for(let i of t.registeredComponents)i.onAxisChangedObserver&&i.component.onAxisValueChangedObservable.remove(i.onAxisChangedObserver),i.onButtonChangedObserver&&i.component.onButtonStateChangedObservable.remove(i.onButtonChangedObserver);delete this._controllers[e]}}};pc.Name=ct.MOVEMENT;pc.REGISTRATIONS={default:[{allowedComponentTypes:[yn.THUMBSTICK_TYPE,yn.TOUCHPAD_TYPE],forceHandedness:"left",axisChangedHandler:(s,e,t)=>{e.rotateX=Math.abs(s.x)>t.rotationThreshold?s.x:0,e.rotateY=Math.abs(s.y)>t.rotationThreshold?s.y:0}},{allowedComponentTypes:[yn.THUMBSTICK_TYPE,yn.TOUCHPAD_TYPE],forceHandedness:"right",axisChangedHandler:(s,e,t)=>{e.moveX=Math.abs(s.x)>t.movementThreshold?s.x:0,e.moveY=Math.abs(s.y)>t.movementThreshold?s.y:0}}]};pc.Version=1;mt.AddWebXRFeature(pc.Name,(s,e)=>()=>new pc(s,e),pc.Version,!0);var Qh=class extends Ct{constructor(e,t){super(e),this.options=t,this._canvasContext=null,this._reflectionCubeMap=null,this._xrLightEstimate=null,this._xrLightProbe=null,this._xrWebGLBinding=null,this._lightDirection=p.Up().negateInPlace(),this._lightColor=X.White(),this._intensity=1,this._sphericalHarmonics=new tl,this._cubeMapPollTime=Date.now(),this._lightEstimationPollTime=Date.now(),this._reflectionCubeMapTextureSize=16,this.directionalLight=null,this.onReflectionCubeMapUpdatedObservable=new U,this._updateReflectionCubeMap=()=>{if(!this._xrLightProbe)return;if(this.options.cubeMapPollInterval){let r=Date.now();if(r-this._cubeMapPollTime<this.options.cubeMapPollInterval)return;this._cubeMapPollTime=r}let i=this._getXRGLBinding().getReflectionCubeMap(this._xrLightProbe);if(i&&this._reflectionCubeMap){if(this._reflectionCubeMap._texture)this._reflectionCubeMap._texture._hardwareTexture?.set(i),this._reflectionCubeMap._texture.getEngine().resetTextureCache();else{let r=new Je(this._xrSessionManager.scene.getEngine(),ke.Unknown);r.isCube=!0,r.invertY=!1,r._useSRGBBuffer=this.options.reflectionFormat==="srgba8",r.format=5,r.generateMipMaps=!0,r.type=this.options.reflectionFormat!=="srgba8"?2:0,r.samplingMode=3,r.width=this._reflectionCubeMapTextureSize,r.height=this._reflectionCubeMapTextureSize,r._cachedWrapU=1,r._cachedWrapV=1,r._hardwareTexture=new Ho(i,this._getCanvasContext()),this._reflectionCubeMap._texture=r}this._reflectionCubeMap._texture.isReady=!0,this.options.disablePreFiltering?(this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap)):(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._hdrFilter.prefilter(this._reflectionCubeMap).then(()=>{this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap)}))}},this.xrNativeFeatureName="light-estimation",this.options.createDirectionalLightSource&&(this.directionalLight=new Cr("light estimation directional",this._lightDirection,this._xrSessionManager.scene),this.directionalLight.position=new p(0,8,0),this.directionalLight.intensity=0,this.directionalLight.falloffType=xr.FALLOFF_GLTF),this._hdrFilter=new zd(this._xrSessionManager.scene.getEngine()),H.Warn("light-estimation is an experimental and unstable feature.")}get reflectionCubeMapTexture(){return this._reflectionCubeMap}get xrLightingEstimate(){return this._xrLightEstimate?{lightColor:this._lightColor,lightDirection:this._lightDirection,lightIntensity:this._intensity,sphericalHarmonics:this._sphericalHarmonics}:this._xrLightEstimate}_getCanvasContext(){return this._canvasContext===null&&(this._canvasContext=this._xrSessionManager.scene.getEngine()._gl),this._canvasContext}_getXRGLBinding(){if(this._xrWebGLBinding===null){let e=this._getCanvasContext();this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,e)}return this._xrWebGLBinding}attach(){if(!super.attach())return!1;let e=this.options.reflectionFormat??(this._xrSessionManager.session.preferredReflectionFormat||"srgba8");return this.options.reflectionFormat=e,this._xrSessionManager.session.requestLightProbe({reflectionFormat:e}).then(t=>{this._xrLightProbe=t,this.options.disableCubeMapReflection||(this._reflectionCubeMap||(this._reflectionCubeMap=new Qi(this._xrSessionManager.scene),this._reflectionCubeMap._isCube=!0,this._reflectionCubeMap.coordinatesMode=3,this.options.setSceneEnvironmentTexture&&(this._xrSessionManager.scene.environmentTexture=this._reflectionCubeMap)),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap))}),!0}detach(){let e=super.detach();return this._xrLightProbe!==null&&!this.options.disableCubeMapReflection&&(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._xrLightProbe=null),this._canvasContext=null,this._xrLightEstimate=null,this._xrWebGLBinding=null,e}dispose(){super.dispose(),this.onReflectionCubeMapUpdatedObservable.clear(),this.directionalLight&&(this.directionalLight.dispose(),this.directionalLight=null),this._reflectionCubeMap!==null&&(this._reflectionCubeMap._texture&&this._reflectionCubeMap._texture.dispose(),this._reflectionCubeMap.dispose(),this._reflectionCubeMap=null)}_onXRFrame(e){if(this._xrLightProbe!==null){if(this.options.lightEstimationPollInterval){let t=Date.now();if(t-this._lightEstimationPollTime<this.options.lightEstimationPollInterval)return;this._lightEstimationPollTime=t}if(this._xrLightEstimate=e.getLightEstimate(this._xrLightProbe),this._xrLightEstimate){this._intensity=Math.max(1,this._xrLightEstimate.primaryLightIntensity.x,this._xrLightEstimate.primaryLightIntensity.y,this._xrLightEstimate.primaryLightIntensity.z);let t=this._xrSessionManager.scene.useRightHandedSystem?1:-1;this.options.disableVectorReuse&&(this._lightDirection=new p,this._lightColor=new X,this.directionalLight&&(this.directionalLight.direction=this._lightDirection,this.directionalLight.diffuse=this._lightColor)),this._lightDirection.copyFromFloats(this._xrLightEstimate.primaryLightDirection.x,this._xrLightEstimate.primaryLightDirection.y,this._xrLightEstimate.primaryLightDirection.z*t),this._lightColor.copyFromFloats(this._xrLightEstimate.primaryLightIntensity.x/this._intensity,this._xrLightEstimate.primaryLightIntensity.y/this._intensity,this._xrLightEstimate.primaryLightIntensity.z/this._intensity),this._sphericalHarmonics.updateFromFloatsArray(this._xrLightEstimate.sphericalHarmonicsCoefficients),this._reflectionCubeMap&&!this.options.disableSphericalPolynomial&&(this._reflectionCubeMap.sphericalPolynomial=this._reflectionCubeMap.sphericalPolynomial||new vs,this._reflectionCubeMap.sphericalPolynomial?.updateFromHarmonics(this._sphericalHarmonics)),this._lightDirection.negateInPlace(),this.directionalLight&&(this.directionalLight.direction.copyFrom(this._lightDirection),this.directionalLight.intensity=Math.min(this._intensity,1),this.directionalLight.diffuse.copyFrom(this._lightColor))}}}};Qh.Name=ct.LIGHT_ESTIMATION;Qh.Version=1;mt.AddWebXRFeature(Qh.Name,(s,e)=>()=>new Qh(s,e),Qh.Version,!1);var Kh=class extends Ct{constructor(e){super(e),this.onEyeTrackingStartedObservable=new U,this.onEyeTrackingEndedObservable=new U,this.onEyeTrackingFrameUpdateObservable=new U,this._eyeTrackingStartListener=t=>{this._latestEyeSpace=t.gazeSpace,this._gazeRay=new pt(p.Zero(),p.Forward()),this.onEyeTrackingStartedObservable.notifyObservers(this._gazeRay)},this._eyeTrackingEndListener=()=>{this._latestEyeSpace=null,this._gazeRay=null,this.onEyeTrackingEndedObservable.notifyObservers()},this.xrNativeFeatureName="eye-tracking",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}dispose(){super.dispose(),this._xrSessionManager.session.removeEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.removeEventListener("eyetrackingend",this._eyeTrackingEndListener),this.onEyeTrackingStartedObservable.clear(),this.onEyeTrackingEndedObservable.clear(),this.onEyeTrackingFrameUpdateObservable.clear()}get isEyeGazeValid(){return!!this._gazeRay}getEyeGaze(){return this._gazeRay}_onXRFrame(e){if(!(!this.attached||!e)&&this._latestEyeSpace&&this._gazeRay){let t=e.getPose(this._latestEyeSpace,this._xrSessionManager.referenceSpace);if(t){this._gazeRay.origin.set(t.transform.position.x,t.transform.position.y,t.transform.position.z).scaleInPlace(this._xrSessionManager.worldScalingFactor);let i=t.transform.orientation;O.Quaternion[0].set(i.x,i.y,i.z,i.w),this._xrSessionManager.scene.useRightHandedSystem?p.RightHandedForwardReadOnly.rotateByQuaternionToRef(O.Quaternion[0],this._gazeRay.direction):(this._gazeRay.origin.z*=-1,O.Quaternion[0].z*=-1,O.Quaternion[0].w*=-1,p.LeftHandedForwardReadOnly.rotateByQuaternionToRef(O.Quaternion[0],this._gazeRay.direction)),this.onEyeTrackingFrameUpdateObservable.notifyObservers(this._gazeRay)}}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.addEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.addEventListener("eyetrackingend",this._eyeTrackingEndListener))}};Kh.Name=ct.EYE_TRACKING;Kh.Version=1;mt.AddWebXRFeature(Kh.Name,s=>()=>new Kh(s),Kh.Version,!1);var SM=class{constructor(e,t){this._samples=[],this._idx=0;for(let i=0;i<e;++i)this._samples.push(t?t():j.Zero())}get length(){return this._samples.length}push(e,t){this._idx=(this._idx+this._samples.length-1)%this._samples.length,this.at(0).copyFromFloats(e,t)}at(e){if(e>=this._samples.length)throw new Error("Index out of bounds");return this._samples[(this._idx+e)%this._samples.length]}},yM=class{constructor(){this._samples=new SM(20),this._entropy=0,this.onFirstStepDetected=new U}update(e,t,i,r){this._samples.push(e,t);let n=this._samples.at(0);if(this._entropy*=this._entropyDecayFactor,this._entropy+=j.Distance(n,this._samples.at(1)),this._entropy>this._entropyThreshold)return;let o;for(o=this._samePointCheckStartIdx;o<this._samples.length&&!(j.DistanceSquared(n,this._samples.at(o))<this._samePointSquaredDistanceThreshold);++o);if(o===this._samples.length)return;let a=-1,l=0;for(let R,E=1;E<o;++E)R=j.DistanceSquared(n,this._samples.at(E)),R>a&&(l=E,a=R);if(a<this._apexSquaredDistanceThreshold)return;let c=this._samples.at(l),h=c.subtract(n);h.normalize();let u=O.Vector2[0],d,f,m=0;for(let R=1;R<o;++R)f=this._samples.at(R),f.subtractToRef(n,u),d=j.Dot(h,u),m+=u.lengthSquared()-d*d;if(m>o*this._squaredProjectionDistanceThreshold)return;let g=O.Vector3[0];g.set(i,r,0);let _=O.Vector3[1];_.set(h.x,h.y,0);let x=p.Cross(g,_).z>0,b=n.clone(),C=n.clone();c.subtractToRef(n,h),x?(h.scaleAndAddToRef(this._axisToApexShrinkFactor,b),h.scaleAndAddToRef(this._axisToApexExtendFactor,C)):(h.scaleAndAddToRef(this._axisToApexExtendFactor,b),h.scaleAndAddToRef(this._axisToApexShrinkFactor,C)),this.onFirstStepDetected.notifyObservers({leftApex:b,rightApex:C,currentPosition:n,currentStepDirection:x?"right":"left"})}reset(){for(let e=0;e<this._samples.length;++e)this._samples.at(e).copyFromFloats(0,0)}get _samePointCheckStartIdx(){return Math.floor(this._samples.length/3)}get _samePointSquaredDistanceThreshold(){return .03*.03}get _apexSquaredDistanceThreshold(){return .09*.09}get _squaredProjectionDistanceThreshold(){return .03*.03}get _axisToApexShrinkFactor(){return .8}get _axisToApexExtendFactor(){return-1.6}get _entropyDecayFactor(){return .93}get _entropyThreshold(){return .4}},EM=class{constructor(e,t,i,r){this._leftApex=new j,this._rightApex=new j,this._currentPosition=new j,this._axis=new j,this._axisLength=-1,this._forward=new j,this._steppingLeft=!1,this._t=-1,this._maxT=-1,this._maxTPosition=new j,this._vitality=0,this.onMovement=new U,this.onFootfall=new U,this._reset(e,t,i,r==="left")}_reset(e,t,i,r){this._leftApex.copyFrom(e),this._rightApex.copyFrom(t),this._steppingLeft=r,this._steppingLeft?(this._leftApex.subtractToRef(this._rightApex,this._axis),this._forward.copyFromFloats(-this._axis.y,this._axis.x)):(this._rightApex.subtractToRef(this._leftApex,this._axis),this._forward.copyFromFloats(this._axis.y,-this._axis.x)),this._axisLength=this._axis.length(),this._forward.scaleInPlace(1/this._axisLength),this._updateTAndVitality(i.x,i.y),this._maxT=this._t,this._maxTPosition.copyFrom(i),this._vitality=1}_updateTAndVitality(e,t){this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._currentPosition.subtractInPlace(this._rightApex):this._currentPosition.subtractInPlace(this._leftApex);let i=this._t,r=j.Dot(this._currentPosition,this._axis);this._t=r/(this._axisLength*this._axisLength);let n=this._currentPosition.lengthSquared()-r/this._axisLength*(r/this._axisLength);this._vitality*=.92-100*Math.max(n-.0016,0)+Math.max(this._t-i,0)}update(e,t){if(this._vitality<this._vitalityThreshold)return!1;let i=this._t;return this._updateTAndVitality(e,t),this._t>this._maxT&&(this._maxT=this._t,this._maxTPosition.copyFromFloats(e,t)),!(this._vitality<this._vitalityThreshold||(this._t>i&&(this.onMovement.notifyObservers({deltaT:this._t-i}),i<.5&&this._t>=.5&&this.onFootfall.notifyObservers({foot:this._steppingLeft?"left":"right"})),this._t<.95*this._maxT&&(this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._leftApex.copyFrom(this._maxTPosition):this._rightApex.copyFrom(this._maxTPosition),this._reset(this._leftApex,this._rightApex,this._currentPosition,!this._steppingLeft)),this._axisLength<.03))}get _vitalityThreshold(){return .1}get forward(){return this._forward}},AM=class s{static get _MillisecondsPerUpdate(){return 1e3/15}constructor(e){this._detector=new yM,this._walker=null,this._movement=new j,this._millisecondsSinceLastUpdate=s._MillisecondsPerUpdate,this.movementThisFrame=p.Zero(),this._engine=e,this._detector.onFirstStepDetected.add(t=>{this._walker||(this._walker=new EM(t.leftApex,t.rightApex,t.currentPosition,t.currentStepDirection),this._walker.onFootfall.add(()=>{F.Log("Footfall!")}),this._walker.onMovement.add(i=>{this._walker.forward.scaleAndAddToRef(.024*i.deltaT,this._movement)}))})}update(e,t){t.y=0,t.normalize(),this._millisecondsSinceLastUpdate+=this._engine.getDeltaTime(),this._millisecondsSinceLastUpdate>=s._MillisecondsPerUpdate&&(this._millisecondsSinceLastUpdate-=s._MillisecondsPerUpdate,this._detector.update(e.x,e.z,t.x,t.z),this._walker&&(this._walker.update(e.x,e.z)||(this._walker=null)),this._movement.scaleInPlace(.85)),this.movementThisFrame.set(this._movement.x,0,this._movement.y)}},lg=class extends Ct{static get Name(){return ct.WALKING_LOCOMOTION}static get Version(){return 1}get locomotionTarget(){return this._locomotionTarget}set locomotionTarget(e){this._locomotionTarget=e,this._isLocomotionTargetWebXRCamera=this._locomotionTarget.getClassName()==="WebXRCamera"}constructor(e,t){super(e),this._up=new p,this._forward=new p,this._position=new p,this._movement=new p,this._sessionManager=e,this.locomotionTarget=t.locomotionTarget,this._isLocomotionTargetWebXRCamera&&F.Warn("Using walking locomotion directly on a WebXRCamera may have unintended interactions with other XR techniques. Using an XR space parent is highly recommended")}isCompatible(){return this._sessionManager.sessionMode===void 0||this._sessionManager.sessionMode==="immersive-vr"}attach(){return!this.isCompatible||!super.attach()?!1:(this._walker=new AM(this._sessionManager.scene.getEngine()),!0)}detach(){return super.detach()?(this._walker=null,!0):!1}_onXRFrame(e){let t=e.getViewerPose(this._sessionManager.baseReferenceSpace);if(!t)return;let i=this.locomotionTarget.getScene().useRightHandedSystem?1:-1,r=t.transform.matrix;this._up.copyFromFloats(r[4],r[5],i*r[6]),this._forward.copyFromFloats(r[8],r[9],i*r[10]),this._position.copyFromFloats(r[12],r[13],i*r[14]),this._forward.scaleAndAddToRef(.05,this._position),this._up.scaleAndAddToRef(-.05,this._position),this._walker.update(this._position,this._forward),this._movement.copyFrom(this._walker.movementThisFrame),this._isLocomotionTargetWebXRCamera||p.TransformNormalToRef(this._movement,this.locomotionTarget.getWorldMatrix(),this._movement),this.locomotionTarget.position.addInPlace(this._movement)}};mt.AddWebXRFeature(lg.Name,(s,e)=>()=>new lg(s,e),lg.Version,!1);var bf=class extends Xl{constructor(e,t,i,r,n,o,a=null){super(e,t,i,r,o),this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this.isMultiview=n,this.createRTTProvider=o,this._originalInternalTexture=a}},Sf=class extends Yl{constructor(e,t,i){super(e.scene,i),this._xrSessionManager=e,this._xrWebGLBinding=t,this.layerWrapper=i,this._lastSubImages=new Map,this.onRenderTargetTextureCreatedObservable=new U,this._compositionLayer=i.layer}_getRenderTargetForSubImage(e,t="none"){let i=this._lastSubImages.get(t),r=t=="right"?1:0,n=e.colorTextureWidth??e.textureWidth,o=e.colorTextureHeight??e.textureHeight;if(!this._renderTargetTextures[r]||i?.textureWidth!==n||i?.textureHeight!==o){let a,l=e.depthStencilTextureWidth??n,c=e.depthStencilTextureHeight??o;(n===l||o===c)&&(a=e.depthStencilTexture),this._renderTargetTextures[r]=this._createRenderTargetTexture(n,o,null,e.colorTexture,a,this.layerWrapper.isMultiview),this._framebufferDimensions={framebufferWidth:n,framebufferHeight:o},this.onRenderTargetTextureCreatedObservable.notifyObservers({texture:this._renderTargetTextures[r],eye:t})}return this._lastSubImages.set(t,e),this._renderTargetTextures[r]}_getSubImageForEye(e){let t=this._xrSessionManager.currentFrame;return t?this._xrWebGLBinding.getSubImage(this._compositionLayer,t,e):null}getRenderTargetTextureForEye(e){let t=this._getSubImageForEye(e);return t?this._getRenderTargetForSubImage(t,e):null}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e?.eye)}_setViewportForSubImage(e,t){let i=t.colorTextureWidth??t.textureWidth,r=t.colorTextureHeight??t.textureHeight,n=t.viewport;e.x=n.x/i,e.y=n.y/r,e.width=n.width/i,e.height=n.height/r}trySetViewportForView(e,t){let i=this._lastSubImages.get(t.eye)||this._getSubImageForEye(t.eye);return i?(this._setViewportForSubImage(e,i),!0):!1}};var lb=class extends bf{constructor(e,t,i){super(()=>e.textureWidth,()=>e.textureHeight,e,"XRProjectionLayer",t,r=>new IM(r,i,this)),this.layer=e}},IM=class extends Sf{constructor(e,t,i){super(e,t,i),this.layerWrapper=i,this._projectionLayer=i.layer}_getSubImageForView(e){return this._xrWebGLBinding.getViewSubImage(this._projectionLayer,e)}getRenderTargetTextureForView(e){return this._getRenderTargetForSubImage(this._getSubImageForView(e),e.eye)}getRenderTargetTextureForEye(e){let t=this._lastSubImages.get(e);return t?this._getRenderTargetForSubImage(t,e):null}trySetViewportForView(e,t){let i=this._lastSubImages.get(t.eye)||this._getSubImageForView(t);return i?(this._setViewportForSubImage(e,i),!0):!1}},RM={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1,clearOnAccess:!1};var pZ={},Zh=class extends Ct{constructor(e,t={}){super(e),this._options=t,this._existingLayers=[],this._isMultiviewEnabled=!1,this._projectionLayerInitialized=!1,this._compositionLayerTextureMapping=new WeakMap,this._layerToRTTProviderMapping=new WeakMap,this.xrNativeFeatureName="layers"}attach(){if(!super.attach())return!1;let e=this._xrSessionManager.scene.getEngine();this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this._existingLayers.length=0;let t=ie(ie({},RM),this._options.projectionLayerInit);return this._isMultiviewEnabled=this._options.preferMultiviewOnInit&&e.getCaps().multiview,this.createProjectionLayer(t),this._projectionLayerInitialized=!0,!0}detach(){return super.detach()?(this._existingLayers.forEach(e=>{e.dispose()}),this._existingLayers.length=0,this._projectionLayerInitialized=!1,!0):!1}createXRWebGLLayer(e=pZ){let t=new XRWebGLLayer(this._xrSessionManager.session,this._glContext,e);return new $l(t)}_validateLayerInit(e,t=this._isMultiviewEnabled){if(!this._xrSessionManager.inXRSession)throw new Error("Cannot create a layer outside of a WebXR session. Make sure the session has started before creating layers.");if(t&&e.textureType!=="texture-array")throw new Error("Projection layers can only be made multiview if they use texture arrays. Set the textureType parameter to 'texture-array'.");if(!t&&e.textureType==="texture-array")throw new Error("We currently only support multiview rendering when the textureType parameter is set to 'texture-array'.")}_extendXRLayerInit(e,t=this._isMultiviewEnabled){return t&&(e.textureType="texture-array"),e}createProjectionLayer(e=RM,t=this._isMultiviewEnabled){this._extendXRLayerInit(e,t),this._validateLayerInit(e,t);let i=this._xrWebGLBinding.createProjectionLayer(e),r=new lb(i,t,this._xrWebGLBinding);return this.addXRSessionLayer(r),r}_createQuadLayer(e={params:{}},t){this._extendXRLayerInit(e.params,!1);let i=this._existingLayers[0].layer.textureWidth,r=this._existingLayers[0].layer.textureHeight,n=ie({space:this._xrSessionManager.referenceSpace,viewPixelWidth:i,viewPixelHeight:r,clearOnAccess:!0},e.params);this._validateLayerInit(n,!1);let o=this._xrWebGLBinding.createQuadLayer(n);o.width=this._isMultiviewEnabled?1:2,o.height=1;let a=new bf(()=>o.width,()=>o.height,o,"XRQuadLayer",!1,c=>new Sf(c,this._xrWebGLBinding,a));t&&this._compositionLayerTextureMapping.set(o,t);let l=a.createRenderTargetTextureProvider(this._xrSessionManager);return this._layerToRTTProviderMapping.set(o,l),this.addXRSessionLayer(a),a}addFullscreenAdvancedDynamicTexture(e,t={distanceFromHeadset:1.5}){let i=this._createQuadLayer({params:{space:this._xrSessionManager.viewerReferenceSpace,textureType:"texture",layout:"mono"}},e),r=i.layer,o={x:0,y:0,z:-Math.max(.1,t.distanceFromHeadset)},a={x:0,y:0,z:0,w:1};r.transform=new XRRigidTransform(o,a);let l=this._layerToRTTProviderMapping.get(r);if(!l)throw new Error("Could not find the RTT provider for the layer");let c=this._xrSessionManager.scene.layers.find(h=>h.texture===e);if(!c)throw new Error("Could not find the babylon layer for the texture");return l.onRenderTargetTextureCreatedObservable.add(h=>{h.eye&&h.eye==="right"||(h.texture.clearColor=new oe(0,0,0,0),c.renderTargetTextures.push(h.texture),c.renderOnlyInRenderTargetTextures=!0,this._xrSessionManager.scene.onBeforeRenderObservable.add(()=>{h.texture.render()}),c.renderTargetTextures.push(h.texture),c.renderOnlyInRenderTargetTextures=!0,this._xrSessionManager.onXRSessionEnded.addOnce(()=>{c.renderTargetTextures.splice(c.renderTargetTextures.indexOf(h.texture),1),c.renderOnlyInRenderTargetTextures=!1}))}),i}_addLensFlareSystem(e){let t=this._createQuadLayer({params:{space:this._xrSessionManager.viewerReferenceSpace,textureType:"texture",layout:"mono"}}),i=t.layer;i.width=2,i.height=1;let n={x:0,y:0,z:-10},o={x:0,y:0,z:0,w:1};i.transform=new XRRigidTransform(n,o);let a=this._layerToRTTProviderMapping.get(i);if(!a)throw new Error("Could not find the RTT provider for the layer");return a.onRenderTargetTextureCreatedObservable.add(l=>{l.texture.clearColor=new oe(0,0,0,0),l.texture.customRenderFunction=()=>{e.render()}}),this._xrSessionManager.onXRSessionInit.add(()=>{this._xrSessionManager.scene.lensFlareSystems.splice(this._xrSessionManager.scene.lensFlareSystems.indexOf(e),1)}),this._xrSessionManager.onXRSessionEnded.add(()=>{this._xrSessionManager.scene.lensFlareSystems.push(e)}),t}addXRSessionLayer(e){this._existingLayers.push(e),this.setXRSessionLayers(this._existingLayers)}setXRSessionLayers(e=this._existingLayers){let t=ie({},this._xrSessionManager.session.renderState);t.baseLayer=void 0,t.layers=e.map(i=>i.layer),this._xrSessionManager.updateRenderState(t),this._projectionLayerInitialized||this._xrSessionManager._setBaseLayerWrapper(e.length>0?e.at(0):null)}isCompatible(){return!this._xrSessionManager.isNative&&typeof XRWebGLBinding<"u"&&!!XRWebGLBinding.prototype.createProjectionLayer}dispose(){super.dispose()}_onXRFrame(e){let t=this._existingLayers;for(let i=0;i<t.length;++i){let r=t[i];if(r.layerType!=="XRProjectionLayer"){let n=this._layerToRTTProviderMapping.get(r.layer);if(!n)continue;if(n.layerWrapper.isMultiview){let o=e.getViewerPose(this._xrSessionManager.referenceSpace);if(o){let a=o.views;for(let l=0;l<a.length;++l){let c=a[l];n.getRenderTargetTextureForView(c)}}}else n.getRenderTargetTextureForView()}}}};Zh.Name=ct.LAYERS;Zh.Version=1;mt.AddWebXRFeature(Zh.Name,(s,e)=>()=>new Zh(s,e),Zh.Version,!1);var Jh=class extends Ct{get width(){return this._width}get height(){return this._height}get rawValueToMeters(){return this._rawValueToMeters}get normDepthBufferFromNormView(){return this._normDepthBufferFromNormView}get depthUsage(){switch(this._xrSessionManager.session.depthUsage){case"cpu-optimized":return"cpu";case"gpu-optimized":return"gpu"}}get depthDataFormat(){switch(this._xrSessionManager.session.depthDataFormat){case"luminance-alpha":return"ushort";case"float32":return"float"}}get latestInternalTexture(){if(!this._cachedWebGLTexture)return null;let e=this._xrSessionManager.scene.getEngine(),t=new Je(e,ke.Unknown);return t.isCube=!1,t.invertY=!1,t._useSRGBBuffer=!1,t.format=this.depthDataFormat==="ushort"?2:5,t.generateMipMaps=!1,t.type=this.depthDataFormat==="ushort"?5:1,t.samplingMode=7,t.width=this.width??0,t.height=this.height??0,t._cachedWrapU=1,t._cachedWrapV=1,t._hardwareTexture=new Ho(this._cachedWebGLTexture,e._gl),t}get latestDepthBuffer(){return this._cachedDepthBuffer?this.depthDataFormat==="ushort"?new Uint16Array(this._cachedDepthBuffer):new Float32Array(this._cachedDepthBuffer):null}get latestDepthImageTexture(){return this._cachedDepthImageTexture}constructor(e,t){super(e),this.options=t,this._width=null,this._height=null,this._rawValueToMeters=null,this._normDepthBufferFromNormView=null,this._cachedDepthBuffer=null,this._cachedWebGLTexture=null,this._cachedDepthImageTexture=null,this.onGetDepthInMetersAvailable=new U,this.xrNativeFeatureName="depth-sensing",H.Warn("depth-sensing is an experimental and unstable feature.")}attach(e){return!super.attach(e)||this._xrSessionManager.session.depthDataFormat==null||this._xrSessionManager.session.depthUsage==null?!1:(this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._xrSessionManager.scene.getEngine()._gl),!0)}dispose(){this._cachedDepthImageTexture?.dispose()}_onXRFrame(e){let t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(i!=null)for(let r of i.views)switch(this.depthUsage){case"cpu":this._updateDepthInformationAndTextureCPUDepthUsage(e,r,this.depthDataFormat);break;case"gpu":if(!this._glBinding)break;this._updateDepthInformationAndTextureWebGLDepthUsage(this._glBinding,r,this.depthDataFormat);break;default:H.Error("Unknown depth usage"),this.detach();break}}_updateDepthInformationAndTextureCPUDepthUsage(e,t,i){let r=e.getDepthInformation(t);if(r===null)return;let{data:n,width:o,height:a,rawValueToMeters:l,getDepthInMeters:c}=r;switch(this._width=o,this._height=a,this._rawValueToMeters=l,this._cachedDepthBuffer=n,this.onGetDepthInMetersAvailable.notifyObservers(c.bind(r)),this._cachedDepthImageTexture||(this._cachedDepthImageTexture=xi.CreateRTexture(null,o,a,this._xrSessionManager.scene,!1,!0,z.NEAREST_SAMPLINGMODE,K.TEXTURETYPE_FLOAT)),i){case"ushort":this._cachedDepthImageTexture.update(Float32Array.from(new Uint16Array(n)).map(h=>h*l));break;case"float":this._cachedDepthImageTexture.update(new Float32Array(n).map(h=>h*l));break;default:break}}_updateDepthInformationAndTextureWebGLDepthUsage(e,t,i){let r=e.getDepthInformation(t);if(r===null)return;let{texture:n,width:o,height:a}=r;this._width=o,this._height=a,this._cachedWebGLTexture=n;let l=this._xrSessionManager.scene,h=l.getEngine().wrapWebGLTexture(n);this._cachedDepthImageTexture||(this._cachedDepthImageTexture=xi.CreateRTexture(null,o,a,l,!1,!0,z.NEAREST_SAMPLINGMODE,i==="ushort"?K.TEXTURETYPE_UNSIGNED_BYTE:K.TEXTURETYPE_FLOAT)),this._cachedDepthImageTexture._texture=h}getXRSessionInitExtension(){let e=this.options.usagePreference!=null&&this.options.usagePreference.length!==0,t=this.options.dataFormatPreference!=null&&this.options.dataFormatPreference.length!==0;return new Promise(i=>{if(e&&t){let r=this.options.usagePreference.map(o=>{switch(o){case"cpu":return"cpu-optimized";case"gpu":return"gpu-optimized"}}),n=this.options.dataFormatPreference.map(o=>{switch(o){case"ushort":return"luminance-alpha";case"float":return"float32"}});i({depthSensing:{usagePreference:r,dataFormatPreference:n}})}else i({})})}};Jh.Name=ct.DEPTH_SENSING;Jh.Version=1;mt.AddWebXRFeature(Jh.Name,(s,e)=>()=>new Jh(s,e),Jh.Version,!1);var mZ="velocityPixelShader",gZ=`precision highp float;
#define CUSTOM_FRAGMENT_BEGIN
varying vec4 clipPos;varying vec4 previousClipPos;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
highp vec4 motionVector=( clipPos/clipPos.w-previousClipPos/previousClipPos.w );gl_FragColor=motionVector;
#define CUSTOM_FRAGMENT_MAIN_END
}`;D.ShadersStore[mZ]=gZ;var _Z="velocityVertexShader",xZ=`#define CUSTOM_VERTEX_BEGIN
#define VELOCITY
attribute vec3 position;
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform mat4 previousViewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;uniform mat4 previousViewProjectionR;
#endif
varying vec4 clipPos;varying vec4 previousClipPos;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#include<instancesVertex>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vec4 previousWorldPos=finalPreviousWorld*vec4(positionUpdated,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {clipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;} else {clipPos=viewProjectionR*worldPos;previousClipPos=previousViewProjectionR*previousWorldPos;gl_Position=clipPos;}
#elif
clipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}`;D.ShadersStore[_Z]=xZ;var PM=class extends vt{constructor(e,t,i,r=512){super("spacewarp rtt",r,i,!1,!0,2,!1,void 0,!1,!1,!0,void 0,!0),this._originalPairing=[],this._previousWorldMatrices=[],this._previousTransforms=[N.Identity(),N.Identity()],this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight(),e,t),this._renderTarget._disposeOnlyFramebuffers=!0,this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,i&&(this._velocityMaterial=new Fi("velocity shader material",i,{vertex:"velocity",fragment:"velocity"},{uniforms:["world","previousWorld","viewProjection","viewProjectionR","previousViewProjection","previousViewProjectionR"]}),this._velocityMaterial._materialHelperNeedsPreviousMatrices=!0,this._velocityMaterial.onBindObservable.add(n=>{this._previousWorldMatrices[n.uniqueId]=this._previousWorldMatrices[n.uniqueId]||n.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousWorld",this._previousWorldMatrices[n.uniqueId]),this._previousWorldMatrices[n.uniqueId]=n.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousViewProjection",this._previousTransforms[0]),this._velocityMaterial.getEffect().setMatrix("previousViewProjectionR",this._previousTransforms[1]),this._previousTransforms[0].copyFrom(i.getTransformMatrix()),this._previousTransforms[1].copyFrom(i._transformMatrixR)}),this._velocityMaterial.freeze())}render(e=!1,t=!1){this._originalPairing.length=0;let i=this.getScene();i&&this._velocityMaterial&&i.getActiveMeshes().forEach(r=>{this._originalPairing.push([r,r.material]),r.material=this._velocityMaterial}),super.render(e,t),this._originalPairing.forEach(r=>{r[0].material=r[1]})}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindSpaceWarpFramebuffer(this._renderTarget)}getViewCount(){return 2}dispose(){super.dispose(),this._velocityMaterial.dispose(),this._previousTransforms.length=0,this._previousWorldMatrices.length=0,this._originalPairing.length=0}},MM=class{constructor(e,t,i){this._scene=e,this._xrSessionManager=t,this._xrWebGLBinding=i,this._lastSubImages=new Map,this._renderTargetTextures=new Map,this._engine=e.getEngine()}_getSubImageForView(e){let t=this._xrSessionManager._getBaseLayerWrapper();if(!t)throw new Error("For Space Warp, the base layer should be a WebXR Projection Layer.");if(t.layerType!=="XRProjectionLayer")throw new Error('For Space Warp, the base layer type should "XRProjectionLayer".');let i=t.layer;return this._xrWebGLBinding.getViewSubImage(i,e)}_setViewportForSubImage(e,t){e.x=0,e.y=0,e.width=t.motionVectorTextureWidth,e.height=t.motionVectorTextureHeight}_createRenderTargetTexture(e,t,i,r,n){if(!this._engine)throw new Error("Engine is disposed");let o={width:e,height:t},a=new PM(r,n,this._scene,o),l=a.renderTarget;return i&&(l._framebuffer=i),l._colorTextureArray=r,l._depthStencilTextureArray=n,a.disableRescaling(),a.renderListPredicate=()=>!0,a}_getRenderTargetForSubImage(e,t){let i=this._lastSubImages.get(t),r=this._renderTargetTextures.get(t.eye),n=e.motionVectorTextureWidth,o=e.motionVectorTextureHeight;return(!r||i?.textureWidth!==n||i?.textureHeight!=o)&&(r=this._createRenderTargetTexture(n,o,null,e.motionVectorTexture,e.depthStencilTexture),this._renderTargetTextures.set(t.eye,r),this._framebufferDimensions={framebufferWidth:n,framebufferHeight:o}),this._lastSubImages.set(t,e),r}trySetViewportForView(e,t){let i=this._lastSubImages.get(t)||this._getSubImageForView(t);return i?(this._setViewportForSubImage(e,i),!0):!1}accessMotionVector(e){let t=this._getSubImageForView(e);t&&(t.motionVectorTexture,t.depthStencilTexture)}getRenderTargetTextureForEye(e){return null}getRenderTargetTextureForView(e){let t=this._getSubImageForView(e);return t?this._getRenderTargetForSubImage(t,e):null}dispose(){this._renderTargetTextures.forEach(e=>e.dispose()),this._renderTargetTextures.clear()}},eu=class extends Ct{constructor(e){super(e),this._onAfterRenderObserver=null,this.dependsOn=[ct.LAYERS],this.xrNativeFeatureName="space-warp",this._xrSessionManager.scene.needsPreviousWorldMatrices=!0}attach(){if(!super.attach())return!1;let e=this._xrSessionManager.scene.getEngine();return this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this.spaceWarpRTTProvider=new MM(this._xrSessionManager.scene,this._xrSessionManager,this._xrWebGLBinding),this._onAfterRenderObserver=this._xrSessionManager.scene.onAfterRenderObservable.add(()=>this._onAfterRender()),!0}detach(){return this._xrSessionManager.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),super.detach()}_onAfterRender(){this.attached&&this._renderTargetTexture&&this._renderTargetTexture.render(!1,!1)}isCompatible(){return this._xrSessionManager.scene.getEngine().getCaps().colorBufferHalfFloat||!1}dispose(){super.dispose()}_onXRFrame(e){let t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;let i=t.views[0];this._renderTargetTexture=this._renderTargetTexture||this.spaceWarpRTTProvider.getRenderTargetTextureForView(i),this.spaceWarpRTTProvider.accessMotionVector(i)}};eu.Name=ct.SPACE_WARP;eu.Version=1;mt.AddWebXRFeature(eu.Name,s=>()=>new eu(s),eu.Version,!1);var tu=class extends Ct{constructor(e,t={}){super(e),this.options=t,this._cachedInternalTextures=[],this.texturesData=[],this.viewIndex=[],this.cameraIntrinsics=[],this.onTexturesUpdatedObservable=new U,this.xrNativeFeatureName="camera-access"}attach(e){return super.attach(e)?(this._glContext=this._xrSessionManager.scene.getEngine()._gl,this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),!0):!1}detach(){return super.detach()?(this._glBinding=void 0,this.options.doNotDisposeOnDetach||(this._cachedInternalTextures.forEach(e=>e.dispose()),this.texturesData.forEach(e=>e.dispose()),this._cachedInternalTextures.length=0,this.texturesData.length=0,this.cameraIntrinsics.length=0),!0):!1}dispose(){super.dispose(),this.onTexturesUpdatedObservable.clear()}_updateCameraIntrinsics(e,t){let i={width:e.camera.width,height:e.camera.height,x:0,y:0},r=e.projectionMatrix,n=(1-r[8])*i.width/2+i.x,o=(1-r[9])*i.height/2+i.y,a=i.width/2*r[0],l=i.height/2*r[5],c=i.width/2*r[4];this.cameraIntrinsics[t]={u0:n,v0:o,ax:a,ay:l,gamma:c,width:i.width,height:i.height,viewportX:i.x,viewportY:i.y}}_updateInternalTextures(e,t=0){if(!e.camera)return!1;this.viewIndex[t]=e.eye;let i=this._glBinding?.getCameraImage(e.camera);if(this._cachedInternalTextures[t])this._cachedInternalTextures[t]._hardwareTexture?.set(i);else{let r=new Je(this._xrSessionManager.scene.getEngine(),ke.Unknown,!0);r.invertY=!1,r.format=5,r.generateMipMaps=!0,r.type=1,r.samplingMode=3,r.width=e.camera.width,r.height=e.camera.height,r._cachedWrapU=1,r._cachedWrapV=1,r._hardwareTexture=new Ho(i,this._glContext),this._cachedInternalTextures[t]=r;let n=new Qi(this._xrSessionManager.scene);n.name=`WebXR Raw Camera Access (${t})`,n._texture=this._cachedInternalTextures[t],this.texturesData[t]=n,this._updateCameraIntrinsics(e,t)}return this._cachedInternalTextures[t].isReady=!0,!0}_onXRFrame(e){let t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(!i||!i.views)return;let r=!0;i.views.forEach((n,o)=>{r=r&&this._updateInternalTextures(n,o)}),r&&this.onTexturesUpdatedObservable.notifyObservers(this.texturesData)}};tu.Name=ct.RAW_CAMERA_ACCESS;tu.Version=1;mt.AddWebXRFeature(tu.Name,(s,e)=>()=>new tu(s,e),tu.Version,!1);var DM=class extends Zs{constructor(e,t,i){super(e,vZ[i],t,i,!0),this.profileId="generic-hand-select-grasp"}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){}_updateModel(){}};br.RegisterController("generic-hand-select-grasp",(s,e)=>new DM(e,s.gamepad,s.handedness));var vZ={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-none",assetPath:"none.glb"}};var TZ=(()=>{class s extends Zs{constructor(t,i,r){super(t,CZ["left-right"],i,r),this._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},this.profileId="microsoft-mixed-reality"}_getFilenameAndPath(){let t="";this.handedness==="left"?t=s.MODEL_LEFT_FILENAME:t=s.MODEL_RIGHT_FILENAME;let r=s.MODEL_BASE_URL+"default"+"/";return{filename:t,path:r}}_getModelLoadingConstraints(){let t=Mt.IsPluginForExtensionAvailable(".glb");return t||F.Warn("glTF / glb loaded was not registered, using generic controller instead"),t}_processLoadedModel(t){this.rootMesh&&(this.getComponentIds().forEach((i,r)=>{if(!this.disableAnimation&&i&&this.rootMesh){let n=this._mapping.buttons[i],o=n.rootNodeName;if(!o){F.Log("Skipping unknown button at index: "+r+" with mapped name: "+i);return}let a=this._getChildByName(this.rootMesh,o);if(!a){F.Warn("Missing button mesh with name: "+o);return}if(n.valueMesh=this._getImmediateChildByName(a,this._mapping.defaultButton.valueNodeName),n.pressedMesh=this._getImmediateChildByName(a,this._mapping.defaultButton.pressedNodeName),n.unpressedMesh=this._getImmediateChildByName(a,this._mapping.defaultButton.unpressedNodeName),n.valueMesh&&n.pressedMesh&&n.unpressedMesh){let l=this.getComponent(i);l&&l.onButtonStateChangedObservable.add(c=>{this._lerpTransform(n,c.value)},void 0,!0)}else F.Warn("Missing button submesh under mesh with name: "+o)}}),this.getComponentIds().forEach(i=>{let r=this.getComponent(i);r.isAxes()&&["x-axis","y-axis"].forEach(n=>{if(!this.rootMesh)return;let o=this._mapping.axes[i][n],a=this._getChildByName(this.rootMesh,o.rootNodeName);if(!a){F.Warn("Missing axis mesh with name: "+o.rootNodeName);return}o.valueMesh=this._getImmediateChildByName(a,this._mapping.defaultAxis.valueNodeName),o.minMesh=this._getImmediateChildByName(a,this._mapping.defaultAxis.minNodeName),o.maxMesh=this._getImmediateChildByName(a,this._mapping.defaultAxis.maxNodeName),o.valueMesh&&o.minMesh&&o.maxMesh?r&&r.onAxisValueChangedObservable.add(l=>{let c=n==="x-axis"?l.x:l.y;this._lerpTransform(o,c,!0)},void 0,!0):F.Warn("Missing axis submesh under mesh with name: "+o.rootNodeName)})}))}_setRootMesh(t){this.rootMesh=new k(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;let i;for(let r=0;r<t.length;r++){let n=t[r];n.isPickable=!1,n.parent||(i=n)}i&&i.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=q.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}return s.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",s.MODEL_LEFT_FILENAME="left.glb",s.MODEL_RIGHT_FILENAME="right.glb",s})();br.RegisterController("windows-mixed-reality",(s,e)=>new TZ(e,s.gamepad,s.handedness));var CZ={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}};var $V=(()=>{class s extends Zs{constructor(t,i,r,n=!1,o=!1){super(t,bZ[r],i,r),this._forceLegacyControllers=o,this.profileId="oculus-touch"}_getFilenameAndPath(){let t="";this.handedness==="left"?t=s.MODEL_LEFT_FILENAME:t=s.MODEL_RIGHT_FILENAME;let i=this._isQuest()?s.QUEST_MODEL_BASE_URL:s.MODEL_BASE_URL;return{filename:t,path:i}}_getModelLoadingConstraints(){return!0}_processLoadedModel(t){let i=this._isQuest(),r=this.handedness==="right"?-1:1;this.getComponentIds().forEach(n=>{let o=n&&this.getComponent(n);o&&o.onButtonStateChangedObservable.add(a=>{if(!(!this.rootMesh||this.disableAnimation))switch(n){case"xr-standard-trigger":i||(this._modelRootNode.getChildren()[3].rotation.x=-a.value*.2,this._modelRootNode.getChildren()[3].position.y=-a.value*.005,this._modelRootNode.getChildren()[3].position.z=-a.value*.005);return;case"xr-standard-squeeze":i||(this._modelRootNode.getChildren()[4].position.x=r*a.value*.0035);return;case"xr-standard-thumbstick":return;case"a-button":case"x-button":i||(a.pressed?this._modelRootNode.getChildren()[1].position.y=-.001:this._modelRootNode.getChildren()[1].position.y=0);return;case"b-button":case"y-button":i||(a.pressed?this._modelRootNode.getChildren()[2].position.y=-.001:this._modelRootNode.getChildren()[2].position.y=0);return}},void 0,!0)})}_setRootMesh(t){this.rootMesh=new k(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=q.FromEulerAngles(0,Math.PI,0)),t.forEach(i=>{i.isPickable=!1}),this._isQuest()?this._modelRootNode=t[0]:(this._modelRootNode=t[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh}_updateModel(){}_isQuest(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers}}return s.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",s.MODEL_LEFT_FILENAME="left.babylon",s.MODEL_RIGHT_FILENAME="right.babylon",s.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",s})();br.RegisterController("oculus-touch",(s,e)=>new $V(e,s.gamepad,s.handedness));br.RegisterController("oculus-touch-legacy",(s,e)=>new $V(e,s.gamepad,s.handedness,!0));var bZ={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}};var SZ=(()=>{class s extends Zs{constructor(t,i,r){super(t,yZ[r],i,r),this.profileId="htc-vive"}_getFilenameAndPath(){let t=s.MODEL_FILENAME,i=s.MODEL_BASE_URL;return{filename:t,path:i}}_getModelLoadingConstraints(){return!0}_processLoadedModel(t){this.getComponentIds().forEach(i=>{let r=i&&this.getComponent(i);r&&r.onButtonStateChangedObservable.add(n=>{if(!(!this.rootMesh||this.disableAnimation))switch(i){case"xr-standard-trigger":this._modelRootNode.getChildren()[6].rotation.x=-n.value*.15;return;case"xr-standard-touchpad":return;case"xr-standard-squeeze":return}},void 0,!0)})}_setRootMesh(t){this.rootMesh=new k(this.profileId+" "+this.handedness,this.scene),t.forEach(i=>{i.isPickable=!1}),this._modelRootNode=t[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=q.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}return s.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",s.MODEL_FILENAME="wand.babylon",s})();br.RegisterController("htc-vive",(s,e)=>new SZ(e,s.gamepad,s.handedness));var yZ={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}};var OM=class{get session(){return this._nativeImpl.session}constructor(e){this._nativeImpl=e,this._xrTransform=new XRRigidTransform,this._xrPose={transform:this._xrTransform,emulatedPosition:!1},this._xrPoseVectorData=new Float32Array(8),this.fillPoses=this._nativeImpl.fillPoses.bind(this._nativeImpl),this.getViewerPose=this._nativeImpl.getViewerPose.bind(this._nativeImpl),this.getHitTestResults=this._nativeImpl.getHitTestResults.bind(this._nativeImpl),this.getHitTestResultsForTransientInput=()=>{throw new Error("XRFrame.getHitTestResultsForTransientInput not supported on native.")},this.createAnchor=this._nativeImpl.createAnchor.bind(this._nativeImpl),this.getJointPose=this._nativeImpl.getJointPose.bind(this._nativeImpl),this.fillJointRadii=this._nativeImpl.fillJointRadii.bind(this._nativeImpl),this.getLightEstimate=()=>{throw new Error("XRFrame.getLightEstimate not supported on native.")},this.getImageTrackingResults=()=>this._nativeImpl._imageTrackingResults??[]}getPose(e,t){if(!this._nativeImpl.getPoseData(e,t,this._xrPoseVectorData.buffer,this._xrTransform.matrix.buffer))return;let i=this._xrTransform.position;i.x=this._xrPoseVectorData[0],i.y=this._xrPoseVectorData[1],i.z=this._xrPoseVectorData[2],i.w=this._xrPoseVectorData[3];let r=this._xrTransform.orientation;return r.x=this._xrPoseVectorData[4],r.y=this._xrPoseVectorData[5],r.z=this._xrPoseVectorData[6],r.w=this._xrPoseVectorData[7],this._xrPose}get trackedAnchors(){return this._nativeImpl.trackedAnchors}get worldInformation(){return this._nativeImpl.worldInformation}get detectedPlanes(){return this._nativeImpl.detectedPlanes}get featurePointCloud(){return this._nativeImpl.featurePointCloud}getDepthInformation(e){throw new Error("This function is not available in Babylon Native")}};cV("NativeXRFrame",OM);var Jr=function(s){return s[s.Input=0]="Input",s[s.Output=1]="Output",s}(Jr||{}),iu=class{constructor(e,t,i){this._ownerBlock=i,this._connectedPoint=[],this.uniqueId=ts(),this.connectedPointIds=[],this.name=e,this._connectionType=t}get connectionType(){return this._connectionType}_isSingularConnection(){return!0}isConnected(){return this._connectedPoint.length>0}connectTo(e){if(this._connectionType===e._connectionType)throw new Error(`Cannot connect two points of type ${this.connectionType}`);if(this._isSingularConnection()&&this._connectedPoint.length>0||e._isSingularConnection()&&e._connectedPoint.length>0)throw new Error("Max number of connections for point reached");this._connectedPoint.push(e),e._connectedPoint.push(this)}serialize(e={}){e.uniqueId=this.uniqueId,e.name=this.name,e._connectionType=this._connectionType,e.connectedPointIds=[],e.className=this.getClassName();for(let t of this._connectedPoint)e.connectedPointIds.push(t.uniqueId)}getClassName(){return"FGConnection"}deserialize(e){this.uniqueId=e.uniqueId,this.name=e.name,this._connectionType=e._connectionType,this.connectedPointIds=e.connectedPointIds}static Parse(e={},t){let i=H.Instantiate(e.className),r=new i(e.name,e._connectionType,t);return r.deserialize(e),r}};var ur=(()=>{class s{constructor(t){this.value=this._toInt(t)}_toInt(t){return t|0}add(t){return new s(this.value+t.value)}subtract(t){return new s(this.value-t.value)}multiply(t){return new s(Math.imul(this.value,t.value))}divide(t){return new s(this.value/t.value)}getClassName(){return s.ClassName}equals(t){return this.value===t.value}static Parse(t){return new s(t.value)}}return s.ClassName="FlowGraphInteger",s})();P("FlowGraphInteger",ur);var Es=class s{constructor(e,t){this.typeName=e,this.defaultValue=t}serialize(e){e.typeName=this.typeName,e.defaultValue=this.defaultValue}static Parse(e){return new s(e.typeName,e.defaultValue)}},be=new Es("any",void 0),EZ=new Es("string",""),Ot=new Es("number",0),Bi=new Es("boolean",!1),cb=new Es("Vector2",j.Zero()),Uo=new Es("Vector3",p.Zero()),AZ=new Es("Vector4",De.Zero()),xl=new Es("Matrix",N.Identity()),IZ=new Es("Color3",X.Black()),RZ=new Es("Color4",new oe(0,0,0,0)),PZ=new Es("Quaternion",q.Identity()),Pi=new Es("FlowGraphInteger",new ur(0));function jV(s){switch(typeof s){case"string":return EZ;case"number":return Ot;case"boolean":return Bi;case"object":return s instanceof j?cb:s instanceof p?Uo:s instanceof De?AZ:s instanceof X?IZ:s instanceof oe?RZ:s instanceof q?PZ:s instanceof ur?Pi:be;default:return be}}var yf=class extends iu{constructor(e,t,i,r){super(e,t,i),this.richType=r}_isSingularConnection(){return this.connectionType===Jr.Input}setValue(e,t){t._setConnectionValue(this,e)}connectTo(e){super.connectTo(e)}_getValueOrDefault(e){return e._hasConnectionValue(this)?e._getConnectionValue(this):this.richType.defaultValue}getValue(e){return this.connectionType===Jr.Output?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._updateOutputs(e),this._getValueOrDefault(e)):this.isConnected()?this._connectedPoint[0].getValue(e):this._getValueOrDefault(e)}getClassName(){return"FGDataConnection"}serialize(e={}){super.serialize(e),e.richType={},this.richType.serialize(e.richType)}static Parse(e,t){let i=iu.Parse(e,t);return i.richType=Es.Parse(e.richType),i}};P("FGDataConnection",yf);function qV(s){return s==="Mesh"||s==="AbstractMesh"||s==="GroundMesh"||s==="InstanceMesh"||s==="LinesMesh"||s==="GoldbergMesh"||s==="GreasedLineMesh"||s==="TrailMesh"}function QV(s){return s==="Vector2"||s==="Vector3"||s==="Vector4"||s==="Quaternion"||s==="Color3"||s==="Color4"}function MZ(s,e){if(s==="Vector2")return j.FromArray(e);if(s==="Vector3")return p.FromArray(e);if(s==="Vector4")return De.FromArray(e);if(s==="Quaternion")return q.FromArray(e);if(s==="Color3")return new X(e[0],e[1],e[2]);if(s==="Color4")return new oe(e[0],e[1],e[2],e[3]);throw new Error(`Unknown vector class name ${s}`)}function Ef(s,e,t){let i=e?.getClassName?.()??"";qV(i)?t[s]={name:e.name,className:i}:QV(i)?t[s]={value:e.asArray(),className:i}:t[s]=e}function mc(s,e,t){let i=e[s],r,n=i?.className;return qV(n)?r=t.getMeshByName(i.name):QV(n)?r=MZ(n,i.value):n==="Matrix"?r=N.FromArray(i.value):n===ur.ClassName?r=ur.Parse(i):i&&i.value!==void 0?r=i.value:r=i,r}function KV(s){return s==="FGSetPropertyBlock"||s==="FGGetPropertyBlock"||s==="FGPlayAnimationBlock"||s==="FGMeshPickEventBlock"}var es=class{constructor(e){this.config=e,this.uniqueId=ts(),this.name=this.config?.name??this.getClassName(),this.dataInputs=[],this.dataOutputs=[]}_updateOutputs(e){}registerDataInput(e,t){let i=new yf(e,Jr.Input,this,t);return this.dataInputs.push(i),i}registerDataOutput(e,t){let i=new yf(e,Jr.Output,this,t);return this.dataOutputs.push(i),i}getDataInput(e){return this.dataInputs.find(t=>t.name===e)}getDataOutput(e){return this.dataOutputs.find(t=>t.name===e)}serialize(e={},t=Ef){e.uniqueId=this.uniqueId,e.config={},this.config&&(e.config.name=this.config.name),e.dataInputs=[],e.dataOutputs=[],e.className=this.getClassName();for(let i of this.dataInputs){let r={};i.serialize(r),e.dataInputs.push(r)}for(let i of this.dataOutputs){let r={};i.serialize(r),e.dataOutputs.push(r)}}getClassName(){return"FGBlock"}static Parse(e,t){let i=H.Instantiate(e.className),r={},n=t.valueParseFunction??mc;if(e.config)for(let a in e.config)r[a]=n(a,e.config,t.scene);KV(e.className)&&(r.pathConverter=t.pathConverter);let o=new i(r);o.uniqueId=e.uniqueId;for(let a=0;a<e.dataInputs.length;a++){let l=o.getDataInput(e.dataInputs[a].name);if(l)l.deserialize(e.dataInputs[a]);else throw new Error("Could not find data input with name "+e.dataInputs[a].name+" in block "+e.className)}for(let a=0;a<e.dataOutputs.length;a++){let l=o.getDataOutput(e.dataOutputs[a].name);if(l)l.deserialize(e.dataOutputs[a]);else throw new Error("Could not find data output with name "+e.dataOutputs[a].name+" in block "+e.className)}return o.metadata=e.metadata,o.deserialize&&o.deserialize(e),o}};var Af=class extends iu{_isSingularConnection(){return this.connectionType===Jr.Output}_activateSignal(e){this.connectionType===Jr.Input?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._execute(e,this),e._increaseExecutionId()):this._connectedPoint[0]?._activateSignal(e)}};P("FlowGraphSignalConnection",Af);var Fr=class extends es{constructor(e){super(e),this.signalInputs=[],this.signalOutputs=[],this.in=this._registerSignalInput("in")}_registerSignalInput(e){let t=new Af(e,Jr.Input,this);return this.signalInputs.push(t),t}_registerSignalOutput(e){let t=new Af(e,Jr.Output,this);return this.signalOutputs.push(t),t}getSignalInput(e){return this.signalInputs.find(t=>t.name===e)}getSignalOutput(e){return this.signalOutputs.find(t=>t.name===e)}serialize(e={}){super.serialize(e),e.signalInputs=[],e.signalOutputs=[];for(let t of this.signalInputs){let i={};t.serialize(i),e.signalInputs.push(i)}for(let t of this.signalOutputs){let i={};t.serialize(i),e.signalOutputs.push(i)}}deserialize(e){for(let t=0;t<e.signalInputs.length;t++){let i=this.getSignalInput(e.signalInputs[t].name);if(i)i.deserialize(e.signalInputs[t]);else throw new Error("Could not find signal input with name "+e.signalInputs[t].name+" in block "+e.className)}for(let t=0;t<e.signalOutputs.length;t++){let i=this.getSignalOutput(e.signalOutputs[t].name);if(i)i.deserialize(e.signalOutputs[t]);else throw new Error("Could not find signal output with name "+e.signalOutputs[t].name+" in block "+e.className)}}getClassName(){return"FGExecutionBlock"}};var gc=class extends Fr{constructor(e){super(e),this.out=this._registerSignalOutput("out"),this.done=this._registerSignalOutput("done")}_startPendingTasks(e){this._preparePendingTasks(e),e._addPendingBlock(this)}};var to=class extends gc{_execute(e){e._notifyExecuteNode(this),this.out._activateSignal(e)}};var If=class{constructor(e){this.uniqueId=ts(),this._userVariables={},this._executionVariables={},this._connectionValues={},this._pendingBlocks=[],this._executionId=0,this.onNodeExecutedObservable=new U,this._configuration=e}hasVariable(e){return e in this._userVariables}setVariable(e,t){this._userVariables[e]=t}getVariable(e){return this._userVariables[e]}get userVariables(){return this._userVariables}_getUniqueIdPrefixedName(e,t){return`${e.uniqueId}_${t}`}_setExecutionVariable(e,t,i){this._executionVariables[this._getUniqueIdPrefixedName(e,t)]=i}_getExecutionVariable(e,t,i){return this._hasExecutionVariable(e,t)?this._executionVariables[this._getUniqueIdPrefixedName(e,t)]:i}_deleteExecutionVariable(e,t){delete this._executionVariables[this._getUniqueIdPrefixedName(e,t)]}_hasExecutionVariable(e,t){return this._getUniqueIdPrefixedName(e,t)in this._executionVariables}_hasConnectionValue(e){return e.uniqueId in this._connectionValues}_setConnectionValue(e,t){this._connectionValues[e.uniqueId]=t}_getConnectionValue(e){return this._connectionValues[e.uniqueId]}get configuration(){return this._configuration}_addPendingBlock(e){this._pendingBlocks.push(e)}_removePendingBlock(e){let t=this._pendingBlocks.indexOf(e);t!==-1&&this._pendingBlocks.splice(t,1)}_clearPendingBlocks(){for(let e of this._pendingBlocks)e._cancelPendingTasks(this);this._pendingBlocks.length=0}_notifyExecuteNode(e){this.onNodeExecutedObservable.notifyObservers(e)}_increaseExecutionId(){this._executionId++}get executionId(){return this._executionId}serialize(e={},t=Ef){e.uniqueId=this.uniqueId,e._userVariables={};for(let i in this._userVariables)t(i,this._userVariables[i],e._userVariables);e._connectionValues={};for(let i in this._connectionValues)t(i,this._connectionValues[i],e._connectionValues)}getClassName(){return"FGContext"}static Parse(e,t){let i=t.graph.createContext(),r=t.valueParseFunction??mc;i.uniqueId=e.uniqueId;for(let n in e._userVariables){let o=r(n,e._userVariables,i._configuration.scene);i._userVariables[n]=o}for(let n in e._connectionValues){let o=r(n,e._connectionValues,i._configuration.scene);i._connectionValues[n]=o}return i}};v([I()],If.prototype,"uniqueId",void 0);function cg(s,e){return!!(s.parent&&(s.parent===e||cg(s.parent,e)))}var hb=(()=>{class s extends to{constructor(t){super(t),this.config=t}_getReferencedMesh(){let t=this.config.pathConverter.convert(this.config.path),i=t.info.getObject(t.object);if(!i||!(i instanceof lt))throw new Error("Mesh pick event block requires a valid mesh");return i}_preparePendingTasks(t){let i=t._getExecutionVariable(this,"meshPickObserver");if(!i){let r=this._getReferencedMesh();t._setExecutionVariable(this,"mesh",r),i=r.getScene().onPointerObservable.add(o=>{o.type===Ae.POINTERPICK&&o.pickInfo?.pickedMesh&&(o.pickInfo?.pickedMesh===r||cg(o.pickInfo?.pickedMesh,r))&&this._execute(t)});let n=r.onDisposeObservable.add(()=>this._onDispose);t._setExecutionVariable(this,"meshPickObserver",i),t._setExecutionVariable(this,"meshDisposeObserver",n)}}_onDispose(t){this._cancelPendingTasks(t),t._removePendingBlock(this)}_cancelPendingTasks(t){let i=t._getExecutionVariable(this,"mesh"),r=t._getExecutionVariable(this,"meshPickObserver"),n=t._getExecutionVariable(this,"meshDisposeObserver");i.getScene().onPointerObservable.remove(r),i.onDisposeObservable.remove(n),t._deleteExecutionVariable(this,"mesh"),t._deleteExecutionVariable(this,"meshPickObserver"),t._deleteExecutionVariable(this,"meshDisposeObserver")}getClassName(){return s.ClassName}serialize(t){super.serialize(t),t.config.path=this.config.path}}return s.ClassName="FGMeshPickEventBlock",s})();P(hb.ClassName,hb);var Rf=function(s){return s[s.Stopped=0]="Stopped",s[s.Started=1]="Started",s}(Rf||{}),ru=class s{constructor(e){this._eventBlocks=[],this._executionContexts=[],this.state=Rf.Stopped,this._scene=e.scene,this._coordinator=e.coordinator,this._sceneDisposeObserver=this._scene.onDisposeObservable.add(()=>this.dispose())}createContext(){let e=new If({scene:this._scene,coordinator:this._coordinator});return this._executionContexts.push(e),e}getContext(e){return this._executionContexts[e]}addEventBlock(e){this._eventBlocks.push(e)}start(){if(this.state!==Rf.Started){this.state=Rf.Started,this._executionContexts.length===0&&this.createContext();for(let e of this._executionContexts){let t=this._getContextualOrder();for(let i of t)i._startPendingTasks(e)}}}_getContextualOrder(){let e=[];for(let t of this._eventBlocks)if(t.getClassName()===hb.ClassName){let i=t._getReferencedMesh(),r=0;for(;r<e.length;r++){let o=e[r]._getReferencedMesh();if(i&&o&&cg(i,o))break}e.splice(r,0,t)}else e.push(t);return e}dispose(){if(this.state!==Rf.Stopped){this.state=Rf.Stopped;for(let e of this._executionContexts)e._clearPendingBlocks();this._executionContexts.length=0,this._eventBlocks.length=0,this._scene.onDisposeObservable.remove(this._sceneDisposeObserver),this._sceneDisposeObserver=null}}visitAllBlocks(e){let t=[],i=new Set;for(let r of this._eventBlocks)t.push(r),i.add(r.uniqueId);for(;t.length>0;){let r=t.pop();e(r);for(let n of r.dataInputs)for(let o of n._connectedPoint)i.has(o._ownerBlock.uniqueId)||(t.push(o._ownerBlock),i.add(o._ownerBlock.uniqueId));if(r instanceof Fr)for(let n of r.signalOutputs)for(let o of n._connectedPoint)i.has(o._ownerBlock.uniqueId)||(t.push(o._ownerBlock),i.add(o._ownerBlock.uniqueId))}}serialize(e={},t){e.allBlocks=[],this.visitAllBlocks(i=>{let r={};i.serialize(r),e.allBlocks.push(r)}),e.executionContexts=[];for(let i of this._executionContexts){let r={};i.serialize(r,t),e.executionContexts.push(r)}}static GetDataOutConnectionByUniqueId(e,t){for(let i of e)for(let r of i.dataOutputs)if(r.uniqueId===t)return r;throw new Error("Could not find data out connection with unique id "+t)}static GetSignalInConnectionByUniqueId(e,t){for(let i of e)if(i instanceof Fr){for(let r of i.signalInputs)if(r.uniqueId===t)return r}throw new Error("Could not find signal in connection with unique id "+t)}static Parse(e,t){let i=t.coordinator.createGraph(),r=[],n=t.valueParseFunction??mc;for(let o of e.allBlocks){let a=es.Parse(o,{scene:t.coordinator.config.scene,pathConverter:t.pathConverter,valueParseFunction:n});r.push(a),a instanceof to&&i.addEventBlock(a)}for(let o of r){for(let a of o.dataInputs)for(let l of a.connectedPointIds){let c=s.GetDataOutConnectionByUniqueId(r,l);a.connectTo(c)}if(o instanceof Fr)for(let a of o.signalOutputs)for(let l of a.connectedPointIds){let c=s.GetSignalInConnectionByUniqueId(r,l);a.connectTo(c)}}for(let o of e.executionContexts)If.Parse(o,{graph:i,valueParseFunction:n});return i}};var hg=class s{constructor(e){this.config=e,this._flowGraphs=[],this._customEventsMap=new Map,this.config.scene.onDisposeObservable.add(()=>{this.dispose()}),(s.SceneCoordinators.get(this.config.scene)??[]).push(this)}createGraph(){let e=new ru({scene:this.config.scene,coordinator:this});return this._flowGraphs.push(e),e}removeGraph(e){let t=this._flowGraphs.indexOf(e);t!==-1&&(e.dispose(),this._flowGraphs.splice(t,1))}start(){this._flowGraphs.forEach(e=>e.start())}dispose(){this._flowGraphs.forEach(i=>i.dispose()),this._flowGraphs.length=0;let e=s.SceneCoordinators.get(this.config.scene)??[],t=e.indexOf(this);t!==-1&&e.splice(t,1)}serialize(e,t){e._flowGraphs=[],this._flowGraphs.forEach(i=>{let r={};i.serialize(r,t),e._flowGraphs.push(r)})}static Parse(e,t){let i=t.valueParseFunction??mc,r=new s({scene:t.scene});return e._flowGraphs?.forEach(n=>{ru.Parse(n,{coordinator:r,valueParseFunction:i,pathConverter:t.pathConverter})}),r}get flowGraphs(){return this._flowGraphs}getCustomEventObservable(e){let t=this._customEventsMap.get(e);return t||(t=new U,this._customEventsMap.set(e,t)),t}notifyCustomEvent(e,t){let i=this._customEventsMap.get(e);i&&i.notifyObservers(t)}};hg.SceneCoordinators=new Map;var Vi=class extends Fr{constructor(e){super(e),this.out=this._registerSignalOutput("out")}};var ub=(()=>{class s extends Vi{constructor(t){super(t),this.message=this.registerDataInput("message",be)}_execute(t){let i=this.message.getValue(t);F.Log(i),this.out._activateSignal(t)}getClassName(){return s.ClassName}}return s.ClassName="FGConsoleLogBlock",s})();P(ub.ClassName,ub);var db=(()=>{class s extends Vi{constructor(t){super(t),this.config=t,this.input=this.registerDataInput(t.variableName,be)}_execute(t){let i=this.config.variableName,r=this.input.getValue(t);t.setVariable(i,r),this.out._activateSignal(t)}getClassName(){return s.ClassName}}return s.ClassName="FGSetVariableBlock",s})();P(db.ClassName,db);var ZV=new RegExp(/\{(\w+)\}/g),vl=class{constructor(e,t){this.path=e,this.ownerBlock=t,this.templatedInputs=[];let i=ZV.exec(e);for(;i;){let[,r]=i;this.templatedInputs.push(t.registerDataInput(r,Pi)),i=ZV.exec(e)}}getAccessor(e,t){let i=this.path;for(let r of this.templatedInputs){let n=r.getValue(t).value;i=i.replace(`{${r.name}}`,n.toString())}return e.convert(i)}};var wM=(()=>{class s extends Vi{constructor(t){super(t),this.config=t,this.a=this.registerDataInput("a",be),this.templateComponent=new vl(t.path,this)}_execute(t){let i=this.a.getValue(t),r=this.templateComponent.getAccessor(this.config.pathConverter,t);r.info.set(i,r.object),this.out._activateSignal(t)}serialize(t={}){super.serialize(t),t.config.path=this.config.path}getClassName(){return s.ClassName}}return s.ClassName="FGSetPropertyBlock",s})();P("FGSetPropertyBlock",wM);var NM=(()=>{class s extends Vi{constructor(t){super(t),this.config=t;for(let i=0;i<this.config.eventData.length;i++){let r=this.config.eventData[i];this.registerDataInput(r,be)}}_execute(t){let i=this.config.eventId,r=this.dataInputs.map(n=>n.getValue(t));t.configuration.coordinator.notifyCustomEvent(i,r),this.out._activateSignal(t)}getClassName(){return s.ClassName}}return s.ClassName="FGSendCustomEventBlock",s})();P("FGSendCustomEventBlock",NM);var FM=class extends Fr{constructor(e){super(e),this.condition=this.registerDataInput("condition",Bi),this.onTrue=this._registerSignalOutput("onTrue"),this.onFalse=this._registerSignalOutput("onFalse")}_execute(e){this.condition.getValue(e)?this.onTrue._activateSignal(e):this.onFalse._activateSignal(e)}getClassName(){return"FGBranchBlock"}};P("FGBranchBlock",FM);var fb=(()=>{class s extends Vi{constructor(t={startIndex:new ur(0)}){super(t),this.config=t,this.reset=this._registerSignalInput("reset"),this.n=this.registerDataInput("n",Pi),this.value=this.registerDataOutput("value",Pi)}_execute(t,i){if(i===this.reset)this.value.setValue(this.config.startIndex,t);else{let r=this.value.getValue(t);r.value<this.n.getValue(t).value&&(this.value.setValue(new ur(r.value+1),t),this.out._activateSignal(t))}}getClassName(){return s.ClassName}}return s.ClassName="FGDoNBlock",s})();P(fb.ClassName,fb);var LM=class extends Vi{constructor(e){super(e),this.startIndex=this.registerDataInput("startIndex",Ot),this.endIndex=this.registerDataInput("endIndex",Ot),this.step=this.registerDataInput("step",Ot),this.index=this.registerDataOutput("index",Ot),this.onLoop=this._registerSignalOutput("onLoop")}_executeLoop(e){let t=e._getExecutionVariable(this,"index"),i=e._getExecutionVariable(this,"endIndex");if(t<i){this.index.setValue(t,e),this.onLoop._activateSignal(e);let r=e._getExecutionVariable(this,"step",1);t+=r,e._setExecutionVariable(this,"index",t),this._executeLoop(e)}else this.out._activateSignal(e)}_execute(e){let t=this.startIndex.getValue(e),i=this.endIndex.getValue(e),r=this.step.getValue(e);e._setExecutionVariable(this,"index",t),e._setExecutionVariable(this,"endIndex",i),e._setExecutionVariable(this,"step",r),this._executeLoop(e)}getClassName(){return"FGForLoopBlock"}};P("FGForLoopBlock",LM);var BM=class extends Vi{constructor(e){super(e),this.reset=this._registerSignalInput("reset"),this.duration=this.registerDataInput("duration",Ot),this.timeRemaining=this.registerDataOutput("timeRemaining",Ot)}_execute(e,t){let i=e._getExecutionVariable(this,"lastExecutedTime"),r=this.duration.getValue(e),n=Date.now();if(t===this.reset||i===void 0||n-i>r)this.timeRemaining.setValue(0,e),this.out._activateSignal(e),e._setExecutionVariable(this,"lastExecutedTime",n);else{let o=r-(n-i);this.timeRemaining.setValue(o,e)}}getClassName(){return"FGThrottleBlock"}};P("FGThrottleBlock",BM);var VM=(()=>{class s extends gc{constructor(t){super(t),this.timeout=this.registerDataInput("timeout",Ot)}_preparePendingTasks(t){let i=this.timeout.getValue(t);if(i!==void 0&&i>=0){let r=t._getExecutionVariable(this,"runningTimers")||[],n=t.configuration.scene,o=new yT({timeout:i,contextObservable:n.onBeforeRenderObservable,onEnded:()=>this._onEnded(o,t)});o.start(),r.push(o),t._setExecutionVariable(this,"runningTimers",r)}}_execute(t){this._startPendingTasks(t),this.out._activateSignal(t)}_onEnded(t,i){let r=i._getExecutionVariable(this,"runningTimers")||[],n=r.indexOf(t);n!==-1?r.splice(n,1):H.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),i._removePendingBlock(this),this.done._activateSignal(i)}_cancelPendingTasks(t){let i=t._getExecutionVariable(this,"runningTimers")||[];for(let r of i)r.dispose();t._deleteExecutionVariable(this,"runningTimers")}getClassName(){return s.ClassName}}return s.ClassName="FGTimerBlock",s})();P("FGTimerBlock",VM);var UM=class extends Fr{constructor(e){super(e),this.config=e,this._cachedUnusedIndexes=[],this.reset=this._registerSignalInput("reset"),this.currentIndex=this.registerDataOutput("currentIndex",Ot),this.config.startIndex=this.config.startIndex!==void 0?this.config.startIndex:0,this.config.startIndex=Math.max(0,Math.min(this.config.startIndex,this.config.numberOutputFlows-1)),this.outFlows=[];for(let t=0;t<this.config.numberOutputFlows;t++)this.outFlows.push(this._registerSignalOutput(`out${t}`))}_getUnusedIndexes(e){let t=this._cachedUnusedIndexes;if(t.length=0,e._hasExecutionVariable(this,"unusedIndexes")){let i=e._getExecutionVariable(this,"unusedIndexes");for(let r=0;r<i.length;r++)t.push(i[r])}else for(let i=0;i<this.config.numberOutputFlows;i++)t.push(i);return t}_getNextOutput(e,t){if(this.config.isRandom){let i=Math.floor(Math.random()*t.length);return t[i]}else return e+1}_execute(e,t){let i=e._getExecutionVariable(this,"currentIndex")??this.config.startIndex-1,r=this._getUnusedIndexes(e);if(t===this.reset){e._deleteExecutionVariable(this,"currentIndex"),e._deleteExecutionVariable(this,"unusedIndexes");return}let n=this._getNextOutput(i,r);if(n>=this.config.numberOutputFlows&&this.config.loop)n=0;else if(n>=this.config.numberOutputFlows&&!this.config.loop)return;if(r=r.filter(o=>o!==n),r.length===0)for(let o=0;o<this.config.numberOutputFlows;o++)r.push(o);e._setExecutionVariable(this,"unusedIndexes",r),e._setExecutionVariable(this,"currentIndex",n),this.currentIndex.setValue(n,e),this.outFlows[n]._activateSignal(e)}getClassName(){return"FGMultiGateBlock"}serialize(e){super.serialize(e),e.config.numberOutputFlows=this.config.numberOutputFlows,e.config.isRandom=this.config.isRandom,e.config.loop=this.config.loop,e.config.startIndex=this.config.startIndex}};P("FGMultiGateBlock",UM);var kM=class extends Fr{constructor(e){super(e),this.config=e,this.selection=this.registerDataInput("selection",be),this.outputFlows=[];for(let t=0;t<=this.config.cases.length;t++)this.outputFlows.push(this._registerSignalOutput(`out${t}`))}_execute(e,t){let i=this.selection.getValue(e);for(let r=0;r<this.config.cases.length;r++)if(i===this.config.cases[r]){this.outputFlows[r]._activateSignal(e);return}this.outputFlows[this.outputFlows.length-1]._activateSignal(e)}getClassName(){return"FGSwitchBlock"}serialize(e){super.serialize(e),e.cases=this.config.cases}};P("FGSwitchBlock",kM);var GM=class extends Vi{constructor(e){super(e),this.config=e,this.inFlows=[],this._cachedActivationState=[],this.reset=this._registerSignalInput("reset");for(let t=1;t<this.config.numberInputFlows;t++)this.inFlows.push(this._registerSignalInput(`in${t}`))}_getCurrentActivationState(e){let t=this._cachedActivationState;if(t.length=0,e._hasExecutionVariable(this,"activationState")){let i=e._getExecutionVariable(this,"activationState");for(let r=0;r<i.length;r++)t.push(i[r])}else for(let i=0;i<this.config.numberInputFlows;i++)t.push(!1);return t}_execute(e,t){let i=this._getCurrentActivationState(e);if(t===this.reset)for(let r=0;r<this.config.numberInputFlows;r++)i[r]=!1;else if(t===this.in)i[0]=!0;else{let r=this.inFlows.indexOf(t);r>=0&&(i[r+1]=!0)}if(e._setExecutionVariable(this,"activationState",i.slice()),i.every(r=>r)){this.out._activateSignal(e);for(let r=0;r<this.config.numberInputFlows;r++)i[r]=!1}}getClassName(){return"FGWaitAllBlock"}serialize(e){super.serialize(e),e.config.numberInputFlows=this.config.numberInputFlows}};P("FGWaitAllBlock",GM);var zM=class extends Vi{constructor(e){super(e),this.count=this.registerDataOutput("count",Ot),this.reset=this._registerSignalInput("reset")}_execute(e,t){if(t===this.reset){e._setExecutionVariable(this,"count",0),this.count.setValue(0,e);return}let i=(e._getExecutionVariable(this,"count")??0)+1;e._setExecutionVariable(this,"count",i),this.count.setValue(i,e),this.out._activateSignal(e)}getClassName(){return"FGCounterBlock"}};P("FGCounterBlock",zM);var pb=(()=>{class s extends Vi{constructor(t){super(t),this.config=t,this.condition=this.registerDataInput("condition",Bi),this.loopBody=this._registerSignalOutput("loopBody")}_execute(t,i){let r=this.condition.getValue(t);for(this.config?.isDo&&!r&&this.loopBody._activateSignal(t);r;)this.loopBody._activateSignal(t),r=this.condition.getValue(t);this.out._activateSignal(t)}getClassName(){return s.ClassName}serialize(t){super.serialize(t),t.isDo=this.config?.isDo}}return s.ClassName="FGWhileLoopBlock",s})();P(pb.ClassName,pb);var WM=class extends Vi{constructor(e){super(e),this.count=this.registerDataInput("count",Ot),this.reset=this._registerSignalInput("reset"),this.currentCount=this.registerDataOutput("currentCount",Ot)}_execute(e,t){if(t===this.reset){e._setExecutionVariable(this,"debounceCount",0);return}let i=this.count.getValue(e),n=e._getExecutionVariable(this,"debounceCount",0)+1;this.currentCount.setValue(n,e),e._setExecutionVariable(this,"debounceCount",n),n>=i&&(this.out._activateSignal(e),e._setExecutionVariable(this,"debounceCount",0))}getClassName(){return"FGDebounceBlock"}};P("FGDebounceBlock",WM);var HM=class extends Fr{constructor(e){super(e),this.onOn=this._registerSignalOutput("onOn"),this.onOff=this._registerSignalOutput("onOff"),this.isOn=this.registerDataOutput("isOn",Bi)}_execute(e,t){let i=e._getExecutionVariable(this,"value",!1);i=!i,e._setExecutionVariable(this,"value",i),this.isOn.setValue(i,e),i?this.onOn._activateSignal(e):this.onOff._activateSignal(e)}getClassName(){return"FGFlipFlopBlock"}};P("FGFlipFlopBlock",HM);var mb=(()=>{class s extends Fr{constructor(t){super(t),this.config=t,this.outFlows=[];for(let i=0;i<this.config.numberOutputFlows;i++)this.outFlows.push(this._registerSignalOutput(`${i}`))}_execute(t){for(let i=0;i<this.config.numberOutputFlows;i++)this.outFlows[i]._activateSignal(t)}getClassName(){return s.ClassName}}return s.ClassName="FGSequenceBlock",s})();P(mb.ClassName,mb);var JV=(()=>{class s extends gc{constructor(t){super(t),this.config=t,this.templateTargetComponent=new vl(t.targetPath,this),this.templateAnimationComponent=new vl(t.animationPath,this),this.speed=this.registerDataInput("speed",Ot),this.loop=this.registerDataInput("loop",Bi),this.from=this.registerDataInput("from",Ot),this.to=this.registerDataInput("to",Ot),this.runningAnimatable=this.registerDataOutput("runningAnimatable",be)}_preparePendingTasks(t){let i=this.templateTargetComponent.getAccessor(this.config.pathConverter,t),r=i.info.getObject(i.object),n=this.templateAnimationComponent.getAccessor(this.config.pathConverter,t),o=n.info.get(n.object);if(!r||!o)throw new Error("Cannot play animation without target or animation");let a=t._getExecutionVariable(this,"runningAnimatables")??[],l=this.runningAnimatable.getValue(t);if(l&&l.paused)l.restart();else{let h=t.configuration.scene.beginDirectAnimation(r,[o],this.from.getValue(t),this.to.getValue(t),this.loop.getValue(t),this.speed.getValue(t),()=>this._onAnimationEnd(h,t));this.runningAnimatable.setValue(h,t),a.push(h)}t._setExecutionVariable(this,"runningAnimatables",a)}_execute(t){this._startPendingTasks(t),this.out._activateSignal(t)}_onAnimationEnd(t,i){let r=i._getExecutionVariable(this,"runningAnimatables")??[],n=r.indexOf(t);n!==-1&&r.splice(n,1),i._removePendingBlock(this),this.done._activateSignal(i)}_cancelPendingTasks(t){let i=t._getExecutionVariable(this,"runningAnimatables")??[];for(let r of i)r.stop();t._deleteExecutionVariable(this,"runningAnimatables")}getClassName(){return s.ClassName}serialize(t={}){super.serialize(t),t.config.targetPath=this.config.targetPath,t.config.animationPath=this.config.animationPath}}return s.ClassName="FGPlayAnimationBlock",s})();P(JV.ClassName,JV);var XM=class extends Vi{constructor(e){super(e),this.animationToStop=this.registerDataInput("animationToStop",be)}_execute(e){this.animationToStop.getValue(e).stop(),this.out._activateSignal(e)}getClassName(){return"FGStopAnimationBlock"}};P("FGStopAnimationBlock",XM);var YM=class extends Vi{constructor(e){super(e),this.animationToPause=this.registerDataInput("animationToPause",be)}_execute(e){this.animationToPause.getValue(e).pause(),this.out._activateSignal(e)}getClassName(){return"FGPauseAnimationBlock"}};P("FGPauseAnimationBlock",YM);var $M=class extends es{constructor(e){super(e),this.condition=this.registerDataInput("condition",Bi),this.trueValue=this.registerDataInput("trueValue",be),this.falseValue=this.registerDataInput("falseValue",be),this.output=this.registerDataOutput("output",be)}_updateOutputs(e){this.output.setValue(this.condition.getValue(e)?this.trueValue.getValue(e):this.falseValue.getValue(e),e)}getClassName(){return"FGConditionalDataBlock"}};P("FGConditionalDataBlock",$M);var gb=(()=>{class s extends es{constructor(t){super(t),this.config=t,this.output=this.registerDataOutput(t.variableName,be)}_updateOutputs(t){let i=this.config.variableName;t.hasVariable(i)&&this.output.setValue(t.getVariable(i),t)}getClassName(){return s.ClassName}serialize(t){super.serialize(t),t.config.variableName=this.config.variableName}}return s.ClassName="FGGetVariableBlock",s})();P(gb.ClassName,gb);var jM=class extends es{constructor(e){super(e),this.sourceSystem=this.registerDataInput("sourceSystem",be),this.destinationSystem=this.registerDataInput("destinationSystem",be),this.inputCoordinates=this.registerDataInput("inputCoordinates",Uo),this.outputCoordinates=this.registerDataOutput("outputCoordinates",Uo)}_updateOutputs(e){let t=this.sourceSystem.getValue(e),i=this.destinationSystem.getValue(e),r=this.inputCoordinates.getValue(e),n=t.getWorldMatrix(),o=i.getWorldMatrix(),a=O.Matrix[0].copyFrom(o);a.invert();let l=O.Matrix[1];a.multiplyToRef(n,l);let c=this.outputCoordinates.getValue(e);p.TransformCoordinatesToRef(r,l,c)}getClassName(){return"FGCoordinateTransformBlock"}};P("FGCoordinateTransformBlock",jM);var qM=class extends es{constructor(e){super(e),this.config=e,this.output=this.registerDataOutput("output",jV(e.value))}_updateOutputs(e){this.output.setValue(this.config.value,e)}getClassName(){return"FGConstantBlock"}serialize(e={},t=Ef){super.serialize(e),t("value",this.config.value,e.config)}};P("FGConstantBlock",qM);var _b=(()=>{class s extends es{constructor(t){super(t),this.config=t,this.value=this.registerDataOutput("value",be),this.templateComponent=new vl(t.path,this)}_updateOutputs(t){let i=this.templateComponent.getAccessor(this.config.pathConverter,t),r=i.info.get(i.object);this.value.setValue(r,t)}getClassName(){return s.ClassName}serialize(t={}){super.serialize(t),t.config.path=this.config.path}}return s.ClassName="FGGetPropertyBlock",s})();P(_b.ClassName,_b);var e2="cachedOperationValue",t2="cachedExecutionId",Ia=class extends es{constructor(e,t){super(t),this.value=this.registerDataOutput("value",e)}_updateOutputs(e){let t=e._getExecutionVariable(this,t2),i=e._getExecutionVariable(this,e2);if(i!==void 0&&t===e.executionId)this.value.setValue(i,e);else{let r=this._doOperation(e);e._setExecutionVariable(this,e2,r),e._setExecutionVariable(this,t2,e.executionId),this.value.setValue(r,e)}}};var Ni=class extends Ia{constructor(e,t,i,r,n,o){super(i,o),this._operation=r,this._className=n,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e))}getClassName(){return this._className}};var wt=class extends Ia{constructor(e,t,i,r,n){super(t,n),this._operation=i,this._className=r,this.a=this.registerDataInput("a",e)}_doOperation(e){return this._operation(this.a.getValue(e))}getClassName(){return this._className}};var Pf="FGLogic",i2="AndBlock",r2="OrBlock",s2="NotBlock",QM=class extends Ni{constructor(e){super(Bi,Bi,Bi,(t,i)=>t&&i,`${Pf}${i2}`,e)}};P(`${Pf}${i2}`,QM);var KM=class extends Ni{constructor(e){super(Bi,Bi,Bi,(t,i)=>t||i,`${Pf}${r2}`,e)}};P(`${Pf}${r2}`,KM);var ZM=class extends wt{constructor(e){super(Bi,Bi,t=>!t,`${Pf}${s2}`,e)}};P(`${Pf}${s2}`,ZM);var _c=class extends Ia{constructor(e,t,i,r){super(e,r),this._operation=t,this._className=i}_doOperation(e){return this._operation()}getClassName(){return this._className}};var Mf=class extends Ia{constructor(e,t,i,r,n,o,a){super(r,a),this._operation=n,this._className=o,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t),this.c=this.registerDataInput("c",i)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e),this.c.getValue(e))}getClassName(){return this._className}};function Lr(s){return s.getClassName?s.getClassName():""}function ug(s,e){return s==="Vector2"&&e==="Vector2"||s==="Vector3"&&e==="Vector3"||s==="Vector4"&&e==="Vector4"}function dg(s,e){return s==="Matrix"&&e==="Matrix"}function fg(s,e){return s==="FlowGraphInteger"&&e==="FlowGraphInteger"}var xb=(()=>{class s extends Ni{constructor(t){super(be,be,be,(i,r)=>this._polymorphicAdd(i,r),s.ClassName,t)}_polymorphicAdd(t,i){let r=Lr(t),n=Lr(i);return ug(r,n)||dg(r,n)||fg(r,n)?t.add(i):t+i}}return s.ClassName="FGAddBlock",s})();P(xb.ClassName,xb);var vb=(()=>{class s extends Ni{constructor(t){super(be,be,be,(i,r)=>this._polymorphicAdd(i,r),s.ClassName,t)}_polymorphicAdd(t,i){let r=Lr(t),n=Lr(i);return ug(r,n)||fg(r,n)?t.subtract(i):dg(r,n)?t.add(i.scale(-1)):t-i}}return s.ClassName="FGSubBlock",s})();P(vb.ClassName,vb);var Tb=(()=>{class s extends Ni{constructor(t){super(be,be,be,(i,r)=>this._polymorphicMultiply(i,r),s.ClassName,t)}_polymorphicMultiply(t,i){let r=Lr(t),n=Lr(i);return ug(r,n)||fg(r,n)?t.multiply(i):dg(r,n)?N.FromValues(t.m[0]*i.m[0],t.m[4]*i.m[4],t.m[8]*i.m[8],t.m[12]*i.m[12],t.m[1]*i.m[1],t.m[5]*i.m[5],t.m[9]*i.m[9],t.m[13]*i.m[13],t.m[2]*i.m[2],t.m[6]*i.m[6],t.m[10]*i.m[10],t.m[14]*i.m[14],t.m[3]*i.m[3],t.m[7]*i.m[7],t.m[11]*i.m[11],t.m[15]*i.m[15]):t*i}}return s.ClassName="FGMultiplyBlock",s})();P(Tb.ClassName,Tb);var Cb=(()=>{class s extends Ni{constructor(t){super(be,be,be,(i,r)=>this._polymorphicDivide(i,r),s.ClassName,t)}_polymorphicDivide(t,i){let r=Lr(t),n=Lr(i);return ug(r,n)||fg(r,n)?t.divide(i):dg(r,n)?N.FromValues(t.m[0]/i.m[0],t.m[4]/i.m[4],t.m[8]/i.m[8],t.m[12]/i.m[12],t.m[1]/i.m[1],t.m[5]/i.m[5],t.m[9]/i.m[9],t.m[13]/i.m[13],t.m[2]/i.m[2],t.m[6]/i.m[6],t.m[10]/i.m[10],t.m[14]/i.m[14],t.m[3]/i.m[3],t.m[7]/i.m[7],t.m[11]/i.m[11],t.m[15]/i.m[15]):t/i}}return s.ClassName="FGDivideBlock",s})();P(Cb.ClassName,Cb);var bb=(()=>{class s extends _c{constructor(t){super(Ot,()=>Math.random(),s.ClassName,t)}}return s.ClassName="FGRandomBlock",s})();P(bb.ClassName,bb);var Sb=(()=>{class s extends Ni{constructor(t){super(be,be,Ot,(i,r)=>this._polymorphicDot(i,r),s.ClassName,t)}_polymorphicDot(t,i){switch(Lr(t)){case"Vector2":return j.Dot(t,i);case"Vector3":return p.Dot(t,i);case"Vector4":return De.Dot(t,i);default:throw new Error(`Cannot get dot product of ${t} and ${i}`)}}}return s.ClassName="FGDotBlock",s})();P(Sb.ClassName,Sb);var yb=(()=>{class s extends _c{constructor(t){super(Ot,()=>Math.E,s.ClassName,t)}}return s.ClassName="FGEBlock",s})();P(yb.ClassName,yb);var Eb=(()=>{class s extends _c{constructor(t){super(Ot,()=>Math.PI,s.ClassName,t)}}return s.ClassName="FGPIBlock",s})();P(Eb.ClassName,Eb);var Ab=(()=>{class s extends _c{constructor(t){super(Ot,()=>Number.POSITIVE_INFINITY,s.ClassName,t)}}return s.ClassName="FGInfBlock",s})();P(Ab.ClassName,Ab);var Ib=(()=>{class s extends _c{constructor(t){super(Ot,()=>Number.NaN,s.ClassName,t)}}return s.ClassName="FGNaNBlock",s})();P(Ib.ClassName,Ib);function Ui(s,e){switch(Lr(s)){case"FlowGraphInteger":return new ur(e(s.value));case"Vector2":return new j(e(s.x),e(s.y));case"Vector3":return new p(e(s.x),e(s.y),e(s.z));case"Vector4":return new De(e(s.x),e(s.y),e(s.z),e(s.w));case"Matrix":return N.FromValues(e(s.m[0]),e(s.m[4]),e(s.m[8]),e(s.m[12]),e(s.m[1]),e(s.m[5]),e(s.m[9]),e(s.m[13]),e(s.m[2]),e(s.m[6]),e(s.m[10]),e(s.m[14]),e(s.m[3]),e(s.m[7]),e(s.m[11]),e(s.m[15]));default:return e(s)}}var Rb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicAbs(i),s.ClassName,t)}_polymorphicAbs(t){return Ui(t,Math.abs)}}return s.ClassName="FGAbsBlock",s})();P(Rb.ClassName,Rb);var Pb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicSign(i),s.ClassName,t)}_polymorphicSign(t){return Ui(t,Math.sign)}}return s.ClassName="FGSignBlock",s})();P(Pb.ClassName,Pb);var Mb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicTrunc(i),s.ClassName,t)}_polymorphicTrunc(t){return Ui(t,Math.trunc)}}return s.ClassName="FGTruncBlock",s})();P(Mb.ClassName,Mb);var Db=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicFloor(i),s.ClassName,t)}_polymorphicFloor(t){return Ui(t,Math.floor)}}return s.ClassName="FGFloorBlock",s})();P(Db.ClassName,Db);var Ob=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicCeiling(i),s.ClassName,t)}_polymorphicCeiling(t){return Ui(t,Math.ceil)}}return s.ClassName="FGCeilBlock",s})();P(Ob.ClassName,Ob);var wb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicFract(i),s.ClassName,t)}_polymorphicFract(t){return Ui(t,i=>i-Math.floor(i))}}return s.ClassName="FGFractBlock",s})();P(wb.ClassName,wb);var Nb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicNeg(i),s.ClassName,t)}_polymorphicNeg(t){return Ui(t,i=>-i)}}return s.ClassName="FGNegBlock",s})();P(Nb.ClassName,Nb);function pg(s,e,t){switch(Lr(s)){case"FlowGraphInteger":return new ur(t(s.value,e.value));case"Vector2":return new j(t(s.x,e.x),t(s.y,e.y));case"Vector3":return new p(t(s.x,e.x),t(s.y,e.y),t(s.z,e.z));case"Vector4":return new De(t(s.x,e.x),t(s.y,e.y),t(s.z,e.z),t(s.w,e.w));case"Matrix":return N.FromValues(t(s.m[0],e.m[0]),t(s.m[4],e.m[4]),t(s.m[8],e.m[8]),t(s.m[12],e.m[12]),t(s.m[1],e.m[1]),t(s.m[5],e.m[5]),t(s.m[9],e.m[9]),t(s.m[13],e.m[13]),t(s.m[2],e.m[2]),t(s.m[6],e.m[6]),t(s.m[10],e.m[10]),t(s.m[14],e.m[14]),t(s.m[3],e.m[3]),t(s.m[7],e.m[7]),t(s.m[11],e.m[11]),t(s.m[15],e.m[15]));default:return t(s,e)}}var Fb=(()=>{class s extends Ni{constructor(t){super(be,be,be,(i,r)=>this._polymorphicRemainder(i,r),s.ClassName,t)}_polymorphicRemainder(t,i){return pg(t,i,(r,n)=>r%n)}}return s.ClassName="FGRemainderBlock",s})();P(Fb.ClassName,Fb);var Lb=(()=>{class s extends Ni{constructor(t){super(be,be,be,(i,r)=>this._polymorphicMin(i,r),s.ClassName,t)}_polymorphicMin(t,i){return pg(t,i,Math.min)}}return s.ClassName="FGMinBlock",s})();P(Lb.ClassName,Lb);var Bb=(()=>{class s extends Ni{constructor(t){super(be,be,be,(i,r)=>this._polymorphicMax(i,r),s.ClassName,t)}_polymorphicMax(t,i){return pg(t,i,Math.max)}}return s.ClassName="FGMaxBlock",s})();P(Bb.ClassName,Bb);function DZ(s,e,t){return Math.min(Math.max(s,Math.min(e,t)),Math.max(e,t))}function n2(s,e,t,i){switch(Lr(s)){case"FlowGraphInteger":return new ur(i(s.value,e.value,t.value));case"Vector2":return new j(i(s.x,e.x,t.x),i(s.y,e.y,t.y));case"Vector3":return new p(i(s.x,e.x,t.x),i(s.y,e.y,t.y),i(s.z,e.z,t.z));case"Vector4":return new De(i(s.x,e.x,t.x),i(s.y,e.y,t.y),i(s.z,e.z,t.z),i(s.w,e.w,t.w));case"Matrix":return N.FromValues(i(s.m[0],e.m[0],t.m[0]),i(s.m[4],e.m[4],t.m[4]),i(s.m[8],e.m[8],t.m[8]),i(s.m[12],e.m[12],t.m[12]),i(s.m[1],e.m[1],t.m[1]),i(s.m[5],e.m[5],t.m[5]),i(s.m[9],e.m[9],t.m[9]),i(s.m[13],e.m[13],t.m[13]),i(s.m[2],e.m[2],t.m[2]),i(s.m[6],e.m[6],t.m[6]),i(s.m[10],e.m[10],t.m[10]),i(s.m[14],e.m[14],t.m[14]),i(s.m[3],e.m[3],t.m[3]),i(s.m[7],e.m[7],t.m[7]),i(s.m[11],e.m[11],t.m[11]),i(s.m[15],e.m[15],t.m[15]));default:return i(s,e,t)}}var Vb=(()=>{class s extends Mf{constructor(t){super(be,be,be,be,(i,r,n)=>this._polymorphicClamp(i,r,n),s.ClassName,t)}_polymorphicClamp(t,i,r){return n2(t,i,r,DZ)}}return s.ClassName="FGClampBlock",s})();P(Vb.ClassName,Vb);function OZ(s){return Math.min(Math.max(s,0),1)}var Ub=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicSaturate(i),s.ClassName,t)}_polymorphicSaturate(t){return Ui(t,OZ)}}return s.ClassName="FGSaturateBlock",s})();P(Ub.ClassName,Ub);var kb=(()=>{class s extends Mf{constructor(t){super(be,be,be,be,(i,r,n)=>this._polymorphicInterpolate(i,r,n),s.ClassName,t)}_interpolate(t,i,r){return(1-r)*t+r*i}_polymorphicInterpolate(t,i,r){return n2(t,i,r,this._interpolate)}}return s.ClassName="FGInterpolateBlock",s})();P(kb.ClassName,kb);var Gb=(()=>{class s extends Ni{constructor(t){super(be,be,Bi,(i,r)=>this._polymorphicEq(i,r),s.ClassName,t)}_polymorphicEq(t,i){let r=Lr(t),n=Lr(i);return ug(r,n)||dg(r,n)||fg(r,n)?t.equals(i):t===i}}return s.ClassName="FGEqBlock",s})();P(Gb.ClassName,Gb);function OS(s,e,t){let i=Lr(s),r=Lr(e);if(i===r){if(i==="")return t(s,e);if(i==="FlowGraphInteger")return t(s.value,e.value);throw new Error(`Cannot compare ${s} and ${e}`)}throw new Error(`${s} and ${e} are of different types.`)}var zb=(()=>{class s extends Ni{constructor(t){super(be,be,Bi,(i,r)=>this._polymorphicLessThan(i,r),s.ClassName,t)}_polymorphicLessThan(t,i){return OS(t,i,(r,n)=>r<n)}}return s.ClassName="FGLessThanBlock",s})();P(zb.ClassName,zb);var o2=(()=>{class s extends Ni{constructor(t){super(be,be,Bi,(i,r)=>this._polymorphicLessThanOrEqual(i,r),s.ClassName,t)}_polymorphicLessThanOrEqual(t,i){return OS(t,i,(r,n)=>r<=n)}}return s.ClassName="FGLessThanOrEqualBlock",s})(),Wb=(()=>{class s extends Ni{constructor(t){super(be,be,Bi,(i,r)=>this._polymorphicGreaterThan(i,r),s.ClassName,t)}_polymorphicGreaterThan(t,i){return OS(t,i,(r,n)=>r>n)}}return s.ClassName="FGGreaterThanBlock",s})();P(Wb.ClassName,Wb);var Hb=(()=>{class s extends Ni{constructor(t){super(be,be,Bi,(i,r)=>this._polymorphicGreaterThanOrEqual(i,r),s.ClassName,t)}_polymorphicGreaterThanOrEqual(t,i){return OS(t,i,(r,n)=>r>=n)}}return s.ClassName="FGGreaterThanOrEqualBlock",s})();P(Hb.ClassName,Hb);var Xb=(()=>{class s extends wt{constructor(t){super(be,Bi,i=>this._polymorphicIsNan(i),s.ClassName,t)}_polymorphicIsNan(t){let i=Lr(t);if(i==="")return isNaN(t);if(i==="FlowGraphInteger")return isNaN(t.value);throw new Error(`Cannot get NaN of ${t}`)}}return s.ClassName="FGIsNanBlock",s})();P(Xb.ClassName,Xb);var a2=(()=>{class s extends wt{constructor(t){super(be,Bi,i=>this._polymorphicIsInf(i),s.ClassName,t)}_polymorphicIsInf(t){let i=Lr(t);if(i==="")return!isFinite(t);if(i==="FlowGraphInteger")return!isFinite(t.value);throw new Error(`Cannot get isInf of ${t}`)}}return s.ClassName="FGIsInfBlock",s})(),Yb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicDegToRad(i),s.ClassName,t)}_degToRad(t){return t*Math.PI/180}_polymorphicDegToRad(t){return Ui(t,this._degToRad)}}return s.ClassName="FGDegToRadBlock",s})();P(Yb.ClassName,Yb);var $b=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicRadToDeg(i),s.ClassName,t)}_radToDeg(t){return t*180/Math.PI}_polymorphicRadToDeg(t){return Ui(t,this._radToDeg)}}return s.ClassName="FGRadToDegBlock",s})();P($b.ClassName,$b);var jb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicSin(i),s.ClassName,t)}_polymorphicSin(t){return Ui(t,Math.sin)}}return s.ClassName="FGSinBlock",s})();P(jb.ClassName,jb);var qb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicCos(i),s.ClassName,t)}_polymorphicCos(t){return Ui(t,Math.cos)}}return s.ClassName="FGCosBlock",s})();P(qb.ClassName,qb);var Qb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicTan(i),s.ClassName,t)}_polymorphicTan(t){return Ui(t,Math.tan)}}return s.ClassName="FGTanBlock",s})();P(Qb.ClassName,Qb);var Kb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicAsin(i),s.ClassName,t)}_polymorphicAsin(t){return Ui(t,Math.asin)}}return s.ClassName="FGAsinBlock",s})();P(Kb.ClassName,Kb);var Zb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicAcos(i),s.ClassName,t)}_polymorphicAcos(t){return Ui(t,Math.acos)}}return s.ClassName="FGAcosBlock",s})();P(Zb.ClassName,Zb);var Jb=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicAtan(i),s.ClassName,t)}_polymorphicAtan(t){return Ui(t,Math.atan)}}return s.ClassName="FGAtanBlock",s})();P(Jb.ClassName,Jb);var eS=(()=>{class s extends Ni{constructor(t){super(be,be,be,(i,r)=>this._polymorphicAtan2(i,r),s.ClassName,t)}_polymorphicAtan2(t,i){return pg(t,i,Math.atan2)}}return s.ClassName="FGAtan2Block",s})();P(eS.ClassName,eS);var tS=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicSinh(i),s.ClassName,t)}_polymorphicSinh(t){return Ui(t,Math.sinh)}}return s.ClassName="FGSinhBlock",s})();P(tS.ClassName,tS);var iS=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicCosh(i),s.ClassName,t)}_polymorphicCosh(t){return Ui(t,Math.cosh)}}return s.ClassName="FGCoshBlock",s})();P(iS.ClassName,iS);var rS=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicTanh(i),s.ClassName,t)}_polymorphicTanh(t){return Ui(t,Math.tanh)}}return s.ClassName="FGTanhBlock",s})();P(rS.ClassName,rS);var sS=(()=>{class s extends wt{constructor(t){super(be,Ot,i=>this._polymorphicAsinh(i),s.ClassName,t)}_polymorphicAsinh(t){return Ui(t,Math.asinh)}}return s.ClassName="FGAsinhBlock",s})();P(sS.ClassName,sS);var nS=(()=>{class s extends wt{constructor(t){super(be,Ot,i=>this._polymorphicAcosh(i),s.ClassName,t)}_polymorphicAcosh(t){return Ui(t,Math.acosh)}}return s.ClassName="FGAcoshBlock",s})();P(nS.ClassName,nS);var oS=(()=>{class s extends wt{constructor(t){super(be,Ot,i=>this._polymorphicAtanh(i),s.ClassName,t)}_polymorphicAtanh(t){return Ui(t,Math.atanh)}}return s.ClassName="FGAtanhBlock",s})();P(oS.ClassName,oS);var aS=(()=>{class s extends wt{constructor(t){super(be,Ot,i=>this._polymorphicExp(i),s.ClassName,t)}_polymorphicExp(t){return Ui(t,Math.exp)}}return s.ClassName="FGExpBlock",s})();P(aS.ClassName,aS);var lS=(()=>{class s extends wt{constructor(t){super(be,Ot,i=>this._polymorphicLog(i),s.ClassName,t)}_polymorphicLog(t){return Ui(t,Math.log)}}return s.ClassName="FGLogBlock",s})();P(lS.ClassName,lS);var cS=(()=>{class s extends wt{constructor(t){super(be,Ot,i=>this._polymorphicLog2(i),s.ClassName,t)}_polymorphicLog2(t){return Ui(t,Math.log2)}}return s.ClassName="FGLog2Block",s})();P(cS.ClassName,cS);var hS=(()=>{class s extends wt{constructor(t){super(be,Ot,i=>this._polymorphicLog10(i),s.ClassName,t)}_polymorphicLog10(t){return Ui(t,Math.log10)}}return s.ClassName="FGLog10Block",s})();P(hS.ClassName,hS);var uS=(()=>{class s extends wt{constructor(t){super(be,Ot,i=>this._polymorphicSqrt(i),s.ClassName,t)}_polymorphicSqrt(t){return Ui(t,Math.sqrt)}}return s.ClassName="FGSqrtBlock",s})();P(uS.ClassName,uS);var dS=(()=>{class s extends wt{constructor(t){super(be,Ot,i=>this._polymorphicCubeRoot(i),s.ClassName,t)}_polymorphicCubeRoot(t){return Ui(t,Math.cbrt)}}return s.ClassName="FGCubeRootBlock",s})();P(dS.ClassName,dS);var fS=(()=>{class s extends Ni{constructor(t){super(be,Ot,Ot,(i,r)=>this._polymorphicPow(i,r),s.ClassName,t)}_polymorphicPow(t,i){return pg(t,i,Math.pow)}}return s.ClassName="FGPowBlock",s})();P(fS.ClassName,fS);var pS=(()=>{class s extends wt{constructor(t){super(be,Ot,i=>this._polymorphicLength(i),s.ClassName,t)}_polymorphicLength(t){switch(Lr(t)){case"Vector2":case"Vector3":case"Vector4":return t.length();default:throw new Error(`Cannot compute length of value ${t}`)}}}return s.ClassName="FGLengthBlock",s})();P(pS.ClassName,pS);var mS=(()=>{class s extends wt{constructor(t){super(be,be,i=>this._polymorphicNormalize(i),s.ClassName,t)}_polymorphicNormalize(t){switch(Lr(t)){case"Vector2":case"Vector3":case"Vector4":return t.normalize();default:throw new Error(`Cannot normalize value ${t}`)}}}return s.ClassName="FGNormalizeBlock",s})();P(mS.ClassName,mS);var gS=(()=>{class s extends Ni{constructor(t){super(Uo,Uo,Uo,(i,r)=>p.Cross(i,r),s.ClassName,t)}}return s.ClassName="FGCrossBlock",s})();P(gS.ClassName,gS);var _S=(()=>{class s extends Ni{constructor(t){super(cb,Ot,cb,(i,r)=>j.Transform(i,N.RotationZ(r)),s.ClassName,t)}}return s.ClassName="FGRotate2DBlock",s})();P(_S.ClassName,_S);var xS=(()=>{class s extends Mf{constructor(t){super(Uo,Uo,Ot,Uo,(i,r,n)=>p.TransformCoordinates(i,N.RotationAxis(r,n)),s.ClassName,t)}}return s.ClassName="FGRotate3DBlock",s})();P(xS.ClassName,xS);var vS=(()=>{class s extends wt{constructor(t){super(xl,xl,i=>N.Transpose(i),s.ClassName,t)}}return s.ClassName="FGTransposeBlock",s})();P(vS.ClassName,vS);var TS=(()=>{class s extends wt{constructor(t){super(xl,Ot,i=>i.determinant(),s.ClassName,t)}}return s.ClassName="FGDeterminantBlock",s})();P(TS.ClassName,TS);var CS=(()=>{class s extends wt{constructor(t){super(xl,xl,i=>N.Invert(i),s.ClassName,t)}}return s.ClassName="FGInvertMatrixBlock",s})();P(CS.ClassName,CS);var bS=(()=>{class s extends Ni{constructor(t){super(xl,xl,xl,(i,r)=>r.multiply(i),s.ClassName,t)}}return s.ClassName="FGMatMulBlock",s})();P(bS.ClassName,bS);var SS=(()=>{class s extends wt{constructor(t){super(Pi,Pi,i=>new ur(~i.value),s.ClassName,t)}}return s.ClassName="FGBitwiseNotBlock",s})();P(SS.ClassName,SS);var yS=(()=>{class s extends Ni{constructor(t){super(Pi,Pi,Pi,(i,r)=>new ur(i.value&r.value),s.ClassName,t)}}return s.ClassName="FGBitwiseAndBlock",s})();P(yS.ClassName,yS);var ES=(()=>{class s extends Ni{constructor(t){super(Pi,Pi,Pi,(i,r)=>new ur(i.value|r.value),s.ClassName,t)}}return s.ClassName="FGBitwiseOrBlock",s})();P(ES.ClassName,ES);var AS=(()=>{class s extends Ni{constructor(t){super(Pi,Pi,Pi,(i,r)=>new ur(i.value^r.value),s.ClassName,t)}}return s.ClassName="FGBitwiseXorBlock",s})();P(AS.ClassName,AS);var IS=(()=>{class s extends Ni{constructor(t){super(Pi,Pi,Pi,(i,r)=>new ur(i.value<<r.value),s.ClassName,t)}}return s.ClassName="FGBitwiseLeftShiftBlock",s})();P(IS.ClassName,IS);var RS=(()=>{class s extends Ni{constructor(t){super(Pi,Pi,Pi,(i,r)=>new ur(i.value>>r.value),s.ClassName,t)}}return s.ClassName="FGBitwiseRightShiftBlock",s})();P(RS.ClassName,RS);var PS=(()=>{class s extends wt{constructor(t){super(Pi,Pi,i=>new ur(Math.clz32(i.value)),s.ClassName,t)}}return s.ClassName="FGCountLeadingZerosBlock",s})();P(PS.ClassName,PS);var MS=(()=>{class s extends wt{constructor(t){super(Pi,Pi,i=>new ur(i.value?31-Math.clz32(i.value&-i.value):32),s.ClassName,t)}}return s.ClassName="FGCountTrailingZerosBlock",s})();P(MS.ClassName,MS);function wZ(s){let e=0;for(;s;)e+=s&1,s>>=1;return e}var DS=(()=>{class s extends wt{constructor(t){super(Pi,Pi,i=>new ur(wZ(i.value)),s.ClassName,t)}}return s.ClassName="FGCountOneBitsBlock",s})();P(DS.ClassName,DS);var JM=(()=>{class s extends to{_preparePendingTasks(t){if(!t._getExecutionVariable(this,"sceneReadyObserver")){let r=t.configuration.scene.onReadyObservable.add(()=>{this._execute(t)});t._setExecutionVariable(this,"sceneReadyObserver",r)}}_cancelPendingTasks(t){let i=t._getExecutionVariable(this,"sceneReadyObserver");t.configuration.scene.onReadyObservable.remove(i),t._deleteExecutionVariable(this,"sceneReadyObserver")}getClassName(){return s.ClassName}}return s.ClassName="FGSceneReadyEventBlock",s})();P("FGSceneReadyEventBlock",JM);var wS=(()=>{class s extends to{constructor(t){super(t),this.config=t;for(let i=0;i<this.config.eventData.length;i++){let r=this.config.eventData[i];this.registerDataOutput(r,be)}}_preparePendingTasks(t){let i=t.configuration.coordinator.getCustomEventObservable(this.config.eventId);this._eventObserver=i.add(r=>{for(let n=0;n<r.length;n++)this.dataOutputs[n].setValue(r[n],t);this._execute(t)})}_cancelPendingTasks(t){let i=t.configuration.coordinator.getCustomEventObservable(this.config.eventId);i?i.remove(this._eventObserver):H.Warn(`FlowGraphReceiveCustomEventBlock: Missing observable for event ${this.config.eventId}`)}getClassName(){return s.ClassName}serialize(t){super.serialize(t),t.eventId=this.config.eventId,t.eventData=this.config.eventData}}return s.ClassName="FGReceiveCustomEventBlock",s})();P(wS.ClassName,wS);var NS=(()=>{class s extends to{_preparePendingTasks(t){if(!t._getExecutionVariable(this,"sceneBeforeRender")){let r=t.configuration.scene.onBeforeRenderObservable.add(()=>{this._execute(t)});t._setExecutionVariable(this,"sceneBeforeRender",r)}}_cancelPendingTasks(t){let i=t._getExecutionVariable(this,"sceneBeforeRender");t.configuration.scene.onBeforeRenderObservable.remove(i),t._deleteExecutionVariable(this,"sceneBeforeRender")}getClassName(){return s.ClassName}}return s.ClassName="FGSceneTickEventBlock",s})();P(NS.ClassName,NS);function eD(s,e,t,i){let r={externalResourceFunction:i};return t&&(r.uri=e==="file:"?t:e+t),ArrayBuffer.isView(s)?GLTFValidator.validateBytes(s,r):GLTFValidator.validateString(s,r)}function NZ(){let s=[];onmessage=e=>{let t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{eD(t.data,t.rootUrl,t.fileName,i=>new Promise((r,n)=>{let o=s.length;s.push({resolve:r,reject:n}),postMessage({id:"getExternalResource",index:o,uri:i})})).then(i=>{postMessage({id:"validate.resolve",value:i})},i=>{postMessage({id:"validate.reject",reason:i})});break}case"getExternalResource.resolve":{s[t.index].resolve(t.value);break}case"getExternalResource.reject":{s[t.index].reject(t.reason);break}}}}var mg=class{static ValidateAsync(e,t,i,r){return typeof Worker=="function"?new Promise((n,o)=>{let a=`${eD}(${NZ})()`,l=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),c=new Worker(l),h=d=>{c.removeEventListener("error",h),c.removeEventListener("message",u),o(d)},u=d=>{let f=d.data;switch(f.id){case"getExternalResource":{r(f.uri).then(m=>{c.postMessage({id:"getExternalResource.resolve",index:f.index,value:m},[m.buffer])},m=>{c.postMessage({id:"getExternalResource.reject",index:f.index,reason:m})});break}case"validate.resolve":{c.removeEventListener("error",h),c.removeEventListener("message",u),n(f.value),c.terminate();break}case"validate.reject":c.removeEventListener("error",h),c.removeEventListener("message",u),o(f.reason),c.terminate()}};if(c.addEventListener("error",h),c.addEventListener("message",u),c.postMessage({id:"init",url:H.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){let d=e.slice();c.postMessage({id:"validate",data:d,rootUrl:t,fileName:i},[d.buffer])}else c.postMessage({id:"validate",data:e,rootUrl:t,fileName:i})}):(this._LoadScriptPromise||(this._LoadScriptPromise=H.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>eD(e,t,i,r)))}};mg.Configuration={url:`${H._DefaultCdnUrl}/gltf_validator.js`};function l2(s,e,t){try{return Promise.resolve(new Uint8Array(s,e,t))}catch(i){return Promise.reject(i)}}function FZ(s,e,t){try{if(e<0||e>=s.byteLength)throw new RangeError("Offset is out of range.");if(e+t>s.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(s.buffer,s.byteOffset+e,t))}catch(i){return Promise.reject(i)}}var gg=function(s){return s[s.AUTO=0]="AUTO",s[s.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED",s}(gg||{}),Df=function(s){return s[s.NONE=0]="NONE",s[s.FIRST=1]="FIRST",s[s.ALL=2]="ALL",s}(Df||{}),tn=function(s){return s[s.LOADING=0]="LOADING",s[s.READY=1]="READY",s[s.COMPLETE=2]="COMPLETE",s}(tn||{}),Ra=(()=>{class s{constructor(){this.onParsedObservable=new U,this.coordinateSystemMode=gg.AUTO,this.animationStartMode=Df.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=t=>Promise.resolve(t),this.onMeshLoadedObservable=new U,this.onSkinLoadedObservable=new U,this.onTextureLoadedObservable=new U,this.onMaterialLoadedObservable=new U,this.onCameraLoadedObservable=new U,this.onCompleteObservable=new U,this.onErrorObservable=new U,this.onDisposeObservable=new U,this.onExtensionLoadedObservable=new U,this.validate=!1,this.onValidatedObservable=new U,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new U,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(t){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(t)}set onMeshLoaded(t){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(t)}set onTextureLoaded(t){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(t)}set onMaterialLoaded(t){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(t)}set onCameraLoaded(t){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(t)}set onComplete(t){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(t)}set onError(t){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(t)}set onDispose(t){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(t)}set onExtensionLoaded(t){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(t)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(t){this._loggingEnabled!==t&&(this._loggingEnabled=t,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(t){this._capturePerformanceCounters!==t&&(this._capturePerformanceCounters=t,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(t){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(t)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(let t of this._requests)t.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=t=>Promise.resolve(t),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(t,i,r,n,o,a,l,c){if(ArrayBuffer.isView(i))return this._loadBinary(t,i,r,n,l,c),null;this._progressCallback=o;let h=i.name||H.GetFilename(i);if(a){if(this.useRangeRequests){this.validate&&F.Warn("glTF validation is not supported when range requests are enabled");let u={abort:()=>{},onCompleteObservable:new U},d={readAsync:(f,m)=>new Promise((g,_)=>{this._loadFile(t,i,x=>{g(new Uint8Array(x))},!0,x=>{_(x)},x=>{x.setRequestHeader("Range",`bytes=${f}-${f+m-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new Vh(d)).then(f=>{u.onCompleteObservable.notifyObservers(u),n(f)},l?f=>l(void 0,f):void 0),u}return this._loadFile(t,i,u=>{this._validate(t,new Uint8Array(u,0,u.byteLength),r,h),this._unpackBinaryAsync(new Vh({readAsync:(d,f)=>l2(u,d,f),byteLength:u.byteLength})).then(d=>{n(d)},l?d=>l(void 0,d):void 0)},!0,l)}else return this._loadFile(t,i,u=>{try{this._validate(t,u,r,h),n({json:this._parseJson(u)})}catch{l&&l()}},!1,l)}_loadBinary(t,i,r,n,o,a){this._validate(t,new Uint8Array(i.buffer,i.byteOffset,i.byteLength),r,a),this._unpackBinaryAsync(new Vh({readAsync:(l,c)=>FZ(i,l,c),byteLength:i.byteLength})).then(l=>{n(l)},o?l=>o(void 0,l):void 0)}importMeshAsync(t,i,r,n,o,a){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(r),this.onParsedObservable.clear(),this._log(`Loading ${a||""}`),this._loader=this._getLoader(r),this._loader.importMeshAsync(t,i,null,r,n,o,a)))}loadAsync(t,i,r,n,o){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(i),this._loader.loadAsync(t,i,r,n,o)))}loadAssetContainerAsync(t,i,r,n,o){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(i),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(i);let a=new md(t),l=[];this.onMaterialLoadedObservable.add(d=>{l.push(d)});let c=[];this.onTextureLoadedObservable.add(d=>{c.push(d)});let h=[];this.onCameraLoadedObservable.add(d=>{h.push(d)});let u=[];return this.onMeshLoadedObservable.add(d=>{d.morphTargetManager&&u.push(d.morphTargetManager)}),this._loader.importMeshAsync(null,t,a,i,r,n,o).then(d=>(Array.prototype.push.apply(a.geometries,d.geometries),Array.prototype.push.apply(a.meshes,d.meshes),Array.prototype.push.apply(a.particleSystems,d.particleSystems),Array.prototype.push.apply(a.skeletons,d.skeletons),Array.prototype.push.apply(a.animationGroups,d.animationGroups),Array.prototype.push.apply(a.materials,l),Array.prototype.push.apply(a.textures,c),Array.prototype.push.apply(a.lights,d.lights),Array.prototype.push.apply(a.transformNodes,d.transformNodes),Array.prototype.push.apply(a.cameras,h),Array.prototype.push.apply(a.morphTargetManagers,u),a))})}canDirectLoad(t){return t.indexOf("asset")!==-1&&t.indexOf("version")!==-1||t.startsWith("data:base64,"+s._MagicBase64Encoded)||t.startsWith("data:;base64,"+s._MagicBase64Encoded)||t.startsWith("data:application/octet-stream;base64,"+s._MagicBase64Encoded)||t.startsWith("data:model/gltf-binary;base64,"+s._MagicBase64Encoded)}directLoad(t,i){if(i.startsWith("base64,"+s._MagicBase64Encoded)||i.startsWith(";base64,"+s._MagicBase64Encoded)||i.startsWith("application/octet-stream;base64,"+s._MagicBase64Encoded)||i.startsWith("model/gltf-binary;base64,"+s._MagicBase64Encoded)){let r=Ag(i);return this._validate(t,new Uint8Array(r,0,r.byteLength)),this._unpackBinaryAsync(new Vh({readAsync:(n,o)=>l2(r,n,o),byteLength:r.byteLength}))}return this._validate(t,i),Promise.resolve({json:this._parseJson(i)})}createPlugin(){return new s}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((t,i)=>{this.onCompleteObservable.addOnce(()=>{t()}),this.onErrorObservable.addOnce(r=>{i(r)})})}_setState(t){this._state!==t&&(this._state=t,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(tn[this._state]))}_loadFile(t,i,r,n,o,a){let l=t._loadFile(i,r,c=>{this._onProgress(c,l)},!0,n,o,a);return l.onCompleteObservable.add(()=>{l._lengthComputable=!0,l._total=l._loaded}),this._requests.push(l),l}_onProgress(t,i){if(!this._progressCallback)return;i._lengthComputable=t.lengthComputable,i._loaded=t.loaded,i._total=t.total;let r=!0,n=0,o=0;for(let a of this._requests){if(a._lengthComputable===void 0||a._loaded===void 0||a._total===void 0)return;r=r&&a._lengthComputable,n+=a._loaded,o+=a._total}this._progressCallback({lengthComputable:r,loaded:n,total:r?o:0})}_validate(t,i,r="",n=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),mg.ValidateAsync(i,r,n,o=>this.preprocessUrlAsync(r+o).then(a=>t._loadFileAsync(a,void 0,!0,!0).then(l=>new Uint8Array(l,0,l.byteLength)))).then(o=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(o),this.onValidatedObservable.clear()},o=>{this._endPerformanceCounter("Validate JSON"),H.Warn(`Failed to validate: ${o.message}`),this.onValidatedObservable.clear()}))}_getLoader(t){let i=t.json.asset||{};this._log(`Asset version: ${i.version}`),i.minVersion&&this._log(`Asset minimum version: ${i.minVersion}`),i.generator&&this._log(`Asset generator: ${i.generator}`);let r=s._parseVersion(i.version);if(!r)throw new Error("Invalid version: "+i.version);if(i.minVersion!==void 0){let a=s._parseVersion(i.minVersion);if(!a)throw new Error("Invalid minimum version: "+i.minVersion);if(s._compareVersion(a,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+i.minVersion)}let o={1:s._CreateGLTF1Loader,2:s._CreateGLTF2Loader}[r.major];if(!o)throw new Error("Unsupported version: "+i.version);return o(this)}_parseJson(t){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${t.length}`);let i=JSON.parse(t);return this._endPerformanceCounter("Parse JSON"),i}_unpackBinaryAsync(t){return this._startPerformanceCounter("Unpack Binary"),t.loadAsync(20).then(()=>{let i={Magic:1179937895},r=t.readUint32();if(r!==i.Magic)throw new Wo("Unexpected magic: "+r,zo.GLTFLoaderUnexpectedMagicError);let n=t.readUint32();this.loggingEnabled&&this._log(`Binary version: ${n}`);let o=t.readUint32();!this.useRangeRequests&&o!==t.buffer.byteLength&&F.Warn(`Length in header does not match actual data length: ${o} != ${t.buffer.byteLength}`);let a;switch(n){case 1:{a=this._unpackBinaryV1Async(t,o);break}case 2:{a=this._unpackBinaryV2Async(t,o);break}default:throw new Error("Unsupported version: "+n)}return this._endPerformanceCounter("Unpack Binary"),a})}_unpackBinaryV1Async(t,i){let r={JSON:0},n=t.readUint32(),o=t.readUint32();if(o!==r.JSON)throw new Error(`Unexpected content format: ${o}`);let a=i-t.byteOffset,l={json:this._parseJson(t.readString(n)),bin:null};if(a!==0){let c=t.byteOffset;l.bin={readAsync:(h,u)=>t.buffer.readAsync(c+h,u),byteLength:a}}return Promise.resolve(l)}_unpackBinaryV2Async(t,i){let r={JSON:1313821514,BIN:5130562},n=t.readUint32();if(t.readUint32()!==r.JSON)throw new Error("First chunk format is not JSON");return t.byteOffset+n===i?t.loadAsync(n).then(()=>({json:this._parseJson(t.readString(n)),bin:null})):t.loadAsync(n+8).then(()=>{let a={json:this._parseJson(t.readString(n)),bin:null},l=()=>{let c=t.readUint32();switch(t.readUint32()){case r.JSON:throw new Error("Unexpected JSON chunk");case r.BIN:{let u=t.byteOffset;a.bin={readAsync:(d,f)=>t.buffer.readAsync(u+d,f),byteLength:c},t.skipBytes(c);break}default:{t.skipBytes(c);break}}return t.byteOffset!==i?t.loadAsync(8).then(l):Promise.resolve(a)};return l()})}static _parseVersion(t){if(t==="1.0"||t==="1.0.1")return{major:1,minor:0};let i=(t+"").match(/^(\d+)\.(\d+)/);return i?{major:parseInt(i[1]),minor:parseInt(i[2])}:null}static _compareVersion(t,i){return t.major>i.major?1:t.major<i.major?-1:t.minor>i.minor?1:t.minor<i.minor?-1:0}_logOpen(t){this._log(t),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(t){let i=s._logSpaces.substr(0,this._logIndentLevel*2);F.Log(`${i}${t}`)}_logDisabled(t){}_startPerformanceCounterEnabled(t){H.StartPerformanceCounter(t)}_startPerformanceCounterDisabled(t){}_endPerformanceCounterEnabled(t){H.EndPerformanceCounter(t)}_endPerformanceCounterDisabled(t){}}return s.IncrementalLoading=!0,s.HomogeneousCoordinates=!1,s._MagicBase64Encoded="Z2xURg",s._logSpaces="                                ",s})();Mt&&Mt.RegisterPlugin(new Ra);var Tl=function(s){return s[s.BYTE=5120]="BYTE",s[s.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",s[s.SHORT=5122]="SHORT",s[s.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",s[s.FLOAT=5126]="FLOAT",s}(Tl||{}),tD=function(s){return s[s.FRAGMENT=35632]="FRAGMENT",s[s.VERTEX=35633]="VERTEX",s}(tD||{}),As=function(s){return s[s.BYTE=5120]="BYTE",s[s.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",s[s.SHORT=5122]="SHORT",s[s.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",s[s.INT=5124]="INT",s[s.UNSIGNED_INT=5125]="UNSIGNED_INT",s[s.FLOAT=5126]="FLOAT",s[s.FLOAT_VEC2=35664]="FLOAT_VEC2",s[s.FLOAT_VEC3=35665]="FLOAT_VEC3",s[s.FLOAT_VEC4=35666]="FLOAT_VEC4",s[s.INT_VEC2=35667]="INT_VEC2",s[s.INT_VEC3=35668]="INT_VEC3",s[s.INT_VEC4=35669]="INT_VEC4",s[s.BOOL=35670]="BOOL",s[s.BOOL_VEC2=35671]="BOOL_VEC2",s[s.BOOL_VEC3=35672]="BOOL_VEC3",s[s.BOOL_VEC4=35673]="BOOL_VEC4",s[s.FLOAT_MAT2=35674]="FLOAT_MAT2",s[s.FLOAT_MAT3=35675]="FLOAT_MAT3",s[s.FLOAT_MAT4=35676]="FLOAT_MAT4",s[s.SAMPLER_2D=35678]="SAMPLER_2D",s}(As||{}),_g=function(s){return s[s.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",s[s.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",s[s.REPEAT=10497]="REPEAT",s}(_g||{}),io=function(s){return s[s.NEAREST=9728]="NEAREST",s[s.LINEAR=9728]="LINEAR",s[s.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",s[s.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",s[s.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",s[s.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",s}(io||{});var iD=function(s){return s[s.FRONT=1028]="FRONT",s[s.BACK=1029]="BACK",s[s.FRONT_AND_BACK=1032]="FRONT_AND_BACK",s}(iD||{}),qi=function(s){return s[s.ZERO=0]="ZERO",s[s.ONE=1]="ONE",s[s.SRC_COLOR=768]="SRC_COLOR",s[s.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",s[s.DST_COLOR=774]="DST_COLOR",s[s.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",s[s.SRC_ALPHA=770]="SRC_ALPHA",s[s.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",s[s.DST_ALPHA=772]="DST_ALPHA",s[s.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",s[s.CONSTANT_COLOR=32769]="CONSTANT_COLOR",s[s.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",s[s.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",s[s.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",s[s.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",s}(qi||{});var Is=(()=>{class s{static SetMatrix(t,i,r,n,o){let a=null;if(r.semantic==="MODEL"?a=i.getWorldMatrix():r.semantic==="PROJECTION"?a=t.getProjectionMatrix():r.semantic==="VIEW"?a=t.getViewMatrix():r.semantic==="MODELVIEWINVERSETRANSPOSE"?a=N.Transpose(i.getWorldMatrix().multiply(t.getViewMatrix()).invert()):r.semantic==="MODELVIEW"?a=i.getWorldMatrix().multiply(t.getViewMatrix()):r.semantic==="MODELVIEWPROJECTION"?a=i.getWorldMatrix().multiply(t.getTransformMatrix()):r.semantic==="MODELINVERSE"?a=i.getWorldMatrix().invert():r.semantic==="VIEWINVERSE"?a=t.getViewMatrix().invert():r.semantic==="PROJECTIONINVERSE"?a=t.getProjectionMatrix().invert():r.semantic==="MODELVIEWINVERSE"?a=i.getWorldMatrix().multiply(t.getViewMatrix()).invert():r.semantic==="MODELVIEWPROJECTIONINVERSE"?a=i.getWorldMatrix().multiply(t.getTransformMatrix()).invert():r.semantic==="MODELINVERSETRANSPOSE"&&(a=N.Transpose(i.getWorldMatrix().invert())),a)switch(r.type){case As.FLOAT_MAT2:o.setMatrix2x2(n,N.GetAsMatrix2x2(a));break;case As.FLOAT_MAT3:o.setMatrix3x3(n,N.GetAsMatrix3x3(a));break;case As.FLOAT_MAT4:o.setMatrix(n,a);break;default:break}}static SetUniform(t,i,r,n){switch(n){case As.FLOAT:return t.setFloat(i,r),!0;case As.FLOAT_VEC2:return t.setVector2(i,j.FromArray(r)),!0;case As.FLOAT_VEC3:return t.setVector3(i,p.FromArray(r)),!0;case As.FLOAT_VEC4:return t.setVector4(i,De.FromArray(r)),!0;default:return!1}}static GetWrapMode(t){switch(t){case _g.CLAMP_TO_EDGE:return z.CLAMP_ADDRESSMODE;case _g.MIRRORED_REPEAT:return z.MIRROR_ADDRESSMODE;case _g.REPEAT:return z.WRAP_ADDRESSMODE;default:return z.WRAP_ADDRESSMODE}}static GetByteStrideFromType(t){switch(t.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(t){switch(t){case io.LINEAR:case io.LINEAR_MIPMAP_NEAREST:case io.LINEAR_MIPMAP_LINEAR:return z.TRILINEAR_SAMPLINGMODE;case io.NEAREST:case io.NEAREST_MIPMAP_NEAREST:return z.NEAREST_SAMPLINGMODE;default:return z.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(t,i,r,n,o){r=i.byteOffset+r;let a=t.loadedBufferViews[i.buffer];if(r+n>a.byteLength)throw new Error("Buffer access is out of range");let l=a.buffer;switch(r+=a.byteOffset,o){case Tl.BYTE:return new Int8Array(l,r,n);case Tl.UNSIGNED_BYTE:return new Uint8Array(l,r,n);case Tl.SHORT:return new Int16Array(l,r,n);case Tl.UNSIGNED_SHORT:return new Uint16Array(l,r,n);default:return new Float32Array(l,r,n)}}static GetBufferFromAccessor(t,i){let r=t.bufferViews[i.bufferView],n=i.count*s.GetByteStrideFromType(i);return s.GetBufferFromBufferView(t,r,i.byteOffset,n,i.componentType)}static DecodeBufferToText(t){let i="",r=t.byteLength;for(let n=0;n<r;++n)i+=String.fromCharCode(t[n]);return i}static GetDefaultMaterial(t){if(!s._DefaultMaterial){$t.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),$t.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);let i={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},r={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};s._DefaultMaterial=new Fi("GLTFDefaultMaterial",t,i,r),s._DefaultMaterial.setColor4("u_emission",new oe(.5,.5,.5,1))}return s._DefaultMaterial}}return s._DefaultMaterial=null,s})();var su=function(s){return s[s.IDENTIFIER=1]="IDENTIFIER",s[s.UNKNOWN=2]="UNKNOWN",s[s.END_OF_INPUT=3]="END_OF_INPUT",s}(su||{}),FS=class{constructor(e){this._pos=0,this.currentToken=su.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return su.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=su.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=su.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}},p2=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],m2=["world","view","projection","worldView","worldViewProjection","mBones"],LZ=["translation","rotation","scale"],BZ=["position","rotationQuaternion","scaling"],VZ=(s,e)=>{for(let t in s){let i=s[t];e.buffers[t]=i,e.buffersCount++}},UZ=(s,e)=>{for(let t in s){let i=s[t];e.shaders[t]=i,e.shaderscount++}},Rs=(s,e,t)=>{for(let i in s){let r=s[i];t[e][i]=r}},kZ=s=>{if(s)for(let e=0;e<s.length/2;e++)s[e*2+1]=1-s[e*2+1]},c2=s=>{if(s.semantic==="NORMAL")return"normal";if(s.semantic==="POSITION")return"position";if(s.semantic==="JOINT")return"matricesIndices";if(s.semantic==="WEIGHT")return"matricesWeights";if(s.semantic==="COLOR")return"color";if(s.semantic&&s.semantic.indexOf("TEXCOORD_")!==-1){let e=Number(s.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},GZ=s=>{for(let e in s.animations){let t=s.animations[e];if(!t.channels||!t.samplers)continue;let i=null;for(let r=0;r<t.channels.length;r++){let n=t.channels[r],o=t.samplers[n.sampler];if(!o)continue;let a=null,l=null;t.parameters?(a=t.parameters[o.input],l=t.parameters[o.output]):(a=o.input,l=o.output);let c=Is.GetBufferFromAccessor(s,s.accessors[a]),h=Is.GetBufferFromAccessor(s,s.accessors[l]),u=n.target.id,d=s.scene.getNodeById(u);if(d===null&&(d=s.scene.getNodeByName(u)),d===null){H.Warn("Creating animation named "+e+". But cannot find node named "+u+" to attach to");continue}let f=d instanceof ss,m=n.target.path,g=LZ.indexOf(m);g!==-1&&(m=BZ[g]);let _=te.ANIMATIONTYPE_MATRIX;f||(m==="rotationQuaternion"?(_=te.ANIMATIONTYPE_QUATERNION,d.rotationQuaternion=new q):_=te.ANIMATIONTYPE_VECTOR3);let x=null,b=[],C=0,R=!1;f&&i&&i.getKeys().length===c.length&&(x=i,R=!0),R||(s.scene._blockEntityCollection=!!s.assetContainer,x=new te(e,f?"_matrix":m,1,_,te.ANIMATIONLOOPMODE_CYCLE),s.scene._blockEntityCollection=!1);for(let E=0;E<c.length;E++){let S=null;if(m==="rotationQuaternion"?(S=q.FromArray([h[C],h[C+1],h[C+2],h[C+3]]),C+=4):(S=p.FromArray([h[C],h[C+1],h[C+2]]),C+=3),f){let A=d,L=p.Zero(),G=new q,W=p.Zero(),$=A.getBaseMatrix();R&&i&&($=i.getKeys()[E].value),$.decompose(W,G,L),m==="position"?L=S:m==="rotationQuaternion"?G=S:W=S,S=N.Compose(W,G,L)}R?i&&(i.getKeys()[E].value=S):b.push({frame:c[E],value:S})}!R&&x&&(x.setKeys(b),d.animations.push(x)),i=x,s.scene.stopAnimation(d),s.scene.beginAnimation(d,0,c[c.length-1],!0,1)}}},nD=s=>{let e=null;if(s.translation||s.rotation||s.scale){let t=p.FromArray(s.scale||[1,1,1]),i=q.FromArray(s.rotation||[0,0,0,1]),r=p.FromArray(s.translation||[0,0,0]);e=N.Compose(t,i,r)}else e=N.FromArray(s.matrix);return e},g2=(s,e,t,i)=>{for(let n=0;n<i.bones.length;n++)if(i.bones[n].name===t)return i.bones[n];let r=s.nodes;for(let n in r){let o=r[n];if(!o.jointName)continue;let a=o.children;for(let l=0;l<a.length;l++){let c=s.nodes[a[l]];if(c.jointName&&c.jointName===t){let h=nD(o),u=new ss(o.name||"",i,g2(s,e,o.jointName,i),h);return u.id=n,u}}}return null},zZ=(s,e)=>{for(let t=0;t<s.length;t++){let i=s[t];for(let r=0;r<i.node.children.length;r++)if(i.node.children[r]===e)return i.bone}return null},rD=(s,e)=>{let t=s.nodes,i=t[e];if(i)return{node:i,id:e};for(let r in t)if(i=t[r],i.jointName===e)return{node:i,id:r};return null},WZ=(s,e)=>{for(let t=0;t<s.jointNames.length;t++)if(s.jointNames[t]===e)return!0;return!1},HZ=(s,e,t,i)=>{for(let r in s.nodes){let n=s.nodes[r],o=r;if(!n.jointName||WZ(t,n.jointName))continue;let a=nD(n),l=new ss(n.name||"",e,null,a);l.id=o,i.push({bone:l,node:n,id:o})}for(let r=0;r<i.length;r++){let n=i[r],o=n.node.children;for(let a=0;a<o.length;a++){let l=null;for(let c=0;c<i.length;c++)if(i[c].id===o[a]){l=i[c];break}l&&(l.bone._parent=n.bone,n.bone.children.push(l.bone))}}},XZ=(s,e,t,i)=>{if(i||(i=new Xn(e.name||"","",s.scene)),!e.babylonSkeleton)return i;let r=[],n=[];HZ(s,i,e,r),i.bones=[];for(let a=0;a<e.jointNames.length;a++){let l=rD(s,e.jointNames[a]);if(!l)continue;let c=l.node;if(!c){H.Warn("Joint named "+e.jointNames[a]+" does not exist");continue}let h=l.id,u=s.scene.getBoneById(h);if(u){i.bones.push(u);continue}let d=!1,f=null;for(let _=0;_<a;_++){let x=rD(s,e.jointNames[_]);if(!x)continue;let b=x.node;if(!b){H.Warn("Joint named "+e.jointNames[_]+" does not exist when looking for parent");continue}let C=b.children;if(C){d=!1;for(let R=0;R<C.length;R++)if(C[R]===h){f=g2(s,e,e.jointNames[_],i),d=!0;break}if(d)break}}let m=nD(c);!f&&r.length>0&&(f=zZ(r,h),f&&n.indexOf(f)===-1&&n.push(f));let g=new ss(c.jointName||"",i,f,m);g.id=h}let o=i.bones;i.bones=[];for(let a=0;a<e.jointNames.length;a++){let l=rD(s,e.jointNames[a]);if(l){for(let c=0;c<o.length;c++)if(o[c].id===l.id){i.bones.push(o[c]);break}}}i.prepare();for(let a=0;a<n.length;a++)i.bones.push(n[a]);return i},h2=(s,e,t,i,r)=>{if(r||(s.scene._blockEntityCollection=!!s.assetContainer,r=new k(e.name||"",s.scene),r._parentContainer=s.assetContainer,s.scene._blockEntityCollection=!1,r.id=i),!e.babylonNode)return r;let n=[],o=null,a=[],l=[],c=[],h=[];for(let f=0;f<t.length;f++){let m=t[f],g=s.meshes[m];if(g)for(let _=0;_<g.primitives.length;_++){let x=new le,b=g.primitives[_];b.mode;let C=b.attributes,R=null,E=null;for(let A in C)if(R=s.accessors[C[A]],E=Is.GetBufferFromAccessor(s,R),A==="NORMAL")x.normals=new Float32Array(E.length),x.normals.set(E);else if(A==="POSITION"){if(Ra.HomogeneousCoordinates){x.positions=new Float32Array(E.length-E.length/4);for(let L=0;L<E.length;L+=4)x.positions[L]=E[L],x.positions[L+1]=E[L+1],x.positions[L+2]=E[L+2]}else x.positions=new Float32Array(E.length),x.positions.set(E);l.push(x.positions.length)}else if(A.indexOf("TEXCOORD_")!==-1){let L=Number(A.split("_")[1]),G=y.UVKind+(L===0?"":L+1),W=new Float32Array(E.length);W.set(E),kZ(W),x.set(W,G)}else A==="JOINT"?(x.matricesIndices=new Float32Array(E.length),x.matricesIndices.set(E)):A==="WEIGHT"?(x.matricesWeights=new Float32Array(E.length),x.matricesWeights.set(E)):A==="COLOR"&&(x.colors=new Float32Array(E.length),x.colors.set(E));if(R=s.accessors[b.indices],R)E=Is.GetBufferFromAccessor(s,R),x.indices=new Int32Array(E.length),x.indices.set(E),h.push(x.indices.length);else{let A=[];for(let L=0;L<x.positions.length/3;L++)A.push(L);x.indices=new Int32Array(A),h.push(x.indices.length)}o?o.merge(x):o=x;let S=s.scene.getMaterialById(b.material);n.push(S===null?Is.GetDefaultMaterial(s.scene):S),a.push(a.length===0?0:a[a.length-1]+l[l.length-2]),c.push(c.length===0?0:c[c.length-1]+h[h.length-2])}}let u;s.scene._blockEntityCollection=!!s.assetContainer,n.length>1?(u=new Hs("multimat"+i,s.scene),u.subMaterials=n):u=new Ee("multimat"+i,s.scene),n.length===1&&(u=n[0]),u._parentContainer=s.assetContainer,r.material||(r.material=u),new nr(i,s.scene,o,!1,r),r.computeWorldMatrix(!0),s.scene._blockEntityCollection=!1,r.subMeshes=[];let d=0;for(let f=0;f<t.length;f++){let m=t[f],g=s.meshes[m];if(g)for(let _=0;_<g.primitives.length;_++)g.primitives[_].mode,Wi.AddToMesh(d,a[d],l[d],c[d],h[d],r,r,!0),d++}return r},sD=(s,e,t,i)=>{s.position&&(s.position=e),(s.rotationQuaternion||s.rotation)&&(s.rotationQuaternion=t),s.scaling&&(s.scaling=i)},YZ=(s,e)=>{if(e.matrix){let t=new p(0,0,0),i=new q,r=new p(0,0,0);N.FromArray(e.matrix).decompose(r,i,t),sD(s,t,i,r)}else e.translation&&e.rotation&&e.scale&&sD(s,p.FromArray(e.translation),q.FromArray(e.rotation),p.FromArray(e.scale));s.computeWorldMatrix(!0)},$Z=(s,e,t)=>{let i=null;if(s.importOnlyMeshes&&(e.skin||e.meshes)&&s.importMeshesNames&&s.importMeshesNames.length>0&&s.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){let r=s.skins[e.skin],n=h2(s,e,e.meshes,t,e.babylonNode);n.skeleton=s.scene.getLastSkeletonById(e.skin),n.skeleton===null&&(n.skeleton=XZ(s,r,n,r.babylonSkeleton),r.babylonSkeleton||(r.babylonSkeleton=n.skeleton)),i=n}}else if(e.meshes)i=h2(s,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(e.light&&!e.babylonNode&&!s.importOnlyMeshes){let r=s.lights[e.light];if(r){if(r.type==="ambient"){let n=r[r.type],o=new as(e.light,p.Zero(),s.scene);o.name=e.name||"",n.color&&(o.diffuse=X.FromArray(n.color)),i=o}else if(r.type==="directional"){let n=r[r.type],o=new Cr(e.light,p.Zero(),s.scene);o.name=e.name||"",n.color&&(o.diffuse=X.FromArray(n.color)),i=o}else if(r.type==="point"){let n=r[r.type],o=new In(e.light,p.Zero(),s.scene);o.name=e.name||"",n.color&&(o.diffuse=X.FromArray(n.color)),i=o}else if(r.type==="spot"){let n=r[r.type],o=new Hr(e.light,p.Zero(),p.Zero(),0,0,s.scene);o.name=e.name||"",n.color&&(o.diffuse=X.FromArray(n.color)),n.fallOfAngle&&(o.angle=n.fallOfAngle),n.fallOffExponent&&(o.exponent=n.fallOffExponent),i=o}}}else if(e.camera&&!e.babylonNode&&!s.importOnlyMeshes){let r=s.cameras[e.camera];if(r){if(s.scene._blockEntityCollection=!!s.assetContainer,r.type==="orthographic"){let n=new wi(e.camera,p.Zero(),s.scene,!1);n.name=e.name||"",n.mode=Ce.ORTHOGRAPHIC_CAMERA,n.attachControl(),i=n,n._parentContainer=s.assetContainer}else if(r.type==="perspective"){let n=r[r.type],o=new wi(e.camera,p.Zero(),s.scene,!1);o.name=e.name||"",o.attachControl(),n.aspectRatio||(n.aspectRatio=s.scene.getEngine().getRenderWidth()/s.scene.getEngine().getRenderHeight()),n.znear&&n.zfar&&(o.maxZ=n.zfar,o.minZ=n.znear),i=o,o._parentContainer=s.assetContainer}s.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(i===null){s.scene._blockEntityCollection=!!s.assetContainer;let r=new k(e.name||"",s.scene);r._parentContainer=s.assetContainer,s.scene._blockEntityCollection=!1,e.babylonNode=r,i=r}}if(i!==null){if(e.matrix&&i instanceof k)YZ(i,e);else{let r=e.translation||[0,0,0],n=e.rotation||[0,0,0,1],o=e.scale||[1,1,1];sD(i,p.FromArray(r),q.FromArray(n),p.FromArray(o))}i.updateCache(!0),e.babylonNode=i}return i},xg=(s,e,t,i=!1)=>{let r=s.nodes[e],n=null;if(s.importOnlyMeshes&&!i&&s.importMeshesNames?s.importMeshesNames.indexOf(r.name||"")!==-1||s.importMeshesNames.length===0?i=!0:i=!1:i=!0,!r.jointName&&i&&(n=$Z(s,r,e),n!==null&&(n.id=e,n.parent=t)),r.children)for(let o=0;o<r.children.length;o++)xg(s,r.children[o],n,i)},u2=s=>{let e=s.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)xg(s,e.nodes[t],null);else for(let t in s.scenes){e=s.scenes[t];for(let i=0;i<e.nodes.length;i++)xg(s,e.nodes[i],null)}GZ(s);for(let t=0;t<s.scene.skeletons.length;t++){let i=s.scene.skeletons[t];s.scene.beginAnimation(i,0,Number.MAX_VALUE,!0,1)}},jZ=(s,e,t,i,r,n,o)=>{let a=n.values||r.parameters;for(let l in t){let c=t[l],h=c.type;if(h===As.FLOAT_MAT2||h===As.FLOAT_MAT3||h===As.FLOAT_MAT4){if(c.semantic&&!c.source&&!c.node)Is.SetMatrix(e.scene,s,c,l,i.getEffect());else if(c.semantic&&(c.source||c.node)){let u=e.scene.getNodeByName(c.source||c.node||"");if(u===null&&(u=e.scene.getNodeById(c.source||c.node||"")),u===null)continue;Is.SetMatrix(e.scene,u,c,l,i.getEffect())}}else{let u=a[r.uniforms[l]];if(!u)continue;if(h===As.SAMPLER_2D){let d=e.textures[n.values?u:c.value].babylonTexture;if(d==null)continue;i.getEffect().setTexture(l,d)}else Is.SetUniform(i.getEffect(),l,u,h)}}o(i)},qZ=(s,e,t,i,r)=>{let n=i.values||t.parameters,o=t.uniforms;for(let a in r){let l=r[a],c=l.type,h=n[o[a]];if(h===void 0&&(h=l.value),!h)continue;let u=d=>f=>{l.value&&d&&(e.setTexture(d,f),delete r[d])};c===As.SAMPLER_2D?On.LoadTextureAsync(s,i.values?h:l.value,u(a),()=>u(null)):l.value&&Is.SetUniform(e,a,i.values?h:l.value,c)&&delete r[a]}},QZ=(s,e,t)=>(i,r)=>{e.dispose(!0),t("Cannot compile program named "+s.name+". Error: "+r+". Default material will be applied")},KZ=(s,e,t,i,r,n)=>o=>{qZ(s,e,t,i,r),e.onBind=a=>{jZ(a,s,r,e,t,i,n)}},d2=(s,e,t)=>{for(let i in e.uniforms){let r=e.uniforms[i],n=e.parameters[r];if(s.currentIdentifier===i&&n.semantic&&!n.source&&!n.node){let o=p2.indexOf(n.semantic);if(o!==-1)return delete t[i],m2[o]}}return s.currentIdentifier},f2=s=>{for(let e in s.materials)On.LoadMaterialAsync(s,e,()=>{},()=>{})},Dn=class{static CreateRuntime(e,t,i){let r={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:i,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&Rs(e.extensions,"extensions",r),e.extensionsUsed&&Rs(e.extensionsUsed,"extensionsUsed",r),e.buffers&&VZ(e.buffers,r),e.bufferViews&&Rs(e.bufferViews,"bufferViews",r),e.accessors&&Rs(e.accessors,"accessors",r),e.meshes&&Rs(e.meshes,"meshes",r),e.lights&&Rs(e.lights,"lights",r),e.cameras&&Rs(e.cameras,"cameras",r),e.nodes&&Rs(e.nodes,"nodes",r),e.images&&Rs(e.images,"images",r),e.textures&&Rs(e.textures,"textures",r),e.shaders&&UZ(e.shaders,r),e.programs&&Rs(e.programs,"programs",r),e.samplers&&Rs(e.samplers,"samplers",r),e.techniques&&Rs(e.techniques,"techniques",r),e.materials&&Rs(e.materials,"materials",r),e.animations&&Rs(e.animations,"animations",r),e.skins&&Rs(e.skins,"skins",r),e.scenes&&(r.scenes=e.scenes),e.scene&&e.scenes&&(r.currentScene=e.scenes[e.scene]),r}static LoadBufferAsync(e,t,i,r,n){let o=e.buffers[t];H.IsBase64(o.uri)?setTimeout(()=>i(new Uint8Array(H.DecodeBase64(o.uri)))):H.LoadFile(e.rootUrl+o.uri,a=>i(new Uint8Array(a)),n,void 0,!0,a=>{a&&r(a.status+" "+a.statusText)})}static LoadTextureBufferAsync(e,t,i,r){let n=e.textures[t];if(!n||!n.source){r("");return}if(n.babylonTexture){i(null);return}let o=e.images[n.source];H.IsBase64(o.uri)?setTimeout(()=>i(new Uint8Array(H.DecodeBase64(o.uri)))):H.LoadFile(e.rootUrl+o.uri,a=>i(new Uint8Array(a)),void 0,void 0,!0,a=>{a&&r(a.status+" "+a.statusText)})}static CreateTextureAsync(e,t,i,r){let n=e.textures[t];if(n.babylonTexture){r(n.babylonTexture);return}let o=e.samplers[n.sampler],a=o.minFilter===io.NEAREST_MIPMAP_NEAREST||o.minFilter===io.NEAREST_MIPMAP_LINEAR||o.minFilter===io.LINEAR_MIPMAP_NEAREST||o.minFilter===io.LINEAR_MIPMAP_LINEAR,l=z.BILINEAR_SAMPLINGMODE,c=i==null?new Blob:new Blob([i]),h=URL.createObjectURL(c),u=()=>URL.revokeObjectURL(h),d=new z(h,e.scene,!a,!0,l,u,u);o.wrapS!==void 0&&(d.wrapU=Is.GetWrapMode(o.wrapS)),o.wrapT!==void 0&&(d.wrapV=Is.GetWrapMode(o.wrapT)),d.name=t,n.babylonTexture=d,r(d)}static LoadShaderStringAsync(e,t,i,r){let n=e.shaders[t];if(H.IsBase64(n.uri)){let o=atob(n.uri.split(",")[1]);i&&i(o)}else H.LoadFile(e.rootUrl+n.uri,i,void 0,void 0,!1,o=>{o&&r&&r(o.status+" "+o.statusText)})}static LoadMaterialAsync(e,t,i,r){let n=e.materials[t];if(!n.technique){r&&r("No technique found.");return}let o=e.techniques[n.technique];if(!o){e.scene._blockEntityCollection=!!e.assetContainer;let S=new Ee(t,e.scene);S._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,S.diffuseColor=new X(.5,.5,.5),S.sideOrientation=se.CounterClockWiseSideOrientation,i(S);return}let a=e.programs[o.program],l=o.states,c=$t.ShadersStore[a.vertexShader+"VertexShader"],h=$t.ShadersStore[a.fragmentShader+"PixelShader"],u="",d="",f=new FS(c),m=new FS(h),g={},_=[],x=[],b=[];for(let S in o.uniforms){let A=o.uniforms[S],L=o.parameters[A];if(g[S]=L,L.semantic&&!L.node&&!L.source){let G=p2.indexOf(L.semantic);G!==-1?(_.push(m2[G]),delete g[S]):_.push(S)}else L.type===As.SAMPLER_2D?b.push(S):_.push(S)}for(let S in o.attributes){let A=o.attributes[S],L=o.parameters[A];if(L.semantic){let G=c2(L);G&&x.push(G)}}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==su.IDENTIFIER){u+=f.currentString;continue}let A=!1;for(let L in o.attributes){let G=o.attributes[L],W=o.parameters[G];if(f.currentIdentifier===L&&W.semantic){u+=c2(W),A=!0;break}}A||(u+=d2(f,o,g))}for(;!m.isEnd()&&m.getNextToken();){if(m.currentToken!==su.IDENTIFIER){d+=m.currentString;continue}d+=d2(m,o,g)}let C={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},R={attributes:x,uniforms:_,samplers:b,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};$t.ShadersStore[a.vertexShader+t+"VertexShader"]=u,$t.ShadersStore[a.fragmentShader+t+"PixelShader"]=d;let E=new Fi(t,e.scene,C,R);if(E.onError=QZ(a,E,r),E.onCompiled=KZ(e,E,o,n,g,i),E.sideOrientation=se.CounterClockWiseSideOrientation,l&&l.functions){let S=l.functions;S.cullFace&&S.cullFace[0]!==iD.BACK&&(E.backFaceCulling=!1);let A=S.blendFuncSeparate;A&&(A[0]===qi.SRC_ALPHA&&A[1]===qi.ONE_MINUS_SRC_ALPHA&&A[2]===qi.ONE&&A[3]===qi.ONE?E.alphaMode=Za.ALPHA_COMBINE:A[0]===qi.ONE&&A[1]===qi.ONE&&A[2]===qi.ZERO&&A[3]===qi.ONE?E.alphaMode=Za.ALPHA_ONEONE:A[0]===qi.SRC_ALPHA&&A[1]===qi.ONE&&A[2]===qi.ZERO&&A[3]===qi.ONE?E.alphaMode=Za.ALPHA_ADD:A[0]===qi.ZERO&&A[1]===qi.ONE_MINUS_SRC_COLOR&&A[2]===qi.ONE&&A[3]===qi.ONE?E.alphaMode=Za.ALPHA_SUBTRACT:A[0]===qi.DST_COLOR&&A[1]===qi.ZERO&&A[2]===qi.ONE&&A[3]===qi.ONE?E.alphaMode=Za.ALPHA_MULTIPLY:A[0]===qi.SRC_ALPHA&&A[1]===qi.ONE_MINUS_SRC_COLOR&&A[2]===qi.ONE&&A[3]===qi.ONE&&(E.alphaMode=Za.ALPHA_MAXIMIZED))}}},nu=(()=>{class s{static RegisterExtension(t){if(s.Extensions[t.name]){H.Error('Tool with the same name "'+t.name+'" already exists');return}s.Extensions[t.name]=t}dispose(){}_importMeshAsync(t,i,r,n,o,a,l,c){return i.useRightHandedSystem=!0,On.LoadRuntimeAsync(i,r,n,h=>{h.assetContainer=o,h.importOnlyMeshes=!0,t===""?h.importMeshesNames=[]:typeof t=="string"?h.importMeshesNames=[t]:t&&!(t instanceof Array)?h.importMeshesNames=[t]:(h.importMeshesNames=[],H.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(h);let u=[],d=[];for(let f in h.nodes){let m=h.nodes[f];m.babylonNode instanceof lt&&u.push(m.babylonNode)}for(let f in h.skins){let m=h.skins[f];m.babylonSkeleton instanceof Xn&&d.push(m.babylonSkeleton)}this._loadBuffersAsync(h,()=>{this._loadShadersAsync(h,()=>{f2(h),u2(h),!Ra.IncrementalLoading&&a&&a(u,d)})}),Ra.IncrementalLoading&&a&&a(u,d)},c),!0}importMeshAsync(t,i,r,n,o,a){return new Promise((l,c)=>{this._importMeshAsync(t,i,n,o,r,(h,u)=>{l({meshes:h,particleSystems:[],skeletons:u,animationGroups:[],lights:[],transformNodes:[],geometries:[],spriteManagers:[]})},a,h=>{c(new Error(h))})})}_loadAsync(t,i,r,n,o,a){t.useRightHandedSystem=!0,On.LoadRuntimeAsync(t,i,r,l=>{On.LoadRuntimeExtensionsAsync(l,()=>{this._createNodes(l),this._loadBuffersAsync(l,()=>{this._loadShadersAsync(l,()=>{f2(l),u2(l),Ra.IncrementalLoading||n()})}),Ra.IncrementalLoading&&n()},a)},a)}loadAsync(t,i,r,n){return new Promise((o,a)=>{this._loadAsync(t,i,r,()=>{o()},n,l=>{a(new Error(l))})})}_loadShadersAsync(t,i){let r=!1,n=(o,a)=>{On.LoadShaderStringAsync(t,o,l=>{l instanceof ArrayBuffer||(t.loadedShaderCount++,l&&($t.ShadersStore[o+(a.type===tD.VERTEX?"VertexShader":"PixelShader")]=l),t.loadedShaderCount===t.shaderscount&&i())},()=>{H.Error("Error when loading shader program named "+o+" located at "+a.uri)})};for(let o in t.shaders){r=!0;let a=t.shaders[o];a?n.bind(this,o,a)():H.Error("No shader named: "+o)}r||i()}_loadBuffersAsync(t,i){let r=!1,n=(o,a)=>{On.LoadBufferAsync(t,o,l=>{t.loadedBufferCount++,l&&(l.byteLength!=t.buffers[o].byteLength&&H.Error("Buffer named "+o+" is length "+l.byteLength+". Expected: "+a.byteLength),t.loadedBufferViews[o]=l),t.loadedBufferCount===t.buffersCount&&i()},()=>{H.Error("Error when loading buffer named "+o+" located at "+a.uri)})};for(let o in t.buffers){r=!0;let a=t.buffers[o];a?n.bind(this,o,a)():H.Error("No buffer named: "+o)}r||i()}_createNodes(t){let i=t.currentScene;if(i)for(let r=0;r<i.nodes.length;r++)xg(t,i.nodes[r],null);else for(let r in t.scenes){i=t.scenes[r];for(let n=0;n<i.nodes.length;n++)xg(t,i.nodes[n],null)}}}return s.Extensions={},s})(),On=class s{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,i,r,n){return!1}loadRuntimeExtensionsAsync(e,t,i){return!1}loadBufferAsync(e,t,i,r,n){return!1}loadTextureBufferAsync(e,t,i,r){return!1}createTextureAsync(e,t,i,r,n){return!1}loadShaderStringAsync(e,t,i,r){return!1}loadMaterialAsync(e,t,i,r){return!1}static LoadRuntimeAsync(e,t,i,r,n){s._ApplyExtensions(o=>o.loadRuntimeAsync(e,t,i,r,n),()=>{setTimeout(()=>{r&&r(Dn.CreateRuntime(t.json,e,i))})})}static LoadRuntimeExtensionsAsync(e,t,i){s._ApplyExtensions(r=>r.loadRuntimeExtensionsAsync(e,t,i),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,i,r,n){s._ApplyExtensions(o=>o.loadBufferAsync(e,t,i,r,n),()=>{Dn.LoadBufferAsync(e,t,i,r,n)})}static LoadTextureAsync(e,t,i,r){s._LoadTextureBufferAsync(e,t,n=>{n&&s._CreateTextureAsync(e,t,n,i,r)},r)}static LoadShaderStringAsync(e,t,i,r){s._ApplyExtensions(n=>n.loadShaderStringAsync(e,t,i,r),()=>{Dn.LoadShaderStringAsync(e,t,i,r)})}static LoadMaterialAsync(e,t,i,r){s._ApplyExtensions(n=>n.loadMaterialAsync(e,t,i,r),()=>{Dn.LoadMaterialAsync(e,t,i,r)})}static _LoadTextureBufferAsync(e,t,i,r){s._ApplyExtensions(n=>n.loadTextureBufferAsync(e,t,i,r),()=>{Dn.LoadTextureBufferAsync(e,t,i,r)})}static _CreateTextureAsync(e,t,i,r,n){s._ApplyExtensions(o=>o.createTextureAsync(e,t,i,r,n),()=>{Dn.CreateTextureAsync(e,t,i,r)})}static _ApplyExtensions(e,t){for(let i in nu.Extensions){let r=nu.Extensions[i];if(e(r))return}t()}};Ra._CreateGLTF1Loader=()=>new nu;var ZZ="binary_glTF",oD=class extends On{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,i,r){let n=t.json.extensionsUsed;return!n||n.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,r(Dn.CreateRuntime(t.json,e,i)),!0)}loadBufferAsync(e,t,i,r){return e.extensionsUsed.indexOf(this.name)===-1||t!==ZZ?!1:(this._bin.readAsync(0,this._bin.byteLength).then(i,n=>r(n.message)),!0)}loadTextureBufferAsync(e,t,i){let r=e.textures[t],n=e.images[r.source];if(!n.extensions||!(this.name in n.extensions))return!1;let o=n.extensions[this.name],a=e.bufferViews[o.bufferView],l=Is.GetBufferFromBufferView(e,a,0,a.byteLength,Tl.UNSIGNED_BYTE);return i(l),!0}loadShaderStringAsync(e,t,i){let r=e.shaders[t];if(!r.extensions||!(this.name in r.extensions))return!1;let n=r.extensions[this.name],o=e.bufferViews[n.bufferView],a=Is.GetBufferFromBufferView(e,o,0,o.byteLength,Tl.UNSIGNED_BYTE);return setTimeout(()=>{let l=Is.DecodeBufferToText(a);i(l)}),!0}};nu.RegisterExtension(new oD);var aD=class extends On{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;let t=e.extensions[this.name];if(!t)return!1;let i=t.lights;if(i)for(let r in i){let n=i[r];switch(n.type){case"ambient":{let o=new as(n.name,new p(0,1,0),e.scene),a=n.ambient;a&&(o.diffuse=X.FromArray(a.color||[1,1,1]));break}case"point":{let o=new In(n.name,new p(10,10,10),e.scene),a=n.point;a&&(o.diffuse=X.FromArray(a.color||[1,1,1]));break}case"directional":{let o=new Cr(n.name,new p(0,-1,0),e.scene),a=n.directional;a&&(o.diffuse=X.FromArray(a.color||[1,1,1]));break}case"spot":{let o=n.spot;if(o){let a=new Hr(n.name,new p(0,10,0),new p(0,-1,0),o.fallOffAngle||Math.PI,o.fallOffExponent||0,e.scene);a.diffuse=X.FromArray(o.color||[1,1,1])}break}default:H.Warn('GLTF Material Common extension: light type "'+n.type+"\u201D not supported");break}}return!1}loadMaterialAsync(e,t,i,r){let n=e.materials[t];if(!n||!n.extensions)return!1;let o=n.extensions[this.name];if(!o)return!1;let a=new Ee(t,e.scene);return a.sideOrientation=se.CounterClockWiseSideOrientation,o.technique==="CONSTANT"&&(a.disableLighting=!0),a.backFaceCulling=o.doubleSided===void 0?!1:!o.doubleSided,a.alpha=o.values.transparency===void 0?1:o.values.transparency,a.specularPower=o.values.shininess===void 0?0:o.values.shininess,typeof o.values.ambient=="string"?this._loadTexture(e,o.values.ambient,a,"ambientTexture",r):a.ambientColor=X.FromArray(o.values.ambient||[0,0,0]),typeof o.values.diffuse=="string"?this._loadTexture(e,o.values.diffuse,a,"diffuseTexture",r):a.diffuseColor=X.FromArray(o.values.diffuse||[0,0,0]),typeof o.values.emission=="string"?this._loadTexture(e,o.values.emission,a,"emissiveTexture",r):a.emissiveColor=X.FromArray(o.values.emission||[0,0,0]),typeof o.values.specular=="string"?this._loadTexture(e,o.values.specular,a,"specularTexture",r):a.specularColor=X.FromArray(o.values.specular||[0,0,0]),!0}_loadTexture(e,t,i,r,n){Dn.LoadTextureBufferAsync(e,t,o=>{Dn.CreateTextureAsync(e,t,o,a=>i[r]=a)},n)}};nu.RegisterExtension(new aD);function _2(s,e,t,i){return p.FromArray(e,t).scaleInPlace(i)}function eJ(s,e,t,i){return q.FromArray(e,t).scaleInPlace(i)}function tJ(s,e,t,i){let r=new Array(s._numMorphTargets);for(let n=0;n<r.length;n++)r[n]=e[t++]*i;return r}var xc=class{constructor(e,t,i,r){this.type=e,this.name=t,this.getValue=i,this.getStride=r}_buildAnimation(e,t,i){let r=new te(e,this.name,t,this.type);return r.setKeys(i),r}},vg=class extends xc{buildAnimations(e,t,i,r,n){n(e._babylonTransformNode,this._buildAnimation(t,i,r))}},lD=class extends xc{buildAnimations(e,t,i,r,n){if(e._numMorphTargets)for(let o=0;o<e._numMorphTargets;o++){let a=new te(`${t}_${o}`,this.name,i,this.type);if(a.setKeys(r.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[o]:void 0,value:l.value[o],outTangent:l.outTangent?l.outTangent[o]:void 0,interpolation:l.interpolation}))),e._primitiveBabylonMeshes){for(let l of e._primitiveBabylonMeshes)if(l.morphTargetManager){let c=l.morphTargetManager.getTarget(o),h=a.clone();c.animations.push(h),n(c,h)}}}}},ou={translation:[new vg(te.ANIMATIONTYPE_VECTOR3,"position",_2,()=>3)],rotation:[new vg(te.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",eJ,()=>4)],scale:[new vg(te.ANIMATIONTYPE_VECTOR3,"scaling",_2,()=>3)],weights:[new lD(te.ANIMATIONTYPE_FLOAT,"influence",tJ,s=>s._numMorphTargets)]};function x2(...s){let e=t=>t&&typeof t=="object";return s.reduce((t,i)=>(Object.keys(i).forEach(r=>{let n=t[r],o=i[r];Array.isArray(n)&&Array.isArray(o)?t[r]=n.concat(...o):e(n)&&e(o)?t[r]=x2(n,o):t[r]=o}),t),{})}var Ve=class{static Get(e,t,i){if(!t||i==null||!t[i])throw new Error(`${e}: Failed to find index (${i})`);return t[i]}static TryGet(e,t){return!e||t==null||!e[t]?null:e[t]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}},Ne=(()=>{class s{static RegisterExtension(t,i){s.UnregisterExtension(t)&&F.Warn(`Extension with the name '${t}' already exists`),s._RegisteredExtensions[t]={factory:i}}static UnregisterExtension(t){return s._RegisteredExtensions[t]?(delete s._RegisteredExtensions[t],!0):!1}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(t){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=t}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(t=>t.dispose&&t.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(t,i,r,n,o,a,l=""){return Promise.resolve().then(()=>{this._babylonScene=i,this._assetContainer=r,this._loadData(n);let c=null;if(t){let h={};if(this._gltf.nodes)for(let d of this._gltf.nodes)d.name&&(h[d.name]=d.index);c=(t instanceof Array?t:[t]).map(d=>{let f=h[d];if(f===void 0)throw new Error(`Failed to find node '${d}'`);return f})}return this._loadAsync(o,l,c,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries(),spriteManagers:[]}))})}loadAsync(t,i,r,n,o=""){return Promise.resolve().then(()=>(this._babylonScene=t,this._loadData(i),this._loadAsync(r,o,null,()=>{})))}_loadAsync(t,i,r,n){return Promise.resolve().then(()=>{this._rootUrl=t,this._uniqueRootUrl=!t.startsWith("file:")&&i?t:`${t}${Date.now()}/`,this._fileName=i,this._allMaterialsDirtyRequired=!1,this._loadExtensions(),this._checkExtensions();let o=`${tn[tn.LOADING]} => ${tn[tn.READY]}`,a=`${tn[tn.LOADING]} => ${tn[tn.COMPLETE]}`;this._parent._startPerformanceCounter(o),this._parent._startPerformanceCounter(a),this._parent._setState(tn.LOADING),this._extensionsOnLoading();let l=new Array,c=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(r)l.push(this.loadSceneAsync("/nodes",{nodes:r,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){let u=Ve.Get("/scene",this._gltf.scenes,this._gltf.scene||0);l.push(this.loadSceneAsync(`/scenes/${u.index}`,u))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let u=0;u<this._gltf.materials.length;++u){let d=this._gltf.materials[u],f="/materials/"+u,m=se.TriangleFillMode;l.push(this._loadMaterialAsync(f,d,null,m,()=>{}))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=c:this._babylonScene._forceBlockMaterialDirtyMechanism(c),this._parent.compileMaterials&&l.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&l.push(this._compileShadowGeneratorsAsync()),Promise.all(l).then(()=>(this._rootBabylonMesh&&this._rootBabylonMesh!==this._parent.customRootNode&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(tn.READY),this._startAnimations(),n())).then(u=>(this._parent._endPerformanceCounter(o),H.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(a),this._parent._setState(tn.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},d=>{this._parent.onErrorObservable.notifyObservers(d),this._parent.onErrorObservable.clear(),this.dispose()})}),u))}).catch(o=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(o),this._parent.onErrorObservable.clear(),this.dispose()),o})}_loadData(t){if(this._gltf=t.json,this._setupData(),t.bin){let i=this._gltf.buffers;if(i&&i[0]&&!i[0].uri){let r=i[0];(r.byteLength<t.bin.byteLength-3||r.byteLength>t.bin.byteLength)&&F.Warn(`Binary buffer length (${r.byteLength}) from JSON does not match chunk length (${t.bin.byteLength})`),this._bin=t.bin}else F.Warn("Unexpected BIN chunk")}}_setupData(){if(Ve.Assign(this._gltf.accessors),Ve.Assign(this._gltf.animations),Ve.Assign(this._gltf.buffers),Ve.Assign(this._gltf.bufferViews),Ve.Assign(this._gltf.cameras),Ve.Assign(this._gltf.images),Ve.Assign(this._gltf.materials),Ve.Assign(this._gltf.meshes),Ve.Assign(this._gltf.nodes),Ve.Assign(this._gltf.samplers),Ve.Assign(this._gltf.scenes),Ve.Assign(this._gltf.skins),Ve.Assign(this._gltf.textures),this._gltf.nodes){let t={};for(let r of this._gltf.nodes)if(r.children)for(let n of r.children)t[n]=r.index;let i=this._createRootNode();for(let r of this._gltf.nodes){let n=t[r.index];r.parent=n===void 0?i:this._gltf.nodes[n]}}}_loadExtensions(){for(let t in s._RegisteredExtensions){let i=s._RegisteredExtensions[t].factory(this);i.name!==t&&F.Warn(`The name of the glTF loader extension instance does not match the registered name: ${i.name} !== ${t}`),this._extensions.push(i),this._parent.onExtensionLoadedObservable.notifyObservers(i)}this._extensions.sort((t,i)=>(t.order||Number.MAX_VALUE)-(i.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired){for(let t of this._gltf.extensionsRequired)if(!this._extensions.some(r=>r.name===t&&r.enabled))throw new Error(`Required extension ${t} is not available`)}}_createRootNode(){if(this._parent.customRootNode!==void 0)return this._rootBabylonMesh=this._parent.customRootNode,{_babylonTransformNode:this._rootBabylonMesh===null?void 0:this._rootBabylonMesh,index:-1};this._babylonScene._blockEntityCollection=!!this._assetContainer;let t=new k("__root__",this._babylonScene);this._rootBabylonMesh=t,this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);let i={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case gg.AUTO:{this._babylonScene.useRightHandedSystem||(i.rotation=[0,1,0,0],i.scale=[1,1,-1],s._LoadTransform(i,this._rootBabylonMesh));break}case gg.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(t),i}loadSceneAsync(t,i){let r=this._extensionsLoadSceneAsync(t,i);if(r)return r;let n=new Array;if(this.logOpen(`${t} ${i.name||""}`),i.nodes)for(let o of i.nodes){let a=Ve.Get(`${t}/nodes/${o}`,this._gltf.nodes,o);n.push(this.loadNodeAsync(`/nodes/${a.index}`,a,l=>{l.parent=this._rootBabylonMesh}))}for(let o of this._postSceneLoadActions)o();return n.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(n).then(()=>{})}_forEachPrimitive(t,i){if(t._primitiveBabylonMeshes)for(let r of t._primitiveBabylonMeshes)i(r)}_getGeometries(){let t=[],i=this._gltf.nodes;if(i)for(let r of i)this._forEachPrimitive(r,n=>{let o=n.geometry;o&&t.indexOf(o)===-1&&t.push(o)});return t}_getMeshes(){let t=[];this._rootBabylonMesh instanceof lt&&t.push(this._rootBabylonMesh);let i=this._gltf.nodes;if(i)for(let r of i)this._forEachPrimitive(r,n=>{t.push(n)});return t}_getTransformNodes(){let t=[],i=this._gltf.nodes;if(i)for(let r of i)r._babylonTransformNode&&r._babylonTransformNode.getClassName()==="TransformNode"&&t.push(r._babylonTransformNode),r._babylonTransformNodeForSkin&&t.push(r._babylonTransformNodeForSkin);return t}_getSkeletons(){let t=[],i=this._gltf.skins;if(i)for(let r of i)r._data&&t.push(r._data.babylonSkeleton);return t}_getAnimationGroups(){let t=[],i=this._gltf.animations;if(i)for(let r of i)r._babylonAnimationGroup&&t.push(r._babylonAnimationGroup);return t}_startAnimations(){switch(this._parent.animationStartMode){case Df.NONE:break;case Df.FIRST:{let t=this._getAnimationGroups();t.length!==0&&t[0].start(!0);break}case Df.ALL:{let t=this._getAnimationGroups();for(let i of t)i.start(!0);break}default:{F.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(t,i,r=()=>{}){let n=this._extensionsLoadNodeAsync(t,i,r);if(n)return n;if(i._babylonTransformNode)throw new Error(`${t}: Invalid recursive node hierarchy`);let o=new Array;this.logOpen(`${t} ${i.name||""}`);let a=l=>{if(s.AddPointerMetadata(l,t),s._LoadTransform(i,l),i.camera!=null){let c=Ve.Get(`${t}/camera`,this._gltf.cameras,i.camera);o.push(this.loadCameraAsync(`/cameras/${c.index}`,c,h=>{h.parent=l}))}if(i.children)for(let c of i.children){let h=Ve.Get(`${t}/children/${c}`,this._gltf.nodes,c);o.push(this.loadNodeAsync(`/nodes/${h.index}`,h,u=>{u.parent=l}))}r(l)};if(i.mesh==null||i.skin!=null){let l=i.name||`node${i.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;let c=new Ze(l,this._babylonScene);c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i.mesh==null?i._babylonTransformNode=c:i._babylonTransformNodeForSkin=c,a(c)}if(i.mesh!=null)if(i.skin==null){let l=Ve.Get(`${t}/mesh`,this._gltf.meshes,i.mesh);o.push(this._loadMeshAsync(`/meshes/${l.index}`,i,l,a))}else{let l=Ve.Get(`${t}/mesh`,this._gltf.meshes,i.mesh);o.push(this._loadMeshAsync(`/meshes/${l.index}`,i,l,c=>{let h=i._babylonTransformNodeForSkin;c.metadata=x2(h.metadata,c.metadata||{});let u=Ve.Get(`${t}/skin`,this._gltf.skins,i.skin);o.push(this._loadSkinAsync(`/skins/${u.index}`,i,u,d=>{this._forEachPrimitive(i,f=>{f.skeleton=d}),this._postSceneLoadActions.push(()=>{if(u.skeleton!=null){let f=Ve.Get(`/skins/${u.index}/skeleton`,this._gltf.nodes,u.skeleton).parent;i.index===f.index?c.parent=h.parent:c.parent=f._babylonTransformNode}else c.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:h,skinnedNode:c})})}))}))}return this.logClose(),Promise.all(o).then(()=>(this._forEachPrimitive(i,l=>{l.geometry&&l.geometry.useBoundingInfoFromGeometry?l._updateBoundingInfo():l.refreshBoundingInfo(!0,!0)}),i._babylonTransformNode))}_loadMeshAsync(t,i,r,n){let o=r.primitives;if(!o||!o.length)throw new Error(`${t}: Primitives are missing`);o[0].index==null&&Ve.Assign(o);let a=new Array;this.logOpen(`${t} ${r.name||""}`);let l=i.name||`node${i.index}`;if(o.length===1){let c=r.primitives[0];a.push(this._loadMeshPrimitiveAsync(`${t}/primitives/${c.index}`,l,i,r,c,h=>{i._babylonTransformNode=h,i._primitiveBabylonMeshes=[h]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,i._babylonTransformNode=new Ze(l,this._babylonScene),i._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i._primitiveBabylonMeshes=[];for(let c of o)a.push(this._loadMeshPrimitiveAsync(`${t}/primitives/${c.index}`,`${l}_primitive${c.index}`,i,r,c,h=>{h.parent=i._babylonTransformNode,i._primitiveBabylonMeshes.push(h)}))}return n(i._babylonTransformNode),this.logClose(),Promise.all(a).then(()=>i._babylonTransformNode)}_loadMeshPrimitiveAsync(t,i,r,n,o,a){let l=this._extensionsLoadMeshPrimitiveAsync(t,i,r,n,o,a);if(l)return l;this.logOpen(`${t}`);let c=this._disableInstancedMesh===0&&this._parent.createInstances&&r.skin==null&&!n.primitives[0].targets,h,u;if(c&&o._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,h=o._instanceData.babylonSourceMesh.createInstance(i),h._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u=o._instanceData.promise;else{let d=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;let f=new k(i,this._babylonScene);f._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,f.sideOrientation=this._babylonScene.useRightHandedSystem?se.CounterClockWiseSideOrientation:se.ClockWiseSideOrientation,this._createMorphTargets(t,r,n,o,f),d.push(this._loadVertexDataAsync(t,o,f).then(g=>this._loadMorphTargetsAsync(t,o,f,g).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,g.applyToMesh(f),g._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));let m=s._GetDrawMode(t,o.mode);if(o.material==null){let g=this._defaultBabylonMaterialData[m];g||(g=this._createDefaultMaterial("__GLTFLoader._default",m),this._parent.onMaterialLoadedObservable.notifyObservers(g),this._defaultBabylonMaterialData[m]=g),f.material=g}else if(!this.parent.skipMaterials){let g=Ve.Get(`${t}/material`,this._gltf.materials,o.material);d.push(this._loadMaterialAsync(`/materials/${g.index}`,g,f,m,_=>{f.material=_}))}u=Promise.all(d),c&&(o._instanceData={babylonSourceMesh:f,promise:u}),h=f}return s.AddPointerMetadata(h,t),this._parent.onMeshLoadedObservable.notifyObservers(h),a(h),this.logClose(),u.then(()=>h)}_loadVertexDataAsync(t,i,r){let n=this._extensionsLoadVertexDataAsync(t,i,r);if(n)return n;let o=i.attributes;if(!o)throw new Error(`${t}: Attributes are missing`);let a=new Array,l=new nr(r.name,this._babylonScene);if(i.indices==null)r.isUnIndexed=!0;else{let h=Ve.Get(`${t}/indices`,this._gltf.accessors,i.indices);a.push(this._loadIndicesAccessorAsync(`/accessors/${h.index}`,h).then(u=>{l.setIndices(u)}))}let c=(h,u,d)=>{if(o[h]==null)return;r._delayInfo=r._delayInfo||[],r._delayInfo.indexOf(u)===-1&&r._delayInfo.push(u);let f=Ve.Get(`${t}/attributes/${h}`,this._gltf.accessors,o[h]);a.push(this._loadVertexAccessorAsync(`/accessors/${f.index}`,f,u).then(m=>{if(m.getKind()===y.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!r.skeleton&&f.min&&f.max){let g=O.Vector3[0].copyFromFloats(...f.min),_=O.Vector3[1].copyFromFloats(...f.max);if(f.normalized&&f.componentType!==5126){let x=1;switch(f.componentType){case 5120:x=127;break;case 5121:x=255;break;case 5122:x=32767;break;case 5123:x=65535;break}let b=1/x;g.scaleInPlace(b),_.scaleInPlace(b)}l._boundingInfo=new dr(g,_),l.useBoundingInfoFromGeometry=!0}l.setVerticesBuffer(m,f.count)})),u==y.MatricesIndicesExtraKind&&(r.numBoneInfluencers=8),d&&d(f)};return c("POSITION",y.PositionKind),c("NORMAL",y.NormalKind),c("TANGENT",y.TangentKind),c("TEXCOORD_0",y.UVKind),c("TEXCOORD_1",y.UV2Kind),c("TEXCOORD_2",y.UV3Kind),c("TEXCOORD_3",y.UV4Kind),c("TEXCOORD_4",y.UV5Kind),c("TEXCOORD_5",y.UV6Kind),c("JOINTS_0",y.MatricesIndicesKind),c("WEIGHTS_0",y.MatricesWeightsKind),c("JOINTS_1",y.MatricesIndicesExtraKind),c("WEIGHTS_1",y.MatricesWeightsExtraKind),c("COLOR_0",y.ColorKind,h=>{h.type==="VEC4"&&(r.hasVertexAlpha=!0)}),Promise.all(a).then(()=>l)}_createMorphTargets(t,i,r,n,o){if(!n.targets)return;if(i._numMorphTargets==null)i._numMorphTargets=n.targets.length;else if(n.targets.length!==i._numMorphTargets)throw new Error(`${t}: Primitives do not have the same number of targets`);let a=r.extras?r.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,o.morphTargetManager=new Wd(this._babylonScene),o.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.morphTargetManager.areUpdatesFrozen=!0;for(let l=0;l<n.targets.length;l++){let c=i.weights?i.weights[l]:r.weights?r.weights[l]:0,h=a?a[l]:`morphTarget${l}`;o.morphTargetManager.addTarget(new _h(h,c,o.getScene()))}}_loadMorphTargetsAsync(t,i,r,n){if(!i.targets)return Promise.resolve();let o=new Array,a=r.morphTargetManager;for(let l=0;l<a.numTargets;l++){let c=a.getTarget(l);o.push(this._loadMorphTargetVertexDataAsync(`${t}/targets/${l}`,n,i.targets[l],c))}return Promise.all(o).then(()=>{a.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(t,i,r,n){let o=new Array,a=(l,c,h)=>{if(r[l]==null)return;let u=i.getVertexBuffer(c);if(!u)return;let d=Ve.Get(`${t}/${l}`,this._gltf.accessors,r[l]);o.push(this._loadFloatAccessorAsync(`/accessors/${d.index}`,d).then(f=>{h(u,f)}))};return a("POSITION",y.PositionKind,(l,c)=>{let h=new Float32Array(c.length);l.forEach(c.length,(u,d)=>{h[d]=c[d]+u}),n.setPositions(h)}),a("NORMAL",y.NormalKind,(l,c)=>{let h=new Float32Array(c.length);l.forEach(h.length,(u,d)=>{h[d]=c[d]+u}),n.setNormals(h)}),a("TANGENT",y.TangentKind,(l,c)=>{let h=new Float32Array(c.length/3*4),u=0;l.forEach(c.length/3*4,(d,f)=>{(f+1)%4!==0&&(h[u]=c[u]+d,u++)}),n.setTangents(h)}),Promise.all(o).then(()=>{})}static _LoadTransform(t,i){if(t.skin!=null)return;let r=p.Zero(),n=q.Identity(),o=p.One();t.matrix?N.FromArray(t.matrix).decompose(o,n,r):(t.translation&&(r=p.FromArray(t.translation)),t.rotation&&(n=q.FromArray(t.rotation)),t.scale&&(o=p.FromArray(t.scale))),i.position=r,i.rotationQuaternion=n,i.scaling=o}_loadSkinAsync(t,i,r,n){let o=this._extensionsLoadSkinAsync(t,i,r);if(o)return o;if(r._data)return n(r._data.babylonSkeleton),r._data.promise;let a=`skeleton${r.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;let l=new Xn(r.name||a,a,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(t,r,l);let c=this._loadSkinInverseBindMatricesDataAsync(t,r).then(h=>{this._updateBoneMatrices(l,h)});return r._data={babylonSkeleton:l,promise:c},n(l),c}_loadBones(t,i,r){if(i.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){let o=this._findSkeletonRootNode(`${t}/joints`,i.joints);if(o)if(i.skeleton===void 0)i.skeleton=o.index;else{let a=(c,h)=>{for(;h.parent;h=h.parent)if(h.parent===c)return!0;return!1},l=Ve.Get(`${t}/skeleton`,this._gltf.nodes,i.skeleton);l!==o&&!a(l,o)&&(F.Warn(`${t}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),i.skeleton=o.index)}else F.Warn(`${t}: Failed to find common root`)}let n={};for(let o of i.joints){let a=Ve.Get(`${t}/joints/${o}`,this._gltf.nodes,o);this._loadBone(a,i,r,n)}}_findSkeletonRootNode(t,i){if(i.length===0)return null;let r={};for(let o of i){let a=[],l=Ve.Get(`${t}/${o}`,this._gltf.nodes,o);for(;l.index!==-1;)a.unshift(l),l=l.parent;r[o]=a}let n=null;for(let o=0;;++o){let a=r[i[0]];if(o>=a.length)return n;let l=a[o];for(let c=1;c<i.length;++c)if(a=r[i[c]],o>=a.length||l!==a[o])return n;n=l}}_loadBone(t,i,r,n){let o=n[t.index];if(o)return o;let a=null;t.index!==i.skeleton&&(t.parent&&t.parent.index!==-1?a=this._loadBone(t.parent,i,r,n):i.skeleton!==void 0&&F.Warn(`/skins/${i.index}/skeleton: Skeleton node is not a common root`));let l=i.joints.indexOf(t.index);return o=new ss(t.name||`joint${t.index}`,r,a,this._getNodeMatrix(t),null,null,l),n[t.index]=o,this._postSceneLoadActions.push(()=>{o.linkTransformNode(t._babylonTransformNode)}),o}_loadSkinInverseBindMatricesDataAsync(t,i){if(i.inverseBindMatrices==null)return Promise.resolve(null);let r=Ve.Get(`${t}/inverseBindMatrices`,this._gltf.accessors,i.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${r.index}`,r)}_updateBoneMatrices(t,i){for(let r of t.bones){let n=N.Identity(),o=r._index;i&&o!==-1&&(N.FromArrayToRef(i,o*16,n),n.invertToRef(n));let a=r.getParent();a&&n.multiplyToRef(a.getAbsoluteInverseBindMatrix(),n),r.updateMatrix(n,!1,!1),r._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(t){return t.matrix?N.FromArray(t.matrix):N.Compose(t.scale?p.FromArray(t.scale):p.One(),t.rotation?q.FromArray(t.rotation):q.Identity(),t.translation?p.FromArray(t.translation):p.Zero())}loadCameraAsync(t,i,r=()=>{}){let n=this._extensionsLoadCameraAsync(t,i,r);if(n)return n;let o=new Array;this.logOpen(`${t} ${i.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;let a=new wi(i.name||`camera${i.index}`,p.Zero(),this._babylonScene,!1);switch(a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,a.ignoreParentScaling=!0,i._babylonCamera=a,a.rotation.set(0,Math.PI,0),i.type){case"perspective":{let l=i.perspective;if(!l)throw new Error(`${t}: Camera perspective properties are missing`);a.fov=l.yfov,a.minZ=l.znear,a.maxZ=l.zfar||0;break}case"orthographic":{if(!i.orthographic)throw new Error(`${t}: Camera orthographic properties are missing`);a.mode=Ce.ORTHOGRAPHIC_CAMERA,a.orthoLeft=-i.orthographic.xmag,a.orthoRight=i.orthographic.xmag,a.orthoBottom=-i.orthographic.ymag,a.orthoTop=i.orthographic.ymag,a.minZ=i.orthographic.znear,a.maxZ=i.orthographic.zfar;break}default:throw new Error(`${t}: Invalid camera type (${i.type})`)}return s.AddPointerMetadata(a,t),this._parent.onCameraLoadedObservable.notifyObservers(a),r(a),this.logClose(),Promise.all(o).then(()=>a)}_loadAnimationsAsync(){let t=this._gltf.animations;if(!t)return Promise.resolve();let i=new Array;for(let r=0;r<t.length;r++){let n=t[r];i.push(this.loadAnimationAsync(`/animations/${n.index}`,n).then(o=>{o.targetedAnimations.length===0&&o.dispose()}))}return Promise.all(i).then(()=>{})}loadAnimationAsync(t,i){let r=this._extensionsLoadAnimationAsync(t,i);if(r)return r;this._babylonScene._blockEntityCollection=!!this._assetContainer;let n=new ud(i.name||`animation${i.index}`,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,i._babylonAnimationGroup=n;let o=new Array;Ve.Assign(i.channels),Ve.Assign(i.samplers);for(let a of i.channels)o.push(this._loadAnimationChannelAsync(`${t}/channels/${a.index}`,t,i,a,(l,c)=>{l.animations=l.animations||[],l.animations.push(c),n.addTargetedAnimation(c,l)}));return Promise.all(o).then(()=>(n.normalize(0),n))}_loadAnimationChannelAsync(t,i,r,n,o){let a=this._extensionsLoadAnimationChannelAsync(t,i,r,n,o);if(a)return a;if(n.target.node==null)return Promise.resolve();let l=Ve.Get(`${t}/target/node`,this._gltf.nodes,n.target.node);if(n.target.path==="weights"&&!l._numMorphTargets||n.target.path!=="weights"&&!l._babylonTransformNode)return Promise.resolve();let c;switch(n.target.path){case"translation":{c=ou.translation;break}case"rotation":{c=ou.rotation;break}case"scale":{c=ou.scale;break}case"weights":{c=ou.weights;break}default:throw new Error(`${t}/target/path: Invalid value (${n.target.path})`)}let h={object:l,info:c};return this._loadAnimationChannelFromTargetInfoAsync(t,i,r,n,h,o)}_loadAnimationChannelFromTargetInfoAsync(t,i,r,n,o,a){let l=this.parent.targetFps,c=1/l,h=Ve.Get(`${t}/sampler`,r.samplers,n.sampler);return this._loadAnimationSamplerAsync(`${i}/samplers/${n.sampler}`,h).then(u=>{let d=0,f=o.object,m=o.info;for(let g of m){let _=g.getStride(f),x=u.input,b=u.output,C=new Array(x.length),R=0;switch(u.interpolation){case"STEP":{for(let E=0;E<x.length;E++){let S=g.getValue(f,b,R,1);R+=_,C[E]={frame:x[E]*l,value:S,interpolation:kp.STEP}}break}case"CUBICSPLINE":{for(let E=0;E<x.length;E++){let S=g.getValue(f,b,R,c);R+=_;let A=g.getValue(f,b,R,1);R+=_;let L=g.getValue(f,b,R,c);R+=_,C[E]={frame:x[E]*l,inTangent:S,value:A,outTangent:L}}break}case"LINEAR":{for(let E=0;E<x.length;E++){let S=g.getValue(f,b,R,1);R+=_,C[E]={frame:x[E]*l,value:S}}break}}if(R>0){let E=`${r.name||`animation${r.index}`}_channel${n.index}_${d}`;g.buildAnimations(f,E,l,C,(S,A)=>{++d,a(S,A)})}}})}_loadAnimationSamplerAsync(t,i){if(i._data)return i._data;let r=i.interpolation||"LINEAR";switch(r){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${t}/interpolation: Invalid value (${i.interpolation})`)}let n=Ve.Get(`${t}/input`,this._gltf.accessors,i.input),o=Ve.Get(`${t}/output`,this._gltf.accessors,i.output);return i._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${n.index}`,n),this._loadFloatAccessorAsync(`/accessors/${o.index}`,o)]).then(([a,l])=>({input:a,interpolation:r,output:l})),i._data}loadBufferAsync(t,i,r,n){let o=this._extensionsLoadBufferAsync(t,i,r,n);if(o)return o;if(!i._data)if(i.uri)i._data=this.loadUriAsync(`${t}/uri`,i,i.uri);else{if(!this._bin)throw new Error(`${t}: Uri is missing or the binary glTF is missing its binary chunk`);i._data=this._bin.readAsync(0,i.byteLength)}return i._data.then(a=>{try{return new Uint8Array(a.buffer,a.byteOffset+r,n)}catch(l){throw new Error(`${t}: ${l.message}`)}})}loadBufferViewAsync(t,i){let r=this._extensionsLoadBufferViewAsync(t,i);if(r)return r;if(i._data)return i._data;let n=Ve.Get(`${t}/buffer`,this._gltf.buffers,i.buffer);return i._data=this.loadBufferAsync(`/buffers/${n.index}`,n,i.byteOffset||0,i.byteLength),i._data}_loadAccessorAsync(t,i,r){if(i._data)return i._data;let n=s._GetNumComponents(t,i.type),o=n*y.GetTypeByteLength(i.componentType),a=n*i.count;if(i.bufferView==null)i._data=Promise.resolve(new r(a));else{let l=Ve.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${l.index}`,l).then(c=>{if(i.componentType===5126&&!i.normalized&&(!l.byteStride||l.byteStride===o))return s._GetTypedArray(t,i.componentType,c,i.byteOffset,a);{let h=new r(a);return y.ForEach(c,i.byteOffset||0,l.byteStride||o,n,i.componentType,h.length,i.normalized||!1,(u,d)=>{h[d]=u}),h}})}if(i.sparse){let l=i.sparse;i._data=i._data.then(c=>{let h=c,u=Ve.Get(`${t}/sparse/indices/bufferView`,this._gltf.bufferViews,l.indices.bufferView),d=Ve.Get(`${t}/sparse/values/bufferView`,this._gltf.bufferViews,l.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${u.index}`,u),this.loadBufferViewAsync(`/bufferViews/${d.index}`,d)]).then(([f,m])=>{let g=s._GetTypedArray(`${t}/sparse/indices`,l.indices.componentType,f,l.indices.byteOffset,l.count),_=n*l.count,x;if(i.componentType===5126&&!i.normalized)x=s._GetTypedArray(`${t}/sparse/values`,i.componentType,m,l.values.byteOffset,_);else{let C=s._GetTypedArray(`${t}/sparse/values`,i.componentType,m,l.values.byteOffset,_);x=new r(_),y.ForEach(C,0,o,n,i.componentType,x.length,i.normalized||!1,(R,E)=>{x[E]=R})}let b=0;for(let C=0;C<g.length;C++){let R=g[C]*n;for(let E=0;E<n;E++)h[R++]=x[b++]}return h})})}return i._data}_loadFloatAccessorAsync(t,i){return this._loadAccessorAsync(t,i,Float32Array)}_loadIndicesAccessorAsync(t,i){if(i.type!=="SCALAR")throw new Error(`${t}/type: Invalid value ${i.type}`);if(i.componentType!==5121&&i.componentType!==5123&&i.componentType!==5125)throw new Error(`${t}/componentType: Invalid value ${i.componentType}`);if(i._data)return i._data;if(i.sparse){let r=s._GetTypedArrayConstructor(`${t}/componentType`,i.componentType);i._data=this._loadAccessorAsync(t,i,r)}else{let r=Ve.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${r.index}`,r).then(n=>s._GetTypedArray(t,i.componentType,n,i.byteOffset,i.count))}return i._data}_loadVertexBufferViewAsync(t){if(t._babylonBuffer)return t._babylonBuffer;let i=this._babylonScene.getEngine();return t._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${t.index}`,t).then(r=>new gi(i,r,!1)),t._babylonBuffer}_loadVertexAccessorAsync(t,i,r){if(i._babylonVertexBuffer?.[r])return i._babylonVertexBuffer[r];i._babylonVertexBuffer||(i._babylonVertexBuffer={});let n=this._babylonScene.getEngine();if(i.sparse||i.bufferView==null)i._babylonVertexBuffer[r]=this._loadFloatAccessorAsync(t,i).then(o=>new y(n,o,r,!1));else{let o=Ve.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._babylonVertexBuffer[r]=this._loadVertexBufferViewAsync(o).then(a=>{let l=s._GetNumComponents(t,i.type);return new y(n,a,r,!1,void 0,o.byteStride,void 0,i.byteOffset,l,i.componentType,i.normalized,!0,void 0,!0)})}return i._babylonVertexBuffer[r]}_loadMaterialMetallicRoughnessPropertiesAsync(t,i,r){if(!(r instanceof Pe))throw new Error(`${t}: Material type not supported`);let n=new Array;return i&&(i.baseColorFactor?(r.albedoColor=X.FromArray(i.baseColorFactor),r.alpha=i.baseColorFactor[3]):r.albedoColor=X.White(),r.metallic=i.metallicFactor==null?1:i.metallicFactor,r.roughness=i.roughnessFactor==null?1:i.roughnessFactor,i.baseColorTexture&&n.push(this.loadTextureInfoAsync(`${t}/baseColorTexture`,i.baseColorTexture,o=>{o.name=`${r.name} (Base Color)`,r.albedoTexture=o})),i.metallicRoughnessTexture&&(i.metallicRoughnessTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${t}/metallicRoughnessTexture`,i.metallicRoughnessTexture,o=>{o.name=`${r.name} (Metallic Roughness)`,r.metallicTexture=o})),r.useMetallnessFromMetallicTextureBlue=!0,r.useRoughnessFromMetallicTextureGreen=!0,r.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(n).then(()=>{})}_loadMaterialAsync(t,i,r,n,o=()=>{}){let a=this._extensionsLoadMaterialAsync(t,i,r,n,o);if(a)return a;i._data=i._data||{};let l=i._data[n];if(!l){this.logOpen(`${t} ${i.name||""}`);let c=this.createMaterial(t,i,n);l={babylonMaterial:c,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(t,i,c)},i._data[n]=l,s.AddPointerMetadata(c,t),this._parent.onMaterialLoadedObservable.notifyObservers(c),this.logClose()}return r&&(l.babylonMeshes.push(r),r.onDisposeObservable.addOnce(()=>{let c=l.babylonMeshes.indexOf(r);c!==-1&&l.babylonMeshes.splice(c,1)})),o(l.babylonMaterial),l.promise.then(()=>l.babylonMaterial)}_createDefaultMaterial(t,i){this._babylonScene._blockEntityCollection=!!this._assetContainer;let r=new Pe(t,this._babylonScene);return r._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.fillMode=i,r.enableSpecularAntiAliasing=!0,r.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,r.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,r.transparencyMode=Pe.PBRMATERIAL_OPAQUE,r.metallic=1,r.roughness=1,r}createMaterial(t,i,r){let n=this._extensionsCreateMaterial(t,i,r);if(n)return n;let o=i.name||`material${i.index}`;return this._createDefaultMaterial(o,r)}loadMaterialPropertiesAsync(t,i,r){let n=this._extensionsLoadMaterialPropertiesAsync(t,i,r);if(n)return n;let o=new Array;return o.push(this.loadMaterialBasePropertiesAsync(t,i,r)),i.pbrMetallicRoughness&&o.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${t}/pbrMetallicRoughness`,i.pbrMetallicRoughness,r)),this.loadMaterialAlphaProperties(t,i,r),Promise.all(o).then(()=>{})}loadMaterialBasePropertiesAsync(t,i,r){if(!(r instanceof Pe))throw new Error(`${t}: Material type not supported`);let n=new Array;return r.emissiveColor=i.emissiveFactor?X.FromArray(i.emissiveFactor):new X(0,0,0),i.doubleSided&&(r.backFaceCulling=!1,r.twoSidedLighting=!0),i.normalTexture&&(i.normalTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${t}/normalTexture`,i.normalTexture,o=>{o.name=`${r.name} (Normal)`,r.bumpTexture=o})),r.invertNormalMapX=!this._babylonScene.useRightHandedSystem,r.invertNormalMapY=this._babylonScene.useRightHandedSystem,i.normalTexture.scale!=null&&r.bumpTexture&&(r.bumpTexture.level=i.normalTexture.scale),r.forceIrradianceInFragment=!0),i.occlusionTexture&&(i.occlusionTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${t}/occlusionTexture`,i.occlusionTexture,o=>{o.name=`${r.name} (Occlusion)`,r.ambientTexture=o})),r.useAmbientInGrayScale=!0,i.occlusionTexture.strength!=null&&(r.ambientTextureStrength=i.occlusionTexture.strength)),i.emissiveTexture&&n.push(this.loadTextureInfoAsync(`${t}/emissiveTexture`,i.emissiveTexture,o=>{o.name=`${r.name} (Emissive)`,r.emissiveTexture=o})),Promise.all(n).then(()=>{})}loadMaterialAlphaProperties(t,i,r){if(!(r instanceof Pe))throw new Error(`${t}: Material type not supported`);switch(i.alphaMode||"OPAQUE"){case"OPAQUE":{r.transparencyMode=Pe.PBRMATERIAL_OPAQUE,r.alpha=1;break}case"MASK":{r.transparencyMode=Pe.PBRMATERIAL_ALPHATEST,r.alphaCutOff=i.alphaCutoff==null?.5:i.alphaCutoff,r.albedoTexture&&(r.albedoTexture.hasAlpha=!0);break}case"BLEND":{r.transparencyMode=Pe.PBRMATERIAL_ALPHABLEND,r.albedoTexture&&(r.albedoTexture.hasAlpha=!0,r.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(`${t}/alphaMode: Invalid value (${i.alphaMode})`)}}loadTextureInfoAsync(t,i,r=()=>{}){let n=this._extensionsLoadTextureInfoAsync(t,i,r);if(n)return n;if(this.logOpen(`${t}`),i.texCoord>=6)throw new Error(`${t}/texCoord: Invalid value (${i.texCoord})`);let o=Ve.Get(`${t}/index`,this._gltf.textures,i.index);o._textureInfo=i;let a=this._loadTextureAsync(`/textures/${i.index}`,o,l=>{l.coordinatesIndex=i.texCoord||0,s.AddPointerMetadata(l,t),this._parent.onTextureLoadedObservable.notifyObservers(l),r(l)});return this.logClose(),a}_loadTextureAsync(t,i,r=()=>{}){let n=this._extensionsLoadTextureAsync(t,i,r);if(n)return n;this.logOpen(`${t} ${i.name||""}`);let o=i.sampler==null?s.DefaultSampler:Ve.Get(`${t}/sampler`,this._gltf.samplers,i.sampler),a=Ve.Get(`${t}/source`,this._gltf.images,i.source),l=this._createTextureAsync(t,o,a,r,void 0,!i._textureInfo.nonColorData);return this.logClose(),l}_createTextureAsync(t,i,r,n=()=>{},o,a){let l=this._loadSampler(`/samplers/${i.index}`,i),c=new Array,h=new gl;this._babylonScene._blockEntityCollection=!!this._assetContainer;let u={noMipmap:l.noMipMaps,invertY:!1,samplingMode:l.samplingMode,onLoad:()=>{this._disposed||h.resolve()},onError:(f,m)=>{this._disposed||h.reject(new Error(`${t}: ${m&&m.message?m.message:f||"Failed to load texture"}`))},mimeType:r.mimeType,loaderOptions:o,useSRGBBuffer:!!a&&this._parent.useSRGBBuffers},d=new z(null,this._babylonScene,u);return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,c.push(h.promise),c.push(this.loadImageAsync(`/images/${r.index}`,r).then(f=>{let m=r.uri||`${this._fileName}#image${r.index}`,g=`data:${this._uniqueRootUrl}${m}`;d.updateURL(g,f)})),d.wrapU=l.wrapU,d.wrapV=l.wrapV,n(d),Promise.all(c).then(()=>d)}_loadSampler(t,i){return i._data||(i._data={noMipMaps:i.minFilter===9728||i.minFilter===9729,samplingMode:s._GetTextureSamplingMode(t,i),wrapU:s._GetTextureWrapMode(`${t}/wrapS`,i.wrapS),wrapV:s._GetTextureWrapMode(`${t}/wrapT`,i.wrapT)}),i._data}loadImageAsync(t,i){if(!i._data){if(this.logOpen(`${t} ${i.name||""}`),i.uri)i._data=this.loadUriAsync(`${t}/uri`,i,i.uri);else{let r=Ve.Get(`${t}/bufferView`,this._gltf.bufferViews,i.bufferView);i._data=this.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}this.logClose()}return i._data}loadUriAsync(t,i,r){let n=this._extensionsLoadUriAsync(t,i,r);if(n)return n;if(!s._ValidateUri(r))throw new Error(`${t}: '${r}' is invalid`);if(Eg(r)){let o=new Uint8Array(Ag(r));return this.log(`${t}: Decoded ${r.substr(0,64)}... (${o.length} bytes)`),Promise.resolve(o)}return this.log(`${t}: Loading ${r}`),this._parent.preprocessUrlAsync(this._rootUrl+r).then(o=>new Promise((a,l)=>{this._parent._loadFile(this._babylonScene,o,c=>{this._disposed||(this.log(`${t}: Loaded ${r} (${c.byteLength} bytes)`),a(new Uint8Array(c)))},!0,c=>{l(new BO(`${t}: Failed to load '${r}'${c?": "+c.status+" "+c.statusText:""}`,c))})}))}static AddPointerMetadata(t,i){t.metadata=t.metadata||{};let r=t._internalMetadata=t._internalMetadata||{},n=r.gltf=r.gltf||{};(n.pointers=n.pointers||[]).push(i)}static _GetTextureWrapMode(t,i){switch(i=i??10497,i){case 33071:return z.CLAMP_ADDRESSMODE;case 33648:return z.MIRROR_ADDRESSMODE;case 10497:return z.WRAP_ADDRESSMODE;default:return F.Warn(`${t}: Invalid value (${i})`),z.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(t,i){let r=i.magFilter==null?9729:i.magFilter,n=i.minFilter==null?9987:i.minFilter;if(r===9729)switch(n){case 9728:return z.LINEAR_NEAREST;case 9729:return z.LINEAR_LINEAR;case 9984:return z.LINEAR_NEAREST_MIPNEAREST;case 9985:return z.LINEAR_LINEAR_MIPNEAREST;case 9986:return z.LINEAR_NEAREST_MIPLINEAR;case 9987:return z.LINEAR_LINEAR_MIPLINEAR;default:return F.Warn(`${t}/minFilter: Invalid value (${n})`),z.LINEAR_LINEAR_MIPLINEAR}else switch(r!==9728&&F.Warn(`${t}/magFilter: Invalid value (${r})`),n){case 9728:return z.NEAREST_NEAREST;case 9729:return z.NEAREST_LINEAR;case 9984:return z.NEAREST_NEAREST_MIPNEAREST;case 9985:return z.NEAREST_LINEAR_MIPNEAREST;case 9986:return z.NEAREST_NEAREST_MIPLINEAR;case 9987:return z.NEAREST_LINEAR_MIPLINEAR;default:return F.Warn(`${t}/minFilter: Invalid value (${n})`),z.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(t,i){switch(i){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${t}: Invalid component type ${i}`)}}static _GetTypedArray(t,i,r,n,o){let a=r.buffer;n=r.byteOffset+(n||0);let l=s._GetTypedArrayConstructor(`${t}/componentType`,i),c=y.GetTypeByteLength(i);return n%c!==0?(F.Warn(`${t}: Copying buffer as byte offset (${n}) is not a multiple of component type byte length (${c})`),new l(a.slice(n,n+o*c),0)):new l(a,n,o)}static _GetNumComponents(t,i){switch(i){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${t}: Invalid type (${i})`)}static _ValidateUri(t){return H.IsBase64(t)||t.indexOf("..")===-1}static _GetDrawMode(t,i){switch(i==null&&(i=4),i){case 0:return se.PointListDrawMode;case 1:return se.LineListDrawMode;case 2:return se.LineLoopDrawMode;case 3:return se.LineStripDrawMode;case 4:return se.TriangleFillMode;case 5:return se.TriangleStripDrawMode;case 6:return se.TriangleFanDrawMode}throw new Error(`${t}: Invalid mesh primitive mode (${i})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");let t=new Array;if(this._gltf.materials){for(let i of this._gltf.materials)if(i._data)for(let r in i._data){let n=i._data[r];for(let o of n.babylonMeshes){o.computeWorldMatrix(!0);let a=n.babylonMaterial;t.push(a.forceCompilationAsync(o)),t.push(a.forceCompilationAsync(o,{useInstances:!0})),this._parent.useClipPlane&&(t.push(a.forceCompilationAsync(o,{clipPlane:!0})),t.push(a.forceCompilationAsync(o,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");let t=new Array,i=this._babylonScene.lights;for(let r of i){let n=r.getShadowGenerator();n&&t.push(n.forceCompilationAsync())}return Promise.all(t).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(t){for(let i of this._extensions)i.enabled&&t(i)}_applyExtensions(t,i,r){for(let n of this._extensions)if(n.enabled){let o=`${n.name}.${i}`,a=t;a._activeLoaderExtensionFunctions=a._activeLoaderExtensionFunctions||{};let l=a._activeLoaderExtensionFunctions;if(!l[o]){l[o]=!0;try{let c=r(n);if(c)return c}finally{delete l[o]}}}return null}_extensionsOnLoading(){this._forEachExtensions(t=>t.onLoading&&t.onLoading())}_extensionsOnReady(){this._forEachExtensions(t=>t.onReady&&t.onReady())}_extensionsLoadSceneAsync(t,i){return this._applyExtensions(i,"loadScene",r=>r.loadSceneAsync&&r.loadSceneAsync(t,i))}_extensionsLoadNodeAsync(t,i,r){return this._applyExtensions(i,"loadNode",n=>n.loadNodeAsync&&n.loadNodeAsync(t,i,r))}_extensionsLoadCameraAsync(t,i,r){return this._applyExtensions(i,"loadCamera",n=>n.loadCameraAsync&&n.loadCameraAsync(t,i,r))}_extensionsLoadVertexDataAsync(t,i,r){return this._applyExtensions(i,"loadVertexData",n=>n._loadVertexDataAsync&&n._loadVertexDataAsync(t,i,r))}_extensionsLoadMeshPrimitiveAsync(t,i,r,n,o,a){return this._applyExtensions(o,"loadMeshPrimitive",l=>l._loadMeshPrimitiveAsync&&l._loadMeshPrimitiveAsync(t,i,r,n,o,a))}_extensionsLoadMaterialAsync(t,i,r,n,o){return this._applyExtensions(i,"loadMaterial",a=>a._loadMaterialAsync&&a._loadMaterialAsync(t,i,r,n,o))}_extensionsCreateMaterial(t,i,r){return this._applyExtensions(i,"createMaterial",n=>n.createMaterial&&n.createMaterial(t,i,r))}_extensionsLoadMaterialPropertiesAsync(t,i,r){return this._applyExtensions(i,"loadMaterialProperties",n=>n.loadMaterialPropertiesAsync&&n.loadMaterialPropertiesAsync(t,i,r))}_extensionsLoadTextureInfoAsync(t,i,r){return this._applyExtensions(i,"loadTextureInfo",n=>n.loadTextureInfoAsync&&n.loadTextureInfoAsync(t,i,r))}_extensionsLoadTextureAsync(t,i,r){return this._applyExtensions(i,"loadTexture",n=>n._loadTextureAsync&&n._loadTextureAsync(t,i,r))}_extensionsLoadAnimationAsync(t,i){return this._applyExtensions(i,"loadAnimation",r=>r.loadAnimationAsync&&r.loadAnimationAsync(t,i))}_extensionsLoadAnimationChannelAsync(t,i,r,n,o){return this._applyExtensions(r,"loadAnimationChannel",a=>a._loadAnimationChannelAsync&&a._loadAnimationChannelAsync(t,i,r,n,o))}_extensionsLoadSkinAsync(t,i,r){return this._applyExtensions(r,"loadSkin",n=>n._loadSkinAsync&&n._loadSkinAsync(t,i,r))}_extensionsLoadUriAsync(t,i,r){return this._applyExtensions(i,"loadUri",n=>n._loadUriAsync&&n._loadUriAsync(t,i,r))}_extensionsLoadBufferViewAsync(t,i){return this._applyExtensions(i,"loadBufferView",r=>r.loadBufferViewAsync&&r.loadBufferViewAsync(t,i))}_extensionsLoadBufferAsync(t,i,r,n){return this._applyExtensions(i,"loadBuffer",o=>o.loadBufferAsync&&o.loadBufferAsync(t,i,r,n))}static LoadExtensionAsync(t,i,r,n){if(!i.extensions)return null;let a=i.extensions[r];return a?n(`${t}/extensions/${r}`,a):null}static LoadExtraAsync(t,i,r,n){if(!i.extras)return null;let a=i.extras[r];return a?n(`${t}/extras/${r}`,a):null}isExtensionUsed(t){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(t)!==-1}logOpen(t){this._parent._logOpen(t)}logClose(){this._parent._logClose()}log(t){this._parent._log(t)}startPerformanceCounter(t){this._parent._startPerformanceCounter(t)}endPerformanceCounter(t){this._parent._endPerformanceCounter(t)}}return s._RegisteredExtensions={},s.DefaultSampler={index:-1},s})();Ra._CreateGLTF2Loader=s=>new Ne(s);var cD="EXT_lights_image_based",hD=class{constructor(e){this.name=cD,this._loader=e,this.enabled=this._loader.isExtensionUsed(cD)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return Ne.LoadExtensionAsync(e,t,this.name,(i,r)=>{this._loader._allMaterialsDirtyRequired=!0;let n=new Array;n.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${i}`);let o=Ve.Get(`${i}/light`,this._lights,r.light);return n.push(this._loadLightAsync(`/extensions/${this.name}/lights/${r.light}`,o).then(a=>{this._loader.babylonScene.environmentTexture=a})),this._loader.logClose(),Promise.all(n).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){let i=new Array;this._loader.logOpen(`${e}`);let r=new Array(t.specularImages.length);for(let n=0;n<t.specularImages.length;n++){let o=t.specularImages[n];r[n]=new Array(o.length);for(let a=0;a<o.length;a++){let l=`${e}/specularImages/${n}/${a}`;this._loader.logOpen(`${l}`);let c=o[a],h=Ve.Get(l,this._loader.gltf.images,c);i.push(this._loader.loadImageAsync(`/images/${c}`,h).then(u=>{r[n][a]=u})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(i).then(()=>{let n=new zT(this._loader.babylonScene,null,t.specularImageSize);if(n.name=t.name||"environment",t._babylonTexture=n,t.intensity!=null&&(n.level=t.intensity),t.rotation){let c=q.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(c=q.Inverse(c)),N.FromQuaternionToRef(c,n.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);let o=tl.FromArray(t.irradianceCoefficients);o.scaleInPlace(t.intensity),o.convertIrradianceToLambertianRadiance();let a=vs.FromHarmonics(o),l=(r.length-1)/xe.Log2(t.specularImageSize);return n.updateRGBDAsync(r,a,l)})}return t._loaded.then(()=>t._babylonTexture)}};Ne.RegisterExtension(cD,s=>new hD(s));var uD="EXT_mesh_gpu_instancing",dD=class{constructor(e){this.name=uD,this._loader=e,this.enabled=this._loader.isExtensionUsed(uD)}dispose(){this._loader=null}loadNodeAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{this._loader._disableInstancedMesh++;let o=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,i);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return o;let a=new Array,l=0,c=h=>{if(n.attributes[h]==null){a.push(Promise.resolve(null));return}let u=Ve.Get(`${r}/attributes/${h}`,this._loader.gltf.accessors,n.attributes[h]);if(a.push(this._loader._loadFloatAccessorAsync(`/accessors/${u.bufferView}`,u)),l===0)l=u.count;else if(l!==u.count)throw new Error(`${r}/attributes: Instance buffer accessors do not have the same count.`)};return c("TRANSLATION"),c("ROTATION"),c("SCALE"),o.then(h=>Promise.all(a).then(([u,d,f])=>{let m=new Float32Array(l*16);O.Vector3[0].copyFromFloats(0,0,0),O.Quaternion[0].copyFromFloats(0,0,0,1),O.Vector3[1].copyFromFloats(1,1,1);for(let g=0;g<l;++g)u&&p.FromArrayToRef(u,g*3,O.Vector3[0]),d&&q.FromArrayToRef(d,g*4,O.Quaternion[0]),f&&p.FromArrayToRef(f,g*3,O.Vector3[1]),N.ComposeToRef(O.Vector3[1],O.Quaternion[0],O.Vector3[0],O.Matrix[0]),O.Matrix[0].copyToArray(m,g*16);for(let g of t._primitiveBabylonMeshes)g.thinInstanceSetBuffer("matrix",m,16,!0);return h}))})}};Ne.RegisterExtension(uD,s=>new dD(s));var fD="EXT_meshopt_compression",pD=class{constructor(e){this.name=fD,this.enabled=e.isExtensionUsed(fD),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return Ne.LoadExtensionAsync(e,t,this.name,(i,r)=>{let n=t;if(n._meshOptData)return n._meshOptData;let o=Ve.Get(`${e}/buffer`,this._loader.gltf.buffers,r.buffer);return n._meshOptData=this._loader.loadBufferAsync(`/buffers/${o.index}`,o,r.byteOffset||0,r.byteLength).then(a=>rf.Default.decodeGltfBufferAsync(a,r.count,r.byteStride,r.mode,r.filter)),n._meshOptData})}};Ne.RegisterExtension(fD,s=>new pD(s));var mD="EXT_texture_webp",gD=class{constructor(e){this.name=mD,this._loader=e,this.enabled=e.isExtensionUsed(mD)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=t.sampler==null?Ne.DefaultSampler:Ve.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=Ve.Get(`${r}/source`,this._loader.gltf.images,n.source);return this._loader._createTextureAsync(e,o,a,l=>{i(l)},void 0,!t._textureInfo.nonColorData)})}};Ne.RegisterExtension(mD,s=>new gD(s));var _D="EXT_texture_avif",xD=class{constructor(e){this.name=_D,this._loader=e,this.enabled=e.isExtensionUsed(_D)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=t.sampler==null?Ne.DefaultSampler:Ve.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=Ve.Get(`${r}/source`,this._loader.gltf.images,n.source);return this._loader._createTextureAsync(e,o,a,l=>{i(l)},void 0,!t._textureInfo.nonColorData)})}};Ne.RegisterExtension(_D,s=>new xD(s));var vD="KHR_draco_mesh_compression",TD=class{constructor(e){this.name=vD,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=hl.DecoderAvailable&&this._loader.isExtensionUsed(vD)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{if(t.mode!=null&&t.mode!==4&&t.mode!==5)throw new Error(`${e}: Unsupported mode ${t.mode}`);let o={},a={},l=(h,u)=>{let d=n.attributes[h];if(d!=null&&(i._delayInfo=i._delayInfo||[],i._delayInfo.indexOf(u)===-1&&i._delayInfo.push(u),o[u]=d,this.useNormalizedFlagFromAccessor)){let f=Ve.TryGet(this._loader.gltf.accessors,t.attributes[h]);f&&(a[u]=f.normalized||!1)}};l("POSITION",y.PositionKind),l("NORMAL",y.NormalKind),l("TANGENT",y.TangentKind),l("TEXCOORD_0",y.UVKind),l("TEXCOORD_1",y.UV2Kind),l("TEXCOORD_2",y.UV3Kind),l("TEXCOORD_3",y.UV4Kind),l("TEXCOORD_4",y.UV5Kind),l("TEXCOORD_5",y.UV6Kind),l("JOINTS_0",y.MatricesIndicesKind),l("WEIGHTS_0",y.MatricesWeightsKind),l("COLOR_0",y.ColorKind);let c=Ve.Get(r,this._loader.gltf.bufferViews,n.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${c.index}`,c).then(h=>(this.dracoCompression||hl.Default)._decodeMeshToGeometryForGltfAsync(i.name,this._loader.babylonScene,h,o,a).catch(d=>{throw new Error(`${e}: ${d.message}`)}))),c._dracoBabylonGeometry})}};Ne.RegisterExtension(vD,s=>new TD(s));var CD="KHR_lights_punctual",bD=class{constructor(e){this.name=CD,this._loader=e,this.enabled=this._loader.isExtensionUsed(CD)}dispose(){this._loader=null,delete this._lights}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._lights=t.lights,Ve.Assign(this._lights)}}loadNodeAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>(this._loader._allMaterialsDirtyRequired=!0,this._loader.loadNodeAsync(e,t,o=>{let a,l=Ve.Get(r,this._lights,n.light),c=l.name||o.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{let h=new Cr(c,p.Backward(),this._loader.babylonScene);h.position.setAll(0),a=h;break}case"point":{a=new In(c,p.Zero(),this._loader.babylonScene);break}case"spot":{let h=new Hr(c,p.Zero(),p.Backward(),0,1,this._loader.babylonScene);h.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,h.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,a=h;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${r}: Invalid light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=tt.FALLOFF_GLTF,a.diffuse=l.color?X.FromArray(l.color):X.White(),a.intensity=l.intensity==null?1:l.intensity,a.range=l.range==null?Number.MAX_VALUE:l.range,a.parent=o,this._loader._babylonLights.push(a),Ne.AddPointerMetadata(a,r),i(o)})))}};Ne.RegisterExtension(CD,s=>new bD(s));var SD="KHR_materials_pbrSpecularGlossiness",yD=class{constructor(e){this.name=SD,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(SD)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),o.push(this._loadSpecularGlossinessPropertiesAsync(r,n,i)),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(o).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,i){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.metallic=null,i.roughness=null,t.diffuseFactor?(i.albedoColor=X.FromArray(t.diffuseFactor),i.alpha=t.diffuseFactor[3]):i.albedoColor=X.White(),i.reflectivityColor=t.specularFactor?X.FromArray(t.specularFactor):X.White(),i.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,n=>{n.name=`${i.name} (Diffuse)`,i.albedoTexture=n})),t.specularGlossinessTexture&&(r.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,n=>{n.name=`${i.name} (Specular Glossiness)`,i.reflectivityTexture=n,i.reflectivityTexture.hasAlpha=!0})),i.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(r).then(()=>{})}};Ne.RegisterExtension(SD,s=>new yD(s));var ED="KHR_materials_unlit",AD=class{constructor(e){this.name=ED,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(ED)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,()=>this._loadUnlitPropertiesAsync(e,t,i))}_loadUnlitPropertiesAsync(e,t,i){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);let r=new Array;i.unlit=!0;let n=t.pbrMetallicRoughness;return n&&(n.baseColorFactor?(i.albedoColor=X.FromArray(n.baseColorFactor),i.alpha=n.baseColorFactor[3]):i.albedoColor=X.White(),n.baseColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,n.baseColorTexture,o=>{o.name=`${i.name} (Base Color)`,i.albedoTexture=o}))),t.doubleSided&&(i.backFaceCulling=!1,i.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,i),Promise.all(r).then(()=>{})}};Ne.RegisterExtension(ED,s=>new AD(s));var ID="KHR_materials_clearcoat",RD=class{constructor(e){this.name=ID,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(ID)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadClearCoatPropertiesAsync(r,n,i)),Promise.all(o).then(()=>{})})}_loadClearCoatPropertiesAsync(e,t,i){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.clearCoat.isEnabled=!0,i.clearCoat.useRoughnessFromMainTexture=!1,i.clearCoat.remapF0OnInterfaceChange=!1,t.clearcoatFactor!=null?i.clearCoat.intensity=t.clearcoatFactor:i.clearCoat.intensity=0,t.clearcoatTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,n=>{n.name=`${i.name} (ClearCoat Intensity)`,i.clearCoat.texture=n})),t.clearcoatRoughnessFactor!=null?i.clearCoat.roughness=t.clearcoatRoughnessFactor:i.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,n=>{n.name=`${i.name} (ClearCoat Roughness)`,i.clearCoat.textureRoughness=n}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,n=>{n.name=`${i.name} (ClearCoat Normal)`,i.clearCoat.bumpTexture=n})),i.invertNormalMapX=!i.getScene().useRightHandedSystem,i.invertNormalMapY=i.getScene().useRightHandedSystem,t.clearcoatNormalTexture.scale!=null&&(i.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(r).then(()=>{})}};Ne.RegisterExtension(ID,s=>new RD(s));var PD="KHR_materials_iridescence",MD=class{constructor(e){this.name=PD,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(PD)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadIridescencePropertiesAsync(r,n,i)),Promise.all(o).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,i){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.iridescence.isEnabled=!0,i.iridescence.intensity=t.iridescenceFactor??0,i.iridescence.indexOfRefraction=t.iridescenceIor??t.iridescenceIOR??1.3,i.iridescence.minimumThickness=t.iridescenceThicknessMinimum??100,i.iridescence.maximumThickness=t.iridescenceThicknessMaximum??400,t.iridescenceTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,n=>{n.name=`${i.name} (Iridescence Intensity)`,i.iridescence.texture=n})),t.iridescenceThicknessTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,n=>{n.name=`${i.name} (Iridescence Thickness)`,i.iridescence.thicknessTexture=n})),Promise.all(r).then(()=>{})}};Ne.RegisterExtension(PD,s=>new MD(s));var DD="KHR_materials_anisotropy",OD=class{constructor(e){this.name=DD,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(DD)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadIridescencePropertiesAsync(r,n,i)),Promise.all(o).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,i){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.anisotropy.isEnabled=!0,i.anisotropy.intensity=t.anisotropyStrength??0,i.anisotropy.angle=t.anisotropyRotation??0,t.anisotropyTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,n=>{n.name=`${i.name} (Anisotropy Intensity)`,i.anisotropy.texture=n})),Promise.all(r).then(()=>{})}};Ne.RegisterExtension(DD,s=>new OD(s));var wD="KHR_materials_emissive_strength",ND=class{constructor(e){this.name=wD,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(wD)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>this._loader.loadMaterialPropertiesAsync(e,t,i).then(()=>{this._loadEmissiveProperties(r,n,i)}))}_loadEmissiveProperties(e,t,i){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);t.emissiveStrength!==void 0&&(i.emissiveIntensity=t.emissiveStrength)}};Ne.RegisterExtension(wD,s=>new ND(s));var FD="KHR_materials_sheen",LD=class{constructor(e){this.name=FD,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(FD)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadSheenPropertiesAsync(r,n,i)),Promise.all(o).then(()=>{})})}_loadSheenPropertiesAsync(e,t,i){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);let r=new Array;return i.sheen.isEnabled=!0,i.sheen.intensity=1,t.sheenColorFactor!=null?i.sheen.color=X.FromArray(t.sheenColorFactor):i.sheen.color=X.Black(),t.sheenColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,n=>{n.name=`${i.name} (Sheen Color)`,i.sheen.texture=n})),t.sheenRoughnessFactor!==void 0?i.sheen.roughness=t.sheenRoughnessFactor:i.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,n=>{n.name=`${i.name} (Sheen Roughness)`,i.sheen.textureRoughness=n}))),i.sheen.albedoScaling=!0,i.sheen.useRoughnessFromMainTexture=!1,Promise.all(r).then(()=>{})}};Ne.RegisterExtension(FD,s=>new LD(s));var BD="KHR_materials_specular",VD=class{constructor(e){this.name=BD,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(BD)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadSpecularPropertiesAsync(r,n,i)),Promise.all(o).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,i){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);let r=new Array;return t.specularFactor!==void 0&&(i.metallicF0Factor=t.specularFactor),t.specularColorFactor!==void 0&&(i.metallicReflectanceColor=X.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,r.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,n=>{n.name=`${i.name} (Specular F0 Strength)`,i.metallicReflectanceTexture=n,i.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),t.specularColorTexture&&r.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,n=>{n.name=`${i.name} (Specular F0 Color)`,i.reflectanceTexture=n})),Promise.all(r).then(()=>{})}};Ne.RegisterExtension(BD,s=>new VD(s));var UD="KHR_materials_ior",iJ=(()=>{class s{constructor(t){this.name=UD,this.order=180,this._loader=t,this.enabled=this._loader.isExtensionUsed(UD)}dispose(){this._loader=null}loadMaterialPropertiesAsync(t,i,r){return Ne.LoadExtensionAsync(t,i,this.name,(n,o)=>{let a=new Array;return a.push(this._loader.loadMaterialPropertiesAsync(t,i,r)),a.push(this._loadIorPropertiesAsync(n,o,r)),Promise.all(a).then(()=>{})})}_loadIorPropertiesAsync(t,i,r){if(!(r instanceof Pe))throw new Error(`${t}: Material type not supported`);return i.ior!==void 0?r.indexOfRefraction=i.ior:r.indexOfRefraction=s._DEFAULT_IOR,Promise.resolve()}}return s._DEFAULT_IOR=1.5,s})();Ne.RegisterExtension(UD,s=>new iJ(s));var Gs="KHR_materials_variants",kD=class s{constructor(e){this.name=Gs,this._loader=e,this.enabled=this._loader.isExtensionUsed(Gs)}dispose(){this._loader=null}static GetAvailableVariants(e){let t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return s.GetAvailableVariants(e)}static SelectVariant(e,t){let i=this._GetExtensionMetadata(e);if(!i)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${Gs} extension`);let r=n=>{let o=i.variants[n];if(o)for(let a of o)a.mesh.material=a.material};if(t instanceof Array)for(let n of t)r(n);else r(t);i.lastSelected=t}selectVariant(e,t){s.SelectVariant(e,t)}static Reset(e){let t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${Gs} extension`);for(let i of t.original)i.mesh.material=i.material;t.lastSelected=null}reset(e){s.Reset(e)}static GetLastSelectedVariant(e){let t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${Gs} extension`);return t.lastSelected}getLastSelectedVariant(e){return s.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){return e?._internalMetadata?.gltf?.[Gs]||null}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._variants=t.variants}}_loadMeshPrimitiveAsync(e,t,i,r,n,o){return Ne.LoadExtensionAsync(e,n,this.name,(a,l)=>{let c=new Array;return c.push(this._loader._loadMeshPrimitiveAsync(e,t,i,r,n,h=>{if(o(h),h instanceof k){let u=Ne._GetDrawMode(e,n.mode),d=this._loader.rootBabylonMesh,f=d?d._internalMetadata=d._internalMetadata||{}:{},m=f.gltf=f.gltf||{},g=m[Gs]=m[Gs]||{lastSelected:null,original:[],variants:{}};g.original.push({mesh:h,material:h.material});for(let _=0;_<l.mappings.length;++_){let x=l.mappings[_],b=Ve.Get(`${a}/mappings/${_}/material`,this._loader.gltf.materials,x.material);c.push(this._loader._loadMaterialAsync(`#/materials/${x.material}`,b,h,u,C=>{for(let R=0;R<x.variants.length;++R){let E=x.variants[R],S=Ve.Get(`/extensions/${Gs}/variants/${E}`,this._variants,E);g.variants[S.name]=g.variants[S.name]||[],g.variants[S.name].push({mesh:h,material:C}),h.onClonedObservable.add(A=>{let L=A,G=null,W=L;do{if(W=W.parent,!W)return;G=s._GetExtensionMetadata(W)}while(G===null);if(d&&G===s._GetExtensionMetadata(d)){W._internalMetadata={};for(let $ in d._internalMetadata)W._internalMetadata[$]=d._internalMetadata[$];W._internalMetadata.gltf=[];for(let $ in d._internalMetadata.gltf)W._internalMetadata.gltf[$]=d._internalMetadata.gltf[$];W._internalMetadata.gltf[Gs]={lastSelected:null,original:[],variants:{}};for(let $ of G.original)W._internalMetadata.gltf[Gs].original.push({mesh:$.mesh,material:$.material});for(let $ in G.variants)if(Object.prototype.hasOwnProperty.call(G.variants,$)){W._internalMetadata.gltf[Gs].variants[$]=[];for(let re of G.variants[$])W._internalMetadata.gltf[Gs].variants[$].push({mesh:re.mesh,material:re.material})}G=W._internalMetadata.gltf[Gs]}for(let $ of G.original)$.mesh===h&&($.mesh=L);for(let $ of G.variants[S.name])$.mesh===h&&($.mesh=L)})}}))}}})),Promise.all(c).then(([h])=>h)})}};Ne.RegisterExtension(Gs,s=>new kD(s));var GD=class s{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:Za.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options=ie(ie({},s._GetDefaultOptions()),e),this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new U,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(n=>this._options[n]!==e[n]).length)return;let i=ie(ie({},this._options),e),r=this._options;this._options=i,i.renderSize!==r.renderSize||i.renderTargetTextureType!==r.renderTargetTextureType||i.generateMipmaps!==r.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=i.samples,this._opaqueRenderTarget.lodGenerationScale=i.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=i.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return e?!!(e instanceof Pe&&e.subSurface.isRefractionEnabled):!1}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),H.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){let t=this._transparentMeshesCache.indexOf(e),i=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof Pe&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),i!==-1?(this._opaqueMeshesCache.splice(i,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)):t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):i===-1&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){return this._opaqueRenderTarget?.getInternalTexture()!==null}_setupRenderTargets(){this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new vt("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=this._options.clearColor?.clone()??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0;let e,t;this._opaqueRenderTarget.onBeforeBindObservable.add(i=>{t=this._scene.environmentIntensity,this._scene.environmentIntensity=1,e=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?i.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(i.clearColor,this._scene.getEngine().useExactSrgbConversions),this._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=t,this._scene.imageProcessingConfiguration._applyByPostProcess=e}),this._transparentMeshesCache.forEach(i=>{this._shouldRenderAsTransmission(i.material)&&(i.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}},zD="KHR_materials_transmission",WD=class{constructor(e){this.name=zD,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(zD),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadTransparentPropertiesAsync(r,t,i,n)),Promise.all(o).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,i,r){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);let n=i;if(n.subSurface.isRefractionEnabled=!0,n.subSurface.volumeIndexOfRefraction=1,n.subSurface.useAlbedoToTintRefraction=!0,r.transmissionFactor!==void 0){n.subSurface.refractionIntensity=r.transmissionFactor;let o=n.getScene();n.subSurface.refractionIntensity&&!o._transmissionHelper?new GD({},n.getScene()):n.subSurface.refractionIntensity&&!o._transmissionHelper?._isRenderTargetValid()&&o._transmissionHelper?._setupRenderTargets()}else return n.subSurface.refractionIntensity=0,n.subSurface.isRefractionEnabled=!1,Promise.resolve();return n.subSurface.minimumThickness=0,n.subSurface.maximumThickness=0,r.transmissionTexture?(r.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,r.transmissionTexture,void 0).then(o=>{n.subSurface.refractionIntensityTexture=o,n.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}};Ne.RegisterExtension(zD,s=>new WD(s));var HD="KHR_materials_diffuse_transmission",XD=class{constructor(e){this.name=HD,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(HD),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadTranslucentPropertiesAsync(r,t,i,n)),Promise.all(o).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,i,r){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);let n=i;if(n.subSurface.isTranslucencyEnabled=!0,n.subSurface.volumeIndexOfRefraction=1,n.subSurface.minimumThickness=0,n.subSurface.maximumThickness=0,n.subSurface.useAlbedoToTintTranslucency=!1,r.diffuseTransmissionFactor!==void 0)n.subSurface.translucencyIntensity=r.diffuseTransmissionFactor;else return n.subSurface.translucencyIntensity=0,n.subSurface.isTranslucencyEnabled=!1,Promise.resolve();let o=new Array;return n.subSurface.useGltfStyleTextures=!0,r.diffuseTransmissionTexture&&(r.diffuseTransmissionTexture.nonColorData=!0,o.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionTexture`,r.diffuseTransmissionTexture).then(a=>{n.subSurface.translucencyIntensityTexture=a}))),r.diffuseTransmissionColorFactor!==void 0?n.subSurface.translucencyColor=X.FromArray(r.diffuseTransmissionColorFactor):n.subSurface.translucencyColor=X.White(),r.diffuseTransmissionColorTexture&&o.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTransmissionColorTexture`,r.diffuseTransmissionColorTexture).then(a=>{n.subSurface.translucencyColorTexture=a})),Promise.all(o).then(()=>{})}};Ne.RegisterExtension(HD,s=>new XD(s));var YD="KHR_materials_volume",$D=class{constructor(e){this.name=YD,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(YD),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadVolumePropertiesAsync(r,t,i,n)),Promise.all(o).then(()=>{})})}_loadVolumePropertiesAsync(e,t,i,r){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);if(!i.subSurface.isRefractionEnabled&&!i.subSurface.isTranslucencyEnabled||!r.thicknessFactor)return Promise.resolve();i.subSurface.volumeIndexOfRefraction=i.indexOfRefraction;let n=r.attenuationDistance!==void 0?r.attenuationDistance:Number.MAX_VALUE;return i.subSurface.tintColorAtDistance=n,r.attenuationColor!==void 0&&r.attenuationColor.length==3&&i.subSurface.tintColor.copyFromFloats(r.attenuationColor[0],r.attenuationColor[1],r.attenuationColor[2]),i.subSurface.minimumThickness=0,i.subSurface.maximumThickness=r.thicknessFactor,i.subSurface.useThicknessAsDepth=!0,r.thicknessTexture?(r.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,r.thicknessTexture).then(o=>{i.subSurface.thicknessTexture=o,i.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}};Ne.RegisterExtension(YD,s=>new $D(s));var jD="KHR_materials_dispersion",qD=class{constructor(e){this.name=jD,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(jD)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,i)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,i)),o.push(this._loadDispersionPropertiesAsync(r,t,i,n)),Promise.all(o).then(()=>{})})}_loadDispersionPropertiesAsync(e,t,i,r){if(!(i instanceof Pe))throw new Error(`${e}: Material type not supported`);return!i.subSurface.isRefractionEnabled||!r.dispersion||(i.subSurface.isDispersionEnabled=!0,i.subSurface.dispersion=r.dispersion),Promise.resolve()}};Ne.RegisterExtension(jD,s=>new qD(s));var QD="KHR_mesh_quantization",KD=class{constructor(e){this.name=QD,this.enabled=e.isExtensionUsed(QD)}dispose(){}};Ne.RegisterExtension(QD,s=>new KD(s));var ZD="KHR_texture_basisu",JD=class{constructor(e){this.name=ZD,this._loader=e,this.enabled=e.isExtensionUsed(ZD)}dispose(){this._loader=null}_loadTextureAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=t.sampler==null?Ne.DefaultSampler:Ve.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=Ve.Get(`${r}/source`,this._loader.gltf.images,n.source);return this._loader._createTextureAsync(e,o,a,l=>{i(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}};Ne.RegisterExtension(ZD,s=>new JD(s));var eO="KHR_texture_transform",tO=class{constructor(e){this.name=eO,this._loader=e,this.enabled=this._loader.isExtensionUsed(eO)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>this._loader.loadTextureInfoAsync(e,t,o=>{if(!(o instanceof z))throw new Error(`${r}: Texture type not supported`);n.offset&&(o.uOffset=n.offset[0],o.vOffset=n.offset[1]),o.uRotationCenter=0,o.vRotationCenter=0,n.rotation&&(o.wAng=-n.rotation),n.scale&&(o.uScale=n.scale[0],o.vScale=n.scale[1]),n.texCoord!=null&&(o.coordinatesIndex=n.texCoord),i(o)}))}};Ne.RegisterExtension(eO,s=>new tO(s));var iO="KHR_xmp_json_ld",rO=class{constructor(e){this.name=iO,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(iO)}dispose(){this._loader=null}onLoading(){if(this._loader.rootBabylonMesh===null)return;let e=this._loader.gltf.extensions?.KHR_xmp_json_ld,t=this._loader.gltf.asset?.extensions?.KHR_xmp_json_ld;if(e&&t){let i=+t.packet;e.packets&&i<e.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=e.packets[i])}}};Ne.RegisterExtension(iO,s=>new rO(s));function au(s,e,t,i){return X.FromArray(e,t).scale(i)}function rJ(s,e,t,i){return e[t+3]*i}function Ei(s,e,t,i){return e[t]*i}function sO(s,e,t,i){return-e[t]*i}function LS(s,e,t,i){return e[t+1]*i}function v2(s,e,t,i){return e[t]*i*2}function Yr(s){return{scale:[new ri(te.ANIMATIONTYPE_FLOAT,`${s}.uScale`,Ei,()=>2),new ri(te.ANIMATIONTYPE_FLOAT,`${s}.vScale`,LS,()=>2)],offset:[new ri(te.ANIMATIONTYPE_FLOAT,`${s}.uOffset`,Ei,()=>2),new ri(te.ANIMATIONTYPE_FLOAT,`${s}.vOffset`,LS,()=>2)],rotation:[new ri(te.ANIMATIONTYPE_FLOAT,`${s}.wAng`,sO,()=>1)]}}var ko=class extends xc{buildAnimations(e,t,i,r,n){n(e._babylonCamera,this._buildAnimation(t,i,r))}},ri=class extends xc{buildAnimations(e,t,i,r,n){for(let o in e._data)n(e._data[o].babylonMaterial,this._buildAnimation(t,i,r))}},lu=class extends xc{buildAnimations(e,t,i,r,n){n(e._babylonLight,this._buildAnimation(t,i,r))}},sJ={__array__:ie({__target__:!0},ou)},nJ={__array__:{__target__:!0,orthographic:{xmag:[new ko(te.ANIMATIONTYPE_FLOAT,"orthoLeft",sO,()=>1),new ko(te.ANIMATIONTYPE_FLOAT,"orthoRight",LS,()=>1)],ymag:[new ko(te.ANIMATIONTYPE_FLOAT,"orthoBottom",sO,()=>1),new ko(te.ANIMATIONTYPE_FLOAT,"orthoTop",LS,()=>1)],zfar:[new ko(te.ANIMATIONTYPE_FLOAT,"maxZ",Ei,()=>1)],znear:[new ko(te.ANIMATIONTYPE_FLOAT,"minZ",Ei,()=>1)]},perspective:{yfov:[new ko(te.ANIMATIONTYPE_FLOAT,"fov",Ei,()=>1)],zfar:[new ko(te.ANIMATIONTYPE_FLOAT,"maxZ",Ei,()=>1)],znear:[new ko(te.ANIMATIONTYPE_FLOAT,"minZ",Ei,()=>1)]}}},oJ={__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new ri(te.ANIMATIONTYPE_COLOR3,"albedoColor",au,()=>4),new ri(te.ANIMATIONTYPE_FLOAT,"alpha",rJ,()=>4)],metallicFactor:[new ri(te.ANIMATIONTYPE_FLOAT,"metallic",Ei,()=>1)],roughnessFactor:[new ri(te.ANIMATIONTYPE_FLOAT,"roughness",Ei,()=>1)],baseColorTexture:{extensions:{KHR_texture_transform:Yr("albedoTexture")}},metallicRoughnessTexture:{extensions:{KHR_texture_transform:Yr("metallicTexture")}}},emissiveFactor:[new ri(te.ANIMATIONTYPE_COLOR3,"emissiveColor",au,()=>3)],normalTexture:{scale:[new ri(te.ANIMATIONTYPE_FLOAT,"bumpTexture.level",Ei,()=>1)],extensions:{KHR_texture_transform:Yr("bumpTexture")}},occlusionTexture:{strength:[new ri(te.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",Ei,()=>1)],extensions:{KHR_texture_transform:Yr("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:Yr("emissiveTexture")}},extensions:{KHR_materials_anisotropy:{anisotropyStrength:[new ri(te.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",Ei,()=>1)],anisotropyRotation:[new ri(te.ANIMATIONTYPE_FLOAT,"anisotropy.angle",Ei,()=>1)],anisotropyTexture:{extensions:{KHR_texture_transform:Yr("anisotropy.texture")}}},KHR_materials_clearcoat:{clearcoatFactor:[new ri(te.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",Ei,()=>1)],clearcoatRoughnessFactor:[new ri(te.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",Ei,()=>1)],clearcoatTexture:{extensions:{KHR_texture_transform:Yr("clearCoat.texture")}},clearcoatNormalTexture:{scale:[new ri(te.ANIMATIONTYPE_FLOAT,"clearCoat.bumpTexture.level",Ei,()=>1)],extensions:{KHR_texture_transform:Yr("clearCoat.bumpTexture")}},clearcoatRoughnessTexture:{extensions:{KHR_texture_transform:Yr("clearCoat.textureRoughness")}}},KHR_materials_dispersion:{dispersion:[new ri(te.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",Ei,()=>1)]},KHR_materials_emissive_strength:{emissiveStrength:[new ri(te.ANIMATIONTYPE_FLOAT,"emissiveIntensity",Ei,()=>1)]},KHR_materials_ior:{ior:[new ri(te.ANIMATIONTYPE_FLOAT,"indexOfRefraction",Ei,()=>1)]},KHR_materials_iridescence:{iridescenceFactor:[new ri(te.ANIMATIONTYPE_FLOAT,"iridescence.intensity",Ei,()=>1)],iridescenceIor:[new ri(te.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",Ei,()=>1)],iridescenceThicknessMinimum:[new ri(te.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",Ei,()=>1)],iridescenceThicknessMaximum:[new ri(te.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",Ei,()=>1)],iridescenceTexture:{extensions:{KHR_texture_transform:Yr("iridescence.texture")}},iridescenceThicknessTexture:{extensions:{KHR_texture_transform:Yr("iridescence.thicknessTexture")}}},KHR_materials_sheen:{sheenColorFactor:[new ri(te.ANIMATIONTYPE_COLOR3,"sheen.color",au,()=>3)],sheenRoughnessFactor:[new ri(te.ANIMATIONTYPE_FLOAT,"sheen.roughness",Ei,()=>1)],sheenColorTexture:{extensions:{KHR_texture_transform:Yr("sheen.texture")}},sheenRoughnessTexture:{extensions:{KHR_texture_transform:Yr("sheen.textureRoughness")}}},KHR_materials_specular:{specularFactor:[new ri(te.ANIMATIONTYPE_FLOAT,"metallicF0Factor",Ei,()=>1)],specularColorFactor:[new ri(te.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",au,()=>3)],specularTexture:{extensions:{KHR_texture_transform:Yr("metallicReflectanceTexture")}},specularColorTexture:{extensions:{KHR_texture_transform:Yr("reflectanceTexture")}}},KHR_materials_transmission:{transmissionFactor:[new ri(te.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",Ei,()=>1)],transmissionTexture:{extensions:{KHR_texture_transform:Yr("subSurface.refractionIntensityTexture")}}},KHR_materials_volume:{attenuationColor:[new ri(te.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",au,()=>3)],attenuationDistance:[new ri(te.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",Ei,()=>1)],thicknessFactor:[new ri(te.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",Ei,()=>1)],thicknessTexture:{extensions:{KHR_texture_transform:Yr("subSurface.thicknessTexture")}}},KHR_materials_diffuse_transmission:{diffuseTransmissionFactor:[new ri(te.ANIMATIONTYPE_FLOAT,"subSurface.translucencyIntensity",Ei,()=>1)],diffuseTransmissionTexture:{extensions:{KHR_texture_transform:Yr("subSurface.translucencyIntensityTexture")}},diffuseTransmissionColorFactor:[new ri(te.ANIMATIONTYPE_COLOR3,"subSurface.translucencyColor",au,()=>3)],diffuseTransmissionColorTexture:{extensions:{KHR_texture_transform:Yr("subSurface.translucencyColorTexture")}}}}}},aJ={KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new lu(te.ANIMATIONTYPE_COLOR3,"diffuse",au,()=>3)],intensity:[new lu(te.ANIMATIONTYPE_FLOAT,"intensity",Ei,()=>1)],range:[new lu(te.ANIMATIONTYPE_FLOAT,"range",Ei,()=>1)],spot:{innerConeAngle:[new lu(te.ANIMATIONTYPE_FLOAT,"innerAngle",v2,()=>1)],outerConeAngle:[new lu(te.ANIMATIONTYPE_FLOAT,"angle",v2,()=>1)]}}}}},T2={nodes:sJ,materials:oJ,cameras:nJ,extensions:aJ};var Of=class{constructor(e,t){this._gltf=e,this._infoTree=t}convert(e){let t=this._gltf,i=this._infoTree,r;if(!e.startsWith("/"))throw new Error("Path must start with a /");let n=e.split("/");n.shift();for(let o of n){if(i.__array__)i=i.__array__;else if(i=i[o],!i)throw new Error(`Path ${e} is invalid`);if(t===void 0)throw new Error(`Path ${e} is invalid`);t=t[o],i.__target__&&(r=t)}return{object:r,info:i}}};var nO="KHR_animation_pointer",oO=class extends Of{constructor(e){super(e,T2)}},aO=class{constructor(e){this.name=nO,this._loader=e,this._pathToObjectConverter=new oO(this._loader.gltf)}get enabled(){return this._loader.isExtensionUsed(nO)}dispose(){this._loader=null,delete this._pathToObjectConverter}_loadAnimationChannelAsync(e,t,i,r,n){let o=r.target.extensions?.KHR_animation_pointer;if(!o||!this._pathToObjectConverter)return null;r.target.path!=="pointer"&&F.Warn(`${e}/target/path: Value (${r.target.path}) must be (pointer) when using the ${this.name} extension`),r.target.node!=null&&F.Warn(`${e}/target/node: Value (${r.target.node}) must not be present when using the ${this.name} extension`);let a=`${e}/extensions/${this.name}`,l=o.pointer;if(!l)throw new Error(`${a}: Pointer is missing`);try{let c=this._pathToObjectConverter.convert(l);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,i,r,c,n)}catch{return F.Warn(`${a}/pointer: Invalid pointer (${l}) skipped`),null}}};Ne.RegisterExtension(nO,s=>new aO(s));var lO="MSFT_audio_emitter",cO=class{constructor(e){this.name=lO,this._loader=e,this.enabled=this._loader.isExtensionUsed(lO)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){let e=this._loader.gltf.extensions;if(e&&e[this.name]){let t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,Ve.Assign(this._clips),Ve.Assign(this._emitters)}}loadSceneAsync(e,t){return Ne.LoadExtensionAsync(e,t,this.name,(i,r)=>{let n=new Array;n.push(this._loader.loadSceneAsync(e,t));for(let o of r.emitters){let a=Ve.Get(`${i}/emitters`,this._emitters,o);if(a.refDistance!=null||a.maxDistance!=null||a.rolloffFactor!=null||a.distanceModel!=null||a.innerAngle!=null||a.outerAngle!=null)throw new Error(`${i}: Direction or Distance properties are not allowed on emitters attached to a scene`);n.push(this._loadEmitterAsync(`${i}/emitters/${a.index}`,a))}return Promise.all(n).then(()=>{})})}loadNodeAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o=new Array;return this._loader.loadNodeAsync(r,t,a=>{for(let l of n.emitters){let c=Ve.Get(`${r}/emitters`,this._emitters,l);o.push(this._loadEmitterAsync(`${r}/emitters/${c.index}`,c).then(()=>{for(let h of c._babylonSounds)h.attachToMesh(a),(c.innerAngle!=null||c.outerAngle!=null)&&(h.setLocalDirectionToMesh(p.Forward()),h.setDirectionalCone(2*H.ToDegrees(c.innerAngle==null?Math.PI:c.innerAngle),2*H.ToDegrees(c.outerAngle==null?Math.PI:c.outerAngle),0))}))}i(a)}).then(a=>Promise.all(o).then(()=>a))})}loadAnimationAsync(e,t){return Ne.LoadExtensionAsync(e,t,this.name,(i,r)=>this._loader.loadAnimationAsync(e,t).then(n=>{let o=new Array;Ve.Assign(r.events);for(let a of r.events)o.push(this._loadAnimationEventAsync(`${i}/events/${a.index}`,e,t,a,n));return Promise.all(o).then(()=>n)}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let i;if(t.uri)i=this._loader.loadUriAsync(e,t,t.uri);else{let r=Ve.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);i=this._loader.loadBufferViewAsync(`/bufferViews/${r.index}`,r)}return t._objectURL=i.then(r=>URL.createObjectURL(new Blob([r],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){let i=new Array,r=t.name||`emitter${t.index}`,n={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let a=0;a<t.clips.length;a++){let l=`/extensions/${this.name}/clips`,c=Ve.Get(l,this._clips,t.clips[a].clip);i.push(this._loadClipAsync(`${l}/${t.clips[a].clip}`,c).then(h=>{let u=t._babylonSounds[a]=new Bl(r,h,this._loader.babylonScene,null,n);u.refDistance=t.refDistance||1,u.maxDistance=t.maxDistance||256,u.rolloffFactor=t.rolloffFactor||1,u.distanceModel=t.distanceModel||"exponential"}))}let o=Promise.all(i).then(()=>{let a=t.clips.map(c=>c.weight||1),l=new Yx(t.loop||!1,t._babylonSounds,a);t.innerAngle&&(l.directionalConeInnerAngle=2*H.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*H.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:o}}return t._babylonData.loaded}_getEventAction(e,t,i,r,n){switch(i){case"play":return o=>{let a=(n||0)+(o-r);t.play(a)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${i}`)}}_loadAnimationEventAsync(e,t,i,r,n){if(n.targetedAnimations.length==0)return Promise.resolve();let o=n.targetedAnimations[0],a=r.emitter,l=Ve.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,l).then(()=>{let c=l._babylonData.sound;if(c){let h=new Ox(r.time,this._getEventAction(e,c,r.action,r.time,r.startOffset));o.animation.addEvent(h),n.onAnimationGroupEndObservable.add(()=>{c.stop()}),n.onAnimationGroupPauseObservable.add(()=>{c.pause()})}})}};Ne.RegisterExtension(lO,s=>new cO(s));var hO="MSFT_lod",uO=class{constructor(e){this.name=hO,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new U,this.onMaterialLODsLoadedObservable=new U,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(hO)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){let t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){let t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){let i=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),i}loadNodeAsync(e,t,i){return Ne.LoadExtensionAsync(e,t,this.name,(r,n)=>{let o,a=this._getLODs(r,t,this._loader.gltf.nodes,n.ids);this._loader.logOpen(`${r}`);for(let l=0;l<a.length;l++){let c=a[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new gl);let h=d=>{i(d),d.setEnabled(!1)},u=this._loader.loadNodeAsync(`/nodes/${c.index}`,c,h).then(d=>{if(l!==0){let f=a[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return d.setEnabled(!0),d});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?o=u:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(u))}return this._loader.logClose(),o})}_loadMaterialAsync(e,t,i,r,n){return this._nodeIndexLOD?null:Ne.LoadExtensionAsync(e,t,this.name,(o,a)=>{let l,c=this._getLODs(o,t,this._loader.gltf.materials,a.ids);this._loader.logOpen(`${o}`);for(let h=0;h<c.length;h++){let u=c[h];h!==0&&(this._materialIndexLOD=h);let d=this._loader._loadMaterialAsync(`/materials/${u.index}`,u,i,r,f=>{h===0&&n(f)}).then(f=>{if(h!==0){n(f);let m=c[h-1]._data;m[r]&&(this._disposeMaterials([m[r].babylonMaterial]),delete m[r])}return f});this._materialPromiseLODs[h]=this._materialPromiseLODs[h]||[],h===0?l=d:(this._materialIndexLOD=null,this._materialPromiseLODs[h].push(d))}return this._loader.logClose(),l})}_loadUriAsync(e,t,i){if(this._nodeIndexLOD!==null){this._loader.log("deferred");let r=this._nodeIndexLOD-1;return this._nodeSignalLODs[r]=this._nodeSignalLODs[r]||new gl,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,t,i))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");let r=this._materialIndexLOD-1;return this._materialSignalLODs[r]=this._materialSignalLODs[r]||new gl,this._materialSignalLODs[r].promise.then(()=>this._loader.loadUriAsync(e,t,i))}return null}loadBufferAsync(e,t,i,r){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);let n=(o,a)=>{let l=i,c=l+r-1,h=o[a];return h?(h.start=Math.min(h.start,l),h.end=Math.max(h.end,c)):(h={start:l,end:c,loaded:new gl},o[a]=h),h.loaded.promise.then(u=>new Uint8Array(u.buffer,u.byteOffset+i-h.start,r))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?n(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?n(this._materialBufferLODs,this._materialIndexLOD):n(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){let i=e[t];i&&(this._loader.log(`Loading buffer range [${i.start}-${i.end}]`),this._loader.bin.readAsync(i.start,i.end-i.start+1).then(r=>{i.loaded.resolve(r)},r=>{i.loaded.reject(r)}))}_getLODs(e,t,i,r){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");let n=[];for(let o=r.length-1;o>=0;o--)if(n.push(Ve.Get(`${e}/ids/${r[o]}`,i,r[o])),n.length===this.maxLODsToLoad)return n;return n.push(t),n}_disposeTransformNode(e){let t=[],i=e.material;i&&t.push(i);for(let n of e.getChildMeshes())n.material&&t.push(n.material);e.dispose();let r=t.filter(n=>this._loader.babylonScene.meshes.every(o=>o.material!=n));this._disposeMaterials(r)}_disposeMaterials(e){let t={};for(let i of e){for(let r of i.getActiveTextures())t[r.uniqueId]=r;i.dispose()}for(let i in t)for(let r of this._loader.babylonScene.materials)r.hasTexture(t[i])&&delete t[i];for(let i in t)t[i].dispose()}};Ne.RegisterExtension(hO,s=>new uO(s));var dO="MSFT_minecraftMesh",fO=class{constructor(e){this.name=dO,this._loader=e,this.enabled=this._loader.isExtensionUsed(dO)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtraAsync(e,t,this.name,(r,n)=>{if(n){if(!(i instanceof Pe))throw new Error(`${r}: Material type not supported`);let o=this._loader.loadMaterialPropertiesAsync(e,t,i);return i.needAlphaBlending()&&(i.forceDepthWrite=!0,i.separateCullingPass=!0),i.backFaceCulling=i.forceDepthWrite,i.twoSidedLighting=!0,o}return null})}};Ne.RegisterExtension(dO,s=>new fO(s));var pO="MSFT_sRGBFactors",mO=class{constructor(e){this.name=pO,this._loader=e,this.enabled=this._loader.isExtensionUsed(pO)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,i){return Ne.LoadExtraAsync(e,t,this.name,(r,n)=>{if(n){if(!(i instanceof Pe))throw new Error(`${r}: Material type not supported`);let o=this._loader.loadMaterialPropertiesAsync(e,t,i),a=i.getScene().getEngine().useExactSrgbConversions;return i.albedoTexture||i.albedoColor.toLinearSpaceToRef(i.albedoColor,a),i.reflectivityTexture||i.reflectivityColor.toLinearSpaceToRef(i.reflectivityColor,a),o}return null})}};Ne.RegisterExtension(pO,s=>new mO(s));var C2={"lifecycle/onStart":JM.ClassName,"lifecycle/onTick":NS.ClassName,log:ub.ClassName,"flow/delay":VM.ClassName,"customEvent/send":NM.ClassName,"customEvent/receive":wS.ClassName,"flow/sequence":mb.ClassName,"world/get":_b.ClassName,"world/set":wM.ClassName,"flow/doN":fb.ClassName,"variable/get":gb.ClassName,"variable/set":db.ClassName,"flow/whileLoop":pb.ClassName,"math/random":bb.ClassName,"math/e":yb.ClassName,"math/pi":Eb.ClassName,"math/inf":Ab.ClassName,"math/nan":Ib.ClassName,"math/abs":Rb.ClassName,"math/sign":Pb.ClassName,"math/trunc":Mb.ClassName,"math/floor":Db.ClassName,"math/ceil":Ob.ClassName,"math/fract":wb.ClassName,"math/neg":Nb.ClassName,"math/add":xb.ClassName,"math/sub":vb.ClassName,"math/mul":Tb.ClassName,"math/div":Cb.ClassName,"math/rem":Fb.ClassName,"math/min":Lb.ClassName,"math/max":Bb.ClassName,"math/clamp":Vb.ClassName,"math/saturate":Ub.ClassName,"math/mix":kb.ClassName,"math/eq":Gb.ClassName,"math/lt":zb.ClassName,"math/le":o2.ClassName,"math/gt":Wb.ClassName,"math/ge":Hb.ClassName,"math/isnan":Xb.ClassName,"math/isinf":a2.ClassName,"math/rad":Yb.ClassName,"math/deg":$b.ClassName,"math/sin":jb.ClassName,"math/cos":qb.ClassName,"math/tan":Qb.ClassName,"math/asin":Kb.ClassName,"math/acos":Zb.ClassName,"math/atan":Jb.ClassName,"math/atan2":eS.ClassName,"math/sinh":tS.ClassName,"math/cosh":iS.ClassName,"math/tanh":rS.ClassName,"math/asinh":sS.ClassName,"math/acosh":nS.ClassName,"math/atanh":oS.ClassName,"math/exp":aS.ClassName,"math/log":lS.ClassName,"math/log2":cS.ClassName,"math/log10":hS.ClassName,"math/sqrt":uS.ClassName,"math/cbrt":dS.ClassName,"math/pow":fS.ClassName,"math/length":pS.ClassName,"math/normalize":mS.ClassName,"math/dot":Sb.ClassName,"math/cross":gS.ClassName,"math/rotate2d":_S.ClassName,"math/rotate3d":xS.ClassName,"math/transpose":vS.ClassName,"math/determinant":TS.ClassName,"math/inverse":CS.ClassName,"math/matmul":bS.ClassName,"math/not":SS.ClassName,"math/and":yS.ClassName,"math/or":ES.ClassName,"math/xor":AS.ClassName,"math/asr":RS.ClassName,"math/lsl":IS.ClassName,"math/clz":PS.ClassName,"math/ctz":MS.ClassName,"math/popcnt":DS.ClassName},b2={float2:"Vector2",float3:"Vector3",float4:"Vector4",float4x4:"Matrix",int:"FlowGraphInteger"};function gO(s,e,t){if(s.type!==void 0){let i=e.types&&e.types[s.type];if(!i)throw new Error(`${t}: Unknown type: ${s.type}`);let r=i.signature;if(!r)throw new Error(`${t}: Type ${s.type} has no signature`);let n=b2[r];return{value:s.value,className:n}}else return s.value}function lJ(s,e,t){let i={},r=s.configuration??[];for(let n of r)if(n.id==="customEvent"){let o=e.customEvents&&e.customEvents[n.value];if(!o)throw new Error(`/extensions/KHR_interactivity/nodes/${t}: Unknown custom event: ${n.value}`);i.eventId=o.id,i.eventData=o.values.map(a=>a.id)}else if(n.id==="variable"){let o=e.variables&&e.variables[n.value];if(!o)throw new Error(`/extensions/KHR_interactivity/nodes/${t}: Unknown variable: ${n.value}`);i.variableName=o.id}else if(n.id==="path"){let o=n.value;i.path=o}else i[n.id]=gO(n,e,`/extensions/KHR_interactivity/nodes/${t}`);return i}function cJ(s,e,t){let i=C2[e.type];if(!i)throw new Error(`/extensions/KHR_interactivity/nodes/${s}: Unknown block type: ${e.type}`);let r=s.toString(),n=lJ(e,t,r),o=e.metadata;return{className:i,config:n,uniqueId:r,metadata:o,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[]}}function S2(s){let e={uniqueId:ts(),_userVariables:{},_connectionValues:{}},t=[e],i=[];for(let n=0;n<s.nodes.length;n++){let o=s.nodes[n],a=cJ(n,o,s);i.push(a)}for(let n=0;n<s.nodes.length;n++){let o=s.nodes[n],a=i[n],l=o.flows??[];for(let h of l){let u=h.id,d={uniqueId:ts(),name:u,_connectionType:Jr.Output,connectedPointIds:[]};a.signalOutputs.push(d);let f=h.node,m=h.socket,g=i[f];if(!g)throw new Error(`/extensions/KHR_interactivity/nodes/${n}: Could not find node with id ${f} that connects its input with with node ${n}'s output ${u}`);let _=g.signalInputs.find(x=>x.name===m);_||(_={uniqueId:ts(),name:m,_connectionType:Jr.Input,connectedPointIds:[]},g.signalInputs.push(_)),_.connectedPointIds.push(d.uniqueId),d.connectedPointIds.push(_.uniqueId)}let c=o.values??[];for(let h of c){let u=h.id,d={uniqueId:ts(),name:u,_connectionType:Jr.Input,connectedPointIds:[]};if(a.dataInputs.push(d),h.value!==void 0){let f=gO(h,s,`/extensions/KHR_interactivity/nodes/${n}`);e._connectionValues[d.uniqueId]=f}else if(h.node!==void 0&&h.socket!==void 0){let f=h.node,m=h.socket,g=i[f];if(!g)throw new Error(`/extensions/KHR_interactivity/nodes/${n}: Could not find node with id ${f} that connects its output with node${n}'s input ${u}`);let _=g.dataOutputs.find(x=>x.name===m);_||(_={uniqueId:ts(),name:m,_connectionType:Jr.Output,connectedPointIds:[]},g.dataOutputs.push(_)),d.connectedPointIds.push(_.uniqueId),_.connectedPointIds.push(d.uniqueId)}else throw new Error(`/extensions/KHR_interactivity/nodes/${n}: Invalid socket ${u} in node ${n}`)}}let r=s.variables??[];for(let n=0;n<r.length;n++){let o=r[n],a=o.id;e._userVariables[a]=gO(o,s,`/extensions/KHR_interactivity/variables/${n}`)}return{allBlocks:i,executionContexts:t}}var BS=class extends Of{constructor(e){super(e,uJ)}},hJ={__array__:{__target__:!0,translation:{type:"Vector3",get:s=>s._babylonTransformNode.position,set:(s,e)=>{let t=e._babylonTransformNode;t.position=s},getObject(s){return s._babylonTransformNode}}}},uJ={nodes:hJ};var _O="KHR_interactivity",xO=class{constructor(e){this._loader=e,this.name=_O,this.enabled=this._loader.isExtensionUsed(_O),this._pathConverter=new BS(this._loader.gltf)}dispose(){this._loader=null,delete this._pathConverter}onReady(){if(!this._loader.babylonScene||!this._pathConverter)return;let e=this._loader.babylonScene,t=this._loader.gltf.extensions?.KHR_interactivity,i=S2(t),r=new hg({scene:e});ru.Parse(i,{coordinator:r,pathConverter:this._pathConverter}),r.start()}};Ne.RegisterExtension(_O,s=>new xO(s));var y2="ExtrasAsMetadata",vO=class{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){let i=e.metadata=e.metadata||{},r=i.gltf=i.gltf||{};r.extras=t.extras}}constructor(e){this.name=y2,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,i){return this._loader.loadNodeAsync(e,t,r=>{this._assignExtras(r,t),i(r)})}loadCameraAsync(e,t,i){return this._loader.loadCameraAsync(e,t,r=>{this._assignExtras(r,t),i(r)})}createMaterial(e,t,i){let r=this._loader.createMaterial(e,t,i);return this._assignExtras(r,t),r}};Ne.RegisterExtension(y2,s=>new vO(s));var E2=(()=>{let e=class e{constructor(i){this.platformId=i}ngOnInit(){}ngAfterViewInit(){GL(this.platformId)&&(this.canvas=document.getElementById("renderCanvas"),this.createEngineAndScene(),this.loadModel(),this.startRenderLoop())}createEngineAndScene(){if(!this.canvas)return;this.engine=new K(this.canvas,!0),this.scene=new Te(this.engine),new Bt("Camera",Math.PI/2,Math.PI/4,4,p.Zero(),this.scene).attachControl(this.canvas,!0),new as("light1",new p(1,1,0),this.scene)}loadModel(){this.scene&&Mt.Append("/assets/","Furniture.glb",this.scene,i=>{console.log("Modelo cargado")},null,(i,r,n)=>{console.error("Error al cargar el modelo:",r,n)})}startRenderLoop(){!this.engine||!this.scene||(this.engine.runRenderLoop(()=>{this.scene&&this.scene.render()}),window.addEventListener("resize",()=>{this.engine&&this.engine.resize()}))}};e.\u0275fac=function(r){return new(r||e)(hp(Gn))},e.\u0275cmp=Wu({type:e,selectors:[["app-babylon-scene"]],standalone:!0,features:[Yu],decls:1,vars:0,consts:[["id","renderCanvas","width","800","height","600"]],template:function(r,n){r&1&&Bc(0,"canvas",0)}});let s=e;return s})();var A2=(()=>{let e=class e{constructor(){this.title="firstProject"}};e.\u0275fac=function(r){return new(r||e)},e.\u0275cmp=Wu({type:e,selectors:[["app-root"]],standalone:!0,features:[Yu],decls:1,vars:0,template:function(r,n){r&1&&Bc(0,"app-babylon-scene")},dependencies:[YE,E2]});let s=e;return s})();s1(A2,H1).catch(s=>console.error(s));
